var PI=Object.defineProperty;var LI=(t,e,r)=>e in t?PI(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var p=(t,e,r)=>LI(t,typeof e!="symbol"?e+"":e,r);import{g as Pa,a as Wu}from"./index-DtnJ7LlQ.js";import{c as lG,h as uG,s as dG}from"./index-DtnJ7LlQ.js";const Vt=[];for(let t=0;t<256;++t)Vt.push((t+256).toString(16).slice(1));function MI(t,e=0){return(Vt[t[e+0]]+Vt[t[e+1]]+Vt[t[e+2]]+Vt[t[e+3]]+"-"+Vt[t[e+4]]+Vt[t[e+5]]+"-"+Vt[t[e+6]]+Vt[t[e+7]]+"-"+Vt[t[e+8]]+Vt[t[e+9]]+"-"+Vt[t[e+10]]+Vt[t[e+11]]+Vt[t[e+12]]+Vt[t[e+13]]+Vt[t[e+14]]+Vt[t[e+15]]).toLowerCase()}let Ud;const DI=new Uint8Array(16);function UI(){if(!Ud){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ud=crypto.getRandomValues.bind(crypto)}return Ud(DI)}const BI=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Zy={randomUUID:BI};function jI(t,e,r){var s;t=t||{};const n=t.random??((s=t.rng)==null?void 0:s.call(t))??UI();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,MI(n)}function Bv(t,e,r){return Zy.randomUUID&&!t?Zy.randomUUID():jI(t)}const It={JOB_STATUS:"tm_job_status_",JOB_RESULTS:"tm_job_results_",JOB_TRAIL:"tm_job_trail_",ALL_JOBS:"tm_all_jobs",UPLOADED_FILES:"tm_uploaded_files_",AWS_CREDENTIALS:"tm_aws_credentials"},Bd={COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"};class FI{setJobStatus(e,r,n=0,s=null){const i={id:e,state:r,retry:n,owner:"LIGHTNING_USER",updated_at:new Date().toISOString()};s!=null&&(i.detail=s),sessionStorage.setItem(`${It.JOB_STATUS}${e}`,JSON.stringify(i))}getJobStatus(e){const r=sessionStorage.getItem(`${It.JOB_STATUS}${e}`);if(!r)return null;try{return JSON.parse(r)}catch(n){return console.error("Failed to parse job status:",n),null}}setJobResults(e,r){sessionStorage.setItem(`${It.JOB_RESULTS}${e}`,JSON.stringify(r))}getJobResults(e){const r=sessionStorage.getItem(`${It.JOB_RESULTS}${e}`);if(!r)return null;try{return JSON.parse(r)}catch(n){return console.error("Failed to parse job results:",n),null}}updateJobResults(e,r){const s={...this.getJobResults(e)||{},...r};this.setJobResults(e,s)}setJobTrail(e,r){sessionStorage.setItem(`${It.JOB_TRAIL}${e}`,JSON.stringify(r))}getJobTrail(e){const r=sessionStorage.getItem(`${It.JOB_TRAIL}${e}`);if(!r)return null;try{return JSON.parse(r)}catch(n){return console.error("Failed to parse job trail:",n),null}}updateJobTrail(e,r){const n=this.getJobTrail(e)||{id:e,assets:"",flows:"",gaps:[],threats:[]},s={...n};r.assets!==void 0&&(s.assets=r.assets),r.flows!==void 0&&(s.flows=r.flows),r.gaps!==void 0&&(s.gaps=Array.isArray(r.gaps)?[...n.gaps||[],...r.gaps]:[...n.gaps||[],r.gaps]),r.threats!==void 0&&(s.threats=Array.isArray(r.threats)?[...n.threats||[],...r.threats]:[...n.threats||[],r.threats]),this.setJobTrail(e,s)}addJobToIndex(e,r){const n=this.getAllJobs(),s=n.findIndex(a=>a.id===e),i={id:e,...r,created_at:r.created_at||new Date().toISOString()};s>=0?n[s]={...n[s],...i}:n.push(i),sessionStorage.setItem(It.ALL_JOBS,JSON.stringify(n))}getAllJobs(){const e=sessionStorage.getItem(It.ALL_JOBS);if(!e)return[];try{return JSON.parse(e)}catch(r){return console.error("Failed to parse all jobs:",r),[]}}removeJobFromIndex(e){const n=this.getAllJobs().filter(s=>s.id!==e);sessionStorage.setItem(It.ALL_JOBS,JSON.stringify(n))}storeUploadedFile(e,r){sessionStorage.setItem(`${It.UPLOADED_FILES}${e}`,r)}getUploadedFile(e){return sessionStorage.getItem(`${It.UPLOADED_FILES}${e}`)}deleteUploadedFile(e){sessionStorage.removeItem(`${It.UPLOADED_FILES}${e}`)}clearJobData(e){sessionStorage.removeItem(`${It.JOB_STATUS}${e}`),sessionStorage.removeItem(`${It.JOB_RESULTS}${e}`),sessionStorage.removeItem(`${It.JOB_TRAIL}${e}`),this.removeJobFromIndex(e)}clearAllData(){const e=sessionStorage.getItem(It.AWS_CREDENTIALS);this.getAllJobs().forEach(n=>{this.clearJobData(n.id)}),sessionStorage.removeItem(It.ALL_JOBS),Object.keys(sessionStorage).forEach(n=>{n.startsWith(It.UPLOADED_FILES)&&sessionStorage.removeItem(n)}),e&&sessionStorage.setItem(It.AWS_CREDENTIALS,e)}isJobActive(e){const r=this.getJobStatus(e);return r?![Bd.CANCELLED,Bd.COMPLETE,Bd.FAILED].includes(r.state):!1}}const ee=new FI;var Li=class extends Error{constructor(e,r){let n=e??"";r!=null&&r.lc_error_code&&(n=`${n}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langgraph/${r.lc_error_code}/
`);super(n);p(this,"lc_error_code");this.lc_error_code=r==null?void 0:r.lc_error_code}},jv=class extends Li{get is_bubble_up(){return!0}},zI=class extends Li{constructor(t,e){super(t,e),this.name="GraphRecursionError"}static get unminifiable_name(){return"GraphRecursionError"}},pl=class extends Li{constructor(t,e){super(t,e),this.name="GraphValueError"}static get unminifiable_name(){return"GraphValueError"}},pa=class extends jv{constructor(e,r){super(JSON.stringify(e,null,2),r);p(this,"interrupts");this.name="GraphInterrupt",this.interrupts=e??[]}static get unminifiable_name(){return"GraphInterrupt"}},Fv=class extends pa{constructor(t,e){super([{value:t}],e),this.name="NodeInterrupt"}static get unminifiable_name(){return"NodeInterrupt"}},zv=class extends jv{constructor(e){super();p(this,"command");this.name="ParentCommand",this.command=e}static get unminifiable_name(){return"ParentCommand"}};function VI(t){return t!==void 0&&t.name===zv.unminifiable_name}function ml(t){return t!==void 0&&t.is_bubble_up===!0}function fi(t){return t!==void 0&&[pa.unminifiable_name,Fv.unminifiable_name].includes(t.name)}var Ky=class extends Li{constructor(t,e){super(t,e),this.name="EmptyInputError"}static get unminifiable_name(){return"EmptyInputError"}},Qt=class extends Li{constructor(t,e){super(t,e),this.name="EmptyChannelError"}static get unminifiable_name(){return"EmptyChannelError"}},lt=class extends Li{constructor(t,e){super(t,e),this.name="InvalidUpdateError"}static get unminifiable_name(){return"InvalidUpdateError"}},qI=class extends Li{constructor(t,e){super(t,e),this.name="UnreachableNodeError"}static get unminifiable_name(){return"UnreachableNodeError"}};const HI=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function GI(t){return typeof t=="string"&&HI.test(t)}function Vv(t){if(!GI(t))throw TypeError("Invalid UUID");var e,r=new Uint8Array(16);return r[0]=(e=parseInt(t.slice(0,8),16))>>>24,r[1]=e>>>16&255,r[2]=e>>>8&255,r[3]=e&255,r[4]=(e=parseInt(t.slice(9,13),16))>>>8,r[5]=e&255,r[6]=(e=parseInt(t.slice(14,18),16))>>>8,r[7]=e&255,r[8]=(e=parseInt(t.slice(19,23),16))>>>8,r[9]=e&255,r[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,r[11]=e/4294967296&255,r[12]=e>>>24&255,r[13]=e>>>16&255,r[14]=e>>>8&255,r[15]=e&255,r}var qt=[];for(var jd=0;jd<256;++jd)qt.push((jd+256).toString(16).slice(1));function Ju(t,e=0){return(qt[t[e+0]]+qt[t[e+1]]+qt[t[e+2]]+qt[t[e+3]]+"-"+qt[t[e+4]]+qt[t[e+5]]+"-"+qt[t[e+6]]+qt[t[e+7]]+"-"+qt[t[e+8]]+qt[t[e+9]]+"-"+qt[t[e+10]]+qt[t[e+11]]+qt[t[e+12]]+qt[t[e+13]]+qt[t[e+14]]+qt[t[e+15]]).toLowerCase()}var $c,WI=new Uint8Array(16);function JI(){if(!$c&&($c=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!$c))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return $c(WI)}var Fd,Nc,zd=0,Vd=0;function ZI(t,e,r){var n=0,s=e||new Array(16);t=t||{};var i=t.node,a=t.clockseq;if(t._v6||(i||(i=Fd),a==null&&(a=Nc)),i==null||a==null){var o=t.random||(t.rng||JI)();i==null&&(i=[o[0],o[1],o[2],o[3],o[4],o[5]],!Fd&&!t._v6&&(i[0]|=1,Fd=i)),a==null&&(a=(o[6]<<8|o[7])&16383,Nc===void 0&&!t._v6&&(Nc=a))}var c=t.msecs!==void 0?t.msecs:Date.now(),l=t.nsecs!==void 0?t.nsecs:Vd+1,u=c-zd+(l-Vd)/1e4;if(u<0&&t.clockseq===void 0&&(a=a+1&16383),(u<0||c>zd)&&t.nsecs===void 0&&(l=0),l>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");zd=c,Vd=l,Nc=a,c+=122192928e5;var d=((c&268435455)*1e4+l)%4294967296;s[n++]=d>>>24&255,s[n++]=d>>>16&255,s[n++]=d>>>8&255,s[n++]=d&255;var h=c/4294967296*1e4&268435455;s[n++]=h>>>8&255,s[n++]=h&255,s[n++]=h>>>24&15|16,s[n++]=h>>>16&255,s[n++]=a>>>8|128,s[n++]=a&255;for(var f=0;f<6;++f)s[n+f]=i[f];return e||Ju(s)}function KI(t){var e=typeof t=="string"?Vv(t):t,r=XI(e);return typeof t=="string"?Ju(r):r}function XI(t,e=!1){return Uint8Array.of((t[6]&15)<<4|t[7]>>4&15,(t[7]&15)<<4|(t[4]&240)>>4,(t[4]&15)<<4|(t[5]&240)>>4,(t[5]&15)<<4|(t[0]&240)>>4,(t[0]&15)<<4|(t[1]&240)>>4,(t[1]&15)<<4|(t[2]&240)>>4,96|t[2]&15,t[3],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}function YI(t){t=unescape(encodeURIComponent(t));for(var e=[],r=0;r<t.length;++r)e.push(t.charCodeAt(r));return e}var QI="6ba7b810-9dad-11d1-80b4-00c04fd430c8",e1="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function t1(t,e,r){function n(s,i,a,o){var c;if(typeof s=="string"&&(s=YI(s)),typeof i=="string"&&(i=Vv(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var l=new Uint8Array(16+s.length);if(l.set(i),l.set(s,i.length),l=r(l),l[6]=l[6]&15|e,l[8]=l[8]&63|128,a){o=o||0;for(var u=0;u<16;++u)a[o+u]=l[u];return a}return Ju(l)}try{n.name=t}catch{}return n.DNS=QI,n.URL=e1,n}function r1(t,e,r,n){switch(t){case 0:return e&r^~e&n;case 1:return e^r^n;case 2:return e&r^e&n^r&n;case 3:return e^r^n}}function qd(t,e){return t<<e|t>>>32-e}function n1(t){var e=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var n=unescape(encodeURIComponent(t));t=[];for(var s=0;s<n.length;++s)t.push(n.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var i=t.length/4+2,a=Math.ceil(i/16),o=new Array(a),c=0;c<a;++c){for(var l=new Uint32Array(16),u=0;u<16;++u)l[u]=t[c*64+u*4]<<24|t[c*64+u*4+1]<<16|t[c*64+u*4+2]<<8|t[c*64+u*4+3];o[c]=l}o[a-1][14]=(t.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var h=new Uint32Array(80),f=0;f<16;++f)h[f]=o[d][f];for(var m=16;m<80;++m)h[m]=qd(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var g=r[0],y=r[1],b=r[2],_=r[3],E=r[4],C=0;C<80;++C){var k=Math.floor(C/20),R=qd(g,5)+r1(k,y,b,_)+E+e[k]+h[C]>>>0;E=_,_=b,b=qd(y,30)>>>0,y=g,g=R}r[0]=r[0]+g>>>0,r[1]=r[1]+y>>>0,r[2]=r[2]+b>>>0,r[3]=r[3]+_>>>0,r[4]=r[4]+E>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,r[0]&255,r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,r[1]&255,r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,r[2]&255,r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,r[3]&255,r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,r[4]&255]}var s1=t1("v5",80,n1);function Xy(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(t,s).enumerable})),r.push.apply(r,n)}return r}function Yy(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};e%2?Xy(Object(r),!0).forEach(function(n){i1(t,n,r[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Xy(Object(r)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(r,n))})}return t}function i1(t,e,r){return(e=a1(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function a1(t){var e=o1(t,"string");return typeof e=="symbol"?e:e+""}function o1(t,e){if(typeof t!="object"||!t)return t;var r=t[Symbol.toPrimitive];if(r!==void 0){var n=r.call(t,e);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function c1(t={},e,r=0){var n=ZI(Yy(Yy({},t),{},{_v6:!0}),new Uint8Array(16));return n=KI(n),Ju(n)}function qv(t){return c1({clockseq:t})}function ia(t,e){const r=e.replace(/-/g,"").match(/.{2}/g).map(n=>parseInt(n,16));return s1(t,new Uint8Array(r))}const l1="__error__",gl="__scheduled__",u1="__interrupt__",d1="__resume__";var Qy="[...]",h1="[Circular]",Wl=[],aa=[];function f1(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function p1(t,e,r,n){typeof n>"u"&&(n=f1()),rp(t,"",0,[],void 0,0,n);var s;try{aa.length===0?s=JSON.stringify(t,e,r):s=JSON.stringify(t,m1(e),r)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Wl.length!==0;){var i=Wl.pop();i.length===4?Object.defineProperty(i[0],i[1],i[3]):i[0][i[1]]=i[2]}}return s}function Hd(t,e,r,n){var s=Object.getOwnPropertyDescriptor(n,r);s.get!==void 0?s.configurable?(Object.defineProperty(n,r,{value:t}),Wl.push([n,r,e,s])):aa.push([e,r,t]):(n[r]=t,Wl.push([n,r,e]))}function rp(t,e,r,n,s,i,a){i+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<n.length;o++)if(n[o]===t){Hd(h1,t,e,s);return}if(typeof a.depthLimit<"u"&&i>a.depthLimit){Hd(Qy,t,e,s);return}if(typeof a.edgesLimit<"u"&&r+1>a.edgesLimit){Hd(Qy,t,e,s);return}if(n.push(t),Array.isArray(t))for(o=0;o<t.length;o++)rp(t[o],o,o,n,t,i,a);else{var c=Object.keys(t);for(o=0;o<c.length;o++){var l=c[o];rp(t[l],l,o,n,t,i,a)}}n.pop()}}function m1(t){return t=typeof t<"u"?t:function(e,r){return r},function(e,r){if(aa.length>0)for(var n=0;n<aa.length;n++){var s=aa[n];if(s[1]===e&&s[0]===r){r=s[2],aa.splice(n,1);break}}return t.call(this,e,r)}}var Gd,e_;function g1(){return e_||(e_=1,Gd=function(t,e){if(typeof t!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,t.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}),Gd}var y1=g1();const _1=Pa(y1);var Pc={exports:{}},t_;function w1(){if(t_)return Pc.exports;t_=1;const t=/[\p{Lu}]/u,e=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,n=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,i=new RegExp("^"+s.source),a=new RegExp(s.source+n.source,"gu"),o=new RegExp("\\d+"+n.source,"gu"),c=(h,f,m)=>{let g=!1,y=!1,b=!1;for(let _=0;_<h.length;_++){const E=h[_];g&&t.test(E)?(h=h.slice(0,_)+"-"+h.slice(_),g=!1,b=y,y=!0,_++):y&&b&&e.test(E)?(h=h.slice(0,_-1)+"-"+h.slice(_-1),b=y,y=!1,g=!0):(g=f(E)===E&&m(E)!==E,b=y,y=m(E)===E&&f(E)!==E)}return h},l=(h,f)=>(r.lastIndex=0,h.replace(r,m=>f(m))),u=(h,f)=>(a.lastIndex=0,o.lastIndex=0,h.replace(a,(m,g)=>f(g)).replace(o,m=>f(m))),d=(h,f)=>{if(!(typeof h=="string"||Array.isArray(h)))throw new TypeError("Expected the input to be `string | string[]`");if(f={pascalCase:!1,preserveConsecutiveUppercase:!1,...f},Array.isArray(h)?h=h.map(b=>b.trim()).filter(b=>b.length).join("-"):h=h.trim(),h.length===0)return"";const m=f.locale===!1?b=>b.toLowerCase():b=>b.toLocaleLowerCase(f.locale),g=f.locale===!1?b=>b.toUpperCase():b=>b.toLocaleUpperCase(f.locale);return h.length===1?f.pascalCase?g(h):m(h):(h!==m(h)&&(h=c(h,m,g)),h=h.replace(i,""),f.preserveConsecutiveUppercase?h=l(h,m):h=m(h),f.pascalCase&&(h=g(h.charAt(0))+h.slice(1)),u(h,g))};return Pc.exports=d,Pc.exports.default=d,Pc.exports}var b1=w1();const v1=Pa(b1);function E1(t,e){return(e==null?void 0:e[t])||_1(t)}function S1(t,e){return(e==null?void 0:e[t])||v1(t)}function Hv(t,e,r){const n={};for(const s in t)Object.hasOwn(t,s)&&(n[e(s,r)]=t[s]);return n}var x1=Object.defineProperty,ve=(t,e)=>{for(var r in e)x1(t,r,{get:e[r],enumerable:!0})},Gv={};ve(Gv,{Serializable:()=>sn,get_lc_unique_name:()=>Zu});function r_(t){return Array.isArray(t)?[...t]:{...t}}function T1(t,e){const r=r_(t);for(const[n,s]of Object.entries(e)){const[i,...a]=n.split(".").reverse();let o=r;for(const c of a.reverse()){if(o[c]===void 0)break;o[c]=r_(o[c]),o=o[c]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[s]})}return r}function Zu(t){const e=Object.getPrototypeOf(t);return typeof t.lc_name=="function"&&(typeof e.lc_name!="function"||t.lc_name()!==e.lc_name())?t.lc_name():t.name}var sn=class Wv{constructor(e,...r){p(this,"lc_serializable",!1);p(this,"lc_kwargs");this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([n])=>{var s;return(s=this.lc_serializable_keys)==null?void 0:s.includes(n)})):this.lc_kwargs=e??{}}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Zu(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Wv||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},r={},n=Object.keys(this.lc_kwargs).reduce((s,i)=>(s[i]=i in this?this[i]:this.lc_kwargs[i],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(r,Reflect.get(s,"lc_secrets",this)),Object.assign(n,Reflect.get(s,"lc_attributes",this));return Object.keys(r).forEach(s=>{let i=this,a=n;const[o,...c]=s.split(".").reverse();for(const l of c.reverse()){if(!(l in i)||i[l]===void 0)return;(!(l in a)||a[l]===void 0)&&(typeof i[l]=="object"&&i[l]!=null?a[l]={}:Array.isArray(i[l])&&(a[l]=[])),i=i[l],a=a[l]}o in i&&i[o]!==void 0&&(a[o]=a[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Hv(Object.keys(r).length?T1(n,r):n,E1,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function A1(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Jv={exports:{}},wt=Jv.exports={},Nn,Pn;function np(){throw new Error("setTimeout has not been defined")}function sp(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?Nn=setTimeout:Nn=np}catch{Nn=np}try{typeof clearTimeout=="function"?Pn=clearTimeout:Pn=sp}catch{Pn=sp}})();function Zv(t){if(Nn===setTimeout)return setTimeout(t,0);if((Nn===np||!Nn)&&setTimeout)return Nn=setTimeout,setTimeout(t,0);try{return Nn(t,0)}catch{try{return Nn.call(null,t,0)}catch{return Nn.call(this,t,0)}}}function C1(t){if(Pn===clearTimeout)return clearTimeout(t);if((Pn===sp||!Pn)&&clearTimeout)return Pn=clearTimeout,clearTimeout(t);try{return Pn(t)}catch{try{return Pn.call(null,t)}catch{return Pn.call(this,t)}}}var ls=[],ma=!1,pi,yl=-1;function k1(){!ma||!pi||(ma=!1,pi.length?ls=pi.concat(ls):yl=-1,ls.length&&Kv())}function Kv(){if(!ma){var t=Zv(k1);ma=!0;for(var e=ls.length;e;){for(pi=ls,ls=[];++yl<e;)pi&&pi[yl].run();yl=-1,e=ls.length}pi=null,ma=!1,C1(t)}}wt.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)e[r-1]=arguments[r];ls.push(new Xv(t,e)),ls.length===1&&!ma&&Zv(Kv)};function Xv(t,e){this.fun=t,this.array=e}Xv.prototype.run=function(){this.fun.apply(null,this.array)};wt.title="browser";wt.browser=!0;wt.env={};wt.argv=[];wt.version="";wt.versions={};function vs(){}wt.on=vs;wt.addListener=vs;wt.once=vs;wt.off=vs;wt.removeListener=vs;wt.removeAllListeners=vs;wt.emit=vs;wt.prependListener=vs;wt.prependOnceListener=vs;wt.listeners=function(t){return[]};wt.binding=function(t){throw new Error("process.binding is not supported")};wt.cwd=function(){return"/"};wt.chdir=function(t){throw new Error("process.chdir is not supported")};wt.umask=function(){return 0};var I1=Jv.exports;const Vn=A1(I1);var Wd={},Yv={};ve(Yv,{getEnv:()=>nE,getEnvironmentVariable:()=>rn,getRuntimeEnvironment:()=>sE,isBrowser:()=>Qv,isDeno:()=>Ku,isJsDom:()=>tE,isNode:()=>rE,isWebWorker:()=>eE});const Qv=()=>typeof window<"u"&&typeof window.document<"u",eE=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",tE=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Ku=()=>typeof Deno<"u",rE=()=>typeof Vn<"u"&&typeof Vn.versions<"u"&&typeof Vn.versions.node<"u"&&!Ku(),nE=()=>{let t;return Qv()?t="browser":rE()?t="node":eE()?t="webworker":tE()?t="jsdom":Ku()?t="deno":t="other",t};let Jd;function sE(){return Jd===void 0&&(Jd={library:"langchain-js",runtime:nE()}),Jd}function rn(t){try{return typeof Vn<"u"?Wd==null?void 0:Wd[t]:Ku()?Deno==null?void 0:Deno.env.get(t):void 0}catch{return}}const R1=[];var O1={};function Sn(t){return typeof t=="object"&&t!==null&&"type"in t&&typeof t.type=="string"&&"source_type"in t&&(t.source_type==="url"||t.source_type==="base64"||t.source_type==="text"||t.source_type==="id")}function Bm(t){return Sn(t)&&t.source_type==="url"&&"url"in t&&typeof t.url=="string"}function jm(t){return Sn(t)&&t.source_type==="base64"&&"data"in t&&typeof t.data=="string"}function $1(t){return Sn(t)&&t.source_type==="text"&&"text"in t&&typeof t.text=="string"}function iE(t){return Sn(t)&&t.source_type==="id"&&"id"in t&&typeof t.id=="string"}function aE(t){if(Sn(t)){if(t.source_type==="url")return{type:"image_url",image_url:{url:t.url}};if(t.source_type==="base64"){if(!t.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${t.mime_type};base64,${t.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function mi(t){const e=t.split(";")[0].split("/");if(e.length!==2)throw new Error(`Invalid mime type: "${t}" - does not match type/subtype format.`);const r=e[0].trim(),n=e[1].trim();if(r===""||n==="")throw new Error(`Invalid mime type: "${t}" - type or subtype is empty.`);const s={};for(const i of t.split(";").slice(1)){const a=i.split("=");if(a.length!==2)throw new Error(`Invalid parameter syntax in mime type: "${t}".`);const o=a[0].trim(),c=a[1].trim();if(o==="")throw new Error(`Invalid parameter syntax in mime type: "${t}".`);s[o]=c}return{type:r,subtype:n,parameters:s}}function Ci({dataUrl:t,asTypedArray:e=!1}){const r=t.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let n;if(r){n=r[1].toLowerCase();const s=e?Uint8Array.from(atob(r[2]),i=>i.charCodeAt(0)):r[2];return{mime_type:n,data:s}}}function Xu(t,e){if(t.type==="text"){if(!e.fromStandardTextBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardTextBlock\` method.`);return e.fromStandardTextBlock(t)}if(t.type==="image"){if(!e.fromStandardImageBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardImageBlock\` method.`);return e.fromStandardImageBlock(t)}if(t.type==="audio"){if(!e.fromStandardAudioBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardAudioBlock\` method.`);return e.fromStandardAudioBlock(t)}if(t.type==="file"){if(!e.fromStandardFileBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardFileBlock\` method.`);return e.fromStandardFileBlock(t)}throw new Error(`Unable to convert content block type '${t.type}' to provider-specific format: not recognized.`)}function be(t,e){return Ie(t)&&t.type===e}function Ie(t){return typeof t=="object"&&t!==null}function qn(t){return Array.isArray(t)}function oe(t){return typeof t=="string"}function mn(t){return typeof t=="number"}function Fm(t){return t instanceof Uint8Array}function n_(t){try{return JSON.parse(t)}catch{return}}const Oo=t=>t();function N1(t){if(t.type==="char_location"&&oe(t.document_title)&&mn(t.start_char_index)&&mn(t.end_char_index)&&oe(t.cited_text)){const{document_title:e,start_char_index:r,end_char_index:n,cited_text:s,...i}=t;return{...i,type:"citation",source:"char",title:e??void 0,startIndex:r,endIndex:n,citedText:s}}if(t.type==="page_location"&&oe(t.document_title)&&mn(t.start_page_number)&&mn(t.end_page_number)&&oe(t.cited_text)){const{document_title:e,start_page_number:r,end_page_number:n,cited_text:s,...i}=t;return{...i,type:"citation",source:"page",title:e??void 0,startIndex:r,endIndex:n,citedText:s}}if(t.type==="content_block_location"&&oe(t.document_title)&&mn(t.start_block_index)&&mn(t.end_block_index)&&oe(t.cited_text)){const{document_title:e,start_block_index:r,end_block_index:n,cited_text:s,...i}=t;return{...i,type:"citation",source:"block",title:e??void 0,startIndex:r,endIndex:n,citedText:s}}if(t.type==="web_search_result_location"&&oe(t.url)&&oe(t.title)&&oe(t.encrypted_index)&&oe(t.cited_text)){const{url:e,title:r,encrypted_index:n,cited_text:s,...i}=t;return{...i,type:"citation",source:"url",url:e,title:r,startIndex:Number(n),endIndex:Number(n),citedText:s}}if(t.type==="search_result_location"&&oe(t.source)&&oe(t.title)&&mn(t.start_block_index)&&mn(t.end_block_index)&&oe(t.cited_text)){const{source:e,title:r,start_block_index:n,end_block_index:s,cited_text:i,...a}=t;return{...a,type:"citation",source:"search",url:e,title:r??void 0,startIndex:n,endIndex:s,citedText:i}}}function oE(t){if(be(t,"document")&&Ie(t.source)&&"type"in t.source){if(t.source.type==="base64"&&oe(t.source.media_type)&&oe(t.source.data))return{type:"file",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&oe(t.source.url))return{type:"file",url:t.source.url};if(t.source.type==="file"&&oe(t.source.file_id))return{type:"file",fileId:t.source.file_id};if(t.source.type==="text"&&oe(t.source.data))return{type:"file",mimeType:String(t.source.media_type??"text/plain"),data:t.source.data}}else if(be(t,"image")&&Ie(t.source)&&"type"in t.source){if(t.source.type==="base64"&&oe(t.source.media_type)&&oe(t.source.data))return{type:"image",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&oe(t.source.url))return{type:"image",url:t.source.url};if(t.source.type==="file"&&oe(t.source.file_id))return{type:"image",fileId:t.source.file_id}}}function P1(t){function*e(){for(const r of t){const n=oE(r);n?yield n:yield r}}return Array.from(e())}function s_(t){function*e(){var n;const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const s of r){if(be(s,"text")&&oe(s.text)){const{text:i,citations:a,...o}=s;if(qn(a)&&a.length){const c=a.reduce((l,u)=>{const d=N1(u);return d?[...l,d]:l},[]);yield{...o,type:"text",text:i,annotations:c};continue}else{yield{...o,type:"text",text:i};continue}}else if(be(s,"thinking")&&oe(s.thinking)){const{thinking:i,signature:a,...o}=s;yield{...o,type:"reasoning",reasoning:i,signature:a};continue}else if(be(s,"redacted_thinking")){yield{type:"non_standard",value:s};continue}else if(be(s,"tool_use")&&oe(s.name)&&oe(s.id)){yield{type:"tool_call",id:s.id,name:s.name,args:s.input};continue}else if(be(s,"input_json_delta")){if(M1(t)&&((n=t.tool_call_chunks)!=null&&n.length)){const i=t.tool_call_chunks[0];yield{type:"tool_call_chunk",id:i.id,name:i.name,args:i.args,index:i.index};continue}}else if(be(s,"server_tool_use")&&oe(s.name)&&oe(s.id)){const{name:i,id:a}=s;if(i==="web_search"){const o=Oo(()=>{if(typeof s.input=="string")return s.input;if(Ie(s.input)&&oe(s.input.query))return s.input.query;if(oe(s.partial_json)){const c=n_(s.partial_json);if(c!=null&&c.query)return c.query}return""});yield{id:a,type:"server_tool_call",name:"web_search",args:{query:o}};continue}else if(s.name==="code_execution"){const o=Oo(()=>{if(typeof s.input=="string")return s.input;if(Ie(s.input)&&oe(s.input.code))return s.input.code;if(oe(s.partial_json)){const c=n_(s.partial_json);if(c!=null&&c.code)return c.code}return""});yield{id:a,type:"server_tool_call",name:"code_execution",args:{code:o}};continue}}else if(be(s,"web_search_tool_result")&&oe(s.tool_use_id)&&qn(s.content)){const{content:i,tool_use_id:a}=s,o=i.reduce((c,l)=>be(l,"web_search_result")?[...c,l.url]:c,[]);yield{type:"server_tool_call_result",name:"web_search",toolCallId:a,status:"success",output:{urls:o}};continue}else if(be(s,"code_execution_tool_result")&&oe(s.tool_use_id)&&Ie(s.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(be(s,"mcp_tool_use")){yield{id:s.id,type:"server_tool_call",name:"mcp_tool_use",args:s.input};continue}else if(be(s,"mcp_tool_result")&&oe(s.tool_use_id)&&Ie(s.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(be(s,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:s.input};continue}else if(be(s,"search_result")){yield{id:s.id,type:"non_standard",value:s};continue}else if(be(s,"tool_result")){yield{id:s.id,type:"non_standard",value:s};continue}else{const i=oE(s);if(i){yield i;continue}}yield{type:"non_standard",value:s}}}return Array.from(e())}const L1={translateContent:s_,translateContentChunk:s_};function M1(t){return typeof(t==null?void 0:t._getType)=="function"&&typeof t.concat=="function"&&t._getType()==="ai"}function D1(t){return Bm(t)?{type:t.type,mimeType:t.mime_type,url:t.url,metadata:t.metadata}:jm(t)?{type:t.type,mimeType:t.mime_type??"application/octet-stream",data:t.data,metadata:t.metadata}:iE(t)?{type:t.type,mimeType:t.mime_type,fileId:t.id,metadata:t.metadata}:t}function U1(t){return t.map(D1)}function B1(t){return!!(be(t,"image_url")&&Ie(t.image_url)||be(t,"input_audio")&&Ie(t.input_audio)||be(t,"file")&&Ie(t.file))}function j1(t){if(be(t,"image_url")&&Ie(t.image_url)&&oe(t.image_url.url)){const e=Ci({dataUrl:t.image_url.url});return e?{type:"image",mimeType:e.mime_type,data:e.data}:{type:"image",url:t.image_url.url}}else{if(be(t,"input_audio")&&Ie(t.input_audio)&&oe(t.input_audio.data)&&oe(t.input_audio.format))return{type:"audio",data:t.input_audio.data,mimeType:`audio/${t.input_audio.format}`};if(be(t,"file")&&Ie(t.file)&&oe(t.file.data)){const e=Ci({dataUrl:t.file.data});if(e)return{type:"file",data:e.data,mimeType:e.mime_type};if(oe(t.file.file_id))return{type:"file",fileId:t.file.file_id}}}return t}function F1(t){const e=[];typeof t.content=="string"?e.push({type:"text",text:t.content}):e.push(...zm(t.content));for(const r of t.tool_calls??[])e.push({type:"tool_call",id:r.id,name:r.name,args:r.args});return e}function z1(t){const e=[];typeof t.content=="string"?e.push({type:"text",text:t.content}):e.push(...zm(t.content));for(const r of t.tool_calls??[])e.push({type:"tool_call",id:r.id,name:r.name,args:r.args});return e}function zm(t){const e=[];for(const r of t)B1(r)?e.push(j1(r)):e.push(r);return e}function V1(t){if(t.type==="url_citation"){const{url:e,title:r,start_index:n,end_index:s}=t;return{type:"citation",url:e,title:r,startIndex:n,endIndex:s}}if(t.type==="file_citation"){const{file_id:e,filename:r,index:n}=t;return{type:"citation",title:r,startIndex:n,endIndex:n,fileId:e}}return t}function cE(t){function*e(){var n;Ie((n=t.additional_kwargs)==null?void 0:n.reasoning)&&qn(t.additional_kwargs.reasoning.summary)&&(yield{type:"reasoning",reasoning:t.additional_kwargs.reasoning.summary.reduce((i,a)=>Ie(a)&&oe(a.text)?`${i}${a.text}`:i,"")});const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const s of r)if(be(s,"text")){const{text:i,annotations:a,...o}=s;Array.isArray(a)?yield{...o,type:"text",text:String(i),annotations:a.map(V1)}:yield{...o,type:"text",text:String(i)}}for(const s of t.tool_calls??[])yield{type:"tool_call",id:s.id,name:s.name,args:s.args};if(Ie(t.additional_kwargs)&&qn(t.additional_kwargs.tool_outputs))for(const s of t.additional_kwargs.tool_outputs){if(be(s,"web_search_call")){yield{id:s.id,type:"server_tool_call",name:"web_search",args:{query:s.query}};continue}else if(be(s,"file_search_call")){yield{id:s.id,type:"server_tool_call",name:"file_search",args:{query:s.query}};continue}else if(be(s,"computer_call")){yield{type:"non_standard",value:s};continue}else if(be(s,"code_interpreter_call")){if(oe(s.code)&&(yield{id:s.id,type:"server_tool_call",name:"code_interpreter",args:{code:s.code}}),qn(s.outputs)){const i=Oo(()=>{if(s.status!=="in_progress"){if(s.status==="completed")return 0;if(s.status==="incomplete")return 127;if(s.status!=="interpreting"&&s.status==="failed")return 1}});for(const a of s.outputs)if(be(a,"logs")){yield{type:"server_tool_call_result",toolCallId:s.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:i??0,stderr:[0,void 0].includes(i)?void 0:String(a.logs),stdout:[0,void 0].includes(i)?String(a.logs):void 0}};continue}}continue}else if(be(s,"mcp_call")){yield{id:s.id,type:"server_tool_call",name:"mcp_call",args:s.input};continue}else if(be(s,"mcp_list_tools")){yield{id:s.id,type:"server_tool_call",name:"mcp_list_tools",args:s.input};continue}else if(be(s,"mcp_approval_request")){yield{type:"non_standard",value:s};continue}else if(be(s,"image_generation_call")){yield{type:"non_standard",value:s};continue}Ie(s)&&(yield{type:"non_standard",value:s})}}return Array.from(e())}function q1(t){function*e(){yield*cE(t);for(const r of t.tool_call_chunks??[])yield{type:"tool_call_chunk",id:r.id,name:r.name,args:r.args}}return Array.from(e())}const H1={translateContent:t=>typeof t.content=="string"?F1(t):cE(t),translateContentChunk:t=>typeof t.content=="string"?z1(t):q1(t)};function lE(t){return typeof t=="object"&&t!==null&&"type"in t&&"content"in t&&(typeof t.content=="string"||Array.isArray(t.content))}const Zd=Symbol.for("langchain.message");function Mi(t,e){return typeof t=="string"?t===""?e:typeof e=="string"?t+e:Array.isArray(e)&&e.some(r=>Sn(r))?[{type:"text",source_type:"text",text:t},...e]:[{type:"text",text:t},...e]:Array.isArray(e)?cc(t,e)??[...t,...e]:e===""?t:Array.isArray(t)&&t.some(r=>Sn(r))?[...t,{type:"file",source_type:"text",text:e}]:[...t,{type:"text",text:e}]}function uE(t,e){return t==="error"||e==="error"?"error":"success"}function G1(t,e){function r(n,s){if(typeof n!="object"||n===null||n===void 0)return n;if(s>=e)return Array.isArray(n)?"[Array]":"[Object]";if(Array.isArray(n))return n.map(a=>r(a,s+1));const i={};for(const a of Object.keys(n))i[a]=r(n[a],s+1);return i}return JSON.stringify(r(t,0),null,2)}var Dv,nn=class extends sn{constructor(e){const r=typeof e=="string"||Array.isArray(e)?{content:e}:e;r.additional_kwargs||(r.additional_kwargs={}),r.response_metadata||(r.response_metadata={});super(r);p(this,"lc_namespace",["langchain_core","messages"]);p(this,"lc_serializable",!0);p(this,Dv,!0);p(this,"id");p(this,"name");p(this,"content");p(this,"additional_kwargs");p(this,"response_metadata");this.name=r.name,r.content===void 0&&r.contentBlocks!==void 0?(this.content=r.contentBlocks,this.response_metadata={output_version:"v1",...r.response_metadata}):r.content!==void 0?(this.content=r.content??[],this.response_metadata=r.response_metadata):(this.content=[],this.response_metadata=r.response_metadata),this.additional_kwargs=r.additional_kwargs,this.id=r.id}get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}_getType(){return this.type}getType(){return this._getType()}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}get contentBlocks(){const e=typeof this.content=="string"?[{type:"text",text:this.content}]:this.content;return[U1,zm,P1].reduce((s,i)=>i(s),e)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(e){return typeof e=="object"&&e!==null&&Zd in e&&e[Zd]===!0&&lE(e)}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[(Dv=Zd,Symbol.toStringTag)](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const r=G1(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${r}`}};function W1(t){return Array.isArray(t)&&t.every(e=>typeof e.index=="number")}function or(t={},e={}){const r={...t};for(const[n,s]of Object.entries(e))if(r[n]==null)r[n]=s;else{if(s==null)continue;if(typeof r[n]!=typeof s||Array.isArray(r[n])!==Array.isArray(s))throw new Error(`field[${n}] already exists in the message chunk, but with a different type.`);if(typeof r[n]=="string"){if(n==="type")continue;["id","name","output_version","model_provider"].includes(n)?r[n]=s:r[n]+=s}else if(typeof r[n]=="object"&&!Array.isArray(r[n]))r[n]=or(r[n],s);else if(Array.isArray(r[n]))r[n]=cc(r[n],s);else{if(r[n]===s)continue;console.warn(`field[${n}] already exists in this message chunk and value has unsupported type.`)}}return r}function cc(t,e){if(!(t===void 0&&e===void 0)){if(t===void 0||e===void 0)return t||e;{const r=[...t];for(const n of e)if(typeof n=="object"&&n!==null&&"index"in n&&typeof n.index=="number"){const s=r.findIndex(i=>{const a=typeof i=="object",o="index"in i&&i.index===n.index,c="id"in i&&"id"in n&&(i==null?void 0:i.id)===(n==null?void 0:n.id),l=!("id"in i)||!(i!=null&&i.id)||!("id"in n)||!(n!=null&&n.id);return a&&o&&(c||l)});s!==-1&&typeof r[s]=="object"&&r[s]!==null?r[s]=or(r[s],n):r.push(n)}else{if(typeof n=="object"&&n!==null&&"text"in n&&n.text==="")continue;r.push(n)}return r}}}function dE(t,e){if(!t&&!e)throw new Error("Cannot merge two undefined objects.");if(!t||!e)return t||e;if(typeof t!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof t}
Right ${typeof e}`);if(typeof t=="string"&&typeof e=="string")return t+e;if(Array.isArray(t)&&Array.isArray(e))return cc(t,e);if(typeof t=="object"&&typeof e=="object")return or(t,e);if(t===e)return t;throw new Error(`Can not merge objects of different types.
Left ${t}
Right ${e}`)}var Di=class extends nn{static isInstance(t){return super.isInstance(t)&&"concat"in t&&typeof t.concat=="function"}};function hE(t){return typeof t.role=="string"}function St(t){return typeof(t==null?void 0:t._getType)=="function"}function $o(t){return St(t)&&typeof t.concat=="function"}var fE={};ve(fE,{ToolMessage:()=>fr,ToolMessageChunk:()=>lc,defaultToolCallParser:()=>qm,isDirectToolOutput:()=>Vm,isToolMessage:()=>Hm,isToolMessageChunk:()=>pE});function Vm(t){return t!=null&&typeof t=="object"&&"lc_direct_tool_output"in t&&t.lc_direct_tool_output===!0}var fr=class extends nn{constructor(e,r,n){const s=typeof e=="string"||Array.isArray(e)?{content:e,name:n,tool_call_id:r}:e;super(s);p(this,"lc_direct_tool_output",!0);p(this,"type","tool");p(this,"status");p(this,"tool_call_id");p(this,"metadata");p(this,"artifact");this.tool_call_id=s.tool_call_id,this.artifact=s.artifact,this.status=s.status,this.metadata=s.metadata}static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}static isInstance(e){return super.isInstance(e)&&e.type==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},lc=class extends Di{constructor(e){super(e);p(this,"type","tool");p(this,"tool_call_id");p(this,"status");p(this,"artifact");this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}concat(e){const r=this.constructor;return new r({content:Mi(this.content,e.content),additional_kwargs:or(this.additional_kwargs,e.additional_kwargs),response_metadata:or(this.response_metadata,e.response_metadata),artifact:dE(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:uE(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function qm(t){const e=[],r=[];for(const n of t)if(n.function){const s=n.function.name;try{const i=JSON.parse(n.function.arguments);e.push({name:s||"",args:i||{},id:n.id})}catch{r.push({name:s,args:n.function.arguments,id:n.id,error:"Malformed args."})}}else continue;return[e,r]}function Hm(t){return typeof t=="object"&&t!==null&&"getType"in t&&typeof t.getType=="function"&&t.getType()==="tool"}function pE(t){return t._getType()==="tool"}const J1=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function go(t){return typeof t=="string"&&J1.test(t)}function Z1(t){if(!go(t))throw TypeError("Invalid UUID");var e,r=new Uint8Array(16);return r[0]=(e=parseInt(t.slice(0,8),16))>>>24,r[1]=e>>>16&255,r[2]=e>>>8&255,r[3]=e&255,r[4]=(e=parseInt(t.slice(9,13),16))>>>8,r[5]=e&255,r[6]=(e=parseInt(t.slice(14,18),16))>>>8,r[7]=e&255,r[8]=(e=parseInt(t.slice(19,23),16))>>>8,r[9]=e&255,r[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,r[11]=e/4294967296&255,r[12]=e>>>24&255,r[13]=e>>>16&255,r[14]=e>>>8&255,r[15]=e&255,r}var Ht=[];for(var Kd=0;Kd<256;++Kd)Ht.push((Kd+256).toString(16).slice(1));function mE(t,e=0){return(Ht[t[e+0]]+Ht[t[e+1]]+Ht[t[e+2]]+Ht[t[e+3]]+"-"+Ht[t[e+4]]+Ht[t[e+5]]+"-"+Ht[t[e+6]]+Ht[t[e+7]]+"-"+Ht[t[e+8]]+Ht[t[e+9]]+"-"+Ht[t[e+10]]+Ht[t[e+11]]+Ht[t[e+12]]+Ht[t[e+13]]+Ht[t[e+14]]+Ht[t[e+15]]).toLowerCase()}var Lc,K1=new Uint8Array(16);function X1(){if(!Lc&&(Lc=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Lc))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Lc(K1)}function Y1(t){t=unescape(encodeURIComponent(t));for(var e=[],r=0;r<t.length;++r)e.push(t.charCodeAt(r));return e}var Q1="6ba7b810-9dad-11d1-80b4-00c04fd430c8",eR="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function tR(t,e,r){function n(s,i,a,o){var c;if(typeof s=="string"&&(s=Y1(s)),typeof i=="string"&&(i=Z1(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var l=new Uint8Array(16+s.length);if(l.set(i),l.set(s,i.length),l=r(l),l[6]=l[6]&15|e,l[8]=l[8]&63|128,a){o=o||0;for(var u=0;u<16;++u)a[o+u]=l[u];return a}return mE(l)}try{n.name=t}catch{}return n.DNS=Q1,n.URL=eR,n}var rR=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const i_={randomUUID:rR};function ss(t,e,r){if(i_.randomUUID&&!t)return i_.randomUUID();t=t||{};var n=t.random||(t.rng||X1)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,mE(n)}function nR(t,e,r,n){switch(t){case 0:return e&r^~e&n;case 1:return e^r^n;case 2:return e&r^e&n^r&n;case 3:return e^r^n}}function Xd(t,e){return t<<e|t>>>32-e}function sR(t){var e=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var n=unescape(encodeURIComponent(t));t=[];for(var s=0;s<n.length;++s)t.push(n.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var i=t.length/4+2,a=Math.ceil(i/16),o=new Array(a),c=0;c<a;++c){for(var l=new Uint32Array(16),u=0;u<16;++u)l[u]=t[c*64+u*4]<<24|t[c*64+u*4+1]<<16|t[c*64+u*4+2]<<8|t[c*64+u*4+3];o[c]=l}o[a-1][14]=(t.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var h=new Uint32Array(80),f=0;f<16;++f)h[f]=o[d][f];for(var m=16;m<80;++m)h[m]=Xd(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var g=r[0],y=r[1],b=r[2],_=r[3],E=r[4],C=0;C<80;++C){var k=Math.floor(C/20),R=Xd(g,5)+nR(k,y,b,_)+E+e[k]+h[C]>>>0;E=_,_=b,b=Xd(y,30)>>>0,y=g,g=R}r[0]=r[0]+g>>>0,r[1]=r[1]+y>>>0,r[2]=r[2]+b>>>0,r[3]=r[3]+_>>>0,r[4]=r[4]+E>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,r[0]&255,r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,r[1]&255,r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,r[2]&255,r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,r[3]&255,r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,r[4]&255]}var a_=tR("v5",80,sR),gE={};ve(gE,{BaseCallbackHandler:()=>La,callbackHandlerPrefersStreaming:()=>Gm,isBaseCallbackHandler:()=>yE});var iR=class{};function Gm(t){return"lc_prefer_streaming"in t&&t.lc_prefer_streaming}var La=class extends iR{constructor(e){super();p(this,"lc_serializable",!1);p(this,"lc_kwargs");p(this,"ignoreLLM",!1);p(this,"ignoreChain",!1);p(this,"ignoreAgent",!1);p(this,"ignoreRetriever",!1);p(this,"ignoreCustomEvent",!1);p(this,"raiseError",!1);p(this,"awaitHandlers",rn("LANGCHAIN_CALLBACKS_BACKGROUND")==="false");this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Zu(this.constructor)]}copy(){return new this.constructor(this)}toJSON(){return sn.prototype.toJSON.call(this)}toJSONNotImplemented(){return sn.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class r extends La{constructor(){super();p(this,"name",ss());Object.assign(this,e)}}return new r}};const yE=t=>{const e=t;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"},aR=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function oR(t){return typeof t=="string"&&aR.test(t)}function cR(t){if(!oR(t))throw TypeError("Invalid UUID");var e,r=new Uint8Array(16);return r[0]=(e=parseInt(t.slice(0,8),16))>>>24,r[1]=e>>>16&255,r[2]=e>>>8&255,r[3]=e&255,r[4]=(e=parseInt(t.slice(9,13),16))>>>8,r[5]=e&255,r[6]=(e=parseInt(t.slice(14,18),16))>>>8,r[7]=e&255,r[8]=(e=parseInt(t.slice(19,23),16))>>>8,r[9]=e&255,r[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,r[11]=e/4294967296&255,r[12]=e>>>24&255,r[13]=e>>>16&255,r[14]=e>>>8&255,r[15]=e&255,r}var Gt=[];for(var Yd=0;Yd<256;++Yd)Gt.push((Yd+256).toString(16).slice(1));function _E(t,e=0){return(Gt[t[e+0]]+Gt[t[e+1]]+Gt[t[e+2]]+Gt[t[e+3]]+"-"+Gt[t[e+4]]+Gt[t[e+5]]+"-"+Gt[t[e+6]]+Gt[t[e+7]]+"-"+Gt[t[e+8]]+Gt[t[e+9]]+"-"+Gt[t[e+10]]+Gt[t[e+11]]+Gt[t[e+12]]+Gt[t[e+13]]+Gt[t[e+14]]+Gt[t[e+15]]).toLowerCase()}var Mc,lR=new Uint8Array(16);function uR(){if(!Mc&&(Mc=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Mc))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Mc(lR)}function dR(t){t=unescape(encodeURIComponent(t));for(var e=[],r=0;r<t.length;++r)e.push(t.charCodeAt(r));return e}var hR="6ba7b810-9dad-11d1-80b4-00c04fd430c8",fR="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function pR(t,e,r){function n(s,i,a,o){var c;if(typeof s=="string"&&(s=dR(s)),typeof i=="string"&&(i=cR(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var l=new Uint8Array(16+s.length);if(l.set(i),l.set(s,i.length),l=r(l),l[6]=l[6]&15|e,l[8]=l[8]&63|128,a){o=o||0;for(var u=0;u<16;++u)a[o+u]=l[u];return a}return _E(l)}try{n.name=t}catch{}return n.DNS=hR,n.URL=fR,n}var mR=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const o_={randomUUID:mR};function Qi(t,e,r){if(o_.randomUUID&&!t)return o_.randomUUID();t=t||{};var n=t.random||(t.rng||uR)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,_E(n)}function gR(t,e,r,n){switch(t){case 0:return e&r^~e&n;case 1:return e^r^n;case 2:return e&r^e&n^r&n;case 3:return e^r^n}}function Qd(t,e){return t<<e|t>>>32-e}function yR(t){var e=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var n=unescape(encodeURIComponent(t));t=[];for(var s=0;s<n.length;++s)t.push(n.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var i=t.length/4+2,a=Math.ceil(i/16),o=new Array(a),c=0;c<a;++c){for(var l=new Uint32Array(16),u=0;u<16;++u)l[u]=t[c*64+u*4]<<24|t[c*64+u*4+1]<<16|t[c*64+u*4+2]<<8|t[c*64+u*4+3];o[c]=l}o[a-1][14]=(t.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var h=new Uint32Array(80),f=0;f<16;++f)h[f]=o[d][f];for(var m=16;m<80;++m)h[m]=Qd(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var g=r[0],y=r[1],b=r[2],_=r[3],E=r[4],C=0;C<80;++C){var k=Math.floor(C/20),R=Qd(g,5)+gR(k,y,b,_)+E+e[k]+h[C]>>>0;E=_,_=b,b=Qd(y,30)>>>0,y=g,g=R}r[0]=r[0]+g>>>0,r[1]=r[1]+y>>>0,r[2]=r[2]+b>>>0,r[3]=r[3]+_>>>0,r[4]=r[4]+E>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,r[0]&255,r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,r[1]&255,r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,r[2]&255,r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,r[3]&255,r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,r[4]&255]}var c_=pR("v5",80,yR);const _R="gen_ai.operation.name",wR="gen_ai.system",l_="gen_ai.request.model",bR="gen_ai.response.model",u_="gen_ai.usage.input_tokens",d_="gen_ai.usage.output_tokens",h_="gen_ai.usage.total_tokens",vR="gen_ai.request.max_tokens",ER="gen_ai.request.temperature",SR="gen_ai.request.top_p",xR="gen_ai.request.frequency_penalty",TR="gen_ai.request.presence_penalty",AR="gen_ai.response.finish_reasons",CR="gen_ai.prompt",kR="gen_ai.completion",IR="gen_ai.request.extra_query",RR="gen_ai.request.extra_body",OR="gen_ai.serialized.name",$R="gen_ai.serialized.signature",NR="gen_ai.serialized.doc",PR="gen_ai.response.id",LR="gen_ai.response.service_tier",MR="gen_ai.response.system_fingerprint",DR="gen_ai.usage.input_token_details",UR="gen_ai.usage.output_token_details",BR="langsmith.trace.session_id",jR="langsmith.trace.session_name",FR="langsmith.span.kind",zR="langsmith.trace.name",VR="langsmith.metadata",f_="langsmith.span.tags",qR="langsmith.request.streaming",HR="langsmith.request.headers",GR=(...t)=>fetch(...t),wE=Symbol.for("ls:fetch_implementation"),WR=()=>{const t=globalThis[wE];return t?typeof t=="function"&&"Headers"in t&&"Request"in t&&"Response"in t:!1},JR=t=>async(...e)=>{if(t||Er("DEBUG")==="true"){const[n,s]=e;console.log(`→ ${(s==null?void 0:s.method)||"GET"} ${n}`)}const r=await(globalThis[wE]??GR)(...e);return(t||Er("DEBUG")==="true")&&console.log(`← ${r.status} ${r.statusText} ${r.url}`),r},bE=()=>Er("PROJECT")??Wn("LANGCHAIN_SESSION")??"default",vE="0.3.74";var yo={};let kn;const ZR=()=>typeof window<"u"&&typeof window.document<"u",KR=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",XR=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),EE=()=>typeof Deno<"u",YR=()=>typeof Vn<"u"&&typeof Vn.versions<"u"&&typeof Vn.versions.node<"u"&&!EE(),SE=()=>kn||(typeof Bun<"u"?kn="bun":ZR()?kn="browser":YR()?kn="node":KR()?kn="webworker":XR()?kn="jsdom":EE()?kn="deno":kn="other",kn);let eh;function xE(){if(eh===void 0){const t=SE(),e=eO();eh={library:"langsmith",runtime:t,sdk:"langsmith-js",sdk_version:vE,...e}}return eh}function TE(){const t=QR(),e={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[n,s]of Object.entries(t))typeof s=="string"&&!r.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[n]=s);return e}function QR(){const t={};try{if(typeof Vn<"u"&&yo)for(const[e,r]of Object.entries(yo))(e.startsWith("LANGCHAIN_")||e.startsWith("LANGSMITH_"))&&r!=null&&((e.toLowerCase().includes("key")||e.toLowerCase().includes("secret")||e.toLowerCase().includes("token"))&&typeof r=="string"?t[e]=r.slice(0,2)+"*".repeat(r.length-4)+r.slice(-2):t[e]=r)}catch{}return t}function Wn(t){try{return typeof Vn<"u"?yo==null?void 0:yo[t]:void 0}catch{return}}function Er(t){return Wn(`LANGSMITH_${t}`)||Wn(`LANGCHAIN_${t}`)}let th;function eO(){if(th!==void 0)return th;const t=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const r of t){const n=Wn(r);n!==void 0&&(e[r]=n)}return th=e,e}function AE(){return Wn("OTEL_ENABLED")==="true"||Er("OTEL_ENABLED")==="true"}class tO{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...r){!this.hasWarned&&AE()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let n;if(r.length===1&&typeof r[0]=="function"?n=r[0]:r.length===2&&typeof r[1]=="function"?n=r[1]:r.length===3&&typeof r[2]=="function"&&(n=r[2]),typeof n=="function")return n()}}class rO{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new tO})}getTracer(e,r){return this.mockTracer}getActiveSpan(){}setSpan(e,r){return e}getSpan(e){}setSpanContext(e,r){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}}class nO{active(){return{}}with(e,r){return r()}}const rh=Symbol.for("ls:otel_trace"),nh=Symbol.for("ls:otel_context"),p_=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),sO=new rO,iO=new nO;class aO{getTraceInstance(){return globalThis[rh]??sO}getContextInstance(){return globalThis[nh]??iO}initializeGlobalInstances(e){globalThis[rh]===void 0&&(globalThis[rh]=e.trace),globalThis[nh]===void 0&&(globalThis[nh]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[p_]=e}getDefaultOTLPTracerComponents(){return globalThis[p_]??void 0}}const Wm=new aO;function CE(){return Wm.getTraceInstance()}function oO(){return Wm.getContextInstance()}function cO(){return Wm.getDefaultOTLPTracerComponents()}const lO={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function uO(t){return lO[t]||t}class dO{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,r){for(const n of e)try{if(!n.run)continue;if(n.operation==="post"){const s=this.createSpanForRun(n,n.run,r.get(n.id));s&&!n.run.end_time&&this.spans.set(n.id,s)}else this.updateSpanForRun(n,n.run)}catch(s){console.error(`Error processing operation ${n.id}:`,s)}}createSpanForRun(e,r,n){const s=n&&CE().getSpan(n);if(s)try{return this.finishSpanSetup(s,r,e)}catch(i){console.error(`Failed to create span for run ${e.id}:`,i);return}}finishSpanSetup(e,r,n){return this.setSpanAttributes(e,r,n),r.error?(e.setStatus({code:2}),e.recordException(new Error(r.error))):e.setStatus({code:1}),r.end_time&&e.end(new Date(r.end_time)),e}updateSpanForRun(e,r){try{const n=this.spans.get(e.id);if(!n){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(n,r,e),r.error?(n.setStatus({code:2}),n.recordException(new Error(r.error))):n.setStatus({code:1});const s=r.end_time;s&&(n.end(new Date(s)),this.spans.delete(e.id))}catch(n){console.error(`Failed to update span for run ${e.id}:`,n)}}extractModelName(e){var r;if((r=e.extra)!=null&&r.metadata){const n=e.extra.metadata;if(n.ls_model_name)return n.ls_model_name;if(n.invocation_params){const s=n.invocation_params;if(s.model)return s.model;if(s.model_name)return s.model_name}}}setSpanAttributes(e,r,n){var o;if("run_type"in r&&r.run_type){e.setAttribute(FR,r.run_type);const c=uO(r.run_type||"chain");e.setAttribute(_R,c)}"name"in r&&r.name&&e.setAttribute(zR,r.name),"session_id"in r&&r.session_id&&e.setAttribute(BR,r.session_id),"session_name"in r&&r.session_name&&e.setAttribute(jR,r.session_name),this.setGenAiSystem(e,r);const s=this.extractModelName(r);s&&e.setAttribute(l_,s),"prompt_tokens"in r&&typeof r.prompt_tokens=="number"&&e.setAttribute(u_,r.prompt_tokens),"completion_tokens"in r&&typeof r.completion_tokens=="number"&&e.setAttribute(d_,r.completion_tokens),"total_tokens"in r&&typeof r.total_tokens=="number"&&e.setAttribute(h_,r.total_tokens),this.setInvocationParameters(e,r);const i=((o=r.extra)==null?void 0:o.metadata)||{};for(const[c,l]of Object.entries(i))l!=null&&e.setAttribute(`${VR}.${c}`,String(l));const a=r.tags;if(a&&Array.isArray(a)?e.setAttribute(f_,a.join(", ")):a&&e.setAttribute(f_,String(a)),"serialized"in r&&typeof r.serialized=="object"){const c=r.serialized;c.name&&e.setAttribute(OR,String(c.name)),c.signature&&e.setAttribute($R,String(c.signature)),c.doc&&e.setAttribute(NR,String(c.doc))}this.setIOAttributes(e,n)}setGenAiSystem(e,r){let n="langchain";const s=this.extractModelName(r);if(s){const i=s.toLowerCase();i.includes("anthropic")||i.startsWith("claude")?n="anthropic":i.includes("bedrock")?n="aws.bedrock":i.includes("azure")&&i.includes("openai")?n="az.ai.openai":i.includes("azure")&&i.includes("inference")?n="az.ai.inference":i.includes("cohere")?n="cohere":i.includes("deepseek")?n="deepseek":i.includes("gemini")?n="gemini":i.includes("groq")?n="groq":i.includes("watson")||i.includes("ibm")?n="ibm.watsonx.ai":i.includes("mistral")?n="mistral_ai":i.includes("gpt")||i.includes("openai")?n="openai":i.includes("perplexity")||i.includes("sonar")?n="perplexity":i.includes("vertex")?n="vertex_ai":(i.includes("xai")||i.includes("grok"))&&(n="xai")}e.setAttribute(wR,n)}setInvocationParameters(e,r){var s,i;if(!((i=(s=r.extra)==null?void 0:s.metadata)!=null&&i.invocation_params))return;const n=r.extra.metadata.invocation_params;n.max_tokens!==void 0&&e.setAttribute(vR,n.max_tokens),n.temperature!==void 0&&e.setAttribute(ER,n.temperature),n.top_p!==void 0&&e.setAttribute(SR,n.top_p),n.frequency_penalty!==void 0&&e.setAttribute(xR,n.frequency_penalty),n.presence_penalty!==void 0&&e.setAttribute(TR,n.presence_penalty)}setIOAttributes(e,r){if(r.run.inputs)try{const n=r.run.inputs;typeof n=="object"&&n!==null&&(n.model&&Array.isArray(n.messages)&&e.setAttribute(l_,n.model),n.stream!==void 0&&e.setAttribute(qR,n.stream),n.extra_headers&&e.setAttribute(HR,JSON.stringify(n.extra_headers)),n.extra_query&&e.setAttribute(IR,JSON.stringify(n.extra_query)),n.extra_body&&e.setAttribute(RR,JSON.stringify(n.extra_body))),e.setAttribute(CR,JSON.stringify(n))}catch(n){console.debug(`Failed to process inputs for run ${r.id}`,n)}if(r.run.outputs)try{const n=r.run.outputs,s=this.getUnifiedRunTokens(n);if(s&&(e.setAttribute(u_,s[0]),e.setAttribute(d_,s[1]),e.setAttribute(h_,s[0]+s[1])),n&&typeof n=="object"){if(n.model&&e.setAttribute(bR,String(n.model)),n.id&&e.setAttribute(PR,n.id),n.choices&&Array.isArray(n.choices)){const i=n.choices.map(a=>a.finish_reason).filter(a=>a).map(String);i.length>0&&e.setAttribute(AR,i.join(", "))}if(n.service_tier&&e.setAttribute(LR,n.service_tier),n.system_fingerprint&&e.setAttribute(MR,n.system_fingerprint),n.usage_metadata&&typeof n.usage_metadata=="object"){const i=n.usage_metadata;i.input_token_details&&e.setAttribute(DR,JSON.stringify(i.input_token_details)),i.output_token_details&&e.setAttribute(UR,JSON.stringify(i.output_token_details))}}e.setAttribute(kR,JSON.stringify(n))}catch(n){console.debug(`Failed to process outputs for run ${r.id}`,n)}}getUnifiedRunTokens(e){if(!e)return null;let r=this.extractUnifiedRunTokens(e.usage_metadata);if(r)return r;const n=Object.keys(e);for(const a of n){const o=e[a];if(!(!o||typeof o!="object")&&(r=this.extractUnifiedRunTokens(o.usage_metadata),r||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(r=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),r)))return r}const s=e.generations||[];if(!Array.isArray(s))return null;const i=Array.isArray(s[0])?s.flat():s;for(const a of i)if(typeof a=="object"&&a.message&&typeof a.message=="object"&&a.message.kwargs&&typeof a.message.kwargs=="object"&&(r=this.extractUnifiedRunTokens(a.message.kwargs.usage_metadata),r))return r;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}var qa={exports:{}},sh={},ih,m_;function hO(){if(m_)return ih;m_=1;function t(e,r){typeof r=="boolean"&&(r={forever:r}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=r||{},this._maxRetryTime=r&&r.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return ih=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var r=new Date().getTime();if(e&&r-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},n),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,r){this._fn=e,r&&(r.timeout&&(this._operationTimeout=r.timeout),r.cb&&(this._operationTimeoutCb=r.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},r=null,n=0,s=0;s<this._errors.length;s++){var i=this._errors[s],a=i.message,o=(e[a]||0)+1;e[a]=o,o>=n&&(r=i,n=o)}return r},ih}var g_;function fO(){return g_||(g_=1,(function(t){var e=hO();t.operation=function(r){var n=t.timeouts(r);return new e(n,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})},t.timeouts=function(r){if(r instanceof Array)return[].concat(r);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in r)n[s]=r[s];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],a=0;a<n.retries;a++)i.push(this.createTimeout(a,n));return r&&r.forever&&!i.length&&i.push(this.createTimeout(a,n)),i.sort(function(o,c){return o-c}),i},t.createTimeout=function(r,n){var s=n.randomize?Math.random()+1:1,i=Math.round(s*Math.max(n.minTimeout,1)*Math.pow(n.factor,r));return i=Math.min(i,n.maxTimeout),i},t.wrap=function(r,n,s){if(n instanceof Array&&(s=n,n=null),!s){s=[];for(var i in r)typeof r[i]=="function"&&s.push(i)}for(var a=0;a<s.length;a++){var o=s[a],c=r[o];r[o]=(function(u){var d=t.operation(n),h=Array.prototype.slice.call(arguments,1),f=h.pop();h.push(function(m){d.retry(m)||(m&&(arguments[0]=d.mainError()),f.apply(this,arguments))}),d.attempt(function(){u.apply(r,h)})}).bind(r,c),r[o].options=n}}})(sh)),sh}var ah,y_;function pO(){return y_||(y_=1,ah=fO()),ah}var __;function mO(){if(__)return qa.exports;__=1;const t=pO(),e=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class r extends Error{constructor(o){super(),o instanceof Error?(this.originalError=o,{message:o}=o):(this.originalError=new Error(o),this.originalError.stack=this.stack),this.name="AbortError",this.message=o}}const n=(a,o,c)=>{const l=c.retries-(o-1);return a.attemptNumber=o,a.retriesLeft=l,a},s=a=>e.includes(a),i=(a,o)=>new Promise((c,l)=>{o={onFailedAttempt:()=>{},retries:10,...o};const u=t.operation(o);u.attempt(async d=>{try{c(await a(d))}catch(h){if(!(h instanceof Error)){l(new TypeError(`Non-error was thrown: "${h}". You should only throw errors.`));return}if(h instanceof r)u.stop(),l(h.originalError);else if(h instanceof TypeError&&!s(h.message))u.stop(),l(h);else{n(h,d,o);try{await o.onFailedAttempt(h)}catch(f){l(f);return}u.retry(h)||l(u.mainError())}}})});return qa.exports=i,qa.exports.default=i,qa.exports.AbortError=r,qa.exports}var gO=mO();const Jl=Pa(gO);var Dc={},oh={exports:{}},w_;function yO(){return w_||(w_=1,(function(t){var e=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function s(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function i(c,l,u,d,h){if(typeof u!="function")throw new TypeError("The listener must be a function");var f=new s(u,d||c,h),m=r?r+l:l;return c._events[m]?c._events[m].fn?c._events[m]=[c._events[m],f]:c._events[m].push(f):(c._events[m]=f,c._eventsCount++),c}function a(c,l){--c._eventsCount===0?c._events=new n:delete c._events[l]}function o(){this._events=new n,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],u,d;if(this._eventsCount===0)return l;for(d in u=this._events)e.call(u,d)&&l.push(r?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},o.prototype.listeners=function(l){var u=r?r+l:l,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,m=new Array(f);h<f;h++)m[h]=d[h].fn;return m},o.prototype.listenerCount=function(l){var u=r?r+l:l,d=this._events[u];return d?d.fn?1:d.length:0},o.prototype.emit=function(l,u,d,h,f,m){var g=r?r+l:l;if(!this._events[g])return!1;var y=this._events[g],b=arguments.length,_,E;if(y.fn){switch(y.once&&this.removeListener(l,y.fn,void 0,!0),b){case 1:return y.fn.call(y.context),!0;case 2:return y.fn.call(y.context,u),!0;case 3:return y.fn.call(y.context,u,d),!0;case 4:return y.fn.call(y.context,u,d,h),!0;case 5:return y.fn.call(y.context,u,d,h,f),!0;case 6:return y.fn.call(y.context,u,d,h,f,m),!0}for(E=1,_=new Array(b-1);E<b;E++)_[E-1]=arguments[E];y.fn.apply(y.context,_)}else{var C=y.length,k;for(E=0;E<C;E++)switch(y[E].once&&this.removeListener(l,y[E].fn,void 0,!0),b){case 1:y[E].fn.call(y[E].context);break;case 2:y[E].fn.call(y[E].context,u);break;case 3:y[E].fn.call(y[E].context,u,d);break;case 4:y[E].fn.call(y[E].context,u,d,h);break;default:if(!_)for(k=1,_=new Array(b-1);k<b;k++)_[k-1]=arguments[k];y[E].fn.apply(y[E].context,_)}}return!0},o.prototype.on=function(l,u,d){return i(this,l,u,d,!1)},o.prototype.once=function(l,u,d){return i(this,l,u,d,!0)},o.prototype.removeListener=function(l,u,d,h){var f=r?r+l:l;if(!this._events[f])return this;if(!u)return a(this,f),this;var m=this._events[f];if(m.fn)m.fn===u&&(!h||m.once)&&(!d||m.context===d)&&a(this,f);else{for(var g=0,y=[],b=m.length;g<b;g++)(m[g].fn!==u||h&&!m[g].once||d&&m[g].context!==d)&&y.push(m[g]);y.length?this._events[f]=y.length===1?y[0]:y:a(this,f)}return this},o.prototype.removeAllListeners=function(l){var u;return l?(u=r?r+l:l,this._events[u]&&a(this,u)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,t.exports=o})(oh)),oh.exports}var Ha={exports:{}},ch,b_;function _O(){return b_||(b_=1,ch=(t,e)=>(e=e||(()=>{}),t.then(r=>new Promise(n=>{n(e())}).then(()=>r),r=>new Promise(n=>{n(e())}).then(()=>{throw r})))),ch}var v_;function wO(){if(v_)return Ha.exports;v_=1;const t=_O();class e extends Error{constructor(s){super(s),this.name="TimeoutError"}}const r=(n,s,i)=>new Promise((a,o)=>{if(typeof s!="number"||s<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(s===1/0){a(n);return}const c=setTimeout(()=>{if(typeof i=="function"){try{a(i())}catch(d){o(d)}return}const l=typeof i=="string"?i:`Promise timed out after ${s} milliseconds`,u=i instanceof Error?i:new e(l);typeof n.cancel=="function"&&n.cancel(),o(u)},s);t(n.then(a,o),()=>{clearTimeout(c)})});return Ha.exports=r,Ha.exports.default=r,Ha.exports.TimeoutError=e,Ha.exports}var Uc={},Bc={},E_;function bO(){if(E_)return Bc;E_=1,Object.defineProperty(Bc,"__esModule",{value:!0});function t(e,r,n){let s=0,i=e.length;for(;i>0;){const a=i/2|0;let o=s+a;n(e[o],r)<=0?(s=++o,i-=a+1):i=a}return s}return Bc.default=t,Bc}var S_;function vO(){if(S_)return Uc;S_=1,Object.defineProperty(Uc,"__esModule",{value:!0});const t=bO();class e{constructor(){this._queue=[]}enqueue(n,s){s=Object.assign({priority:0},s);const i={priority:s.priority,run:n};if(this.size&&this._queue[this.size-1].priority>=s.priority){this._queue.push(i);return}const a=t.default(this._queue,i,(o,c)=>c.priority-o.priority);this._queue.splice(a,0,i)}dequeue(){const n=this._queue.shift();return n==null?void 0:n.run}filter(n){return this._queue.filter(s=>s.priority===n.priority).map(s=>s.run)}get size(){return this._queue.length}}return Uc.default=e,Uc}var x_;function EO(){if(x_)return Dc;x_=1,Object.defineProperty(Dc,"__esModule",{value:!0});const t=yO(),e=wO(),r=vO(),n=()=>{},s=new e.TimeoutError;class i extends t{constructor(o){var c,l,u,d;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=n,this._resolveIdle=n,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:r.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(l=(c=o.intervalCap)===null||c===void 0?void 0:c.toString())!==null&&l!==void 0?l:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(d=(u=o.interval)===null||u===void 0?void 0:u.toString())!==null&&d!==void 0?d:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=n,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=n,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const o=Date.now();if(this._intervalId===void 0){const c=this._intervalEnd-o;if(c<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},c)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const c=this._queue.dequeue();return c?(this.emit("active"),c(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,c={}){return new Promise((l,u)=>{const d=async()=>{this._pendingCount++,this._intervalCount++;try{const h=this._timeout===void 0&&c.timeout===void 0?o():e.default(Promise.resolve(o()),c.timeout===void 0?this._timeout:c.timeout,()=>{(c.throwOnTimeout===void 0?this._throwOnTimeout:c.throwOnTimeout)&&u(s)});l(await h)}catch(h){u(h)}this._next()};this._queue.enqueue(d,c),this._tryToStartAnother(),this.emit("add")})}async addAll(o,c){return Promise.all(o.map(async l=>this.add(l,c)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{const c=this._resolveEmpty;this._resolveEmpty=()=>{c(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{const c=this._resolveIdle;this._resolveIdle=()=>{c(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}}return Dc.default=i,Dc}var SO=EO();const ds=Pa(SO),xO=[429,500,502,503,504];let T_=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in ds?this.queue=new ds.default({concurrency:this.maxConcurrency}):this.queue=new ds({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...r){const n=this.onFailedResponseHook;return this.queue.add(()=>Jl(()=>e(...r).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.name==="TimeoutError"||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;const i=s==null?void 0:s.response;if(n&&await n(i))return;const a=(i==null?void 0:i.status)??(s==null?void 0:s.status);if(a&&!xO.includes(+a))throw s},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,r,...n){return e.signal?Promise.race([this.call(r,...n),new Promise((s,i)=>{var a;(a=e.signal)==null||a.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(r,...n)}};function A_(t){return typeof(t==null?void 0:t._getType)=="function"}function C_(t){const e={type:t._getType(),data:{content:t.content}};return t!=null&&t.additional_kwargs&&Object.keys(t.additional_kwargs).length>0&&(e.data.additional_kwargs={...t.additional_kwargs}),e}const TO=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function Oe(t,e){if(!TO.test(t)){const r=e!==void 0?`Invalid UUID for ${e}: ${t}`:`Invalid UUID: ${t}`;throw new Error(r)}return t}const k_={};function ip(t){k_[t]||(console.warn(t),k_[t]=!0)}var jc={exports:{}},lh,I_;function Yu(){if(I_)return lh;I_=1;const t="2.0.0",e=256,r=Number.MAX_SAFE_INTEGER||9007199254740991,n=16,s=e-6;return lh={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:s,MAX_SAFE_INTEGER:r,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:t,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},lh}var uh,R_;function Qu(){if(R_)return uh;R_=1;var t={};return uh=typeof Vn=="object"&&t&&t.NODE_DEBUG&&/\bsemver\b/i.test(t.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{},uh}var O_;function uc(){return O_||(O_=1,(function(t,e){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:s}=Yu(),i=Qu();e=t.exports={};const a=e.re=[],o=e.safeRe=[],c=e.src=[],l=e.safeSrc=[],u=e.t={};let d=0;const h="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",s],[h,n]],m=y=>{for(const[b,_]of f)y=y.split(`${b}*`).join(`${b}{0,${_}}`).split(`${b}+`).join(`${b}{1,${_}}`);return y},g=(y,b,_)=>{const E=m(b),C=d++;i(y,C,b),u[y]=C,c[C]=b,l[C]=E,a[C]=new RegExp(b,_?"g":void 0),o[C]=new RegExp(E,_?"g":void 0)};g("NUMERICIDENTIFIER","0|[1-9]\\d*"),g("NUMERICIDENTIFIERLOOSE","\\d+"),g("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),g("MAINVERSION",`(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})`),g("MAINVERSIONLOOSE",`(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})`),g("PRERELEASEIDENTIFIER",`(?:${c[u.NONNUMERICIDENTIFIER]}|${c[u.NUMERICIDENTIFIER]})`),g("PRERELEASEIDENTIFIERLOOSE",`(?:${c[u.NONNUMERICIDENTIFIER]}|${c[u.NUMERICIDENTIFIERLOOSE]})`),g("PRERELEASE",`(?:-(${c[u.PRERELEASEIDENTIFIER]}(?:\\.${c[u.PRERELEASEIDENTIFIER]})*))`),g("PRERELEASELOOSE",`(?:-?(${c[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[u.PRERELEASEIDENTIFIERLOOSE]})*))`),g("BUILDIDENTIFIER",`${h}+`),g("BUILD",`(?:\\+(${c[u.BUILDIDENTIFIER]}(?:\\.${c[u.BUILDIDENTIFIER]})*))`),g("FULLPLAIN",`v?${c[u.MAINVERSION]}${c[u.PRERELEASE]}?${c[u.BUILD]}?`),g("FULL",`^${c[u.FULLPLAIN]}$`),g("LOOSEPLAIN",`[v=\\s]*${c[u.MAINVERSIONLOOSE]}${c[u.PRERELEASELOOSE]}?${c[u.BUILD]}?`),g("LOOSE",`^${c[u.LOOSEPLAIN]}$`),g("GTLT","((?:<|>)?=?)"),g("XRANGEIDENTIFIERLOOSE",`${c[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),g("XRANGEIDENTIFIER",`${c[u.NUMERICIDENTIFIER]}|x|X|\\*`),g("XRANGEPLAIN",`[v=\\s]*(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:${c[u.PRERELEASE]})?${c[u.BUILD]}?)?)?`),g("XRANGEPLAINLOOSE",`[v=\\s]*(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:${c[u.PRERELEASELOOSE]})?${c[u.BUILD]}?)?)?`),g("XRANGE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAIN]}$`),g("XRANGELOOSE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAINLOOSE]}$`),g("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),g("COERCE",`${c[u.COERCEPLAIN]}(?:$|[^\\d])`),g("COERCEFULL",c[u.COERCEPLAIN]+`(?:${c[u.PRERELEASE]})?(?:${c[u.BUILD]})?(?:$|[^\\d])`),g("COERCERTL",c[u.COERCE],!0),g("COERCERTLFULL",c[u.COERCEFULL],!0),g("LONETILDE","(?:~>?)"),g("TILDETRIM",`(\\s*)${c[u.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",g("TILDE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAIN]}$`),g("TILDELOOSE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAINLOOSE]}$`),g("LONECARET","(?:\\^)"),g("CARETTRIM",`(\\s*)${c[u.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",g("CARET",`^${c[u.LONECARET]}${c[u.XRANGEPLAIN]}$`),g("CARETLOOSE",`^${c[u.LONECARET]}${c[u.XRANGEPLAINLOOSE]}$`),g("COMPARATORLOOSE",`^${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]})$|^$`),g("COMPARATOR",`^${c[u.GTLT]}\\s*(${c[u.FULLPLAIN]})$|^$`),g("COMPARATORTRIM",`(\\s*)${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]}|${c[u.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",g("HYPHENRANGE",`^\\s*(${c[u.XRANGEPLAIN]})\\s+-\\s+(${c[u.XRANGEPLAIN]})\\s*$`),g("HYPHENRANGELOOSE",`^\\s*(${c[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[u.XRANGEPLAINLOOSE]})\\s*$`),g("STAR","(<|>)?=?\\s*\\*"),g("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),g("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(jc,jc.exports)),jc.exports}var dh,$_;function Jm(){if($_)return dh;$_=1;const t=Object.freeze({loose:!0}),e=Object.freeze({});return dh=n=>n?typeof n!="object"?t:n:e,dh}var hh,N_;function kE(){if(N_)return hh;N_=1;const t=/^[0-9]+$/,e=(n,s)=>{if(typeof n=="number"&&typeof s=="number")return n===s?0:n<s?-1:1;const i=t.test(n),a=t.test(s);return i&&a&&(n=+n,s=+s),n===s?0:i&&!a?-1:a&&!i?1:n<s?-1:1};return hh={compareIdentifiers:e,rcompareIdentifiers:(n,s)=>e(s,n)},hh}var fh,P_;function gr(){if(P_)return fh;P_=1;const t=Qu(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:r}=Yu(),{safeRe:n,t:s}=uc(),i=Jm(),{compareIdentifiers:a}=kE();class o{constructor(l,u){if(u=i(u),l instanceof o){if(l.loose===!!u.loose&&l.includePrerelease===!!u.includePrerelease)return l;l=l.version}else if(typeof l!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof l}".`);if(l.length>e)throw new TypeError(`version is longer than ${e} characters`);t("SemVer",l,u),this.options=u,this.loose=!!u.loose,this.includePrerelease=!!u.includePrerelease;const d=l.trim().match(u.loose?n[s.LOOSE]:n[s.FULL]);if(!d)throw new TypeError(`Invalid Version: ${l}`);if(this.raw=l,this.major=+d[1],this.minor=+d[2],this.patch=+d[3],this.major>r||this.major<0)throw new TypeError("Invalid major version");if(this.minor>r||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>r||this.patch<0)throw new TypeError("Invalid patch version");d[4]?this.prerelease=d[4].split(".").map(h=>{if(/^[0-9]+$/.test(h)){const f=+h;if(f>=0&&f<r)return f}return h}):this.prerelease=[],this.build=d[5]?d[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(l){if(t("SemVer.compare",this.version,this.options,l),!(l instanceof o)){if(typeof l=="string"&&l===this.version)return 0;l=new o(l,this.options)}return l.version===this.version?0:this.compareMain(l)||this.comparePre(l)}compareMain(l){return l instanceof o||(l=new o(l,this.options)),this.major<l.major?-1:this.major>l.major?1:this.minor<l.minor?-1:this.minor>l.minor?1:this.patch<l.patch?-1:this.patch>l.patch?1:0}comparePre(l){if(l instanceof o||(l=new o(l,this.options)),this.prerelease.length&&!l.prerelease.length)return-1;if(!this.prerelease.length&&l.prerelease.length)return 1;if(!this.prerelease.length&&!l.prerelease.length)return 0;let u=0;do{const d=this.prerelease[u],h=l.prerelease[u];if(t("prerelease compare",u,d,h),d===void 0&&h===void 0)return 0;if(h===void 0)return 1;if(d===void 0)return-1;if(d===h)continue;return a(d,h)}while(++u)}compareBuild(l){l instanceof o||(l=new o(l,this.options));let u=0;do{const d=this.build[u],h=l.build[u];if(t("build compare",u,d,h),d===void 0&&h===void 0)return 0;if(h===void 0)return 1;if(d===void 0)return-1;if(d===h)continue;return a(d,h)}while(++u)}inc(l,u,d){if(l.startsWith("pre")){if(!u&&d===!1)throw new Error("invalid increment argument: identifier is empty");if(u){const h=`-${u}`.match(this.options.loose?n[s.PRERELEASELOOSE]:n[s.PRERELEASE]);if(!h||h[1]!==u)throw new Error(`invalid identifier: ${u}`)}}switch(l){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",u,d);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",u,d);break;case"prepatch":this.prerelease.length=0,this.inc("patch",u,d),this.inc("pre",u,d);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",u,d),this.inc("pre",u,d);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const h=Number(d)?1:0;if(this.prerelease.length===0)this.prerelease=[h];else{let f=this.prerelease.length;for(;--f>=0;)typeof this.prerelease[f]=="number"&&(this.prerelease[f]++,f=-2);if(f===-1){if(u===this.prerelease.join(".")&&d===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(h)}}if(u){let f=[u,h];d===!1&&(f=[u]),a(this.prerelease[0],u)===0?isNaN(this.prerelease[1])&&(this.prerelease=f):this.prerelease=f}break}default:throw new Error(`invalid increment argument: ${l}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return fh=o,fh}var ph,L_;function Ma(){if(L_)return ph;L_=1;const t=gr();return ph=(r,n,s=!1)=>{if(r instanceof t)return r;try{return new t(r,n)}catch(i){if(!s)return null;throw i}},ph}var mh,M_;function AO(){if(M_)return mh;M_=1;const t=Ma();return mh=(r,n)=>{const s=t(r,n);return s?s.version:null},mh}var gh,D_;function CO(){if(D_)return gh;D_=1;const t=Ma();return gh=(r,n)=>{const s=t(r.trim().replace(/^[=v]+/,""),n);return s?s.version:null},gh}var yh,U_;function kO(){if(U_)return yh;U_=1;const t=gr();return yh=(r,n,s,i,a)=>{typeof s=="string"&&(a=i,i=s,s=void 0);try{return new t(r instanceof t?r.version:r,s).inc(n,i,a).version}catch{return null}},yh}var _h,B_;function IO(){if(B_)return _h;B_=1;const t=Ma();return _h=(r,n)=>{const s=t(r,null,!0),i=t(n,null,!0),a=s.compare(i);if(a===0)return null;const o=a>0,c=o?s:i,l=o?i:s,u=!!c.prerelease.length;if(!!l.prerelease.length&&!u){if(!l.patch&&!l.minor)return"major";if(l.compareMain(c)===0)return l.minor&&!l.patch?"minor":"patch"}const h=u?"pre":"";return s.major!==i.major?h+"major":s.minor!==i.minor?h+"minor":s.patch!==i.patch?h+"patch":"prerelease"},_h}var wh,j_;function RO(){if(j_)return wh;j_=1;const t=gr();return wh=(r,n)=>new t(r,n).major,wh}var bh,F_;function OO(){if(F_)return bh;F_=1;const t=gr();return bh=(r,n)=>new t(r,n).minor,bh}var vh,z_;function $O(){if(z_)return vh;z_=1;const t=gr();return vh=(r,n)=>new t(r,n).patch,vh}var Eh,V_;function NO(){if(V_)return Eh;V_=1;const t=Ma();return Eh=(r,n)=>{const s=t(r,n);return s&&s.prerelease.length?s.prerelease:null},Eh}var Sh,q_;function Tn(){if(q_)return Sh;q_=1;const t=gr();return Sh=(r,n,s)=>new t(r,s).compare(new t(n,s)),Sh}var xh,H_;function PO(){if(H_)return xh;H_=1;const t=Tn();return xh=(r,n,s)=>t(n,r,s),xh}var Th,G_;function LO(){if(G_)return Th;G_=1;const t=Tn();return Th=(r,n)=>t(r,n,!0),Th}var Ah,W_;function Zm(){if(W_)return Ah;W_=1;const t=gr();return Ah=(r,n,s)=>{const i=new t(r,s),a=new t(n,s);return i.compare(a)||i.compareBuild(a)},Ah}var Ch,J_;function MO(){if(J_)return Ch;J_=1;const t=Zm();return Ch=(r,n)=>r.sort((s,i)=>t(s,i,n)),Ch}var kh,Z_;function DO(){if(Z_)return kh;Z_=1;const t=Zm();return kh=(r,n)=>r.sort((s,i)=>t(i,s,n)),kh}var Ih,K_;function ed(){if(K_)return Ih;K_=1;const t=Tn();return Ih=(r,n,s)=>t(r,n,s)>0,Ih}var Rh,X_;function Km(){if(X_)return Rh;X_=1;const t=Tn();return Rh=(r,n,s)=>t(r,n,s)<0,Rh}var Oh,Y_;function IE(){if(Y_)return Oh;Y_=1;const t=Tn();return Oh=(r,n,s)=>t(r,n,s)===0,Oh}var $h,Q_;function RE(){if(Q_)return $h;Q_=1;const t=Tn();return $h=(r,n,s)=>t(r,n,s)!==0,$h}var Nh,ew;function Xm(){if(ew)return Nh;ew=1;const t=Tn();return Nh=(r,n,s)=>t(r,n,s)>=0,Nh}var Ph,tw;function Ym(){if(tw)return Ph;tw=1;const t=Tn();return Ph=(r,n,s)=>t(r,n,s)<=0,Ph}var Lh,rw;function OE(){if(rw)return Lh;rw=1;const t=IE(),e=RE(),r=ed(),n=Xm(),s=Km(),i=Ym();return Lh=(o,c,l,u)=>{switch(c){case"===":return typeof o=="object"&&(o=o.version),typeof l=="object"&&(l=l.version),o===l;case"!==":return typeof o=="object"&&(o=o.version),typeof l=="object"&&(l=l.version),o!==l;case"":case"=":case"==":return t(o,l,u);case"!=":return e(o,l,u);case">":return r(o,l,u);case">=":return n(o,l,u);case"<":return s(o,l,u);case"<=":return i(o,l,u);default:throw new TypeError(`Invalid operator: ${c}`)}},Lh}var Mh,nw;function UO(){if(nw)return Mh;nw=1;const t=gr(),e=Ma(),{safeRe:r,t:n}=uc();return Mh=(i,a)=>{if(i instanceof t)return i;if(typeof i=="number"&&(i=String(i)),typeof i!="string")return null;a=a||{};let o=null;if(!a.rtl)o=i.match(a.includePrerelease?r[n.COERCEFULL]:r[n.COERCE]);else{const f=a.includePrerelease?r[n.COERCERTLFULL]:r[n.COERCERTL];let m;for(;(m=f.exec(i))&&(!o||o.index+o[0].length!==i.length);)(!o||m.index+m[0].length!==o.index+o[0].length)&&(o=m),f.lastIndex=m.index+m[1].length+m[2].length;f.lastIndex=-1}if(o===null)return null;const c=o[2],l=o[3]||"0",u=o[4]||"0",d=a.includePrerelease&&o[5]?`-${o[5]}`:"",h=a.includePrerelease&&o[6]?`+${o[6]}`:"";return e(`${c}.${l}.${u}${d}${h}`,a)},Mh}var Dh,sw;function BO(){if(sw)return Dh;sw=1;class t{constructor(){this.max=1e3,this.map=new Map}get(r){const n=this.map.get(r);if(n!==void 0)return this.map.delete(r),this.map.set(r,n),n}delete(r){return this.map.delete(r)}set(r,n){if(!this.delete(r)&&n!==void 0){if(this.map.size>=this.max){const i=this.map.keys().next().value;this.delete(i)}this.map.set(r,n)}return this}}return Dh=t,Dh}var Uh,iw;function An(){if(iw)return Uh;iw=1;const t=/\s+/g;class e{constructor(z,G){if(G=s(G),z instanceof e)return z.loose===!!G.loose&&z.includePrerelease===!!G.includePrerelease?z:new e(z.raw,G);if(z instanceof i)return this.raw=z.value,this.set=[[z]],this.formatted=void 0,this;if(this.options=G,this.loose=!!G.loose,this.includePrerelease=!!G.includePrerelease,this.raw=z.trim().replace(t," "),this.set=this.raw.split("||").map(ie=>this.parseRange(ie.trim())).filter(ie=>ie.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const ie=this.set[0];if(this.set=this.set.filter(ce=>!g(ce[0])),this.set.length===0)this.set=[ie];else if(this.set.length>1){for(const ce of this.set)if(ce.length===1&&y(ce[0])){this.set=[ce];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let z=0;z<this.set.length;z++){z>0&&(this.formatted+="||");const G=this.set[z];for(let ie=0;ie<G.length;ie++)ie>0&&(this.formatted+=" "),this.formatted+=G[ie].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(z){const ie=((this.options.includePrerelease&&f)|(this.options.loose&&m))+":"+z,ce=n.get(ie);if(ce)return ce;const te=this.options.loose,le=te?c[l.HYPHENRANGELOOSE]:c[l.HYPHENRANGE];z=z.replace(le,se(this.options.includePrerelease)),a("hyphen replace",z),z=z.replace(c[l.COMPARATORTRIM],u),a("comparator trim",z),z=z.replace(c[l.TILDETRIM],d),a("tilde trim",z),z=z.replace(c[l.CARETTRIM],h),a("caret trim",z);let Ee=z.split(" ").map(V=>_(V,this.options)).join(" ").split(/\s+/).map(V=>q(V,this.options));te&&(Ee=Ee.filter(V=>(a("loose invalid filter",V,this.options),!!V.match(c[l.COMPARATORLOOSE])))),a("range list",Ee);const W=new Map,X=Ee.map(V=>new i(V,this.options));for(const V of X){if(g(V))return[V];W.set(V.value,V)}W.size>1&&W.has("")&&W.delete("");const ae=[...W.values()];return n.set(ie,ae),ae}intersects(z,G){if(!(z instanceof e))throw new TypeError("a Range is required");return this.set.some(ie=>b(ie,G)&&z.set.some(ce=>b(ce,G)&&ie.every(te=>ce.every(le=>te.intersects(le,G)))))}test(z){if(!z)return!1;if(typeof z=="string")try{z=new o(z,this.options)}catch{return!1}for(let G=0;G<this.set.length;G++)if(pe(this.set[G],z,this.options))return!0;return!1}}Uh=e;const r=BO(),n=new r,s=Jm(),i=td(),a=Qu(),o=gr(),{safeRe:c,t:l,comparatorTrimReplace:u,tildeTrimReplace:d,caretTrimReplace:h}=uc(),{FLAG_INCLUDE_PRERELEASE:f,FLAG_LOOSE:m}=Yu(),g=j=>j.value==="<0.0.0-0",y=j=>j.value==="",b=(j,z)=>{let G=!0;const ie=j.slice();let ce=ie.pop();for(;G&&ie.length;)G=ie.every(te=>ce.intersects(te,z)),ce=ie.pop();return G},_=(j,z)=>(j=j.replace(c[l.BUILD],""),a("comp",j,z),j=R(j,z),a("caret",j),j=C(j,z),a("tildes",j),j=S(j,z),a("xrange",j),j=B(j,z),a("stars",j),j),E=j=>!j||j.toLowerCase()==="x"||j==="*",C=(j,z)=>j.trim().split(/\s+/).map(G=>k(G,z)).join(" "),k=(j,z)=>{const G=z.loose?c[l.TILDELOOSE]:c[l.TILDE];return j.replace(G,(ie,ce,te,le,Ee)=>{a("tilde",j,ie,ce,te,le,Ee);let W;return E(ce)?W="":E(te)?W=`>=${ce}.0.0 <${+ce+1}.0.0-0`:E(le)?W=`>=${ce}.${te}.0 <${ce}.${+te+1}.0-0`:Ee?(a("replaceTilde pr",Ee),W=`>=${ce}.${te}.${le}-${Ee} <${ce}.${+te+1}.0-0`):W=`>=${ce}.${te}.${le} <${ce}.${+te+1}.0-0`,a("tilde return",W),W})},R=(j,z)=>j.trim().split(/\s+/).map(G=>$(G,z)).join(" "),$=(j,z)=>{a("caret",j,z);const G=z.loose?c[l.CARETLOOSE]:c[l.CARET],ie=z.includePrerelease?"-0":"";return j.replace(G,(ce,te,le,Ee,W)=>{a("caret",j,ce,te,le,Ee,W);let X;return E(te)?X="":E(le)?X=`>=${te}.0.0${ie} <${+te+1}.0.0-0`:E(Ee)?te==="0"?X=`>=${te}.${le}.0${ie} <${te}.${+le+1}.0-0`:X=`>=${te}.${le}.0${ie} <${+te+1}.0.0-0`:W?(a("replaceCaret pr",W),te==="0"?le==="0"?X=`>=${te}.${le}.${Ee}-${W} <${te}.${le}.${+Ee+1}-0`:X=`>=${te}.${le}.${Ee}-${W} <${te}.${+le+1}.0-0`:X=`>=${te}.${le}.${Ee}-${W} <${+te+1}.0.0-0`):(a("no pr"),te==="0"?le==="0"?X=`>=${te}.${le}.${Ee}${ie} <${te}.${le}.${+Ee+1}-0`:X=`>=${te}.${le}.${Ee}${ie} <${te}.${+le+1}.0-0`:X=`>=${te}.${le}.${Ee} <${+te+1}.0.0-0`),a("caret return",X),X})},S=(j,z)=>(a("replaceXRanges",j,z),j.split(/\s+/).map(G=>M(G,z)).join(" ")),M=(j,z)=>{j=j.trim();const G=z.loose?c[l.XRANGELOOSE]:c[l.XRANGE];return j.replace(G,(ie,ce,te,le,Ee,W)=>{a("xRange",j,ie,ce,te,le,Ee,W);const X=E(te),ae=X||E(le),V=ae||E(Ee),A=V;return ce==="="&&A&&(ce=""),W=z.includePrerelease?"-0":"",X?ce===">"||ce==="<"?ie="<0.0.0-0":ie="*":ce&&A?(ae&&(le=0),Ee=0,ce===">"?(ce=">=",ae?(te=+te+1,le=0,Ee=0):(le=+le+1,Ee=0)):ce==="<="&&(ce="<",ae?te=+te+1:le=+le+1),ce==="<"&&(W="-0"),ie=`${ce+te}.${le}.${Ee}${W}`):ae?ie=`>=${te}.0.0${W} <${+te+1}.0.0-0`:V&&(ie=`>=${te}.${le}.0${W} <${te}.${+le+1}.0-0`),a("xRange return",ie),ie})},B=(j,z)=>(a("replaceStars",j,z),j.trim().replace(c[l.STAR],"")),q=(j,z)=>(a("replaceGTE0",j,z),j.trim().replace(c[z.includePrerelease?l.GTE0PRE:l.GTE0],"")),se=j=>(z,G,ie,ce,te,le,Ee,W,X,ae,V,A)=>(E(ie)?G="":E(ce)?G=`>=${ie}.0.0${j?"-0":""}`:E(te)?G=`>=${ie}.${ce}.0${j?"-0":""}`:le?G=`>=${G}`:G=`>=${G}${j?"-0":""}`,E(X)?W="":E(ae)?W=`<${+X+1}.0.0-0`:E(V)?W=`<${X}.${+ae+1}.0-0`:A?W=`<=${X}.${ae}.${V}-${A}`:j?W=`<${X}.${ae}.${+V+1}-0`:W=`<=${W}`,`${G} ${W}`.trim()),pe=(j,z,G)=>{for(let ie=0;ie<j.length;ie++)if(!j[ie].test(z))return!1;if(z.prerelease.length&&!G.includePrerelease){for(let ie=0;ie<j.length;ie++)if(a(j[ie].semver),j[ie].semver!==i.ANY&&j[ie].semver.prerelease.length>0){const ce=j[ie].semver;if(ce.major===z.major&&ce.minor===z.minor&&ce.patch===z.patch)return!0}return!1}return!0};return Uh}var Bh,aw;function td(){if(aw)return Bh;aw=1;const t=Symbol("SemVer ANY");class e{static get ANY(){return t}constructor(u,d){if(d=r(d),u instanceof e){if(u.loose===!!d.loose)return u;u=u.value}u=u.trim().split(/\s+/).join(" "),a("comparator",u,d),this.options=d,this.loose=!!d.loose,this.parse(u),this.semver===t?this.value="":this.value=this.operator+this.semver.version,a("comp",this)}parse(u){const d=this.options.loose?n[s.COMPARATORLOOSE]:n[s.COMPARATOR],h=u.match(d);if(!h)throw new TypeError(`Invalid comparator: ${u}`);this.operator=h[1]!==void 0?h[1]:"",this.operator==="="&&(this.operator=""),h[2]?this.semver=new o(h[2],this.options.loose):this.semver=t}toString(){return this.value}test(u){if(a("Comparator.test",u,this.options.loose),this.semver===t||u===t)return!0;if(typeof u=="string")try{u=new o(u,this.options)}catch{return!1}return i(u,this.operator,this.semver,this.options)}intersects(u,d){if(!(u instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(u.value,d).test(this.value):u.operator===""?u.value===""?!0:new c(this.value,d).test(u.semver):(d=r(d),d.includePrerelease&&(this.value==="<0.0.0-0"||u.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||u.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&u.operator.startsWith(">")||this.operator.startsWith("<")&&u.operator.startsWith("<")||this.semver.version===u.semver.version&&this.operator.includes("=")&&u.operator.includes("=")||i(this.semver,"<",u.semver,d)&&this.operator.startsWith(">")&&u.operator.startsWith("<")||i(this.semver,">",u.semver,d)&&this.operator.startsWith("<")&&u.operator.startsWith(">")))}}Bh=e;const r=Jm(),{safeRe:n,t:s}=uc(),i=OE(),a=Qu(),o=gr(),c=An();return Bh}var jh,ow;function rd(){if(ow)return jh;ow=1;const t=An();return jh=(r,n,s)=>{try{n=new t(n,s)}catch{return!1}return n.test(r)},jh}var Fh,cw;function jO(){if(cw)return Fh;cw=1;const t=An();return Fh=(r,n)=>new t(r,n).set.map(s=>s.map(i=>i.value).join(" ").trim().split(" ")),Fh}var zh,lw;function FO(){if(lw)return zh;lw=1;const t=gr(),e=An();return zh=(n,s,i)=>{let a=null,o=null,c=null;try{c=new e(s,i)}catch{return null}return n.forEach(l=>{c.test(l)&&(!a||o.compare(l)===-1)&&(a=l,o=new t(a,i))}),a},zh}var Vh,uw;function zO(){if(uw)return Vh;uw=1;const t=gr(),e=An();return Vh=(n,s,i)=>{let a=null,o=null,c=null;try{c=new e(s,i)}catch{return null}return n.forEach(l=>{c.test(l)&&(!a||o.compare(l)===1)&&(a=l,o=new t(a,i))}),a},Vh}var qh,dw;function VO(){if(dw)return qh;dw=1;const t=gr(),e=An(),r=ed();return qh=(s,i)=>{s=new e(s,i);let a=new t("0.0.0");if(s.test(a)||(a=new t("0.0.0-0"),s.test(a)))return a;a=null;for(let o=0;o<s.set.length;++o){const c=s.set[o];let l=null;c.forEach(u=>{const d=new t(u.semver.version);switch(u.operator){case">":d.prerelease.length===0?d.patch++:d.prerelease.push(0),d.raw=d.format();case"":case">=":(!l||r(d,l))&&(l=d);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${u.operator}`)}}),l&&(!a||r(a,l))&&(a=l)}return a&&s.test(a)?a:null},qh}var Hh,hw;function qO(){if(hw)return Hh;hw=1;const t=An();return Hh=(r,n)=>{try{return new t(r,n).range||"*"}catch{return null}},Hh}var Gh,fw;function Qm(){if(fw)return Gh;fw=1;const t=gr(),e=td(),{ANY:r}=e,n=An(),s=rd(),i=ed(),a=Km(),o=Ym(),c=Xm();return Gh=(u,d,h,f)=>{u=new t(u,f),d=new n(d,f);let m,g,y,b,_;switch(h){case">":m=i,g=o,y=a,b=">",_=">=";break;case"<":m=a,g=c,y=i,b="<",_="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(s(u,d,f))return!1;for(let E=0;E<d.set.length;++E){const C=d.set[E];let k=null,R=null;if(C.forEach($=>{$.semver===r&&($=new e(">=0.0.0")),k=k||$,R=R||$,m($.semver,k.semver,f)?k=$:y($.semver,R.semver,f)&&(R=$)}),k.operator===b||k.operator===_||(!R.operator||R.operator===b)&&g(u,R.semver))return!1;if(R.operator===_&&y(u,R.semver))return!1}return!0},Gh}var Wh,pw;function HO(){if(pw)return Wh;pw=1;const t=Qm();return Wh=(r,n,s)=>t(r,n,">",s),Wh}var Jh,mw;function GO(){if(mw)return Jh;mw=1;const t=Qm();return Jh=(r,n,s)=>t(r,n,"<",s),Jh}var Zh,gw;function WO(){if(gw)return Zh;gw=1;const t=An();return Zh=(r,n,s)=>(r=new t(r,s),n=new t(n,s),r.intersects(n,s)),Zh}var Kh,yw;function JO(){if(yw)return Kh;yw=1;const t=rd(),e=Tn();return Kh=(r,n,s)=>{const i=[];let a=null,o=null;const c=r.sort((h,f)=>e(h,f,s));for(const h of c)t(h,n,s)?(o=h,a||(a=h)):(o&&i.push([a,o]),o=null,a=null);a&&i.push([a,null]);const l=[];for(const[h,f]of i)h===f?l.push(h):!f&&h===c[0]?l.push("*"):f?h===c[0]?l.push(`<=${f}`):l.push(`${h} - ${f}`):l.push(`>=${h}`);const u=l.join(" || "),d=typeof n.raw=="string"?n.raw:String(n);return u.length<d.length?u:n},Kh}var Xh,_w;function ZO(){if(_w)return Xh;_w=1;const t=An(),e=td(),{ANY:r}=e,n=rd(),s=Tn(),i=(d,h,f={})=>{if(d===h)return!0;d=new t(d,f),h=new t(h,f);let m=!1;e:for(const g of d.set){for(const y of h.set){const b=c(g,y,f);if(m=m||b!==null,b)continue e}if(m)return!1}return!0},a=[new e(">=0.0.0-0")],o=[new e(">=0.0.0")],c=(d,h,f)=>{if(d===h)return!0;if(d.length===1&&d[0].semver===r){if(h.length===1&&h[0].semver===r)return!0;f.includePrerelease?d=a:d=o}if(h.length===1&&h[0].semver===r){if(f.includePrerelease)return!0;h=o}const m=new Set;let g,y;for(const S of d)S.operator===">"||S.operator===">="?g=l(g,S,f):S.operator==="<"||S.operator==="<="?y=u(y,S,f):m.add(S.semver);if(m.size>1)return null;let b;if(g&&y){if(b=s(g.semver,y.semver,f),b>0)return null;if(b===0&&(g.operator!==">="||y.operator!=="<="))return null}for(const S of m){if(g&&!n(S,String(g),f)||y&&!n(S,String(y),f))return null;for(const M of h)if(!n(S,String(M),f))return!1;return!0}let _,E,C,k,R=y&&!f.includePrerelease&&y.semver.prerelease.length?y.semver:!1,$=g&&!f.includePrerelease&&g.semver.prerelease.length?g.semver:!1;R&&R.prerelease.length===1&&y.operator==="<"&&R.prerelease[0]===0&&(R=!1);for(const S of h){if(k=k||S.operator===">"||S.operator===">=",C=C||S.operator==="<"||S.operator==="<=",g){if($&&S.semver.prerelease&&S.semver.prerelease.length&&S.semver.major===$.major&&S.semver.minor===$.minor&&S.semver.patch===$.patch&&($=!1),S.operator===">"||S.operator===">="){if(_=l(g,S,f),_===S&&_!==g)return!1}else if(g.operator===">="&&!n(g.semver,String(S),f))return!1}if(y){if(R&&S.semver.prerelease&&S.semver.prerelease.length&&S.semver.major===R.major&&S.semver.minor===R.minor&&S.semver.patch===R.patch&&(R=!1),S.operator==="<"||S.operator==="<="){if(E=u(y,S,f),E===S&&E!==y)return!1}else if(y.operator==="<="&&!n(y.semver,String(S),f))return!1}if(!S.operator&&(y||g)&&b!==0)return!1}return!(g&&C&&!y&&b!==0||y&&k&&!g&&b!==0||$||R)},l=(d,h,f)=>{if(!d)return h;const m=s(d.semver,h.semver,f);return m>0?d:m<0||h.operator===">"&&d.operator===">="?h:d},u=(d,h,f)=>{if(!d)return h;const m=s(d.semver,h.semver,f);return m<0?d:m>0||h.operator==="<"&&d.operator==="<="?h:d};return Xh=i,Xh}var Yh,ww;function KO(){if(ww)return Yh;ww=1;const t=uc(),e=Yu(),r=gr(),n=kE(),s=Ma(),i=AO(),a=CO(),o=kO(),c=IO(),l=RO(),u=OO(),d=$O(),h=NO(),f=Tn(),m=PO(),g=LO(),y=Zm(),b=MO(),_=DO(),E=ed(),C=Km(),k=IE(),R=RE(),$=Xm(),S=Ym(),M=OE(),B=UO(),q=td(),se=An(),pe=rd(),j=jO(),z=FO(),G=zO(),ie=VO(),ce=qO(),te=Qm(),le=HO(),Ee=GO(),W=WO(),X=JO(),ae=ZO();return Yh={parse:s,valid:i,clean:a,inc:o,diff:c,major:l,minor:u,patch:d,prerelease:h,compare:f,rcompare:m,compareLoose:g,compareBuild:y,sort:b,rsort:_,gt:E,lt:C,eq:k,neq:R,gte:$,lte:S,cmp:M,coerce:B,Comparator:q,Range:se,satisfies:pe,toComparators:j,maxSatisfying:z,minSatisfying:G,minVersion:ie,validRange:ce,outside:te,gtr:le,ltr:Ee,intersects:W,simplifyRange:X,subset:ae,SemVer:r,re:t.re,src:t.src,tokens:t.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:n.compareIdentifiers,rcompareIdentifiers:n.rcompareIdentifiers},Yh}KO();function xs(t){if(!t||t.split("/").length>2||t.startsWith("/")||t.endsWith("/")||t.split(":").length>2)throw new Error(`Invalid identifier format: ${t}`);const[e,r]=t.split(":"),n=r||"latest";if(e.includes("/")){const[s,i]=e.split("/",2);if(!s||!i)throw new Error(`Invalid identifier format: ${t}`);return[s,i,n]}else{if(!e)throw new Error(`Invalid identifier format: ${t}`);return["-",e,n]}}class XO extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function _e(t,e,r){let n;if(t.ok){r&&(n=await t.text());return}if(t.status===403)try{const a=await t.json();(a==null?void 0:a.error)==="org_scoped_key_requires_workspace"&&(n="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const o=new Error(`${t.status} ${t.statusText}`);throw o.status=t==null?void 0:t.status,o}if(n===void 0)try{n=await t.text()}catch{n=""}const s=`Failed to ${e}. Received status [${t.status}]: ${t.statusText}. Message: ${n}`;if(t.status===409)throw new XO(s);const i=new Error(s);throw i.status=t.status,i}const $E="ERR_CONFLICTING_ENDPOINTS";class YO extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:$E}),this.name="ConflictingEndpointsError"}}function QO(t){return typeof t=="object"&&t!==null&&t.code===$E}var bw="[...]",e$={result:"[Circular]"},Zl=[],oa=[];const t$=new TextEncoder;function r$(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function Fc(t){return t$.encode(t)}function NE(t){if(t&&typeof t=="object"&&t!==null){if(t instanceof Map)return Object.fromEntries(t);if(t instanceof Set)return Array.from(t);if(t instanceof Date)return t.toISOString();if(t instanceof RegExp)return t.toString();if(t instanceof Error)return{name:t.name,message:t.message}}else if(typeof t=="bigint")return t.toString();return t}function n$(t){return function(e,r){return NE(r)}}function Lr(t,e,r,n,s){var i;try{const a=JSON.stringify(t,n$(r),n);return Fc(a)}catch(a){if(!((i=a.message)!=null&&i.includes("Converting circular structure to JSON")))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),Fc("[Unserializable]");Er("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof s>"u"&&(s=r$()),ap(t,"",0,[],void 0,0,s);let o;try{oa.length===0?o=JSON.stringify(t,r,n):o=JSON.stringify(t,s$(r),n)}catch{return Fc("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Zl.length!==0;){const c=Zl.pop();c.length===4?Object.defineProperty(c[0],c[1],c[3]):c[0][c[1]]=c[2]}}return Fc(o)}}function Qh(t,e,r,n){var s=Object.getOwnPropertyDescriptor(n,r);s.get!==void 0?s.configurable?(Object.defineProperty(n,r,{value:t}),Zl.push([n,r,e,s])):oa.push([e,r,t]):(n[r]=t,Zl.push([n,r,e]))}function ap(t,e,r,n,s,i,a){i+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<n.length;o++)if(n[o]===t){Qh(e$,t,e,s);return}if(typeof a.depthLimit<"u"&&i>a.depthLimit){Qh(bw,t,e,s);return}if(typeof a.edgesLimit<"u"&&r+1>a.edgesLimit){Qh(bw,t,e,s);return}if(n.push(t),Array.isArray(t))for(o=0;o<t.length;o++)ap(t[o],o,o,n,t,i,a);else{t=NE(t);var c=Object.keys(t);for(o=0;o<c.length;o++){var l=c[o];ap(t[l],l,o,n,t,i,a)}}n.pop()}}function s$(t){return t=typeof t<"u"?t:function(e,r){return r},function(e,r){if(oa.length>0)for(var n=0;n<oa.length;n++){var s=oa[n];if(s[1]===e&&s[0]===r){r=s[2],oa.splice(n,1);break}}return t.call(this,e,r)}}function vw(t,e){const r=xE(),n=e??TE(),s=t.extra??{},i=s.metadata;return t.extra={...s,runtime:{...r,...s==null?void 0:s.runtime},metadata:{...n,...n.revision_id||"revision_id"in t&&t.revision_id?{revision_id:("revision_id"in t?t.revision_id:void 0)??n.revision_id}:{},...i}},t}const i$=t=>{const e=(t==null?void 0:t.toString())??Er("TRACING_SAMPLING_RATE");if(e===void 0)return;const r=parseFloat(e);if(r<0||r>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${r}`);return r},a$=t=>{const r=t.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return r==="localhost"||r==="127.0.0.1"||r==="::1"};async function o$(t){const e=[];for await(const r of t)e.push(r);return e}function zc(t){if(t!==void 0)return t.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const c$=async t=>{if((t==null?void 0:t.status)===429){const e=parseInt(t.headers.get("retry-after")??"10",10)*1e3;if(e>0)return await new Promise(r=>setTimeout(r,e)),!0}return!1};function Ew(t){return typeof t=="number"?Number(t.toFixed(4)):t}class l${constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let r;const n=new Promise(i=>{r=i}),s=Lr(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:r,itemPromise:n,size:s}),this.sizeBytes+=s,n}pop({upToSizeBytes:e,upToSize:r}){var i;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const n=[];let s=0;for(;s+(((i=this.peek())==null?void 0:i.size)??0)<e&&this.items.length>0&&n.length<r;){const a=this.items.shift();a&&(n.push(a),s+=a.size,this.sizeBytes-=a.size)}if(n.length===0&&this.items.length>0){const a=this.items.shift();n.push(a),s+=a.size,this.sizeBytes-=a.size}return[n.map(a=>({action:a.action,item:a.payload,otelContext:a.otelContext,apiKey:a.apiKey,apiUrl:a.apiUrl})),()=>n.forEach(a=>a.itemPromiseResolve())]}}const u$=24*1024*1024,d$=1e4,h$=100,Sw="https://api.smith.langchain.com";let eg=class op{get _fetch(){return this.fetchImplementation||JR(this.debug)}constructor(e={}){var n;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new l$}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Wn("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:Wn("LANGSMITH_DEBUG")==="true"});const r=op.getDefaultClientConfig();if(this.tracingSampleRate=i$(e.tracingSamplingRate),this.apiUrl=zc(e.apiUrl??r.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=zc(e.apiKey??r.apiKey),this.webUrl=zc(e.webUrl??r.webUrl),(n=this.webUrl)!=null&&n.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=zc(e.workspaceId??Er("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new T_({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation,this.batchIngestCaller=new T_({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:c$,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??r.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??r.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,AE()&&(this.langSmithToOTELTranslator=new dO),this.cachedLSEnvVarsForMetadata=TE()}static getDefaultClientConfig(){const e=Er("API_KEY"),r=Er("ENDPOINT")??Sw,n=Er("HIDE_INPUTS")==="true",s=Er("HIDE_OUTPUTS")==="true";return{apiUrl:r,apiKey:e,webUrl:void 0,hideInputs:n,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:a$(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${vE}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const r={...e};return r.inputs!==void 0&&(r.inputs=await this.processInputs(r.inputs)),r.outputs!==void 0&&(r.outputs=await this.processOutputs(r.outputs)),r}async _getResponse(e,r){const n=(r==null?void 0:r.toString())??"",s=`${this.apiUrl}${e}?${n}`;return await this.caller.call(async()=>{const a=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,`fetch ${e}`),a})}async _get(e,r){return(await this._getResponse(e,r)).json()}async*_getPaginated(e,r=new URLSearchParams,n){let s=Number(r.get("offset"))||0;const i=Number(r.get("limit"))||100;for(;;){r.set("offset",String(s)),r.set("limit",String(i));const a=`${this.apiUrl}${e}?${r}`,o=await this.caller.call(async()=>{const l=await this._fetch(a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(l,`fetch ${e}`),l}),c=n?n(await o.json()):await o.json();if(c.length===0||(yield c,c.length<i))break;s+=c.length}}async*_getCursorPaginatedList(e,r=null,n="POST",s="runs"){const i=r?{...r}:{};for(;;){const a=JSON.stringify(i),c=await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(u,`fetch ${e}`),u})).json();if(!c||!c[s])break;yield c[s];const l=c.cursors;if(!l||!l.next)break;i.cursor=l.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,r=!1){if(this.tracingSampleRate===void 0)return e;if(r){const n=[];for(const s of e)this.filteredPostUuids.has(s.trace_id)?s.id===s.trace_id&&this.filteredPostUuids.delete(s.trace_id):n.push(s);return n}else{const n=[];for(const s of e){const i=s.trace_id??s.id;this.filteredPostUuids.has(i)||(s.id===i?this._shouldSample()?n.push(s):this.filteredPostUuids.add(i):n.push(s))}return n}}async _getBatchSizeLimitBytes(){var r;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((r=e.batch_ingest_config)==null?void 0:r.size_limit_bytes)??u$}async _getBatchSizeLimit(){var r;const e=await this._ensureServerInfo();return this.batchSizeLimit??((r=e.batch_ingest_config)==null?void 0:r.size_limit)??h$}async _getDatasetExamplesMultiPartSupport(){var r;return((r=(await this._ensureServerInfo()).instance_flags)==null?void 0:r.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:r}){const n=[];for(;this.autoBatchQueue.items.length>0;){const[s,i]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:r});if(!s.length){i();break}const a=s.reduce((l,u)=>{const d=u.apiUrl??this.apiUrl,h=u.apiKey??this.apiKey,m=u.apiKey===this.apiKey&&u.apiUrl===this.apiUrl?"default":`${d}|${h}`;return l[m]||(l[m]=[]),l[m].push(u),l},{}),o=[];for(const[l,u]of Object.entries(a)){const d=this._processBatch(u,{apiUrl:l==="default"?void 0:l.split("|")[0],apiKey:l==="default"?void 0:l.split("|")[1]});o.push(d)}const c=Promise.all(o).finally(i);n.push(c)}return Promise.all(n)}async _processBatch(e,r){var n,s;if(e.length)try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(e);else{const i={runCreates:e.filter(o=>o.action==="create").map(o=>o.item),runUpdates:e.filter(o=>o.action==="update").map(o=>o.item)},a=await this._ensureServerInfo();if((n=a==null?void 0:a.batch_ingest_config)!=null&&n.use_multipart_endpoint){const o=(s=a==null?void 0:a.instance_flags)==null?void 0:s.gzip_body_enabled;await this.multipartIngestRuns(i,{...r,useGzip:o})}else await this.batchIngestRuns(i,r)}}catch(i){console.error("Error exporting batch:",i)}}_sendBatchToOTELTranslator(e){if(this.langSmithToOTELTranslator!==void 0){const r=new Map,n=[];for(const s of e)s.item.id&&s.otelContext&&(r.set(s.item.id,s.otelContext),s.action==="create"?n.push({operation:"post",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}):n.push({operation:"patch",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}));this.langSmithToOTELTranslator.exportBatch(n,r)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=vw(e.item,this.cachedLSEnvVarsForMetadata);const r=this.autoBatchQueue.push(e);if(this.manualFlushMode)return r;const n=await this._getBatchSizeLimitBytes(),s=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>n||this.autoBatchQueue.items.length>s)&&this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:s}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:s})},this.autoBatchAggregationDelayMs)),r}async _getServerInfo(){const r=await(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(d$),...this.fetchOptions});return await _e(n,"get server info"),n})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(r,null,2)+`
`),r}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),r=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:r})}_cloneCurrentOTELContext(){const e=CE(),r=oO();if(this.langSmithToOTELTranslator!==void 0){const n=e.getActiveSpan();if(n)return e.setSpan(r.active(),n)}}async createRun(e,r){if(!this._filterForSampling([e]).length)return;const n={...this.headers,"Content-Type":"application/json"},s=e.project_name;delete e.project_name;const i=await this.prepareRunCreateOrUpdateInputs({session_name:s,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){const c=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:i,otelContext:c,apiKey:r==null?void 0:r.apiKey,apiUrl:r==null?void 0:r.apiUrl}).catch(console.error);return}const a=vw(i,this.cachedLSEnvVarsForMetadata);(r==null?void 0:r.apiKey)!==void 0&&(n["x-api-key"]=r.apiKey),(r==null?void 0:r.workspaceId)!==void 0&&(n["x-tenant-id"]=r.workspaceId);const o=Lr(a,`Creating run with id: ${a.id}`);await this.caller.call(async()=>{const c=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"create run",!0),c})}async batchIngestRuns({runCreates:e,runUpdates:r},n){if(e===void 0&&r===void 0)return;let s=await Promise.all((e==null?void 0:e.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[]),i=await Promise.all((r==null?void 0:r.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[]);if(s.length>0&&i.length>0){const c=s.reduce((u,d)=>(d.id&&(u[d.id]=d),u),{}),l=[];for(const u of i)u.id!==void 0&&c[u.id]?c[u.id]={...c[u.id],...u}:l.push(u);s=Object.values(c),i=l}const a={post:s,patch:i};if(!a.post.length&&!a.patch.length)return;const o={post:[],patch:[]};for(const c of["post","patch"]){const l=c,u=a[l].reverse();let d=u.pop();for(;d!==void 0;)o[l].push(d),d=u.pop()}if(o.post.length>0||o.patch.length>0){const c=o.post.map(l=>l.id).concat(o.patch.map(l=>l.id)).join(",");await this._postBatchIngestRuns(Lr(o,`Ingesting runs with ids: ${c}`),n)}}async _postBatchIngestRuns(e,r){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"};(r==null?void 0:r.apiKey)!==void 0&&(n["x-api-key"]=r.apiKey),await this.batchIngestCaller.call(async()=>{const s=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/batch`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await _e(s,"batch create run",!0),s})}async multipartIngestRuns({runCreates:e,runUpdates:r},n){if(e===void 0&&r===void 0)return;const s={};let i=[];for(const d of e??[]){const h=await this.prepareRunCreateOrUpdateInputs(d);h.id!==void 0&&h.attachments!==void 0&&(s[h.id]=h.attachments),delete h.attachments,i.push(h)}let a=[];for(const d of r??[])a.push(await this.prepareRunCreateOrUpdateInputs(d));if(i.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(a.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(i.length>0&&a.length>0){const d=i.reduce((f,m)=>(m.id&&(f[m.id]=m),f),{}),h=[];for(const f of a)f.id!==void 0&&d[f.id]?d[f.id]={...d[f.id],...f}:h.push(f);i=Object.values(d),a=h}if(i.length===0&&a.length===0)return;const l=[],u=[];for(const[d,h]of[["post",i],["patch",a]])for(const f of h){const{inputs:m,outputs:g,events:y,extra:b,error:_,serialized:E,attachments:C,...k}=f,R={inputs:m,outputs:g,events:y,extra:b,error:_,serialized:E},$=Lr(k,`Serializing for multipart ingestion of run with id: ${k.id}`);u.push({name:`${d}.${k.id}`,payload:new Blob([$],{type:`application/json; length=${$.length}`})});for(const[S,M]of Object.entries(R)){if(M===void 0)continue;const B=Lr(M,`Serializing ${S} for multipart ingestion of run with id: ${k.id}`);u.push({name:`${d}.${k.id}.${S}`,payload:new Blob([B],{type:`application/json; length=${B.length}`})})}if(k.id!==void 0){const S=s[k.id];if(S){delete s[k.id];for(const[M,B]of Object.entries(S)){let q,se;if(Array.isArray(B)?[q,se]=B:(q=B.mimeType,se=B.data),M.includes(".")){console.warn(`Skipping attachment '${M}' for run ${k.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}u.push({name:`attachment.${k.id}.${M}`,payload:new Blob([se],{type:`${q}; length=${se.byteLength}`})})}}}l.push(`trace=${k.trace_id},id=${k.id}`)}await this._sendMultipartRequest(u,l.join("; "),n)}async _createNodeFetchBody(e,r){const n=[];for(const a of e)n.push(new Blob([`--${r}\r
`])),n.push(new Blob([`Content-Disposition: form-data; name="${a.name}"\r
`,`Content-Type: ${a.payload.type}\r
\r
`])),n.push(a.payload),n.push(new Blob([`\r
`]));return n.push(new Blob([`--${r}--\r
`])),await new Blob(n).arrayBuffer()}async _createMultipartStream(e,r){const n=new TextEncoder;return new ReadableStream({async start(i){const a=async o=>{typeof o=="string"?i.enqueue(n.encode(o)):i.enqueue(o)};for(const o of e){await a(`--${r}\r
`),await a(`Content-Disposition: form-data; name="${o.name}"\r
`),await a(`Content-Type: ${o.payload.type}\r
\r
`);const l=o.payload.stream().getReader();try{let u;for(;!(u=await l.read()).done;)i.enqueue(u.value)}finally{l.releaseLock()}await a(`\r
`)}await a(`--${r}--\r
`),i.close()}})}async _sendMultipartRequest(e,r,n){const s="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),i=WR(),a=()=>this._createNodeFetchBody(e,s),o=()=>this._createMultipartStream(e,s),c=async l=>this.batchIngestCaller.call(async()=>{const u=await l(),d={...this.headers,"Content-Type":`multipart/form-data; boundary=${s}`};(n==null?void 0:n.apiKey)!==void 0&&(d["x-api-key"]=n.apiKey);let h=u;n!=null&&n.useGzip&&typeof u=="object"&&"pipeThrough"in u&&(h=u.pipeThrough(new CompressionStream("gzip")),d["Content-Encoding"]="gzip");const f=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/multipart`,{method:"POST",headers:d,body:h,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(f,"Failed to send multipart request",!0),f});try{let l,u=!1;!i&&!this.multipartStreamingDisabled&&SE()!=="bun"?(u=!0,l=await c(o)):l=await c(a),(!this.multipartStreamingDisabled||u)&&l.status===422&&((n==null?void 0:n.apiUrl)??this.apiUrl)!==Sw&&(console.warn(`Streaming multipart upload to ${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${r}".`),this.multipartStreamingDisabled=!0,l=await c(a))}catch(l){console.warn(`${l.message.trim()}

Context: ${r}`)}}async updateRun(e,r,n){Oe(e),r.inputs&&(r.inputs=await this.processInputs(r.inputs)),r.outputs&&(r.outputs=await this.processOutputs(r.outputs));const s={...r,id:e};if(!this._filterForSampling([s],!0).length)return;if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){const o=this._cloneCurrentOTELContext();if(r.end_time!==void 0&&s.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:n==null?void 0:n.apiKey,apiUrl:n==null?void 0:n.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:n==null?void 0:n.apiKey,apiUrl:n==null?void 0:n.apiUrl}).catch(console.error);return}const i={...this.headers,"Content-Type":"application/json"};(n==null?void 0:n.apiKey)!==void 0&&(i["x-api-key"]=n.apiKey),(n==null?void 0:n.workspaceId)!==void 0&&(i["x-tenant-id"]=n.workspaceId);const a=Lr(r,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const o=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(o,"update run",!0),o})}async readRun(e,{loadChildRuns:r}={loadChildRuns:!1}){Oe(e);let n=await this._get(`/runs/${e}`);return r&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:r,projectOpts:n}){if(r!==void 0){let s;r.session_id?s=r.session_id:n!=null&&n.projectName?s=(await this.readProject({projectName:n==null?void 0:n.projectName})).id:n!=null&&n.projectId?s=n==null?void 0:n.projectId:s=(await this.readProject({projectName:Er("PROJECT")||"default"})).id;const i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${s}/r/${r.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){var i;const r=await o$(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),n={},s={};r.sort((a,o)=>((a==null?void 0:a.dotted_order)??"").localeCompare((o==null?void 0:o.dotted_order)??""));for(const a of r){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);(i=a.dotted_order)!=null&&i.startsWith(e.dotted_order??"")&&a.id!==e.id&&(a.parent_run_id in n||(n[a.parent_run_id]=[]),n[a.parent_run_id].push(a),s[a.id]=a)}e.child_runs=n[e.id]||[];for(const a in n)a!==e.id&&(s[a].child_runs=n[a]);return e}async*listRuns(e){const{projectId:r,projectName:n,parentRunId:s,traceId:i,referenceExampleId:a,startTime:o,executionOrder:c,isRoot:l,runType:u,error:d,id:h,query:f,filter:m,traceFilter:g,treeFilter:y,limit:b,select:_,order:E}=e;let C=[];if(r&&(C=Array.isArray(r)?r:[r]),n){const S=Array.isArray(n)?n:[n],M=await Promise.all(S.map(B=>this.readProject({projectName:B}).then(q=>q.id)));C.push(...M)}const k=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],R={session:C.length?C:null,run_type:u,reference_example:a,query:f,filter:m,trace_filter:g,tree_filter:y,execution_order:c,parent_run:s,start_time:o?o.toISOString():null,error:d,id:h,limit:b,trace:i,select:_||k,is_root:l,order:E};R.select.includes("child_run_ids")&&ip("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let $=0;for await(const S of this._getCursorPaginatedList("/runs/query",R))if(b){if($>=b)break;if(S.length+$>b){yield*S.slice(0,b-$);break}$+=S.length,yield*S}else yield*S}async*listGroupRuns(e){const{projectId:r,projectName:n,groupBy:s,filter:i,startTime:a,endTime:o,limit:c,offset:l}=e,d={session_id:r||(await this.readProject({projectName:n})).id,group_by:s,filter:i,start_time:a?a.toISOString():null,end_time:o?o.toISOString():null,limit:Number(c)||100};let h=Number(l)||0;const f="/runs/group",m=`${this.apiUrl}${f}`;for(;;){const g={...d,offset:h},y=Object.fromEntries(Object.entries(g).filter(([R,$])=>$!==void 0)),b=JSON.stringify(y),E=await(await this.caller.call(async()=>{const R=await this._fetch(m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:b});return await _e(R,`Failed to fetch ${f}`),R})).json(),{groups:C,total:k}=E;if(C.length===0)break;for(const R of C)yield R;if(h+=C.length,h>=k)break}}async getRunStats({id:e,trace:r,parentRun:n,runType:s,projectNames:i,projectIds:a,referenceExampleIds:o,startTime:c,endTime:l,error:u,query:d,filter:h,traceFilter:f,treeFilter:m,isRoot:g,dataSourceType:y}){let b=a||[];i&&(b=[...a||[],...await Promise.all(i.map($=>this.readProject({projectName:$}).then(S=>S.id)))]);const E=Object.fromEntries(Object.entries({id:e,trace:r,parent_run:n,run_type:s,session:b,reference_example:o,start_time:c,end_time:l,error:u,query:d,filter:h,trace_filter:f,tree_filter:m,is_root:g,data_source_type:y}).filter(([$,S])=>S!==void 0)),C=JSON.stringify(E);return await(await this.caller.call(async()=>{const $=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:C});return await _e($,"get run stats"),$})).json()}async shareRun(e,{shareId:r}={}){const n={run_id:e,share_token:r||Qi()};Oe(e);const s=JSON.stringify(n),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(o,"share run"),o})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){Oe(e),await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"unshare run",!0),r})}async readRunSharedLink(e){Oe(e);const n=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"read run shared link"),s})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:r}={}){const n=new URLSearchParams({share_token:e});if(r!==void 0)for(const a of r)n.append("id",a);return Oe(e),await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"list shared runs"),a})).json()}async readDatasetSharedSchema(e,r){if(!e&&!r)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:r})).id),Oe(e);const s=await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,"read dataset shared schema"),i})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,r){if(!e&&!r)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:r})).id);const n={dataset_id:e};Oe(e);const s=JSON.stringify(n),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(o,"share dataset"),o})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){Oe(e),await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"unshare dataset",!0),r})}async readSharedDataset(e){return Oe(e),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"read shared dataset"),s})).json()}async listSharedExamples(e,r){const n={};r!=null&&r.exampleIds&&(n.id=r.exampleIds);const s=new URLSearchParams;Object.entries(n).forEach(([o,c])=>{Array.isArray(c)?c.forEach(l=>s.append(o,l)):s.append(o,c)});const i=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(o,"list shared examples"),o}),a=await i.json();if(!i.ok)throw"detail"in a?new Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(a.detail)?a.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${i.status} ${i.statusText}`);return a.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:r=null,metadata:n=null,upsert:s=!1,projectExtra:i=null,referenceDatasetId:a=null}){const o=s?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,l=i||{};n&&(l.metadata=n);const u={name:e,extra:l,description:r};a!==null&&(u.reference_dataset_id=a);const d=JSON.stringify(u);return await(await this.caller.call(async()=>{const m=await this._fetch(c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await _e(m,"create project"),m})).json()}async updateProject(e,{name:r=null,description:n=null,metadata:s=null,projectExtra:i=null,endTime:a=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=i;s&&(c={...c||{},metadata:s});const l=JSON.stringify({name:r,extra:c,description:n,end_time:a?new Date(a).toISOString():null});return await(await this.caller.call(async()=>{const h=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await _e(h,"update project"),h})).json()}async hasProject({projectId:e,projectName:r}){let n="/sessions";const s=new URLSearchParams;if(e!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Oe(e),n+=`/${e}`;else if(r!==void 0)s.append("name",r);else throw new Error("Must provide projectName or projectId");const i=await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${n}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"has project"),a});try{const a=await i.json();return i.ok?Array.isArray(a)?a.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:r,includeStats:n}){let s="/sessions";const i=new URLSearchParams;if(e!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Oe(e),s+=`/${e}`;else if(r!==void 0)i.append("name",r);else throw new Error("Must provide projectName or projectId");n!==void 0&&i.append("include_stats",n.toString());const a=await this._get(s,i);let o;if(Array.isArray(a)){if(a.length===0)throw new Error(`Project[id=${e}, name=${r}] not found`);o=a[0]}else o=a;return o}async getProjectUrl({projectId:e,projectName:r}){if(e===void 0&&r===void 0)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:r}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:r}){if(e===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:r}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${n.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const r of this._getPaginated("/sessions",e))return this._tenantId=r[0].tenant_id,r[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:r,nameContains:n,referenceDatasetId:s,referenceDatasetName:i,includeStats:a,datasetVersion:o,referenceFree:c,metadata:l}={}){const u=new URLSearchParams;if(e!==void 0)for(const d of e)u.append("id",d);if(r!==void 0&&u.append("name",r),n!==void 0&&u.append("name_contains",n),s!==void 0)u.append("reference_dataset",s);else if(i!==void 0){const d=await this.readDataset({datasetName:i});u.append("reference_dataset",d.id)}a!==void 0&&u.append("include_stats",a.toString()),o!==void 0&&u.append("dataset_version",o),c!==void 0&&u.append("reference_free",c.toString()),l!==void 0&&u.append("metadata",JSON.stringify(l));for await(const d of this._getPaginated("/sessions",u))yield*d}async deleteProject({projectId:e,projectName:r}){let n;if(e===void 0&&r===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?n=(await this.readProject({projectName:r})).id:n=e,Oe(n),await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,`delete session ${n} (${r})`,!0),s})}async uploadCsv({csvFile:e,fileName:r,inputKeys:n,outputKeys:s,description:i,dataType:a,name:o}){const c=`${this.apiUrl}/datasets/upload`,l=new FormData;return l.append("file",e,r),n.forEach(h=>{l.append("input_keys",h)}),s.forEach(h=>{l.append("output_keys",h)}),i&&l.append("description",i),a&&l.append("data_type",a),o&&l.append("name",o),await(await this.caller.call(async()=>{const h=await this._fetch(c,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await _e(h,"upload CSV"),h})).json()}async createDataset(e,{description:r,dataType:n,inputsSchema:s,outputsSchema:i,metadata:a}={}){const o={name:e,description:r,extra:a?{metadata:a}:void 0};n&&(o.data_type=n),s&&(o.inputs_schema_definition=s),i&&(o.outputs_schema_definition=i);const c=JSON.stringify(o);return await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(d,"create dataset"),d})).json()}async readDataset({datasetId:e,datasetName:r}){let n="/datasets";const s=new URLSearchParams({limit:"1"});if(e&&r)throw new Error("Must provide either datasetName or datasetId, not both");if(e)Oe(e),n+=`/${e}`;else if(r)s.append("name",r);else throw new Error("Must provide datasetName or datasetId");const i=await this._get(n,s);let a;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${e}, name=${r}] not found`);a=i[0]}else a=i;return a}async hasDataset({datasetId:e,datasetName:r}){try{return await this.readDataset({datasetId:e,datasetName:r}),!0}catch(n){if(n instanceof Error&&n.message.toLocaleLowerCase().includes("not found"))return!1;throw n}}async diffDatasetVersions({datasetId:e,datasetName:r,fromVersion:n,toVersion:s}){let i=e;if(i===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:r})).id);const a=new URLSearchParams({from_version:typeof n=="string"?n:n.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,a)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:r}){const n="/datasets";if(e===void 0)if(r!==void 0)e=(await this.readDataset({datasetName:r})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${n}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:r=0,datasetIds:n,datasetName:s,datasetNameContains:i,metadata:a}={}){const o="/datasets",c=new URLSearchParams({limit:e.toString(),offset:r.toString()});if(n!==void 0)for(const l of n)c.append("id",l);s!==void 0&&c.append("name",s),i!==void 0&&c.append("name_contains",i),a!==void 0&&c.append("metadata",JSON.stringify(a));for await(const l of this._getPaginated(o,c))yield*l}async updateDataset(e){const{datasetId:r,datasetName:n,...s}=e;if(!r&&!n)throw new Error("Must provide either datasetName or datasetId");const i=r??(await this.readDataset({datasetName:n})).id;Oe(i);const a=JSON.stringify(s);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(c,"update dataset"),c})).json()}async updateDatasetTag(e){const{datasetId:r,datasetName:n,asOf:s,tag:i}=e;if(!r&&!n)throw new Error("Must provide either datasetName or datasetId");const a=r??(await this.readDataset({datasetName:n})).id;Oe(a);const o=JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:i});await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"update dataset tags",!0),c})}async deleteDataset({datasetId:e,datasetName:r}){let n="/datasets",s=e;if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(r!==void 0&&(s=(await this.readDataset({datasetName:r})).id),s!==void 0)Oe(s),n+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const i=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,`delete ${n}`,!0),i})}async indexDataset({datasetId:e,datasetName:r,tag:n}){let s=e;if(!s&&!r)throw new Error("Must provide either datasetName or datasetId");if(s&&r)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:r})).id),Oe(s);const a=JSON.stringify({tag:n});await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(c,"index dataset"),c})).json()}async similarExamples(e,r,n,{filter:s}={}){const i={limit:n,inputs:e};s!==void 0&&(i.filter=s),Oe(r);const a=JSON.stringify(i);return(await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/datasets/${r}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:a});return await _e(l,"fetch similar examples"),l})).json()).examples}async createExample(e,r,n){var u;if(xw(e)&&(r!==void 0||n!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let s=r?n==null?void 0:n.datasetId:e.dataset_id;const i=r?n==null?void 0:n.datasetName:e.dataset_name;if(s===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:i})).id);const a=(r?n==null?void 0:n.createdAt:e.created_at)||new Date;let o;xw(e)?o=e:o={inputs:e,outputs:r,created_at:a==null?void 0:a.toISOString(),id:n==null?void 0:n.exampleId,metadata:n==null?void 0:n.metadata,split:n==null?void 0:n.split,source_run_id:n==null?void 0:n.sourceRunId,use_source_run_io:n==null?void 0:n.useSourceRunIO,use_source_run_attachments:n==null?void 0:n.useSourceRunAttachments,attachments:n==null?void 0:n.attachments};const c=await this._uploadExamplesMultipart(s,[o]);return await this.readExample(((u=c.example_ids)==null?void 0:u[0])??Qi())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const _=e;let E=_[0].dataset_id;const C=_[0].dataset_name;if(E===void 0&&C===void 0)throw new Error("Must provide either datasetName or datasetId");if(E!==void 0&&C!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");E===void 0&&(E=(await this.readDataset({datasetName:C})).id);const k=await this._uploadExamplesMultipart(E,_);return await Promise.all(k.example_ids.map($=>this.readExample($)))}const{inputs:r,outputs:n,metadata:s,splits:i,sourceRunIds:a,useSourceRunIOs:o,useSourceRunAttachments:c,attachments:l,exampleIds:u,datasetId:d,datasetName:h}=e;if(r===void 0)throw new Error("Must provide inputs when using legacy parameters");let f=d;const m=h;if(f===void 0&&m===void 0)throw new Error("Must provide either datasetName or datasetId");if(f!==void 0&&m!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");f===void 0&&(f=(await this.readDataset({datasetName:m})).id);const g=r.map((_,E)=>({dataset_id:f,inputs:_,outputs:n==null?void 0:n[E],metadata:s==null?void 0:s[E],split:i==null?void 0:i[E],id:u==null?void 0:u[E],attachments:l==null?void 0:l[E],source_run_id:a==null?void 0:a[E],use_source_run_io:o==null?void 0:o[E],use_source_run_attachments:c==null?void 0:c[E]})),y=await this._uploadExamplesMultipart(f,g);return await Promise.all(y.example_ids.map(_=>this.readExample(_)))}async createLLMExample(e,r,n){return this.createExample({input:e},{output:r},n)}async createChatExample(e,r,n){const s=e.map(a=>A_(a)?C_(a):a),i=A_(r)?C_(r):r;return this.createExample({input:s},{output:i},n)}async readExample(e){Oe(e);const r=`/examples/${e}`,n=await this._get(r),{attachment_urls:s,...i}=n,a=i;return s&&(a.attachments=Object.entries(s).reduce((o,[c,l])=>(o[c.slice(11)]={presigned_url:l.presigned_url,mime_type:l.mime_type},o),{})),a}async*listExamples({datasetId:e,datasetName:r,exampleIds:n,asOf:s,splits:i,inlineS3Urls:a,metadata:o,limit:c,offset:l,filter:u,includeAttachments:d}={}){let h;if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(r!==void 0)h=(await this.readDataset({datasetName:r})).id;else throw new Error("Must provide a datasetName or datasetId");const f=new URLSearchParams({dataset:h}),m=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;m&&f.append("as_of",m);const g=a??!0;if(f.append("inline_s3_urls",g.toString()),n!==void 0)for(const b of n)f.append("id",b);if(i!==void 0)for(const b of i)f.append("splits",b);if(o!==void 0){const b=JSON.stringify(o);f.append("metadata",b)}c!==void 0&&f.append("limit",c.toString()),l!==void 0&&f.append("offset",l.toString()),u!==void 0&&f.append("filter",u),d===!0&&["attachment_urls","outputs","metadata"].forEach(b=>f.append("select",b));let y=0;for await(const b of this._getPaginated("/examples",f)){for(const _ of b){const{attachment_urls:E,...C}=_,k=C;E&&(k.attachments=Object.entries(E).reduce((R,[$,S])=>(R[$.slice(11)]={presigned_url:S.presigned_url,mime_type:S.mime_type||void 0},R),{})),yield k,y++}if(c!==void 0&&y>=c)break}}async deleteExample(e){Oe(e);const r=`/examples/${e}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,`delete ${r}`,!0),n})}async updateExample(e,r){let n;r?n=e:n=e.id,Oe(n);let s;r?s={id:n,...r}:s=e;let i;return s.dataset_id!==void 0?i=s.dataset_id:i=(await this.readExample(n)).dataset_id,this._updateExamplesMultipart(i,[s])}async updateExamples(e){let r;return e[0].dataset_id===void 0?r=(await this.readExample(e[0].id)).dataset_id:r=e[0].dataset_id,this._updateExamplesMultipart(r,e)}async readDatasetVersion({datasetId:e,datasetName:r,asOf:n,tag:s}){let i;if(e?i=e:i=(await this.readDataset({datasetName:r})).id,Oe(i),n&&s||!n&&!s)throw new Error("Exactly one of asOf and tag must be specified.");const a=new URLSearchParams;return n!==void 0&&a.append("as_of",typeof n=="string"?n:n.toISOString()),s!==void 0&&a.append("tag",s),await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}/version?${a.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(c,"read dataset version"),c})).json()}async listDatasetSplits({datasetId:e,datasetName:r,asOf:n}){let s;if(e===void 0&&r===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:r})).id:s=e,Oe(s);const i=new URLSearchParams,a=n?typeof n=="string"?n:n==null?void 0:n.toISOString():void 0;return a&&i.append("as_of",a),await this._get(`/datasets/${s}/splits`,i)}async updateDatasetSplits({datasetId:e,datasetName:r,splitName:n,exampleIds:s,remove:i=!1}){let a;if(e===void 0&&r===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:r})).id:a=e,Oe(a);const o={split_name:n,examples:s.map(l=>(Oe(l),l)),remove:i},c=JSON.stringify(o);await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/datasets/${a}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(l,"update dataset splits",!0),l})}async evaluateRun(e,r,{sourceInfo:n,loadChildRuns:s,referenceExample:i}={loadChildRuns:!1}){ip("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let a;if(typeof e=="string")a=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)a=e;else throw new Error(`Invalid run type: ${typeof e}`);a.reference_example_id!==null&&a.reference_example_id!==void 0&&(i=await this.readExample(a.reference_example_id));const o=await r.evaluateRun(a,i),[c,l]=await this._logEvaluationFeedback(o,a,n);return l[0]}async createFeedback(e,r,{score:n,value:s,correction:i,comment:a,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:l,feedbackId:u,feedbackConfig:d,projectId:h,comparativeExperimentId:f}){var _;if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const m={type:c??"api",metadata:o??{}};l!==void 0&&(m==null?void 0:m.metadata)!==void 0&&!m.metadata.__run&&(m.metadata.__run={run_id:l}),(m==null?void 0:m.metadata)!==void 0&&((_=m.metadata.__run)==null?void 0:_.run_id)!==void 0&&Oe(m.metadata.__run.run_id);const g={id:u??Qi(),run_id:e,key:r,score:Ew(n),value:s,correction:i,comment:a,feedback_source:m,comparative_experiment_id:f,feedbackConfig:d,session_id:h},y=JSON.stringify(g),b=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const E=await this._fetch(b,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:y});return await _e(E,"create feedback",!0),E}),g}async updateFeedback(e,{score:r,value:n,correction:s,comment:i}){const a={};r!=null&&(a.score=Ew(r)),n!=null&&(a.value=n),s!=null&&(a.correction=s),i!=null&&(a.comment=i),Oe(e);const o=JSON.stringify(a);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"update feedback",!0),c})}async readFeedback(e){Oe(e);const r=`/feedback/${e}`;return await this._get(r)}async deleteFeedback(e){Oe(e);const r=`/feedback/${e}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,`delete ${r}`,!0),n})}async*listFeedback({runIds:e,feedbackKeys:r,feedbackSourceTypes:n}={}){const s=new URLSearchParams;if(e)for(const i of e)Oe(i),s.append("run",i);if(r)for(const i of r)s.append("key",i);if(n)for(const i of n)s.append("source",i);for await(const i of this._getPaginated("/feedback",s))yield*i}async createPresignedFeedbackToken(e,r,{expiration:n,feedbackConfig:s}={}){const i={run_id:e,feedback_key:r,feedback_config:s};n?typeof n=="string"?i.expires_at=n:(n!=null&&n.hours||n!=null&&n.minutes||n!=null&&n.days)&&(i.expires_in=n):i.expires_in={hours:3};const a=JSON.stringify(i);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(c,"create presigned feedback token"),c})).json()}async createComparativeExperiment({name:e,experimentIds:r,referenceDatasetId:n,createdAt:s,description:i,metadata:a,id:o}){var d;if(r.length===0)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:r[0]})).reference_dataset_id),!n==null)throw new Error("A reference dataset is required");const c={id:o,name:e,experiment_ids:r,reference_dataset_id:n,description:i,created_at:(d=s??new Date)==null?void 0:d.toISOString(),extra:{}};a&&(c.extra.metadata=a);const l=JSON.stringify(c);return(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await _e(h,"create comparative experiment"),h})).json()}async*listPresignedFeedbackTokens(e){Oe(e);const r=new URLSearchParams({run_id:e});for await(const n of this._getPaginated("/feedback/tokens",r))yield*n}_selectEvalResults(e){let r;return"results"in e?r=e.results:Array.isArray(e)?r=e:r=[e],r}async _logEvaluationFeedback(e,r,n){const s=this._selectEvalResults(e),i=[];for(const a of s){let o=n||{};a.evaluatorInfo&&(o={...a.evaluatorInfo,...o});let c=null;a.targetRunId?c=a.targetRunId:r&&(c=r.id),i.push(await this.createFeedback(c,a.key,{score:a.score,value:a.value,comment:a.comment,correction:a.correction,sourceInfo:o,sourceRunId:a.sourceRunId,feedbackConfig:a.feedbackConfig,feedbackSourceType:"model"}))}return[s,i]}async logEvaluationFeedback(e,r,n){const[s]=await this._logEvaluationFeedback(e,r,n);return s}async*listAnnotationQueues(e={}){const{queueIds:r,name:n,nameContains:s,limit:i}=e,a=new URLSearchParams;r&&r.forEach((c,l)=>{Oe(c,`queueIds[${l}]`),a.append("ids",c)}),n&&a.append("name",n),s&&a.append("name_contains",s),a.append("limit",(i!==void 0?Math.min(i,100):100).toString());let o=0;for await(const c of this._getPaginated("/annotation-queues",a))if(yield*c,o++,i!==void 0&&o>=i)break}async createAnnotationQueue(e){const{name:r,description:n,queueId:s,rubricInstructions:i}=e,a={name:r,description:n,id:s||Qi(),rubric_instructions:i},o=JSON.stringify(Object.fromEntries(Object.entries(a).filter(([l,u])=>u!==void 0)));return(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(l,"create annotation queue"),l})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"read annotation queue"),n})).json()}async updateAnnotationQueue(e,r){const{name:n,description:s,rubricInstructions:i}=r,a=JSON.stringify({name:n,description:s,rubric_instructions:i});await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"delete annotation queue",!0),r})}async addRunsToAnnotationQueue(e,r){const n=JSON.stringify(r.map((s,i)=>Oe(s,`runIds[${i}]`).toString()));await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await _e(s,"add runs to annotation queue",!0),s})}async getRunFromAnnotationQueue(e,r){const n=`/annotation-queues/${Oe(e,"queueId")}/run`;return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${n}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,"get run from annotation queue"),i})).json()}async deleteRunFromAnnotationQueue(e,r){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}/runs/${Oe(r,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"delete run from annotation queue",!0),n})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"get size from annotation queue"),n})).json()}async _currentTenantIsOwner(e){const r=await this._getSettings();return e=="-"||r.tenant_handle===e}async _ownerConflictError(e,r){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${n.tenant_handle}

      Requested tenant: ${r}`)}async _getLatestCommitHash(e){const n=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"get latest commit hash"),s})).json();if(n.commits.length!==0)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,r){const[n,s,i]=xs(e),a=JSON.stringify({like:r});return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/likes/${n}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(c,`${r?"like":"unlike"} prompt`),c})).json()}async _getPromptUrl(e){const[r,n,s]=xs(e);if(await this._currentTenantIsOwner(r)){const i=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${n}/${s.substring(0,8)}?organizationId=${i.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${i.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${r}/${n}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${r}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const r of this._getPaginated(`/commits/${e}/`,new URLSearchParams,n=>n.commits))yield*r}async*listPrompts(e){const r=new URLSearchParams;r.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),r.append("sort_direction","desc"),r.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&r.append("is_public",e.isPublic.toString()),e!=null&&e.query&&r.append("query",e.query);for await(const n of this._getPaginated("/repos",r,s=>s.repos))yield*n}async getPrompt(e){const[r,n,s]=xs(e),i=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return(o==null?void 0:o.status)===404?null:(await _e(o,"get prompt"),o)}),a=await(i==null?void 0:i.json());return a!=null&&a.repo?a.repo:null}async createPrompt(e,r){const n=await this._getSettings();if(r!=null&&r.isPublic&&!n.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,i,a]=xs(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const o={repo_handle:i,...(r==null?void 0:r.description)&&{description:r.description},...(r==null?void 0:r.readme)&&{readme:r.readme},...(r==null?void 0:r.tags)&&{tags:r.tags},is_public:!!(r!=null&&r.isPublic)},c=JSON.stringify(o),l=await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(d,"create prompt"),d}),{repo:u}=await l.json();return u}async createCommit(e,r,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,i,a]=xs(e),o=(n==null?void 0:n.parentCommitHash)==="latest"||!(n!=null&&n.parentCommitHash)?await this._getLatestCommitHash(`${s}/${i}`):n==null?void 0:n.parentCommitHash,c={manifest:JSON.parse(JSON.stringify(r)),parent_commit:o},l=JSON.stringify(c),d=await(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/commits/${s}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await _e(h,"create commit"),h})).json();return this._getPromptUrl(`${s}/${i}${d.commit_hash?`:${d.commit_hash}`:""}`)}async updateExamplesMultipart(e,r=[]){return this._updateExamplesMultipart(e,r)}async _updateExamplesMultipart(e,r=[]){var a;if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const o of r){const c=o.id,l={...o.metadata&&{metadata:o.metadata},...o.split&&{split:o.split}},u=Lr(l,`Serializing body for example with id: ${c}`),d=new Blob([u],{type:"application/json"});if(n.append(c,d),o.inputs){const h=Lr(o.inputs,`Serializing inputs for example with id: ${c}`),f=new Blob([h],{type:"application/json"});n.append(`${c}.inputs`,f)}if(o.outputs){const h=Lr(o.outputs,`Serializing outputs whle updating example with id: ${c}`),f=new Blob([h],{type:"application/json"});n.append(`${c}.outputs`,f)}if(o.attachments)for(const[h,f]of Object.entries(o.attachments)){let m,g;Array.isArray(f)?[m,g]=f:(m=f.mimeType,g=f.data);const y=new Blob([g],{type:`${m}; length=${g.byteLength}`});n.append(`${c}.attachment.${h}`,y)}if(o.attachments_operations){const h=Lr(o.attachments_operations,`Serializing attachments while updating example with id: ${c}`),f=new Blob([h],{type:"application/json"});n.append(`${c}.attachments_operations`,f)}}const s=e??((a=r[0])==null?void 0:a.dataset_id);return(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${s}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await _e(o,"update examples"),o})).json()}async uploadExamplesMultipart(e,r=[]){return this._uploadExamplesMultipart(e,r)}async _uploadExamplesMultipart(e,r=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const i of r){const a=(i.id??Qi()).toString(),o={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split},...i.source_run_id&&{source_run_id:i.source_run_id},...i.use_source_run_io&&{use_source_run_io:i.use_source_run_io},...i.use_source_run_attachments&&{use_source_run_attachments:i.use_source_run_attachments}},c=Lr(o,`Serializing body for uploaded example with id: ${a}`),l=new Blob([c],{type:"application/json"});if(n.append(a,l),i.inputs){const u=Lr(i.inputs,`Serializing inputs for uploaded example with id: ${a}`),d=new Blob([u],{type:"application/json"});n.append(`${a}.inputs`,d)}if(i.outputs){const u=Lr(i.outputs,`Serializing outputs for uploaded example with id: ${a}`),d=new Blob([u],{type:"application/json"});n.append(`${a}.outputs`,d)}if(i.attachments)for(const[u,d]of Object.entries(i.attachments)){let h,f;Array.isArray(d)?[h,f]=d:(h=d.mimeType,f=d.data);const m=new Blob([f],{type:`${h}; length=${f.byteLength}`});n.append(`${a}.attachment.${u}`,m)}}return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await _e(i,"upload examples"),i})).json()}async updatePrompt(e,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,s]=xs(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const i={};if((r==null?void 0:r.description)!==void 0&&(i.description=r.description),(r==null?void 0:r.readme)!==void 0&&(i.readme=r.readme),(r==null?void 0:r.tags)!==void 0&&(i.tags=r.tags),(r==null?void 0:r.isPublic)!==void 0&&(i.is_public=r.isPublic),(r==null?void 0:r.isArchived)!==void 0&&(i.is_archived=r.isArchived),Object.keys(i).length===0)throw new Error("No valid update options provided");const a=JSON.stringify(i);return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/repos/${n}/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(c,"update prompt"),c})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,n,s]=xs(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("delete a prompt",r);return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"delete prompt"),a})).json()}async pullPromptCommit(e,r){const[n,s,i]=xs(e),o=await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/commits/${n}/${s}/${i}${r!=null&&r.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(c,"pull prompt commit"),c})).json();return{owner:n,repo:s,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,r){const n=await this.pullPromptCommit(e,{includeModel:r==null?void 0:r.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,r){return await this.promptExists(e)?r&&Object.keys(r).some(s=>s!=="object")&&await this.updatePrompt(e,{description:r==null?void 0:r.description,readme:r==null?void 0:r.readme,tags:r==null?void 0:r.tags,isPublic:r==null?void 0:r.isPublic}):await this.createPrompt(e,{description:r==null?void 0:r.description,readme:r==null?void 0:r.readme,tags:r==null?void 0:r.tags,isPublic:r==null?void 0:r.isPublic}),r!=null&&r.object?await this.createCommit(e,r==null?void 0:r.object,{parentCommitHash:r==null?void 0:r.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,r={}){const{sourceApiUrl:n=this.apiUrl,datasetName:s}=r,[i,a]=this.parseTokenOrUrl(e,n),o=new op({apiUrl:i,apiKey:"placeholder"}),c=await o.readSharedDataset(a),l=s||c.name;try{if(await this.hasDataset({datasetId:l})){console.log(`Dataset ${l} already exists in your tenant. Skipping.`);return}}catch{}const u=await o.listSharedExamples(a),d=await this.createDataset(l,{description:c.description,dataType:c.data_type||"kv",inputsSchema:c.inputs_schema_definition??void 0,outputsSchema:c.outputs_schema_definition??void 0});try{await this.createExamples({inputs:u.map(h=>h.inputs),outputs:u.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),h}}parseTokenOrUrl(e,r,n=2,s="dataset"){try{return Oe(e),[r,e]}catch{}try{const a=new URL(e).pathname.split("/").filter(o=>o!=="");if(a.length>=n){const o=a[a.length-n];return[r,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}async awaitPendingTraceBatches(){var e,r;if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:n})=>n),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await((r=(e=cO())==null?void 0:e.DEFAULT_LANGSMITH_SPAN_PROCESSOR)==null?void 0:r.forceFlush())}};function xw(t){return"dataset_id"in t||"dataset_name"in t}const f$=t=>!!["TRACING_V2","TRACING"].find(r=>Er(r)==="true"),ef=Symbol.for("lc:context_variables");function p$(t){return t.replace(/[-:.]/g,"")}function PE(t,e,r=1){const n=r.toFixed(0).slice(0,3).padStart(3,"0"),s=`${new Date(t).toISOString().slice(0,-1)}${n}Z`;return{dottedOrder:p$(s)+e,microsecondPrecisionDatestring:s}}class Kl{constructor(e,r,n,s){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=r,this.project_name=n,this.replicas=s}static fromHeader(e){const r=e.split(",");let n={},s=[],i,a;for(const o of r){const[c,l]=o.split("="),u=decodeURIComponent(l);c==="langsmith-metadata"?n=JSON.parse(u):c==="langsmith-tags"?s=u.split(","):c==="langsmith-project"?i=u:c==="langsmith-replicas"&&(a=JSON.parse(u))}return new Kl(n,s,i,a)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class br{constructor(e){var o;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),m$(e)){Object.assign(this,{...e});return}const r=br.getDefaultConfig(),{metadata:n,...s}=e,i=s.client??br.getSharedClient(),a={...n,...(o=s==null?void 0:s.extra)==null?void 0:o.metadata};if(s.extra={...s.extra,metadata:a},Object.assign(this,{...r,...s,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=b$(this.replicas),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){const{dottedOrder:c,microsecondPrecisionDatestring:l}=PE(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+c:this.dotted_order=c,this._serialized_start_time=l}}set metadata(e){var r;this.extra={...this.extra,metadata:{...(r=this.extra)==null?void 0:r.metadata,...e}}}get metadata(){var e;return(e=this.extra)==null?void 0:e.metadata}static getDefaultConfig(){return{id:Qi(),run_type:"chain",project_name:bE(),child_runs:[],api_url:Wn("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Wn("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return br.sharedClient||(br.sharedClient=new eg),br.sharedClient}createChild(e){var c,l,u,d,h,f;const r=this.child_execution_order+1,n=new br({...e,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:r,child_execution_order:r});ef in this&&(n[ef]=this[ef]);const s=Symbol.for("lc:child_config"),i=((c=e.extra)==null?void 0:c[s])??this.extra[s];if(y$(i)){const m={...i},g=g$(m.callbacks)?(u=(l=m.callbacks).copy)==null?void 0:u.call(l):void 0;g&&(Object.assign(g,{_parentRunId:n.id}),(f=(h=(d=g.handlers)==null?void 0:d.find(LE))==null?void 0:h.updateFromRunTree)==null||f.call(h,n),m.callbacks=g),n.extra[s]=m}const a=new Set;let o=this;for(;o!=null&&!a.has(o.id);)a.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,r),o=o.parent_run;return this.child_runs.push(n),n}async end(e,r,n=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??r,this.end_time=this.end_time??n,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,r,n=!0){var o,c;const s=e.extra??{};if(((o=s==null?void 0:s.runtime)==null?void 0:o.library)===void 0&&(s.runtime||(s.runtime={}),r))for(const[l,u]of Object.entries(r))s.runtime[l]||(s.runtime[l]=u);let i,a;return n?(a=((c=e.parent_run)==null?void 0:c.id)??e.parent_run_id,i=[]):(i=e.child_runs.map(l=>this._convertToCreate(l,r,n)),a=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:i,parent_run_id:a,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_remapForProject(e,r,n=!0){const s=this._convertToCreate(this,r,n);if(e===this.project_name)return s;const i=d=>c_(`${d}:${e}`,c_.DNS),a=i(s.id),o=s.trace_id?i(s.trace_id):void 0,c=s.parent_run_id?i(s.parent_run_id):void 0;let l;if(s.dotted_order){const d=_$(s.dotted_order),h=[];for(let m=0;m<d.length-1;m++){const[g,y]=d[m],b=i(y);h.push(g.toISOString().replace(/[-:]/g,"").replace(".","")+b)}const[f]=d[d.length-1];h.push(f.toISOString().replace(/[-:]/g,"").replace(".","")+a),l=h.join(".")}else l=void 0;return{...s,id:a,trace_id:o,parent_run_id:c,dotted_order:l,session_name:e}}async postRun(e=!0){try{const r=xE();if(this.replicas&&this.replicas.length>0)for(const{projectName:n,apiKey:s,apiUrl:i,workspaceId:a}of this.replicas){const o=this._remapForProject(n??this.project_name,r,!0);await this.client.createRun(o,{apiKey:s,apiUrl:i,workspaceId:a})}else{const n=this._convertToCreate(this,r,e);await this.client.createRun(n)}if(!e){ip("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const n of this.child_runs)await n.postRun(!1)}}catch(r){console.error(`Error in postRun for run ${this.id}:`,r)}}async patchRun(e){var r;if(this.replicas&&this.replicas.length>0)for(const{projectName:n,apiKey:s,apiUrl:i,workspaceId:a,updates:o}of this.replicas){const c=this._remapForProject(n??this.project_name),l={id:c.id,outputs:c.outputs,error:c.error,parent_run_id:c.parent_run_id,session_name:c.session_name,reference_example_id:c.reference_example_id,end_time:c.end_time,dotted_order:c.dotted_order,trace_id:c.trace_id,events:c.events,tags:c.tags,extra:c.extra,attachments:this.attachments,...o};e!=null&&e.excludeInputs||(l.inputs=c.inputs),await this.client.updateRun(c.id,l,{apiKey:s,apiUrl:i,workspaceId:a})}else try{const n={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:((r=this.parent_run)==null?void 0:r.id)??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e!=null&&e.excludeInputs||(n.inputs=this.inputs),await this.client.updateRun(this.id,n)}catch(n){console.error(`Error in patchRun for run ${this.id}`,n)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,r){var l,u,d,h;const n=e==null?void 0:e.callbacks;let s,i,a,o=f$();if(n){const f=((l=n==null?void 0:n.getParentRunId)==null?void 0:l.call(n))??"",m=(u=n==null?void 0:n.handlers)==null?void 0:u.find(g=>(g==null?void 0:g.name)=="langchain_tracer");s=(d=m==null?void 0:m.getRun)==null?void 0:d.call(m,f),i=m==null?void 0:m.projectName,a=m==null?void 0:m.client,o=o||!!m}return s?new br({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:a,tracingEnabled:o,project_name:i,tags:[...new Set(((s==null?void 0:s.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(h=s==null?void 0:s.extra)==null?void 0:h.metadata,...e==null?void 0:e.metadata}}}).createChild(r):new br({...r,client:a,tracingEnabled:o,project_name:i})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,r){var l;const n="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=n["langsmith-trace"];if(!s||typeof s!="string")return;const i=s.trim(),a=i.split(".").map(u=>{const[d,h]=u.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:h}}),o=a[0].uuid,c={...r,name:(r==null?void 0:r.name)??"parent",run_type:(r==null?void 0:r.run_type)??"chain",start_time:(r==null?void 0:r.start_time)??Date.now(),id:(l=a.at(-1))==null?void 0:l.uuid,trace_id:o,dotted_order:i};if(n.baggage&&typeof n.baggage=="string"){const u=Kl.fromHeader(n.baggage);c.metadata=u.metadata,c.tags=u.tags,c.project_name=u.project_name,c.replicas=u.replicas}return new br(c)}toHeaders(e){var n;const r={"langsmith-trace":this.dotted_order,baggage:new Kl((n=this.extra)==null?void 0:n.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[s,i]of Object.entries(r))e.set(s,i);return r}}Object.defineProperty(br,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function m$(t){return t!=null&&typeof t.createChild=="function"&&typeof t.postRun=="function"}function LE(t){return typeof t=="object"&&t!=null&&typeof t.name=="string"&&t.name==="langchain_tracer"}function Tw(t){return Array.isArray(t)&&t.some(e=>LE(e))}function g$(t){return typeof t=="object"&&t!=null&&Array.isArray(t.handlers)}function y$(t){var e;return t!=null&&typeof t.callbacks=="object"&&(Tw((e=t.callbacks)==null?void 0:e.handlers)||Tw(t.callbacks))}function _$(t){return t.split(".").map(r=>{const n=r.slice(0,-36),s=r.slice(-36),i=parseInt(n.slice(0,4)),a=parseInt(n.slice(4,6))-1,o=parseInt(n.slice(6,8)),c=parseInt(n.slice(9,11)),l=parseInt(n.slice(11,13)),u=parseInt(n.slice(13,15)),d=parseInt(n.slice(15,21));return[new Date(i,a,o,c,l,u,d/1e3),s]})}function w$(){const t=Wn("LANGSMITH_RUNS_ENDPOINTS");if(!t)return[];try{const e=JSON.parse(t);if(Array.isArray(e)){const r=[];for(const n of e){if(typeof n!="object"||n===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof n}`);continue}if(typeof n.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_url}`);continue}if(typeof n.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_key}`);continue}r.push({apiUrl:n.api_url.replace(/\/$/,""),apiKey:n.api_key})}return r}else if(typeof e=="object"&&e!==null){v$(e);const r=[];for(const[n,s]of Object.entries(e)){const i=n.replace(/\/$/,"");if(typeof s=="string")r.push({apiUrl:i,apiKey:s});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${n}: expected string, got ${typeof s}`);continue}}return r}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS – must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof e}`),[]}catch(e){if(QO(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS – must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function b$(t){return t?t.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):w$()}function v$(t){if(Object.keys(t).length>0&&Er("ENDPOINT"))throw new YO}var ME={};ve(ME,{BaseTracer:()=>Es,isBaseTracer:()=>ea});const E$=t=>{if(t)return t.events=t.events??[],t.child_runs=t.child_runs??[],t};function cp(t,e){if(t)return new br({...t,start_time:t._serialized_start_time??t.start_time,parent_run:cp(e),child_runs:t.child_runs.map(r=>cp(r)).filter(r=>r!==void 0),extra:{...t.extra,runtime:sE()},tracingEnabled:!1})}function tf(t,e){return t&&!Array.isArray(t)&&typeof t=="object"?t:{[e]:t}}function ea(t){return typeof t._addRunToRunMap=="function"}var Es=class extends La{constructor(e){super(...arguments);p(this,"runMap",new Map);p(this,"runTreeMap",new Map);p(this,"usesRunTreeMap",!1)}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?E$(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,r){e.child_runs.push(r)}_addRunToRunMap(e){const{dottedOrder:r,microsecondPrecisionDatestring:n}=PE(new Date(e.start_time).getTime(),e.id,e.execution_order),s={...e},i=this.getRunById(s.parent_run_id);if(s.parent_run_id!==void 0?i&&(this._addChildRun(i,s),i.child_execution_order=Math.max(i.child_execution_order,s.child_execution_order),s.trace_id=i.trace_id,i.dotted_order!==void 0&&(s.dotted_order=[i.dotted_order,r].join("."),s._serialized_start_time=n)):(s.trace_id=s.id,s.dotted_order=r,s._serialized_start_time=n),this.usesRunTreeMap){const a=cp(s,i);a!==void 0&&this.runTreeMap.set(s.id,a)}else this.runMap.set(s.id,s);return s}async _endTrace(e){var n;const r=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);r?r.child_execution_order=Math.max(r.child_execution_order,e.child_execution_order):await this.persistRun(e),await((n=this.onRunUpdate)==null?void 0:n.call(this,e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const r=e!==void 0&&this.getRunById(e);return r?r.child_execution_order+1:1}_createRunForLLMStart(e,r,n,s,i,a,o,c){const l=this._getExecutionOrder(s),u=Date.now(),d=o?{...i,metadata:o}:i,h={id:n,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:r},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,r,n,s,i,a,o,c){var u,d;const l=this.getRunById(n)??this._createRunForLLMStart(e,r,n,s,i,a,o,c);return await((u=this.onRunCreate)==null?void 0:u.call(this,l)),await((d=this.onLLMStart)==null?void 0:d.call(this,l)),l}_createRunForChatModelStart(e,r,n,s,i,a,o,c){const l=this._getExecutionOrder(s),u=Date.now(),d=o?{...i,metadata:o}:i,h={id:n,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:r},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,r,n,s,i,a,o,c){var u,d;const l=this.getRunById(n)??this._createRunForChatModelStart(e,r,n,s,i,a,o,c);return await((u=this.onRunCreate)==null?void 0:u.call(this,l)),await((d=this.onLLMStart)==null?void 0:d.call(this,l)),l}async handleLLMEnd(e,r,n,s,i){var o;const a=this.getRunById(r);if(!a||(a==null?void 0:a.run_type)!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.outputs=e,a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await((o=this.onLLMEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleLLMError(e,r,n,s,i){var o;const a=this.getRunById(r);if(!a||(a==null?void 0:a.run_type)!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await((o=this.onLLMError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}_createRunForChainStart(e,r,n,s,i,a,o,c){const l=this._getExecutionOrder(s),u=Date.now(),d={id:n,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:r,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(d)}async handleChainStart(e,r,n,s,i,a,o,c){var u,d;const l=this.getRunById(n)??this._createRunForChainStart(e,r,n,s,i,a,o,c);return await((u=this.onRunCreate)==null?void 0:u.call(this,l)),await((d=this.onChainStart)==null?void 0:d.call(this,l)),l}async handleChainEnd(e,r,n,s,i){var o;const a=this.getRunById(r);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=tf(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=tf(i.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleChainError(e,r,n,s,i){var o;const a=this.getRunById(r);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=tf(i.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}_createRunForToolStart(e,r,n,s,i,a,o){const c=this._getExecutionOrder(s),l=Date.now(),u={id:n,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:r},execution_order:c,child_execution_order:c,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleToolStart(e,r,n,s,i,a,o){var l,u;const c=this.getRunById(n)??this._createRunForToolStart(e,r,n,s,i,a,o);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((u=this.onToolStart)==null?void 0:u.call(this,c)),c}async handleToolEnd(e,r){var s;const n=this.getRunById(r);if(!n||(n==null?void 0:n.run_type)!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleToolError(e,r){var s;const n=this.getRunById(r);if(!n||(n==null?void 0:n.run_type)!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleAgentAction(e,r){var i;const n=this.getRunById(r);if(!n||(n==null?void 0:n.run_type)!=="chain")return;const s=n;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((i=this.onAgentAction)==null?void 0:i.call(this,n))}async handleAgentEnd(e,r){var s;const n=this.getRunById(r);!n||(n==null?void 0:n.run_type)!=="chain"||(n.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,n)))}_createRunForRetrieverStart(e,r,n,s,i,a,o){const c=this._getExecutionOrder(s),l=Date.now(),u={id:n,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:r},execution_order:c,child_execution_order:c,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleRetrieverStart(e,r,n,s,i,a,o){var l,u;const c=this.getRunById(n)??this._createRunForRetrieverStart(e,r,n,s,i,a,o);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((u=this.onRetrieverStart)==null?void 0:u.call(this,c)),c}async handleRetrieverEnd(e,r){var s;const n=this.getRunById(r);if(!n||(n==null?void 0:n.run_type)!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleRetrieverError(e,r){var s;const n=this.getRunById(r);if(!n||(n==null?void 0:n.run_type)!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleText(e,r){var s;const n=this.getRunById(r);!n||(n==null?void 0:n.run_type)!=="chain"||(n.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,n)))}async handleLLMNewToken(e,r,n,s,i,a){var c;const o=this.getRunById(n);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:r,chunk:a==null?void 0:a.chunk}}),await((c=this.onLLMNewToken)==null?void 0:c.call(this,o,e,{chunk:a==null?void 0:a.chunk})),o}},_l={exports:{}};_l.exports;var Aw;function S$(){return Aw||(Aw=1,(function(t){const r=(i=0)=>a=>`\x1B[${38+i};5;${a}m`,n=(i=0)=>(a,o,c)=>`\x1B[${38+i};2;${a};${o};${c}m`;function s(){const i=new Map,a={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};a.color.gray=a.color.blackBright,a.bgColor.bgGray=a.bgColor.bgBlackBright,a.color.grey=a.color.blackBright,a.bgColor.bgGrey=a.bgColor.bgBlackBright;for(const[o,c]of Object.entries(a)){for(const[l,u]of Object.entries(c))a[l]={open:`\x1B[${u[0]}m`,close:`\x1B[${u[1]}m`},c[l]=a[l],i.set(u[0],u[1]);Object.defineProperty(a,o,{value:c,enumerable:!1})}return Object.defineProperty(a,"codes",{value:i,enumerable:!1}),a.color.close="\x1B[39m",a.bgColor.close="\x1B[49m",a.color.ansi256=r(),a.color.ansi16m=n(),a.bgColor.ansi256=r(10),a.bgColor.ansi16m=n(10),Object.defineProperties(a,{rgbToAnsi256:{value:(o,c,l)=>o===c&&c===l?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(l/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:l}=c.groups;l.length===3&&(l=l.split("").map(d=>d+d).join(""));const u=Number.parseInt(l,16);return[u>>16&255,u>>8&255,u&255]},enumerable:!1},hexToAnsi256:{value:o=>a.rgbToAnsi256(...a.hexToRgb(o)),enumerable:!1}}),a}Object.defineProperty(t,"exports",{enumerable:!0,get:s})})(_l)),_l.exports}var x$=S$();const DE=Pa(x$);var UE={};ve(UE,{ConsoleCallbackHandler:()=>lp});function cr(t,e){return`${t.open}${e}${t.close}`}function Jr(t,e){try{return JSON.stringify(t,null,2)}catch{return e}}function Cw(t){return typeof t=="string"?t.trim():t==null?t:Jr(t,t.toString())}function Ts(t){if(!t.end_time)return"";const e=t.end_time-t.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:wr}=DE;var lp=class extends Es{constructor(){super(...arguments);p(this,"name","console_callback_handler")}persistRun(e){return Promise.resolve()}getParents(e){const r=[];let n=e;for(;n.parent_run_id;){const s=this.runMap.get(n.parent_run_id);if(s)r.push(s),n=s;else break}return r}getBreadcrumbs(e){const n=[...this.getParents(e).reverse(),e].map((s,i,a)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return i===a.length-1?cr(DE.bold,o):o}).join(" > ");return cr(wr.grey,n)}onChainStart(e){const r=this.getBreadcrumbs(e);console.log(`${cr(wr.green,"[chain/start]")} [${r}] Entering Chain run with input: ${Jr(e.inputs,"[inputs]")}`)}onChainEnd(e){const r=this.getBreadcrumbs(e);console.log(`${cr(wr.cyan,"[chain/end]")} [${r}] [${Ts(e)}] Exiting Chain run with output: ${Jr(e.outputs,"[outputs]")}`)}onChainError(e){const r=this.getBreadcrumbs(e);console.log(`${cr(wr.red,"[chain/error]")} [${r}] [${Ts(e)}] Chain run errored with error: ${Jr(e.error,"[error]")}`)}onLLMStart(e){const r=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${cr(wr.green,"[llm/start]")} [${r}] Entering LLM run with input: ${Jr(n,"[inputs]")}`)}onLLMEnd(e){const r=this.getBreadcrumbs(e);console.log(`${cr(wr.cyan,"[llm/end]")} [${r}] [${Ts(e)}] Exiting LLM run with output: ${Jr(e.outputs,"[response]")}`)}onLLMError(e){const r=this.getBreadcrumbs(e);console.log(`${cr(wr.red,"[llm/error]")} [${r}] [${Ts(e)}] LLM run errored with error: ${Jr(e.error,"[error]")}`)}onToolStart(e){const r=this.getBreadcrumbs(e);console.log(`${cr(wr.green,"[tool/start]")} [${r}] Entering Tool run with input: "${Cw(e.inputs.input)}"`)}onToolEnd(e){var n;const r=this.getBreadcrumbs(e);console.log(`${cr(wr.cyan,"[tool/end]")} [${r}] [${Ts(e)}] Exiting Tool run with output: "${Cw((n=e.outputs)==null?void 0:n.output)}"`)}onToolError(e){const r=this.getBreadcrumbs(e);console.log(`${cr(wr.red,"[tool/error]")} [${r}] [${Ts(e)}] Tool run errored with error: ${Jr(e.error,"[error]")}`)}onRetrieverStart(e){const r=this.getBreadcrumbs(e);console.log(`${cr(wr.green,"[retriever/start]")} [${r}] Entering Retriever run with input: ${Jr(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const r=this.getBreadcrumbs(e);console.log(`${cr(wr.cyan,"[retriever/end]")} [${r}] [${Ts(e)}] Exiting Retriever run with output: ${Jr(e.outputs,"[outputs]")}`)}onRetrieverError(e){const r=this.getBreadcrumbs(e);console.log(`${cr(wr.red,"[retriever/error]")} [${r}] [${Ts(e)}] Retriever run errored with error: ${Jr(e.error,"[error]")}`)}onAgentAction(e){const r=e,n=this.getBreadcrumbs(e);console.log(`${cr(wr.blue,"[agent/action]")} [${n}] Agent selected action: ${Jr(r.actions[r.actions.length-1],"[action]")}`)}};let rf;const BE=()=>{if(rf===void 0){const t=rn("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};rf=new eg(t)}return rf};let T$=class{getStore(){}run(e,r){return r()}};const nf=Symbol.for("ls:tracing_async_local_storage"),A$=new T$;let C$=class{getInstance(){return globalThis[nf]??A$}initializeGlobalInstance(e){globalThis[nf]===void 0&&(globalThis[nf]=e)}};const k$=new C$;function I$(t=!1){const e=k$.getInstance().getStore();if(!t&&e===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function tg(t){return typeof t=="function"&&"langsmith:traceable"in t}var jE={};ve(jE,{LangChainTracer:()=>wl});var wl=class FE extends Es{constructor(r={}){super(r);p(this,"name","langchain_tracer");p(this,"projectName");p(this,"exampleId");p(this,"client");p(this,"replicas");p(this,"usesRunTreeMap",!0);const{exampleId:n,projectName:s,client:i,replicas:a}=r;this.projectName=s??bE(),this.replicas=a,this.exampleId=n,this.client=i??BE();const o=FE.getTraceableRunTree();o&&this.updateFromRunTree(o)}async persistRun(r){}async onRunCreate(r){const n=this.getRunTreeWithTracingConfig(r.id);await(n==null?void 0:n.postRun())}async onRunUpdate(r){const n=this.getRunTreeWithTracingConfig(r.id);await(n==null?void 0:n.patchRun())}getRun(r){return this.runTreeMap.get(r)}updateFromRunTree(r){this.runTreeMap.set(r.id,r);let n=r;const s=new Set;for(;n.parent_run&&!(s.has(n.id)||(s.add(n.id),!n.parent_run));)n=n.parent_run;s.clear();const i=[n];for(;i.length>0;){const a=i.shift();!a||s.has(a.id)||(s.add(a.id),this.runTreeMap.set(a.id,a),a.child_runs&&i.push(...a.child_runs))}this.client=r.client??this.client,this.replicas=r.replicas??this.replicas,this.projectName=r.project_name??this.projectName,this.exampleId=r.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(r){const n=this.runTreeMap.get(r);if(n)return new br({...n,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return I$(!0)}catch{return}}};const zE=Symbol.for("ls:tracing_async_local_storage"),_o=Symbol.for("lc:context_variables"),R$=t=>{globalThis[zE]=t},No=()=>globalThis[zE];let wi;function O$(){const t="default"in ds?ds.default:ds;return new t({autoStart:!0,concurrency:1})}function $$(){return typeof wi>"u"&&(wi=O$()),wi}async function xt(t,e){if(e===!0){const r=No();r!==void 0?await r.run(void 0,async()=>t()):await t()}else wi=$$(),wi.add(async()=>{const r=No();r!==void 0?await r.run(void 0,async()=>t()):await t()})}async function N$(){const t=BE();await Promise.allSettled([typeof wi<"u"?wi.onIdle():Promise.resolve(),t.awaitPendingTraceBatches()])}var VE={};ve(VE,{awaitAllCallbacks:()=>N$,consumeCallback:()=>xt});function up(t,e=wa){t=t.trim();const r=t.indexOf("```");if(r===-1)return e(t);let n=t.substring(r+3);n.startsWith(`json
`)?n=n.substring(5):n.startsWith("json")?n=n.substring(4):n.startsWith(`
`)&&(n=n.substring(1));const s=n.indexOf("```");let i=n;return s!==-1&&(i=n.substring(0,s)),e(i.trim())}function wa(t){if(typeof t>"u")return null;try{return JSON.parse(t)}catch{}let e="";const r=[];let n=!1,s=!1;for(let i of t){if(n)i==='"'&&!s?n=!1:i===`
`&&!s?i="\\n":i==="\\"?s=!s:s=!1;else if(i==='"')n=!0,s=!1;else if(i==="{")r.push("}");else if(i==="[")r.push("]");else if(i==="}"||i==="]")if(r&&r[r.length-1]===i)r.pop();else return null;e+=i}n&&(e+='"');for(let i=r.length-1;i>=0;i-=1)e+=r[i];try{return JSON.parse(e)}catch{return null}}var qE={},nd={};nd.byteLength=M$;nd.toByteArray=U$;nd.fromByteArray=F$;var Dn=[],Zr=[],P$=typeof Uint8Array<"u"?Uint8Array:Array,sf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var qi=0,L$=sf.length;qi<L$;++qi)Dn[qi]=sf[qi],Zr[sf.charCodeAt(qi)]=qi;Zr[45]=62;Zr[95]=63;function HE(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=t.indexOf("=");r===-1&&(r=e);var n=r===e?0:4-r%4;return[r,n]}function M$(t){var e=HE(t),r=e[0],n=e[1];return(r+n)*3/4-n}function D$(t,e,r){return(e+r)*3/4-r}function U$(t){var e,r=HE(t),n=r[0],s=r[1],i=new P$(D$(t,n,s)),a=0,o=s>0?n-4:n,c;for(c=0;c<o;c+=4)e=Zr[t.charCodeAt(c)]<<18|Zr[t.charCodeAt(c+1)]<<12|Zr[t.charCodeAt(c+2)]<<6|Zr[t.charCodeAt(c+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return s===2&&(e=Zr[t.charCodeAt(c)]<<2|Zr[t.charCodeAt(c+1)]>>4,i[a++]=e&255),s===1&&(e=Zr[t.charCodeAt(c)]<<10|Zr[t.charCodeAt(c+1)]<<4|Zr[t.charCodeAt(c+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function B$(t){return Dn[t>>18&63]+Dn[t>>12&63]+Dn[t>>6&63]+Dn[t&63]}function j$(t,e,r){for(var n,s=[],i=e;i<r;i+=3)n=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(B$(n));return s.join("")}function F$(t){for(var e,r=t.length,n=r%3,s=[],i=16383,a=0,o=r-n;a<o;a+=i)s.push(j$(t,a,a+i>o?o:a+i));return n===1?(e=t[r-1],s.push(Dn[e>>2]+Dn[e<<4&63]+"==")):n===2&&(e=(t[r-2]<<8)+t[r-1],s.push(Dn[e>>10]+Dn[e>>4&63]+Dn[e<<2&63]+"=")),s.join("")}var rg={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */rg.read=function(t,e,r,n,s){var i,a,o=s*8-n-1,c=(1<<o)-1,l=c>>1,u=-7,d=r?s-1:0,h=r?-1:1,f=t[e+d];for(d+=h,i=f&(1<<-u)-1,f>>=-u,u+=o;u>0;i=i*256+t[e+d],d+=h,u-=8);for(a=i&(1<<-u)-1,i>>=-u,u+=n;u>0;a=a*256+t[e+d],d+=h,u-=8);if(i===0)i=1-l;else{if(i===c)return a?NaN:(f?-1:1)*(1/0);a=a+Math.pow(2,n),i=i-l}return(f?-1:1)*a*Math.pow(2,i-n)};rg.write=function(t,e,r,n,s,i){var a,o,c,l=i*8-s-1,u=(1<<l)-1,d=u>>1,h=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:i-1,m=n?1:-1,g=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(o=isNaN(e)?1:0,a=u):(a=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-a))<1&&(a--,c*=2),a+d>=1?e+=h/c:e+=h*Math.pow(2,1-d),e*c>=2&&(a++,c/=2),a+d>=u?(o=0,a=u):a+d>=1?(o=(e*c-1)*Math.pow(2,s),a=a+d):(o=e*Math.pow(2,d-1)*Math.pow(2,s),a=0));s>=8;t[r+f]=o&255,f+=m,o/=256,s-=8);for(a=a<<s|o,l+=s;l>0;t[r+f]=a&255,f+=m,a/=256,l-=8);t[r+f-m]|=g*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(t){const e=nd,r=rg,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=u,t.SlowBuffer=k,t.INSPECT_MAX_BYTES=50;const s=2147483647;t.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:a,SharedArrayBuffer:o}=globalThis;u.TYPED_ARRAY_SUPPORT=c(),!u.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function c(){try{const T=new i(1),w={foo:function(){return 42}};return Object.setPrototypeOf(w,i.prototype),Object.setPrototypeOf(T,w),T.foo()===42}catch{return!1}}Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}});function l(T){if(T>s)throw new RangeError('The value "'+T+'" is invalid for option "size"');const w=new i(T);return Object.setPrototypeOf(w,u.prototype),w}function u(T,w,v){if(typeof T=="number"){if(typeof w=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return m(T)}return d(T,w,v)}u.poolSize=8192;function d(T,w,v){if(typeof T=="string")return g(T,w);if(a.isView(T))return b(T);if(T==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof T);if(Q(T,a)||T&&Q(T.buffer,a)||typeof o<"u"&&(Q(T,o)||T&&Q(T.buffer,o)))return _(T,w,v);if(typeof T=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const I=T.valueOf&&T.valueOf();if(I!=null&&I!==T)return u.from(I,w,v);const O=E(T);if(O)return O;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof T[Symbol.toPrimitive]=="function")return u.from(T[Symbol.toPrimitive]("string"),w,v);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof T)}u.from=function(T,w,v){return d(T,w,v)},Object.setPrototypeOf(u.prototype,i.prototype),Object.setPrototypeOf(u,i);function h(T){if(typeof T!="number")throw new TypeError('"size" argument must be of type number');if(T<0)throw new RangeError('The value "'+T+'" is invalid for option "size"')}function f(T,w,v){return h(T),T<=0?l(T):w!==void 0?typeof v=="string"?l(T).fill(w,v):l(T).fill(w):l(T)}u.alloc=function(T,w,v){return f(T,w,v)};function m(T){return h(T),l(T<0?0:C(T)|0)}u.allocUnsafe=function(T){return m(T)},u.allocUnsafeSlow=function(T){return m(T)};function g(T,w){if((typeof w!="string"||w==="")&&(w="utf8"),!u.isEncoding(w))throw new TypeError("Unknown encoding: "+w);const v=R(T,w)|0;let I=l(v);const O=I.write(T,w);return O!==v&&(I=I.slice(0,O)),I}function y(T){const w=T.length<0?0:C(T.length)|0,v=l(w);for(let I=0;I<w;I+=1)v[I]=T[I]&255;return v}function b(T){if(Q(T,i)){const w=new i(T);return _(w.buffer,w.byteOffset,w.byteLength)}return y(T)}function _(T,w,v){if(w<0||T.byteLength<w)throw new RangeError('"offset" is outside of buffer bounds');if(T.byteLength<w+(v||0))throw new RangeError('"length" is outside of buffer bounds');let I;return w===void 0&&v===void 0?I=new i(T):v===void 0?I=new i(T,w):I=new i(T,w,v),Object.setPrototypeOf(I,u.prototype),I}function E(T){if(u.isBuffer(T)){const w=C(T.length)|0,v=l(w);return v.length===0||T.copy(v,0,0,w),v}if(T.length!==void 0)return typeof T.length!="number"||K(T.length)?l(0):y(T);if(T.type==="Buffer"&&Array.isArray(T.data))return y(T.data)}function C(T){if(T>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return T|0}function k(T){return+T!=T&&(T=0),u.alloc(+T)}u.isBuffer=function(w){return w!=null&&w._isBuffer===!0&&w!==u.prototype},u.compare=function(w,v){if(Q(w,i)&&(w=u.from(w,w.offset,w.byteLength)),Q(v,i)&&(v=u.from(v,v.offset,v.byteLength)),!u.isBuffer(w)||!u.isBuffer(v))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(w===v)return 0;let I=w.length,O=v.length;for(let L=0,F=Math.min(I,O);L<F;++L)if(w[L]!==v[L]){I=w[L],O=v[L];break}return I<O?-1:O<I?1:0},u.isEncoding=function(w){switch(String(w).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(w,v){if(!Array.isArray(w))throw new TypeError('"list" argument must be an Array of Buffers');if(w.length===0)return u.alloc(0);let I;if(v===void 0)for(v=0,I=0;I<w.length;++I)v+=w[I].length;const O=u.allocUnsafe(v);let L=0;for(I=0;I<w.length;++I){let F=w[I];if(Q(F,i))L+F.length>O.length?(u.isBuffer(F)||(F=u.from(F)),F.copy(O,L)):i.prototype.set.call(O,F,L);else if(u.isBuffer(F))F.copy(O,L);else throw new TypeError('"list" argument must be an Array of Buffers');L+=F.length}return O};function R(T,w){if(u.isBuffer(T))return T.length;if(a.isView(T)||Q(T,a))return T.byteLength;if(typeof T!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof T);const v=T.length,I=arguments.length>2&&arguments[2]===!0;if(!I&&v===0)return 0;let O=!1;for(;;)switch(w){case"ascii":case"latin1":case"binary":return v;case"utf8":case"utf-8":return Y(T).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return v*2;case"hex":return v>>>1;case"base64":return me(T).length;default:if(O)return I?-1:Y(T).length;w=(""+w).toLowerCase(),O=!0}}u.byteLength=R;function $(T,w,v){let I=!1;if((w===void 0||w<0)&&(w=0),w>this.length||((v===void 0||v>this.length)&&(v=this.length),v<=0)||(v>>>=0,w>>>=0,v<=w))return"";for(T||(T="utf8");;)switch(T){case"hex":return W(this,w,v);case"utf8":case"utf-8":return ie(this,w,v);case"ascii":return le(this,w,v);case"latin1":case"binary":return Ee(this,w,v);case"base64":return G(this,w,v);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return X(this,w,v);default:if(I)throw new TypeError("Unknown encoding: "+T);T=(T+"").toLowerCase(),I=!0}}u.prototype._isBuffer=!0;function S(T,w,v){const I=T[w];T[w]=T[v],T[v]=I}u.prototype.swap16=function(){const w=this.length;if(w%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let v=0;v<w;v+=2)S(this,v,v+1);return this},u.prototype.swap32=function(){const w=this.length;if(w%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let v=0;v<w;v+=4)S(this,v,v+3),S(this,v+1,v+2);return this},u.prototype.swap64=function(){const w=this.length;if(w%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let v=0;v<w;v+=8)S(this,v,v+7),S(this,v+1,v+6),S(this,v+2,v+5),S(this,v+3,v+4);return this},u.prototype.toString=function(){const w=this.length;return w===0?"":arguments.length===0?ie(this,0,w):$.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(w){if(!u.isBuffer(w))throw new TypeError("Argument must be a Buffer");return this===w?!0:u.compare(this,w)===0},u.prototype.inspect=function(){let w="";const v=t.INSPECT_MAX_BYTES;return w=this.toString("hex",0,v).replace(/(.{2})/g,"$1 ").trim(),this.length>v&&(w+=" ... "),"<Buffer "+w+">"},n&&(u.prototype[n]=u.prototype.inspect),u.prototype.compare=function(w,v,I,O,L){if(Q(w,i)&&(w=u.from(w,w.offset,w.byteLength)),!u.isBuffer(w))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof w);if(v===void 0&&(v=0),I===void 0&&(I=w?w.length:0),O===void 0&&(O=0),L===void 0&&(L=this.length),v<0||I>w.length||O<0||L>this.length)throw new RangeError("out of range index");if(O>=L&&v>=I)return 0;if(O>=L)return-1;if(v>=I)return 1;if(v>>>=0,I>>>=0,O>>>=0,L>>>=0,this===w)return 0;let F=L-O,Be=I-v;const pt=Math.min(F,Be),ot=this.slice(O,L),mt=w.slice(v,I);for(let nt=0;nt<pt;++nt)if(ot[nt]!==mt[nt]){F=ot[nt],Be=mt[nt];break}return F<Be?-1:Be<F?1:0};function M(T,w,v,I,O){if(T.length===0)return-1;if(typeof v=="string"?(I=v,v=0):v>2147483647?v=2147483647:v<-2147483648&&(v=-2147483648),v=+v,K(v)&&(v=O?0:T.length-1),v<0&&(v=T.length+v),v>=T.length){if(O)return-1;v=T.length-1}else if(v<0)if(O)v=0;else return-1;if(typeof w=="string"&&(w=u.from(w,I)),u.isBuffer(w))return w.length===0?-1:B(T,w,v,I,O);if(typeof w=="number")return w=w&255,typeof i.prototype.indexOf=="function"?O?i.prototype.indexOf.call(T,w,v):i.prototype.lastIndexOf.call(T,w,v):B(T,[w],v,I,O);throw new TypeError("val must be string, number or Buffer")}function B(T,w,v,I,O){let L=1,F=T.length,Be=w.length;if(I!==void 0&&(I=String(I).toLowerCase(),I==="ucs2"||I==="ucs-2"||I==="utf16le"||I==="utf-16le")){if(T.length<2||w.length<2)return-1;L=2,F/=2,Be/=2,v/=2}function pt(mt,nt){return L===1?mt[nt]:mt.readUInt16BE(nt*L)}let ot;if(O){let mt=-1;for(ot=v;ot<F;ot++)if(pt(T,ot)===pt(w,mt===-1?0:ot-mt)){if(mt===-1&&(mt=ot),ot-mt+1===Be)return mt*L}else mt!==-1&&(ot-=ot-mt),mt=-1}else for(v+Be>F&&(v=F-Be),ot=v;ot>=0;ot--){let mt=!0;for(let nt=0;nt<Be;nt++)if(pt(T,ot+nt)!==pt(w,nt)){mt=!1;break}if(mt)return ot}return-1}u.prototype.includes=function(w,v,I){return this.indexOf(w,v,I)!==-1},u.prototype.indexOf=function(w,v,I){return M(this,w,v,I,!0)},u.prototype.lastIndexOf=function(w,v,I){return M(this,w,v,I,!1)};function q(T,w,v,I){v=Number(v)||0;const O=T.length-v;I?(I=Number(I),I>O&&(I=O)):I=O;const L=w.length;I>L/2&&(I=L/2);let F;for(F=0;F<I;++F){const Be=parseInt(w.substr(F*2,2),16);if(K(Be))return F;T[v+F]=Be}return F}function se(T,w,v,I){return Se(Y(w,T.length-v),T,v,I)}function pe(T,w,v,I){return Se(Yn(w),T,v,I)}function j(T,w,v,I){return Se(me(w),T,v,I)}function z(T,w,v,I){return Se(xe(w,T.length-v),T,v,I)}u.prototype.write=function(w,v,I,O){if(v===void 0)O="utf8",I=this.length,v=0;else if(I===void 0&&typeof v=="string")O=v,I=this.length,v=0;else if(isFinite(v))v=v>>>0,isFinite(I)?(I=I>>>0,O===void 0&&(O="utf8")):(O=I,I=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const L=this.length-v;if((I===void 0||I>L)&&(I=L),w.length>0&&(I<0||v<0)||v>this.length)throw new RangeError("Attempt to write outside buffer bounds");O||(O="utf8");let F=!1;for(;;)switch(O){case"hex":return q(this,w,v,I);case"utf8":case"utf-8":return se(this,w,v,I);case"ascii":case"latin1":case"binary":return pe(this,w,v,I);case"base64":return j(this,w,v,I);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return z(this,w,v,I);default:if(F)throw new TypeError("Unknown encoding: "+O);O=(""+O).toLowerCase(),F=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function G(T,w,v){return w===0&&v===T.length?e.fromByteArray(T):e.fromByteArray(T.slice(w,v))}function ie(T,w,v){v=Math.min(T.length,v);const I=[];let O=w;for(;O<v;){const L=T[O];let F=null,Be=L>239?4:L>223?3:L>191?2:1;if(O+Be<=v){let pt,ot,mt,nt;switch(Be){case 1:L<128&&(F=L);break;case 2:pt=T[O+1],(pt&192)===128&&(nt=(L&31)<<6|pt&63,nt>127&&(F=nt));break;case 3:pt=T[O+1],ot=T[O+2],(pt&192)===128&&(ot&192)===128&&(nt=(L&15)<<12|(pt&63)<<6|ot&63,nt>2047&&(nt<55296||nt>57343)&&(F=nt));break;case 4:pt=T[O+1],ot=T[O+2],mt=T[O+3],(pt&192)===128&&(ot&192)===128&&(mt&192)===128&&(nt=(L&15)<<18|(pt&63)<<12|(ot&63)<<6|mt&63,nt>65535&&nt<1114112&&(F=nt))}}F===null?(F=65533,Be=1):F>65535&&(F-=65536,I.push(F>>>10&1023|55296),F=56320|F&1023),I.push(F),O+=Be}return te(I)}const ce=4096;function te(T){const w=T.length;if(w<=ce)return String.fromCharCode.apply(String,T);let v="",I=0;for(;I<w;)v+=String.fromCharCode.apply(String,T.slice(I,I+=ce));return v}function le(T,w,v){let I="";v=Math.min(T.length,v);for(let O=w;O<v;++O)I+=String.fromCharCode(T[O]&127);return I}function Ee(T,w,v){let I="";v=Math.min(T.length,v);for(let O=w;O<v;++O)I+=String.fromCharCode(T[O]);return I}function W(T,w,v){const I=T.length;(!w||w<0)&&(w=0),(!v||v<0||v>I)&&(v=I);let O="";for(let L=w;L<v;++L)O+=Ae[T[L]];return O}function X(T,w,v){const I=T.slice(w,v);let O="";for(let L=0;L<I.length-1;L+=2)O+=String.fromCharCode(I[L]+I[L+1]*256);return O}u.prototype.slice=function(w,v){const I=this.length;w=~~w,v=v===void 0?I:~~v,w<0?(w+=I,w<0&&(w=0)):w>I&&(w=I),v<0?(v+=I,v<0&&(v=0)):v>I&&(v=I),v<w&&(v=w);const O=this.subarray(w,v);return Object.setPrototypeOf(O,u.prototype),O};function ae(T,w,v){if(T%1!==0||T<0)throw new RangeError("offset is not uint");if(T+w>v)throw new RangeError("Trying to access beyond buffer length")}u.prototype.readUintLE=u.prototype.readUIntLE=function(w,v,I){w=w>>>0,v=v>>>0,I||ae(w,v,this.length);let O=this[w],L=1,F=0;for(;++F<v&&(L*=256);)O+=this[w+F]*L;return O},u.prototype.readUintBE=u.prototype.readUIntBE=function(w,v,I){w=w>>>0,v=v>>>0,I||ae(w,v,this.length);let O=this[w+--v],L=1;for(;v>0&&(L*=256);)O+=this[w+--v]*L;return O},u.prototype.readUint8=u.prototype.readUInt8=function(w,v){return w=w>>>0,v||ae(w,1,this.length),this[w]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(w,v){return w=w>>>0,v||ae(w,2,this.length),this[w]|this[w+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(w,v){return w=w>>>0,v||ae(w,2,this.length),this[w]<<8|this[w+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),(this[w]|this[w+1]<<8|this[w+2]<<16)+this[w+3]*16777216},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),this[w]*16777216+(this[w+1]<<16|this[w+2]<<8|this[w+3])},u.prototype.readBigUInt64LE=ye(function(w){w=w>>>0,Xe(w,"offset");const v=this[w],I=this[w+7];(v===void 0||I===void 0)&&Lt(w,this.length-8);const O=v+this[++w]*2**8+this[++w]*2**16+this[++w]*2**24,L=this[++w]+this[++w]*2**8+this[++w]*2**16+I*2**24;return BigInt(O)+(BigInt(L)<<BigInt(32))}),u.prototype.readBigUInt64BE=ye(function(w){w=w>>>0,Xe(w,"offset");const v=this[w],I=this[w+7];(v===void 0||I===void 0)&&Lt(w,this.length-8);const O=v*2**24+this[++w]*2**16+this[++w]*2**8+this[++w],L=this[++w]*2**24+this[++w]*2**16+this[++w]*2**8+I;return(BigInt(O)<<BigInt(32))+BigInt(L)}),u.prototype.readIntLE=function(w,v,I){w=w>>>0,v=v>>>0,I||ae(w,v,this.length);let O=this[w],L=1,F=0;for(;++F<v&&(L*=256);)O+=this[w+F]*L;return L*=128,O>=L&&(O-=Math.pow(2,8*v)),O},u.prototype.readIntBE=function(w,v,I){w=w>>>0,v=v>>>0,I||ae(w,v,this.length);let O=v,L=1,F=this[w+--O];for(;O>0&&(L*=256);)F+=this[w+--O]*L;return L*=128,F>=L&&(F-=Math.pow(2,8*v)),F},u.prototype.readInt8=function(w,v){return w=w>>>0,v||ae(w,1,this.length),this[w]&128?(255-this[w]+1)*-1:this[w]},u.prototype.readInt16LE=function(w,v){w=w>>>0,v||ae(w,2,this.length);const I=this[w]|this[w+1]<<8;return I&32768?I|4294901760:I},u.prototype.readInt16BE=function(w,v){w=w>>>0,v||ae(w,2,this.length);const I=this[w+1]|this[w]<<8;return I&32768?I|4294901760:I},u.prototype.readInt32LE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),this[w]|this[w+1]<<8|this[w+2]<<16|this[w+3]<<24},u.prototype.readInt32BE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),this[w]<<24|this[w+1]<<16|this[w+2]<<8|this[w+3]},u.prototype.readBigInt64LE=ye(function(w){w=w>>>0,Xe(w,"offset");const v=this[w],I=this[w+7];(v===void 0||I===void 0)&&Lt(w,this.length-8);const O=this[w+4]+this[w+5]*2**8+this[w+6]*2**16+(I<<24);return(BigInt(O)<<BigInt(32))+BigInt(v+this[++w]*2**8+this[++w]*2**16+this[++w]*2**24)}),u.prototype.readBigInt64BE=ye(function(w){w=w>>>0,Xe(w,"offset");const v=this[w],I=this[w+7];(v===void 0||I===void 0)&&Lt(w,this.length-8);const O=(v<<24)+this[++w]*2**16+this[++w]*2**8+this[++w];return(BigInt(O)<<BigInt(32))+BigInt(this[++w]*2**24+this[++w]*2**16+this[++w]*2**8+I)}),u.prototype.readFloatLE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),r.read(this,w,!0,23,4)},u.prototype.readFloatBE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),r.read(this,w,!1,23,4)},u.prototype.readDoubleLE=function(w,v){return w=w>>>0,v||ae(w,8,this.length),r.read(this,w,!0,52,8)},u.prototype.readDoubleBE=function(w,v){return w=w>>>0,v||ae(w,8,this.length),r.read(this,w,!1,52,8)};function V(T,w,v,I,O,L){if(!u.isBuffer(T))throw new TypeError('"buffer" argument must be a Buffer instance');if(w>O||w<L)throw new RangeError('"value" argument is out of bounds');if(v+I>T.length)throw new RangeError("Index out of range")}u.prototype.writeUintLE=u.prototype.writeUIntLE=function(w,v,I,O){if(w=+w,v=v>>>0,I=I>>>0,!O){const Be=Math.pow(2,8*I)-1;V(this,w,v,I,Be,0)}let L=1,F=0;for(this[v]=w&255;++F<I&&(L*=256);)this[v+F]=w/L&255;return v+I},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(w,v,I,O){if(w=+w,v=v>>>0,I=I>>>0,!O){const Be=Math.pow(2,8*I)-1;V(this,w,v,I,Be,0)}let L=I-1,F=1;for(this[v+L]=w&255;--L>=0&&(F*=256);)this[v+L]=w/F&255;return v+I},u.prototype.writeUint8=u.prototype.writeUInt8=function(w,v,I){return w=+w,v=v>>>0,I||V(this,w,v,1,255,0),this[v]=w&255,v+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(w,v,I){return w=+w,v=v>>>0,I||V(this,w,v,2,65535,0),this[v]=w&255,this[v+1]=w>>>8,v+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(w,v,I){return w=+w,v=v>>>0,I||V(this,w,v,2,65535,0),this[v]=w>>>8,this[v+1]=w&255,v+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(w,v,I){return w=+w,v=v>>>0,I||V(this,w,v,4,4294967295,0),this[v+3]=w>>>24,this[v+2]=w>>>16,this[v+1]=w>>>8,this[v]=w&255,v+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(w,v,I){return w=+w,v=v>>>0,I||V(this,w,v,4,4294967295,0),this[v]=w>>>24,this[v+1]=w>>>16,this[v+2]=w>>>8,this[v+3]=w&255,v+4};function A(T,w,v,I,O){zt(w,I,O,T,v,7);let L=Number(w&BigInt(4294967295));T[v++]=L,L=L>>8,T[v++]=L,L=L>>8,T[v++]=L,L=L>>8,T[v++]=L;let F=Number(w>>BigInt(32)&BigInt(4294967295));return T[v++]=F,F=F>>8,T[v++]=F,F=F>>8,T[v++]=F,F=F>>8,T[v++]=F,v}function x(T,w,v,I,O){zt(w,I,O,T,v,7);let L=Number(w&BigInt(4294967295));T[v+7]=L,L=L>>8,T[v+6]=L,L=L>>8,T[v+5]=L,L=L>>8,T[v+4]=L;let F=Number(w>>BigInt(32)&BigInt(4294967295));return T[v+3]=F,F=F>>8,T[v+2]=F,F=F>>8,T[v+1]=F,F=F>>8,T[v]=F,v+8}u.prototype.writeBigUInt64LE=ye(function(w,v=0){return A(this,w,v,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeBigUInt64BE=ye(function(w,v=0){return x(this,w,v,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeIntLE=function(w,v,I,O){if(w=+w,v=v>>>0,!O){const pt=Math.pow(2,8*I-1);V(this,w,v,I,pt-1,-pt)}let L=0,F=1,Be=0;for(this[v]=w&255;++L<I&&(F*=256);)w<0&&Be===0&&this[v+L-1]!==0&&(Be=1),this[v+L]=(w/F>>0)-Be&255;return v+I},u.prototype.writeIntBE=function(w,v,I,O){if(w=+w,v=v>>>0,!O){const pt=Math.pow(2,8*I-1);V(this,w,v,I,pt-1,-pt)}let L=I-1,F=1,Be=0;for(this[v+L]=w&255;--L>=0&&(F*=256);)w<0&&Be===0&&this[v+L+1]!==0&&(Be=1),this[v+L]=(w/F>>0)-Be&255;return v+I},u.prototype.writeInt8=function(w,v,I){return w=+w,v=v>>>0,I||V(this,w,v,1,127,-128),w<0&&(w=255+w+1),this[v]=w&255,v+1},u.prototype.writeInt16LE=function(w,v,I){return w=+w,v=v>>>0,I||V(this,w,v,2,32767,-32768),this[v]=w&255,this[v+1]=w>>>8,v+2},u.prototype.writeInt16BE=function(w,v,I){return w=+w,v=v>>>0,I||V(this,w,v,2,32767,-32768),this[v]=w>>>8,this[v+1]=w&255,v+2},u.prototype.writeInt32LE=function(w,v,I){return w=+w,v=v>>>0,I||V(this,w,v,4,2147483647,-2147483648),this[v]=w&255,this[v+1]=w>>>8,this[v+2]=w>>>16,this[v+3]=w>>>24,v+4},u.prototype.writeInt32BE=function(w,v,I){return w=+w,v=v>>>0,I||V(this,w,v,4,2147483647,-2147483648),w<0&&(w=4294967295+w+1),this[v]=w>>>24,this[v+1]=w>>>16,this[v+2]=w>>>8,this[v+3]=w&255,v+4},u.prototype.writeBigInt64LE=ye(function(w,v=0){return A(this,w,v,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),u.prototype.writeBigInt64BE=ye(function(w,v=0){return x(this,w,v,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function D(T,w,v,I,O,L){if(v+I>T.length)throw new RangeError("Index out of range");if(v<0)throw new RangeError("Index out of range")}function N(T,w,v,I,O){return w=+w,v=v>>>0,O||D(T,w,v,4),r.write(T,w,v,I,23,4),v+4}u.prototype.writeFloatLE=function(w,v,I){return N(this,w,v,!0,I)},u.prototype.writeFloatBE=function(w,v,I){return N(this,w,v,!1,I)};function ke(T,w,v,I,O){return w=+w,v=v>>>0,O||D(T,w,v,8),r.write(T,w,v,I,52,8),v+8}u.prototype.writeDoubleLE=function(w,v,I){return ke(this,w,v,!0,I)},u.prototype.writeDoubleBE=function(w,v,I){return ke(this,w,v,!1,I)},u.prototype.copy=function(w,v,I,O){if(!u.isBuffer(w))throw new TypeError("argument should be a Buffer");if(I||(I=0),!O&&O!==0&&(O=this.length),v>=w.length&&(v=w.length),v||(v=0),O>0&&O<I&&(O=I),O===I||w.length===0||this.length===0)return 0;if(v<0)throw new RangeError("targetStart out of bounds");if(I<0||I>=this.length)throw new RangeError("Index out of range");if(O<0)throw new RangeError("sourceEnd out of bounds");O>this.length&&(O=this.length),w.length-v<O-I&&(O=w.length-v+I);const L=O-I;return this===w&&typeof i.prototype.copyWithin=="function"?this.copyWithin(v,I,O):i.prototype.set.call(w,this.subarray(I,O),v),L},u.prototype.fill=function(w,v,I,O){if(typeof w=="string"){if(typeof v=="string"?(O=v,v=0,I=this.length):typeof I=="string"&&(O=I,I=this.length),O!==void 0&&typeof O!="string")throw new TypeError("encoding must be a string");if(typeof O=="string"&&!u.isEncoding(O))throw new TypeError("Unknown encoding: "+O);if(w.length===1){const F=w.charCodeAt(0);(O==="utf8"&&F<128||O==="latin1")&&(w=F)}}else typeof w=="number"?w=w&255:typeof w=="boolean"&&(w=Number(w));if(v<0||this.length<v||this.length<I)throw new RangeError("Out of range index");if(I<=v)return this;v=v>>>0,I=I===void 0?this.length:I>>>0,w||(w=0);let L;if(typeof w=="number")for(L=v;L<I;++L)this[L]=w;else{const F=u.isBuffer(w)?w:u.from(w,O),Be=F.length;if(Be===0)throw new TypeError('The value "'+w+'" is invalid for argument "value"');for(L=0;L<I-v;++L)this[L+v]=F[L%Be]}return this};const $e={};function Je(T,w,v){$e[T]=class extends v{constructor(){super(),Object.defineProperty(this,"message",{value:w.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${T}]`,this.stack,delete this.name}get code(){return T}set code(O){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:O,writable:!0})}toString(){return`${this.name} [${T}]: ${this.message}`}}}Je("ERR_BUFFER_OUT_OF_BOUNDS",function(T){return T?`${T} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),Je("ERR_INVALID_ARG_TYPE",function(T,w){return`The "${T}" argument must be of type number. Received type ${typeof w}`},TypeError),Je("ERR_OUT_OF_RANGE",function(T,w,v){let I=`The value of "${T}" is out of range.`,O=v;return Number.isInteger(v)&&Math.abs(v)>2**32?O=at(String(v)):typeof v=="bigint"&&(O=String(v),(v>BigInt(2)**BigInt(32)||v<-(BigInt(2)**BigInt(32)))&&(O=at(O)),O+="n"),I+=` It must be ${w}. Received ${O}`,I},RangeError);function at(T){let w="",v=T.length;const I=T[0]==="-"?1:0;for(;v>=I+4;v-=3)w=`_${T.slice(v-3,v)}${w}`;return`${T.slice(0,v)}${w}`}function ft(T,w,v){Xe(w,"offset"),(T[w]===void 0||T[w+v]===void 0)&&Lt(w,T.length-(v+1))}function zt(T,w,v,I,O,L){if(T>v||T<w){const F=typeof w=="bigint"?"n":"";let Be;throw w===0||w===BigInt(0)?Be=`>= 0${F} and < 2${F} ** ${(L+1)*8}${F}`:Be=`>= -(2${F} ** ${(L+1)*8-1}${F}) and < 2 ** ${(L+1)*8-1}${F}`,new $e.ERR_OUT_OF_RANGE("value",Be,T)}ft(I,O,L)}function Xe(T,w){if(typeof T!="number")throw new $e.ERR_INVALID_ARG_TYPE(w,"number",T)}function Lt(T,w,v){throw Math.floor(T)!==T?(Xe(T,v),new $e.ERR_OUT_OF_RANGE("offset","an integer",T)):w<0?new $e.ERR_BUFFER_OUT_OF_BOUNDS:new $e.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${w}`,T)}const Ss=/[^+/0-9A-Za-z-_]/g;function Vi(T){if(T=T.split("=")[0],T=T.trim().replace(Ss,""),T.length<2)return"";for(;T.length%4!==0;)T=T+"=";return T}function Y(T,w){w=w||1/0;let v;const I=T.length;let O=null;const L=[];for(let F=0;F<I;++F){if(v=T.charCodeAt(F),v>55295&&v<57344){if(!O){if(v>56319){(w-=3)>-1&&L.push(239,191,189);continue}else if(F+1===I){(w-=3)>-1&&L.push(239,191,189);continue}O=v;continue}if(v<56320){(w-=3)>-1&&L.push(239,191,189),O=v;continue}v=(O-55296<<10|v-56320)+65536}else O&&(w-=3)>-1&&L.push(239,191,189);if(O=null,v<128){if((w-=1)<0)break;L.push(v)}else if(v<2048){if((w-=2)<0)break;L.push(v>>6|192,v&63|128)}else if(v<65536){if((w-=3)<0)break;L.push(v>>12|224,v>>6&63|128,v&63|128)}else if(v<1114112){if((w-=4)<0)break;L.push(v>>18|240,v>>12&63|128,v>>6&63|128,v&63|128)}else throw new Error("Invalid code point")}return L}function Yn(T){const w=[];for(let v=0;v<T.length;++v)w.push(T.charCodeAt(v)&255);return w}function xe(T,w){let v,I,O;const L=[];for(let F=0;F<T.length&&!((w-=2)<0);++F)v=T.charCodeAt(F),I=v>>8,O=v%256,L.push(O),L.push(I);return L}function me(T){return e.toByteArray(Vi(T))}function Se(T,w,v,I){let O;for(O=0;O<I&&!(O+v>=w.length||O>=T.length);++O)w[O+v]=T[O];return O}function Q(T,w){return T instanceof w||T!=null&&T.constructor!=null&&T.constructor.name!=null&&T.constructor.name===w.name}function K(T){return T!==T}const Ae=(function(){const T="0123456789abcdef",w=new Array(256);for(let v=0;v<16;++v){const I=v*16;for(let O=0;O<16;++O)w[I+O]=T[v]+T[O]}return w})();function ye(T){return typeof BigInt>"u"?nr:T}function nr(){throw new Error("BigInt not supported")}})(qE);const er=qE.Buffer;function ng(t){switch(t){case"csv":return"text/csv";case"doc":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":return"image/jpeg";case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function z$(t){if(Ie(t.document)&&Ie(t.document.source)){const e=Ie(t.document)&&oe(t.document.format)?t.document.format:"",r=ng(e);if(Ie(t.document.source)){if(Ie(t.document.source.s3Location)&&oe(t.document.source.s3Location.uri))return{type:"file",mimeType:r,fileId:t.document.source.s3Location.uri};if(Fm(t.document.source.bytes))return{type:"file",mimeType:r,data:t.document.source.bytes};if(oe(t.document.source.text))return{type:"file",mimeType:r,data:er.from(t.document.source.text).toString("base64")};if(qn(t.document.source.content)){const n=t.document.source.content.reduce((s,i)=>Ie(i)&&oe(i.text)?s+i.text:s,"");return{type:"file",mimeType:r,data:n}}}}return{type:"non_standard",value:t}}function V$(t){if(be(t,"image")&&Ie(t.image)){const e=Ie(t.image)&&oe(t.image.format)?t.image.format:"",r=ng(e);if(Ie(t.image.source)){if(Ie(t.image.source.s3Location)&&oe(t.image.source.s3Location.uri))return{type:"image",mimeType:r,fileId:t.image.source.s3Location.uri};if(Fm(t.image.source.bytes))return{type:"image",mimeType:r,data:t.image.source.bytes}}}return{type:"non_standard",value:t}}function q$(t){if(be(t,"video")&&Ie(t.video)){const e=Ie(t.video)&&oe(t.video.format)?t.video.format:"",r=ng(e);if(Ie(t.video.source)){if(Ie(t.video.source.s3Location)&&oe(t.video.source.s3Location.uri))return{type:"video",mimeType:r,fileId:t.video.source.s3Location.uri};if(Fm(t.video.source.bytes))return{type:"video",mimeType:r,data:t.video.source.bytes}}}return{type:"non_standard",value:t}}function kw(t){function*e(){const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r){if(be(n,"cache_point")){yield{type:"non_standard",value:n};continue}else if(be(n,"citations_content")&&Ie(n.citationsContent)){const s=qn(n.citationsContent.content)?n.citationsContent.content.reduce((a,o)=>Ie(o)&&oe(o.text)?a+o.text:a,""):"",i=qn(n.citationsContent.citations)?n.citationsContent.citations.reduce((a,o)=>{if(Ie(o)){const c=qn(o.sourceContent)?o.sourceContent.reduce((u,d)=>Ie(d)&&oe(d.text)?u+d.text:u,""):"",l=Oo(()=>{if(Ie(o.location)){const u=o.location.documentChar||o.location.documentPage||o.location.documentChunk;if(Ie(u))return{source:mn(u.documentIndex)?u.documentIndex.toString():void 0,startIndex:mn(u.start)?u.start:void 0,endIndex:mn(u.end)?u.end:void 0}}return{}});a.push({type:"citation",citedText:c,...l})}return a},[]):[];yield{type:"text",text:s,annotations:i};continue}else if(be(n,"document")&&Ie(n.document)){yield z$(n);continue}else if(be(n,"guard_content")){yield{type:"non_standard",value:n};continue}else if(be(n,"image")&&Ie(n.image)){yield V$(n);continue}else if(be(n,"reasoning_content")&&oe(n.reasoningText)){yield{type:"reasoning",reasoning:n.reasoningText};continue}else if(be(n,"text")&&oe(n.text)){yield{type:"text",text:n.text};continue}else if(be(n,"tool_result")){yield{type:"non_standard",value:n};continue}else{if(be(n,"tool_call"))continue;if(be(n,"video")&&Ie(n.video)){yield q$(n);continue}}yield{type:"non_standard",value:n}}}return Array.from(e())}const H$={translateContent:kw,translateContentChunk:kw};function Iw(t){function*e(){const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r){if(be(n,"text")&&oe(n.text)){yield{type:"text",text:n.text};continue}else if(be(n,"inlineData")&&Ie(n.inlineData)&&oe(n.inlineData.mimeType)&&oe(n.inlineData.data)){yield{type:"file",mimeType:n.inlineData.mimeType,data:n.inlineData.data};continue}else if(be(n,"functionCall")&&Ie(n.functionCall)&&oe(n.functionCall.name)&&Ie(n.functionCall.args)){yield{type:"tool_call",id:t.id,name:n.functionCall.name,args:n.functionCall.args};continue}else if(be(n,"functionResponse")){yield{type:"non_standard",value:n};continue}else if(be(n,"fileData")&&Ie(n.fileData)&&oe(n.fileData.mimeType)&&oe(n.fileData.fileUri)){yield{type:"file",mimeType:n.fileData.mimeType,fileId:n.fileData.fileUri};continue}else if(be(n,"executableCode")){yield{type:"non_standard",value:n};continue}else if(be(n,"codeExecutionResult")){yield{type:"non_standard",value:n};continue}yield{type:"non_standard",value:n}}}return Array.from(e())}const G$={translateContent:Iw,translateContentChunk:Iw};function Rw(t){function*e(){const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r){if(be(n,"reasoning")&&oe(n.reasoning)){const s=Oo(()=>{var a;const i=r.indexOf(n);if(qn((a=t.additional_kwargs)==null?void 0:a.signatures)&&i>=0)return t.additional_kwargs.signatures.at(i)});oe(s)?yield{type:"reasoning",reasoning:n.reasoning,signature:s}:yield{type:"reasoning",reasoning:n.reasoning};continue}else if(be(n,"text")&&oe(n.text)){yield{type:"text",text:n.text};continue}else if(be(n,"image_url")){if(oe(n.image_url))if(n.image_url.startsWith("data:")){const s=/^data:([^;]+);base64,(.+)$/,i=n.image_url.match(s);i?yield{type:"image",data:i[2],mimeType:i[1]}:yield{type:"image",url:n.image_url}}else yield{type:"image",url:n.image_url};continue}else if(be(n,"media")&&oe(n.mimeType)&&oe(n.data)){yield{type:"file",mimeType:n.mimeType,data:n.data};continue}yield{type:"non_standard",value:n}}}return Array.from(e())}const W$={translateContent:Rw,translateContentChunk:Rw};globalThis.lc_block_translators_registry??(globalThis.lc_block_translators_registry=new Map([["anthropic",L1],["bedrock-converse",H$],["google-genai",G$],["google-vertexai",W$],["openai",H1]]));function GE(t){return globalThis.lc_block_translators_registry.get(t)}function WE(t,e){return or(t??{},e??{})}function JE(t,e){const r={};return((t==null?void 0:t.audio)!==void 0||(e==null?void 0:e.audio)!==void 0)&&(r.audio=((t==null?void 0:t.audio)??0)+((e==null?void 0:e.audio)??0)),((t==null?void 0:t.image)!==void 0||(e==null?void 0:e.image)!==void 0)&&(r.image=((t==null?void 0:t.image)??0)+((e==null?void 0:e.image)??0)),((t==null?void 0:t.video)!==void 0||(e==null?void 0:e.video)!==void 0)&&(r.video=((t==null?void 0:t.video)??0)+((e==null?void 0:e.video)??0)),((t==null?void 0:t.document)!==void 0||(e==null?void 0:e.document)!==void 0)&&(r.document=((t==null?void 0:t.document)??0)+((e==null?void 0:e.document)??0)),((t==null?void 0:t.text)!==void 0||(e==null?void 0:e.text)!==void 0)&&(r.text=((t==null?void 0:t.text)??0)+((e==null?void 0:e.text)??0)),r}function J$(t,e){const r={...JE(t,e)};return((t==null?void 0:t.cache_read)!==void 0||(e==null?void 0:e.cache_read)!==void 0)&&(r.cache_read=((t==null?void 0:t.cache_read)??0)+((e==null?void 0:e.cache_read)??0)),((t==null?void 0:t.cache_creation)!==void 0||(e==null?void 0:e.cache_creation)!==void 0)&&(r.cache_creation=((t==null?void 0:t.cache_creation)??0)+((e==null?void 0:e.cache_creation)??0)),r}function Z$(t,e){const r={...JE(t,e)};return((t==null?void 0:t.reasoning)!==void 0||(e==null?void 0:e.reasoning)!==void 0)&&(r.reasoning=((t==null?void 0:t.reasoning)??0)+((e==null?void 0:e.reasoning)??0)),r}function ZE(t,e){return{input_tokens:((t==null?void 0:t.input_tokens)??0)+((e==null?void 0:e.input_tokens)??0),output_tokens:((t==null?void 0:t.output_tokens)??0)+((e==null?void 0:e.output_tokens)??0),total_tokens:((t==null?void 0:t.total_tokens)??0)+((e==null?void 0:e.total_tokens)??0),input_token_details:J$(t==null?void 0:t.input_token_details,e==null?void 0:e.input_token_details),output_token_details:Z$(t==null?void 0:t.output_token_details,e==null?void 0:e.output_token_details)}}var ht=class extends nn{constructor(e){var n;let r;if(typeof e=="string"||Array.isArray(e))r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:{}};else{r=e;const s=(n=r.additional_kwargs)==null?void 0:n.tool_calls,i=r.tool_calls;s!=null&&s.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `pnpm install @langchain/anthropic`,","pnpm install @langchain/openai`, etc."].join(" "));try{if(s!=null&&i===void 0){const[a,o]=qm(s);r.tool_calls=a??[],r.invalid_tool_calls=o??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}if(r.response_metadata!==void 0&&"output_version"in r.response_metadata&&r.response_metadata.output_version==="v1"&&(r.contentBlocks=r.content,r.content=void 0),r.contentBlocks!==void 0){r.contentBlocks.push(...r.tool_calls.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})));const a=r.contentBlocks.filter(o=>o.type==="tool_call").filter(o=>{var c;return!((c=r.tool_calls)!=null&&c.some(l=>l.id===o.id&&l.name===o.name))});a.length>0&&(r.tool_calls=a.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})))}}super(r);p(this,"type","ai");p(this,"tool_calls",[]);p(this,"invalid_tool_calls",[]);p(this,"usage_metadata");typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}static lc_name(){return"AIMessage"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const r=GE(this.response_metadata.model_provider);if(r)return r.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls){const r=this.tool_calls.filter(n=>!e.some(s=>s.id===n.id&&s.name===n.name));e.push(...r.map(n=>({...n,type:"tool_call",id:n.id,name:n.name,args:n.args})))}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}};function ms(t){return t._getType()==="ai"}function dp(t){return t._getType()==="ai"}var At=class extends Di{constructor(e){var n,s;let r;if(typeof e=="string"||Array.isArray(e))r={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)r={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const i=e.tool_call_chunks.reduce((c,l)=>{const u=c.findIndex(([d])=>"id"in l&&l.id&&"index"in l&&l.index!==void 0?l.id===d.id&&l.index===d.index:"id"in l&&l.id?l.id===d.id:"index"in l&&l.index!==void 0?l.index===d.index:!1);return u!==-1?c[u].push(l):c.push([l]),c},[]),a=[],o=[];for(const c of i){let l=null;const u=((n=c[0])==null?void 0:n.name)??"",d=c.map(m=>m.args||"").join(""),h=d.length?d:"{}",f=(s=c[0])==null?void 0:s.id;try{if(l=wa(h),!f||l===null||typeof l!="object"||Array.isArray(l))throw new Error("Malformed tool call chunk args.");a.push({name:u,args:l,id:f,type:"tool_call"})}catch{o.push({name:u,args:h,id:f,error:"Malformed args.",type:"invalid_tool_call"})}}r={...e,tool_calls:a,invalid_tool_calls:o,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(r);p(this,"type","ai");p(this,"tool_calls",[]);p(this,"invalid_tool_calls",[]);p(this,"tool_call_chunks",[]);p(this,"usage_metadata");this.tool_call_chunks=r.tool_call_chunks??this.tool_call_chunks,this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=r.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const r=GE(this.response_metadata.model_provider);if(r)return r.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls&&typeof this.content!="string"){const r=this.content.filter(n=>n.type==="tool_call").map(n=>n.id);for(const n of this.tool_calls)n.id&&!r.includes(n.id)&&e.push({...n,type:"tool_call",id:n.id,name:n.name,args:n.args})}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const r={content:Mi(this.content,e.content),additional_kwargs:or(this.additional_kwargs,e.additional_kwargs),response_metadata:WE(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const s=cc(this.tool_call_chunks,e.tool_call_chunks);s!==void 0&&s.length>0&&(r.tool_call_chunks=s)}(this.usage_metadata!==void 0||e.usage_metadata!==void 0)&&(r.usage_metadata=ZE(this.usage_metadata,e.usage_metadata));const n=this.constructor;return new n(r)}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}},Kn=class KE extends nn{constructor(r,n){(typeof r=="string"||Array.isArray(r))&&(r={content:r,role:n});super(r);p(this,"type","generic");p(this,"role");this.role=r.role}static lc_name(){return"ChatMessage"}static _chatMessageClass(){return KE}static isInstance(r){return super.isInstance(r)&&r.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},dc=class extends Di{constructor(e,r){(typeof e=="string"||Array.isArray(e))&&(e={content:e,role:r});super(e);p(this,"type","generic");p(this,"role");this.role=e.role}static lc_name(){return"ChatMessageChunk"}concat(e){const r=this.constructor;return new r({content:Mi(this.content,e.content),additional_kwargs:or(this.additional_kwargs,e.additional_kwargs),response_metadata:or(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}};function K$(t){return t._getType()==="generic"}function X$(t){return t._getType()==="generic"}var sd=class extends nn{constructor(e){super(e);p(this,"type","function");p(this,"name");this.name=e.name}static lc_name(){return"FunctionMessage"}},hc=class extends Di{constructor(){super(...arguments);p(this,"type","function")}static lc_name(){return"FunctionMessageChunk"}concat(e){const r=this.constructor;return new r({content:Mi(this.content,e.content),additional_kwargs:or(this.additional_kwargs,e.additional_kwargs),response_metadata:or(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}};function Y$(t){return t._getType()==="function"}function Q$(t){return t._getType()==="function"}var ut=class extends nn{constructor(e){super(e);p(this,"type","human")}static lc_name(){return"HumanMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="human"}},fc=class extends Di{constructor(e){super(e);p(this,"type","human")}static lc_name(){return"HumanMessageChunk"}concat(e){const r=this.constructor;return new r({content:Mi(this.content,e.content),additional_kwargs:or(this.additional_kwargs,e.additional_kwargs),response_metadata:or(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="human"}};function eN(t){return t.getType()==="human"}function tN(t){return t.getType()==="human"}var dt=class extends nn{constructor(e){super(e);p(this,"type","system")}static lc_name(){return"SystemMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="system"}},qs=class extends Di{constructor(e){super(e);p(this,"type","system")}static lc_name(){return"SystemMessageChunk"}concat(e){const r=this.constructor;return new r({content:Mi(this.content,e.content),additional_kwargs:or(this.additional_kwargs,e.additional_kwargs),response_metadata:or(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="system"}};function rN(t){return t._getType()==="system"}function nN(t){return t._getType()==="system"}function id(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function wo(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="tool_call")}function sN(t){return!!(t&&typeof t=="object"&&"toolCall"in t&&t.toolCall!=null&&typeof t.toolCall=="object"&&"id"in t.toolCall&&typeof t.toolCall.id=="string")}var Xl=class extends Error{constructor(e,r){super(e);p(this,"output");this.output=r}},Yl=class extends nn{constructor(e){super({...e,content:[]});p(this,"type","remove");p(this,"id");this.id=e.id}get _printableFields(){return{...super._printableFields,id:this.id}}static isInstance(e){return super.isInstance(e)&&e.type==="remove"}};const iN=t=>t();function aN(t){return wo(t)?t:typeof t.id=="string"&&t.type==="function"&&typeof t.function=="object"&&t.function!==null&&"arguments"in t.function&&typeof t.function.arguments=="string"&&"name"in t.function&&typeof t.function.name=="string"?{id:t.id,args:JSON.parse(t.function.arguments),name:t.function.name,type:"tool_call"}:t}function oN(t){return typeof t=="object"&&t!=null&&t.lc===1&&Array.isArray(t.id)&&t.kwargs!=null&&typeof t.kwargs=="object"}function af(t){let e,r;if(oN(t)){const n=t.id.at(-1);n==="HumanMessage"||n==="HumanMessageChunk"?e="user":n==="AIMessage"||n==="AIMessageChunk"?e="assistant":n==="SystemMessage"||n==="SystemMessageChunk"?e="system":n==="FunctionMessage"||n==="FunctionMessageChunk"?e="function":n==="ToolMessage"||n==="ToolMessageChunk"?e="tool":e="unknown",r=t.kwargs}else{const{type:n,...s}=t;e=n,r=s}if(e==="human"||e==="user")return new ut(r);if(e==="ai"||e==="assistant"){const{tool_calls:n,...s}=r;if(!Array.isArray(n))return new ht(r);const i=n.map(aN);return new ht({...s,tool_calls:i})}else{if(e==="system")return new dt(r);if(e==="developer")return new dt({...r,additional_kwargs:{...r.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in r)return new fr({...r,content:r.content,tool_call_id:r.tool_call_id,name:r.name});if(e==="remove"&&"id"in r&&typeof r.id=="string")return new Yl({...r,id:r.id});throw id(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(t,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Hn(t){if(typeof t=="string")return new ut(t);if(St(t))return t;if(Array.isArray(t)){const[e,r]=t;return af({type:e,content:r})}else if(hE(t)){const{role:e,...r}=t;return af({...r,type:e})}else return af(t)}function sg(t,e="Human",r="AI"){const n=[];for(const s of t){let i;if(s._getType()==="human")i=e;else if(s._getType()==="ai")i=r;else if(s._getType()==="system")i="System";else if(s._getType()==="tool")i="Tool";else if(s._getType()==="generic")i=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const a=s.name?`${s.name}, `:"",o=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);n.push(`${i}: ${a}${o}`)}return n.join(`
`)}function cN(t){if(t.data!==void 0)return t;{const e=t;return{type:e.type,data:{content:e.text,role:e.role,name:void 0,tool_call_id:void 0}}}}function ig(t){const e=cN(t);switch(e.type){case"human":return new ut(e.data);case"ai":return new ht(e.data);case"system":return new dt(e.data);case"function":if(e.data.name===void 0)throw new Error("Name must be defined for function messages");return new sd(e.data);case"tool":if(e.data.tool_call_id===void 0)throw new Error("Tool call ID must be defined for tool messages");return new fr(e.data);case"generic":if(e.data.role===void 0)throw new Error("Role must be defined for chat messages");return new Kn(e.data);default:throw new Error(`Got unexpected type: ${e.type}`)}}function lN(t){return t.map(ig)}function uN(t){return t.map(e=>e.toDict())}function Ql(t){var r;const e=t._getType();if(e==="human")return new fc({...t});if(e==="ai"){let n={...t};return"tool_calls"in n&&(n={...n,tool_call_chunks:(r=n.tool_calls)==null?void 0:r.map(s=>({...s,type:"tool_call_chunk",index:void 0,args:JSON.stringify(s.args)}))}),new At({...n})}else{if(e==="system")return new qs({...t});if(e==="function")return new hc({...t});if(Kn.isInstance(t))return new dc({...t});throw new Error("Unknown message type.")}}const dN=t=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(r=>rn(r)==="true");function XE(t){var n;const e=No();if(e===void 0)return;const r=e.getStore();return(n=r==null?void 0:r[_o])==null?void 0:n[t]}const hN=Symbol("lc:configure_hooks"),fN=()=>XE(hN)||[];var YE={};ve(YE,{BaseCallbackManager:()=>QE,BaseRunManager:()=>mc,CallbackManager:()=>pr,CallbackManagerForChainRun:()=>tS,CallbackManagerForLLMRun:()=>hp,CallbackManagerForRetrieverRun:()=>eS,CallbackManagerForToolRun:()=>rS,ensureHandler:()=>Po,parseCallbackConfigArg:()=>pc});function pc(t){return t?Array.isArray(t)||"name"in t?{callbacks:t}:t:{}}var QE=class{setHandler(t){return this.setHandlers([t])}},mc=class{constructor(t,e,r,n,s,i,a,o){this.runId=t,this.handlers=e,this.inheritableHandlers=r,this.tags=n,this.inheritableTags=s,this.metadata=i,this.inheritableMetadata=a,this._parentRunId=o}get parentRunId(){return this._parentRunId}async handleText(t){await Promise.all(this.handlers.map(e=>xt(async()=>{var r;try{await((r=e.handleText)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleText: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}async handleCustomEvent(t,e,r,n,s){await Promise.all(this.handlers.map(i=>xt(async()=>{var a;try{await((a=i.handleCustomEvent)==null?void 0:a.call(i,t,e,this.runId,this.tags,this.metadata))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}},eS=class extends mc{getChild(t){const e=new pr(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleRetrieverEnd(t){await Promise.all(this.handlers.map(e=>xt(async()=>{var r;if(!e.ignoreRetriever)try{await((r=e.handleRetrieverEnd)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetriever`),e.raiseError)throw n}},e.awaitHandlers)))}async handleRetrieverError(t){await Promise.all(this.handlers.map(e=>xt(async()=>{var r;if(!e.ignoreRetriever)try{await((r=e.handleRetrieverError)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetrieverError: ${n}`),e.raiseError)throw t}},e.awaitHandlers)))}},hp=class extends mc{async handleLLMNewToken(t,e,r,n,s,i){await Promise.all(this.handlers.map(a=>xt(async()=>{var o;if(!a.ignoreLLM)try{await((o=a.handleLLMNewToken)==null?void 0:o.call(a,t,e??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMNewToken: ${c}`),a.raiseError)throw c}},a.awaitHandlers)))}async handleLLMError(t,e,r,n,s){await Promise.all(this.handlers.map(i=>xt(async()=>{var a;if(!i.ignoreLLM)try{await((a=i.handleLLMError)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleLLMEnd(t,e,r,n,s){await Promise.all(this.handlers.map(i=>xt(async()=>{var a;if(!i.ignoreLLM)try{await((a=i.handleLLMEnd)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}},tS=class extends mc{getChild(t){const e=new pr(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleChainError(t,e,r,n,s){await Promise.all(this.handlers.map(i=>xt(async()=>{var a;if(!i.ignoreChain)try{await((a=i.handleChainError)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleChainEnd(t,e,r,n,s){await Promise.all(this.handlers.map(i=>xt(async()=>{var a;if(!i.ignoreChain)try{await((a=i.handleChainEnd)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleAgentAction(t){await Promise.all(this.handlers.map(e=>xt(async()=>{var r;if(!e.ignoreAgent)try{await((r=e.handleAgentAction)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentAction: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}async handleAgentEnd(t){await Promise.all(this.handlers.map(e=>xt(async()=>{var r;if(!e.ignoreAgent)try{await((r=e.handleAgentEnd)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentEnd: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}},rS=class extends mc{getChild(t){const e=new pr(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleToolError(t){await Promise.all(this.handlers.map(e=>xt(async()=>{var r;if(!e.ignoreAgent)try{await((r=e.handleToolError)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolError: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}async handleToolEnd(t){await Promise.all(this.handlers.map(e=>xt(async()=>{var r;if(!e.ignoreAgent)try{await((r=e.handleToolEnd)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolEnd: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}},pr=class Ya extends QE{constructor(r,n){super();p(this,"handlers",[]);p(this,"inheritableHandlers",[]);p(this,"tags",[]);p(this,"inheritableTags",[]);p(this,"metadata",{});p(this,"inheritableMetadata",{});p(this,"name","callback_manager");p(this,"_parentRunId");this.handlers=(n==null?void 0:n.handlers)??this.handlers,this.inheritableHandlers=(n==null?void 0:n.inheritableHandlers)??this.inheritableHandlers,this.tags=(n==null?void 0:n.tags)??this.tags,this.inheritableTags=(n==null?void 0:n.inheritableTags)??this.inheritableTags,this.metadata=(n==null?void 0:n.metadata)??this.metadata,this.inheritableMetadata=(n==null?void 0:n.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=r}getParentRunId(){return this._parentRunId}async handleLLMStart(r,n,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0,l=void 0){return Promise.all(n.map(async(u,d)=>{const h=d===0&&s?s:ss();return await Promise.all(this.handlers.map(f=>{if(!f.ignoreLLM)return ea(f)&&f._createRunForLLMStart(r,[u],h,this._parentRunId,a,this.tags,this.metadata,l),xt(async()=>{var m;try{await((m=f.handleLLMStart)==null?void 0:m.call(f,r,[u],h,this._parentRunId,a,this.tags,this.metadata,l))}catch(g){if((f.raiseError?console.error:console.warn)(`Error in handler ${f.constructor.name}, handleLLMStart: ${g}`),f.raiseError)throw g}},f.awaitHandlers)})),new hp(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(r,n,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0,l=void 0){return Promise.all(n.map(async(u,d)=>{const h=d===0&&s?s:ss();return await Promise.all(this.handlers.map(f=>{if(!f.ignoreLLM)return ea(f)&&f._createRunForChatModelStart(r,[u],h,this._parentRunId,a,this.tags,this.metadata,l),xt(async()=>{var m,g;try{if(f.handleChatModelStart)await((m=f.handleChatModelStart)==null?void 0:m.call(f,r,[u],h,this._parentRunId,a,this.tags,this.metadata,l));else if(f.handleLLMStart){const y=sg(u);await((g=f.handleLLMStart)==null?void 0:g.call(f,r,[y],h,this._parentRunId,a,this.tags,this.metadata,l))}}catch(y){if((f.raiseError?console.error:console.warn)(`Error in handler ${f.constructor.name}, handleLLMStart: ${y}`),f.raiseError)throw y}},f.awaitHandlers)})),new hp(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(r,n,s=ss(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreChain)return ea(l)&&l._createRunForChainStart(r,n,s,this._parentRunId,this.tags,this.metadata,i,c),xt(async()=>{var u;try{await((u=l.handleChainStart)==null?void 0:u.call(l,r,n,s,this._parentRunId,this.tags,this.metadata,i,c))}catch(d){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleChainStart: ${d}`),l.raiseError)throw d}},l.awaitHandlers)})),new tS(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(r,n,s=ss(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreAgent)return ea(l)&&l._createRunForToolStart(r,n,s,this._parentRunId,this.tags,this.metadata,c),xt(async()=>{var u;try{await((u=l.handleToolStart)==null?void 0:u.call(l,r,n,s,this._parentRunId,this.tags,this.metadata,c))}catch(d){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleToolStart: ${d}`),l.raiseError)throw d}},l.awaitHandlers)})),new rS(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(r,n,s=ss(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreRetriever)return ea(l)&&l._createRunForRetrieverStart(r,n,s,this._parentRunId,this.tags,this.metadata,c),xt(async()=>{var u;try{await((u=l.handleRetrieverStart)==null?void 0:u.call(l,r,n,s,this._parentRunId,this.tags,this.metadata,c))}catch(d){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleRetrieverStart: ${d}`),l.raiseError)throw d}},l.awaitHandlers)})),new eS(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(r,n,s,i,a){await Promise.all(this.handlers.map(o=>xt(async()=>{var c;if(!o.ignoreCustomEvent)try{await((c=o.handleCustomEvent)==null?void 0:c.call(o,r,n,s,this.tags,this.metadata))}catch(l){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleCustomEvent: ${l}`),o.raiseError)throw l}},o.awaitHandlers)))}addHandler(r,n=!0){this.handlers.push(r),n&&this.inheritableHandlers.push(r)}removeHandler(r){this.handlers=this.handlers.filter(n=>n!==r),this.inheritableHandlers=this.inheritableHandlers.filter(n=>n!==r)}setHandlers(r,n=!0){this.handlers=[],this.inheritableHandlers=[];for(const s of r)this.addHandler(s,n)}addTags(r,n=!0){this.removeTags(r),this.tags.push(...r),n&&this.inheritableTags.push(...r)}removeTags(r){this.tags=this.tags.filter(n=>!r.includes(n)),this.inheritableTags=this.inheritableTags.filter(n=>!r.includes(n))}addMetadata(r,n=!0){this.metadata={...this.metadata,...r},n&&(this.inheritableMetadata={...this.inheritableMetadata,...r})}removeMetadata(r){for(const n of Object.keys(r))delete this.metadata[n],delete this.inheritableMetadata[n]}copy(r=[],n=!0){const s=new Ya(this._parentRunId);for(const i of this.handlers){const a=this.inheritableHandlers.includes(i);s.addHandler(i,a)}for(const i of this.tags){const a=this.inheritableTags.includes(i);s.addTags([i],a)}for(const i of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(i);s.addMetadata({[i]:this.metadata[i]},a)}for(const i of r)s.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===i.name)||s.addHandler(i,n);return s}static fromHandlers(r){class n extends La{constructor(){super();p(this,"name",ss());Object.assign(this,r)}}const s=new this;return s.addHandler(new n),s}static configure(r,n,s,i,a,o,c){return this._configureSync(r,n,s,i,a,o,c)}static _configureSync(r,n,s,i,a,o,c){var f;let l;(r||n)&&(Array.isArray(r)||!r?(l=new Ya,l.setHandlers((r==null?void 0:r.map(Po))??[],!0)):l=r,l=l.copy(Array.isArray(n)?n.map(Po):n==null?void 0:n.handlers,!1));const u=rn("LANGCHAIN_VERBOSE")==="true"||(c==null?void 0:c.verbose),d=((f=wl.getTraceableRunTree())==null?void 0:f.tracingEnabled)||dN(),h=d||(rn("LANGCHAIN_TRACING")??!1);if(u||h){if(l||(l=new Ya),u&&!l.handlers.some(m=>m.name===lp.prototype.name)){const m=new lp;l.addHandler(m,!0)}if(h&&!l.handlers.some(m=>m.name==="langchain_tracer")&&d){const m=new wl;l.addHandler(m,!0)}if(d){const m=wl.getTraceableRunTree();if(m&&l._parentRunId===void 0){l._parentRunId=m.id;const g=l.handlers.find(y=>y.name==="langchain_tracer");g==null||g.updateFromRunTree(m)}}}for(const{contextVar:m,inheritable:g=!0,handlerClass:y,envVar:b}of fN()){const _=b&&rn(b)==="true"&&y;let E;const C=m!==void 0?XE(m):void 0;C&&yE(C)?E=C:_&&(E=new y({})),E!==void 0&&(l||(l=new Ya),l.handlers.some(k=>k.name===E.name)||l.addHandler(E,g))}return(s||i)&&l&&(l.addTags(s??[]),l.addTags(i??[],!1)),(a||o)&&l&&(l.addMetadata(a??{}),l.addMetadata(o??{},!1)),l}};function Po(t){return"name"in t?t:La.fromMethods(t)}var nS=class{getStore(){}run(t,e){return e()}enterWith(t){}};const pN=new nS,Ow=Symbol.for("lc:child_config");var mN=class{getInstance(){return No()??pN}getRunnableConfig(){var e,r;return(r=(e=this.getInstance().getStore())==null?void 0:e.extra)==null?void 0:r[Ow]}runWithConfig(t,e,r){var l;const n=pr._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),s=this.getInstance(),i=s.getStore(),a=n==null?void 0:n.getParentRunId(),o=(l=n==null?void 0:n.handlers)==null?void 0:l.find(u=>(u==null?void 0:u.name)==="langchain_tracer");let c;return o&&a?c=o.getRunTreeWithTracingConfig(a):r||(c=new br({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[Ow]:t}),i!==void 0&&i[_o]!==void 0&&(c===void 0&&(c={}),c[_o]=i[_o]),s.run(c,e)}initializeGlobalInstance(t){No()===void 0&&R$(t)}};const Bt=new mN;var sS={};ve(sS,{AsyncLocalStorageProviderSingleton:()=>Bt,MockAsyncLocalStorage:()=>nS,_CONTEXT_VARIABLES_KEY:()=>_o});const of=25;async function Ar(t){return pr._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata)}function en(...t){const e={};for(const r of t.filter(n=>!!n))for(const n of Object.keys(r))if(n==="metadata")e[n]={...e[n],...r[n]};else if(n==="tags"){const s=e[n]??[];e[n]=[...new Set(s.concat(r[n]??[]))]}else if(n==="configurable")e[n]={...e[n],...r[n]};else if(n==="timeout")e.timeout===void 0?e.timeout=r.timeout:r.timeout!==void 0&&(e.timeout=Math.min(e.timeout,r.timeout));else if(n==="signal")e.signal===void 0?e.signal=r.signal:r.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,r.signal]):e.signal=r.signal);else if(n==="callbacks"){const s=e.callbacks,i=r.callbacks;if(Array.isArray(i))if(!s)e.callbacks=i;else if(Array.isArray(s))e.callbacks=s.concat(i);else{const a=s.copy();for(const o of i)a.addHandler(Po(o),!0);e.callbacks=a}else if(i)if(!s)e.callbacks=i;else if(Array.isArray(s)){const a=i.copy();for(const o of s)a.addHandler(Po(o),!0);e.callbacks=a}else e.callbacks=new pr(i._parentRunId,{handlers:s.handlers.concat(i.handlers),inheritableHandlers:s.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(i.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(i.inheritableTags))),metadata:{...s.metadata,...i.metadata}})}else{const s=n;e[s]=r[s]??e[s]}return e}const gN=new Set(["string","number","boolean"]);function Ve(t){var n;const e=Bt.getRunnableConfig();let r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:s,runName:i,...a}=e;r=Object.entries(a).reduce((o,[c,l])=>(l!==void 0&&(o[c]=l),o),r)}if(t&&(r=Object.entries(t).reduce((s,[i,a])=>(a!==void 0&&(s[i]=a),s),r)),r!=null&&r.configurable)for(const s of Object.keys(r.configurable))gN.has(typeof r.configurable[s])&&!((n=r.metadata)!=null&&n[s])&&(r.metadata||(r.metadata={}),r.metadata[s]=r.configurable[s]);if(r.timeout!==void 0){if(r.timeout<=0)throw new Error("Timeout must be a positive number");const s=AbortSignal.timeout(r.timeout);r.signal!==void 0?"any"in AbortSignal&&(r.signal=AbortSignal.any([r.signal,s])):r.signal=s,delete r.timeout}return r}function Ze(t={},{callbacks:e,maxConcurrency:r,recursionLimit:n,runName:s,configurable:i,runId:a}={}){const o=Ve(t);return e!==void 0&&(delete o.runName,o.callbacks=e),n!==void 0&&(o.recursionLimit=n),r!==void 0&&(o.maxConcurrency=r),s!==void 0&&(o.runName=s),i!==void 0&&(o.configurable={...o.configurable,...i}),a!==void 0&&delete o.runId,o}function gs(t){return t?{configurable:t.configurable,recursionLimit:t.recursionLimit,callbacks:t.callbacks,tags:t.tags,metadata:t.metadata,maxConcurrency:t.maxConcurrency,timeout:t.timeout,signal:t.signal}:void 0}async function Hs(t,e){if(e===void 0)return t;let r;return Promise.race([t.catch(n=>{if(!(e!=null&&e.aborted))throw n}),new Promise((n,s)=>{r=()=>{s(Lo(e))},e.addEventListener("abort",r),e.aborted&&s(Lo(e))})]).finally(()=>e.removeEventListener("abort",r))}function Lo(t){return(t==null?void 0:t.reason)instanceof Error?t.reason:typeof(t==null?void 0:t.reason)=="string"?new Error(t.reason):new Error("Aborted")}var iS={};ve(iS,{AsyncGeneratorWithSetup:()=>Ui,IterableReadableStream:()=>kr,atee:()=>ag,concat:()=>Gs,pipeGeneratorWithSetup:()=>aS});var kr=class fp extends ReadableStream{constructor(){super(...arguments);p(this,"reader")}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const r=await this.reader.read();return r.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:r.value}}catch(r){throw this.reader.releaseLock(),r}}async return(){if(this.ensureReader(),this.locked){const r=this.reader.cancel();this.reader.releaseLock(),await r}return{done:!0,value:void 0}}async throw(r){if(this.ensureReader(),this.locked){const n=this.reader.cancel();this.reader.releaseLock(),await n}throw r}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(r){const n=r.getReader();return new fp({start(s){return i();function i(){return n.read().then(({done:a,value:o})=>{if(a){s.close();return}return s.enqueue(o),i()})}},cancel(){n.releaseLock()}})}static fromAsyncGenerator(r){return new fp({async pull(n){const{value:s,done:i}=await r.next();i&&n.close(),n.enqueue(s)},async cancel(n){await r.return(n)}})}};function ag(t,e=2){const r=Array.from({length:e},()=>[]);return r.map(async function*(s){for(;;)if(s.length===0){const i=await t.next();for(const a of r)a.push(i)}else{if(s[0].done)return;yield s.shift().value}})}function Gs(t,e){if(Array.isArray(t)&&Array.isArray(e))return t.concat(e);if(typeof t=="string"&&typeof e=="string")return t+e;if(typeof t=="number"&&typeof e=="number")return t+e;if("concat"in t&&typeof t.concat=="function")return t.concat(e);if(typeof t=="object"&&typeof e=="object"){const r={...t};for(const[n,s]of Object.entries(e))n in r&&!Array.isArray(r[n])?r[n]=Gs(r[n],s):r[n]=s;return r}else throw new Error(`Cannot concat ${typeof t} and ${typeof e}`)}var Ui=class{constructor(t){p(this,"generator");p(this,"setup");p(this,"config");p(this,"signal");p(this,"firstResult");p(this,"firstResultUsed",!1);var e;this.generator=t.generator,this.config=t.config,this.signal=t.signal??((e=this.config)==null?void 0:e.signal),this.setup=new Promise((r,n)=>{Bt.runWithConfig(gs(t.config),async()=>{this.firstResult=t.generator.next(),t.startSetup?this.firstResult.then(t.startSetup).then(r,n):this.firstResult.then(s=>r(void 0),n)},!0)})}async next(...t){var e;return(e=this.signal)==null||e.throwIfAborted(),this.firstResultUsed?Bt.runWithConfig(gs(this.config),this.signal?async()=>Hs(this.generator.next(...t),this.signal):async()=>this.generator.next(...t),!0):(this.firstResultUsed=!0,this.firstResult)}async return(t){return this.generator.return(t)}async throw(t){return this.generator.throw(t)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function aS(t,e,r,n,...s){const i=new Ui({generator:e,startSetup:r,signal:n}),a=await i.setup;return{output:t(i,a,...s),setup:a}}/*!
* https://github.com/Starcounter-Jack/JSON-Patch
* (c) 2017-2022 Joachim Wester
* MIT licensed
*/const yN=Object.prototype.hasOwnProperty;function pp(t,e){return yN.call(t,e)}function mp(t){if(Array.isArray(t)){const r=new Array(t.length);for(let n=0;n<r.length;n++)r[n]=""+n;return r}if(Object.keys)return Object.keys(t);let e=[];for(let r in t)pp(t,r)&&e.push(r);return e}function vn(t){switch(typeof t){case"object":return JSON.parse(JSON.stringify(t));case"undefined":return null;default:return t}}function gp(t){let e=0;const r=t.length;let n;for(;e<r;){if(n=t.charCodeAt(e),n>=48&&n<=57){e++;continue}return!1}return!0}function Hi(t){return t.indexOf("/")===-1&&t.indexOf("~")===-1?t:t.replace(/~/g,"~0").replace(/\//g,"~1")}function _N(t){return t.replace(/~1/g,"/").replace(/~0/g,"~")}function yp(t){if(t===void 0)return!0;if(t){if(Array.isArray(t)){for(let r=0,n=t.length;r<n;r++)if(yp(t[r]))return!0}else if(typeof t=="object"){const r=mp(t),n=r.length;for(var e=0;e<n;e++)if(yp(t[r[e]]))return!0}}return!1}function $w(t,e){const r=[t];for(const n in e){const s=typeof e[n]=="object"?JSON.stringify(e[n],null,2):e[n];typeof s<"u"&&r.push(`${n}: ${s}`)}return r.join(`
`)}var wN=class extends Error{constructor(t,e,r,n,s){super($w(t,{name:e,index:r,operation:n,tree:s})),this.name=e,this.index=r,this.operation=n,this.tree=s,Object.setPrototypeOf(this,new.target.prototype),this.message=$w(t,{name:e,index:r,operation:n,tree:s})}},oS={};ve(oS,{JsonPatchError:()=>gt,_areEquals:()=>Mo,applyOperation:()=>bi,applyPatch:()=>ba,applyReducer:()=>EN,deepClone:()=>bN,getValueByPointer:()=>eu,validate:()=>cS,validator:()=>tu});const gt=wN,bN=vn,ca={add:function(t,e,r){return t[e]=this.value,{newDocument:r}},remove:function(t,e,r){var n=t[e];return delete t[e],{newDocument:r,removed:n}},replace:function(t,e,r){var n=t[e];return t[e]=this.value,{newDocument:r,removed:n}},move:function(t,e,r){let n=eu(r,this.path);n&&(n=vn(n));const s=bi(r,{op:"remove",path:this.from}).removed;return bi(r,{op:"add",path:this.path,value:s}),{newDocument:r,removed:n}},copy:function(t,e,r){const n=eu(r,this.from);return bi(r,{op:"add",path:this.path,value:vn(n)}),{newDocument:r}},test:function(t,e,r){return{newDocument:r,test:Mo(t[e],this.value)}},_get:function(t,e,r){return this.value=t[e],{newDocument:r}}};var vN={add:function(t,e,r){return gp(e)?t.splice(e,0,this.value):t[e]=this.value,{newDocument:r,index:e}},remove:function(t,e,r){var n=t.splice(e,1);return{newDocument:r,removed:n[0]}},replace:function(t,e,r){var n=t[e];return t[e]=this.value,{newDocument:r,removed:n}},move:ca.move,copy:ca.copy,test:ca.test,_get:ca._get};function eu(t,e){if(e=="")return t;var r={op:"_get",path:e};return bi(t,r),r.value}function bi(t,e,r=!1,n=!0,s=!0,i=0){if(r&&(typeof r=="function"?r(e,0,t,e.path):tu(e,0)),e.path===""){let a={newDocument:t};if(e.op==="add")return a.newDocument=e.value,a;if(e.op==="replace")return a.newDocument=e.value,a.removed=t,a;if(e.op==="move"||e.op==="copy")return a.newDocument=eu(t,e.from),e.op==="move"&&(a.removed=t),a;if(e.op==="test"){if(a.test=Mo(t,e.value),a.test===!1)throw new gt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return a.newDocument=t,a}else{if(e.op==="remove")return a.removed=t,a.newDocument=null,a;if(e.op==="_get")return e.value=t,a;if(r)throw new gt("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,t);return a}}else{n||(t=vn(t));const o=(e.path||"").split("/");let c=t,l=1,u=o.length,d,h,f;for(typeof r=="function"?f=r:f=tu;;){if(h=o[l],h&&h.indexOf("~")!=-1&&(h=_N(h)),s&&(h=="__proto__"||h=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&d===void 0&&(c[h]===void 0?d=o.slice(0,l).join("/"):l==u-1&&(d=e.path),d!==void 0&&f(e,0,t,d)),l++,Array.isArray(c)){if(h==="-")h=c.length;else{if(r&&!gp(h))throw new gt("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,t);gp(h)&&(h=~~h)}if(l>=u){if(r&&e.op==="add"&&h>c.length)throw new gt("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,t);const m=vN[e.op].call(e,c,h,t);if(m.test===!1)throw new gt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return m}}else if(l>=u){const m=ca[e.op].call(e,c,h,t);if(m.test===!1)throw new gt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return m}if(c=c[h],r&&l<u&&(!c||typeof c!="object"))throw new gt("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,t)}}}function ba(t,e,r,n=!0,s=!0){if(r&&!Array.isArray(e))throw new gt("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(t=vn(t));const i=new Array(e.length);for(let a=0,o=e.length;a<o;a++)i[a]=bi(t,e[a],r,!0,s,a),t=i[a].newDocument;return i.newDocument=t,i}function EN(t,e,r){const n=bi(t,e);if(n.test===!1)throw new gt("Test operation failed","TEST_OPERATION_FAILED",r,e,t);return n.newDocument}function tu(t,e,r,n){if(typeof t!="object"||t===null||Array.isArray(t))throw new gt("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,t,r);if(ca[t.op]){if(typeof t.path!="string")throw new gt("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,t,r);if(t.path.indexOf("/")!==0&&t.path.length>0)throw new gt('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,t,r);if((t.op==="move"||t.op==="copy")&&typeof t.from!="string")throw new gt("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,t,r);if((t.op==="add"||t.op==="replace"||t.op==="test")&&t.value===void 0)throw new gt("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,t,r);if((t.op==="add"||t.op==="replace"||t.op==="test")&&yp(t.value))throw new gt("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,t,r);if(r){if(t.op=="add"){var s=t.path.split("/").length,i=n.split("/").length;if(s!==i+1&&s!==i)throw new gt("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,t,r)}else if(t.op==="replace"||t.op==="remove"||t.op==="_get"){if(t.path!==n)throw new gt("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,t,r)}else if(t.op==="move"||t.op==="copy"){var a={op:"_get",path:t.from,value:void 0},o=cS([a],r);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new gt("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,t,r)}}}else throw new gt("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,t,r)}function cS(t,e,r){try{if(!Array.isArray(t))throw new gt("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)ba(vn(e),vn(t),r||!0);else{r=r||tu;for(var n=0;n<t.length;n++)r(t[n],n,e,void 0)}}catch(s){if(s instanceof gt)return s;throw s}}function Mo(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){var r=Array.isArray(t),n=Array.isArray(e),s,i,a;if(r&&n){if(i=t.length,i!=e.length)return!1;for(s=i;s--!==0;)if(!Mo(t[s],e[s]))return!1;return!0}if(r!=n)return!1;var o=Object.keys(t);if(i=o.length,i!==Object.keys(e).length)return!1;for(s=i;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=i;s--!==0;)if(a=o[s],!Mo(t[a],e[a]))return!1;return!0}return t!==t&&e!==e}function lS(t,e,r,n,s){if(e!==t){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=mp(e),a=mp(t),o=!1,c=a.length-1;c>=0;c--){var l=a[c],u=t[l];if(pp(e,l)&&!(e[l]===void 0&&u!==void 0&&Array.isArray(e)===!1)){var d=e[l];typeof u=="object"&&u!=null&&typeof d=="object"&&d!=null&&Array.isArray(u)===Array.isArray(d)?lS(u,d,r,n+"/"+Hi(l),s):u!==d&&(s&&r.push({op:"test",path:n+"/"+Hi(l),value:vn(u)}),r.push({op:"replace",path:n+"/"+Hi(l),value:vn(d)}))}else Array.isArray(t)===Array.isArray(e)?(s&&r.push({op:"test",path:n+"/"+Hi(l),value:vn(u)}),r.push({op:"remove",path:n+"/"+Hi(l)}),o=!0):(s&&r.push({op:"test",path:n,value:t}),r.push({op:"replace",path:n,value:e}))}if(!(!o&&i.length==a.length))for(var c=0;c<i.length;c++){var l=i[c];!pp(t,l)&&e[l]!==void 0&&r.push({op:"add",path:n+"/"+Hi(l),value:vn(e[l])})}}}function ad(t,e,r=!1){var n=[];return lS(t,e,n,"",r),n}({...oS});var uS={};ve(uS,{LogStreamCallbackHandler:()=>wp,RunLog:()=>og,RunLogPatch:()=>is,isLogStreamHandler:()=>dS});var is=class{constructor(t){p(this,"ops");this.ops=t.ops??[]}concat(t){const e=this.ops.concat(t.ops),r=ba({},e);return new og({ops:e,state:r[r.length-1].newDocument})}},og=class _p extends is{constructor(r){super(r);p(this,"state");this.state=r.state}concat(r){const n=this.ops.concat(r.ops),s=ba(this.state,r.ops);return new _p({ops:n,state:s[s.length-1].newDocument})}static fromRunLogPatch(r){const n=ba({},r.ops);return new _p({ops:r.ops,state:n[n.length-1].newDocument})}};const dS=t=>t.name==="log_stream_tracer";async function Nw(t,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=t;if(["retriever","llm","prompt"].includes(t.run_type))return r;if(!(Object.keys(r).length===1&&(r==null?void 0:r.input)===""))return r.input}async function Pw(t,e){const{outputs:r}=t;return e==="original"||["retriever","llm","prompt"].includes(t.run_type)?r:r!==void 0&&Object.keys(r).length===1&&(r==null?void 0:r.output)!==void 0?r.output:r}function SN(t){return t!==void 0&&t.message!==void 0}var wp=class extends Es{constructor(e){super({_awaitHandler:!0,...e});p(this,"autoClose",!0);p(this,"includeNames");p(this,"includeTypes");p(this,"includeTags");p(this,"excludeNames");p(this,"excludeTypes");p(this,"excludeTags");p(this,"_schemaFormat","original");p(this,"rootId");p(this,"keyMapByRunId",{});p(this,"counterMapByRunName",{});p(this,"transformStream");p(this,"writer");p(this,"receiveStream");p(this,"name","log_stream_tracer");p(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=kr.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const r=e.tags??[];let n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(n=n||r.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(n=n&&r.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),n}async*tapOutputIterable(e,r){for await(const n of r){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new is({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new is({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const r=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=r===1?e.name:`${e.name}:${r}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(n.inputs=await Nw(e,this._schemaFormat)),await this.writer.write(new is({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const r=this.keyMapByRunId[e.id];if(r===void 0)return;const n=[];this._schemaFormat==="streaming_events"&&n.push({op:"replace",path:`/logs/${r}/inputs`,value:await Nw(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${r}/final_output`,value:await Pw(e,this._schemaFormat)}),e.end_time!==void 0&&n.push({op:"add",path:`/logs/${r}/end_time`,value:new Date(e.end_time).toISOString()});const s=new is({ops:n});await this.writer.write(s)}finally{if(e.id===this.rootId){const r=new is({ops:[{op:"replace",path:"/final_output",value:await Pw(e,this._schemaFormat)}]});await this.writer.write(r),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,r,n){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const i=e.inputs.messages!==void 0;let a;i?SN(n==null?void 0:n.chunk)?a=n==null?void 0:n.chunk:a=new At({id:`run-${e.id}`,content:r}):a=r;const o=new is({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:r},{op:"add",path:`/logs/${s}/streamed_output/-`,value:a}]});await this.writer.write(o)}},hS={};ve(hS,{ChatGenerationChunk:()=>mr,GenerationChunk:()=>va,RUN_KEY:()=>Do});const Do="__run";var va=class fS{constructor(e){p(this,"text");p(this,"generationInfo");this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new fS({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},mr=class pS extends va{constructor(r){super(r);p(this,"message");this.message=r.message}concat(r){return new pS({text:this.text+r.text,generationInfo:{...this.generationInfo,...r.generationInfo},message:this.message.concat(r.message)})}},mS={};ve(mS,{AsyncCaller:()=>gc});const xN=[400,401,402,403,404,405,406,407,409],TN=t=>{var r,n;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||(t==null?void 0:t.code)==="ECONNABORTED")throw t;const e=((r=t==null?void 0:t.response)==null?void 0:r.status)??(t==null?void 0:t.status);if(e&&xN.includes(+e))throw t;if(((n=t==null?void 0:t.error)==null?void 0:n.code)==="insufficient_quota"){const s=new Error(t==null?void 0:t.message);throw s.name="InsufficientQuotaError",s}};var gc=class{constructor(t){p(this,"maxConcurrency");p(this,"maxRetries");p(this,"onFailedAttempt");p(this,"queue");this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6,this.onFailedAttempt=t.onFailedAttempt??TN;const e="default"in ds?ds.default:ds;this.queue=new e({concurrency:this.maxConcurrency})}call(t,...e){return this.queue.add(()=>Jl(()=>t(...e).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(t,e,...r){return t.signal?Promise.race([this.call(e,...r),new Promise((n,s)=>{var i;(i=t.signal)==null||i.addEventListener("abort",()=>{s(Lo(t.signal))})})]):this.call(e,...r)}fetch(...t){return this.call(()=>fetch(...t).then(e=>e.ok?e:Promise.reject(e)))}};function Le(t,e,r){function n(o,c){var l;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(l=o._zod).traits??(l.traits=new Set),o._zod.traits.add(t),e(o,c);for(const u in a.prototype)u in o||Object.defineProperty(o,u,{value:a.prototype[u].bind(o)});o._zod.constr=a,o._zod.def=c}const s=(r==null?void 0:r.Parent)??Object;class i extends s{}Object.defineProperty(i,"name",{value:t});function a(o){var c;const l=r!=null&&r.Parent?new i:this;n(l,o),(c=l._zod).deferred??(c.deferred=[]);for(const u of l._zod.deferred)u();return l}return Object.defineProperty(a,"init",{value:n}),Object.defineProperty(a,Symbol.hasInstance,{value:o=>{var c,l;return r!=null&&r.Parent&&o instanceof r.Parent?!0:(l=(c=o==null?void 0:o._zod)==null?void 0:c.traits)==null?void 0:l.has(t)}}),Object.defineProperty(a,"name",{value:t}),a}class Uo extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const AN={};function ki(t){return AN}function CN(t){const e=Object.values(t).filter(n=>typeof n=="number");return Object.entries(t).filter(([n,s])=>e.indexOf(+n)===-1).map(([n,s])=>s)}function kN(t,e){return typeof e=="bigint"?e.toString():e}function cg(t){return t==null}function lg(t){const e=t.startsWith("^")?1:0,r=t.endsWith("$")?t.length-1:t.length;return t.slice(e,r)}function yt(t,e,r){Object.defineProperty(t,e,{get(){{const n=r();return t[e]=n,n}},set(n){Object.defineProperty(t,e,{value:n})},configurable:!0})}function IN(t,e,r){Object.defineProperty(t,e,{value:r,writable:!0,enumerable:!0,configurable:!0})}const gS=Error.captureStackTrace?Error.captureStackTrace:(...t)=>{};function Lw(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function bp(t){if(Lw(t)===!1)return!1;const e=t.constructor;if(e===void 0)return!0;const r=e.prototype;return!(Lw(r)===!1||Object.prototype.hasOwnProperty.call(r,"isPrototypeOf")===!1)}function Jn(t,e,r){const n=new t._zod.constr(e??t._zod.def);return(!e||r!=null&&r.parent)&&(n._zod.parent=t),n}function Qs(t){const e=t;if(!e)return{};if(typeof e=="string")return{error:()=>e};if((e==null?void 0:e.message)!==void 0){if((e==null?void 0:e.error)!==void 0)throw new Error("Cannot specify both `message` and `error` params");e.error=e.message}return delete e.message,typeof e.error=="string"?{...e,error:()=>e.error}:e}function RN(t,e){if(!bp(e))throw new Error("Invalid input to extend: expected a plain object");const r={...t._zod.def,get shape(){const n={...t._zod.def.shape,...e};return IN(this,"shape",n),n},checks:[]};return Jn(t,r)}function ON(t,e,r){const n=e._zod.def.shape,s={...n};for(const i in n)s[i]=t?new t({type:"optional",innerType:n[i]}):n[i];return Jn(e,{...e._zod.def,shape:s,checks:[]})}function bo(t,e=0){var r;for(let n=e;n<t.issues.length;n++)if(((r=t.issues[n])==null?void 0:r.continue)!==!0)return!0;return!1}function $N(t,e){return e.map(r=>{var n;return(n=r).path??(n.path=[]),r.path.unshift(t),r})}function Vc(t){return typeof t=="string"?t:t==null?void 0:t.message}function Ii(t,e,r){var s,i,a,o,c,l;const n={...t,path:t.path??[]};if(!t.message){const u=Vc((a=(i=(s=t.inst)==null?void 0:s._zod.def)==null?void 0:i.error)==null?void 0:a.call(i,t))??Vc((o=e==null?void 0:e.error)==null?void 0:o.call(e,t))??Vc((c=r.customError)==null?void 0:c.call(r,t))??Vc((l=r.localeError)==null?void 0:l.call(r,t))??"Invalid input";n.message=u}return delete n.inst,delete n.continue,e!=null&&e.reportInput||delete n.input,n}function ug(t){return Array.isArray(t)?"array":typeof t=="string"?"string":"unknown"}function Bo(...t){const[e,r,n]=t;return typeof e=="string"?{message:e,code:"custom",input:r,inst:n}:{...e}}const yS=(t,e)=>{t.name="$ZodError",Object.defineProperty(t,"_zod",{value:t._zod,enumerable:!1}),Object.defineProperty(t,"issues",{value:e,enumerable:!1}),Object.defineProperty(t,"message",{get(){return JSON.stringify(e,kN,2)},enumerable:!0}),Object.defineProperty(t,"toString",{value:()=>t.message,enumerable:!1})},_S=Le("$ZodError",yS),od=Le("$ZodError",yS,{Parent:Error});function NN(t,e=r=>r.message){const r={},n=[];for(const s of t.issues)s.path.length>0?(r[s.path[0]]=r[s.path[0]]||[],r[s.path[0]].push(e(s))):n.push(e(s));return{formErrors:n,fieldErrors:r}}function PN(t,e){const r=e||function(i){return i.message},n={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union"&&a.errors.length)a.errors.map(o=>s({issues:o}));else if(a.code==="invalid_key")s({issues:a.issues});else if(a.code==="invalid_element")s({issues:a.issues});else if(a.path.length===0)n._errors.push(r(a));else{let o=n,c=0;for(;c<a.path.length;){const l=a.path[c];c===a.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(r(a))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return s(t),n}function LN(t){const e=[];for(const r of t)typeof r=="number"?e.push(`[${r}]`):typeof r=="symbol"?e.push(`[${JSON.stringify(String(r))}]`):/[^\w$]/.test(r)?e.push(`[${JSON.stringify(r)}]`):(e.length&&e.push("."),e.push(r));return e.join("")}function MN(t){var n;const e=[],r=[...t.issues].sort((s,i)=>s.path.length-i.path.length);for(const s of r)e.push(`✖ ${s.message}`),(n=s.path)!=null&&n.length&&e.push(`  → at ${LN(s.path)}`);return e.join(`
`)}const wS=t=>(e,r,n,s)=>{const i=n?Object.assign(n,{async:!1}):{async:!1},a=e._zod.run({value:r,issues:[]},i);if(a instanceof Promise)throw new Uo;if(a.issues.length){const o=new((s==null?void 0:s.Err)??t)(a.issues.map(c=>Ii(c,i,ki())));throw gS(o,s==null?void 0:s.callee),o}return a.value},cd=wS(od),bS=t=>async(e,r,n,s)=>{const i=n?Object.assign(n,{async:!0}):{async:!0};let a=e._zod.run({value:r,issues:[]},i);if(a instanceof Promise&&(a=await a),a.issues.length){const o=new((s==null?void 0:s.Err)??t)(a.issues.map(c=>Ii(c,i,ki())));throw gS(o,s==null?void 0:s.callee),o}return a.value},vS=bS(od),ES=t=>(e,r,n)=>{const s=n?{...n,async:!1}:{async:!1},i=e._zod.run({value:r,issues:[]},s);if(i instanceof Promise)throw new Uo;return i.issues.length?{success:!1,error:new(t??_S)(i.issues.map(a=>Ii(a,s,ki())))}:{success:!0,data:i.value}},DN=ES(od),SS=t=>async(e,r,n)=>{const s=n?Object.assign(n,{async:!0}):{async:!0};let i=e._zod.run({value:r,issues:[]},s);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new t(i.issues.map(a=>Ii(a,s,ki())))}:{success:!0,data:i.value}},UN=SS(od),Da=Le("$ZodCheck",(t,e)=>{var r;t._zod??(t._zod={}),t._zod.def=e,(r=t._zod).onattach??(r.onattach=[])}),BN=Le("$ZodCheckMaxLength",(t,e)=>{var r;Da.init(t,e),(r=t._zod.def).when??(r.when=n=>{const s=n.value;return!cg(s)&&s.length!==void 0}),t._zod.onattach.push(n=>{const s=n._zod.bag.maximum??Number.POSITIVE_INFINITY;e.maximum<s&&(n._zod.bag.maximum=e.maximum)}),t._zod.check=n=>{const s=n.value;if(s.length<=e.maximum)return;const a=ug(s);n.issues.push({origin:a,code:"too_big",maximum:e.maximum,inclusive:!0,input:s,inst:t,continue:!e.abort})}}),jN=Le("$ZodCheckMinLength",(t,e)=>{var r;Da.init(t,e),(r=t._zod.def).when??(r.when=n=>{const s=n.value;return!cg(s)&&s.length!==void 0}),t._zod.onattach.push(n=>{const s=n._zod.bag.minimum??Number.NEGATIVE_INFINITY;e.minimum>s&&(n._zod.bag.minimum=e.minimum)}),t._zod.check=n=>{const s=n.value;if(s.length>=e.minimum)return;const a=ug(s);n.issues.push({origin:a,code:"too_small",minimum:e.minimum,inclusive:!0,input:s,inst:t,continue:!e.abort})}}),FN=Le("$ZodCheckLengthEquals",(t,e)=>{var r;Da.init(t,e),(r=t._zod.def).when??(r.when=n=>{const s=n.value;return!cg(s)&&s.length!==void 0}),t._zod.onattach.push(n=>{const s=n._zod.bag;s.minimum=e.length,s.maximum=e.length,s.length=e.length}),t._zod.check=n=>{const s=n.value,i=s.length;if(i===e.length)return;const a=ug(s),o=i>e.length;n.issues.push({origin:a,...o?{code:"too_big",maximum:e.length}:{code:"too_small",minimum:e.length},inclusive:!0,exact:!0,input:n.value,inst:t,continue:!e.abort})}}),zN=Le("$ZodCheckOverwrite",(t,e)=>{Da.init(t,e),t._zod.check=r=>{r.value=e.tx(r.value)}}),VN={major:4,minor:0,patch:0},rr=Le("$ZodType",(t,e)=>{var s;var r;t??(t={}),t._zod.def=e,t._zod.bag=t._zod.bag||{},t._zod.version=VN;const n=[...t._zod.def.checks??[]];t._zod.traits.has("$ZodCheck")&&n.unshift(t);for(const i of n)for(const a of i._zod.onattach)a(t);if(n.length===0)(r=t._zod).deferred??(r.deferred=[]),(s=t._zod.deferred)==null||s.push(()=>{t._zod.run=t._zod.parse});else{const i=(a,o,c)=>{let l=bo(a),u;for(const d of o){if(d._zod.def.when){if(!d._zod.def.when(a))continue}else if(l)continue;const h=a.issues.length,f=d._zod.check(a);if(f instanceof Promise&&(c==null?void 0:c.async)===!1)throw new Uo;if(u||f instanceof Promise)u=(u??Promise.resolve()).then(async()=>{await f,a.issues.length!==h&&(l||(l=bo(a,h)))});else{if(a.issues.length===h)continue;l||(l=bo(a,h))}}return u?u.then(()=>a):a};t._zod.run=(a,o)=>{const c=t._zod.parse(a,o);if(c instanceof Promise){if(o.async===!1)throw new Uo;return c.then(l=>i(l,n,o))}return i(c,n,o)}}t["~standard"]={validate:i=>{var a;try{const o=DN(t,i);return o.success?{value:o.data}:{issues:(a=o.error)==null?void 0:a.issues}}catch{return UN(t,i).then(c=>{var l;return c.success?{value:c.data}:{issues:(l=c.error)==null?void 0:l.issues}})}},vendor:"zod",version:1}}),qN=Le("$ZodAny",(t,e)=>{rr.init(t,e),t._zod.parse=r=>r}),HN=Le("$ZodUnknown",(t,e)=>{rr.init(t,e),t._zod.parse=r=>r}),GN=Le("$ZodNever",(t,e)=>{rr.init(t,e),t._zod.parse=(r,n)=>(r.issues.push({expected:"never",code:"invalid_type",input:r.value,inst:t}),r)});function Mw(t,e,r){t.issues.length&&e.issues.push(...$N(r,t.issues)),e.value[r]=t.value}const WN=Le("$ZodArray",(t,e)=>{rr.init(t,e),t._zod.parse=(r,n)=>{const s=r.value;if(!Array.isArray(s))return r.issues.push({expected:"array",code:"invalid_type",input:s,inst:t}),r;r.value=Array(s.length);const i=[];for(let a=0;a<s.length;a++){const o=s[a],c=e.element._zod.run({value:o,issues:[]},n);c instanceof Promise?i.push(c.then(l=>Mw(l,r,a))):Mw(c,r,a)}return i.length?Promise.all(i).then(()=>r):r}});function Dw(t,e,r,n){for(const s of t)if(s.issues.length===0)return e.value=s.value,e;return e.issues.push({code:"invalid_union",input:e.value,inst:r,errors:t.map(s=>s.issues.map(i=>Ii(i,n,ki())))}),e}const JN=Le("$ZodUnion",(t,e)=>{rr.init(t,e),yt(t._zod,"optin",()=>e.options.some(r=>r._zod.optin==="optional")?"optional":void 0),yt(t._zod,"optout",()=>e.options.some(r=>r._zod.optout==="optional")?"optional":void 0),yt(t._zod,"values",()=>{if(e.options.every(r=>r._zod.values))return new Set(e.options.flatMap(r=>Array.from(r._zod.values)))}),yt(t._zod,"pattern",()=>{if(e.options.every(r=>r._zod.pattern)){const r=e.options.map(n=>n._zod.pattern);return new RegExp(`^(${r.map(n=>lg(n.source)).join("|")})$`)}}),t._zod.parse=(r,n)=>{let s=!1;const i=[];for(const a of e.options){const o=a._zod.run({value:r.value,issues:[]},n);if(o instanceof Promise)i.push(o),s=!0;else{if(o.issues.length===0)return o;i.push(o)}}return s?Promise.all(i).then(a=>Dw(a,r,t,n)):Dw(i,r,t,n)}}),ZN=Le("$ZodIntersection",(t,e)=>{rr.init(t,e),t._zod.parse=(r,n)=>{const s=r.value,i=e.left._zod.run({value:s,issues:[]},n),a=e.right._zod.run({value:s,issues:[]},n);return i instanceof Promise||a instanceof Promise?Promise.all([i,a]).then(([c,l])=>Uw(r,c,l)):Uw(r,i,a)}});function vp(t,e){if(t===e)return{valid:!0,data:t};if(t instanceof Date&&e instanceof Date&&+t==+e)return{valid:!0,data:t};if(bp(t)&&bp(e)){const r=Object.keys(e),n=Object.keys(t).filter(i=>r.indexOf(i)!==-1),s={...t,...e};for(const i of n){const a=vp(t[i],e[i]);if(!a.valid)return{valid:!1,mergeErrorPath:[i,...a.mergeErrorPath]};s[i]=a.data}return{valid:!0,data:s}}if(Array.isArray(t)&&Array.isArray(e)){if(t.length!==e.length)return{valid:!1,mergeErrorPath:[]};const r=[];for(let n=0;n<t.length;n++){const s=t[n],i=e[n],a=vp(s,i);if(!a.valid)return{valid:!1,mergeErrorPath:[n,...a.mergeErrorPath]};r.push(a.data)}return{valid:!0,data:r}}return{valid:!1,mergeErrorPath:[]}}function Uw(t,e,r){if(e.issues.length&&t.issues.push(...e.issues),r.issues.length&&t.issues.push(...r.issues),bo(t))return t;const n=vp(e.value,r.value);if(!n.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(n.mergeErrorPath)}`);return t.value=n.data,t}const KN=Le("$ZodTransform",(t,e)=>{rr.init(t,e),t._zod.parse=(r,n)=>{const s=e.transform(r.value,r);if(n.async)return(s instanceof Promise?s:Promise.resolve(s)).then(a=>(r.value=a,r));if(s instanceof Promise)throw new Uo;return r.value=s,r}}),dg=Le("$ZodOptional",(t,e)=>{rr.init(t,e),t._zod.optin="optional",t._zod.optout="optional",yt(t._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,void 0]):void 0),yt(t._zod,"pattern",()=>{const r=e.innerType._zod.pattern;return r?new RegExp(`^(${lg(r.source)})?$`):void 0}),t._zod.parse=(r,n)=>e.innerType._zod.optin==="optional"?e.innerType._zod.run(r,n):r.value===void 0?r:e.innerType._zod.run(r,n)}),XN=Le("$ZodNullable",(t,e)=>{rr.init(t,e),yt(t._zod,"optin",()=>e.innerType._zod.optin),yt(t._zod,"optout",()=>e.innerType._zod.optout),yt(t._zod,"pattern",()=>{const r=e.innerType._zod.pattern;return r?new RegExp(`^(${lg(r.source)}|null)$`):void 0}),yt(t._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,null]):void 0),t._zod.parse=(r,n)=>r.value===null?r:e.innerType._zod.run(r,n)}),YN=Le("$ZodDefault",(t,e)=>{rr.init(t,e),t._zod.optin="optional",yt(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(r,n)=>{if(r.value===void 0)return r.value=e.defaultValue,r;const s=e.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>Bw(i,e)):Bw(s,e)}});function Bw(t,e){return t.value===void 0&&(t.value=e.defaultValue),t}const QN=Le("$ZodPrefault",(t,e)=>{rr.init(t,e),t._zod.optin="optional",yt(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(r,n)=>(r.value===void 0&&(r.value=e.defaultValue),e.innerType._zod.run(r,n))}),eP=Le("$ZodNonOptional",(t,e)=>{rr.init(t,e),yt(t._zod,"values",()=>{const r=e.innerType._zod.values;return r?new Set([...r].filter(n=>n!==void 0)):void 0}),t._zod.parse=(r,n)=>{const s=e.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>jw(i,t)):jw(s,t)}});function jw(t,e){return!t.issues.length&&t.value===void 0&&t.issues.push({code:"invalid_type",expected:"nonoptional",input:t.value,inst:e}),t}const tP=Le("$ZodCatch",(t,e)=>{rr.init(t,e),t._zod.optin="optional",yt(t._zod,"optout",()=>e.innerType._zod.optout),yt(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(r,n)=>{const s=e.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>(r.value=i.value,i.issues.length&&(r.value=e.catchValue({...r,error:{issues:i.issues.map(a=>Ii(a,n,ki()))},input:r.value}),r.issues=[]),r)):(r.value=s.value,s.issues.length&&(r.value=e.catchValue({...r,error:{issues:s.issues.map(i=>Ii(i,n,ki()))},input:r.value}),r.issues=[]),r)}}),rP=Le("$ZodPipe",(t,e)=>{rr.init(t,e),yt(t._zod,"values",()=>e.in._zod.values),yt(t._zod,"optin",()=>e.in._zod.optin),yt(t._zod,"optout",()=>e.out._zod.optout),t._zod.parse=(r,n)=>{const s=e.in._zod.run(r,n);return s instanceof Promise?s.then(i=>Fw(i,e,n)):Fw(s,e,n)}});function Fw(t,e,r){return bo(t)?t:e.out._zod.run({value:t.value,issues:t.issues},r)}const nP=Le("$ZodReadonly",(t,e)=>{rr.init(t,e),yt(t._zod,"propValues",()=>e.innerType._zod.propValues),yt(t._zod,"values",()=>e.innerType._zod.values),yt(t._zod,"optin",()=>e.innerType._zod.optin),yt(t._zod,"optout",()=>e.innerType._zod.optout),t._zod.parse=(r,n)=>{const s=e.innerType._zod.run(r,n);return s instanceof Promise?s.then(zw):zw(s)}});function zw(t){return t.value=Object.freeze(t.value),t}const sP=Le("$ZodCustom",(t,e)=>{Da.init(t,e),rr.init(t,e),t._zod.parse=(r,n)=>r,t._zod.check=r=>{const n=r.value,s=e.fn(n);if(s instanceof Promise)return s.then(i=>Vw(i,r,n,t));Vw(s,r,n,t)}});function Vw(t,e,r,n){if(!t){const s={code:"custom",input:r,inst:n,path:[...n._zod.def.path??[]],continue:!n._zod.def.abort};n._zod.def.params&&(s.params=n._zod.def.params),e.issues.push(Bo(s))}}class xS{constructor(){this._map=new Map,this._idmap=new Map}add(e,...r){const n=r[0];if(this._map.set(e,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const r=this._map.get(e);return r&&typeof r=="object"&&"id"in r&&this._idmap.delete(r.id),this._map.delete(e),this}get(e){const r=e._zod.parent;if(r){const n={...this.get(r)??{}};return delete n.id,{...n,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function iP(){return new xS}const Ut=iP();function aP(t){return new t({type:"any"})}function oP(t){return new t({type:"unknown"})}function cP(t,e){return new t({type:"never",...Qs(e)})}function lP(t,e){return new BN({check:"max_length",...Qs(e),maximum:t})}function qw(t,e){return new jN({check:"min_length",...Qs(e),minimum:t})}function uP(t,e){return new FN({check:"length_equals",...Qs(e),length:t})}function dP(t){return new zN({check:"overwrite",tx:t})}function hP(t,e,r){return new t({type:"array",element:e,...Qs(r)})}function fP(t,e,r){return new t({type:"custom",check:"custom",fn:e,...Qs(r)})}class Hw{constructor(e){this.counter=0,this.metadataRegistry=(e==null?void 0:e.metadata)??Ut,this.target=(e==null?void 0:e.target)??"draft-2020-12",this.unrepresentable=(e==null?void 0:e.unrepresentable)??"throw",this.override=(e==null?void 0:e.override)??(()=>{}),this.io=(e==null?void 0:e.io)??"output",this.seen=new Map}process(e,r={path:[],schemaPath:[]}){var d,h,f;var n;const s=e._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},a=this.seen.get(e);if(a)return a.count++,r.schemaPath.includes(e)&&(a.cycle=r.path),a.schema;const o={schema:{},count:1,cycle:void 0,path:r.path};this.seen.set(e,o);const c=(h=(d=e._zod).toJSONSchema)==null?void 0:h.call(d);if(c)o.schema=c;else{const m={...r,schemaPath:[...r.schemaPath,e],path:r.path},g=e._zod.parent;if(g)o.ref=g,this.process(g,m),this.seen.get(g).isParent=!0;else{const y=o.schema;switch(s.type){case"string":{const b=y;b.type="string";const{minimum:_,maximum:E,format:C,patterns:k,contentEncoding:R}=e._zod.bag;if(typeof _=="number"&&(b.minLength=_),typeof E=="number"&&(b.maxLength=E),C&&(b.format=i[C]??C,b.format===""&&delete b.format),R&&(b.contentEncoding=R),k&&k.size>0){const $=[...k];$.length===1?b.pattern=$[0].source:$.length>1&&(o.schema.allOf=[...$.map(S=>({...this.target==="draft-7"?{type:"string"}:{},pattern:S.source}))])}break}case"number":{const b=y,{minimum:_,maximum:E,format:C,multipleOf:k,exclusiveMaximum:R,exclusiveMinimum:$}=e._zod.bag;typeof C=="string"&&C.includes("int")?b.type="integer":b.type="number",typeof $=="number"&&(b.exclusiveMinimum=$),typeof _=="number"&&(b.minimum=_,typeof $=="number"&&($>=_?delete b.minimum:delete b.exclusiveMinimum)),typeof R=="number"&&(b.exclusiveMaximum=R),typeof E=="number"&&(b.maximum=E,typeof R=="number"&&(R<=E?delete b.maximum:delete b.exclusiveMaximum)),typeof k=="number"&&(b.multipleOf=k);break}case"boolean":{const b=y;b.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{y.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{y.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const b=y,{minimum:_,maximum:E}=e._zod.bag;typeof _=="number"&&(b.minItems=_),typeof E=="number"&&(b.maxItems=E),b.type="array",b.items=this.process(s.element,{...m,path:[...m.path,"items"]});break}case"object":{const b=y;b.type="object",b.properties={};const _=s.shape;for(const k in _)b.properties[k]=this.process(_[k],{...m,path:[...m.path,"properties",k]});const E=new Set(Object.keys(_)),C=new Set([...E].filter(k=>{const R=s.shape[k]._zod;return this.io==="input"?R.optin===void 0:R.optout===void 0}));C.size>0&&(b.required=Array.from(C)),((f=s.catchall)==null?void 0:f._zod.def.type)==="never"?b.additionalProperties=!1:s.catchall?s.catchall&&(b.additionalProperties=this.process(s.catchall,{...m,path:[...m.path,"additionalProperties"]})):this.io==="output"&&(b.additionalProperties=!1);break}case"union":{const b=y;b.anyOf=s.options.map((_,E)=>this.process(_,{...m,path:[...m.path,"anyOf",E]}));break}case"intersection":{const b=y,_=this.process(s.left,{...m,path:[...m.path,"allOf",0]}),E=this.process(s.right,{...m,path:[...m.path,"allOf",1]}),C=R=>"allOf"in R&&Object.keys(R).length===1,k=[...C(_)?_.allOf:[_],...C(E)?E.allOf:[E]];b.allOf=k;break}case"tuple":{const b=y;b.type="array";const _=s.items.map((k,R)=>this.process(k,{...m,path:[...m.path,"prefixItems",R]}));if(this.target==="draft-2020-12"?b.prefixItems=_:b.items=_,s.rest){const k=this.process(s.rest,{...m,path:[...m.path,"items"]});this.target==="draft-2020-12"?b.items=k:b.additionalItems=k}s.rest&&(b.items=this.process(s.rest,{...m,path:[...m.path,"items"]}));const{minimum:E,maximum:C}=e._zod.bag;typeof E=="number"&&(b.minItems=E),typeof C=="number"&&(b.maxItems=C);break}case"record":{const b=y;b.type="object",b.propertyNames=this.process(s.keyType,{...m,path:[...m.path,"propertyNames"]}),b.additionalProperties=this.process(s.valueType,{...m,path:[...m.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const b=y,_=CN(s.entries);_.every(E=>typeof E=="number")&&(b.type="number"),_.every(E=>typeof E=="string")&&(b.type="string"),b.enum=_;break}case"literal":{const b=y,_=[];for(const E of s.values)if(E===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof E=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");_.push(Number(E))}else _.push(E);if(_.length!==0)if(_.length===1){const E=_[0];b.type=E===null?"null":typeof E,b.const=E}else _.every(E=>typeof E=="number")&&(b.type="number"),_.every(E=>typeof E=="string")&&(b.type="string"),_.every(E=>typeof E=="boolean")&&(b.type="string"),_.every(E=>E===null)&&(b.type="null"),b.enum=_;break}case"file":{const b=y,_={type:"string",format:"binary",contentEncoding:"binary"},{minimum:E,maximum:C,mime:k}=e._zod.bag;E!==void 0&&(_.minLength=E),C!==void 0&&(_.maxLength=C),k?k.length===1?(_.contentMediaType=k[0],Object.assign(b,_)):b.anyOf=k.map(R=>({..._,contentMediaType:R})):Object.assign(b,_);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const b=this.process(s.innerType,m);y.anyOf=[b,{type:"null"}];break}case"nonoptional":{this.process(s.innerType,m),o.ref=s.innerType;break}case"success":{const b=y;b.type="boolean";break}case"default":{this.process(s.innerType,m),o.ref=s.innerType,y.default=JSON.parse(JSON.stringify(s.defaultValue));break}case"prefault":{this.process(s.innerType,m),o.ref=s.innerType,this.io==="input"&&(y._prefault=JSON.parse(JSON.stringify(s.defaultValue)));break}case"catch":{this.process(s.innerType,m),o.ref=s.innerType;let b;try{b=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}y.default=b;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const b=y,_=e._zod.pattern;if(!_)throw new Error("Pattern not found in template literal");b.type="string",b.pattern=_.source;break}case"pipe":{const b=this.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;this.process(b,m),o.ref=b;break}case"readonly":{this.process(s.innerType,m),o.ref=s.innerType,y.readOnly=!0;break}case"promise":{this.process(s.innerType,m),o.ref=s.innerType;break}case"optional":{this.process(s.innerType,m),o.ref=s.innerType;break}case"lazy":{const b=e._zod.innerType;this.process(b,m),o.ref=b;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}}}}const l=this.metadataRegistry.get(e);return l&&Object.assign(o.schema,l),this.io==="input"&&Ot(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((n=o.schema).default??(n.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,r){var u,d,h,f,m,g;const n={cycles:(r==null?void 0:r.cycles)??"ref",reused:(r==null?void 0:r.reused)??"inline",external:(r==null?void 0:r.external)??void 0},s=this.seen.get(e);if(!s)throw new Error("Unprocessed schema. This is a bug in Zod.");const i=y=>{var k;const b=this.target==="draft-2020-12"?"$defs":"definitions";if(n.external){const R=(k=n.external.registry.get(y[0]))==null?void 0:k.id,$=n.external.uri??(M=>M);if(R)return{ref:$(R)};const S=y[1].defId??y[1].schema.id??`schema${this.counter++}`;return y[1].defId=S,{defId:S,ref:`${$("__shared")}#/${b}/${S}`}}if(y[1]===s)return{ref:"#"};const E=`#/${b}/`,C=y[1].schema.id??`__schema${this.counter++}`;return{defId:C,ref:E+C}},a=y=>{if(y[1].schema.$ref)return;const b=y[1],{ref:_,defId:E}=i(y);b.def={...b.schema},E&&(b.defId=E);const C=b.schema;for(const k in C)delete C[k];C.$ref=_};if(n.cycles==="throw")for(const y of this.seen.entries()){const b=y[1];if(b.cycle)throw new Error(`Cycle detected: #/${(u=b.cycle)==null?void 0:u.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const y of this.seen.entries()){const b=y[1];if(e===y[0]){a(y);continue}if(n.external){const E=(d=n.external.registry.get(y[0]))==null?void 0:d.id;if(e!==y[0]&&E){a(y);continue}}if((h=this.metadataRegistry.get(y[0]))==null?void 0:h.id){a(y);continue}if(b.cycle){a(y);continue}if(b.count>1&&n.reused==="ref"){a(y);continue}}const o=(y,b)=>{const _=this.seen.get(y),E=_.def??_.schema,C={...E};if(_.ref===null)return;const k=_.ref;if(_.ref=null,k){o(k,b);const R=this.seen.get(k).schema;R.$ref&&b.target==="draft-7"?(E.allOf=E.allOf??[],E.allOf.push(R)):(Object.assign(E,R),Object.assign(E,C))}_.isParent||this.override({zodSchema:y,jsonSchema:E,path:_.path??[]})};for(const y of[...this.seen.entries()].reverse())o(y[0],{target:this.target});const c={};if(this.target==="draft-2020-12"?c.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?c.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),(f=n.external)!=null&&f.uri){const y=(m=n.external.registry.get(e))==null?void 0:m.id;if(!y)throw new Error("Schema is missing an `id` property");c.$id=n.external.uri(y)}Object.assign(c,s.def);const l=((g=n.external)==null?void 0:g.defs)??{};for(const y of this.seen.entries()){const b=y[1];b.def&&b.defId&&(l[b.defId]=b.def)}n.external||Object.keys(l).length>0&&(this.target==="draft-2020-12"?c.$defs=l:c.definitions=l);try{return JSON.parse(JSON.stringify(c))}catch{throw new Error("Error converting schema to JSON.")}}}function ru(t,e){if(t instanceof xS){const n=new Hw(e),s={};for(const o of t._idmap.entries()){const[c,l]=o;n.process(l)}const i={},a={registry:t,uri:e==null?void 0:e.uri,defs:s};for(const o of t._idmap.entries()){const[c,l]=o;i[c]=n.emit(l,{...e,external:a})}if(Object.keys(s).length>0){const o=n.target==="draft-2020-12"?"$defs":"definitions";i.__shared={[o]:s}}return{schemas:i}}const r=new Hw(e);return r.process(t),r.emit(t,e)}function Ot(t,e){const r=e??{seen:new Set};if(r.seen.has(t))return!1;r.seen.add(t);const s=t._zod.def;switch(s.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return Ot(s.element,r);case"object":{for(const i in s.shape)if(Ot(s.shape[i],r))return!0;return!1}case"union":{for(const i of s.options)if(Ot(i,r))return!0;return!1}case"intersection":return Ot(s.left,r)||Ot(s.right,r);case"tuple":{for(const i of s.items)if(Ot(i,r))return!0;return!!(s.rest&&Ot(s.rest,r))}case"record":return Ot(s.keyType,r)||Ot(s.valueType,r);case"map":return Ot(s.keyType,r)||Ot(s.valueType,r);case"set":return Ot(s.valueType,r);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return Ot(s.innerType,r);case"lazy":return Ot(s.getter(),r);case"default":return Ot(s.innerType,r);case"prefault":return Ot(s.innerType,r);case"custom":return!1;case"transform":return!0;case"pipe":return Ot(s.in,r)||Ot(s.out,r);case"success":return!1;case"catch":return!1}throw new Error(`Unknown schema type: ${s.type}`)}function _t(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_zod"in e))return!1;const r=e._zod;return typeof r=="object"&&r!==null&&"def"in r}function bt(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_def"in e)||"_zod"in e)return!1;const r=e._def;return typeof r=="object"&&r!=null&&"typeName"in r}function pP(t){return _t(t)&&console.warn("[WARNING] Attempting to use Zod 4 schema in a context where Zod 3 schema is expected. This may cause unexpected behavior."),bt(t)}function tn(t){return!t||typeof t!="object"||Array.isArray(t)?!1:!!(_t(t)||bt(t))}function TS(t){return typeof t=="object"&&t!==null&&"_def"in t&&typeof t._def=="object"&&t._def!==null&&"typeName"in t._def&&t._def.typeName==="ZodLiteral"}function AS(t){return _t(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="literal":!1}function mP(t){return!!(TS(t)||AS(t))}async function CS(t,e){if(_t(t))try{return{success:!0,data:await vS(t,e)}}catch(r){return{success:!1,error:r}}if(bt(t))return await t.safeParseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function ld(t,e){if(_t(t))return await vS(t,e);if(bt(t))return await t.parseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function gP(t,e){if(_t(t))try{return{success:!0,data:cd(t,e)}}catch(r){return{success:!1,error:r}}if(bt(t))return t.safeParse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function bl(t,e){if(_t(t))return cd(t,e);if(bt(t))return t.parse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Ri(t){var e;if(_t(t))return(e=Ut.get(t))==null?void 0:e.description;if(bt(t)||"description"in t&&typeof t.description=="string")return t.description}function yP(t){if(!tn(t))return!1;if(bt(t)){const e=t._def;if(e.typeName==="ZodObject"){const r=t;return!r.shape||Object.keys(r.shape).length===0}if(e.typeName==="ZodRecord")return!0}if(_t(t)){const e=t._zod.def;if(e.type==="object"){const r=t;return!r.shape||Object.keys(r.shape).length===0}if(e.type==="record")return!0}return typeof t=="object"&&t!==null&&!("shape"in t)}function hg(t){return tn(t)?bt(t)?t._def.typeName==="ZodString":_t(t)?t._zod.def.type==="string":!1:!1}function fg(t){return typeof t=="object"&&t!==null&&"_def"in t&&typeof t._def=="object"&&t._def!==null&&"typeName"in t._def&&t._def.typeName==="ZodObject"}function Gn(t){return _t(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="object":!1}function ud(t){return _t(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="array":!1}function _n(t){return!!(fg(t)||Gn(t))}function jo(t){if(bt(t))return t.shape;if(_t(t))return t._zod.def.shape;throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function kS(t,e){if(bt(t))return t.extend(e);if(_t(t))return RN(t,e);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function pg(t){if(bt(t))return t.partial();if(_t(t))return ON(dg,t);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function nu(t,e=!1){if(bt(t))return t.strict();if(Gn(t)){const r=t._zod.def.shape;if(e)for(const[i,a]of Object.entries(t._zod.def.shape)){if(Gn(a)){const c=nu(a,e);r[i]=c}else if(ud(a)){let c=a._zod.def.element;Gn(c)&&(c=nu(c,e)),r[i]=Jn(a,{...a._zod.def,element:c})}else r[i]=a;const o=Ut.get(a);o&&Ut.add(r[i],o)}const n=Jn(t,{...t._zod.def,shape:r,catchall:cP(GN)}),s=Ut.get(t);return s&&Ut.add(n,s),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function Ep(t,e=!1){if(fg(t))return t.passthrough();if(Gn(t)){const r=t._zod.def.shape;if(e)for(const[i,a]of Object.entries(t._zod.def.shape)){if(Gn(a)){const c=Ep(a,e);r[i]=c}else if(ud(a)){let c=a._zod.def.element;Gn(c)&&(c=Ep(c,e)),r[i]=Jn(a,{...a._zod.def,element:c})}else r[i]=a;const o=Ut.get(a);o&&Ut.add(r[i],o)}const n=Jn(t,{...t._zod.def,shape:r,catchall:oP(HN)}),s=Ut.get(t);return s&&Ut.add(n,s),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function IS(t){if(bt(t))try{const e=t.parse(void 0);return()=>e}catch{return}if(_t(t))try{const e=cd(t,void 0);return()=>e}catch{return}}function _P(t){return bt(t)&&"typeName"in t._def&&t._def.typeName==="ZodEffects"}function wP(t){return _t(t)&&t._zod.def.type==="pipe"}function la(t,e=!1){if(bt(t))return _P(t)?la(t._def.schema,e):t;if(_t(t)){let r=t;if(wP(t)&&(r=la(t._zod.def.in,e)),e){if(Gn(r)){const s=r._zod.def.shape;for(const[i,a]of Object.entries(r._zod.def.shape))s[i]=la(a,e);r=Jn(r,{...r._zod.def,shape:s})}else if(ud(r)){const s=la(r._zod.def.element,e);r=Jn(r,{...r._zod.def,element:s})}}const n=Ut.get(t);return n&&Ut.add(r,n),r}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function bP(t,e){if(bt(t)){const r=jo(t),n={};for(const[s,i]of Object.entries(r))e(s,i)?n[s]=i.optional():n[s]=i;return t.extend(n)}if(_t(t)){const r=jo(t),n={...t._zod.def.shape};for(const[a,o]of Object.entries(r))e(a,o)&&(n[a]=new dg({type:"optional",innerType:o}));const s=Jn(t,{...t._zod.def,shape:n}),i=Ut.get(t);return i&&Ut.add(s,i),s}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}const vP=Symbol("Let zodToJsonSchema decide on which parser to use"),EP={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},SP=t=>({...EP,...t}),xP=t=>{const e=SP(t),r=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,flags:{hasReferencedOpenAiAnyType:!1},currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([n,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}},RS=(t,e)=>{let r=0;for(;r<t.length&&r<e.length&&t[r]===e[r];r++);return[(t.length-r).toString(),...e.slice(r)].join("/")};function Vr(t){if(t.target!=="openAi")return{};const e=[...t.basePath,t.definitionPath,t.openAiAnyTypeName];return t.flags.hasReferencedOpenAiAnyType=!0,{$ref:t.$refStrategy==="relative"?RS(e,t.currentPath):e.join("/")}}function OS(t,e,r,n){n!=null&&n.errorMessages&&r&&(t.errorMessage={...t.errorMessage,[e]:r})}function Ye(t,e,r,n,s){t[e]=r,OS(t,e,n,s)}var Ge;(function(t){t.assertEqual=s=>{};function e(s){}t.assertIs=e;function r(s){throw new Error}t.assertNever=r,t.arrayToEnum=s=>{const i={};for(const a of s)i[a]=a;return i},t.getValidEnumValues=s=>{const i=t.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),a={};for(const o of i)a[o]=s[o];return t.objectValues(a)},t.objectValues=s=>t.objectKeys(s).map(function(i){return s[i]}),t.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const i=[];for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&i.push(a);return i},t.find=(s,i)=>{for(const a of s)if(i(a))return a},t.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function n(s,i=" | "){return s.map(a=>typeof a=="string"?`'${a}'`:a).join(i)}t.joinValues=n,t.jsonStringifyReplacer=(s,i)=>typeof i=="bigint"?i.toString():i})(Ge||(Ge={}));var Gw;(function(t){t.mergeShapes=(e,r)=>({...e,...r})})(Gw||(Gw={}));const he=Ge.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Os=t=>{switch(typeof t){case"undefined":return he.undefined;case"string":return he.string;case"number":return Number.isNaN(t)?he.nan:he.number;case"boolean":return he.boolean;case"function":return he.function;case"bigint":return he.bigint;case"symbol":return he.symbol;case"object":return Array.isArray(t)?he.array:t===null?he.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?he.promise:typeof Map<"u"&&t instanceof Map?he.map:typeof Set<"u"&&t instanceof Set?he.set:typeof Date<"u"&&t instanceof Date?he.date:he.object;default:return he.unknown}},Z=Ge.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class ys extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const r=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,r):this.__proto__=r,this.name="ZodError",this.issues=e}format(e){const r=e||function(i){return i.message},n={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union")a.unionErrors.map(s);else if(a.code==="invalid_return_type")s(a.returnTypeError);else if(a.code==="invalid_arguments")s(a.argumentsError);else if(a.path.length===0)n._errors.push(r(a));else{let o=n,c=0;for(;c<a.path.length;){const l=a.path[c];c===a.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(r(a))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return s(this),n}static assert(e){if(!(e instanceof ys))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Ge.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=r=>r.message){const r={},n=[];for(const s of this.issues)if(s.path.length>0){const i=s.path[0];r[i]=r[i]||[],r[i].push(e(s))}else n.push(e(s));return{formErrors:n,fieldErrors:r}}get formErrors(){return this.flatten()}}ys.create=t=>new ys(t);const Sp=(t,e)=>{let r;switch(t.code){case Z.invalid_type:t.received===he.undefined?r="Required":r=`Expected ${t.expected}, received ${t.received}`;break;case Z.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(t.expected,Ge.jsonStringifyReplacer)}`;break;case Z.unrecognized_keys:r=`Unrecognized key(s) in object: ${Ge.joinValues(t.keys,", ")}`;break;case Z.invalid_union:r="Invalid input";break;case Z.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${Ge.joinValues(t.options)}`;break;case Z.invalid_enum_value:r=`Invalid enum value. Expected ${Ge.joinValues(t.options)}, received '${t.received}'`;break;case Z.invalid_arguments:r="Invalid function arguments";break;case Z.invalid_return_type:r="Invalid function return type";break;case Z.invalid_date:r="Invalid date";break;case Z.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(r=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(r=`${r} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?r=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?r=`Invalid input: must end with "${t.validation.endsWith}"`:Ge.assertNever(t.validation):t.validation!=="regex"?r=`Invalid ${t.validation}`:r="Invalid";break;case Z.too_small:t.type==="array"?r=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?r=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?r=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="bigint"?r=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?r=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:r="Invalid input";break;case Z.too_big:t.type==="array"?r=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?r=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?r=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?r=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?r=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:r="Invalid input";break;case Z.custom:r="Invalid input";break;case Z.invalid_intersection_types:r="Intersection results could not be merged";break;case Z.not_multiple_of:r=`Number must be a multiple of ${t.multipleOf}`;break;case Z.not_finite:r="Number must be finite";break;default:r=e.defaultError,Ge.assertNever(t)}return{message:r}};let TP=Sp;function AP(){return TP}const CP=t=>{const{data:e,path:r,errorMaps:n,issueData:s}=t,i=[...r,...s.path||[]],a={...s,path:i};if(s.message!==void 0)return{...s,path:i,message:s.message};let o="";const c=n.filter(l=>!!l).slice().reverse();for(const l of c)o=l(a,{data:e,defaultError:o}).message;return{...s,path:i,message:o}};function re(t,e){const r=AP(),n=CP({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,r,r===Sp?void 0:Sp].filter(s=>!!s)});t.common.issues.push(n)}class qr{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,r){const n=[];for(const s of r){if(s.status==="aborted")return Re;s.status==="dirty"&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,r){const n=[];for(const s of r){const i=await s.key,a=await s.value;n.push({key:i,value:a})}return qr.mergeObjectSync(e,n)}static mergeObjectSync(e,r){const n={};for(const s of r){const{key:i,value:a}=s;if(i.status==="aborted"||a.status==="aborted")return Re;i.status==="dirty"&&e.dirty(),a.status==="dirty"&&e.dirty(),i.value!=="__proto__"&&(typeof a.value<"u"||s.alwaysSet)&&(n[i.value]=a.value)}return{status:e.value,value:n}}}const Re=Object.freeze({status:"aborted"}),Qa=t=>({status:"dirty",value:t}),cn=t=>({status:"valid",value:t}),Ww=t=>t.status==="aborted",Jw=t=>t.status==="dirty",Ea=t=>t.status==="valid",su=t=>typeof Promise<"u"&&t instanceof Promise;var fe;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(fe||(fe={}));class Ws{constructor(e,r,n,s){this._cachedPath=[],this.parent=e,this.data=r,this._path=n,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Zw=(t,e)=>{if(Ea(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const r=new ys(t.common.issues);return this._error=r,this._error}}};function Ue(t){if(!t)return{};const{errorMap:e,invalid_type_error:r,required_error:n,description:s}=t;if(e&&(r||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(a,o)=>{const{message:c}=t;return a.code==="invalid_enum_value"?{message:c??o.defaultError}:typeof o.data>"u"?{message:c??n??o.defaultError}:a.code!=="invalid_type"?{message:o.defaultError}:{message:c??r??o.defaultError}},description:s}}let qe=class{get description(){return this._def.description}_getType(e){return Os(e.data)}_getOrReturnCtx(e,r){return r||{common:e.parent.common,data:e.data,parsedType:Os(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new qr,ctx:{common:e.parent.common,data:e.data,parsedType:Os(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const r=this._parse(e);if(su(r))throw new Error("Synchronous parse encountered promise.");return r}_parseAsync(e){const r=this._parse(e);return Promise.resolve(r)}parse(e,r){const n=this.safeParse(e,r);if(n.success)return n.data;throw n.error}safeParse(e,r){const n={common:{issues:[],async:(r==null?void 0:r.async)??!1,contextualErrorMap:r==null?void 0:r.errorMap},path:(r==null?void 0:r.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Os(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Zw(n,s)}"~validate"(e){var n,s;const r={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Os(e)};if(!this["~standard"].async)try{const i=this._parseSync({data:e,path:[],parent:r});return Ea(i)?{value:i.value}:{issues:r.common.issues}}catch(i){(s=(n=i==null?void 0:i.message)==null?void 0:n.toLowerCase())!=null&&s.includes("encountered")&&(this["~standard"].async=!0),r.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:r}).then(i=>Ea(i)?{value:i.value}:{issues:r.common.issues})}async parseAsync(e,r){const n=await this.safeParseAsync(e,r);if(n.success)return n.data;throw n.error}async safeParseAsync(e,r){const n={common:{issues:[],contextualErrorMap:r==null?void 0:r.errorMap,async:!0},path:(r==null?void 0:r.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Os(e)},s=this._parse({data:e,path:n.path,parent:n}),i=await(su(s)?s:Promise.resolve(s));return Zw(n,i)}refine(e,r){const n=s=>typeof r=="string"||typeof r>"u"?{message:r}:typeof r=="function"?r(s):r;return this._refinement((s,i)=>{const a=e(s),o=()=>i.addIssue({code:Z.custom,...n(s)});return typeof Promise<"u"&&a instanceof Promise?a.then(c=>c?!0:(o(),!1)):a?!0:(o(),!1)})}refinement(e,r){return this._refinement((n,s)=>e(n)?!0:(s.addIssue(typeof r=="function"?r(n,s):r),!1))}_refinement(e){return new Ta({schema:this,typeName:U.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:r=>this["~validate"](r)}}optional(){return Us.create(this,this._def)}nullable(){return Aa.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Sa.create(this)}promise(){return lu.create(this,this._def)}or(e){return ou.create([this,e],this._def)}and(e){return cu.create(this,e,this._def)}transform(e){return new Ta({...Ue(this._def),schema:this,typeName:U.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const r=typeof e=="function"?e:()=>e;return new Ap({...Ue(this._def),innerType:this,defaultValue:r,typeName:U.ZodDefault})}brand(){return new KP({typeName:U.ZodBranded,type:this,...Ue(this._def)})}catch(e){const r=typeof e=="function"?e:()=>e;return new Cp({...Ue(this._def),innerType:this,catchValue:r,typeName:U.ZodCatch})}describe(e){const r=this.constructor;return new r({...this._def,description:e})}pipe(e){return mg.create(this,e)}readonly(){return kp.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}};const kP=/^c[^\s-]{8,}$/i,IP=/^[0-9a-z]+$/,RP=/^[0-9A-HJKMNP-TV-Z]{26}$/i,OP=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,$P=/^[a-z0-9_-]{21}$/i,NP=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,PP=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,LP=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,MP="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let cf;const DP=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,UP=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,BP=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,jP=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,FP=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,zP=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,$S="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",VP=new RegExp(`^${$S}$`);function NS(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);const r=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${r}`}function qP(t){return new RegExp(`^${NS(t)}$`)}function HP(t){let e=`${$S}T${NS(t)}`;const r=[];return r.push(t.local?"Z?":"Z"),t.offset&&r.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${r.join("|")})`,new RegExp(`^${e}$`)}function GP(t,e){return!!((e==="v4"||!e)&&DP.test(t)||(e==="v6"||!e)&&BP.test(t))}function WP(t,e){if(!NP.test(t))return!1;try{const[r]=t.split(".");if(!r)return!1;const n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),s=JSON.parse(atob(n));return!(typeof s!="object"||s===null||"typ"in s&&(s==null?void 0:s.typ)!=="JWT"||!s.alg||e&&s.alg!==e)}catch{return!1}}function JP(t,e){return!!((e==="v4"||!e)&&UP.test(t)||(e==="v6"||!e)&&jP.test(t))}class Ls extends qe{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==he.string){const i=this._getOrReturnCtx(e);return re(i,{code:Z.invalid_type,expected:he.string,received:i.parsedType}),Re}const n=new qr;let s;for(const i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(s=this._getOrReturnCtx(e,s),re(s,{code:Z.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="max")e.data.length>i.value&&(s=this._getOrReturnCtx(e,s),re(s,{code:Z.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="length"){const a=e.data.length>i.value,o=e.data.length<i.value;(a||o)&&(s=this._getOrReturnCtx(e,s),a?re(s,{code:Z.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&re(s,{code:Z.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),n.dirty())}else if(i.kind==="email")LP.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"email",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="emoji")cf||(cf=new RegExp(MP,"u")),cf.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"emoji",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="uuid")OP.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"uuid",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="nanoid")$P.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"nanoid",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid")kP.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"cuid",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid2")IP.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"cuid2",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="ulid")RP.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"ulid",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),re(s,{validation:"url",code:Z.invalid_string,message:i.message}),n.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"regex",code:Z.invalid_string,message:i.message}),n.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(s=this._getOrReturnCtx(e,s),re(s,{code:Z.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),n.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(s=this._getOrReturnCtx(e,s),re(s,{code:Z.invalid_string,validation:{startsWith:i.value},message:i.message}),n.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(s=this._getOrReturnCtx(e,s),re(s,{code:Z.invalid_string,validation:{endsWith:i.value},message:i.message}),n.dirty()):i.kind==="datetime"?HP(i).test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{code:Z.invalid_string,validation:"datetime",message:i.message}),n.dirty()):i.kind==="date"?VP.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{code:Z.invalid_string,validation:"date",message:i.message}),n.dirty()):i.kind==="time"?qP(i).test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{code:Z.invalid_string,validation:"time",message:i.message}),n.dirty()):i.kind==="duration"?PP.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"duration",code:Z.invalid_string,message:i.message}),n.dirty()):i.kind==="ip"?GP(e.data,i.version)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"ip",code:Z.invalid_string,message:i.message}),n.dirty()):i.kind==="jwt"?WP(e.data,i.alg)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"jwt",code:Z.invalid_string,message:i.message}),n.dirty()):i.kind==="cidr"?JP(e.data,i.version)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"cidr",code:Z.invalid_string,message:i.message}),n.dirty()):i.kind==="base64"?FP.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"base64",code:Z.invalid_string,message:i.message}),n.dirty()):i.kind==="base64url"?zP.test(e.data)||(s=this._getOrReturnCtx(e,s),re(s,{validation:"base64url",code:Z.invalid_string,message:i.message}),n.dirty()):Ge.assertNever(i);return{status:n.value,value:e.data}}_regex(e,r,n){return this.refinement(s=>e.test(s),{validation:r,code:Z.invalid_string,...fe.errToObj(n)})}_addCheck(e){return new Ls({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...fe.errToObj(e)})}url(e){return this._addCheck({kind:"url",...fe.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...fe.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...fe.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...fe.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...fe.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...fe.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...fe.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...fe.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...fe.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...fe.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...fe.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...fe.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...fe.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...fe.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...fe.errToObj(e)})}regex(e,r){return this._addCheck({kind:"regex",regex:e,...fe.errToObj(r)})}includes(e,r){return this._addCheck({kind:"includes",value:e,position:r==null?void 0:r.position,...fe.errToObj(r==null?void 0:r.message)})}startsWith(e,r){return this._addCheck({kind:"startsWith",value:e,...fe.errToObj(r)})}endsWith(e,r){return this._addCheck({kind:"endsWith",value:e,...fe.errToObj(r)})}min(e,r){return this._addCheck({kind:"min",value:e,...fe.errToObj(r)})}max(e,r){return this._addCheck({kind:"max",value:e,...fe.errToObj(r)})}length(e,r){return this._addCheck({kind:"length",value:e,...fe.errToObj(r)})}nonempty(e){return this.min(1,fe.errToObj(e))}trim(){return new Ls({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Ls({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Ls({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxLength(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}}Ls.create=t=>new Ls({checks:[],typeName:U.ZodString,coerce:(t==null?void 0:t.coerce)??!1,...Ue(t)});function ZP(t,e){const r=(t.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,s=r>n?r:n,i=Number.parseInt(t.toFixed(s).replace(".","")),a=Number.parseInt(e.toFixed(s).replace(".",""));return i%a/10**s}class Fo extends qe{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==he.number){const i=this._getOrReturnCtx(e);return re(i,{code:Z.invalid_type,expected:he.number,received:i.parsedType}),Re}let n;const s=new qr;for(const i of this._def.checks)i.kind==="int"?Ge.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),re(n,{code:Z.invalid_type,expected:"integer",received:"float",message:i.message}),s.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),re(n,{code:Z.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),re(n,{code:Z.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="multipleOf"?ZP(e.data,i.value)!==0&&(n=this._getOrReturnCtx(e,n),re(n,{code:Z.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),re(n,{code:Z.not_finite,message:i.message}),s.dirty()):Ge.assertNever(i);return{status:s.value,value:e.data}}gte(e,r){return this.setLimit("min",e,!0,fe.toString(r))}gt(e,r){return this.setLimit("min",e,!1,fe.toString(r))}lte(e,r){return this.setLimit("max",e,!0,fe.toString(r))}lt(e,r){return this.setLimit("max",e,!1,fe.toString(r))}setLimit(e,r,n,s){return new Fo({...this._def,checks:[...this._def.checks,{kind:e,value:r,inclusive:n,message:fe.toString(s)}]})}_addCheck(e){return new Fo({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:fe.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:fe.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:fe.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:fe.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:fe.toString(e)})}multipleOf(e,r){return this._addCheck({kind:"multipleOf",value:e,message:fe.toString(r)})}finite(e){return this._addCheck({kind:"finite",message:fe.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:fe.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:fe.toString(e)})}get minValue(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxValue(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&Ge.isInteger(e.value))}get isFinite(){let e=null,r=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(r===null||n.value>r)&&(r=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(r)&&Number.isFinite(e)}}Fo.create=t=>new Fo({checks:[],typeName:U.ZodNumber,coerce:(t==null?void 0:t.coerce)||!1,...Ue(t)});class zo extends qe{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==he.bigint)return this._getInvalidInput(e);let n;const s=new qr;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),re(n,{code:Z.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),re(n,{code:Z.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),re(n,{code:Z.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):Ge.assertNever(i);return{status:s.value,value:e.data}}_getInvalidInput(e){const r=this._getOrReturnCtx(e);return re(r,{code:Z.invalid_type,expected:he.bigint,received:r.parsedType}),Re}gte(e,r){return this.setLimit("min",e,!0,fe.toString(r))}gt(e,r){return this.setLimit("min",e,!1,fe.toString(r))}lte(e,r){return this.setLimit("max",e,!0,fe.toString(r))}lt(e,r){return this.setLimit("max",e,!1,fe.toString(r))}setLimit(e,r,n,s){return new zo({...this._def,checks:[...this._def.checks,{kind:e,value:r,inclusive:n,message:fe.toString(s)}]})}_addCheck(e){return new zo({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:fe.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:fe.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:fe.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:fe.toString(e)})}multipleOf(e,r){return this._addCheck({kind:"multipleOf",value:e,message:fe.toString(r)})}get minValue(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxValue(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}}zo.create=t=>new zo({checks:[],typeName:U.ZodBigInt,coerce:(t==null?void 0:t.coerce)??!1,...Ue(t)});class xp extends qe{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==he.boolean){const n=this._getOrReturnCtx(e);return re(n,{code:Z.invalid_type,expected:he.boolean,received:n.parsedType}),Re}return cn(e.data)}}xp.create=t=>new xp({typeName:U.ZodBoolean,coerce:(t==null?void 0:t.coerce)||!1,...Ue(t)});class iu extends qe{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==he.date){const i=this._getOrReturnCtx(e);return re(i,{code:Z.invalid_type,expected:he.date,received:i.parsedType}),Re}if(Number.isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return re(i,{code:Z.invalid_date}),Re}const n=new qr;let s;for(const i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(s=this._getOrReturnCtx(e,s),re(s,{code:Z.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),n.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(s=this._getOrReturnCtx(e,s),re(s,{code:Z.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),n.dirty()):Ge.assertNever(i);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new iu({...this._def,checks:[...this._def.checks,e]})}min(e,r){return this._addCheck({kind:"min",value:e.getTime(),message:fe.toString(r)})}max(e,r){return this._addCheck({kind:"max",value:e.getTime(),message:fe.toString(r)})}get minDate(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e!=null?new Date(e):null}}iu.create=t=>new iu({checks:[],coerce:(t==null?void 0:t.coerce)||!1,typeName:U.ZodDate,...Ue(t)});class Kw extends qe{_parse(e){if(this._getType(e)!==he.symbol){const n=this._getOrReturnCtx(e);return re(n,{code:Z.invalid_type,expected:he.symbol,received:n.parsedType}),Re}return cn(e.data)}}Kw.create=t=>new Kw({typeName:U.ZodSymbol,...Ue(t)});class Xw extends qe{_parse(e){if(this._getType(e)!==he.undefined){const n=this._getOrReturnCtx(e);return re(n,{code:Z.invalid_type,expected:he.undefined,received:n.parsedType}),Re}return cn(e.data)}}Xw.create=t=>new Xw({typeName:U.ZodUndefined,...Ue(t)});class Yw extends qe{_parse(e){if(this._getType(e)!==he.null){const n=this._getOrReturnCtx(e);return re(n,{code:Z.invalid_type,expected:he.null,received:n.parsedType}),Re}return cn(e.data)}}Yw.create=t=>new Yw({typeName:U.ZodNull,...Ue(t)});let au=class extends qe{constructor(){super(...arguments),this._any=!0}_parse(e){return cn(e.data)}};au.create=t=>new au({typeName:U.ZodAny,...Ue(t)});class Qw extends qe{constructor(){super(...arguments),this._unknown=!0}_parse(e){return cn(e.data)}}Qw.create=t=>new Qw({typeName:U.ZodUnknown,...Ue(t)});class Js extends qe{_parse(e){const r=this._getOrReturnCtx(e);return re(r,{code:Z.invalid_type,expected:he.never,received:r.parsedType}),Re}}Js.create=t=>new Js({typeName:U.ZodNever,...Ue(t)});class eb extends qe{_parse(e){if(this._getType(e)!==he.undefined){const n=this._getOrReturnCtx(e);return re(n,{code:Z.invalid_type,expected:he.void,received:n.parsedType}),Re}return cn(e.data)}}eb.create=t=>new eb({typeName:U.ZodVoid,...Ue(t)});let Sa=class vl extends qe{_parse(e){const{ctx:r,status:n}=this._processInputParams(e),s=this._def;if(r.parsedType!==he.array)return re(r,{code:Z.invalid_type,expected:he.array,received:r.parsedType}),Re;if(s.exactLength!==null){const a=r.data.length>s.exactLength.value,o=r.data.length<s.exactLength.value;(a||o)&&(re(r,{code:a?Z.too_big:Z.too_small,minimum:o?s.exactLength.value:void 0,maximum:a?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(s.minLength!==null&&r.data.length<s.minLength.value&&(re(r,{code:Z.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),s.maxLength!==null&&r.data.length>s.maxLength.value&&(re(r,{code:Z.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),r.common.async)return Promise.all([...r.data].map((a,o)=>s.type._parseAsync(new Ws(r,a,r.path,o)))).then(a=>qr.mergeArray(n,a));const i=[...r.data].map((a,o)=>s.type._parseSync(new Ws(r,a,r.path,o)));return qr.mergeArray(n,i)}get element(){return this._def.type}min(e,r){return new vl({...this._def,minLength:{value:e,message:fe.toString(r)}})}max(e,r){return new vl({...this._def,maxLength:{value:e,message:fe.toString(r)}})}length(e,r){return new vl({...this._def,exactLength:{value:e,message:fe.toString(r)}})}nonempty(e){return this.min(1,e)}};Sa.create=(t,e)=>new Sa({type:t,minLength:null,maxLength:null,exactLength:null,typeName:U.ZodArray,...Ue(e)});function ta(t){if(t instanceof Et){const e={};for(const r in t.shape){const n=t.shape[r];e[r]=Us.create(ta(n))}return new Et({...t._def,shape:()=>e})}else return t instanceof Sa?new Sa({...t._def,type:ta(t.element)}):t instanceof Us?Us.create(ta(t.unwrap())):t instanceof Aa?Aa.create(ta(t.unwrap())):t instanceof Oi?Oi.create(t.items.map(e=>ta(e))):t}class Et extends qe{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),r=Ge.objectKeys(e);return this._cached={shape:e,keys:r},this._cached}_parse(e){if(this._getType(e)!==he.object){const l=this._getOrReturnCtx(e);return re(l,{code:Z.invalid_type,expected:he.object,received:l.parsedType}),Re}const{status:n,ctx:s}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof Js&&this._def.unknownKeys==="strip"))for(const l in s.data)a.includes(l)||o.push(l);const c=[];for(const l of a){const u=i[l],d=s.data[l];c.push({key:{status:"valid",value:l},value:u._parse(new Ws(s,d,s.path,l)),alwaysSet:l in s.data})}if(this._def.catchall instanceof Js){const l=this._def.unknownKeys;if(l==="passthrough")for(const u of o)c.push({key:{status:"valid",value:u},value:{status:"valid",value:s.data[u]}});else if(l==="strict")o.length>0&&(re(s,{code:Z.unrecognized_keys,keys:o}),n.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const l=this._def.catchall;for(const u of o){const d=s.data[u];c.push({key:{status:"valid",value:u},value:l._parse(new Ws(s,d,s.path,u)),alwaysSet:u in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const l=[];for(const u of c){const d=await u.key,h=await u.value;l.push({key:d,value:h,alwaysSet:u.alwaysSet})}return l}).then(l=>qr.mergeObjectSync(n,l)):qr.mergeObjectSync(n,c)}get shape(){return this._def.shape()}strict(e){return fe.errToObj,new Et({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(r,n)=>{var i,a;const s=((a=(i=this._def).errorMap)==null?void 0:a.call(i,r,n).message)??n.defaultError;return r.code==="unrecognized_keys"?{message:fe.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new Et({...this._def,unknownKeys:"strip"})}passthrough(){return new Et({...this._def,unknownKeys:"passthrough"})}extend(e){return new Et({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Et({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:U.ZodObject})}setKey(e,r){return this.augment({[e]:r})}catchall(e){return new Et({...this._def,catchall:e})}pick(e){const r={};for(const n of Ge.objectKeys(e))e[n]&&this.shape[n]&&(r[n]=this.shape[n]);return new Et({...this._def,shape:()=>r})}omit(e){const r={};for(const n of Ge.objectKeys(this.shape))e[n]||(r[n]=this.shape[n]);return new Et({...this._def,shape:()=>r})}deepPartial(){return ta(this)}partial(e){const r={};for(const n of Ge.objectKeys(this.shape)){const s=this.shape[n];e&&!e[n]?r[n]=s:r[n]=s.optional()}return new Et({...this._def,shape:()=>r})}required(e){const r={};for(const n of Ge.objectKeys(this.shape))if(e&&!e[n])r[n]=this.shape[n];else{let i=this.shape[n];for(;i instanceof Us;)i=i._def.innerType;r[n]=i}return new Et({...this._def,shape:()=>r})}keyof(){return PS(Ge.objectKeys(this.shape))}}Et.create=(t,e)=>new Et({shape:()=>t,unknownKeys:"strip",catchall:Js.create(),typeName:U.ZodObject,...Ue(e)});Et.strictCreate=(t,e)=>new Et({shape:()=>t,unknownKeys:"strict",catchall:Js.create(),typeName:U.ZodObject,...Ue(e)});Et.lazycreate=(t,e)=>new Et({shape:t,unknownKeys:"strip",catchall:Js.create(),typeName:U.ZodObject,...Ue(e)});let ou=class extends qe{_parse(e){const{ctx:r}=this._processInputParams(e),n=this._def.options;function s(i){for(const o of i)if(o.result.status==="valid")return o.result;for(const o of i)if(o.result.status==="dirty")return r.common.issues.push(...o.ctx.common.issues),o.result;const a=i.map(o=>new ys(o.ctx.common.issues));return re(r,{code:Z.invalid_union,unionErrors:a}),Re}if(r.common.async)return Promise.all(n.map(async i=>{const a={...r,common:{...r.common,issues:[]},parent:null};return{result:await i._parseAsync({data:r.data,path:r.path,parent:a}),ctx:a}})).then(s);{let i;const a=[];for(const c of n){const l={...r,common:{...r.common,issues:[]},parent:null},u=c._parseSync({data:r.data,path:r.path,parent:l});if(u.status==="valid")return u;u.status==="dirty"&&!i&&(i={result:u,ctx:l}),l.common.issues.length&&a.push(l.common.issues)}if(i)return r.common.issues.push(...i.ctx.common.issues),i.result;const o=a.map(c=>new ys(c));return re(r,{code:Z.invalid_union,unionErrors:o}),Re}}get options(){return this._def.options}};ou.create=(t,e)=>new ou({options:t,typeName:U.ZodUnion,...Ue(e)});function Tp(t,e){const r=Os(t),n=Os(e);if(t===e)return{valid:!0,data:t};if(r===he.object&&n===he.object){const s=Ge.objectKeys(e),i=Ge.objectKeys(t).filter(o=>s.indexOf(o)!==-1),a={...t,...e};for(const o of i){const c=Tp(t[o],e[o]);if(!c.valid)return{valid:!1};a[o]=c.data}return{valid:!0,data:a}}else if(r===he.array&&n===he.array){if(t.length!==e.length)return{valid:!1};const s=[];for(let i=0;i<t.length;i++){const a=t[i],o=e[i],c=Tp(a,o);if(!c.valid)return{valid:!1};s.push(c.data)}return{valid:!0,data:s}}else return r===he.date&&n===he.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}let cu=class extends qe{_parse(e){const{status:r,ctx:n}=this._processInputParams(e),s=(i,a)=>{if(Ww(i)||Ww(a))return Re;const o=Tp(i.value,a.value);return o.valid?((Jw(i)||Jw(a))&&r.dirty(),{status:r.value,value:o.data}):(re(n,{code:Z.invalid_intersection_types}),Re)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([i,a])=>s(i,a)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}};cu.create=(t,e,r)=>new cu({left:t,right:e,typeName:U.ZodIntersection,...Ue(r)});class Oi extends qe{_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==he.array)return re(n,{code:Z.invalid_type,expected:he.array,received:n.parsedType}),Re;if(n.data.length<this._def.items.length)return re(n,{code:Z.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Re;!this._def.rest&&n.data.length>this._def.items.length&&(re(n,{code:Z.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),r.dirty());const i=[...n.data].map((a,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new Ws(n,a,n.path,o)):null}).filter(a=>!!a);return n.common.async?Promise.all(i).then(a=>qr.mergeArray(r,a)):qr.mergeArray(r,i)}get items(){return this._def.items}rest(e){return new Oi({...this._def,rest:e})}}Oi.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Oi({items:t,typeName:U.ZodTuple,rest:null,...Ue(e)})};class tb extends qe{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==he.map)return re(n,{code:Z.invalid_type,expected:he.map,received:n.parsedType}),Re;const s=this._def.keyType,i=this._def.valueType,a=[...n.data.entries()].map(([o,c],l)=>({key:s._parse(new Ws(n,o,n.path,[l,"key"])),value:i._parse(new Ws(n,c,n.path,[l,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of a){const l=await c.key,u=await c.value;if(l.status==="aborted"||u.status==="aborted")return Re;(l.status==="dirty"||u.status==="dirty")&&r.dirty(),o.set(l.value,u.value)}return{status:r.value,value:o}})}else{const o=new Map;for(const c of a){const l=c.key,u=c.value;if(l.status==="aborted"||u.status==="aborted")return Re;(l.status==="dirty"||u.status==="dirty")&&r.dirty(),o.set(l.value,u.value)}return{status:r.value,value:o}}}}tb.create=(t,e,r)=>new tb({valueType:e,keyType:t,typeName:U.ZodMap,...Ue(r)});class Vo extends qe{_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==he.set)return re(n,{code:Z.invalid_type,expected:he.set,received:n.parsedType}),Re;const s=this._def;s.minSize!==null&&n.data.size<s.minSize.value&&(re(n,{code:Z.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),r.dirty()),s.maxSize!==null&&n.data.size>s.maxSize.value&&(re(n,{code:Z.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),r.dirty());const i=this._def.valueType;function a(c){const l=new Set;for(const u of c){if(u.status==="aborted")return Re;u.status==="dirty"&&r.dirty(),l.add(u.value)}return{status:r.value,value:l}}const o=[...n.data.values()].map((c,l)=>i._parse(new Ws(n,c,n.path,l)));return n.common.async?Promise.all(o).then(c=>a(c)):a(o)}min(e,r){return new Vo({...this._def,minSize:{value:e,message:fe.toString(r)}})}max(e,r){return new Vo({...this._def,maxSize:{value:e,message:fe.toString(r)}})}size(e,r){return this.min(e,r).max(e,r)}nonempty(e){return this.min(1,e)}}Vo.create=(t,e)=>new Vo({valueType:t,minSize:null,maxSize:null,typeName:U.ZodSet,...Ue(e)});class rb extends qe{get schema(){return this._def.getter()}_parse(e){const{ctx:r}=this._processInputParams(e);return this._def.getter()._parse({data:r.data,path:r.path,parent:r})}}rb.create=(t,e)=>new rb({getter:t,typeName:U.ZodLazy,...Ue(e)});class nb extends qe{_parse(e){if(e.data!==this._def.value){const r=this._getOrReturnCtx(e);return re(r,{received:r.data,code:Z.invalid_literal,expected:this._def.value}),Re}return{status:"valid",value:e.data}}get value(){return this._def.value}}nb.create=(t,e)=>new nb({value:t,typeName:U.ZodLiteral,...Ue(e)});function PS(t,e){return new xa({values:t,typeName:U.ZodEnum,...Ue(e)})}class xa extends qe{_parse(e){if(typeof e.data!="string"){const r=this._getOrReturnCtx(e),n=this._def.values;return re(r,{expected:Ge.joinValues(n),received:r.parsedType,code:Z.invalid_type}),Re}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const r=this._getOrReturnCtx(e),n=this._def.values;return re(r,{received:r.data,code:Z.invalid_enum_value,options:n}),Re}return cn(e.data)}get options(){return this._def.values}get enum(){const e={};for(const r of this._def.values)e[r]=r;return e}get Values(){const e={};for(const r of this._def.values)e[r]=r;return e}get Enum(){const e={};for(const r of this._def.values)e[r]=r;return e}extract(e,r=this._def){return xa.create(e,{...this._def,...r})}exclude(e,r=this._def){return xa.create(this.options.filter(n=>!e.includes(n)),{...this._def,...r})}}xa.create=PS;class sb extends qe{_parse(e){const r=Ge.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==he.string&&n.parsedType!==he.number){const s=Ge.objectValues(r);return re(n,{expected:Ge.joinValues(s),received:n.parsedType,code:Z.invalid_type}),Re}if(this._cache||(this._cache=new Set(Ge.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const s=Ge.objectValues(r);return re(n,{received:n.data,code:Z.invalid_enum_value,options:s}),Re}return cn(e.data)}get enum(){return this._def.values}}sb.create=(t,e)=>new sb({values:t,typeName:U.ZodNativeEnum,...Ue(e)});class lu extends qe{unwrap(){return this._def.type}_parse(e){const{ctx:r}=this._processInputParams(e);if(r.parsedType!==he.promise&&r.common.async===!1)return re(r,{code:Z.invalid_type,expected:he.promise,received:r.parsedType}),Re;const n=r.parsedType===he.promise?r.data:Promise.resolve(r.data);return cn(n.then(s=>this._def.type.parseAsync(s,{path:r.path,errorMap:r.common.contextualErrorMap})))}}lu.create=(t,e)=>new lu({type:t,typeName:U.ZodPromise,...Ue(e)});class Ta extends qe{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===U.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:r,ctx:n}=this._processInputParams(e),s=this._def.effect||null,i={addIssue:a=>{re(n,a),a.fatal?r.abort():r.dirty()},get path(){return n.path}};if(i.addIssue=i.addIssue.bind(i),s.type==="preprocess"){const a=s.transform(n.data,i);if(n.common.async)return Promise.resolve(a).then(async o=>{if(r.value==="aborted")return Re;const c=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return c.status==="aborted"?Re:c.status==="dirty"||r.value==="dirty"?Qa(c.value):c});{if(r.value==="aborted")return Re;const o=this._def.schema._parseSync({data:a,path:n.path,parent:n});return o.status==="aborted"?Re:o.status==="dirty"||r.value==="dirty"?Qa(o.value):o}}if(s.type==="refinement"){const a=o=>{const c=s.refinement(o,i);if(n.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?Re:(o.status==="dirty"&&r.dirty(),a(o.value),{status:r.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?Re:(o.status==="dirty"&&r.dirty(),a(o.value).then(()=>({status:r.value,value:o.value}))))}if(s.type==="transform")if(n.common.async===!1){const a=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Ea(a))return Re;const o=s.transform(a.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:r.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(a=>Ea(a)?Promise.resolve(s.transform(a.value,i)).then(o=>({status:r.value,value:o})):Re);Ge.assertNever(s)}}Ta.create=(t,e,r)=>new Ta({schema:t,typeName:U.ZodEffects,effect:e,...Ue(r)});Ta.createWithPreprocess=(t,e,r)=>new Ta({schema:e,effect:{type:"preprocess",transform:t},typeName:U.ZodEffects,...Ue(r)});let Us=class extends qe{_parse(e){return this._getType(e)===he.undefined?cn(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Us.create=(t,e)=>new Us({innerType:t,typeName:U.ZodOptional,...Ue(e)});let Aa=class extends qe{_parse(e){return this._getType(e)===he.null?cn(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Aa.create=(t,e)=>new Aa({innerType:t,typeName:U.ZodNullable,...Ue(e)});let Ap=class extends qe{_parse(e){const{ctx:r}=this._processInputParams(e);let n=r.data;return r.parsedType===he.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:r.path,parent:r})}removeDefault(){return this._def.innerType}};Ap.create=(t,e)=>new Ap({innerType:t,typeName:U.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...Ue(e)});let Cp=class extends qe{_parse(e){const{ctx:r}=this._processInputParams(e),n={...r,common:{...r.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return su(s)?s.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new ys(n.common.issues)},input:n.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new ys(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}};Cp.create=(t,e)=>new Cp({innerType:t,typeName:U.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...Ue(e)});class ib extends qe{_parse(e){if(this._getType(e)!==he.nan){const n=this._getOrReturnCtx(e);return re(n,{code:Z.invalid_type,expected:he.nan,received:n.parsedType}),Re}return{status:"valid",value:e.data}}}ib.create=t=>new ib({typeName:U.ZodNaN,...Ue(t)});class KP extends qe{_parse(e){const{ctx:r}=this._processInputParams(e),n=r.data;return this._def.type._parse({data:n,path:r.path,parent:r})}unwrap(){return this._def.type}}class mg extends qe{_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?Re:i.status==="dirty"?(r.dirty(),Qa(i.value)):this._def.out._parseAsync({data:i.value,path:n.path,parent:n})})();{const s=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return s.status==="aborted"?Re:s.status==="dirty"?(r.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:n.path,parent:n})}}static create(e,r){return new mg({in:e,out:r,typeName:U.ZodPipeline})}}let kp=class extends qe{_parse(e){const r=this._def.innerType._parse(e),n=s=>(Ea(s)&&(s.value=Object.freeze(s.value)),s);return su(r)?r.then(s=>n(s)):n(r)}unwrap(){return this._def.innerType}};kp.create=(t,e)=>new kp({innerType:t,typeName:U.ZodReadonly,...Ue(e)});function XP(t,e={},r){return au.create()}var U;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(U||(U={}));const it=Ls.create,gg=xp.create,ab=au.create;Js.create;const Bs=Sa.create,jt=Et.create;ou.create;cu.create;Oi.create;const Ip=xa.create;lu.create;Us.create;Aa.create;function YP(t,e){var n,s,i;const r={type:"array"};return(n=t.type)!=null&&n._def&&((i=(s=t.type)==null?void 0:s._def)==null?void 0:i.typeName)!==U.ZodAny&&(r.items=Ke(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&Ye(r,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&Ye(r,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(Ye(r,"minItems",t.exactLength.value,t.exactLength.message,e),Ye(r,"maxItems",t.exactLength.value,t.exactLength.message,e)),r}function QP(t,e){const r={type:"integer",format:"int64"};if(!t.checks)return r;for(const n of t.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?Ye(r,"minimum",n.value,n.message,e):Ye(r,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(r.exclusiveMinimum=!0),Ye(r,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?Ye(r,"maximum",n.value,n.message,e):Ye(r,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(r.exclusiveMaximum=!0),Ye(r,"maximum",n.value,n.message,e));break;case"multipleOf":Ye(r,"multipleOf",n.value,n.message,e);break}return r}function e2(){return{type:"boolean"}}function LS(t,e){return Ke(t.type._def,e)}const t2=(t,e)=>Ke(t.innerType._def,e);function MS(t,e,r){const n=r??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map(s=>MS(t,e,s))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return r2(t,e)}}const r2=(t,e)=>{const r={type:"integer",format:"unix-time"};if(e.target==="openApi3")return r;for(const n of t.checks)switch(n.kind){case"min":Ye(r,"minimum",n.value,n.message,e);break;case"max":Ye(r,"maximum",n.value,n.message,e);break}return r};function n2(t,e){return{...Ke(t.innerType._def,e),default:t.defaultValue()}}function s2(t,e){return e.effectStrategy==="input"?Ke(t.schema._def,e):Vr(e)}function i2(t){return{type:"string",enum:Array.from(t.values)}}const a2=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function o2(t,e){const r=[Ke(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),Ke(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return r.forEach(i=>{if(a2(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(n=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;a=c}else n=void 0;s.push(a)}}),s.length?{allOf:s,...n}:void 0}function c2(t,e){const r=typeof t.value;return r!=="bigint"&&r!=="number"&&r!=="boolean"&&r!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:r==="bigint"?"integer":r,enum:[t.value]}:{type:r==="bigint"?"integer":r,const:t.value}}let lf;const ln={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(lf===void 0&&(lf=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),lf),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function DS(t,e){const r={type:"string"};if(t.checks)for(const n of t.checks)switch(n.kind){case"min":Ye(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,e);break;case"max":Ye(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,e);break;case"email":switch(e.emailStrategy){case"format:email":un(r,"email",n.message,e);break;case"format:idn-email":un(r,"idn-email",n.message,e);break;case"pattern:zod":lr(r,ln.email,n.message,e);break}break;case"url":un(r,"uri",n.message,e);break;case"uuid":un(r,"uuid",n.message,e);break;case"regex":lr(r,n.regex,n.message,e);break;case"cuid":lr(r,ln.cuid,n.message,e);break;case"cuid2":lr(r,ln.cuid2,n.message,e);break;case"startsWith":lr(r,RegExp(`^${uf(n.value,e)}`),n.message,e);break;case"endsWith":lr(r,RegExp(`${uf(n.value,e)}$`),n.message,e);break;case"datetime":un(r,"date-time",n.message,e);break;case"date":un(r,"date",n.message,e);break;case"time":un(r,"time",n.message,e);break;case"duration":un(r,"duration",n.message,e);break;case"length":Ye(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,e),Ye(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,e);break;case"includes":lr(r,RegExp(uf(n.value,e)),n.message,e);break;case"ip":n.version!=="v6"&&un(r,"ipv4",n.message,e),n.version!=="v4"&&un(r,"ipv6",n.message,e);break;case"base64url":lr(r,ln.base64url,n.message,e);break;case"jwt":lr(r,ln.jwt,n.message,e);break;case"cidr":n.version!=="v6"&&lr(r,ln.ipv4Cidr,n.message,e),n.version!=="v4"&&lr(r,ln.ipv6Cidr,n.message,e);break;case"emoji":lr(r,ln.emoji(),n.message,e);break;case"ulid":lr(r,ln.ulid,n.message,e);break;case"base64":switch(e.base64Strategy){case"format:binary":un(r,"binary",n.message,e);break;case"contentEncoding:base64":Ye(r,"contentEncoding","base64",n.message,e);break;case"pattern:zod":lr(r,ln.base64,n.message,e);break}break;case"nanoid":lr(r,ln.nanoid,n.message,e);break}return r}function uf(t,e){return e.patternStrategy==="escape"?u2(t):t}const l2=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function u2(t){let e="";for(let r=0;r<t.length;r++)l2.has(t[r])||(e+="\\"),e+=t[r];return e}function un(t,e,r,n){var s;t.format||(s=t.anyOf)!=null&&s.some(i=>i.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&n.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...r&&n.errorMessages&&{errorMessage:{format:r}}})):Ye(t,"format",e,r,n)}function lr(t,e,r,n){var s;t.pattern||(s=t.allOf)!=null&&s.some(i=>i.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&n.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:ob(e,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):Ye(t,"pattern",ob(e,n),r,n)}function ob(t,e){var c;if(!e.applyRegexFlags||!t.flags)return t.source;const r={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},n=r.i?t.source.toLowerCase():t.source;let s="",i=!1,a=!1,o=!1;for(let l=0;l<n.length;l++){if(i){s+=n[l],i=!1;continue}if(r.i){if(a){if(n[l].match(/[a-z]/)){o?(s+=n[l],s+=`${n[l-2]}-${n[l]}`.toUpperCase(),o=!1):n[l+1]==="-"&&((c=n[l+2])!=null&&c.match(/[a-z]/))?(s+=n[l],o=!0):s+=`${n[l]}${n[l].toUpperCase()}`;continue}}else if(n[l].match(/[a-z]/)){s+=`[${n[l]}${n[l].toUpperCase()}]`;continue}}if(r.m){if(n[l]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(n[l]==="$"){s+=`($|(?=[\r
]))`;continue}}if(r.s&&n[l]==="."){s+=a?`${n[l]}\r
`:`[${n[l]}\r
]`;continue}s+=n[l],n[l]==="\\"?i=!0:a&&n[l]==="]"?a=!1:!a&&n[l]==="["&&(a=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s}function US(t,e){var n,s,i,a,o,c;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((n=t.keyType)==null?void 0:n._def.typeName)===U.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((l,u)=>({...l,[u]:Ke(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??Vr(e)}),{}),additionalProperties:e.rejectedAdditionalProperties};const r={type:"object",additionalProperties:Ke(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return r;if(((s=t.keyType)==null?void 0:s._def.typeName)===U.ZodString&&((i=t.keyType._def.checks)!=null&&i.length)){const{type:l,...u}=DS(t.keyType._def,e);return{...r,propertyNames:u}}else{if(((a=t.keyType)==null?void 0:a._def.typeName)===U.ZodEnum)return{...r,propertyNames:{enum:t.keyType._def.values}};if(((o=t.keyType)==null?void 0:o._def.typeName)===U.ZodBranded&&t.keyType._def.type._def.typeName===U.ZodString&&((c=t.keyType._def.type._def.checks)!=null&&c.length)){const{type:l,...u}=LS(t.keyType._def,e);return{...r,propertyNames:u}}}return r}function d2(t,e){if(e.mapStrategy==="record")return US(t,e);const r=Ke(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||Vr(e),n=Ke(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||Vr(e);return{type:"array",maxItems:125,items:{type:"array",items:[r,n],minItems:2,maxItems:2}}}function h2(t){const e=t.values,n=Object.keys(t.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(n.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:n}}function f2(t){return t.target==="openAi"?void 0:{not:Vr({...t,currentPath:[...t.currentPath,"not"]})}}function p2(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const uu={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function m2(t,e){if(e.target==="openApi3")return cb(t,e);const r=t.options instanceof Map?Array.from(t.options.values()):t.options;if(r.every(n=>n._def.typeName in uu&&(!n._def.checks||!n._def.checks.length))){const n=r.reduce((s,i)=>{const a=uu[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:n.length>1?n:n[0]}}else if(r.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=r.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":return i._def.value===null?[...s,"null"]:s;case"symbol":case"undefined":case"function":default:return s}},[]);if(n.length===r.length){const s=n.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:r.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(r.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:r.reduce((n,s)=>[...n,...s._def.values.filter(i=>!n.includes(i))],[])};return cb(t,e)}const cb=(t,e)=>{const r=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((n,s)=>Ke(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return r.length?{anyOf:r}:void 0};function g2(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"?{type:uu[t.innerType._def.typeName],nullable:!0}:{type:[uu[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=Ke(t.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const r=Ke(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}function y2(t,e){const r={type:"number"};if(!t.checks)return r;for(const n of t.checks)switch(n.kind){case"int":r.type="integer",OS(r,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?Ye(r,"minimum",n.value,n.message,e):Ye(r,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(r.exclusiveMinimum=!0),Ye(r,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?Ye(r,"maximum",n.value,n.message,e):Ye(r,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(r.exclusiveMaximum=!0),Ye(r,"maximum",n.value,n.message,e));break;case"multipleOf":Ye(r,"multipleOf",n.value,n.message,e);break}return r}function _2(t,e){const r=e.target==="openAi",n={type:"object",properties:{}},s=[],i=t.shape();for(const o in i){let c=i[o];if(c===void 0||c._def===void 0)continue;let l=b2(c);l&&r&&(c._def.typeName==="ZodOptional"&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),l=!1);const u=Ke(c._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});u!==void 0&&(n.properties[o]=u,l||s.push(o))}s.length&&(n.required=s);const a=w2(t,e);return a!==void 0&&(n.additionalProperties=a),n}function w2(t,e){if(t.catchall._def.typeName!=="ZodNever")return Ke(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(t.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function b2(t){try{return t.isOptional()}catch{return!0}}const v2=(t,e)=>{var n;if(e.currentPath.toString()===((n=e.propertyPath)==null?void 0:n.toString()))return Ke(t.innerType._def,e);const r=Ke(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return r?{anyOf:[{not:Vr(e)},r]}:Vr(e)},E2=(t,e)=>{if(e.pipeStrategy==="input")return Ke(t.in._def,e);if(e.pipeStrategy==="output")return Ke(t.out._def,e);const r=Ke(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=Ke(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",r?"1":"0"]});return{allOf:[r,n].filter(s=>s!==void 0)}};function S2(t,e){return Ke(t.type._def,e)}function x2(t,e){const n={type:"array",uniqueItems:!0,items:Ke(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&Ye(n,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&Ye(n,"maxItems",t.maxSize.value,t.maxSize.message,e),n}function T2(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((r,n)=>Ke(r._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[]),additionalItems:Ke(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((r,n)=>Ke(r._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[])}}function A2(t){return{not:Vr(t)}}function C2(t){return Vr(t)}const k2=(t,e)=>Ke(t.innerType._def,e),I2=(t,e,r)=>{switch(e){case U.ZodString:return DS(t,r);case U.ZodNumber:return y2(t,r);case U.ZodObject:return _2(t,r);case U.ZodBigInt:return QP(t,r);case U.ZodBoolean:return e2();case U.ZodDate:return MS(t,r);case U.ZodUndefined:return A2(r);case U.ZodNull:return p2(r);case U.ZodArray:return YP(t,r);case U.ZodUnion:case U.ZodDiscriminatedUnion:return m2(t,r);case U.ZodIntersection:return o2(t,r);case U.ZodTuple:return T2(t,r);case U.ZodRecord:return US(t,r);case U.ZodLiteral:return c2(t,r);case U.ZodEnum:return i2(t);case U.ZodNativeEnum:return h2(t);case U.ZodNullable:return g2(t,r);case U.ZodOptional:return v2(t,r);case U.ZodMap:return d2(t,r);case U.ZodSet:return x2(t,r);case U.ZodLazy:return()=>t.getter()._def;case U.ZodPromise:return S2(t,r);case U.ZodNaN:case U.ZodNever:return f2(r);case U.ZodEffects:return s2(t,r);case U.ZodAny:return Vr(r);case U.ZodUnknown:return C2(r);case U.ZodDefault:return n2(t,r);case U.ZodBranded:return LS(t,r);case U.ZodReadonly:return k2(t,r);case U.ZodCatch:return t2(t,r);case U.ZodPipeline:return E2(t,r);case U.ZodFunction:case U.ZodVoid:case U.ZodSymbol:return;default:return(n=>{})()}};function Ke(t,e,r=!1){var o;const n=e.seen.get(t);if(e.override){const c=(o=e.override)==null?void 0:o.call(e,t,e,n,r);if(c!==vP)return c}if(n&&!r){const c=R2(n,e);if(c!==void 0)return c}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const i=I2(t,t.typeName,e),a=typeof i=="function"?Ke(i(),e):i;if(a&&O2(t,e,a),e.postProcess){const c=e.postProcess(a,t,e);return s.jsonSchema=a,c}return s.jsonSchema=a,a}const R2=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"relative":return{$ref:RS(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((r,n)=>e.currentPath[n]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),Vr(e)):e.$refStrategy==="seen"?Vr(e):void 0}},O2=(t,e,r)=>(t.description&&(r.description=t.description,e.markdownDescription&&(r.markdownDescription=t.description)),r),$2=(t,e)=>{const r=xP(e);let n;const s=Ke(t._def,r,!1)??Vr(r);r.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[r.openAiAnyTypeName]||(n[r.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:r.$refStrategy==="relative"?"1":[...r.basePath,r.definitionPath,r.openAiAnyTypeName].join("/")}}));const i=n?{...s,[r.definitionPath]:n}:s;return r.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(r.target==="jsonSchema2019-09"||r.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),r.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function vi(t,e){const r=typeof t;if(r!==typeof e)return!1;if(Array.isArray(t)){if(!Array.isArray(e))return!1;const n=t.length;if(n!==e.length)return!1;for(let s=0;s<n;s++)if(!vi(t[s],e[s]))return!1;return!0}if(r==="object"){if(!t||!e)return t===e;const n=Object.keys(t),s=Object.keys(e);if(n.length!==s.length)return!1;for(const a of n)if(!vi(t[a],e[a]))return!1;return!0}return t===e}function pn(t){return encodeURI(N2(t))}function N2(t){return t.replace(/~/g,"~0").replace(/\//g,"~1")}const P2={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},L2={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},M2={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let D2=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function Ms(t,e=Object.create(null),r=D2,n=""){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t.$id||t.id;if(i){const a=new URL(i,r.href);a.hash.length>1?e[a.href]=t:(a.hash="",n===""?r=a:Ms(t,e,r))}}else if(t!==!0&&t!==!1)return e;const s=r.href+(n?"#"+n:"");if(e[s]!==void 0)throw new Error(`Duplicate schema URI "${s}".`);if(e[s]=t,t===!0||t===!1)return e;if(t.__absolute_uri__===void 0&&Object.defineProperty(t,"__absolute_uri__",{enumerable:!1,value:s}),t.$ref&&t.__absolute_ref__===void 0){const i=new URL(t.$ref,r.href);i.hash=i.hash,Object.defineProperty(t,"__absolute_ref__",{enumerable:!1,value:i.href})}if(t.$recursiveRef&&t.__absolute_recursive_ref__===void 0){const i=new URL(t.$recursiveRef,r.href);i.hash=i.hash,Object.defineProperty(t,"__absolute_recursive_ref__",{enumerable:!1,value:i.href})}if(t.$anchor){const i=new URL("#"+t.$anchor,r.href);e[i.href]=t}for(let i in t){if(M2[i])continue;const a=`${n}/${pn(i)}`,o=t[i];if(Array.isArray(o)){if(P2[i]){const c=o.length;for(let l=0;l<c;l++)Ms(o[l],e,r,`${a}/${l}`)}}else if(L2[i])for(let c in o)Ms(o[c],e,r,`${a}/${pn(c)}`);else Ms(o,e,r,a)}return e}const U2=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,B2=[0,31,28,31,30,31,30,31,31,30,31,30,31],j2=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,F2=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,z2=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,V2=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,q2=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,H2=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,G2=/^(?:\/(?:[^~/]|~0|~1)*)*$/,W2=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,J2=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,Z2=t=>{if(t[0]==='"')return!1;const[e,r,...n]=t.split("@");return!e||!r||n.length!==0||e.length>64||r.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(r)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:r.split(".").every(s=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(s))},K2=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,X2=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,Y2=t=>t.length>1&&t.length<80&&(/^P\d+([.,]\d+)?W$/.test(t)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(t)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(t));function In(t){return t.test.bind(t)}const lb={date:BS,time:jS.bind(void 0,!1),"date-time":tL,duration:Y2,uri:sL,"uri-reference":In(z2),"uri-template":In(V2),url:In(q2),email:Z2,hostname:In(F2),ipv4:In(K2),ipv6:In(X2),regex:aL,uuid:In(H2),"json-pointer":In(G2),"json-pointer-uri-fragment":In(W2),"relative-json-pointer":In(J2)};function Q2(t){return t%4===0&&(t%100!==0||t%400===0)}function BS(t){const e=t.match(U2);if(!e)return!1;const r=+e[1],n=+e[2],s=+e[3];return n>=1&&n<=12&&s>=1&&s<=(n==2&&Q2(r)?29:B2[n])}function jS(t,e){const r=e.match(j2);if(!r)return!1;const n=+r[1],s=+r[2],i=+r[3],a=!!r[5];return(n<=23&&s<=59&&i<=59||n==23&&s==59&&i==60)&&(!t||a)}const eL=/t|\s/i;function tL(t){const e=t.split(eL);return e.length==2&&BS(e[0])&&jS(!0,e[1])}const rL=/\/|:/,nL=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function sL(t){return rL.test(t)&&nL.test(t)}const iL=/[^\\]\\Z/;function aL(t){if(iL.test(t))return!1;try{return new RegExp(t,"u"),!0}catch{return!1}}function oL(t){let e=0,r=t.length,n=0,s;for(;n<r;)e++,s=t.charCodeAt(n++),s>=55296&&s<=56319&&n<r&&(s=t.charCodeAt(n),(s&64512)==56320&&n++);return e}function ct(t,e,r="2019-09",n=Ms(e),s=!0,i=null,a="#",o="#",c=Object.create(null)){if(e===!0)return{valid:!0,errors:[]};if(e===!1)return{valid:!1,errors:[{instanceLocation:a,keyword:"false",keywordLocation:a,error:"False boolean schema."}]};const l=typeof t;let u;switch(l){case"boolean":case"number":case"string":u=l;break;case"object":t===null?u="null":Array.isArray(t)?u="array":u="object";break;default:throw new Error(`Instances of "${l}" type are not supported.`)}const{$ref:d,$recursiveRef:h,$recursiveAnchor:f,type:m,const:g,enum:y,required:b,not:_,anyOf:E,allOf:C,oneOf:k,if:R,then:$,else:S,format:M,properties:B,patternProperties:q,additionalProperties:se,unevaluatedProperties:pe,minProperties:j,maxProperties:z,propertyNames:G,dependentRequired:ie,dependentSchemas:ce,dependencies:te,prefixItems:le,items:Ee,additionalItems:W,unevaluatedItems:X,contains:ae,minContains:V,maxContains:A,minItems:x,maxItems:D,uniqueItems:N,minimum:ke,maximum:$e,exclusiveMinimum:Je,exclusiveMaximum:at,multipleOf:ft,minLength:zt,maxLength:Xe,pattern:Lt,__absolute_ref__:Ss,__absolute_recursive_ref__:Vi}=e,Y=[];if(f===!0&&i===null&&(i=e),h==="#"){const xe=i===null?n[Vi]:i,me=`${o}/$recursiveRef`,Se=ct(t,i===null?e:i,r,n,s,xe,a,me,c);Se.valid||Y.push({instanceLocation:a,keyword:"$recursiveRef",keywordLocation:me,error:"A subschema had errors."},...Se.errors)}if(d!==void 0){const me=n[Ss||d];if(me===void 0){let K=`Unresolved $ref "${d}".`;throw Ss&&Ss!==d&&(K+=`  Absolute URI "${Ss}".`),K+=`
Known schemas:
- ${Object.keys(n).join(`
- `)}`,new Error(K)}const Se=`${o}/$ref`,Q=ct(t,me,r,n,s,i,a,Se,c);if(Q.valid||Y.push({instanceLocation:a,keyword:"$ref",keywordLocation:Se,error:"A subschema had errors."},...Q.errors),r==="4"||r==="7")return{valid:Y.length===0,errors:Y}}if(Array.isArray(m)){let xe=m.length,me=!1;for(let Se=0;Se<xe;Se++)if(u===m[Se]||m[Se]==="integer"&&u==="number"&&t%1===0&&t===t){me=!0;break}me||Y.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${m.join('", "')}".`})}else m==="integer"?(u!=="number"||t%1||t!==t)&&Y.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${m}".`}):m!==void 0&&u!==m&&Y.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${m}".`});if(g!==void 0&&(u==="object"||u==="array"?vi(t,g)||Y.push({instanceLocation:a,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(g)}.`}):t!==g&&Y.push({instanceLocation:a,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(g)}.`})),y!==void 0&&(u==="object"||u==="array"?y.some(xe=>vi(t,xe))||Y.push({instanceLocation:a,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(y)}.`}):y.some(xe=>t===xe)||Y.push({instanceLocation:a,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(y)}.`})),_!==void 0){const xe=`${o}/not`;ct(t,_,r,n,s,i,a,xe).valid&&Y.push({instanceLocation:a,keyword:"not",keywordLocation:xe,error:'Instance matched "not" schema.'})}let Yn=[];if(E!==void 0){const xe=`${o}/anyOf`,me=Y.length;let Se=!1;for(let Q=0;Q<E.length;Q++){const K=E[Q],Ae=Object.create(c),ye=ct(t,K,r,n,s,f===!0?i:null,a,`${xe}/${Q}`,Ae);Y.push(...ye.errors),Se=Se||ye.valid,ye.valid&&Yn.push(Ae)}Se?Y.length=me:Y.splice(me,0,{instanceLocation:a,keyword:"anyOf",keywordLocation:xe,error:"Instance does not match any subschemas."})}if(C!==void 0){const xe=`${o}/allOf`,me=Y.length;let Se=!0;for(let Q=0;Q<C.length;Q++){const K=C[Q],Ae=Object.create(c),ye=ct(t,K,r,n,s,f===!0?i:null,a,`${xe}/${Q}`,Ae);Y.push(...ye.errors),Se=Se&&ye.valid,ye.valid&&Yn.push(Ae)}Se?Y.length=me:Y.splice(me,0,{instanceLocation:a,keyword:"allOf",keywordLocation:xe,error:"Instance does not match every subschema."})}if(k!==void 0){const xe=`${o}/oneOf`,me=Y.length,Se=k.filter((Q,K)=>{const Ae=Object.create(c),ye=ct(t,Q,r,n,s,f===!0?i:null,a,`${xe}/${K}`,Ae);return Y.push(...ye.errors),ye.valid&&Yn.push(Ae),ye.valid}).length;Se===1?Y.length=me:Y.splice(me,0,{instanceLocation:a,keyword:"oneOf",keywordLocation:xe,error:`Instance does not match exactly one subschema (${Se} matches).`})}if((u==="object"||u==="array")&&Object.assign(c,...Yn),R!==void 0){const xe=`${o}/if`;if(ct(t,R,r,n,s,i,a,xe,c).valid){if($!==void 0){const Se=ct(t,$,r,n,s,i,a,`${o}/then`,c);Se.valid||Y.push({instanceLocation:a,keyword:"if",keywordLocation:xe,error:'Instance does not match "then" schema.'},...Se.errors)}}else if(S!==void 0){const Se=ct(t,S,r,n,s,i,a,`${o}/else`,c);Se.valid||Y.push({instanceLocation:a,keyword:"if",keywordLocation:xe,error:'Instance does not match "else" schema.'},...Se.errors)}}if(u==="object"){if(b!==void 0)for(const Q of b)Q in t||Y.push({instanceLocation:a,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${Q}".`});const xe=Object.keys(t);if(j!==void 0&&xe.length<j&&Y.push({instanceLocation:a,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${j} properties.`}),z!==void 0&&xe.length>z&&Y.push({instanceLocation:a,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${z} properties.`}),G!==void 0){const Q=`${o}/propertyNames`;for(const K in t){const Ae=`${a}/${pn(K)}`,ye=ct(K,G,r,n,s,i,Ae,Q);ye.valid||Y.push({instanceLocation:a,keyword:"propertyNames",keywordLocation:Q,error:`Property name "${K}" does not match schema.`},...ye.errors)}}if(ie!==void 0){const Q=`${o}/dependantRequired`;for(const K in ie)if(K in t){const Ae=ie[K];for(const ye of Ae)ye in t||Y.push({instanceLocation:a,keyword:"dependentRequired",keywordLocation:Q,error:`Instance has "${K}" but does not have "${ye}".`})}}if(ce!==void 0)for(const Q in ce){const K=`${o}/dependentSchemas`;if(Q in t){const Ae=ct(t,ce[Q],r,n,s,i,a,`${K}/${pn(Q)}`,c);Ae.valid||Y.push({instanceLocation:a,keyword:"dependentSchemas",keywordLocation:K,error:`Instance has "${Q}" but does not match dependant schema.`},...Ae.errors)}}if(te!==void 0){const Q=`${o}/dependencies`;for(const K in te)if(K in t){const Ae=te[K];if(Array.isArray(Ae))for(const ye of Ae)ye in t||Y.push({instanceLocation:a,keyword:"dependencies",keywordLocation:Q,error:`Instance has "${K}" but does not have "${ye}".`});else{const ye=ct(t,Ae,r,n,s,i,a,`${Q}/${pn(K)}`);ye.valid||Y.push({instanceLocation:a,keyword:"dependencies",keywordLocation:Q,error:`Instance has "${K}" but does not match dependant schema.`},...ye.errors)}}}const me=Object.create(null);let Se=!1;if(B!==void 0){const Q=`${o}/properties`;for(const K in B){if(!(K in t))continue;const Ae=`${a}/${pn(K)}`,ye=ct(t[K],B[K],r,n,s,i,Ae,`${Q}/${pn(K)}`);if(ye.valid)c[K]=me[K]=!0;else if(Se=s,Y.push({instanceLocation:a,keyword:"properties",keywordLocation:Q,error:`Property "${K}" does not match schema.`},...ye.errors),Se)break}}if(!Se&&q!==void 0){const Q=`${o}/patternProperties`;for(const K in q){const Ae=new RegExp(K,"u"),ye=q[K];for(const nr in t){if(!Ae.test(nr))continue;const T=`${a}/${pn(nr)}`,w=ct(t[nr],ye,r,n,s,i,T,`${Q}/${pn(K)}`);w.valid?c[nr]=me[nr]=!0:(Se=s,Y.push({instanceLocation:a,keyword:"patternProperties",keywordLocation:Q,error:`Property "${nr}" matches pattern "${K}" but does not match associated schema.`},...w.errors))}}}if(!Se&&se!==void 0){const Q=`${o}/additionalProperties`;for(const K in t){if(me[K])continue;const Ae=`${a}/${pn(K)}`,ye=ct(t[K],se,r,n,s,i,Ae,Q);ye.valid?c[K]=!0:(Se=s,Y.push({instanceLocation:a,keyword:"additionalProperties",keywordLocation:Q,error:`Property "${K}" does not match additional properties schema.`},...ye.errors))}}else if(!Se&&pe!==void 0){const Q=`${o}/unevaluatedProperties`;for(const K in t)if(!c[K]){const Ae=`${a}/${pn(K)}`,ye=ct(t[K],pe,r,n,s,i,Ae,Q);ye.valid?c[K]=!0:Y.push({instanceLocation:a,keyword:"unevaluatedProperties",keywordLocation:Q,error:`Property "${K}" does not match unevaluated properties schema.`},...ye.errors)}}}else if(u==="array"){D!==void 0&&t.length>D&&Y.push({instanceLocation:a,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${t.length} > ${D}).`}),x!==void 0&&t.length<x&&Y.push({instanceLocation:a,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${t.length} < ${x}).`});const xe=t.length;let me=0,Se=!1;if(le!==void 0){const Q=`${o}/prefixItems`,K=Math.min(le.length,xe);for(;me<K;me++){const Ae=ct(t[me],le[me],r,n,s,i,`${a}/${me}`,`${Q}/${me}`);if(c[me]=!0,!Ae.valid&&(Se=s,Y.push({instanceLocation:a,keyword:"prefixItems",keywordLocation:Q,error:"Items did not match schema."},...Ae.errors),Se))break}}if(Ee!==void 0){const Q=`${o}/items`;if(Array.isArray(Ee)){const K=Math.min(Ee.length,xe);for(;me<K;me++){const Ae=ct(t[me],Ee[me],r,n,s,i,`${a}/${me}`,`${Q}/${me}`);if(c[me]=!0,!Ae.valid&&(Se=s,Y.push({instanceLocation:a,keyword:"items",keywordLocation:Q,error:"Items did not match schema."},...Ae.errors),Se))break}}else for(;me<xe;me++){const K=ct(t[me],Ee,r,n,s,i,`${a}/${me}`,Q);if(c[me]=!0,!K.valid&&(Se=s,Y.push({instanceLocation:a,keyword:"items",keywordLocation:Q,error:"Items did not match schema."},...K.errors),Se))break}if(!Se&&W!==void 0){const K=`${o}/additionalItems`;for(;me<xe;me++){const Ae=ct(t[me],W,r,n,s,i,`${a}/${me}`,K);c[me]=!0,Ae.valid||(Se=s,Y.push({instanceLocation:a,keyword:"additionalItems",keywordLocation:K,error:"Items did not match additional items schema."},...Ae.errors))}}}if(ae!==void 0)if(xe===0&&V===void 0)Y.push({instanceLocation:a,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(V!==void 0&&xe<V)Y.push({instanceLocation:a,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${xe}) than minContains (${V}).`});else{const Q=`${o}/contains`,K=Y.length;let Ae=0;for(let ye=0;ye<xe;ye++){const nr=ct(t[ye],ae,r,n,s,i,`${a}/${ye}`,Q);nr.valid?(c[ye]=!0,Ae++):Y.push(...nr.errors)}Ae>=(V||0)&&(Y.length=K),V===void 0&&A===void 0&&Ae===0?Y.splice(K,0,{instanceLocation:a,keyword:"contains",keywordLocation:Q,error:"Array does not contain item matching schema."}):V!==void 0&&Ae<V?Y.push({instanceLocation:a,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${V} items matching schema. Only ${Ae} items were found.`}):A!==void 0&&Ae>A&&Y.push({instanceLocation:a,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${A} items matching schema. ${Ae} items were found.`})}if(!Se&&X!==void 0){const Q=`${o}/unevaluatedItems`;for(me;me<xe;me++){if(c[me])continue;const K=ct(t[me],X,r,n,s,i,`${a}/${me}`,Q);c[me]=!0,K.valid||Y.push({instanceLocation:a,keyword:"unevaluatedItems",keywordLocation:Q,error:"Items did not match unevaluated items schema."},...K.errors)}}if(N)for(let Q=0;Q<xe;Q++){const K=t[Q],Ae=typeof K=="object"&&K!==null;for(let ye=0;ye<xe;ye++){if(Q===ye)continue;const nr=t[ye];(K===nr||Ae&&(typeof nr=="object"&&nr!==null)&&vi(K,nr))&&(Y.push({instanceLocation:a,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${Q} and ${ye}.`}),Q=Number.MAX_SAFE_INTEGER,ye=Number.MAX_SAFE_INTEGER)}}}else if(u==="number"){if(r==="4"?(ke!==void 0&&(Je===!0&&t<=ke||t<ke)&&Y.push({instanceLocation:a,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${t} is less than ${Je?"or equal to ":""} ${ke}.`}),$e!==void 0&&(at===!0&&t>=$e||t>$e)&&Y.push({instanceLocation:a,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${t} is greater than ${at?"or equal to ":""} ${$e}.`})):(ke!==void 0&&t<ke&&Y.push({instanceLocation:a,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${t} is less than ${ke}.`}),$e!==void 0&&t>$e&&Y.push({instanceLocation:a,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${t} is greater than ${$e}.`}),Je!==void 0&&t<=Je&&Y.push({instanceLocation:a,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${t} is less than ${Je}.`}),at!==void 0&&t>=at&&Y.push({instanceLocation:a,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${t} is greater than or equal to ${at}.`})),ft!==void 0){const xe=t%ft;Math.abs(0-xe)>=11920929e-14&&Math.abs(ft-xe)>=11920929e-14&&Y.push({instanceLocation:a,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${t} is not a multiple of ${ft}.`})}}else if(u==="string"){const xe=zt===void 0&&Xe===void 0?0:oL(t);zt!==void 0&&xe<zt&&Y.push({instanceLocation:a,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${xe} < ${zt}).`}),Xe!==void 0&&xe>Xe&&Y.push({instanceLocation:a,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${xe} > ${Xe}).`}),Lt!==void 0&&!new RegExp(Lt,"u").test(t)&&Y.push({instanceLocation:a,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),M!==void 0&&lb[M]&&!lb[M](t)&&Y.push({instanceLocation:a,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${M}".`})}return{valid:Y.length===0,errors:Y}}class cL{constructor(e,r="2019-09",n=!0){p(this,"schema");p(this,"draft");p(this,"shortCircuit");p(this,"lookup");this.schema=e,this.draft=r,this.shortCircuit=n,this.lookup=Ms(e)}validate(e){return ct(e,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(e,r){r&&(e={...e,$id:r}),Ms(e,this.lookup)}}var FS={};ve(FS,{Validator:()=>cL,deepCompareStrict:()=>vi,toJsonSchema:()=>ar,validatesOnlyStrings:()=>vo});function ar(t){if(_t(t)){const e=la(t,!0);if(Gn(e)){const r=nu(e,!0);return ru(r)}else return ru(t)}return bt(t)?$2(t):t}function vo(t){if(!t||typeof t!="object"||Object.keys(t).length===0||Array.isArray(t))return!1;if("type"in t)return typeof t.type=="string"?t.type==="string":Array.isArray(t.type)?t.type.every(e=>e==="string"):!1;if("enum"in t)return Array.isArray(t.enum)&&t.enum.length>0&&t.enum.every(e=>typeof e=="string");if("const"in t)return typeof t.const=="string";if("allOf"in t&&Array.isArray(t.allOf))return t.allOf.some(e=>vo(e));if("anyOf"in t&&Array.isArray(t.anyOf)||"oneOf"in t&&Array.isArray(t.oneOf)){const e="anyOf"in t?t.anyOf:t.oneOf;return e.length>0&&e.every(r=>vo(r))}if("not"in t)return!1;if("$ref"in t&&typeof t.$ref=="string"){const e=t.$ref,r=Ms(t);return r[e]?vo(r[e]):!1}return!1}function yg(t){return t?t.lc_runnable:!1}var lL=class{constructor(t){p(this,"includeNames");p(this,"includeTypes");p(this,"includeTags");p(this,"excludeNames");p(this,"excludeTypes");p(this,"excludeTags");this.includeNames=t.includeNames,this.includeTypes=t.includeTypes,this.includeTags=t.includeTags,this.excludeNames=t.excludeNames,this.excludeTypes=t.excludeTypes,this.excludeTags=t.excludeTags}includeEvent(t,e){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const n=t.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(t.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e)),this.includeTags!==void 0&&(r=r||n.some(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(t.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}};function df(t){return t.replace(/[^a-zA-Z-_0-9]/g,"_")}const uL=["*","_","`"];function dL(t){let e="";for(const[r,n]of Object.entries(t))e+=`	classDef ${r} ${n};
`;return e}function hL(t,e,r){const{firstNode:n,lastNode:s,nodeColors:i,withStyles:a=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=r??{};let l=a?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(a){const f="default",m={[f]:"{0}({1})"};n!==void 0&&(m[n]="{0}([{1}]):::first"),s!==void 0&&(m[s]="{0}([{1}]):::last");for(const[g,y]of Object.entries(t)){const b=y.name.split(":").pop()??"";let E=uL.some(k=>b.startsWith(k)&&b.endsWith(k))?`<p>${b}</p>`:b;Object.keys(y.metadata??{}).length&&(E+=`<hr/><small><em>${Object.entries(y.metadata??{}).map(([k,R])=>`${k} = ${R}`).join(`
`)}</em></small>`);const C=(m[g]??m[f]).replace("{0}",df(g)).replace("{1}",E);l+=`	${C}
`}}const u={};for(const f of e){const m=f.source.split(":"),g=f.target.split(":"),y=m.filter((b,_)=>b===g[_]).join(":");u[y]||(u[y]=[]),u[y].push(f)}const d=new Set;function h(f,m){const g=f.length===1&&f[0].source===f[0].target;if(m&&!g){const y=m.split(":").pop();if(d.has(y))throw new Error(`Found duplicate subgraph '${y}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(y),l+=`	subgraph ${y}
`}for(const y of f){const{source:b,target:_,data:E,conditional:C}=y;let k="";if(E!==void 0){let R=E;const $=R.split(" ");$.length>c&&(R=Array.from({length:Math.ceil($.length/c)},(S,M)=>$.slice(M*c,(M+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),k=C?` -. &nbsp;${R}&nbsp; .-> `:` -- &nbsp;${R}&nbsp; --> `}else k=C?" -.-> ":" --> ";l+=`	${df(b)}${k}${df(_)};
`}for(const y in u)y.startsWith(`${m}:`)&&y!==m&&h(u[y],y);m&&!g&&(l+=`	end
`)}h(u[""]??[],"");for(const f in u)!f.includes(":")&&f!==""&&h(u[f],f);return a&&(l+=dL(i??{})),l}async function fL(t,e){let r=(e==null?void 0:e.backgroundColor)??"white";const n=(e==null?void 0:e.imageType)??"png",s=btoa(t);r!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));const i=`https://mermaid.ink/img/${s}?bgColor=${r}&type=${n}`,a=await fetch(i);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join(`
`));return await a.blob()}var zS={};ve(zS,{Graph:()=>qo});function pL(t,e){if(t!==void 0&&!go(t))return t;if(yg(e))try{let r=e.getName();return r=r.startsWith("Runnable")?r.slice(8):r,r}catch{return e.getName()}else return e.name??"UnknownSchema"}function mL(t){return yg(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...ar(t.data.schema),title:t.data.name}}}var qo=class VS{constructor(e){p(this,"nodes",{});p(this,"edges",[]);this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((r,n)=>{e[r.id]=go(r.id)?n:r.id}),{nodes:Object.values(this.nodes).map(r=>({id:e[r.id],...mL(r)})),edges:this.edges.map(r=>{const n={source:e[r.source],target:e[r.target]};return typeof r.data<"u"&&(n.data=r.data),typeof r.conditional<"u"&&(n.conditional=r.conditional),n})}}addNode(e,r,n){if(r!==void 0&&this.nodes[r]!==void 0)throw new Error(`Node with id ${r} already exists`);const s=r??ss(),i={id:s,data:e,name:pL(r,e),metadata:n};return this.nodes[s]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(r=>r.source!==e.id&&r.target!==e.id)}addEdge(e,r,n,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[r.id]===void 0)throw new Error(`Target node ${r.id} not in graph`);const i={source:e.id,target:r.id,data:n,conditional:s};return this.edges.push(i),i}firstNode(){return ub(this)}lastNode(){return db(this)}extend(e,r=""){let n=r;Object.values(e.nodes).map(l=>l.id).every(go)&&(n="");const i=l=>n?`${n}:${l}`:l;Object.entries(e.nodes).forEach(([l,u])=>{this.nodes[i(l)]={...u,id:i(l)}});const a=e.edges.map(l=>({...l,source:i(l.source),target:i(l.target)}));this.edges=[...this.edges,...a];const o=e.firstNode(),c=e.lastNode();return[o?{id:i(o.id),data:o.data}:void 0,c?{id:i(c.id),data:c.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&ub(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&db(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),r=new Map;Object.values(e).forEach(s=>{r.set(s,(r.get(s)||0)+1)});const n=s=>{const i=e[s];return go(s)&&r.get(i)===1?i:s};return new VS({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,i])=>[n(s),{...i,id:n(s)}])),edges:this.edges.map(s=>({...s,source:n(s.source),target:n(s.target)}))})}drawMermaid(e){const{withStyles:r,curveStyle:n,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=e??{},a=this.reid(),o=a.firstNode(),c=a.lastNode();return hL(a.nodes,a.edges,{firstNode:o==null?void 0:o.id,lastNode:c==null?void 0:c.id,withStyles:r,curveStyle:n,nodeColors:s,wrapLabelNWords:i})}async drawMermaidPng(e){const r=this.drawMermaid(e);return fL(r,{backgroundColor:e==null?void 0:e.backgroundColor})}};function ub(t,e=[]){const r=new Set(t.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),n=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!r.has(s.id)&&n.push(s);return n.length===1?n[0]:void 0}function db(t,e=[]){const r=new Set(t.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),n=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!r.has(s.id)&&n.push(s);return n.length===1?n[0]:void 0}function qc({name:t,serialized:e}){return t!==void 0?t:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const gL=t=>t.name==="event_stream_tracer";var yL=class extends Es{constructor(e){super({_awaitHandler:!0,...e});p(this,"autoClose",!0);p(this,"includeNames");p(this,"includeTypes");p(this,"includeTags");p(this,"excludeNames");p(this,"excludeTypes");p(this,"excludeTags");p(this,"runInfoMap",new Map);p(this,"tappedPromises",new Map);p(this,"transformStream");p(this,"writer");p(this,"receiveStream");p(this,"name","event_stream_tracer");p(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=kr.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const r=e.tags??[];let n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(n=n||r.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(n=n&&r.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),n}async*tapOutputIterable(e,r){const n=await r.next();if(n.done)return;const s=this.runInfoMap.get(e);if(s===void 0){yield n.value;return}function i(o,c){return o==="llm"&&typeof c=="string"?new va({text:c}):c}let a=this.tappedPromises.get(e);if(a===void 0){let o;a=new Promise(c=>{o=c}),this.tappedPromises.set(e,a);try{const c={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...c,data:{chunk:i(s.runType,n.value)}},s),yield n.value;for await(const l of r)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...c,data:{chunk:i(s.runType,l)}},s),yield l}finally{o==null||o()}}else{yield n.value;for await(const o of r)yield o}}async send(e,r){this._includeRun(r)&&await this.writer.write(e)}async sendEndEvent(e,r){const n=this.tappedPromises.get(e.run_id);n!==void 0?n.then(()=>{this.send(e,r)}):await this.send(e,r)}async onLLMStart(e){var a,o;const r=qc(e),n=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:r,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,s);const i=`on_${n}_start`;await this.send({event:i,data:{input:e.inputs},name:r,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onLLMNewToken(e,r,n){const s=this.runInfoMap.get(e.id);let i,a;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")a="on_chat_model_stream",(n==null?void 0:n.chunk)===void 0?i=new At({content:r,id:`run-${e.id}`}):i=n.chunk.message;else if(s.runType==="llm")a="on_llm_stream",(n==null?void 0:n.chunk)===void 0?i=new va({text:r}):i=n.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:a,data:{chunk:i},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){var a,o,c;const r=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let n;if(r===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const s=(a=e.outputs)==null?void 0:a.generations;let i;if(r.runType==="chat_model"){for(const l of s??[]){if(i!==void 0)break;i=(o=l[0])==null?void 0:o.message}n="on_chat_model_end"}else if(r.runType==="llm")i={generations:s==null?void 0:s.map(l=>l.map(u=>({text:u.text,generationInfo:u.generationInfo}))),llmOutput:((c=e.outputs)==null?void 0:c.llmOutput)??{}},n="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${r.runType}`);await this.sendEndEvent({event:n,data:{output:i,input:r.inputs},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}async onChainStart(e){var a,o;const r=qc(e),n=e.run_type??"chain",s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:r,runType:e.run_type};let i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},s.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,s.inputs=e.inputs.input):(i.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${n}_start`,data:i,name:r,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onChainEnd(e){var o;const r=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),r===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const n=`on_${e.run_type}_end`,s=e.inputs??r.inputs??{},a={output:((o=e.outputs)==null?void 0:o.output)??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(a.input=s.input,r.inputs=s.input),await this.sendEndEvent({event:n,data:a,run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata??{}},r)}async onToolStart(e){var s,i;const r=qc(e),n={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:r,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:r,run_id:e.id,tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{}},n)}async onToolEnd(e){var s;const r=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),r===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(r.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const n=((s=e.outputs)==null?void 0:s.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:r.inputs},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}async onRetrieverStart(e){var i,a;const r=qc(e),s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:r,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:r,tags:e.tags??[],run_id:e.id,metadata:((a=e.extra)==null?void 0:a.metadata)??{}},s)}async onRetrieverEnd(e){var n;const r=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),r===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((n=e.outputs)==null?void 0:n.documents)??e.outputs,input:r.inputs},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}async handleCustomEvent(e,r,n){const s=this.runInfoMap.get(n);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:s.tags,metadata:s.metadata,data:r},s)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}},qS=class extends Es{constructor({config:e,onStart:r,onEnd:n,onError:s}){super({_awaitHandler:!0});p(this,"name","RootListenersTracer");p(this,"rootId");p(this,"config");p(this,"argOnStart");p(this,"argOnEnd");p(this,"argOnError");this.config=e,this.argOnStart=r,this.argOnEnd=n,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function _L(t){const e=new TextEncoder,r=new ReadableStream({async start(n){for await(const s of t)n.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));n.enqueue(e.encode(`event: end

`)),n.close()}});return kr.fromReadableStream(r)}function hb(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.iterator]=="function"&&typeof t.next=="function"}const wL=t=>t!=null&&typeof t=="object"&&"next"in t&&typeof t.next=="function";function Rp(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.asyncIterator]=="function"}function*fb(t,e){for(;;){const{value:r,done:n}=Bt.runWithConfig(gs(t),e.next.bind(e),!0);if(n)break;yield r}}async function*Op(t,e){const r=e[Symbol.asyncIterator]();for(;;){const{value:n,done:s}=await Bt.runWithConfig(gs(t),r.next.bind(e),!0);if(s)break;yield n}}function Nt(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}var Fe=class extends sn{constructor(){super(...arguments);p(this,"lc_runnable",!0);p(this,"name")}getName(e){const r=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${r}${e}`:r}withRetry(e){return new _g({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Zs({bound:this,config:e,kwargs:{}})}withFallbacks(e){const r=Array.isArray(e)?e:e.fallbacks;return new KS({runnable:this,fallbacks:r})}_getOptionsList(e,r=0){if(Array.isArray(e)&&e.length!==r)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${r} inputs`);if(Array.isArray(e))return e.map(Ve);if(r>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:r},(s,i)=>Ve(i===0?e:n))}return Array.from({length:r},()=>Ve(e))}async batch(e,r,n){var c;const s=this._getOptionsList(r??{},e.length),i=((c=s[0])==null?void 0:c.maxConcurrency)??(n==null?void 0:n.maxConcurrency),a=new gc({maxConcurrency:i,onFailedAttempt:l=>{throw l}}),o=e.map((l,u)=>a.call(async()=>{try{return await this.invoke(l,s[u])}catch(d){if(n!=null&&n.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,r){yield this.invoke(e,r)}async stream(e,r){const n=Ve(r),s=new Ui({generator:this._streamIterator(e,n),config:n});return await s.setup,kr.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let r;e===void 0?r=Ve(e):r=Ve({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,delete n.timeout,delete n.signal,[r,n]}async _callWithConfig(e,r,n){const s=Ve(n),i=await Ar(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),Nt(r,"input"),s.runId,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));delete s.runId;let o;try{const c=e.call(this,r,s,a);o=await Hs(c,n==null?void 0:n.signal)}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(Nt(o,"output"))),o}async _batchWithConfig(e,r,n,s){var l;const i=this._getOptionsList(n??{},r.length),a=await Promise.all(i.map(Ar)),o=await Promise.all(a.map(async(u,d)=>{const h=await(u==null?void 0:u.handleChainStart(this.toJSON(),Nt(r[d],"input"),i[d].runId,i[d].runType,void 0,void 0,i[d].runName??this.getName()));return delete i[d].runId,h}));let c;try{const u=e.call(this,r,i,o,s);c=await Hs(u,(l=i==null?void 0:i[0])==null?void 0:l.signal)}catch(u){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(u))),u}return await Promise.all(o.map(u=>u==null?void 0:u.handleChainEnd(Nt(c,"output")))),c}_concatOutputChunks(e,r){return Gs(e,r)}async*_transformStreamWithConfig(e,r,n){let s,i=!0,a,o=!0;const c=Ve(n),l=await Ar(c),u=this;async function*d(){for await(const f of e){if(i)if(s===void 0)s=f;else try{s=u._concatOutputChunks(s,f)}catch{s=void 0,i=!1}yield f}}let h;try{const f=await aS(r.bind(this),d(),async()=>l==null?void 0:l.handleChainStart(this.toJSON(),{input:""},c.runId,c.runType,void 0,void 0,c.runName??this.getName()),n==null?void 0:n.signal,c);delete c.runId,h=f.setup;const m=h==null?void 0:h.handlers.find(gL);let g=f.output;m!==void 0&&h!==void 0&&(g=m.tapOutputIterable(h.runId,g));const y=h==null?void 0:h.handlers.find(dS);y!==void 0&&h!==void 0&&(g=y.tapOutputIterable(h.runId,g));for await(const b of g)if(yield b,o)if(a===void 0)a=b;else try{a=this._concatOutputChunks(a,b)}catch{a=void 0,o=!1}}catch(f){throw await(h==null?void 0:h.handleChainError(f,void 0,void 0,void 0,{inputs:Nt(s,"input")})),f}await(h==null?void 0:h.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:Nt(s,"input")}))}getGraph(e){const r=new qo,n=r.addNode({name:`${this.getName()}Input`,schema:ab()}),s=r.addNode(this),i=r.addNode({name:`${this.getName()}Output`,schema:ab()});return r.addEdge(n,s),r.addEdge(s,i),r}pipe(e){return new Zn({first:this,last:Yt(e)})}pick(e){return this.pipe(new XS(e))}assign(e){return this.pipe(new wg(new Ua({steps:e})))}async*transform(e,r){let n;for await(const s of e)n===void 0?n=s:n=this._concatOutputChunks(n,s);yield*this._streamIterator(n,Ve(r))}async*streamLog(e,r,n){const s=new wp({...n,autoClose:!1,_schemaFormat:"original"}),i=Ve(r);yield*this._streamLog(e,s,i)}async*_streamLog(e,r,n){const{callbacks:s}=n;if(s===void 0)n.callbacks=[r];else if(Array.isArray(s))n.callbacks=s.concat([r]);else{const c=s.copy();c.addHandler(r,!0),n.callbacks=c}const i=this.stream(e,n);async function a(){try{const c=await i;for await(const l of c){const u=new is({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await r.writer.write(u)}}finally{await r.writer.close()}}const o=a();try{for await(const c of r)yield c}finally{await o}}streamEvents(e,r,n){let s;if(r.version==="v1")s=this._streamEventsV1(e,r,n);else if(r.version==="v2")s=this._streamEventsV2(e,r,n);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return r.encoding==="text/event-stream"?_L(s):kr.fromAsyncGenerator(s)}async*_streamEventsV2(e,r,n){var m;const s=new yL({...n,autoClose:!1}),i=Ve(r),a=i.runId??ss();i.runId=a;const o=i.callbacks;if(o===void 0)i.callbacks=[s];else if(Array.isArray(o))i.callbacks=o.concat(s);else{const g=o.copy();g.addHandler(s,!0),i.callbacks=g}const c=new AbortController,l=this;async function u(){let g,y=null;try{r!=null&&r.signal?"any"in AbortSignal?g=AbortSignal.any([c.signal,r.signal]):(g=r.signal,y=()=>{c.abort()},r.signal.addEventListener("abort",y,{once:!0})):g=c.signal;const b=await l.stream(e,{...i,signal:g}),_=s.tapOutputIterable(a,b);for await(const E of _)if(c.signal.aborted)break}finally{await s.finish(),g&&y&&g.removeEventListener("abort",y)}}const d=u();let h=!1,f;try{for await(const g of s){if(!h){g.data.input=e,h=!0,f=g.run_id,yield g;continue}g.run_id===f&&g.event.endsWith("_end")&&(m=g.data)!=null&&m.input&&delete g.data.input,yield g}}finally{c.abort(),await d}}async*_streamEventsV1(e,r,n){let s,i=!1;const a=Ve(r),o=a.tags??[],c=a.metadata??{},l=a.runName??this.getName(),u=new wp({...n,autoClose:!1,_schemaFormat:"streaming_events"}),d=new lL({...n}),h=this._streamLog(e,u,a);for await(const m of h){if(s?s=s.concat(m):s=og.fromRunLogPatch(m),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const _={...s.state},E={run_id:_.id,event:`on_${_.type}_start`,name:l,tags:o,metadata:c,data:{input:e}};d.includeEvent(E,_.type)&&(yield E)}const g=m.ops.filter(_=>_.path.startsWith("/logs/")).map(_=>_.path.split("/")[2]),y=[...new Set(g)];for(const _ of y){let E,C={};const k=s.state.logs[_];if(k.end_time===void 0?k.streamed_output.length>0?E="stream":E="start":E="end",E==="start")k.inputs!==void 0&&(C.input=k.inputs);else if(E==="end")k.inputs!==void 0&&(C.input=k.inputs),C.output=k.final_output;else if(E==="stream"){const R=k.streamed_output.length;if(R!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${R} instead. Encountered in: "${k.name}"`);C={chunk:k.streamed_output[0]},k.streamed_output=[]}yield{event:`on_${k.type}_${E}`,name:k.name,run_id:k.id,tags:k.tags,metadata:k.metadata,data:C}}const{state:b}=s;if(b.streamed_output.length>0){const _=b.streamed_output.length;if(_!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${_} instead. Encountered in: "${b.name}"`);const E={chunk:b.streamed_output[0]};b.streamed_output=[];const C={event:`on_${b.type}_stream`,run_id:b.id,tags:o,metadata:c,name:l,data:E};d.includeEvent(C,b.type)&&(yield C)}}const f=s==null?void 0:s.state;if(f!==void 0){const m={event:`on_${f.type}_end`,name:l,run_id:f.id,tags:o,metadata:c,data:{output:f.final_output}};d.includeEvent(m,f.type)&&(yield m)}}static isRunnable(e){return yg(e)}withListeners({onStart:e,onEnd:r,onError:n}){return new Zs({bound:this,config:{},configFactories:[s=>({callbacks:[new qS({config:s,onStart:e,onEnd:r,onError:n})]})]})}asTool(e){return xL(this,e)}},Zs=class HS extends Fe{constructor(r){super(r);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"bound");p(this,"config");p(this,"kwargs");p(this,"configFactories");this.bound=r.bound,this.kwargs=r.kwargs,this.config=r.config,this.configFactories=r.configFactories}static lc_name(){return"RunnableBinding"}getName(r){return this.bound.getName(r)}async _mergeConfig(...r){const n=en(this.config,...r);return en(n,...this.configFactories?await Promise.all(this.configFactories.map(async s=>await s(n))):[])}withConfig(r){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...r}})}withRetry(r){return new _g({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:r==null?void 0:r.stopAfterAttempt,...r})}async invoke(r,n){return this.bound.invoke(r,await this._mergeConfig(n,this.kwargs))}async batch(r,n,s){const i=Array.isArray(n)?await Promise.all(n.map(async a=>this._mergeConfig(Ve(a),this.kwargs))):await this._mergeConfig(Ve(n),this.kwargs);return this.bound.batch(r,i,s)}_concatOutputChunks(r,n){return this.bound._concatOutputChunks(r,n)}async*_streamIterator(r,n){yield*this.bound._streamIterator(r,await this._mergeConfig(Ve(n),this.kwargs))}async stream(r,n){return this.bound.stream(r,await this._mergeConfig(Ve(n),this.kwargs))}async*transform(r,n){yield*this.bound.transform(r,await this._mergeConfig(Ve(n),this.kwargs))}streamEvents(r,n,s){const i=this,a=async function*(){yield*i.bound.streamEvents(r,{...await i._mergeConfig(Ve(n),i.kwargs),version:n.version},s)};return kr.fromAsyncGenerator(a())}static isRunnableBinding(r){return r.bound&&Fe.isRunnable(r.bound)}withListeners({onStart:r,onEnd:n,onError:s}){return new HS({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[i=>({callbacks:[new qS({config:i,onStart:r,onEnd:n,onError:s})]})]})}},bL=class GS extends Fe{constructor(r){super(r);p(this,"lc_serializable",!0);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"bound");this.bound=r.bound}static lc_name(){return"RunnableEach"}async invoke(r,n){return this._callWithConfig(this._invoke.bind(this),r,n)}async _invoke(r,n,s){return this.bound.batch(r,Ze(n,{callbacks:s==null?void 0:s.getChild()}))}withListeners({onStart:r,onEnd:n,onError:s}){return new GS({bound:this.bound.withListeners({onStart:r,onEnd:n,onError:s})})}},_g=class extends Zs{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"maxAttemptNumber",3);p(this,"onFailedAttempt",()=>{});this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}static lc_name(){return"RunnableRetry"}_patchConfigForRetry(e,r,n){const s=e>1?`retry:attempt:${e}`:void 0;return Ze(r,{callbacks:n==null?void 0:n.getChild(s)})}async _invoke(e,r,n){return Jl(s=>super.invoke(e,this._patchConfigForRetry(s,r,n)),{onFailedAttempt:s=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,r){return this._callWithConfig(this._invoke.bind(this),e,r)}async _batch(e,r,n,s){const i={};try{await Jl(async a=>{const o=e.map((h,f)=>f).filter(h=>i[h.toString()]===void 0||i[h.toString()]instanceof Error),c=o.map(h=>e[h]),l=o.map(h=>this._patchConfigForRetry(a,r==null?void 0:r[h],n==null?void 0:n[h])),u=await super.batch(c,l,{...s,returnExceptions:!0});let d;for(let h=0;h<u.length;h+=1){const f=u[h],m=o[h];f instanceof Error&&d===void 0&&(d=f,d.input=c[h]),i[m.toString()]=f}if(d)throw d;return u},{onFailedAttempt:a=>this.onFailedAttempt(a,a.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if((s==null?void 0:s.returnExceptions)!==!0)throw a}return Object.keys(i).sort((a,o)=>parseInt(a,10)-parseInt(o,10)).map(a=>i[parseInt(a,10)])}async batch(e,r,n){return this._batchWithConfig(this._batch.bind(this),e,r,n)}},Zn=class eo extends Fe{constructor(r){super(r);p(this,"first");p(this,"middle",[]);p(this,"last");p(this,"omitSequenceTags",!1);p(this,"lc_serializable",!0);p(this,"lc_namespace",["langchain_core","runnables"]);this.first=r.first,this.middle=r.middle??this.middle,this.last=r.last,this.name=r.name,this.omitSequenceTags=r.omitSequenceTags??this.omitSequenceTags}static lc_name(){return"RunnableSequence"}get steps(){return[this.first,...this.middle,this.last]}async invoke(r,n){var l;const s=Ve(n),i=await Ar(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),Nt(r,"input"),s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;let o=r,c;try{const u=[this.first,...this.middle];for(let d=0;d<u.length;d+=1){const f=u[d].invoke(o,Ze(s,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${d+1}`)}));o=await Hs(f,n==null?void 0:n.signal)}if((l=n==null?void 0:n.signal)!=null&&l.aborted)throw Lo(n.signal);c=await this.last.invoke(o,Ze(s,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(u){throw await(a==null?void 0:a.handleChainError(u)),u}return await(a==null?void 0:a.handleChainEnd(Nt(c,"output"))),c}async batch(r,n,s){var l;const i=this._getOptionsList(n??{},r.length),a=await Promise.all(i.map(Ar)),o=await Promise.all(a.map(async(u,d)=>{const h=await(u==null?void 0:u.handleChainStart(this.toJSON(),Nt(r[d],"input"),i[d].runId,void 0,void 0,void 0,i[d].runName));return delete i[d].runId,h}));let c=r;try{for(let u=0;u<this.steps.length;u+=1){const h=this.steps[u].batch(c,o.map((f,m)=>{const g=f==null?void 0:f.getChild(this.omitSequenceTags?void 0:`seq:step:${u+1}`);return Ze(i[m],{callbacks:g})}),s);c=await Hs(h,(l=i[0])==null?void 0:l.signal)}}catch(u){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(u))),u}return await Promise.all(o.map(u=>u==null?void 0:u.handleChainEnd(Nt(c,"output")))),c}_concatOutputChunks(r,n){return this.last._concatOutputChunks(r,n)}async*_streamIterator(r,n){var h;const s=await Ar(n),{runId:i,...a}=n??{},o=await(s==null?void 0:s.handleChainStart(this.toJSON(),Nt(r,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName)),c=[this.first,...this.middle,this.last];let l=!0,u;async function*d(){yield r}try{let f=c[0].transform(d(),Ze(a,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let m=1;m<c.length;m+=1)f=await c[m].transform(f,Ze(a,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:`seq:step:${m+1}`)}));for await(const m of f)if((h=n==null?void 0:n.signal)==null||h.throwIfAborted(),yield m,l)if(u===void 0)u=m;else try{u=this._concatOutputChunks(u,m)}catch{u=void 0,l=!1}}catch(f){throw await(o==null?void 0:o.handleChainError(f)),f}await(o==null?void 0:o.handleChainEnd(Nt(u,"output")))}getGraph(r){const n=new qo;let s=null;return this.steps.forEach((i,a)=>{const o=i.getGraph(r);a!==0&&o.trimFirstNode(),a!==this.steps.length-1&&o.trimLastNode(),n.extend(o);const c=o.firstNode();if(!c)throw new Error(`Runnable ${i} has no first node`);s&&n.addEdge(s,c),s=o.lastNode()}),n}pipe(r){return eo.isRunnableSequence(r)?new eo({first:this.first,middle:this.middle.concat([this.last,r.first,...r.middle]),last:r.last,name:this.name??r.name}):new eo({first:this.first,middle:[...this.middle,this.last],last:Yt(r),name:this.name})}static isRunnableSequence(r){return Array.isArray(r.middle)&&Fe.isRunnable(r)}static from([r,...n],s){let i={};return typeof s=="string"?i.name=s:s!==void 0&&(i=s),new eo({...i,first:Yt(r),middle:n.slice(0,-1).map(Yt),last:Yt(n[n.length-1])})}},Ua=class WS extends Fe{constructor(r){super(r);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"steps");this.steps={};for(const[n,s]of Object.entries(r.steps))this.steps[n]=Yt(s)}static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}static from(r){return new WS({steps:r})}async invoke(r,n){const s=Ve(n),i=await Ar(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),{input:r},s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;const o={};try{const c=Object.entries(this.steps).map(async([l,u])=>{o[l]=await u.invoke(r,Ze(s,{callbacks:a==null?void 0:a.getChild(`map:key:${l}`)}))});await Hs(Promise.all(c),n==null?void 0:n.signal)}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(o)),o}async*_transform(r,n,s){const i={...this.steps},a=ag(r,Object.keys(i).length),o=new Map(Object.entries(i).map(([c,l],u)=>{const d=l.transform(a[u],Ze(s,{callbacks:n==null?void 0:n.getChild(`map:key:${c}`)}));return[c,d.next().then(h=>({key:c,gen:d,result:h}))]}));for(;o.size;){const c=Promise.race(o.values()),{key:l,result:u,gen:d}=await Hs(c,s==null?void 0:s.signal);o.delete(l),u.done||(yield{[l]:u.value},o.set(l,d.next().then(h=>({key:l,gen:d,result:h}))))}}transform(r,n){return this._transformStreamWithConfig(r,this._transform.bind(this),n)}async stream(r,n){async function*s(){yield r}const i=Ve(n),a=new Ui({generator:this.transform(s(),i),config:i});return await a.setup,kr.fromAsyncGenerator(a)}},vL=class JS extends Fe{constructor(r){super(r);p(this,"lc_serializable",!1);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"func");if(!tg(r.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=r.func}async invoke(r,n){const[s]=this._getOptionsList(n??{},1),i=await Ar(s),a=this.func(Ze(s,{callbacks:i}),r);return Hs(a,s==null?void 0:s.signal)}async*_streamIterator(r,n){var a,o;const[s]=this._getOptionsList(n??{},1),i=await this.invoke(r,n);if(Rp(i)){for await(const c of i)(a=s==null?void 0:s.signal)==null||a.throwIfAborted(),yield c;return}if(wL(i)){for(;;){(o=s==null?void 0:s.signal)==null||o.throwIfAborted();const c=i.next();if(c.done)break;yield c.value}return}yield i}static from(r){return new JS({func:r})}};function EL(t){if(tg(t))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Cn=class ZS extends Fe{constructor(r){if(tg(r.func))return vL.from(r.func);super(r);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"func");EL(r.func),this.func=r.func}static lc_name(){return"RunnableLambda"}static from(r){return new ZS({func:r})}async _invoke(r,n,s){return new Promise((i,a)=>{const o=Ze(n,{callbacks:s==null?void 0:s.getChild(),recursionLimit:((n==null?void 0:n.recursionLimit)??of)-1});Bt.runWithConfig(gs(o),async()=>{var c,l;try{let u=await this.func(r,{...o});if(u&&Fe.isRunnable(u)){if((n==null?void 0:n.recursionLimit)===0)throw new Error("Recursion limit reached.");u=await u.invoke(r,{...o,recursionLimit:(o.recursionLimit??of)-1})}else if(Rp(u)){let d;for await(const h of Op(o,u))if((c=n==null?void 0:n.signal)==null||c.throwIfAborted(),d===void 0)d=h;else try{d=this._concatOutputChunks(d,h)}catch{d=h}u=d}else if(hb(u)){let d;for(const h of fb(o,u))if((l=n==null?void 0:n.signal)==null||l.throwIfAborted(),d===void 0)d=h;else try{d=this._concatOutputChunks(d,h)}catch{d=h}u=d}i(u)}catch(u){a(u)}})})}async invoke(r,n){return this._callWithConfig(this._invoke.bind(this),r,n)}async*_transform(r,n,s){var c,l;let i;for await(const u of r)if(i===void 0)i=u;else try{i=this._concatOutputChunks(i,u)}catch{i=u}const a=Ze(s,{callbacks:n==null?void 0:n.getChild(),recursionLimit:((s==null?void 0:s.recursionLimit)??of)-1}),o=await new Promise((u,d)=>{Bt.runWithConfig(gs(a),async()=>{try{const h=await this.func(i,{...a,config:a});u(h)}catch(h){d(h)}})});if(o&&Fe.isRunnable(o)){if((s==null?void 0:s.recursionLimit)===0)throw new Error("Recursion limit reached.");const u=await o.stream(i,a);for await(const d of u)yield d}else if(Rp(o))for await(const u of Op(a,o))(c=s==null?void 0:s.signal)==null||c.throwIfAborted(),yield u;else if(hb(o))for(const u of fb(a,o))(l=s==null?void 0:s.signal)==null||l.throwIfAborted(),yield u;else yield o}transform(r,n){return this._transformStreamWithConfig(r,this._transform.bind(this),n)}async stream(r,n){async function*s(){yield r}const i=Ve(n),a=new Ui({generator:this.transform(s(),i),config:i});return await a.setup,kr.fromAsyncGenerator(a)}},SL=class extends Ua{},KS=class extends Fe{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"runnable");p(this,"fallbacks");this.runnable=e.runnable,this.fallbacks=e.fallbacks}static lc_name(){return"RunnableWithFallbacks"}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,r){const n=Ve(r),s=await Ar(n),{runId:i,...a}=n,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),Nt(e,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName)),c=Ze(a,{callbacks:o==null?void 0:o.getChild()});return await Bt.runWithConfig(c,async()=>{var d;let u;for(const h of this.runnables()){(d=n==null?void 0:n.signal)==null||d.throwIfAborted();try{const f=await h.invoke(e,c);return await(o==null?void 0:o.handleChainEnd(Nt(f,"output"))),f}catch(f){u===void 0&&(u=f)}}throw u===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(u)),u)})}async*_streamIterator(e,r){var d;const n=Ve(r),s=await Ar(n),{runId:i,...a}=n,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),Nt(e,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName));let c,l;for(const h of this.runnables()){(d=n==null?void 0:n.signal)==null||d.throwIfAborted();const f=Ze(a,{callbacks:o==null?void 0:o.getChild()});try{const m=await h.stream(e,f);l=Op(f,m);break}catch(m){c===void 0&&(c=m)}}if(l===void 0){const h=c??new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(h)),h}let u;try{for await(const h of l){yield h;try{u=u===void 0?u:this._concatOutputChunks(u,h)}catch{u=void 0}}}catch(h){throw await(o==null?void 0:o.handleChainError(h)),h}await(o==null?void 0:o.handleChainEnd(Nt(u,"output")))}async batch(e,r,n){var c;if(n!=null&&n.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(r??{},e.length),i=await Promise.all(s.map(l=>Ar(l))),a=await Promise.all(i.map(async(l,u)=>{const d=await(l==null?void 0:l.handleChainStart(this.toJSON(),Nt(e[u],"input"),s[u].runId,void 0,void 0,void 0,s[u].runName));return delete s[u].runId,d}));let o;for(const l of this.runnables()){(c=s[0].signal)==null||c.throwIfAborted();try{const u=await l.batch(e,a.map((d,h)=>Ze(s[h],{callbacks:d==null?void 0:d.getChild()})),n);return await Promise.all(a.map((d,h)=>d==null?void 0:d.handleChainEnd(Nt(u[h],"output")))),u}catch(u){o===void 0&&(o=u)}}throw o?(await Promise.all(a.map(l=>l==null?void 0:l.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function Yt(t){if(typeof t=="function")return new Cn({func:t});if(Fe.isRunnable(t))return t;if(!Array.isArray(t)&&typeof t=="object"){const e={};for(const[r,n]of Object.entries(t))e[r]=Yt(n);return new Ua({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var wg=class extends Fe{constructor(e){e instanceof Ua&&(e={mapper:e});super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"mapper");this.mapper=e.mapper}static lc_name(){return"RunnableAssign"}async invoke(e,r){const n=await this.mapper.invoke(e,r);return{...e,...n}}async*_transform(e,r,n){const s=this.mapper.getStepsKeys(),[i,a]=ag(e),o=this.mapper.transform(a,Ze(n,{callbacks:r==null?void 0:r.getChild()})),c=o.next();for await(const l of i){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);const u=Object.fromEntries(Object.entries(l).filter(([d])=>!s.includes(d)));Object.keys(u).length>0&&(yield u)}yield(await c).value;for await(const l of o)yield l}transform(e,r){return this._transformStreamWithConfig(e,this._transform.bind(this),r)}async stream(e,r){async function*n(){yield e}const s=Ve(r),i=new Ui({generator:this.transform(n(),s),config:s});return await i.setup,kr.fromAsyncGenerator(i)}},XS=class extends Fe{constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e});super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"keys");this.keys=e.keys}static lc_name(){return"RunnablePick"}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const r=this.keys.map(n=>[n,e[n]]).filter(n=>n[1]!==void 0);return r.length===0?void 0:Object.fromEntries(r)}}async invoke(e,r){return this._callWithConfig(this._pick.bind(this),e,r)}async*_transform(e){for await(const r of e){const n=await this._pick(r);n!==void 0&&(yield n)}}transform(e,r){return this._transformStreamWithConfig(e,this._transform.bind(this),r)}async stream(e,r){async function*n(){yield e}const s=Ve(r),i=new Ui({generator:this.transform(n(),s),config:s});return await i.setup,kr.fromAsyncGenerator(i)}},$p=class extends Zs{constructor(e){const r=Zn.from([Cn.from(async n=>{let s;if(wo(n))try{s=await ld(this.schema,n.args)}catch{throw new Xl("Received tool input did not match expected schema",JSON.stringify(n.args))}else s=n;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:r,config:e.config??{}});p(this,"name");p(this,"description");p(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function xL(t,e){const r=e.name??t.getName(),n=e.description??Ri(e.schema);return hg(e.schema)?new $p({name:r,description:n,schema:jt({input:it()}).transform(s=>s.input),bound:t}):new $p({name:r,description:n,schema:e.schema,bound:t})}const du=(t,e)=>{const r=[...new Set(e==null?void 0:e.map(s=>{if(typeof s=="string")return s;const i=new s({});if(!("getType"in i)||typeof i.getType!="function")throw new Error("Invalid type provided.");return i.getType()}))],n=t.getType();return r.some(s=>s===n)};function TL(t,e){return Array.isArray(t)?pb(t,e):Cn.from(r=>pb(r,t))}function pb(t,e={}){const{includeNames:r,excludeNames:n,includeTypes:s,excludeTypes:i,includeIds:a,excludeIds:o}=e,c=[];for(const l of t)if(!(n&&l.name&&n.includes(l.name))){{if(i&&du(l,i))continue;if(o&&l.id&&o.includes(l.id))continue}s||a||r?(r&&l.name&&r.some(u=>u===l.name)||s&&du(l,s)||a&&l.id&&a.some(u=>u===l.id))&&c.push(l):c.push(l)}return c}function AL(t){return Array.isArray(t)?mb(t):Cn.from(mb)}function mb(t){if(!t.length)return[];const e=[];for(const r of t){const n=r,s=e.pop();if(!s)e.push(n);else if(n.getType()==="tool"||n.getType()!==s.getType())e.push(s,n);else{const i=Ql(s),a=Ql(n),o=i.concat(a);typeof i.content=="string"&&typeof a.content=="string"&&(o.content=`${i.content}
${a.content}`),e.push(IL(o))}}return e}function CL(t,e){if(Array.isArray(t)){const r=t;if(!e)throw new Error("Options parameter is required when providing messages.");return gb(r,e)}else{const r=t;return Cn.from(n=>gb(n,r)).withConfig({runName:"trim_messages"})}}async function gb(t,e){const{maxTokens:r,tokenCounter:n,strategy:s="last",allowPartial:i=!1,endOn:a,startOn:o,includeSystem:c=!1,textSplitter:l}=e;if(o&&s==="first")throw new Error("`startOn` should only be specified if `strategy` is 'last'.");if(c&&s==="first")throw new Error("`includeSystem` should only be specified if `strategy` is 'last'.");let u;"getNumTokens"in n?u=async h=>(await Promise.all(h.map(m=>n.getNumTokens(m.content)))).reduce((m,g)=>m+g,0):u=async h=>n(h);let d=QS;if(l&&("splitText"in l?d=l.splitText:d=async h=>l(h)),s==="first")return YS(t,{maxTokens:r,tokenCounter:u,textSplitter:d,partialStrategy:i?"first":void 0,endOn:a});if(s==="last")return kL(t,{maxTokens:r,tokenCounter:u,textSplitter:d,allowPartial:i,includeSystem:c,startOn:o,endOn:a});throw new Error(`Unrecognized strategy: '${s}'. Must be one of 'first' or 'last'.`)}async function YS(t,e){const{maxTokens:r,tokenCounter:n,textSplitter:s,partialStrategy:i,endOn:a}=e;let o=[...t],c=0;for(let l=0;l<o.length;l+=1){const u=l>0?o.slice(0,-l):o;if(await n(u)<=r){c=o.length-l;break}}if(c<o.length&&i){let l=!1;if(Array.isArray(o[c].content)){const u=o[c];if(typeof u.content=="string")throw new Error("Expected content to be an array.");const d=u.content.length,h=i==="last"?[...u.content].reverse():u.content;for(let f=1;f<=d;f+=1){const m=i==="first"?h.slice(0,f):h.slice(-f),g=Object.fromEntries(Object.entries(u).filter(([_])=>_!=="type"&&!_.startsWith("lc_"))),y=bg(u.getType(),{...g,content:m}),b=[...o.slice(0,c),y];if(await n(b)<=r)o=b,c+=1,l=!0;else break}l&&i==="last"&&(u.content=[...h].reverse())}if(!l){const u=o[c];let d;if(Array.isArray(u.content)&&u.content.some(h=>typeof h=="string"||h.type==="text")){const h=u.content.find(f=>f.type==="text"&&f.text);d=h==null?void 0:h.text}else typeof u.content=="string"&&(d=u.content);if(d){const h=await s(d),f=h.length;i==="last"&&h.reverse();for(let m=0;m<f-1;m+=1)if(h.pop(),u.content=h.join(""),await n([...o.slice(0,c),u])<=r){i==="last"&&(u.content=[...h].reverse().join("")),o=[...o.slice(0,c),u],c+=1;break}}}}if(a){const l=Array.isArray(a)?a:[a];for(;c>0&&!du(o[c-1],l);)c-=1}return o.slice(0,c)}async function kL(t,e){var u;const{allowPartial:r=!1,includeSystem:n=!1,endOn:s,startOn:i,...a}=e;let o=t.map(d=>{const h=Object.fromEntries(Object.entries(d).filter(([f])=>f!=="type"&&!f.startsWith("lc_")));return bg(d.getType(),h,$o(d))});if(s){const d=Array.isArray(s)?s:[s];for(;o.length>0&&!du(o[o.length-1],d);)o=o.slice(0,-1)}const c=n&&((u=o[0])==null?void 0:u.getType())==="system";let l=c?o.slice(0,1).concat(o.slice(1).reverse()):o.reverse();return l=await YS(l,{...a,partialStrategy:r?"last":void 0,endOn:i}),c?[l[0],...l.slice(1).reverse()]:l.reverse()}const yb={human:{message:ut,messageChunk:fc},ai:{message:ht,messageChunk:At},system:{message:dt,messageChunk:qs},developer:{message:dt,messageChunk:qs},tool:{message:fr,messageChunk:lc},function:{message:sd,messageChunk:hc},generic:{message:Kn,messageChunk:dc},remove:{message:Yl,messageChunk:Yl}};function bg(t,e,r){var i;let n,s;switch(t){case"human":r?n=new fc(e):s=new ut(e);break;case"ai":if(r){let a={...e};"tool_calls"in a&&(a={...a,tool_call_chunks:(i=a.tool_calls)==null?void 0:i.map(o=>({...o,type:"tool_call_chunk",index:void 0,args:JSON.stringify(o.args)}))}),n=new At(a)}else s=new ht(e);break;case"system":r?n=new qs(e):s=new dt(e);break;case"developer":r?n=new qs({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}}):s=new dt({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}});break;case"tool":if("tool_call_id"in e)r?n=new lc(e):s=new fr(e);else throw new Error("Can not convert ToolMessage to ToolMessageChunk if 'tool_call_id' field is not defined.");break;case"function":if(r)n=new hc(e);else{if(!e.name)throw new Error("FunctionMessage must have a 'name' field");s=new sd(e)}break;case"generic":if("role"in e)r?n=new dc(e):s=new Kn(e);else throw new Error("Can not convert ChatMessage to ChatMessageChunk if 'role' field is not defined.");break;default:throw new Error(`Unrecognized message type ${t}`)}if(r&&n)return n;if(s)return s;throw new Error(`Unrecognized message type ${t}`)}function IL(t){const e=t.getType();let r;const n=Object.fromEntries(Object.entries(t).filter(([s])=>!["type","tool_call_chunks"].includes(s)&&!s.startsWith("lc_")));if(e in yb&&(r=bg(e,n)),!r)throw new Error(`Unrecognized message chunk class ${e}. Supported classes are ${Object.keys(yb)}`);return r}function QS(t){const e=t.split(`
`);return Promise.resolve([...e.slice(0,-1).map(r=>`${r}
`),e[e.length-1]])}const RL=["tool_call","tool_call_chunk","invalid_tool_call","server_tool_call","server_tool_call_chunk","server_tool_call_result"],OL=["image","video","audio","text-plain","file"],$L=["text","reasoning",...RL,...OL];var ex={};ve(ex,{AIMessage:()=>ht,AIMessageChunk:()=>At,BaseMessage:()=>nn,BaseMessageChunk:()=>Di,ChatMessage:()=>Kn,ChatMessageChunk:()=>dc,FunctionMessage:()=>sd,FunctionMessageChunk:()=>hc,HumanMessage:()=>ut,HumanMessageChunk:()=>fc,KNOWN_BLOCK_TYPES:()=>$L,RemoveMessage:()=>Yl,SystemMessage:()=>dt,SystemMessageChunk:()=>qs,ToolMessage:()=>fr,ToolMessageChunk:()=>lc,_isMessageFieldWithRole:()=>hE,_mergeDicts:()=>or,_mergeLists:()=>cc,_mergeObj:()=>dE,_mergeStatus:()=>uE,coerceMessageLikeToMessage:()=>Hn,convertToChunk:()=>Ql,convertToOpenAIImageBlock:()=>aE,convertToProviderContentBlock:()=>Xu,defaultTextSplitter:()=>QS,defaultToolCallParser:()=>qm,filterMessages:()=>TL,getBufferString:()=>sg,iife:()=>iN,isAIMessage:()=>ms,isAIMessageChunk:()=>dp,isBase64ContentBlock:()=>jm,isBaseMessage:()=>St,isBaseMessageChunk:()=>$o,isChatMessage:()=>K$,isChatMessageChunk:()=>X$,isDataContentBlock:()=>Sn,isDirectToolOutput:()=>Vm,isFunctionMessage:()=>Y$,isFunctionMessageChunk:()=>Q$,isHumanMessage:()=>eN,isHumanMessageChunk:()=>tN,isIDContentBlock:()=>iE,isMessage:()=>lE,isOpenAIToolCallArray:()=>W1,isPlainTextContentBlock:()=>$1,isSystemMessage:()=>rN,isSystemMessageChunk:()=>nN,isToolMessage:()=>Hm,isToolMessageChunk:()=>pE,isURLContentBlock:()=>Bm,mapChatMessagesToStoredMessages:()=>uN,mapStoredMessageToChatMessage:()=>ig,mapStoredMessagesToChatMessages:()=>lN,mergeContent:()=>Mi,mergeMessageRuns:()=>AL,mergeResponseMetadata:()=>WE,mergeUsageMetadata:()=>ZE,parseBase64DataUrl:()=>Ci,parseMimeType:()=>mi,trimMessages:()=>CL});var tx={};ve(tx,{BaseChatMessageHistory:()=>rx,BaseListChatMessageHistory:()=>vg,InMemoryChatMessageHistory:()=>NL});var rx=class extends sn{async addMessages(t){for(const e of t)await this.addMessage(e)}},vg=class extends sn{addUserMessage(t){return this.addMessage(new ut(t))}addAIMessage(t){return this.addMessage(new ht(t))}async addMessages(t){for(const e of t)await this.addMessage(e)}clear(){throw new Error("Not implemented.")}},NL=class extends vg{constructor(e){super(...arguments);p(this,"lc_namespace",["langchain","stores","message","in_memory"]);p(this,"messages",[]);this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}},nx={};ve(nx,{Embeddings:()=>Eg});var Eg=class{constructor(e){p(this,"caller");this.caller=new gc(e??{})}},PL={},sx={};ve(sx,{BaseMemory:()=>LL,getInputValue:()=>ML,getOutputValue:()=>DL,getPromptInputKey:()=>UL});var LL=class{};const ix=(t,e)=>{if(e!==void 0)return t[e];const r=Object.keys(t);if(r.length===1)return t[r[0]]},ML=(t,e)=>{const r=ix(t,e);if(!r){const n=Object.keys(t);throw new Error(`input values have ${n.length} keys, you must specify an input key or pass only 1 key as input`)}return r},DL=(t,e)=>{const r=ix(t,e);if(!r&&r!==""){const n=Object.keys(t);throw new Error(`output values have ${n.length} keys, you must specify an output key or pass only 1 key as output`)}return r};function UL(t,e){const r=Object.keys(t).filter(n=>!e.includes(n)&&n!=="stop");if(r.length!==1)throw new Error(`One input key expected, but got ${r.length}`);return r[0]}var ax={};ve(ax,{BasePromptValue:()=>dd,ChatPromptValue:()=>xg,ImagePromptValue:()=>ox,StringPromptValue:()=>Sg});var dd=class extends sn{},Sg=class extends dd{constructor(e){super({value:e});p(this,"lc_namespace",["langchain_core","prompt_values"]);p(this,"lc_serializable",!0);p(this,"value");this.value=e}static lc_name(){return"StringPromptValue"}toString(){return this.value}toChatMessages(){return[new ut(this.value)]}},xg=class extends dd{constructor(e){Array.isArray(e)&&(e={messages:e});super(e);p(this,"lc_namespace",["langchain_core","prompt_values"]);p(this,"lc_serializable",!0);p(this,"messages");this.messages=e.messages}static lc_name(){return"ChatPromptValue"}toString(){return sg(this.messages)}toChatMessages(){return this.messages}},ox=class extends dd{constructor(e){"imageUrl"in e||(e={imageUrl:e});super(e);p(this,"lc_namespace",["langchain_core","prompt_values"]);p(this,"lc_serializable",!0);p(this,"imageUrl");p(this,"value");this.imageUrl=e.imageUrl}static lc_name(){return"ImagePromptValue"}toString(){return this.imageUrl.url}toChatMessages(){return[new ut({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}},cx={};ve(cx,{BaseStore:()=>lx,InMemoryStore:()=>BL});var lx=class extends sn{},BL=class extends lx{constructor(){super(...arguments);p(this,"lc_namespace",["langchain","storage"]);p(this,"store",{})}async mget(e){return e.map(r=>this.store[r])}async mset(e){for(const[r,n]of e)this.store[r]=n}async mdelete(e){for(const r of e)delete this.store[r]}async*yieldKeys(e){const r=Object.keys(this.store);for(const n of r)(e===void 0||n.startsWith(e))&&(yield n)}},ux={};ve(ux,{BaseRetriever:()=>Tg});var Tg=class extends Fe{constructor(e){super(e);p(this,"callbacks");p(this,"tags");p(this,"metadata");p(this,"verbose");this.callbacks=e==null?void 0:e.callbacks,this.tags=(e==null?void 0:e.tags)??[],this.metadata=(e==null?void 0:e.metadata)??{},this.verbose=(e==null?void 0:e.verbose)??!1}_getRelevantDocuments(e,r){throw new Error("Not implemented!")}async invoke(e,r){const n=Ve(pc(r)),s=await pr.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),i=await(s==null?void 0:s.handleRetrieverStart(this.toJSON(),e,n.runId,void 0,void 0,void 0,n.runName));try{const a=await this._getRelevantDocuments(e,i);return await(i==null?void 0:i.handleRetrieverEnd(a)),a}catch(a){throw await(i==null?void 0:i.handleRetrieverError(a)),a}}},dx={};ve(dx,{SaveableVectorStore:()=>jL,VectorStore:()=>Ag,VectorStoreRetriever:()=>El});var El=class extends Tg{constructor(e){super(e);p(this,"vectorStore");p(this,"k",4);p(this,"searchType","similarity");p(this,"searchKwargs");p(this,"filter");this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,e.searchType==="mmr"&&(this.searchKwargs=e.searchKwargs)}static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}async _getRelevantDocuments(e,r){if(this.searchType==="mmr"){if(typeof this.vectorStore.maxMarginalRelevanceSearch!="function")throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},r==null?void 0:r.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,r==null?void 0:r.getChild("vectorstore"))}async addDocuments(e,r){return this.vectorStore.addDocuments(e,r)}},Ag=class extends sn{constructor(e,r){super(r);p(this,"lc_namespace",["langchain","vectorstores",this._vectorstoreType()]);p(this,"embeddings");this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,r=4,n=void 0,s=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),r,n)).map(a=>a[0])}async similaritySearchWithScore(e,r=4,n=void 0,s=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),r,n)}static fromTexts(e,r,n,s){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,r,n){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,r,n,s,i,a){if(typeof e=="number")return new El({vectorStore:this,k:e,filter:r,tags:[...s??[],this._vectorstoreType()],metadata:i,verbose:a,callbacks:n});{const o={vectorStore:this,k:e==null?void 0:e.k,filter:e==null?void 0:e.filter,tags:[...(e==null?void 0:e.tags)??[],this._vectorstoreType()],metadata:e==null?void 0:e.metadata,verbose:e==null?void 0:e.verbose,callbacks:e==null?void 0:e.callbacks,searchType:e==null?void 0:e.searchType};return(e==null?void 0:e.searchType)==="mmr"?new El({...o,searchKwargs:e.searchKwargs}):new El({...o})}}},jL=class extends Ag{static load(t,e){throw new Error("Not implemented")}},de="0123456789abcdef".split(""),FL=[-2147483648,8388608,32768,128],dn=[24,16,8,0],Hc=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],Mt=[];function xn(t,e){e?(Mt[0]=Mt[16]=Mt[1]=Mt[2]=Mt[3]=Mt[4]=Mt[5]=Mt[6]=Mt[7]=Mt[8]=Mt[9]=Mt[10]=Mt[11]=Mt[12]=Mt[13]=Mt[14]=Mt[15]=0,this.blocks=Mt):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=t}xn.prototype.update=function(t){if(!this.finalized){var e,r=typeof t;if(r!=="string"){if(r==="object"){if(t===null)throw new Error(ERROR);if(ARRAY_BUFFER&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!Array.isArray(t)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(t)))throw new Error(ERROR)}else throw new Error(ERROR);e=!0}for(var n,s=0,i,a=t.length,o=this.blocks;s<a;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),e)for(i=this.start;s<a&&i<64;++s)o[i>>>2]|=t[s]<<dn[i++&3];else for(i=this.start;s<a&&i<64;++s)n=t.charCodeAt(s),n<128?o[i>>>2]|=n<<dn[i++&3]:n<2048?(o[i>>>2]|=(192|n>>>6)<<dn[i++&3],o[i>>>2]|=(128|n&63)<<dn[i++&3]):n<55296||n>=57344?(o[i>>>2]|=(224|n>>>12)<<dn[i++&3],o[i>>>2]|=(128|n>>>6&63)<<dn[i++&3],o[i>>>2]|=(128|n&63)<<dn[i++&3]):(n=65536+((n&1023)<<10|t.charCodeAt(++s)&1023),o[i>>>2]|=(240|n>>>18)<<dn[i++&3],o[i>>>2]|=(128|n>>>12&63)<<dn[i++&3],o[i>>>2]|=(128|n>>>6&63)<<dn[i++&3],o[i>>>2]|=(128|n&63)<<dn[i++&3]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=o[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};xn.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>>2]|=FL[e&3],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}};xn.prototype.hash=function(){var t=this.h0,e=this.h1,r=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=this.blocks,l,u,d,h,f,m,g,y,b,_,E;for(l=16;l<64;++l)f=c[l-15],u=(f>>>7|f<<25)^(f>>>18|f<<14)^f>>>3,f=c[l-2],d=(f>>>17|f<<15)^(f>>>19|f<<13)^f>>>10,c[l]=c[l-16]+u+c[l-7]+d<<0;for(E=e&r,l=0;l<64;l+=4)this.first?(this.is224?(y=300032,f=c[0]-1413257819,o=f-150054599<<0,n=f+24177077<<0):(y=704751109,f=c[0]-210244248,o=f-1521486534<<0,n=f+143694565<<0),this.first=!1):(u=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),d=(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7),y=t&e,h=y^t&r^E,g=s&i^~s&a,f=o+d+g+Hc[l]+c[l],m=u+h,o=n+f<<0,n=f+m<<0),u=(n>>>2|n<<30)^(n>>>13|n<<19)^(n>>>22|n<<10),d=(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7),b=n&t,h=b^n&e^y,g=a&o^~a&s,f=i+d+g+Hc[l+1]+c[l+1],m=u+h,a=r+f<<0,r=f+m<<0,u=(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10),d=(a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7),_=r&n,h=_^r&t^b,g=i&a^~i&o,f=s+d+g+Hc[l+2]+c[l+2],m=u+h,i=e+f<<0,e=f+m<<0,u=(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10),d=(i>>>6|i<<26)^(i>>>11|i<<21)^(i>>>25|i<<7),E=e&r,h=E^e&n^_,g=i&a^~i&o,f=s+d+g+Hc[l+3]+c[l+3],m=u+h,s=t+f<<0,t=f+m<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+t<<0,this.h1=this.h1+e<<0,this.h2=this.h2+r<<0,this.h3=this.h3+n<<0,this.h4=this.h4+s<<0,this.h5=this.h5+i<<0,this.h6=this.h6+a<<0,this.h7=this.h7+o<<0};xn.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,r=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=de[t>>>28&15]+de[t>>>24&15]+de[t>>>20&15]+de[t>>>16&15]+de[t>>>12&15]+de[t>>>8&15]+de[t>>>4&15]+de[t&15]+de[e>>>28&15]+de[e>>>24&15]+de[e>>>20&15]+de[e>>>16&15]+de[e>>>12&15]+de[e>>>8&15]+de[e>>>4&15]+de[e&15]+de[r>>>28&15]+de[r>>>24&15]+de[r>>>20&15]+de[r>>>16&15]+de[r>>>12&15]+de[r>>>8&15]+de[r>>>4&15]+de[r&15]+de[n>>>28&15]+de[n>>>24&15]+de[n>>>20&15]+de[n>>>16&15]+de[n>>>12&15]+de[n>>>8&15]+de[n>>>4&15]+de[n&15]+de[s>>>28&15]+de[s>>>24&15]+de[s>>>20&15]+de[s>>>16&15]+de[s>>>12&15]+de[s>>>8&15]+de[s>>>4&15]+de[s&15]+de[i>>>28&15]+de[i>>>24&15]+de[i>>>20&15]+de[i>>>16&15]+de[i>>>12&15]+de[i>>>8&15]+de[i>>>4&15]+de[i&15]+de[a>>>28&15]+de[a>>>24&15]+de[a>>>20&15]+de[a>>>16&15]+de[a>>>12&15]+de[a>>>8&15]+de[a>>>4&15]+de[a&15];return this.is224||(c+=de[o>>>28&15]+de[o>>>24&15]+de[o>>>20&15]+de[o>>>16&15]+de[o>>>12&15]+de[o>>>8&15]+de[o>>>4&15]+de[o&15]),c};xn.prototype.toString=xn.prototype.hex;xn.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,r=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=[t>>>24&255,t>>>16&255,t>>>8&255,t&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255,i>>>24&255,i>>>16&255,i>>>8&255,i&255,a>>>24&255,a>>>16&255,a>>>8&255,a&255];return this.is224||c.push(o>>>24&255,o>>>16&255,o>>>8&255,o&255),c};xn.prototype.array=xn.prototype.digest;xn.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(this.is224?28:32),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),e.setUint32(20,this.h5),e.setUint32(24,this.h6),this.is224||e.setUint32(28,this.h7),t};const Cg=(...t)=>new xn(!1,!0).update(t.join("")).hex();var hx={};ve(hx,{sha256:()=>Cg});var fx={};ve(fx,{BaseCache:()=>mx,InMemoryCache:()=>gx,defaultHashKeyEncoder:()=>px,deserializeStoredGeneration:()=>zL,serializeGeneration:()=>VL});const px=(...t)=>Cg(t.join("_"));function zL(t){return t.message!==void 0?{text:t.text,message:ig(t.message)}:{text:t.text}}function VL(t){const e={text:t.text};return t.message!==void 0&&(e.message=t.message.toDict()),e}var mx=class{constructor(){p(this,"keyEncoder",px)}makeDefaultKeyEncoder(e){this.keyEncoder=e}};const qL=new Map;var gx=class yx extends mx{constructor(r){super();p(this,"cache");this.cache=r??new Map}lookup(r,n){return Promise.resolve(this.cache.get(this.keyEncoder(r,n))??null)}async update(r,n,s){this.cache.set(this.keyEncoder(r,n),s)}static global(){return new yx(qL)}},_x={};ve(_x,{BaseDocumentLoader:()=>wx});var wx=class{},bx={};ve(bx,{LangSmithLoader:()=>HL});var HL=class extends wx{constructor(e){super();p(this,"datasetId");p(this,"datasetName");p(this,"exampleIds");p(this,"asOf");p(this,"splits");p(this,"inlineS3Urls");p(this,"offset");p(this,"limit");p(this,"metadata");p(this,"filter");p(this,"contentKey");p(this,"formatContent");p(this,"client");if(e.client&&e.clientConfig)throw new Error("client and clientConfig cannot both be provided.");this.client=e.client??new eg(e==null?void 0:e.clientConfig),this.contentKey=e.contentKey?e.contentKey.split("."):[],this.formatContent=e.formatContent??GL,this.datasetId=e.datasetId,this.datasetName=e.datasetName,this.exampleIds=e.exampleIds,this.asOf=e.asOf,this.splits=e.splits,this.inlineS3Urls=e.inlineS3Urls,this.offset=e.offset,this.limit=e.limit,this.metadata=e.metadata,this.filter=e.filter}async load(){const e=[];for await(const r of this.client.listExamples({datasetId:this.datasetId,datasetName:this.datasetName,exampleIds:this.exampleIds,asOf:this.asOf,splits:this.splits,inlineS3Urls:this.inlineS3Urls,offset:this.offset,limit:this.limit,metadata:this.metadata,filter:this.filter})){let n=r.inputs;for(const a of this.contentKey)n=n[a];const s=this.formatContent(n),i=r;["created_at","modified_at"].forEach(a=>{a in i&&typeof i[a]=="object"&&(i[a]=i[a].toString())}),e.push({pageContent:s,metadata:i})}return e}};function GL(t){if(typeof t=="string")return t;try{return JSON.stringify(t,null,2)}catch{return String(t)}}var js=class{constructor(t){p(this,"pageContent");p(this,"metadata");p(this,"id");this.pageContent=t.pageContent!==void 0?t.pageContent.toString():"",this.metadata=t.metadata??{},this.id=t.id}},vx=class extends Fe{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","documents","transformers"])}invoke(e,r){return this.transformDocuments(e)}},WL=class extends vx{async transformDocuments(t){const e=[];for(const r of t){const n=await this._transformDocument(r);e.push(n)}return e}},Ex={};ve(Ex,{BaseDocumentTransformer:()=>vx,Document:()=>js,MappingDocumentTransformer:()=>WL});var kg=class extends sn{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","example_selectors","base"])}},Sx=class{async getPromptAsync(t,e){return this.getPrompt(t).partial((e==null?void 0:e.partialVariables)??{})}},JL=class extends Sx{constructor(e,r=[]){super();p(this,"defaultPrompt");p(this,"conditionals");this.defaultPrompt=e,this.conditionals=r}getPrompt(e){for(const[r,n]of this.conditionals)if(r(e))return n;return this.defaultPrompt}};function ZL(t){return t._modelType()==="base_llm"}function KL(t){return t._modelType()==="base_chat_model"}function _b(t){return t.split(/\n| /).length}var XL=class xx extends kg{constructor(r){super(r);p(this,"examples",[]);p(this,"examplePrompt");p(this,"getTextLength",_b);p(this,"maxLength",2048);p(this,"exampleTextLengths",[]);this.examplePrompt=r.examplePrompt,this.maxLength=r.maxLength??2048,this.getTextLength=r.getTextLength??_b}async addExample(r){this.examples.push(r);const n=await this.examplePrompt.format(r);this.exampleTextLengths.push(this.getTextLength(n))}async calculateExampleTextLengths(r,n){if(r.length>0)return r;const{examples:s,examplePrompt:i}=n;return(await Promise.all(s.map(o=>i.format(o)))).map(o=>this.getTextLength(o))}async selectExamples(r){const n=Object.values(r).join(" ");let s=this.maxLength-this.getTextLength(n),i=0;const a=[];for(;s>0&&i<this.examples.length;){const o=s-this.exampleTextLengths[i];if(o<0)break;a.push(this.examples[i]),s=o,i+=1}return a}static async fromExamples(r,n){const s=new xx(n);return await Promise.all(r.map(i=>s.addExample(i))),s}};function hf(t){return Object.keys(t).sort().map(e=>t[e])}var YL=class Tx extends kg{constructor(r){super(r);p(this,"vectorStoreRetriever");p(this,"exampleKeys");p(this,"inputKeys");if(this.exampleKeys=r.exampleKeys,this.inputKeys=r.inputKeys,r.vectorStore!==void 0)this.vectorStoreRetriever=r.vectorStore.asRetriever({k:r.k??4,filter:r.filter});else if(r.vectorStoreRetriever)this.vectorStoreRetriever=r.vectorStoreRetriever;else throw new Error('You must specify one of "vectorStore" and "vectorStoreRetriever".')}async addExample(r){const n=this.inputKeys??Object.keys(r),s=hf(n.reduce((i,a)=>({...i,[a]:r[a]}),{})).join(" ");await this.vectorStoreRetriever.addDocuments([new js({pageContent:s,metadata:r})])}async selectExamples(r){const n=this.inputKeys??Object.keys(r),s=hf(n.reduce((o,c)=>({...o,[c]:r[c]}),{})).join(" "),a=(await this.vectorStoreRetriever.invoke(s)).map(o=>o.metadata);return this.exampleKeys?a.map(o=>this.exampleKeys.reduce((c,l)=>({...c,[l]:o[l]}),{})):a}static async fromExamples(r,n,s,i={}){const a=i.inputKeys??null,o=r.map(l=>hf(a?a.reduce((u,d)=>({...u,[d]:l[d]}),{}):l).join(" ")),c=await s.fromTexts(o,r,n,i);return new Tx({vectorStore:c,k:i.k??4,exampleKeys:i.exampleKeys,inputKeys:i.inputKeys})}},Ax={};ve(Ax,{BaseExampleSelector:()=>kg,BasePromptSelector:()=>Sx,ConditionalPromptSelector:()=>JL,LengthBasedExampleSelector:()=>XL,SemanticSimilarityExampleSelector:()=>YL,isChatModel:()=>KL,isLLM:()=>ZL});const Np="10f90ea3-90a4-4962-bf75-83a0f3c1c62a";var QL=class extends sn{constructor(){super(...arguments);p(this,"lc_namespace",["langchain","recordmanagers"])}},Cx=class{constructor(t){p(this,"uid");p(this,"hash_");p(this,"contentHash");p(this,"metadataHash");p(this,"pageContent");p(this,"metadata");p(this,"keyEncoder",Cg);this.uid=t.uid,this.pageContent=t.pageContent,this.metadata=t.metadata}makeDefaultKeyEncoder(t){this.keyEncoder=t}calculateHashes(){const t=["hash_","content_hash","metadata_hash"];for(const r of t)if(r in this.metadata)throw new Error(`Metadata cannot contain key ${r} as it is reserved for internal use. Restricted keys: [${t.join(", ")}]`);const e=this._hashStringToUUID(this.pageContent);try{const r=this._hashNestedDictToUUID(this.metadata);this.contentHash=e,this.metadataHash=r}catch(r){throw new Error(`Failed to hash metadata: ${r}. Please use a dict that can be serialized using json.`)}this.hash_=this._hashStringToUUID(this.contentHash+this.metadataHash),this.uid||(this.uid=this.hash_)}toDocument(){return new js({pageContent:this.pageContent,metadata:this.metadata})}static fromDocument(t,e){const r=new this({pageContent:t.pageContent,metadata:t.metadata,uid:e||t.uid});return r.calculateHashes(),r}_hashStringToUUID(t){const e=this.keyEncoder(t);return a_(e,Np)}_hashNestedDictToUUID(t){const e=JSON.stringify(t,Object.keys(t).sort()),r=this.keyEncoder(e);return a_(r,Np)}};function kx(t,e){const r=[];let n=[];return e.forEach(s=>{n.push(s),n.length>=t&&(r.push(n),n=[])}),n.length>0&&r.push(n),r}function Ix(t){const e=new Set,r=[];for(const n of t){if(!n.hash_)throw new Error("Hashed document does not have a hash");e.has(n.hash_)||(e.add(n.hash_),r.push(n))}return r}function Rx(t){if(t===null)return e=>null;if(typeof t=="string")return e=>e.metadata[t];if(typeof t=="function")return t;throw new Error(`sourceIdKey should be null, a string or a function, got ${typeof t}`)}const Ox=t=>"load"in t&&typeof t.load=="function"&&"loadAndSplit"in t&&typeof t.loadAndSplit=="function";async function eM(t){const{docsSource:e,recordManager:r,vectorStore:n,options:s}=t,{batchSize:i=100,cleanup:a,sourceIdKey:o,cleanupBatchSize:c=1e3,forceUpdate:l=!1}=s??{};if(a==="incremental"&&!o)throw new Error("sourceIdKey is required when cleanup mode is incremental. Please provide through 'options.sourceIdKey'.");const u=Ox(e)?await e.load():e,d=Rx(o??null),h=await r.getTime();let f=0,m=0,g=0,y=0;const b=kx(i??100,u);for(const _ of b){const E=Ix(_.map(B=>Cx.fromDocument(B))),C=E.map(B=>d(B));a==="incremental"&&E.forEach((B,q)=>{if(C[q]===null)throw new Error("sourceIdKey must be provided when cleanup is incremental")});const k=await r.exists(E.map(B=>B.uid)),R=[],$=[],S=[],M=new Set;if(E.forEach((B,q)=>{if(k[q])if(l)M.add(B.uid);else{S.push(B.uid);return}R.push(B.uid),$.push(B.toDocument())}),S.length>0&&(await r.update(S,{timeAtLeast:h}),y+=S.length),$.length>0&&(await n.addDocuments($,{ids:R}),f+=$.length-M.size,g+=M.size),await r.update(E.map(B=>B.uid),{timeAtLeast:h,groupIds:C}),a==="incremental"){C.forEach(q=>{if(!q)throw new Error("Source id cannot be null")});const B=await r.listKeys({before:h,groupIds:C});B.length>0&&(await n.delete({ids:B}),await r.deleteKeys(B),m+=B.length)}}if(a==="full"){let _=await r.listKeys({before:h,limit:c});for(;_.length>0;)await n.delete({ids:_}),await r.deleteKeys(_),m+=_.length,_=await r.listKeys({before:h,limit:c})}return{numAdded:f,numDeleted:m,numUpdated:g,numSkipped:y}}var $x={};ve($x,{RecordManager:()=>QL,UUIDV5_NAMESPACE:()=>Np,_HashedDocument:()=>Cx,_batch:()=>kx,_deduplicateInOrder:()=>Ix,_getSourceIdAssigner:()=>Rx,_isBaseDocumentLoader:()=>Ox,index:()=>eM});var Ga={},wb;function tM(){if(wb)return Ga;wb=1,Ga.byteLength=o,Ga.toByteArray=l,Ga.fromByteArray=h;for(var t=[],e=[],r=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,i=n.length;s<i;++s)t[s]=n[s],e[n.charCodeAt(s)]=s;e[45]=62,e[95]=63;function a(f){var m=f.length;if(m%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var g=f.indexOf("=");g===-1&&(g=m);var y=g===m?0:4-g%4;return[g,y]}function o(f){var m=a(f),g=m[0],y=m[1];return(g+y)*3/4-y}function c(f,m,g){return(m+g)*3/4-g}function l(f){var m,g=a(f),y=g[0],b=g[1],_=new r(c(f,y,b)),E=0,C=b>0?y-4:y,k;for(k=0;k<C;k+=4)m=e[f.charCodeAt(k)]<<18|e[f.charCodeAt(k+1)]<<12|e[f.charCodeAt(k+2)]<<6|e[f.charCodeAt(k+3)],_[E++]=m>>16&255,_[E++]=m>>8&255,_[E++]=m&255;return b===2&&(m=e[f.charCodeAt(k)]<<2|e[f.charCodeAt(k+1)]>>4,_[E++]=m&255),b===1&&(m=e[f.charCodeAt(k)]<<10|e[f.charCodeAt(k+1)]<<4|e[f.charCodeAt(k+2)]>>2,_[E++]=m>>8&255,_[E++]=m&255),_}function u(f){return t[f>>18&63]+t[f>>12&63]+t[f>>6&63]+t[f&63]}function d(f,m,g){for(var y,b=[],_=m;_<g;_+=3)y=(f[_]<<16&16711680)+(f[_+1]<<8&65280)+(f[_+2]&255),b.push(u(y));return b.join("")}function h(f){for(var m,g=f.length,y=g%3,b=[],_=16383,E=0,C=g-y;E<C;E+=_)b.push(d(f,E,E+_>C?C:E+_));return y===1?(m=f[g-1],b.push(t[m>>2]+t[m<<4&63]+"==")):y===2&&(m=(f[g-2]<<8)+f[g-1],b.push(t[m>>10]+t[m>>4&63]+t[m<<2&63]+"=")),b.join("")}return Ga}var rM=tM();const nM=Pa(rM);var sM=Object.defineProperty,iM=(t,e,r)=>e in t?sM(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,aM=(t,e,r)=>(iM(t,e+"",r),r);function oM(t,e){let r=Array.from({length:t.length},(n,s)=>({start:s,end:s+1}));for(;r.length>1;){let n=null;for(let s=0;s<r.length-1;s++){const i=t.slice(r[s].start,r[s+1].end),a=e.get(i.join(","));a!=null&&(n==null||a<n[0])&&(n=[a,s])}if(n!=null){const s=n[1];r[s]={start:r[s].start,end:r[s+1].end},r.splice(s+1,1)}else break}return r}function cM(t,e){return t.length===1?[e.get(t.join(","))]:oM(t,e).map(r=>e.get(t.slice(r.start,r.end).join(","))).filter(r=>r!=null)}function lM(t){return t.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Pp=class{constructor(t,e){p(this,"specialTokens");p(this,"inverseSpecialTokens");p(this,"patStr");p(this,"textEncoder",new TextEncoder);p(this,"textDecoder",new TextDecoder("utf-8"));p(this,"rankMap",new Map);p(this,"textMap",new Map);this.patStr=t.pat_str;const r=t.bpe_ranks.split(`
`).filter(Boolean).reduce((n,s)=>{const[i,a,...o]=s.split(" "),c=Number.parseInt(a,10);return o.forEach((l,u)=>n[l]=c+u),n},{});for(const[n,s]of Object.entries(r)){const i=nM.toByteArray(n);this.rankMap.set(i.join(","),s),this.textMap.set(s,i)}this.specialTokens={...t.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[s,i])=>(n[i]=this.textEncoder.encode(s),n),{})}encode(t,e=[],r="all"){const n=new RegExp(this.patStr,"ug"),s=Pp.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(r==="all"?Object.keys(this.specialTokens).filter(l=>!a.has(l)):r);if(o.size>0){const l=Pp.specialTokenRegex([...o]),u=t.match(l);if(u!=null)throw new Error(`The text contains a special token that is not allowed: ${u[0]}`)}let c=0;for(;;){let l=null,u=c;for(;s.lastIndex=u,l=s.exec(t),!(l==null||a.has(l[0]));)u=l.index+1;const d=(l==null?void 0:l.index)??t.length;for(const f of t.substring(c,d).matchAll(n)){const m=this.textEncoder.encode(f[0]),g=this.rankMap.get(m.join(","));if(g!=null){i.push(g);continue}i.push(...cM(m,this.rankMap))}if(l==null)break;let h=this.specialTokens[l[0]];i.push(h),c=l.index+l[0].length}return i}decode(t){const e=[];let r=0;for(let i=0;i<t.length;++i){const a=t[i],o=this.textMap.get(a)??this.inverseSpecialTokens[a];o!=null&&(e.push(o),r+=o.length)}const n=new Uint8Array(r);let s=0;for(const i of e)n.set(i,s),s+=i.length;return this.textDecoder.decode(n)}},Nx=Pp;aM(Nx,"specialTokenRegex",t=>new RegExp(t.map(e=>lM(e)).join("|"),"g"));function uM(t){switch(t){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}var Px={};ve(Px,{encodingForModel:()=>Ig,getEncoding:()=>Lx});const Gc={},dM=new gc({});async function Lx(t){return t in Gc||(Gc[t]=dM.fetch(`https://tiktoken.pages.dev/js/${t}.json`).then(e=>e.json()).then(e=>new Nx(e)).catch(e=>{throw delete Gc[t],e})),await Gc[t]}async function Ig(t){return Lx(uM(t))}var Mx={};ve(Mx,{BaseLangChain:()=>Rg,BaseLanguageModel:()=>Og,calculateMaxTokens:()=>fM,getEmbeddingContextSize:()=>hM,getModelContextSize:()=>Dx,getModelNameForTiktoken:()=>hd,isOpenAITool:()=>fd});const hd=t=>t.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":t.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":t.startsWith("gpt-4-32k")?"gpt-4-32k":t.startsWith("gpt-4-")?"gpt-4":t.startsWith("gpt-4o")?"gpt-4o":t,hM=t=>{switch(t){case"text-embedding-ada-002":return 8191;default:return 2046}},Dx=t=>{switch(hd(t)){case"gpt-3.5-turbo-16k":return 16384;case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":return 4097;case"text-curie-001":return 2048;case"text-babbage-001":return 2048;case"text-ada-001":return 2048;case"code-davinci-002":return 8e3;case"code-cushman-001":return 2048;default:return 4097}};function fd(t){return typeof t!="object"||!t?!1:!!("type"in t&&t.type==="function"&&"function"in t&&typeof t.function=="object"&&t.function&&"name"in t.function&&"parameters"in t.function)}const fM=async({prompt:t,modelName:e})=>{let r;try{r=(await Ig(hd(e))).encode(t).length}catch{console.warn("Failed to calculate number of tokens, falling back to approximate count"),r=Math.ceil(t.length/4)}return Dx(e)-r},pM=()=>!1;var Rg=class extends Fe{constructor(e){super(e);p(this,"verbose");p(this,"callbacks");p(this,"tags");p(this,"metadata");this.verbose=e.verbose??pM(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}get lc_attributes(){return{callbacks:void 0,verbose:void 0}}},Og=class extends Rg{constructor({callbacks:e,callbackManager:r,...n}){const{cache:s,...i}=n;super({callbacks:e??r,...i});p(this,"caller");p(this,"cache");p(this,"_encoding");typeof s=="object"?this.cache=s:s?this.cache=gx.global():this.cache=void 0,this.caller=new gc(n??{})}get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}async getNumTokens(e){let r;typeof e=="string"?r=e:r=e.map(s=>typeof s=="string"?s:s.type==="text"&&"text"in s?s.text:"").join("");let n=Math.ceil(r.length/4);if(!this._encoding)try{this._encoding=await Ig("modelName"in this?hd(this.modelName):"gpt2")}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}if(this._encoding)try{n=this._encoding.encode(r).length}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}return n}static _convertInputToPromptValue(e){return typeof e=="string"?new Sg(e):Array.isArray(e)?new xg(e.map(Hn)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...r}){const n={...this._identifyingParams(),...r,_type:this._llmType(),_model:this._modelType()};return Object.entries(n).filter(([a,o])=>o!==void 0).map(([a,o])=>`${a}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}},_s=class extends Fe{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"func");e&&(this.func=e.func)}static lc_name(){return"RunnablePassthrough"}async invoke(e,r){const n=Ve(r);return this.func&&await this.func(e,n),this._callWithConfig(s=>Promise.resolve(s),e,n)}async*transform(e,r){const n=Ve(r);let s,i=!0;for await(const a of this._transformStreamWithConfig(e,o=>o,n))if(yield a,i)if(s===void 0)s=a;else try{s=Gs(s,a)}catch{s=void 0,i=!1}this.func&&s!==void 0&&await this.func(s,n)}static assign(e){return new wg(new Ua({steps:e}))}};const mM=t=>t();function ff(t){const e=t.constructor;return new e({...t,content:t.contentBlocks,response_metadata:{...t.response_metadata,output_version:"v1"}})}var Ux={};ve(Ux,{BaseChatModel:()=>Bi,SimpleChatModel:()=>gM});function pf(t){const e=[];for(const r of t){let n=r;if(Array.isArray(r.content))for(let s=0;s<r.content.length;s++){const i=r.content[s];(Bm(i)||jm(i))&&n===r&&(n=new r.constructor({...n,content:[...r.content.slice(0,s),aE(i),...r.content.slice(s+1)]}))}e.push(n)}return e}var Bi=class ai extends Og{constructor(r){super(r);p(this,"lc_namespace",["langchain","chat_models",this._llmType()]);p(this,"disableStreaming",!1);p(this,"outputVersion");this.outputVersion=mM(()=>{const n=r.outputVersion??rn("LC_OUTPUT_VERSION");return n&&["v0","v1"].includes(n)?n:"v0"})}get callKeys(){return[...super.callKeys,"outputVersion"]}_separateRunnableConfigFromCallOptionsCompat(r){const[n,s]=super._separateRunnableConfigFromCallOptions(r);return s.signal=n.signal,[n,s]}async invoke(r,n){const s=ai._convertInputToPromptValue(r);return(await this.generatePrompt([s],n,n==null?void 0:n.callbacks)).generations[0][0].message}async*_streamResponseChunks(r,n,s){throw new Error("Not implemented.")}async*_streamIterator(r,n){var s;if(this._streamResponseChunks===ai.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(r,n);else{const a=ai._convertInputToPromptValue(r).toChatMessages(),[o,c]=this._separateRunnableConfigFromCallOptionsCompat(n),l={...o.metadata,...this.getLsParams(c)},u=await pr.configure(o.callbacks,this.callbacks,o.tags,this.tags,l,this.metadata,{verbose:this.verbose}),d={options:c,invocation_params:this==null?void 0:this.invocationParams(c),batch_size:1},h=c.outputVersion??this.outputVersion,f=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),[pf(a)],o.runId,void 0,d,void 0,void 0,o.runName));let m,g;try{for await(const y of this._streamResponseChunks(a,c,f==null?void 0:f[0])){if(y.message.id==null){const b=(s=f==null?void 0:f.at(0))==null?void 0:s.runId;b!=null&&y.message._updateId(`run-${b}`)}y.message.response_metadata={...y.generationInfo,...y.message.response_metadata},h==="v1"?yield ff(y.message):yield y.message,m?m=m.concat(y):m=y,dp(y.message)&&y.message.usage_metadata!==void 0&&(g={tokenUsage:{promptTokens:y.message.usage_metadata.input_tokens,completionTokens:y.message.usage_metadata.output_tokens,totalTokens:y.message.usage_metadata.total_tokens}})}}catch(y){throw await Promise.all((f??[]).map(b=>b==null?void 0:b.handleLLMError(y))),y}await Promise.all((f??[]).map(y=>y==null?void 0:y.handleLLMEnd({generations:[[m]],llmOutput:g})))}}getLsParams(r){const n=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:r.stop,ls_provider:n}}async _generateUncached(r,n,s,i){var f,m;const a=r.map(g=>g.map(Hn));let o;if(i!==void 0&&i.length===a.length)o=i;else{const g={...s.metadata,...this.getLsParams(n)},y=await pr.configure(s.callbacks,this.callbacks,s.tags,this.tags,g,this.metadata,{verbose:this.verbose}),b={options:n,invocation_params:this==null?void 0:this.invocationParams(n),batch_size:1};o=await(y==null?void 0:y.handleChatModelStart(this.toJSON(),a.map(pf),s.runId,void 0,b,void 0,void 0,s.runName))}const c=n.outputVersion??this.outputVersion,l=[],u=[];if(!!(o!=null&&o[0].handlers.find(Gm))&&!this.disableStreaming&&a.length===1&&this._streamResponseChunks!==ai.prototype._streamResponseChunks)try{const g=await this._streamResponseChunks(a[0],n,o==null?void 0:o[0]);let y,b;for await(const _ of g){if(_.message.id==null){const E=(f=o==null?void 0:o.at(0))==null?void 0:f.runId;E!=null&&_.message._updateId(`run-${E}`)}y===void 0?y=_:y=Gs(y,_),dp(_.message)&&_.message.usage_metadata!==void 0&&(b={tokenUsage:{promptTokens:_.message.usage_metadata.input_tokens,completionTokens:_.message.usage_metadata.output_tokens,totalTokens:_.message.usage_metadata.total_tokens}})}if(y===void 0)throw new Error("Received empty response from chat model call.");l.push([y]),await(o==null?void 0:o[0].handleLLMEnd({generations:l,llmOutput:b}))}catch(g){throw await(o==null?void 0:o[0].handleLLMError(g)),g}else{const g=await Promise.allSettled(a.map(async(y,b)=>{const _=await this._generate(y,{...n,promptIndex:b},o==null?void 0:o[b]);if(c==="v1")for(const E of _.generations)E.message=ff(E.message);return _}));await Promise.all(g.map(async(y,b)=>{var _,E,C;if(y.status==="fulfilled"){const k=y.value;for(const R of k.generations){if(R.message.id==null){const $=(_=o==null?void 0:o.at(0))==null?void 0:_.runId;$!=null&&R.message._updateId(`run-${$}`)}R.message.response_metadata={...R.generationInfo,...R.message.response_metadata}}return k.generations.length===1&&(k.generations[0].message.response_metadata={...k.llmOutput,...k.generations[0].message.response_metadata}),l[b]=k.generations,u[b]=k.llmOutput,(E=o==null?void 0:o[b])==null?void 0:E.handleLLMEnd({generations:[k.generations],llmOutput:k.llmOutput})}else return await((C=o==null?void 0:o[b])==null?void 0:C.handleLLMError(y.reason)),Promise.reject(y.reason)}))}const h={generations:l,llmOutput:u.length?(m=this._combineLLMOutput)==null?void 0:m.call(this,...u):void 0};return Object.defineProperty(h,Do,{value:o?{runIds:o==null?void 0:o.map(g=>g.runId)}:void 0,configurable:!0}),h}async _generateCached({messages:r,cache:n,llmStringKey:s,parsedOptions:i,handledOptions:a}){const o=r.map(_=>_.map(Hn)),c={...a.metadata,...this.getLsParams(i)},l=await pr.configure(a.callbacks,this.callbacks,a.tags,this.tags,c,this.metadata,{verbose:this.verbose}),u={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},d=await(l==null?void 0:l.handleChatModelStart(this.toJSON(),o.map(pf),a.runId,void 0,u,void 0,void 0,a.runName)),h=[],m=(await Promise.allSettled(o.map(async(_,E)=>{const C=ai._convertInputToPromptValue(_).toString(),k=await n.lookup(C,s);return k==null&&h.push(E),k}))).map((_,E)=>({result:_,runManager:d==null?void 0:d[E]})).filter(({result:_})=>_.status==="fulfilled"&&_.value!=null||_.status==="rejected"),g=i.outputVersion??this.outputVersion,y=[];await Promise.all(m.map(async({result:_,runManager:E},C)=>{if(_.status==="fulfilled"){const k=_.value;return y[C]=k.map(R=>("message"in R&&St(R.message)&&ms(R.message)&&(R.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0},g==="v1"&&(R.message=ff(R.message))),R.generationInfo={...R.generationInfo,tokenUsage:{}},R)),k.length&&await(E==null?void 0:E.handleLLMNewToken(k[0].text)),E==null?void 0:E.handleLLMEnd({generations:[k]},void 0,void 0,void 0,{cached:!0})}else return await(E==null?void 0:E.handleLLMError(_.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(_.reason)}));const b={generations:y,missingPromptIndices:h,startedRunManagers:d};return Object.defineProperty(b,Do,{value:d?{runIds:d==null?void 0:d.map(_=>_.runId)}:void 0,configurable:!0}),b}async generate(r,n,s){let i;Array.isArray(n)?i={stop:n}:i=n;const a=r.map(g=>g.map(Hn)),[o,c]=this._separateRunnableConfigFromCallOptionsCompat(i);if(o.callbacks=o.callbacks??s,!this.cache)return this._generateUncached(a,c,o);const{cache:l}=this,u=this._getSerializedCacheKeyParametersForCall(c),{generations:d,missingPromptIndices:h,startedRunManagers:f}=await this._generateCached({messages:a,cache:l,llmStringKey:u,parsedOptions:c,handledOptions:o});let m={};if(h.length>0){const g=await this._generateUncached(h.map(y=>a[y]),c,o,f!==void 0?h.map(y=>f==null?void 0:f[y]):void 0);await Promise.all(g.generations.map(async(y,b)=>{const _=h[b];d[_]=y;const E=ai._convertInputToPromptValue(a[_]).toString();return l.update(E,u,y)})),m=g.llmOutput??{}}return{generations:d,llmOutput:m}}invocationParams(r){return{}}_modelType(){return"base_chat_model"}async generatePrompt(r,n,s){const i=r.map(a=>a.toChatMessages());return this.generate(i,n,s)}withStructuredOutput(r,n){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(n!=null&&n.strict)throw new Error('"strict" mode is not supported for this model by default.');const s=r,i=n==null?void 0:n.name,a=Ri(s)??"A function available to call.",o=n==null?void 0:n.method,c=n==null?void 0:n.includeRaw;if(o==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let l=i??"extract",u;tn(s)?u=[{type:"function",function:{name:l,description:a,parameters:ar(s)}}]:("name"in s&&(l=s.name),u=[{type:"function",function:{name:l,description:a,parameters:s}}]);const d=this.bindTools(u),h=Cn.from(y=>{if(!At.isInstance(y))throw new Error("Input is not an AIMessageChunk.");if(!y.tool_calls||y.tool_calls.length===0)throw new Error("No tool calls found in the response.");const b=y.tool_calls.find(_=>_.name===l);if(!b)throw new Error(`No tool call found with name ${l}.`);return b.args});if(!c)return d.pipe(h).withConfig({runName:"StructuredOutput"});const f=_s.assign({parsed:(y,b)=>h.invoke(y.raw,b)}),m=_s.assign({parsed:()=>null}),g=f.withFallbacks({fallbacks:[m]});return Zn.from([{raw:d},g]).withConfig({runName:"StructuredOutputRunnable"})}},gM=class extends Bi{async _generate(t,e,r){const n=await this._call(t,e,r),s=new ht(n);if(typeof s.content!="string")throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:s.content,message:s}]}}},Bx={};ve(Bx,{BaseLLM:()=>jx,LLM:()=>$g});var jx=class to extends Og{constructor(){super(...arguments);p(this,"lc_namespace",["langchain","llms",this._llmType()])}async invoke(r,n){const s=to._convertInputToPromptValue(r);return(await this.generatePrompt([s],n,n==null?void 0:n.callbacks)).generations[0][0].text}async*_streamResponseChunks(r,n,s){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptionsCompat(r){const[n,s]=super._separateRunnableConfigFromCallOptions(r);return s.signal=n.signal,[n,s]}async*_streamIterator(r,n){if(this._streamResponseChunks===to.prototype._streamResponseChunks)yield this.invoke(r,n);else{const s=to._convertInputToPromptValue(r),[i,a]=this._separateRunnableConfigFromCallOptionsCompat(n),o=await pr.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},l=await(o==null?void 0:o.handleLLMStart(this.toJSON(),[s.toString()],i.runId,void 0,c,void 0,void 0,i.runName));let u=new va({text:""});try{for await(const d of this._streamResponseChunks(s.toString(),a,l==null?void 0:l[0]))u?u=u.concat(d):u=d,typeof d.text=="string"&&(yield d.text)}catch(d){throw await Promise.all((l??[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}await Promise.all((l??[]).map(d=>d==null?void 0:d.handleLLMEnd({generations:[[u]]})))}}async generatePrompt(r,n,s){const i=r.map(a=>a.toString());return this.generate(i,n,s)}invocationParams(r){return{}}_flattenLLMResult(r){const n=[];for(let s=0;s<r.generations.length;s+=1){const i=r.generations[s];if(s===0)n.push({generations:[i],llmOutput:r.llmOutput});else{const a=r.llmOutput?{...r.llmOutput,tokenUsage:{}}:void 0;n.push({generations:[i],llmOutput:a})}}return n}async _generateUncached(r,n,s,i){let a;if(i!==void 0&&i.length===r.length)a=i;else{const u=await pr.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),d={options:n,invocation_params:this==null?void 0:this.invocationParams(n),batch_size:r.length};a=await(u==null?void 0:u.handleLLMStart(this.toJSON(),r,s.runId,void 0,d,void 0,void 0,s==null?void 0:s.runName))}const o=!!(a!=null&&a[0].handlers.find(Gm));let c;if(o&&r.length===1&&this._streamResponseChunks!==to.prototype._streamResponseChunks)try{const u=await this._streamResponseChunks(r[0],n,a==null?void 0:a[0]);let d;for await(const h of u)d===void 0?d=h:d=Gs(d,h);if(d===void 0)throw new Error("Received empty response from chat model call.");c={generations:[[d]],llmOutput:{}},await(a==null?void 0:a[0].handleLLMEnd(c))}catch(u){throw await(a==null?void 0:a[0].handleLLMError(u)),u}else{try{c=await this._generate(r,n,a==null?void 0:a[0])}catch(d){throw await Promise.all((a??[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}const u=this._flattenLLMResult(c);await Promise.all((a??[]).map((d,h)=>d==null?void 0:d.handleLLMEnd(u[h])))}const l=(a==null?void 0:a.map(u=>u.runId))||void 0;return Object.defineProperty(c,Do,{value:l?{runIds:l}:void 0,configurable:!0}),c}async _generateCached({prompts:r,cache:n,llmStringKey:s,parsedOptions:i,handledOptions:a,runId:o}){const c=await pr.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:r.length},u=await(c==null?void 0:c.handleLLMStart(this.toJSON(),r,o,void 0,l,void 0,void 0,a==null?void 0:a.runName)),d=[],f=(await Promise.allSettled(r.map(async(y,b)=>{const _=await n.lookup(y,s);return _==null&&d.push(b),_}))).map((y,b)=>({result:y,runManager:u==null?void 0:u[b]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),m=[];await Promise.all(f.map(async({result:y,runManager:b},_)=>{if(y.status==="fulfilled"){const E=y.value;return m[_]=E.map(C=>(C.generationInfo={...C.generationInfo,tokenUsage:{}},C)),E.length&&await(b==null?void 0:b.handleLLMNewToken(E[0].text)),b==null?void 0:b.handleLLMEnd({generations:[E]},void 0,void 0,void 0,{cached:!0})}else return await(b==null?void 0:b.handleLLMError(y.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(y.reason)}));const g={generations:m,missingPromptIndices:d,startedRunManagers:u};return Object.defineProperty(g,Do,{value:u?{runIds:u==null?void 0:u.map(y=>y.runId)}:void 0,configurable:!0}),g}async generate(r,n,s){if(!Array.isArray(r))throw new Error("Argument 'prompts' is expected to be a string[]");let i;Array.isArray(n)?i={stop:n}:i=n;const[a,o]=this._separateRunnableConfigFromCallOptionsCompat(i);if(a.callbacks=a.callbacks??s,!this.cache)return this._generateUncached(r,o,a);const{cache:c}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:u,missingPromptIndices:d,startedRunManagers:h}=await this._generateCached({prompts:r,cache:c,llmStringKey:l,parsedOptions:o,handledOptions:a,runId:a.runId});let f={};if(d.length>0){const m=await this._generateUncached(d.map(g=>r[g]),o,a,h!==void 0?d.map(g=>h==null?void 0:h[g]):void 0);await Promise.all(m.generations.map(async(g,y)=>{const b=d[y];return u[b]=g,c.update(r[b],l,g)})),f=m.llmOutput??{}}return{generations:u,llmOutput:f}}_identifyingParams(){return{}}_modelType(){return"base_llm"}},$g=class extends jx{async _generate(t,e,r){return{generations:await Promise.all(t.map((s,i)=>this._call(s,{...e,promptIndex:i},r).then(a=>[{text:a}])))}}},yM=class extends Fe{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"runnables");this.runnables=e.runnables}static lc_name(){return"RouterRunnable"}async invoke(e,r){const{key:n,input:s}=e,i=this.runnables[n];if(i===void 0)throw new Error(`No runnable associated with key "${n}".`);return i.invoke(s,Ve(r))}async batch(e,r,n){var h;const s=e.map(f=>f.key),i=e.map(f=>f.input);if(s.find(f=>this.runnables[f]===void 0)!==void 0)throw new Error("One or more keys do not have a corresponding runnable.");const o=s.map(f=>this.runnables[f]),c=this._getOptionsList(r??{},e.length),l=((h=c[0])==null?void 0:h.maxConcurrency)??(n==null?void 0:n.maxConcurrency),u=l&&l>0?l:e.length,d=[];for(let f=0;f<i.length;f+=u){const m=i.slice(f,f+u).map((y,b)=>o[b].invoke(y,c[b])),g=await Promise.all(m);d.push(g)}return d.flat()}async stream(e,r){const{key:n,input:s}=e,i=this.runnables[n];if(i===void 0)throw new Error(`No runnable associated with key "${n}".`);return i.stream(s,r)}},_M=class extends Fe{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"default");p(this,"branches");this.branches=e.branches,this.default=e.default}static lc_name(){return"RunnableBranch"}static from(e){if(e.length<1)throw new Error("RunnableBranch requires at least one branch");const n=e.slice(0,-1).map(([i,a])=>[Yt(i),Yt(a)]),s=Yt(e[e.length-1]);return new this({branches:n,default:s})}async _invoke(e,r,n){let s;for(let i=0;i<this.branches.length;i+=1){const[a,o]=this.branches[i];if(await a.invoke(e,Ze(r,{callbacks:n==null?void 0:n.getChild(`condition:${i+1}`)}))){s=await o.invoke(e,Ze(r,{callbacks:n==null?void 0:n.getChild(`branch:${i+1}`)}));break}}return s||(s=await this.default.invoke(e,Ze(r,{callbacks:n==null?void 0:n.getChild("branch:default")}))),s}async invoke(e,r={}){return this._callWithConfig(this._invoke,e,r)}async*_streamIterator(e,r){const n=await Ar(r),s=await(n==null?void 0:n.handleChainStart(this.toJSON(),Nt(e,"input"),r==null?void 0:r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));let i,a=!0,o;try{for(let c=0;c<this.branches.length;c+=1){const[l,u]=this.branches[c];if(await l.invoke(e,Ze(r,{callbacks:s==null?void 0:s.getChild(`condition:${c+1}`)}))){o=await u.stream(e,Ze(r,{callbacks:s==null?void 0:s.getChild(`branch:${c+1}`)}));for await(const h of o)if(yield h,a)if(i===void 0)i=h;else try{i=Gs(i,h)}catch{i=void 0,a=!1}break}}if(o===void 0){o=await this.default.stream(e,Ze(r,{callbacks:s==null?void 0:s.getChild("branch:default")}));for await(const c of o)if(yield c,a)if(i===void 0)i=c;else try{i=Gs(i,c)}catch{i=void 0,a=!1}}}catch(c){throw await(s==null?void 0:s.handleChainError(c)),c}await(s==null?void 0:s.handleChainEnd(i??{}))}},wM=class extends Zs{constructor(e){let r=Cn.from((a,o)=>this._enterHistory(a,o??{})).withConfig({runName:"loadHistory"});const n=e.historyMessagesKey??e.inputMessagesKey;n&&(r=_s.assign({[n]:r}).withConfig({runName:"insertHistory"}));const s=r.pipe(e.runnable.withListeners({onEnd:(a,o)=>this._exitHistory(a,o??{})})).withConfig({runName:"RunnableWithMessageHistory"}),i=e.config??{};super({...e,config:i,bound:s});p(this,"runnable");p(this,"inputMessagesKey");p(this,"outputMessagesKey");p(this,"historyMessagesKey");p(this,"getMessageHistory");this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let r;if(typeof e=="object"&&!Array.isArray(e)&&!St(e)){let n;this.inputMessagesKey?n=this.inputMessagesKey:Object.keys(e).length===1?n=Object.keys(e)[0]:n="input",Array.isArray(e[n])&&Array.isArray(e[n][0])?r=e[n][0]:r=e[n]}else r=e;if(typeof r=="string")return[new ut(r)];if(Array.isArray(r))return r;if(St(r))return[r];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(r,null,2)}`)}_getOutputMessages(e){let r;if(!Array.isArray(e)&&!St(e)&&typeof e!="string"){let n;this.outputMessagesKey!==void 0?n=this.outputMessagesKey:Object.keys(e).length===1?n=Object.keys(e)[0]:n="output",e.generations!==void 0?r=e.generations[0][0].message:r=e[n]}else r=e;if(typeof r=="string")return[new ht(r)];if(Array.isArray(r))return r;if(St(r))return[r];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(r,null,2)}`)}async _enterHistory(e,r){var i;const s=await((i=r==null?void 0:r.configurable)==null?void 0:i.messageHistory).getMessages();return this.historyMessagesKey===void 0?s.concat(this._getInputMessages(e)):s}async _exitHistory(e,r){var c;const n=(c=r.configurable)==null?void 0:c.messageHistory;let s;Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?s=e.inputs[0]:s=e.inputs;let i=this._getInputMessages(s);if(this.historyMessagesKey===void 0){const l=await n.getMessages();i=i.slice(l.length)}const a=e.outputs;if(!a)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);const o=this._getOutputMessages(a);await n.addMessages([...i,...o])}async _mergeConfig(...e){const r=await super._mergeConfig(...e);if(!r.configurable||!r.configurable.sessionId){const s={[this.inputMessagesKey??"input"]:"foo"},i={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(s)}, ${JSON.stringify(i)})`)}const{sessionId:n}=r.configurable;return r.configurable.messageHistory=await this.getMessageHistory(n),r}},Fx={};ve(Fx,{RouterRunnable:()=>yM,Runnable:()=>Fe,RunnableAssign:()=>wg,RunnableBinding:()=>Zs,RunnableBranch:()=>_M,RunnableEach:()=>bL,RunnableLambda:()=>Cn,RunnableMap:()=>Ua,RunnableParallel:()=>SL,RunnablePassthrough:()=>_s,RunnablePick:()=>XS,RunnableRetry:()=>_g,RunnableSequence:()=>Zn,RunnableToolLike:()=>$p,RunnableWithFallbacks:()=>KS,RunnableWithMessageHistory:()=>wM,_coerceToRunnable:()=>Yt,ensureConfig:()=>Ve,getCallbackManagerForConfig:()=>Ar,mergeConfigs:()=>en,patchConfig:()=>Ze,pickRunnableConfigKeys:()=>gs});var zx={};ve(zx,{applyPatch:()=>ba,compare:()=>ad});var pd=class extends Fe{parseResultWithPrompt(t,e,r){return this.parseResult(t,r)}_baseMessageToString(t){return typeof t.content=="string"?t.content:this._baseMessageContentToString(t.content)}_baseMessageContentToString(t){return JSON.stringify(t)}async invoke(t,e){return typeof t=="string"?this._callWithConfig(async(r,n)=>this.parseResult([{text:r}],n==null?void 0:n.callbacks),t,{...e,runType:"parser"}):this._callWithConfig(async(r,n)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],n==null?void 0:n.callbacks),t,{...e,runType:"parser"})}},yc=class extends pd{parseResult(t,e){return this.parse(t[0].text,e)}async parseWithPrompt(t,e,r){return this.parse(t,r)}_type(){throw new Error("_type not implemented")}},hs=class extends Error{constructor(e,r,n,s=!1){super(e);p(this,"llmOutput");p(this,"observation");p(this,"sendToLLM");if(this.llmOutput=r,this.observation=n,this.sendToLLM=s,s&&(n===void 0||r===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");id(this,"OUTPUT_PARSING_FAILURE")}},_c=class extends yc{async*_transform(t){for await(const e of t)typeof e=="string"?yield this.parseResult([{text:e}]):yield this.parseResult([{message:e,text:this._baseMessageToString(e)}])}async*transform(t,e){yield*this._transformStreamWithConfig(t,this._transform.bind(this),{...e,runType:"parser"})}},wc=class extends _c{constructor(e){super(e);p(this,"diff",!1);this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let r,n;for await(const s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let i;if($o(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new mr({message:s,text:s.content})}else if(St(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new mr({message:Ql(s),text:s.content})}else i=new va({text:s});n===void 0?n=i:n=n.concat(i);const a=await this.parsePartialResult([n]);a!=null&&!vi(a,r)&&(this.diff?yield this._diff(r,a):yield a,r=a)}}getFormatInstructions(){return""}},bM=class extends _c{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","bytes"]);p(this,"lc_serializable",!0);p(this,"textEncoder",new TextEncoder)}static lc_name(){return"BytesOutputParser"}parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}},bc=class extends _c{constructor(){super(...arguments);p(this,"re")}async*_transform(e){let r="";for await(const n of e)if(typeof n=="string"?r+=n:r+=n.content,this.re){const s=[...r.matchAll(this.re)];if(s.length>1){let i=0;for(const a of s.slice(0,-1))yield[a[1]],i+=(a.index??0)+a[0].length;r=r.slice(i)}}else{const s=await this.parse(r);if(s.length>1){for(const i of s.slice(0,-1))yield[i];r=s[s.length-1]}}for(const n of await this.parse(r))yield[n]}},vM=class extends bc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"lc_serializable",!0)}static lc_name(){return"CommaSeparatedListOutputParser"}async parse(e){try{return e.trim().split(",").map(r=>r.trim())}catch{throw new hs(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},EM=class extends bc{constructor({length:e,separator:r}){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"length");p(this,"separator");this.length=e,this.separator=r||","}async parse(e){try{const r=e.trim().split(this.separator).map(n=>n.trim());if(this.length!==void 0&&r.length!==this.length)throw new hs(`Incorrect number of items. Expected ${this.length}, got ${r.length}.`);return r}catch(r){throw Object.getPrototypeOf(r)===hs.prototype?r:new hs(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${this.length===void 0?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}},SM=class extends bc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"lc_serializable",!0);p(this,"re",/\d+\.\s([^\n]+)/g)}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(r=>r[1])}},xM=class extends bc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"lc_serializable",!0);p(this,"re",/^\s*[-*]\s([^\n]+)$/gm)}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(r=>r[1])}},TM=class extends _c{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","string"]);p(this,"lc_serializable",!0)}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((r,n)=>r+this._messageContentToString(n),"")}},hu=class extends yc{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","structured"]);this.schema=e}static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const r=jt(Object.fromEntries(Object.entries(e).map(([n,s])=>[n,it().describe(s)])));return new this(r)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(ar(this.schema))}
\`\`\`
`}async parse(e){var r,n;try{const s=e.trim(),a=(((r=s.match(/^```(?:json)?\s*([\s\S]*?)```/))==null?void 0:r[1])||((n=s.match(/```json\s*([\s\S]*?)```/))==null?void 0:n[1])||s).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(o,c)=>`"${c.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await ld(this.schema,JSON.parse(a))}catch(s){throw new hs(`Failed to parse. Text: "${e}". Error: ${s}`,e)}}},Vx=class extends hu{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(t){const e=(t==null?void 0:t.interpolationDepth)??1;if(e<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction(ar(this.schema)).replaceAll("{","{".repeat(e)).replaceAll("}","}".repeat(e))}
\`\`\``}_schemaToInstruction(t,e=2){const r=t;if("type"in r){let n=!1,s;if(Array.isArray(r.type)){const o=r.type.findIndex(c=>c==="null");o!==-1&&(n=!0,r.type.splice(o,1)),s=r.type.join(" | ")}else s=r.type;if(r.type==="object"&&r.properties){const o=r.description?` // ${r.description}`:"";return`{
${Object.entries(r.properties).map(([l,u])=>{var h;const d=(h=r.required)!=null&&h.includes(l)?"":" (optional)";return`${" ".repeat(e)}"${l}": ${this._schemaToInstruction(u,e+2)}${d}`}).join(`
`)}
${" ".repeat(e-2)}}${o}`}if(r.type==="array"&&r.items){const o=r.description?` // ${r.description}`:"";return`array[
${" ".repeat(e)}${this._schemaToInstruction(r.items,e+2)}
${" ".repeat(e-2)}] ${o}`}const i=n?" (nullable)":"",a=r.description?` // ${r.description}`:"";return`${s}${a}${i}`}if("anyOf"in r)return r.anyOf.map(n=>this._schemaToInstruction(n,e)).join(`
${" ".repeat(e-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(t){return new this(t)}static fromNamesAndDescriptions(t){const e=jt(Object.fromEntries(Object.entries(t).map(([r,n])=>[r,it().describe(n)])));return new this(e)}},AM=class extends yc{constructor({inputSchema:e}){super(...arguments);p(this,"structuredInputParser");this.structuredInputParser=new Vx(e)}async parse(e){let r;try{r=await this.structuredInputParser.parse(e)}catch(n){throw new hs(`Failed to parse. Text: "${e}". Error: ${n}`,e)}return this.outputProcessor(r)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}},Lp=class extends wc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers"]);p(this,"lc_serializable",!0)}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,r){return this.diff?super._concatOutputChunks(e,r):r}_diff(e,r){if(r)return e?ad(e,r):[{op:"replace",path:"",value:r}]}async parsePartialResult(e){return up(e[0].text)}async parse(e){return up(e,JSON.parse)}getFormatInstructions(){return""}};const CM=function(){const t={};t.parser=function(A,x){return new r(A,x)},t.SAXParser=r,t.SAXStream=l,t.createStream=c,t.MAX_BUFFER_LENGTH=64*1024;const e=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];t.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"];function r(A,x){if(!(this instanceof r))return new r(A,x);var D=this;s(D),D.q=D.c="",D.bufferCheckPosition=t.MAX_BUFFER_LENGTH,D.opt=x||{},D.opt.lowercase=D.opt.lowercase||D.opt.lowercasetags,D.looseCase=D.opt.lowercase?"toLowerCase":"toUpperCase",D.tags=[],D.closed=D.closedRoot=D.sawRoot=!1,D.tag=D.error=null,D.strict=!!A,D.noscript=!!(A||D.opt.noscript),D.state=S.BEGIN,D.strictEntities=D.opt.strictEntities,D.ENTITIES=D.strictEntities?Object.create(t.XML_ENTITIES):Object.create(t.ENTITIES),D.attribList=[],D.opt.xmlns&&(D.ns=Object.create(m)),D.trackPosition=D.opt.position!==!1,D.trackPosition&&(D.position=D.line=D.column=0),B(D,"onready")}Object.create||(Object.create=function(A){function x(){}x.prototype=A;var D=new x;return D}),Object.keys||(Object.keys=function(A){var x=[];for(var D in A)A.hasOwnProperty(D)&&x.push(D);return x});function n(A){for(var x=Math.max(t.MAX_BUFFER_LENGTH,10),D=0,N=0,ke=e.length;N<ke;N++){var $e=A[e[N]].length;if($e>x)switch(e[N]){case"textNode":se(A);break;case"cdata":q(A,"oncdata",A.cdata),A.cdata="";break;case"script":q(A,"onscript",A.script),A.script="";break;default:j(A,"Max buffer length exceeded: "+e[N])}D=Math.max(D,$e)}var Je=t.MAX_BUFFER_LENGTH-D;A.bufferCheckPosition=Je+A.position}function s(A){for(var x=0,D=e.length;x<D;x++)A[e[x]]=""}function i(A){se(A),A.cdata!==""&&(q(A,"oncdata",A.cdata),A.cdata=""),A.script!==""&&(q(A,"onscript",A.script),A.script="")}r.prototype={end:function(){z(this)},write:V,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){i(this)}};var a=ReadableStream;a||(a=function(){});var o=t.EVENTS.filter(function(A){return A!=="error"&&A!=="end"});function c(A,x){return new l(A,x)}function l(A,x){if(!(this instanceof l))return new l(A,x);a.apply(this),this._parser=new r(A,x),this.writable=!0,this.readable=!0;var D=this;this._parser.onend=function(){D.emit("end")},this._parser.onerror=function(N){D.emit("error",N),D._parser.error=null},this._decoder=null,o.forEach(function(N){Object.defineProperty(D,"on"+N,{get:function(){return D._parser["on"+N]},set:function(ke){if(!ke)return D.removeAllListeners(N),D._parser["on"+N]=ke,ke;D.on(N,ke)},enumerable:!0,configurable:!1})})}l.prototype=Object.create(a.prototype,{constructor:{value:l}}),l.prototype.write=function(A){return this._parser.write(A.toString()),this.emit("data",A),!0},l.prototype.end=function(A){return A&&A.length&&this.write(A),this._parser.end(),!0},l.prototype.on=function(A,x){var D=this;return!D._parser["on"+A]&&o.indexOf(A)!==-1&&(D._parser["on"+A]=function(){var N=arguments.length===1?[arguments[0]]:Array.apply(null,arguments);N.splice(0,0,A),D.emit.apply(D,N)}),a.prototype.on.call(D,A,x)};var u="[CDATA[",d="DOCTYPE",h="http://www.w3.org/XML/1998/namespace",f="http://www.w3.org/2000/xmlns/",m={xml:h,xmlns:f},g=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,y=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,b=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,_=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function E(A){return A===" "||A===`
`||A==="\r"||A==="	"}function C(A){return A==='"'||A==="'"}function k(A){return A===">"||E(A)}function R(A,x){return A.test(x)}function $(A,x){return!R(A,x)}var S=0;t.STATE={BEGIN:S++,BEGIN_WHITESPACE:S++,TEXT:S++,TEXT_ENTITY:S++,OPEN_WAKA:S++,SGML_DECL:S++,SGML_DECL_QUOTED:S++,DOCTYPE:S++,DOCTYPE_QUOTED:S++,DOCTYPE_DTD:S++,DOCTYPE_DTD_QUOTED:S++,COMMENT_STARTING:S++,COMMENT:S++,COMMENT_ENDING:S++,COMMENT_ENDED:S++,CDATA:S++,CDATA_ENDING:S++,CDATA_ENDING_2:S++,PROC_INST:S++,PROC_INST_BODY:S++,PROC_INST_ENDING:S++,OPEN_TAG:S++,OPEN_TAG_SLASH:S++,ATTRIB:S++,ATTRIB_NAME:S++,ATTRIB_NAME_SAW_WHITE:S++,ATTRIB_VALUE:S++,ATTRIB_VALUE_QUOTED:S++,ATTRIB_VALUE_CLOSED:S++,ATTRIB_VALUE_UNQUOTED:S++,ATTRIB_VALUE_ENTITY_Q:S++,ATTRIB_VALUE_ENTITY_U:S++,CLOSE_TAG:S++,CLOSE_TAG_SAW_WHITE:S++,SCRIPT:S++,SCRIPT_ENDING:S++},t.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},t.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(t.ENTITIES).forEach(function(A){var x=t.ENTITIES[A],D=typeof x=="number"?String.fromCharCode(x):x;t.ENTITIES[A]=D});for(var M in t.STATE)t.STATE[t.STATE[M]]=M;S=t.STATE;function B(A,x,D){A[x]&&A[x](D)}function q(A,x,D){A.textNode&&se(A),B(A,x,D)}function se(A){A.textNode=pe(A.opt,A.textNode),A.textNode&&B(A,"ontext",A.textNode),A.textNode=""}function pe(A,x){return A.trim&&(x=x.trim()),A.normalize&&(x=x.replace(/\s+/g," ")),x}function j(A,x){return se(A),A.trackPosition&&(x+=`
Line: `+A.line+`
Column: `+A.column+`
Char: `+A.c),x=new Error(x),A.error=x,B(A,"onerror",x),A}function z(A){return A.sawRoot&&!A.closedRoot&&G(A,"Unclosed root tag"),A.state!==S.BEGIN&&A.state!==S.BEGIN_WHITESPACE&&A.state!==S.TEXT&&j(A,"Unexpected end"),se(A),A.c="",A.closed=!0,B(A,"onend"),r.call(A,A.strict,A.opt),A}function G(A,x){if(typeof A!="object"||!(A instanceof r))throw new Error("bad call to strictFail");A.strict&&j(A,x)}function ie(A){A.strict||(A.tagName=A.tagName[A.looseCase]());var x=A.tags[A.tags.length-1]||A,D=A.tag={name:A.tagName,attributes:{}};A.opt.xmlns&&(D.ns=x.ns),A.attribList.length=0,q(A,"onopentagstart",D)}function ce(A,x){var D=A.indexOf(":"),N=D<0?["",A]:A.split(":"),ke=N[0],$e=N[1];return x&&A==="xmlns"&&(ke="xmlns",$e=""),{prefix:ke,local:$e}}function te(A){if(A.strict||(A.attribName=A.attribName[A.looseCase]()),A.attribList.indexOf(A.attribName)!==-1||A.tag.attributes.hasOwnProperty(A.attribName)){A.attribName=A.attribValue="";return}if(A.opt.xmlns){var x=ce(A.attribName,!0),D=x.prefix,N=x.local;if(D==="xmlns")if(N==="xml"&&A.attribValue!==h)G(A,"xml: prefix must be bound to "+h+`
Actual: `+A.attribValue);else if(N==="xmlns"&&A.attribValue!==f)G(A,"xmlns: prefix must be bound to "+f+`
Actual: `+A.attribValue);else{var ke=A.tag,$e=A.tags[A.tags.length-1]||A;ke.ns===$e.ns&&(ke.ns=Object.create($e.ns)),ke.ns[N]=A.attribValue}A.attribList.push([A.attribName,A.attribValue])}else A.tag.attributes[A.attribName]=A.attribValue,q(A,"onattribute",{name:A.attribName,value:A.attribValue});A.attribName=A.attribValue=""}function le(A,x){if(A.opt.xmlns){var D=A.tag,N=ce(A.tagName);D.prefix=N.prefix,D.local=N.local,D.uri=D.ns[N.prefix]||"",D.prefix&&!D.uri&&(G(A,"Unbound namespace prefix: "+JSON.stringify(A.tagName)),D.uri=N.prefix);var ke=A.tags[A.tags.length-1]||A;D.ns&&ke.ns!==D.ns&&Object.keys(D.ns).forEach(function(Yn){q(A,"onopennamespace",{prefix:Yn,uri:D.ns[Yn]})});for(var $e=0,Je=A.attribList.length;$e<Je;$e++){var at=A.attribList[$e],ft=at[0],zt=at[1],Xe=ce(ft,!0),Lt=Xe.prefix,Ss=Xe.local,Vi=Lt===""?"":D.ns[Lt]||"",Y={name:ft,value:zt,prefix:Lt,local:Ss,uri:Vi};Lt&&Lt!=="xmlns"&&!Vi&&(G(A,"Unbound namespace prefix: "+JSON.stringify(Lt)),Y.uri=Lt),A.tag.attributes[ft]=Y,q(A,"onattribute",Y)}A.attribList.length=0}A.tag.isSelfClosing=!!x,A.sawRoot=!0,A.tags.push(A.tag),q(A,"onopentag",A.tag),x||(!A.noscript&&A.tagName.toLowerCase()==="script"?A.state=S.SCRIPT:A.state=S.TEXT,A.tag=null,A.tagName=""),A.attribName=A.attribValue="",A.attribList.length=0}function Ee(A){if(!A.tagName){G(A,"Weird empty close tag."),A.textNode+="</>",A.state=S.TEXT;return}if(A.script){if(A.tagName!=="script"){A.script+="</"+A.tagName+">",A.tagName="",A.state=S.SCRIPT;return}q(A,"onscript",A.script),A.script=""}var x=A.tags.length,D=A.tagName;A.strict||(D=D[A.looseCase]());for(var N=D;x--;){var ke=A.tags[x];if(ke.name!==N)G(A,"Unexpected close tag");else break}if(x<0){G(A,"Unmatched closing tag: "+A.tagName),A.textNode+="</"+A.tagName+">",A.state=S.TEXT;return}A.tagName=D;for(var $e=A.tags.length;$e-- >x;){var Je=A.tag=A.tags.pop();A.tagName=A.tag.name,q(A,"onclosetag",A.tagName);var at={};for(var ft in Je.ns)at[ft]=Je.ns[ft];var zt=A.tags[A.tags.length-1]||A;A.opt.xmlns&&Je.ns!==zt.ns&&Object.keys(Je.ns).forEach(function(Xe){var Lt=Je.ns[Xe];q(A,"onclosenamespace",{prefix:Xe,uri:Lt})})}x===0&&(A.closedRoot=!0),A.tagName=A.attribValue=A.attribName="",A.attribList.length=0,A.state=S.TEXT}function W(A){var x=A.entity,D=x.toLowerCase(),N,ke="";return A.ENTITIES[x]?A.ENTITIES[x]:A.ENTITIES[D]?A.ENTITIES[D]:(x=D,x.charAt(0)==="#"&&(x.charAt(1)==="x"?(x=x.slice(2),N=parseInt(x,16),ke=N.toString(16)):(x=x.slice(1),N=parseInt(x,10),ke=N.toString(10))),x=x.replace(/^0+/,""),isNaN(N)||ke.toLowerCase()!==x?(G(A,"Invalid character entity"),"&"+A.entity+";"):String.fromCodePoint(N))}function X(A,x){x==="<"?(A.state=S.OPEN_WAKA,A.startTagPosition=A.position):E(x)||(G(A,"Non-whitespace before first tag."),A.textNode=x,A.state=S.TEXT)}function ae(A,x){var D="";return x<A.length&&(D=A.charAt(x)),D}function V(A){var x=this;if(this.error)throw this.error;if(x.closed)return j(x,"Cannot write after close. Assign an onready handler.");if(A===null)return z(x);typeof A=="object"&&(A=A.toString());for(var D=0,N="";N=ae(A,D++),x.c=N,!!N;)switch(x.trackPosition&&(x.position++,N===`
`?(x.line++,x.column=0):x.column++),x.state){case S.BEGIN:if(x.state=S.BEGIN_WHITESPACE,N==="\uFEFF")continue;X(x,N);continue;case S.BEGIN_WHITESPACE:X(x,N);continue;case S.TEXT:if(x.sawRoot&&!x.closedRoot){for(var ke=D-1;N&&N!=="<"&&N!=="&";)N=ae(A,D++),N&&x.trackPosition&&(x.position++,N===`
`?(x.line++,x.column=0):x.column++);x.textNode+=A.substring(ke,D-1)}N==="<"&&!(x.sawRoot&&x.closedRoot&&!x.strict)?(x.state=S.OPEN_WAKA,x.startTagPosition=x.position):(!E(N)&&(!x.sawRoot||x.closedRoot)&&G(x,"Text data outside of root node."),N==="&"?x.state=S.TEXT_ENTITY:x.textNode+=N);continue;case S.SCRIPT:N==="<"?x.state=S.SCRIPT_ENDING:x.script+=N;continue;case S.SCRIPT_ENDING:N==="/"?x.state=S.CLOSE_TAG:(x.script+="<"+N,x.state=S.SCRIPT);continue;case S.OPEN_WAKA:if(N==="!")x.state=S.SGML_DECL,x.sgmlDecl="";else if(!E(N))if(R(g,N))x.state=S.OPEN_TAG,x.tagName=N;else if(N==="/")x.state=S.CLOSE_TAG,x.tagName="";else if(N==="?")x.state=S.PROC_INST,x.procInstName=x.procInstBody="";else{if(G(x,"Unencoded <"),x.startTagPosition+1<x.position){var $e=x.position-x.startTagPosition;N=new Array($e).join(" ")+N}x.textNode+="<"+N,x.state=S.TEXT}continue;case S.SGML_DECL:(x.sgmlDecl+N).toUpperCase()===u?(q(x,"onopencdata"),x.state=S.CDATA,x.sgmlDecl="",x.cdata=""):x.sgmlDecl+N==="--"?(x.state=S.COMMENT,x.comment="",x.sgmlDecl=""):(x.sgmlDecl+N).toUpperCase()===d?(x.state=S.DOCTYPE,(x.doctype||x.sawRoot)&&G(x,"Inappropriately located doctype declaration"),x.doctype="",x.sgmlDecl=""):N===">"?(q(x,"onsgmldeclaration",x.sgmlDecl),x.sgmlDecl="",x.state=S.TEXT):(C(N)&&(x.state=S.SGML_DECL_QUOTED),x.sgmlDecl+=N);continue;case S.SGML_DECL_QUOTED:N===x.q&&(x.state=S.SGML_DECL,x.q=""),x.sgmlDecl+=N;continue;case S.DOCTYPE:N===">"?(x.state=S.TEXT,q(x,"ondoctype",x.doctype),x.doctype=!0):(x.doctype+=N,N==="["?x.state=S.DOCTYPE_DTD:C(N)&&(x.state=S.DOCTYPE_QUOTED,x.q=N));continue;case S.DOCTYPE_QUOTED:x.doctype+=N,N===x.q&&(x.q="",x.state=S.DOCTYPE);continue;case S.DOCTYPE_DTD:x.doctype+=N,N==="]"?x.state=S.DOCTYPE:C(N)&&(x.state=S.DOCTYPE_DTD_QUOTED,x.q=N);continue;case S.DOCTYPE_DTD_QUOTED:x.doctype+=N,N===x.q&&(x.state=S.DOCTYPE_DTD,x.q="");continue;case S.COMMENT:N==="-"?x.state=S.COMMENT_ENDING:x.comment+=N;continue;case S.COMMENT_ENDING:N==="-"?(x.state=S.COMMENT_ENDED,x.comment=pe(x.opt,x.comment),x.comment&&q(x,"oncomment",x.comment),x.comment=""):(x.comment+="-"+N,x.state=S.COMMENT);continue;case S.COMMENT_ENDED:N!==">"?(G(x,"Malformed comment"),x.comment+="--"+N,x.state=S.COMMENT):x.state=S.TEXT;continue;case S.CDATA:N==="]"?x.state=S.CDATA_ENDING:x.cdata+=N;continue;case S.CDATA_ENDING:N==="]"?x.state=S.CDATA_ENDING_2:(x.cdata+="]"+N,x.state=S.CDATA);continue;case S.CDATA_ENDING_2:N===">"?(x.cdata&&q(x,"oncdata",x.cdata),q(x,"onclosecdata"),x.cdata="",x.state=S.TEXT):N==="]"?x.cdata+="]":(x.cdata+="]]"+N,x.state=S.CDATA);continue;case S.PROC_INST:N==="?"?x.state=S.PROC_INST_ENDING:E(N)?x.state=S.PROC_INST_BODY:x.procInstName+=N;continue;case S.PROC_INST_BODY:if(!x.procInstBody&&E(N))continue;N==="?"?x.state=S.PROC_INST_ENDING:x.procInstBody+=N;continue;case S.PROC_INST_ENDING:N===">"?(q(x,"onprocessinginstruction",{name:x.procInstName,body:x.procInstBody}),x.procInstName=x.procInstBody="",x.state=S.TEXT):(x.procInstBody+="?"+N,x.state=S.PROC_INST_BODY);continue;case S.OPEN_TAG:R(y,N)?x.tagName+=N:(ie(x),N===">"?le(x):N==="/"?x.state=S.OPEN_TAG_SLASH:(E(N)||G(x,"Invalid character in tag name"),x.state=S.ATTRIB));continue;case S.OPEN_TAG_SLASH:N===">"?(le(x,!0),Ee(x)):(G(x,"Forward-slash in opening tag not followed by >"),x.state=S.ATTRIB);continue;case S.ATTRIB:if(E(N))continue;N===">"?le(x):N==="/"?x.state=S.OPEN_TAG_SLASH:R(g,N)?(x.attribName=N,x.attribValue="",x.state=S.ATTRIB_NAME):G(x,"Invalid attribute name");continue;case S.ATTRIB_NAME:N==="="?x.state=S.ATTRIB_VALUE:N===">"?(G(x,"Attribute without value"),x.attribValue=x.attribName,te(x),le(x)):E(N)?x.state=S.ATTRIB_NAME_SAW_WHITE:R(y,N)?x.attribName+=N:G(x,"Invalid attribute name");continue;case S.ATTRIB_NAME_SAW_WHITE:if(N==="=")x.state=S.ATTRIB_VALUE;else{if(E(N))continue;G(x,"Attribute without value"),x.tag.attributes[x.attribName]="",x.attribValue="",q(x,"onattribute",{name:x.attribName,value:""}),x.attribName="",N===">"?le(x):R(g,N)?(x.attribName=N,x.state=S.ATTRIB_NAME):(G(x,"Invalid attribute name"),x.state=S.ATTRIB)}continue;case S.ATTRIB_VALUE:if(E(N))continue;C(N)?(x.q=N,x.state=S.ATTRIB_VALUE_QUOTED):(G(x,"Unquoted attribute value"),x.state=S.ATTRIB_VALUE_UNQUOTED,x.attribValue=N);continue;case S.ATTRIB_VALUE_QUOTED:if(N!==x.q){N==="&"?x.state=S.ATTRIB_VALUE_ENTITY_Q:x.attribValue+=N;continue}te(x),x.q="",x.state=S.ATTRIB_VALUE_CLOSED;continue;case S.ATTRIB_VALUE_CLOSED:E(N)?x.state=S.ATTRIB:N===">"?le(x):N==="/"?x.state=S.OPEN_TAG_SLASH:R(g,N)?(G(x,"No whitespace between attributes"),x.attribName=N,x.attribValue="",x.state=S.ATTRIB_NAME):G(x,"Invalid attribute name");continue;case S.ATTRIB_VALUE_UNQUOTED:if(!k(N)){N==="&"?x.state=S.ATTRIB_VALUE_ENTITY_U:x.attribValue+=N;continue}te(x),N===">"?le(x):x.state=S.ATTRIB;continue;case S.CLOSE_TAG:if(x.tagName)N===">"?Ee(x):R(y,N)?x.tagName+=N:x.script?(x.script+="</"+x.tagName,x.tagName="",x.state=S.SCRIPT):(E(N)||G(x,"Invalid tagname in closing tag"),x.state=S.CLOSE_TAG_SAW_WHITE);else{if(E(N))continue;$(g,N)?x.script?(x.script+="</"+N,x.state=S.SCRIPT):G(x,"Invalid tagname in closing tag."):x.tagName=N}continue;case S.CLOSE_TAG_SAW_WHITE:if(E(N))continue;N===">"?Ee(x):G(x,"Invalid characters in closing tag");continue;case S.TEXT_ENTITY:case S.ATTRIB_VALUE_ENTITY_Q:case S.ATTRIB_VALUE_ENTITY_U:var Je,at;switch(x.state){case S.TEXT_ENTITY:Je=S.TEXT,at="textNode";break;case S.ATTRIB_VALUE_ENTITY_Q:Je=S.ATTRIB_VALUE_QUOTED,at="attribValue";break;case S.ATTRIB_VALUE_ENTITY_U:Je=S.ATTRIB_VALUE_UNQUOTED,at="attribValue";break}if(N===";")if(x.opt.unparsedEntities){var ft=W(x);x.entity="",x.state=Je,x.write(ft)}else x[at]+=W(x),x.entity="",x.state=Je;else R(x.entity.length?_:b,N)?x.entity+=N:(G(x,"Invalid character in entity name"),x[at]+="&"+x.entity+N,x.entity="",x.state=Je);continue;default:throw new Error(x,"Unknown state: "+x.state)}return x.position>=x.bufferCheckPosition&&n(x),x}/*! http://mths.be/fromcodepoint v0.1.0 by @mathias */return String.fromCodePoint||(function(){var A=String.fromCharCode,x=Math.floor,D=function(){var N=16384,ke=[],$e,Je,at=-1,ft=arguments.length;if(!ft)return"";for(var zt="";++at<ft;){var Xe=Number(arguments[at]);if(!isFinite(Xe)||Xe<0||Xe>1114111||x(Xe)!==Xe)throw RangeError("Invalid code point: "+Xe);Xe<=65535?ke.push(Xe):(Xe-=65536,$e=(Xe>>10)+55296,Je=Xe%1024+56320,ke.push($e,Je)),(at+1===ft||ke.length>N)&&(zt+=A.apply(null,ke),ke.length=0)}return zt};Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:D,configurable:!0,writable:!0}):String.fromCodePoint=D})(),t},kM=CM(),Mp=`The output should be formatted as a XML file.
1. Output should conform to the tags below. 
2. If tags are not given, make them on your own.
3. Remember to always open and close all the tags.

As an example, for the tags ["foo", "bar", "baz"]:
1. String "<foo>
   <bar>
      <baz></baz>
   </bar>
</foo>" is a well-formatted instance of the schema. 
2. String "<foo>
   <bar>
   </foo>" is a badly-formatted instance.
3. String "<foo>
   <tag>
   </tag>
</foo>" is a badly-formatted instance.

Here are the output tags:
\`\`\`
{tags}
\`\`\``;var IM=class extends wc{constructor(e){super(e);p(this,"tags");p(this,"lc_namespace",["langchain_core","output_parsers"]);p(this,"lc_serializable",!0);this.tags=e==null?void 0:e.tags}static lc_name(){return"XMLOutputParser"}_diff(e,r){if(r)return e?ad(e,r):[{op:"replace",path:"",value:r}]}async parsePartialResult(e){return Dp(e[0].text)}async parse(e){return Dp(e)}getFormatInstructions(){var r;return!!(this.tags&&this.tags.length>0)?Mp.replace("{tags}",((r=this.tags)==null?void 0:r.join(", "))??""):Mp}};const RM=t=>t.split(`
`).map(e=>e.replace(/^\s+/,"")).join(`
`).trim(),qx=t=>{if(Object.keys(t).length===0)return{};const e={};return t.children.length>0?(e[t.name]=t.children.map(qx),e):(e[t.name]=t.text??void 0,e)};function Dp(t){const e=RM(t),r=kM.parser(!0);let n={};const s=[];r.onopentag=o=>{const c={name:o.name,attributes:o.attributes,children:[],text:"",isSelfClosing:o.isSelfClosing};s.length>0?s[s.length-1].children.push(c):n=c,o.isSelfClosing||s.push(c)},r.onclosetag=()=>{if(s.length>0){const o=s.pop();s.length===0&&o&&(n=o)}},r.ontext=o=>{if(s.length>0){const c=s[s.length-1];c.text+=o}},r.onattribute=o=>{if(s.length>0){const c=s[s.length-1];c.attributes[o.name]=o.value}};const i=/```(xml)?(.*)```/s.exec(e),a=i?i[2]:e;return r.write(a).close(),n&&n.name==="?xml"&&(n=n.children[0]),qx(n)}var Hx={};ve(Hx,{AsymmetricStructuredOutputParser:()=>AM,BaseCumulativeTransformOutputParser:()=>wc,BaseLLMOutputParser:()=>pd,BaseOutputParser:()=>yc,BaseTransformOutputParser:()=>_c,BytesOutputParser:()=>bM,CommaSeparatedListOutputParser:()=>vM,CustomListOutputParser:()=>EM,JsonMarkdownStructuredOutputParser:()=>Vx,JsonOutputParser:()=>Lp,ListOutputParser:()=>bc,MarkdownListOutputParser:()=>xM,NumberedListOutputParser:()=>SM,OutputParserException:()=>hs,StringOutputParser:()=>TM,StructuredOutputParser:()=>hu,XMLOutputParser:()=>IM,XML_FORMAT_INSTRUCTIONS:()=>Mp,parseJsonMarkdown:()=>up,parsePartialJson:()=>wa,parseXMLMarkdown:()=>Dp});function md(t,e){if(t.function===void 0)return;let r;if(e!=null&&e.partial)try{r=wa(t.function.arguments??"{}")}catch{return}else try{r=JSON.parse(t.function.arguments)}catch(s){throw new hs([`Function "${t.function.name}" arguments:`,"",t.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}const n={name:t.function.name,args:r,type:"tool_call"};return e!=null&&e.returnId&&(n.id=t.id),n}function Gx(t){if(t.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.args)}}}function fu(t,e){var r,n;return{name:(r=t.function)==null?void 0:r.name,args:(n=t.function)==null?void 0:n.arguments,id:t.id,error:e,type:"invalid_tool_call"}}var Wx=class extends wc{constructor(e){super(e);p(this,"returnId",!1);p(this,"lc_namespace",["langchain","output_parsers","openai_tools"]);p(this,"lc_serializable",!0);this.returnId=(e==null?void 0:e.returnId)??this.returnId}static lc_name(){return"JsonOutputToolsParser"}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,r=!0){var a;const n=e[0].message;let s;if(ms(n)&&((a=n.tool_calls)!=null&&a.length)?s=n.tool_calls.map(o=>{const{id:c,...l}=o;return this.returnId?{id:c,...l}:l}):n.additional_kwargs.tool_calls!==void 0&&(s=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(c=>md(c,{returnId:this.returnId,partial:r}))),!s)return[];const i=[];for(const o of s)if(o!==void 0){const c={type:o.name,args:o.args,id:o.id};i.push(c)}return i}},Up=class extends Wx{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","openai_tools"]);p(this,"lc_serializable",!0);p(this,"returnId",!1);p(this,"keyName");p(this,"returnSingle",!1);p(this,"zodSchema");this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}static lc_name(){return"JsonOutputKeyToolsParser"}async _validateResult(e){var n;if(this.zodSchema===void 0)return e;const r=await CS(this.zodSchema,e);if(r.success)return r.data;throw new hs(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify((n=r.error)==null?void 0:n.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const n=(await super.parsePartialResult(e)).filter(i=>i.type===this.keyName);let s=n;if(n.length)return this.returnId||(s=n.map(i=>i.args)),this.returnSingle?s[0]:s}async parseResult(e){const n=(await super.parsePartialResult(e,!1)).filter(a=>a.type===this.keyName);let s=n;return n.length?(this.returnId||(s=n.map(a=>a.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(a=>this._validateResult(a)))):void 0}},Jx={};ve(Jx,{JsonOutputKeyToolsParser:()=>Up,JsonOutputToolsParser:()=>Wx,convertLangChainToolCallToOpenAI:()=>Gx,makeInvalidToolCall:()=>fu,parseToolCall:()=>md});var Zx=class extends pd{constructor(e){super();p(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);p(this,"lc_serializable",!0);p(this,"argsOnly",!0);this.argsOnly=(e==null?void 0:e.argsOnly)??this.argsOnly}static lc_name(){return"OutputFunctionsParser"}async parseResult(e){if("message"in e[0]){const n=e[0].message.additional_kwargs.function_call;if(!n)throw new Error(`No function_call in message ${JSON.stringify(e)}`);if(!n.arguments)throw new Error(`No arguments in function_call ${JSON.stringify(e)}`);return this.argsOnly?n.arguments:JSON.stringify(n)}else throw new Error(`No message in generations ${JSON.stringify(e)}`)}},Kx=class extends wc{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);p(this,"lc_serializable",!0);p(this,"outputParser");p(this,"argsOnly",!0);this.argsOnly=(e==null?void 0:e.argsOnly)??this.argsOnly,this.outputParser=new Zx(e)}static lc_name(){return"JsonOutputFunctionsParser"}_diff(e,r){return r?ad(e??{},r):void 0}async parsePartialResult(e){const r=e[0];if(!r.message)return;const{message:n}=r,s=n.additional_kwargs.function_call;if(s)return this.argsOnly?wa(s.arguments):{...s,arguments:wa(s.arguments)}}async parseResult(e){const r=await this.outputParser.parseResult(e);if(!r)throw new Error(`No result from "OutputFunctionsParser" ${JSON.stringify(e)}`);return this.parse(r)}async parse(e){const r=JSON.parse(e);return this.argsOnly||(r.arguments=JSON.parse(r.arguments)),r}getFormatInstructions(){return""}},OM=class extends pd{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);p(this,"lc_serializable",!0);p(this,"outputParser",new Kx);p(this,"attrName");this.attrName=e.attrName}static lc_name(){return"JsonKeyOutputFunctionsParser"}get lc_aliases(){return{attrName:"key_name"}}async parseResult(e){return(await this.outputParser.parseResult(e))[this.attrName]}},Xx={};ve(Xx,{JsonKeyOutputFunctionsParser:()=>OM,JsonOutputFunctionsParser:()=>Kx,OutputFunctionsParser:()=>Zx});var vc=class extends Fe{constructor(e){super(e);p(this,"lc_serializable",!0);p(this,"lc_namespace",["langchain_core","prompts",this._getPromptType()]);p(this,"inputVariables");p(this,"outputParser");p(this,"partialVariables");p(this,"metadata");p(this,"tags");const{inputVariables:r}=e;if(r.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}get lc_attributes(){return{partialVariables:void 0}}async mergePartialAndUserVariables(e){const r=this.partialVariables??{},n={};for(const[i,a]of Object.entries(r))typeof a=="string"?n[i]=a:n[i]=await a();return{...n,...e}}async invoke(e,r){const n={...this.metadata,...r==null?void 0:r.metadata},s=[...this.tags??[],...(r==null?void 0:r.tags)??[]];return this._callWithConfig(i=>this.formatPromptValue(i),e,{...r,tags:s,metadata:n,runType:"prompt"})}},Ho=class extends vc{async formatPromptValue(t){const e=await this.format(t);return new Sg(e)}};/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var $M=Object.prototype.toString,Ba=Array.isArray||function(e){return $M.call(e)==="[object Array]"};function Ng(t){return typeof t=="function"}function NM(t){return Ba(t)?"array":typeof t}function mf(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function bb(t,e){return t!=null&&typeof t=="object"&&e in t}function PM(t,e){return t!=null&&typeof t!="object"&&t.hasOwnProperty&&t.hasOwnProperty(e)}var LM=RegExp.prototype.test;function MM(t,e){return LM.call(t,e)}var DM=/\S/;function UM(t){return!MM(DM,t)}var BM={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function jM(t){return String(t).replace(/[&<>"'`=\/]/g,function(r){return BM[r]})}var FM=/\s*/,zM=/\s+/,vb=/\s*=/,VM=/\s*\}/,qM=/#|\^|\/|>|\{|&|=|!/;function HM(t,e){if(!t)return[];var r=!1,n=[],s=[],i=[],a=!1,o=!1,c="",l=0;function u(){if(a&&!o)for(;i.length;)delete s[i.pop()];else i=[];a=!1,o=!1}var d,h,f;function m(S){if(typeof S=="string"&&(S=S.split(zM,2)),!Ba(S)||S.length!==2)throw new Error("Invalid tags: "+S);d=new RegExp(mf(S[0])+"\\s*"),h=new RegExp("\\s*"+mf(S[1])),f=new RegExp("\\s*"+mf("}"+S[1]))}m(e||Ir.tags);for(var g=new Ec(t),y,b,_,E,C,k;!g.eos();){if(y=g.pos,_=g.scanUntil(d),_)for(var R=0,$=_.length;R<$;++R)E=_.charAt(R),UM(E)?(i.push(s.length),c+=E):(o=!0,r=!0,c+=" "),s.push(["text",E,y,y+1]),y+=1,E===`
`&&(u(),c="",l=0,r=!1);if(!g.scan(d))break;if(a=!0,b=g.scan(qM)||"name",g.scan(FM),b==="="?(_=g.scanUntil(vb),g.scan(vb),g.scanUntil(h)):b==="{"?(_=g.scanUntil(f),g.scan(VM),g.scanUntil(h),b="&"):_=g.scanUntil(h),!g.scan(h))throw new Error("Unclosed tag at "+g.pos);if(b==">"?C=[b,_,y,g.pos,c,l,r]:C=[b,_,y,g.pos],l++,s.push(C),b==="#"||b==="^")n.push(C);else if(b==="/"){if(k=n.pop(),!k)throw new Error('Unopened section "'+_+'" at '+y);if(k[1]!==_)throw new Error('Unclosed section "'+k[1]+'" at '+y)}else b==="name"||b==="{"||b==="&"?o=!0:b==="="&&m(_)}if(u(),k=n.pop(),k)throw new Error('Unclosed section "'+k[1]+'" at '+g.pos);return WM(GM(s))}function GM(t){for(var e=[],r,n,s=0,i=t.length;s<i;++s)r=t[s],r&&(r[0]==="text"&&n&&n[0]==="text"?(n[1]+=r[1],n[3]=r[3]):(e.push(r),n=r));return e}function WM(t){for(var e=[],r=e,n=[],s,i,a=0,o=t.length;a<o;++a)switch(s=t[a],s[0]){case"#":case"^":r.push(s),n.push(s),r=s[4]=[];break;case"/":i=n.pop(),i[5]=s[2],r=n.length>0?n[n.length-1][4]:e;break;default:r.push(s)}return e}function Ec(t){this.string=t,this.tail=t,this.pos=0}Ec.prototype.eos=function(){return this.tail===""};Ec.prototype.scan=function(e){var r=this.tail.match(e);if(!r||r.index!==0)return"";var n=r[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n};Ec.prototype.scanUntil=function(e){var r=this.tail.search(e),n;switch(r){case-1:n=this.tail,this.tail="";break;case 0:n="";break;default:n=this.tail.substring(0,r),this.tail=this.tail.substring(r)}return this.pos+=n.length,n};function Ca(t,e){this.view=t,this.cache={".":this.view},this.parent=e}Ca.prototype.push=function(e){return new Ca(e,this)};Ca.prototype.lookup=function(e){var r=this.cache,n;if(r.hasOwnProperty(e))n=r[e];else{for(var s=this,i,a,o,c=!1;s;){if(e.indexOf(".")>0)for(i=s.view,a=e.split("."),o=0;i!=null&&o<a.length;)o===a.length-1&&(c=bb(i,a[o])||PM(i,a[o])),i=i[a[o++]];else i=s.view[e],c=bb(s.view,e);if(c){n=i;break}s=s.parent}r[e]=n}return Ng(n)&&(n=n.call(this.view)),n};function yr(){this.templateCache={_cache:{},set:function(e,r){this._cache[e]=r},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}yr.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};yr.prototype.parse=function(e,r){var n=this.templateCache,s=e+":"+(r||Ir.tags).join(":"),i=typeof n<"u",a=i?n.get(s):void 0;return a==null&&(a=HM(e,r),i&&n.set(s,a)),a};yr.prototype.render=function(e,r,n,s){var i=this.getConfigTags(s),a=this.parse(e,i),o=r instanceof Ca?r:new Ca(r,void 0);return this.renderTokens(a,o,n,e,s)};yr.prototype.renderTokens=function(e,r,n,s,i){for(var a="",o,c,l,u=0,d=e.length;u<d;++u)l=void 0,o=e[u],c=o[0],c==="#"?l=this.renderSection(o,r,n,s,i):c==="^"?l=this.renderInverted(o,r,n,s,i):c===">"?l=this.renderPartial(o,r,n,i):c==="&"?l=this.unescapedValue(o,r):c==="name"?l=this.escapedValue(o,r,i):c==="text"&&(l=this.rawValue(o)),l!==void 0&&(a+=l);return a};yr.prototype.renderSection=function(e,r,n,s,i){var a=this,o="",c=r.lookup(e[1]);function l(h){return a.render(h,r,n,i)}if(c){if(Ba(c))for(var u=0,d=c.length;u<d;++u)o+=this.renderTokens(e[4],r.push(c[u]),n,s,i);else if(typeof c=="object"||typeof c=="string"||typeof c=="number")o+=this.renderTokens(e[4],r.push(c),n,s,i);else if(Ng(c)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");c=c.call(r.view,s.slice(e[3],e[5]),l),c!=null&&(o+=c)}else o+=this.renderTokens(e[4],r,n,s,i);return o}};yr.prototype.renderInverted=function(e,r,n,s,i){var a=r.lookup(e[1]);if(!a||Ba(a)&&a.length===0)return this.renderTokens(e[4],r,n,s,i)};yr.prototype.indentPartial=function(e,r,n){for(var s=r.replace(/[^ \t]/g,""),i=e.split(`
`),a=0;a<i.length;a++)i[a].length&&(a>0||!n)&&(i[a]=s+i[a]);return i.join(`
`)};yr.prototype.renderPartial=function(e,r,n,s){if(n){var i=this.getConfigTags(s),a=Ng(n)?n(e[1]):n[e[1]];if(a!=null){var o=e[6],c=e[5],l=e[4],u=a;c==0&&l&&(u=this.indentPartial(a,l,o));var d=this.parse(u,i);return this.renderTokens(d,r,n,u,s)}}};yr.prototype.unescapedValue=function(e,r){var n=r.lookup(e[1]);if(n!=null)return n};yr.prototype.escapedValue=function(e,r,n){var s=this.getConfigEscape(n)||Ir.escape,i=r.lookup(e[1]);if(i!=null)return typeof i=="number"&&s===Ir.escape?String(i):s(i)};yr.prototype.rawValue=function(e){return e[1]};yr.prototype.getConfigTags=function(e){return Ba(e)?e:e&&typeof e=="object"?e.tags:void 0};yr.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!Ba(e))return e.escape};var Ir={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(t){Go.templateCache=t},get templateCache(){return Go.templateCache}},Go=new yr;Ir.clearCache=function(){return Go.clearCache()};Ir.parse=function(e,r){return Go.parse(e,r)};Ir.render=function(e,r,n,s){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+NM(e)+'" was given as the first argument for mustache#render(template, view, partials)');return Go.render(e,r,n,s)};Ir.escape=jM;Ir.Scanner=Ec;Ir.Context=Ca;Ir.Writer=yr;function Yx(){Ir.escape=t=>t}const Wo=t=>{const e=t.split(""),r=[],n=(i,a)=>{for(let o=a;o<e.length;o+=1)if(i.includes(e[o]))return o;return-1};let s=0;for(;s<e.length;)if(e[s]==="{"&&s+1<e.length&&e[s+1]==="{")r.push({type:"literal",text:"{"}),s+=2;else if(e[s]==="}"&&s+1<e.length&&e[s+1]==="}")r.push({type:"literal",text:"}"}),s+=2;else if(e[s]==="{"){const i=n("}",s);if(i<0)throw new Error("Unclosed '{' in template.");r.push({type:"variable",name:e.slice(s+1,i).join("")}),s=i+1}else{if(e[s]==="}")throw new Error("Single '}' in template.");{const i=n("{}",s),a=(i<0?e.slice(s):e.slice(s,i)).join("");r.push({type:"literal",text:a}),s=i<0?e.length:i}}return r},Qx=(t,e=[])=>{const r=[];for(const n of t)if(n[0]==="name"){const s=n[1].includes(".")?n[1].split(".")[0]:n[1];r.push({type:"variable",name:s})}else if(["#","&","^",">"].includes(n[0])){if(r.push({type:"variable",name:n[1]}),n[0]==="#"&&n.length>4&&Array.isArray(n[4])){const s=[...e,n[1]],i=Qx(n[4],s);r.push(...i)}}else r.push({type:"literal",text:n[1]});return r},pu=t=>{Yx();const e=Ir.parse(t);return Qx(e)},eT=(t,e)=>Wo(t).reduce((r,n)=>{if(n.type==="variable"){if(n.name in e){const s=typeof e[n.name]=="string"?e[n.name]:JSON.stringify(e[n.name]);return r+s}throw new Error(`(f-string) Missing value for input ${n.name}`)}return r+n.text},""),tT=(t,e)=>(Yx(),Ir.render(t,e)),mu={"f-string":eT,mustache:tT},rT={"f-string":Wo,mustache:pu},En=(t,e,r)=>{try{return mu[e](t,r)}catch(n){throw id(n,"INVALID_PROMPT_INPUT")}},gu=(t,e)=>rT[e](t),Sc=(t,e,r)=>{if(!(e in mu)){const n=Object.keys(mu);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${n}`)}try{const n=r.reduce((s,i)=>(s[i]="foo",s),{});Array.isArray(t)?t.forEach(s=>{if(s.type==="text"&&"text"in s&&typeof s.text=="string")En(s.text,e,n);else if(s.type==="image_url"){if(typeof s.image_url=="string")En(s.image_url,e,n);else if(typeof s.image_url=="object"&&s.image_url!==null&&"url"in s.image_url&&typeof s.image_url.url=="string"){const i=s.image_url.url;En(i,e,n)}}else throw new Error(`Invalid message template received. ${JSON.stringify(s,null,2)}`)}):En(t,e,n)}catch(n){throw new Error(`Invalid prompt schema: ${n.message}`)}};var Fs=class ro extends Ho{constructor(r){super(r);p(this,"template");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);p(this,"additionalContentFields");if(r.templateFormat==="mustache"&&r.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,r),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let n=this.inputVariables;this.partialVariables&&(n=n.concat(Object.keys(this.partialVariables))),Sc(this.template,this.templateFormat,n)}}static lc_name(){return"PromptTemplate"}_getPromptType(){return"prompt"}async format(r){const n=await this.mergePartialAndUserVariables(r);return En(this.template,this.templateFormat,n)}static fromExamples(r,n,s,i=`

`,a=""){const o=[a,...r,n].join(i);return new ro({inputVariables:s,template:o})}static fromTemplate(r,n){const{templateFormat:s="f-string",...i}=n??{},a=new Set;return gu(r,s).forEach(o=>{o.type==="variable"&&a.add(o.name)}),new ro({inputVariables:[...a],templateFormat:s,template:r,...i})}async partial(r){const n=this.inputVariables.filter(a=>!(a in r)),s={...this.partialVariables??{},...r},i={...this,inputVariables:n,partialVariables:s};return new ro(i)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(r){if(!r.template)throw new Error("Prompt template must have a template");return new ro({inputVariables:r.input_variables,template:r.template,templateFormat:r.template_format})}},Sl=class nT extends vc{constructor(r){super(r);p(this,"lc_namespace",["langchain_core","prompts","image"]);p(this,"template");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);p(this,"additionalContentFields");if(this.template=r.template,this.templateFormat=r.templateFormat??this.templateFormat,this.validateTemplate=r.validateTemplate??this.validateTemplate,this.additionalContentFields=r.additionalContentFields,this.validateTemplate){let n=this.inputVariables;this.partialVariables&&(n=n.concat(Object.keys(this.partialVariables))),Sc([{type:"image_url",image_url:this.template}],this.templateFormat,n)}}static lc_name(){return"ImagePromptTemplate"}_getPromptType(){return"prompt"}async partial(r){const n=this.inputVariables.filter(a=>!(a in r)),s={...this.partialVariables??{},...r},i={...this,inputVariables:n,partialVariables:s};return new nT(i)}async format(r){const n={};for(const[o,c]of Object.entries(this.template))typeof c=="string"?n[o]=En(c,this.templateFormat,r):n[o]=c;const s=r.url||n.url,i=r.detail||n.detail;if(!s)throw new Error("Must provide either an image URL.");if(typeof s!="string")throw new Error("url must be a string.");const a={url:s};return i&&(a.detail=i),a}async formatPromptValue(r){const n=await this.format(r);return new ox(n)}},Bp=class extends Fe{constructor(e){const r=e.templateFormat??"f-string",n=jp(e.template,r);super({inputVariables:n,...e});p(this,"lc_namespace",["langchain_core","prompts","dict"]);p(this,"lc_serializable",!0);p(this,"template");p(this,"templateFormat");p(this,"inputVariables");this.template=e.template,this.templateFormat=r,this.inputVariables=n}static lc_name(){return"DictPromptTemplate"}async format(e){return Fp(this.template,e,this.templateFormat)}async invoke(e){return await this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})}};function jp(t,e){const r=[];for(const n of Object.values(t))if(typeof n=="string")gu(n,e).forEach(s=>{s.type==="variable"&&r.push(s.name)});else if(Array.isArray(n))for(const s of n)typeof s=="string"?gu(s,e).forEach(i=>{i.type==="variable"&&r.push(i.name)}):typeof s=="object"&&r.push(...jp(s,e));else typeof n=="object"&&n!==null&&r.push(...jp(n,e));return Array.from(new Set(r))}function Fp(t,e,r){const n={};for(const[s,i]of Object.entries(t))if(typeof i=="string")n[s]=En(i,r,e);else if(Array.isArray(i)){const a=[];for(const o of i)typeof o=="string"?a.push(En(o,r,e)):typeof o=="object"&&a.push(Fp(o,e,r));n[s]=a}else typeof i=="object"&&i!==null?n[s]=Fp(i,e,r):n[s]=i;return n}var gd=class extends Fe{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","prompts","chat"]);p(this,"lc_serializable",!0)}async invoke(e,r){return this._callWithConfig(n=>this.formatMessages(n),e,{...r,runType:"prompt"})}},zp=class extends gd{constructor(e){typeof e=="string"&&(e={variableName:e});super(e);p(this,"variableName");p(this,"optional");this.variableName=e.variableName,this.optional=e.optional??!1}static lc_name(){return"MessagesPlaceholder"}get inputVariables(){return[this.variableName]}async formatMessages(e){const r=e[this.variableName];if(this.optional&&!r)return[];if(!r){const s=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw s.name="InputFormatError",s}let n;try{Array.isArray(r)?n=r.map(Hn):n=[Hn(r)]}catch(s){const i=typeof r=="string"?r:JSON.stringify(r,null,2),a=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${i}`,`Additional message: ${s.message}`].join(`

`));throw a.name="InputFormatError",a.lc_error_code=s.lc_error_code,a}return n}},sT=class extends gd{constructor(e){"prompt"in e||(e={prompt:e});super(e);p(this,"prompt");this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},Pg=class extends vc{constructor(t){super(t)}async format(t){return(await this.formatPromptValue(t)).toString()}async formatPromptValue(t){const e=await this.formatMessages(t);return new xg(e)}},iT=class extends sT{constructor(e,r){"prompt"in e||(e={prompt:e,role:r});super(e);p(this,"role");this.role=e.role}static lc_name(){return"ChatMessagePromptTemplate"}async format(e){return new Kn(await this.prompt.format(e),this.role)}static fromTemplate(e,r,n){return new this(Fs.fromTemplate(e,{templateFormat:n==null?void 0:n.templateFormat}),r)}};function JM(t){return t===null||typeof t!="object"||Array.isArray(t)?!1:Object.keys(t).length===1&&"text"in t&&typeof t.text=="string"}function ZM(t){return t===null||typeof t!="object"||Array.isArray(t)?!1:"image_url"in t&&(typeof t.image_url=="string"||typeof t.image_url=="object"&&t.image_url!==null&&"url"in t.image_url&&typeof t.image_url.url=="string")}var Lg=class extends gd{constructor(e,r){"prompt"in e||(e={prompt:e});super(e);p(this,"lc_namespace",["langchain_core","prompts","chat"]);p(this,"lc_serializable",!0);p(this,"inputVariables",[]);p(this,"additionalOptions",{});p(this,"prompt");p(this,"messageClass");p(this,"chatMessageClass");if(this.prompt=e.prompt,Array.isArray(this.prompt)){let n=[];this.prompt.forEach(s=>{"inputVariables"in s&&(n=n.concat(s.inputVariables))}),this.inputVariables=n}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=r??this.additionalOptions}static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}createMessage(e){const r=this.constructor;if(r._messageClass()){const n=r._messageClass();return new n({content:e})}else if(r.chatMessageClass){const n=r.chatMessageClass();return new n({content:e,role:this.getRoleFromMessageClass(n.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,r){if(typeof e=="string")return new this(Fs.fromTemplate(e,r));const n=[];for(const s of e)if(typeof s=="string")n.push(Fs.fromTemplate(s,r));else if(s!==null)if(JM(s)){let i="";typeof s.text=="string"&&(i=s.text??"");const a={...r,additionalContentFields:s};n.push(Fs.fromTemplate(i,a))}else if(ZM(s)){let i=s.image_url??"",a,o=[];if(typeof i=="string"){let c;(r==null?void 0:r.templateFormat)==="mustache"?c=pu(i):c=Wo(i);const l=c.flatMap(u=>u.type==="variable"?[u.name]:[]);if(((l==null?void 0:l.length)??0)>0){if(l.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${l}
From: ${i}`);o=[l[0]]}else o=[];i={url:i},a=new Sl({template:i,inputVariables:o,templateFormat:r==null?void 0:r.templateFormat,additionalContentFields:s})}else if(typeof i=="object"){if("url"in i){let c;(r==null?void 0:r.templateFormat)==="mustache"?c=pu(i.url):c=Wo(i.url),o=c.flatMap(l=>l.type==="variable"?[l.name]:[])}else o=[];a=new Sl({template:i,inputVariables:o,templateFormat:r==null?void 0:r.templateFormat,additionalContentFields:s})}else throw new Error("Invalid image template");n.push(a)}else typeof s=="object"&&n.push(new Bp({template:s,templateFormat:r==null?void 0:r.templateFormat}));return new this({prompt:n,additionalOptions:r})}async format(e){if(this.prompt instanceof Ho){const r=await this.prompt.format(e);return this.createMessage(r)}else{const r=[];for(const n of this.prompt){let s={};if(!("inputVariables"in n))throw new Error(`Prompt ${n} does not have inputVariables defined.`);for(const i of n.inputVariables)s||(s={[i]:e[i]}),s={...s,[i]:e[i]};if(n instanceof Ho){const i=await n.format(s);let a;"additionalContentFields"in n&&(a=n.additionalContentFields),i!==""&&r.push({...a,type:"text",text:i})}else if(n instanceof Sl){const i=await n.format(s);let a;"additionalContentFields"in n&&(a=n.additionalContentFields),r.push({...a,type:"image_url",image_url:i})}else if(n instanceof Bp){const i=await n.format(s);let a;"additionalContentFields"in n&&(a=n.additionalContentFields),r.push({...a,...i})}}return this.createMessage(r)}}async formatMessages(e){return[await this.format(e)]}},Mg=class extends Lg{static _messageClass(){return ut}static lc_name(){return"HumanMessagePromptTemplate"}},aT=class extends Lg{static _messageClass(){return ht}static lc_name(){return"AIMessagePromptTemplate"}},oT=class extends Lg{static _messageClass(){return dt}static lc_name(){return"SystemMessagePromptTemplate"}};function KM(t){return typeof t.formatMessages=="function"}function XM(t,e){if(KM(t)||St(t))return t;if(Array.isArray(t)&&t[0]==="placeholder"){const s=t[1];if((e==null?void 0:e.templateFormat)==="mustache"&&typeof s=="string"&&s.slice(0,2)==="{{"&&s.slice(-2)==="}}"){const i=s.slice(2,-2);return new zp({variableName:i,optional:!0})}else if(typeof s=="string"&&s[0]==="{"&&s[s.length-1]==="}"){const i=s.slice(1,-1);return new zp({variableName:i,optional:!0})}throw new Error(`Invalid placeholder template for format ${(e==null?void 0:e.templateFormat)??'"f-string"'}: "${t[1]}". Expected a variable name surrounded by ${(e==null?void 0:e.templateFormat)==="mustache"?"double":"single"} curly braces.`)}const r=Hn(t);let n;if(typeof r.content=="string"?n=r.content:n=r.content.map(s=>"text"in s?{...s,text:s.text}:"image_url"in s?{...s,image_url:s.image_url}:s),r._getType()==="human")return Mg.fromTemplate(n,e);if(r._getType()==="ai")return aT.fromTemplate(n,e);if(r._getType()==="system")return oT.fromTemplate(n,e);if(Kn.isInstance(r))return iT.fromTemplate(r.content,r.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${r._getType()}".`)}function YM(t){return t.constructor.lc_name()==="MessagesPlaceholder"}var Dg=class xl extends Pg{constructor(r){super(r);p(this,"promptMessages");p(this,"validateTemplate",!0);p(this,"templateFormat","f-string");if(r.templateFormat==="mustache"&&r.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,r),this.validateTemplate){const n=new Set;for(const c of this.promptMessages)if(!(c instanceof nn))for(const l of c.inputVariables)n.add(l);const s=this.inputVariables,i=new Set(this.partialVariables?s.concat(Object.keys(this.partialVariables)):s),a=new Set([...i].filter(c=>!n.has(c)));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are not used in any of the prompt messages.`);const o=new Set([...n].filter(c=>!i.has(c)));if(o.size>0)throw new Error(`Input variables \`${[...o]}\` are used in prompt messages but not in the prompt template.`)}}static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}_getPromptType(){return"chat"}async _parseImagePrompts(r,n){if(typeof r.content=="string")return r;const s=await Promise.all(r.content.map(async i=>{if(i.type!=="image_url")return i;let a="";typeof i.image_url=="string"?a=i.image_url:typeof i.image_url=="object"&&i.image_url!==null&&"url"in i.image_url&&typeof i.image_url.url=="string"&&(a=i.image_url.url);const c=await Fs.fromTemplate(a,{templateFormat:this.templateFormat}).format(n);return typeof i.image_url=="object"&&i.image_url!==null&&"url"in i.image_url?i.image_url.url=c:i.image_url=c,i}));return r.content=s,r}async formatMessages(r){const n=await this.mergePartialAndUserVariables(r);let s=[];for(const i of this.promptMessages)if(i instanceof nn)s.push(await this._parseImagePrompts(i,n));else{let a;this.templateFormat==="mustache"?a={...n}:a=i.inputVariables.reduce((c,l)=>{if(!(l in n)&&!(YM(i)&&i.optional))throw id(new Error(`Missing value for input variable \`${l.toString()}\``),"INVALID_PROMPT_INPUT");return c[l]=n[l],c},{});const o=await i.formatMessages(a);s=s.concat(o)}return s}async partial(r){const n=this.inputVariables.filter(a=>!(a in r)),s={...this.partialVariables??{},...r},i={...this,inputVariables:n,partialVariables:s};return new xl(i)}static fromTemplate(r,n){const s=Fs.fromTemplate(r,n),i=new Mg({prompt:s});return this.fromMessages([i])}static fromMessages(r,n){const s=r.reduce((o,c)=>o.concat(c instanceof xl?c.promptMessages:[XM(c,n)]),[]),i=r.reduce((o,c)=>c instanceof xl?Object.assign(o,c.partialVariables):o,Object.create(null)),a=new Set;for(const o of s)if(!(o instanceof nn))for(const c of o.inputVariables)c in i||a.add(c);return new this({...n,inputVariables:[...a],promptMessages:s,partialVariables:i,templateFormat:n==null?void 0:n.templateFormat})}},QM=class Vp extends Ho{constructor(r){super(r);p(this,"lc_serializable",!1);p(this,"examples");p(this,"exampleSelector");p(this,"examplePrompt");p(this,"suffix","");p(this,"exampleSeparator",`

`);p(this,"prefix","");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);if(Object.assign(this,r),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let n=this.inputVariables;this.partialVariables&&(n=n.concat(Object.keys(this.partialVariables))),Sc(this.prefix+this.suffix,this.templateFormat,n)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(r){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(r);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(r){const n=this.inputVariables.filter(a=>!(a in r)),s={...this.partialVariables??{},...r},i={...this,inputVariables:n,partialVariables:s};return new Vp(i)}async format(r){const n=await this.mergePartialAndUserVariables(r),s=await this.getExamples(n),i=await Promise.all(s.map(o=>this.examplePrompt.format(o))),a=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return En(a,this.templateFormat,n)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(r){const{example_prompt:n}=r;if(!n)throw new Error("Missing example prompt");const s=await Fs.deserialize(n);let i;if(Array.isArray(r.examples))i=r.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new Vp({inputVariables:r.input_variables,examplePrompt:s,examples:i,exampleSeparator:r.example_separator,prefix:r.prefix,suffix:r.suffix,templateFormat:r.template_format})}},eD=class cT extends Pg{constructor(r){super(r);p(this,"lc_serializable",!0);p(this,"examples");p(this,"exampleSelector");p(this,"examplePrompt");p(this,"suffix","");p(this,"exampleSeparator",`

`);p(this,"prefix","");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);if(this.examples=r.examples,this.examplePrompt=r.examplePrompt,this.exampleSeparator=r.exampleSeparator??`

`,this.exampleSelector=r.exampleSelector,this.prefix=r.prefix??"",this.suffix=r.suffix??"",this.templateFormat=r.templateFormat??"f-string",this.validateTemplate=r.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let n=this.inputVariables;this.partialVariables&&(n=n.concat(Object.keys(this.partialVariables))),Sc(this.prefix+this.suffix,this.templateFormat,n)}}_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}async getExamples(r){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(r);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(r){const n=await this.mergePartialAndUserVariables(r);let s=await this.getExamples(n);s=s.map(a=>{const o={};return this.examplePrompt.inputVariables.forEach(c=>{o[c]=a[c]}),o});const i=[];for(const a of s){const o=await this.examplePrompt.formatMessages(a);i.push(...o)}return i}async format(r){const n=await this.mergePartialAndUserVariables(r),s=await this.getExamples(n),a=(await Promise.all(s.map(c=>this.examplePrompt.formatMessages(c)))).flat().map(c=>c.content),o=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return En(o,this.templateFormat,n)}async partial(r){const n=this.inputVariables.filter(a=>!(a in r)),s={...this.partialVariables??{},...r},i={...this,inputVariables:n,partialVariables:s};return new cT(i)}},tD=class Tl extends vc{constructor(r){super({...r,inputVariables:[]});p(this,"pipelinePrompts");p(this,"finalPrompt");this.pipelinePrompts=r.pipelinePrompts,this.finalPrompt=r.finalPrompt,this.inputVariables=this.computeInputValues()}static lc_name(){return"PipelinePromptTemplate"}computeInputValues(){const r=this.pipelinePrompts.map(s=>s.name),n=this.pipelinePrompts.map(s=>s.prompt.inputVariables.filter(i=>!r.includes(i))).flat();return[...new Set(n)]}static extractRequiredInputValues(r,n){return n.reduce((s,i)=>(s[i]=r[i],s),{})}async formatPipelinePrompts(r){const n=await this.mergePartialAndUserVariables(r);for(const{name:s,prompt:i}of this.pipelinePrompts){const a=Tl.extractRequiredInputValues(n,i.inputVariables);i instanceof Dg?n[s]=await i.formatMessages(a):n[s]=await i.format(a)}return Tl.extractRequiredInputValues(n,this.finalPrompt.inputVariables)}async formatPromptValue(r){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(r))}async format(r){return this.finalPrompt.format(await this.formatPipelinePrompts(r))}async partial(r){const n={...this};return n.inputVariables=this.inputVariables.filter(s=>!(s in r)),n.partialVariables={...this.partialVariables??{},...r},new Tl(n)}serialize(){throw new Error("Not implemented.")}_getPromptType(){return"pipeline"}};function Eb(t){return typeof t=="object"&&t!=null&&"withStructuredOutput"in t&&typeof t.withStructuredOutput=="function"}function rD(t){return typeof t=="object"&&t!=null&&"lc_id"in t&&Array.isArray(t.lc_id)&&t.lc_id.join("/")==="langchain_core/runnables/RunnableBinding"}var nD=class lT extends Dg{constructor(r){super(r);p(this,"schema");p(this,"method");p(this,"lc_namespace",["langchain_core","prompts","structured"]);this.schema=r.schema,this.method=r.method}get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}pipe(r){if(Eb(r))return super.pipe(r.withStructuredOutput(this.schema));if(rD(r)&&Eb(r.bound))return super.pipe(new Zs({bound:r.bound.withStructuredOutput(this.schema,...this.method?[{method:this.method}]:[]),kwargs:r.kwargs??{},config:r.config,configFactories:r.configFactories}));throw new Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(r,n,s){return lT.fromMessages(r,{schema:n,method:s})}},uT={};ve(uT,{AIMessagePromptTemplate:()=>aT,BaseChatPromptTemplate:()=>Pg,BaseMessagePromptTemplate:()=>gd,BaseMessageStringPromptTemplate:()=>sT,BasePromptTemplate:()=>vc,BaseStringPromptTemplate:()=>Ho,ChatMessagePromptTemplate:()=>iT,ChatPromptTemplate:()=>Dg,DEFAULT_FORMATTER_MAPPING:()=>mu,DEFAULT_PARSER_MAPPING:()=>rT,DictPromptTemplate:()=>Bp,FewShotChatMessagePromptTemplate:()=>eD,FewShotPromptTemplate:()=>QM,HumanMessagePromptTemplate:()=>Mg,ImagePromptTemplate:()=>Sl,MessagesPlaceholder:()=>zp,PipelinePromptTemplate:()=>tD,PromptTemplate:()=>Fs,StructuredPrompt:()=>nD,SystemMessagePromptTemplate:()=>oT,checkValidTemplate:()=>Sc,interpolateFString:()=>eT,interpolateMustache:()=>tT,parseFString:()=>Wo,parseMustache:()=>pu,parseTemplate:()=>gu,renderTemplate:()=>En});var dT={};ve(dT,{BaseDocumentCompressor:()=>sD});var sD=class{static isBaseDocumentCompressor(t){return(t==null?void 0:t.compressDocuments)!==void 0}};const Ds={and:"and",or:"or",not:"not"},je={eq:"eq",ne:"ne",lt:"lt",gt:"gt",lte:"lte",gte:"gte"};var hT=class{},Ug=class{accept(t){if(this.exprName==="Operation")return t.visitOperation(this);if(this.exprName==="Comparison")return t.visitComparison(this);if(this.exprName==="StructuredQuery")return t.visitStructuredQuery(this);throw new Error("Unknown Expression type")}},Bg=class extends Ug{},iD=class extends Bg{constructor(e,r,n){super();p(this,"exprName","Comparison");this.comparator=e,this.attribute=r,this.value=n}},aD=class extends Bg{constructor(e,r){super();p(this,"exprName","Operation");this.operator=e,this.args=r}},oD=class extends Ug{constructor(e,r){super();p(this,"exprName","StructuredQuery");this.query=e,this.filter=r}};function fT(t){return t&&typeof t=="object"&&!Array.isArray(t)}function wn(t){return t?typeof t=="string"&&t.length>0||typeof t=="function"?!1:fT(t)&&Object.keys(t).length===0:!0}function pT(t){if(typeof t=="number")return t%1===0;if(typeof t=="string"){const e=parseInt(t,10);return!Number.isNaN(e)&&e%1===0&&e.toString()===t}return!1}function mT(t){if(typeof t=="number")return t%1!==0;if(typeof t=="string"){const e=parseFloat(t);return!Number.isNaN(e)&&e%1!==0&&e.toString()===t}return!1}function gT(t){return typeof t=="string"&&(Number.isNaN(parseFloat(t))||parseFloat(t).toString()!==t)}function yT(t){return typeof t=="boolean"}function jg(t){let e;if(gT(t))e=t;else if(pT(t))e=parseInt(t,10);else if(mT(t))e=parseFloat(t);else if(yT(t))e=!!t;else throw new Error("Unsupported value type");return e}var Fg=class extends hT{},cD=class extends Fg{constructor(e){super();p(this,"allowedOperators");p(this,"allowedComparators");this.allowedOperators=(e==null?void 0:e.allowedOperators)??[Ds.and,Ds.or],this.allowedComparators=(e==null?void 0:e.allowedComparators)??[je.eq,je.ne,je.gt,je.gte,je.lt,je.lte]}formatFunction(e){if(e in je){if(this.allowedComparators.length>0&&this.allowedComparators.indexOf(e)===-1)throw new Error(`Comparator ${e} not allowed. Allowed comparators: ${this.allowedComparators.join(", ")}`)}else if(e in Ds){if(this.allowedOperators.length>0&&this.allowedOperators.indexOf(e)===-1)throw new Error(`Operator ${e} not allowed. Allowed operators: ${this.allowedOperators.join(", ")}`)}else throw new Error("Unknown comparator or operator");return`$${e}`}visitOperation(e){var n;const r=(n=e.args)==null?void 0:n.map(s=>s.accept(this));return{[this.formatFunction(e.operator)]:r}}visitComparison(e){return{[e.attribute]:{[this.formatFunction(e.comparator)]:jg(e.value)}}}visitStructuredQuery(e){let r={};return e.filter&&(r={filter:e.filter.accept(this)}),r}mergeFilters(e,r,n="and",s=!1){if(!(wn(e)&&wn(r))){if(wn(e)||n==="replace")return wn(r)?void 0:r;if(wn(r))return s?e:n==="and"?void 0:e;if(n==="and")return{$and:[e,r]};if(n==="or")return{$or:[e,r]};throw new Error("Unknown merge type")}}},lD=class extends Fg{constructor(){super(...arguments);p(this,"allowedOperators",[Ds.and,Ds.or]);p(this,"allowedComparators",[je.eq,je.ne,je.gt,je.gte,je.lt,je.lte])}formatFunction(){throw new Error("Not implemented")}getAllowedComparatorsForType(e){switch(e){case"string":return[je.eq,je.ne,je.gt,je.gte,je.lt,je.lte];case"number":return[je.eq,je.ne,je.gt,je.gte,je.lt,je.lte];case"boolean":return[je.eq,je.ne];default:throw new Error(`Unsupported data type: ${e}`)}}getComparatorFunction(e){switch(e){case je.eq:return(r,n)=>r===n;case je.ne:return(r,n)=>r!==n;case je.gt:return(r,n)=>r>n;case je.gte:return(r,n)=>r>=n;case je.lt:return(r,n)=>r<n;case je.lte:return(r,n)=>r<=n;default:throw new Error("Unknown comparator")}}getOperatorFunction(e){switch(e){case Ds.and:return(r,n)=>r&&n;case Ds.or:return(r,n)=>r||n;default:throw new Error("Unknown operator")}}visitOperation(e){const{operator:r,args:n}=e;if(this.allowedOperators.includes(r)){const s=this.getOperatorFunction(r);return i=>n?n.reduce((a,o)=>{const c=o.accept(this);if(typeof c=="function")return s(a,c(i));throw new Error("Filter is not a function")},!0):!0}else throw new Error("Operator not allowed")}visitComparison(e){const{comparator:r,attribute:n,value:s}=e,i=[je.ne];if(this.allowedComparators.includes(r)){if(!this.getAllowedComparatorsForType(typeof s).includes(r))throw new Error(`'${r}' comparator not allowed to be used with ${typeof s}`);const a=this.getComparatorFunction(r);return o=>{const c=o.metadata[n];return c===void 0?!!i.includes(r):a(c,jg(s))}}else throw new Error("Comparator not allowed")}visitStructuredQuery(e){var n;if(!e.filter)return{};const r=(n=e.filter)==null?void 0:n.accept(this);if(typeof r!="function")throw new Error("Structured query filter is not a function");return{filter:r}}mergeFilters(e,r,n="and"){if(!(wn(e)&&wn(r))){if(wn(e)||n==="replace")return wn(r)?void 0:r;if(wn(r))return n==="and"?void 0:e;if(n==="and")return s=>e(s)&&r(s);if(n==="or")return s=>e(s)||r(s);throw new Error("Unknown merge type")}}},_T={};ve(_T,{BaseTranslator:()=>Fg,BasicTranslator:()=>cD,Comparators:()=>je,Comparison:()=>iD,Expression:()=>Ug,FilterDirective:()=>Bg,FunctionalTranslator:()=>lD,Operation:()=>aD,Operators:()=>Ds,StructuredQuery:()=>oD,Visitor:()=>hT,castValue:()=>jg,isBoolean:()=>yT,isFilterEmpty:()=>wn,isFloat:()=>mT,isInt:()=>pT,isObject:()=>fT,isString:()=>gT});function zg(t){return t!==void 0&&Array.isArray(t.lc_namespace)}function Vg(t){return t!==void 0&&Fe.isRunnable(t)&&"lc_name"in t.constructor&&typeof t.constructor.lc_name=="function"&&t.constructor.lc_name()==="RunnableToolLike"}function qg(t){return!!t&&typeof t=="object"&&"name"in t&&"schema"in t&&(tn(t.schema)||t.schema!=null&&typeof t.schema=="object"&&"type"in t.schema&&typeof t.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(t.schema.type))}function xc(t){return qg(t)||Vg(t)||zg(t)}const uD=(t,e)=>{_S.init(t,e),t.name="ZodError",Object.defineProperties(t,{format:{value:r=>PN(t,r)},flatten:{value:r=>NN(t,r)},addIssue:{value:r=>t.issues.push(r)},addIssues:{value:r=>t.issues.push(...r)},isEmpty:{get(){return t.issues.length===0}}})},yd=Le("ZodError",uD,{Parent:Error}),dD=wS(yd),hD=bS(yd),fD=ES(yd),pD=SS(yd),$r=Le("ZodType",(t,e)=>(rr.init(t,e),t.def=e,Object.defineProperty(t,"_def",{value:e}),t.check=(...r)=>t.clone({...e,checks:[...e.checks??[],...r.map(n=>typeof n=="function"?{_zod:{check:n,def:{check:"custom"},onattach:[]}}:n)]}),t.clone=(r,n)=>Jn(t,r,n),t.brand=()=>t,t.register=((r,n)=>(r.add(t,n),t)),t.parse=(r,n)=>dD(t,r,n,{callee:t.parse}),t.safeParse=(r,n)=>fD(t,r,n),t.parseAsync=async(r,n)=>hD(t,r,n,{callee:t.parseAsync}),t.safeParseAsync=async(r,n)=>pD(t,r,n),t.spa=t.safeParseAsync,t.refine=(r,n)=>t.check(BD(r,n)),t.superRefine=r=>t.check(jD(r)),t.overwrite=r=>t.check(dP(r)),t.optional=()=>Sb(t),t.nullable=()=>xb(t),t.nullish=()=>Sb(xb(t)),t.nonoptional=r=>OD(t,r),t.array=()=>yD(t),t.or=r=>wD([t,r]),t.and=r=>vD(t,r),t.transform=r=>Tb(t,SD(r)),t.default=r=>CD(t,r),t.prefault=r=>ID(t,r),t.catch=r=>ND(t,r),t.pipe=r=>Tb(t,r),t.readonly=()=>MD(t),t.describe=r=>{const n=t.clone();return Ut.add(n,{description:r}),n},Object.defineProperty(t,"description",{get(){var r;return(r=Ut.get(t))==null?void 0:r.description},configurable:!0}),t.meta=(...r)=>{if(r.length===0)return Ut.get(t);const n=t.clone();return Ut.add(n,r[0]),n},t.isOptional=()=>t.safeParse(void 0).success,t.isNullable=()=>t.safeParse(null).success,t)),mD=Le("ZodAny",(t,e)=>{qN.init(t,e),$r.init(t,e)});function Wc(){return aP(mD)}const gD=Le("ZodArray",(t,e)=>{WN.init(t,e),$r.init(t,e),t.element=e.element,t.min=(r,n)=>t.check(qw(r,n)),t.nonempty=r=>t.check(qw(1,r)),t.max=(r,n)=>t.check(lP(r,n)),t.length=(r,n)=>t.check(uP(r,n)),t.unwrap=()=>t.element});function yD(t,e){return hP(gD,t,e)}const _D=Le("ZodUnion",(t,e)=>{JN.init(t,e),$r.init(t,e),t.options=e.options});function wD(t,e){return new _D({type:"union",options:t,...Qs(e)})}const bD=Le("ZodIntersection",(t,e)=>{ZN.init(t,e),$r.init(t,e)});function vD(t,e){return new bD({type:"intersection",left:t,right:e})}const ED=Le("ZodTransform",(t,e)=>{KN.init(t,e),$r.init(t,e),t._zod.parse=(r,n)=>{r.addIssue=i=>{if(typeof i=="string")r.issues.push(Bo(i,r.value,e));else{const a=i;a.fatal&&(a.continue=!1),a.code??(a.code="custom"),a.input??(a.input=r.value),a.inst??(a.inst=t),a.continue??(a.continue=!0),r.issues.push(Bo(a))}};const s=e.transform(r.value,r);return s instanceof Promise?s.then(i=>(r.value=i,r)):(r.value=s,r)}});function SD(t){return new ED({type:"transform",transform:t})}const xD=Le("ZodOptional",(t,e)=>{dg.init(t,e),$r.init(t,e),t.unwrap=()=>t._zod.def.innerType});function Sb(t){return new xD({type:"optional",innerType:t})}const TD=Le("ZodNullable",(t,e)=>{XN.init(t,e),$r.init(t,e),t.unwrap=()=>t._zod.def.innerType});function xb(t){return new TD({type:"nullable",innerType:t})}const AD=Le("ZodDefault",(t,e)=>{YN.init(t,e),$r.init(t,e),t.unwrap=()=>t._zod.def.innerType,t.removeDefault=t.unwrap});function CD(t,e){return new AD({type:"default",innerType:t,get defaultValue(){return typeof e=="function"?e():e}})}const kD=Le("ZodPrefault",(t,e)=>{QN.init(t,e),$r.init(t,e),t.unwrap=()=>t._zod.def.innerType});function ID(t,e){return new kD({type:"prefault",innerType:t,get defaultValue(){return typeof e=="function"?e():e}})}const RD=Le("ZodNonOptional",(t,e)=>{eP.init(t,e),$r.init(t,e),t.unwrap=()=>t._zod.def.innerType});function OD(t,e){return new RD({type:"nonoptional",innerType:t,...Qs(e)})}const $D=Le("ZodCatch",(t,e)=>{tP.init(t,e),$r.init(t,e),t.unwrap=()=>t._zod.def.innerType,t.removeCatch=t.unwrap});function ND(t,e){return new $D({type:"catch",innerType:t,catchValue:typeof e=="function"?e:()=>e})}const PD=Le("ZodPipe",(t,e)=>{rP.init(t,e),$r.init(t,e),t.in=e.in,t.out=e.out});function Tb(t,e){return new PD({type:"pipe",in:t,out:e})}const LD=Le("ZodReadonly",(t,e)=>{nP.init(t,e),$r.init(t,e)});function MD(t){return new LD({type:"readonly",innerType:t})}const DD=Le("ZodCustom",(t,e)=>{sP.init(t,e),$r.init(t,e)});function UD(t){const e=new Da({check:"custom"});return e._zod.check=t,e}function BD(t,e={}){return fP(DD,t,e)}function jD(t){const e=UD(r=>(r.addIssue=n=>{if(typeof n=="string")r.issues.push(Bo(n,r.value,e._zod.def));else{const s=n;s.fatal&&(s.continue=!1),s.code??(s.code="custom"),s.input??(s.input=r.value),s.inst??(s.inst=e),s.continue??(s.continue=!e._zod.def.abort),r.issues.push(Bo(s))}},t(r.value,r)));return e}var wT={};ve(wT,{BaseToolkit:()=>FD,DynamicStructuredTool:()=>ET,DynamicTool:()=>vT,StructuredTool:()=>_d,Tool:()=>bT,ToolInputParsingException:()=>Xl,isLangChainTool:()=>xc,isRunnableToolLike:()=>Vg,isStructuredTool:()=>zg,isStructuredToolParams:()=>qg,tool:()=>bn});var _d=class extends Rg{constructor(e){super(e??{});p(this,"returnDirect",!1);p(this,"verboseParsingErrors",!1);p(this,"responseFormat","content");p(this,"defaultConfig");this.verboseParsingErrors=(e==null?void 0:e.verboseParsingErrors)??this.verboseParsingErrors,this.responseFormat=(e==null?void 0:e.responseFormat)??this.responseFormat,this.defaultConfig=(e==null?void 0:e.defaultConfig)??this.defaultConfig,this.metadata=(e==null?void 0:e.metadata)??this.metadata}get lc_namespace(){return["langchain","tools"]}async invoke(e,r){let n,s=Ve(en(this.defaultConfig,r));return wo(e)?(n=e.args,s={...s,toolCall:e}):n=e,this.call(n,s)}async call(e,r,n){const s=wo(e)?e.args:e;let i;if(tn(this.schema))try{i=await ld(this.schema,s)}catch(m){let g="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(g=`${g}
Details: ${m.message}`),m instanceof Error&&m.constructor.name==="ZodError"&&(g=`${g}

${MN(m)}`),new Xl(g,JSON.stringify(e))}else{const m=ct(s,this.schema);if(!m.valid){let g="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(g=`${g}
Details: ${m.errors.map(y=>`${y.keywordLocation}: ${y.error}`).join(`
`)}`),new Xl(g,JSON.stringify(e))}i=s}const a=pc(r),o=pr.configure(a.callbacks,this.callbacks,a.tags||n,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),c=await(o==null?void 0:o.handleToolStart(this.toJSON(),typeof e=="string"?e:JSON.stringify(e),a.runId,void 0,void 0,void 0,a.runName));delete a.runId;let l;try{l=await this._call(i,c,a)}catch(m){throw await(c==null?void 0:c.handleToolError(m)),m}let u,d;if(this.responseFormat==="content_and_artifact")if(Array.isArray(l)&&l.length===2)[u,d]=l;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(l)}`);else u=l;let h;wo(e)&&(h=e.id),!h&&sN(a)&&(h=a.toolCall.id);const f=zD({content:u,artifact:d,toolCallId:h,name:this.name,metadata:this.metadata});return await(c==null?void 0:c.handleToolEnd(f)),f}},bT=class extends _d{constructor(r){super(r);p(this,"schema",jt({input:it().optional()}).transform(r=>r.input))}call(r,n){const s=typeof r=="string"||r==null?{input:r}:r;return super.call(s,n)}},vT=class extends bT{constructor(e){super(e);p(this,"name");p(this,"description");p(this,"func");this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect}static lc_name(){return"DynamicTool"}async call(e,r){const n=pc(r);return n.runName===void 0&&(n.runName=this.name),super.call(e,n)}async _call(e,r,n){return this.func(e,r,n)}},ET=class extends _d{constructor(e){super(e);p(this,"name");p(this,"description");p(this,"func");p(this,"schema");this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=e.schema}static lc_name(){return"DynamicStructuredTool"}async call(e,r,n){const s=pc(r);return s.runName===void 0&&(s.runName=this.name),super.call(e,s,n)}_call(e,r,n){return this.func(e,r,n)}},FD=class{getTools(){return this.tools}};function bn(t,e){var a;const r=hg(e.schema),n=vo(e.schema);if(!e.schema||r||n)return new vT({...e,description:e.description??((a=e.schema)==null?void 0:a.description)??`${e.name} tool`,func:async(o,c,l)=>new Promise((u,d)=>{const h=Ze(l,{callbacks:c==null?void 0:c.getChild()});Bt.runWithConfig(gs(h),async()=>{try{u(t(o,h))}catch(f){d(f)}})})});const s=e.schema,i=e.description??e.schema.description??`${e.name} tool`;return new ET({...e,description:i,schema:s,func:async(o,c,l)=>new Promise((u,d)=>{l!=null&&l.signal&&l.signal.addEventListener("abort",()=>d(Lo(l.signal)));const h=Ze(l,{callbacks:c==null?void 0:c.getChild()});Bt.runWithConfig(gs(h),async()=>{var f;try{const m=await t(o,h);if((f=l==null?void 0:l.signal)!=null&&f.aborted)return;u(m)}catch(m){d(m)}})})})}function zD(t){const{content:e,artifact:r,toolCallId:n,metadata:s}=t;return n&&!Vm(e)?typeof e=="string"||Array.isArray(e)&&e.every(i=>typeof i=="object")?new fr({status:"success",content:e,artifact:r,tool_call_id:n,name:t.name,metadata:s}):new fr({status:"success",content:VD(e),artifact:r,tool_call_id:n,name:t.name,metadata:s}):e}function VD(t){try{return JSON.stringify(t,null,2)??""}catch{return`${t}`}}var ST={};ve(ST,{RunCollectorCallbackHandler:()=>qD});var qD=class extends Es{constructor({exampleId:e}={}){super({_awaitHandler:!0});p(this,"name","run_collector");p(this,"exampleId");p(this,"tracedRuns");this.exampleId=e,this.tracedRuns=[]}async persistRun(e){const r={...e};r.reference_example_id=this.exampleId,this.tracedRuns.push(r)}},HD={},xT={};ve(xT,{chunkArray:()=>GD});const GD=(t,e)=>t.reduce((r,n,s)=>{const i=Math.floor(s/e),a=r[i]||[];return r[i]=a.concat([n]),r},[]);var TT={};ve(TT,{EventStreamContentType:()=>WD,convertEventStreamToIterableReadableDataStream:()=>ZD,getBytes:()=>AT,getLines:()=>CT,getMessages:()=>kT});const WD="text/event-stream";async function AT(t,e){if(t instanceof ReadableStream){const r=t.getReader();for(;;){const n=await r.read();if(n.done){e(new Uint8Array,!0);break}e(n.value)}}else try{for await(const r of t)e(new Uint8Array(r));e(new Uint8Array,!0)}catch(r){throw new Error(["Parsing event source stream failed.","Ensure your implementation of fetch returns a web or Node readable stream.",`Error: ${r.message}`].join(`
`))}}var ua=(function(t){return t[t.NewLine=10]="NewLine",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.Colon=58]="Colon",t})(ua||{});function CT(t){let e,r,n,s=!1;return function(a,o){if(o){t(a,0,!0);return}e===void 0?(e=a,r=0,n=-1):e=JD(e,a);const c=e.length;let l=0;for(;r<c;){s&&(e[r]===ua.NewLine&&(l=++r),s=!1);let u=-1;for(;r<c&&u===-1;++r)switch(e[r]){case ua.Colon:n===-1&&(n=r-l);break;case ua.CarriageReturn:s=!0;case ua.NewLine:u=r;break}if(u===-1)break;t(e.subarray(l,u),n),l=r,n=-1}l===c?e=void 0:l!==0&&(e=e.subarray(l),r-=l)}}function kT(t,e,r){let n=gf();const s=new TextDecoder;return function(a,o,c){if(c){KD(n)||(t==null||t(n),n=gf());return}if(a.length===0)t==null||t(n),n=gf();else if(o>0){const l=s.decode(a.subarray(0,o)),u=o+(a[o+1]===ua.Space?2:1),d=s.decode(a.subarray(u));switch(l){case"data":n.data=n.data?n.data+`
`+d:d;break;case"event":n.event=d;break;case"id":e==null||e(n.id=d);break;case"retry":{const h=parseInt(d,10);Number.isNaN(h)||r==null||r(n.retry=h);break}}}}}function JD(t,e){const r=new Uint8Array(t.length+e.length);return r.set(t),r.set(e,t.length),r}function gf(){return{data:"",event:"",id:"",retry:void 0}}function ZD(t,e){const r=new ReadableStream({async start(n){const s=kT(a=>{if(a.event==="error")throw new Error(a.data??"Unspecified event streaming error.");a.event==="metadata"?e==null||e(a):a.data&&n.enqueue(a.data)});await AT(t,CT((a,o,c)=>{s(a,o,c),c&&n.close()}))}});return kr.fromReadableStream(r)}function KD(t){return t.data===""&&t.event===""&&t.id===""&&t.retry===void 0}var IT={};ve(IT,{convertToOpenAIFunction:()=>RT,convertToOpenAITool:()=>OT,isLangChainTool:()=>xc,isRunnableToolLike:()=>Vg,isStructuredTool:()=>zg,isStructuredToolParams:()=>qg});function RT(t,e){const r=typeof e=="number"?void 0:e;return{name:t.name,description:t.description,parameters:ar(t.schema),...(r==null?void 0:r.strict)!==void 0?{strict:r.strict}:{}}}function OT(t,e){const r=typeof e=="number"?void 0:e;let n;return xc(t)?n={type:"function",function:RT(t)}:n=t,(r==null?void 0:r.strict)!==void 0&&(n.function.strict=r.strict),n}function $T(t,e){let r=0,n=0,s=0;for(let i=0;i<t.length;i++)r+=t[i]*e[i],n+=t[i]*t[i],s+=e[i]*e[i];return r/(Math.sqrt(n)*Math.sqrt(s))}function XD(t,e){let r=0;for(let n=0;n<t.length;n++)r+=t[n]*e[n];return r}function YD(t,e){let r=0;for(let n=0;n<t.length;n++)r+=(t[n]-e[n])*(t[n]-e[n]);return r}function QD(t,e){return Math.sqrt(YD(t,e))}var NT={};ve(NT,{cosineSimilarity:()=>qp,euclideanDistance:()=>r4,innerProduct:()=>t4,matrixFunc:()=>wd,maximalMarginalRelevance:()=>n4,normalize:()=>e4});function wd(t,e,r){if(t.length===0||t[0].length===0||e.length===0||e[0].length===0)return[[]];if(t[0].length!==e[0].length)throw new Error(`Number of columns in X and Y must be the same. X has shape ${[t.length,t[0].length]} and Y has shape ${[e.length,e[0].length]}.`);return t.map(n=>e.map(s=>r(n,s)).map(s=>Number.isNaN(s)?0:s))}function e4(t,e=!1){const r=s4(t);return t.map(n=>n.map(s=>e?1-s/r:s/r))}function qp(t,e){return wd(t,e,$T)}function t4(t,e){return wd(t,e,XD)}function r4(t,e){return wd(t,e,QD)}function n4(t,e,r=.5,n=4){if(Math.min(n,e.length)<=0)return[];const s=Array.isArray(t[0])?t:[t],i=qp(s,e)[0],a=PT(i).maxIndex,o=[e[a]],c=[a];for(;c.length<Math.min(n,e.length);){let l=-1/0,u=-1;const d=qp(e,o);i.forEach((h,f)=>{if(c.includes(f))return;const m=Math.max(...d[f]),g=r*h-(1-r)*m;g>l&&(l=g,u=f)}),o.push(e[u]),c.push(u)}return c}function PT(t){if(t.length===0)return{maxIndex:-1,maxValue:NaN};let e=t[0],r=0;for(let n=1;n<t.length;n+=1)t[n]>e&&(r=n,e=t[n]);return{maxIndex:r,maxValue:e}}function s4(t){return t.reduce((e,r)=>Math.max(e,PT(r).maxValue),0)}var i4=class extends Bi{_combineLLMOutput(){return[]}_llmType(){return"fake"}async _generate(t,e,r){var s;if((s=e==null?void 0:e.stop)!=null&&s.length)return{generations:[{message:new ht(e.stop[0]),text:e.stop[0]}]};const n=t.map(i=>typeof i.content=="string"?i.content:JSON.stringify(i.content,null,2)).join(`
`);return await(r==null?void 0:r.handleLLMNewToken(n)),{generations:[{message:new ht(n),text:n}],llmOutput:{}}}},a4=class LT extends Bi{constructor({sleep:r=50,responses:n=[],chunks:s=[],toolStyle:i="openai",thrownErrorString:a,...o}){super(o);p(this,"sleep",50);p(this,"responses",[]);p(this,"chunks",[]);p(this,"toolStyle","openai");p(this,"thrownErrorString");p(this,"tools",[]);this.sleep=r,this.responses=n,this.chunks=s,this.toolStyle=i,this.thrownErrorString=a}_llmType(){return"fake"}bindTools(r){const n=[...this.tools,...r],s=n.map(o=>{switch(this.toolStyle){case"openai":return{type:"function",function:{name:o.name,description:o.description,parameters:ar(o.schema)}};case"anthropic":return{name:o.name,description:o.description,input_schema:ar(o.schema)};case"bedrock":return{toolSpec:{name:o.name,description:o.description,inputSchema:ar(o.schema)}};case"google":return{name:o.name,description:o.description,parameters:ar(o.schema)};default:throw new Error(`Unsupported tool style: ${this.toolStyle}`)}}),i=this.toolStyle==="google"?[{functionDeclarations:s}]:s,a=new LT({sleep:this.sleep,responses:this.responses,chunks:this.chunks,toolStyle:this.toolStyle,thrownErrorString:this.thrownErrorString});return a.tools=n,a.withConfig({tools:i})}async _generate(r,n,s){var o,c,l,u;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const i=((c=(o=this.responses)==null?void 0:o[0])==null?void 0:c.content)??r[0].content??"";return{generations:[{text:"",message:new ht({content:i,tool_calls:(u=(l=this.chunks)==null?void 0:l[0])==null?void 0:u.tool_calls})}]}}async*_streamResponseChunks(r,n,s){var o,c,l;if(this.thrownErrorString)throw new Error(this.thrownErrorString);if((o=this.chunks)!=null&&o.length){for(const u of this.chunks){const d=new mr({message:new At({content:u.content,tool_calls:u.tool_calls,additional_kwargs:u.additional_kwargs??{}}),text:((c=u.content)==null?void 0:c.toString())??""});yield d,await(s==null?void 0:s.handleLLMNewToken(u.content,void 0,void 0,void 0,void 0,{chunk:d}))}return}const i=((l=this.responses)==null?void 0:l[0])??new ht(typeof r[0].content=="string"?r[0].content:""),a=typeof i.content=="string"?i.content:"";for(const u of a){await new Promise(h=>setTimeout(h,this.sleep));const d=new mr({message:new At({content:u}),text:u});yield d,await(s==null?void 0:s.handleLLMNewToken(u,void 0,void 0,void 0,void 0,{chunk:d}))}}},o4=class extends Bi{constructor(e){super(e);p(this,"lc_serializable",!0);p(this,"responses");p(this,"i",0);p(this,"sleep");p(this,"emitCustomEvent",!1);const{responses:r,sleep:n,emitCustomEvent:s}=e;this.responses=r,this.sleep=n,this.emitCustomEvent=s??this.emitCustomEvent}static lc_name(){return"FakeListChatModel"}_combineLLMOutput(){return[]}_llmType(){return"fake-list"}async _generate(e,r,n){var s;if(await this._sleepIfRequested(),r!=null&&r.thrownErrorString)throw new Error(r.thrownErrorString);if(this.emitCustomEvent&&await(n==null?void 0:n.handleCustomEvent("some_test_event",{someval:!0})),(s=r==null?void 0:r.stop)!=null&&s.length)return{generations:[this._formatGeneration(r.stop[0])]};{const i=this._currentResponse();return this._incrementResponse(),{generations:[this._formatGeneration(i)],llmOutput:{}}}}_formatGeneration(e){return{message:new ht(e),text:e}}async*_streamResponseChunks(e,r,n){const s=this._currentResponse();this._incrementResponse(),this.emitCustomEvent&&await(n==null?void 0:n.handleCustomEvent("some_test_event",{someval:!0}));for await(const i of s){if(await this._sleepIfRequested(),r!=null&&r.thrownErrorString)throw new Error(r.thrownErrorString);yield this._createResponseChunk(i),n==null||n.handleLLMNewToken(i)}}async _sleepIfRequested(){this.sleep!==void 0&&await this._sleep()}async _sleep(){return new Promise(e=>{setTimeout(()=>e(),this.sleep)})}_createResponseChunk(e){return new mr({message:new At({content:e}),text:e})}_currentResponse(){return this.responses[this.i]}_incrementResponse(){this.i<this.responses.length-1?this.i+=1:this.i=0}withStructuredOutput(e,r){return Cn.from(async n=>{var i,a;const s=await this.invoke(n);if((a=(i=s.tool_calls)==null?void 0:i[0])!=null&&a.args)return s.tool_calls[0].args;if(typeof s.content=="string")return JSON.parse(s.content);throw new Error("No structured output found")})}},c4=class extends Eg{constructor(e){super(e??{});p(this,"vectorSize");this.vectorSize=(e==null?void 0:e.vectorSize)??4}async embedDocuments(e){return Promise.all(e.map(r=>this.embedQuery(r)))}async embedQuery(e){let r=e;r=r.toLowerCase().replaceAll(/[^a-z ]/g,"");const n=r.length%this.vectorSize,s=n===0?0:this.vectorSize-n,i=r.length+s;r=r.padEnd(i," ");const a=r.length/this.vectorSize,o=[];for(let l=0;l<r.length;l+=a)o.push(r.slice(l,l+a));return o.map(l=>{let u=0;for(let h=0;h<l.length;h+=1)u+=l===" "?0:l.charCodeAt(h);return u%26/26})}},l4=class extends Eg{constructor(t){super(t??{})}embedDocuments(t){return Promise.resolve(t.map(()=>[.1,.2,.3,.4]))}embedQuery(t){return Promise.resolve([.1,.2,.3,.4])}},u4=class extends $g{constructor(e){super(e);p(this,"response");p(this,"thrownErrorString");this.response=e.response,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e,r,n){if(this.thrownErrorString)throw new Error(this.thrownErrorString);const s=this.response??e;return await(n==null?void 0:n.handleLLMNewToken(s)),s}},d4=class extends $g{constructor(e){super(e);p(this,"sleep",50);p(this,"responses");p(this,"thrownErrorString");this.sleep=e.sleep??this.sleep,this.responses=e.responses,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e){var n,s;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const r=(n=this.responses)==null?void 0:n[0];return this.responses=(s=this.responses)==null?void 0:s.slice(1),r??e}async*_streamResponseChunks(e,r,n){var i,a;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const s=(i=this.responses)==null?void 0:i[0];this.responses=(a=this.responses)==null?void 0:a.slice(1);for(const o of s??e)await new Promise(c=>setTimeout(c,this.sleep)),yield{text:o,generationInfo:{}},await(n==null?void 0:n.handleLLMNewToken(o))}},h4=class extends rx{constructor(){super();p(this,"lc_namespace",["langchain_core","message","fake"]);p(this,"messages",[])}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async addUserMessage(e){this.messages.push(new ut(e))}async addAIMessage(e){this.messages.push(new ht(e))}async clear(){this.messages=[]}},f4=class extends vg{constructor(){super();p(this,"lc_namespace",["langchain_core","message","fake"]);p(this,"messages",[])}async addMessage(e){this.messages.push(e)}async getMessages(){return this.messages}},p4=class extends Es{constructor(){super();p(this,"name","fake_tracer");p(this,"runs",[])}persistRun(e){return this.runs.push(e),Promise.resolve()}},m4=class extends yc{constructor(){super(...arguments);p(this,"lc_namespace",["tests","fake"])}getFormatInstructions(){return""}async parse(e){return e.split(",").map(r=>r.trim())}},g4=class extends Tg{constructor(e){super();p(this,"lc_namespace",["test","fake"]);p(this,"output",[new js({pageContent:"foo"}),new js({pageContent:"bar"})]);this.output=(e==null?void 0:e.output)??this.output}async _getRelevantDocuments(e){return this.output}},y4=class extends Fe{constructor(e){super(e);p(this,"lc_namespace",["tests","fake"]);p(this,"returnOptions");this.returnOptions=e.returnOptions}async invoke(e,r){return this.returnOptions?r??{}:{input:e}}},_4=class extends _d{constructor(e){super(e);p(this,"name");p(this,"description");p(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}async _call(e,r){return JSON.stringify(e)}},w4=class extends Es{constructor(){super();p(this,"runPromiseResolver");p(this,"runPromise");p(this,"name","single_run_extractor");this.runPromise=new Promise(e=>{this.runPromiseResolver=e})}async persistRun(e){this.runPromiseResolver(e)}async extract(){return this.runPromise}},b4=class MT extends Ag{constructor(r,{similarity:n,...s}={}){super(r,s);p(this,"memoryVectors",[]);p(this,"similarity");this.similarity=n??$T}_vectorstoreType(){return"memory"}async addDocuments(r){const n=r.map(({pageContent:s})=>s);return this.addVectors(await this.embeddings.embedDocuments(n),r)}async addVectors(r,n){const s=r.map((i,a)=>({content:n[a].pageContent,embedding:i,metadata:n[a].metadata}));this.memoryVectors=this.memoryVectors.concat(s)}async similaritySearchVectorWithScore(r,n,s){const i=l=>{if(!s)return!0;const u=new js({metadata:l.metadata,pageContent:l.content});return s(u)},a=this.memoryVectors.filter(i);return a.map((l,u)=>({similarity:this.similarity(r,l.embedding),index:u})).sort((l,u)=>l.similarity>u.similarity?-1:0).slice(0,n).map(l=>[new js({metadata:a[l.index].metadata,pageContent:a[l.index].content}),l.similarity])}static async fromTexts(r,n,s,i){const a=[];for(let o=0;o<r.length;o+=1){const c=Array.isArray(n)?n[o]:n,l=new js({pageContent:r[o],metadata:c});a.push(l)}return MT.fromDocuments(a,s,i)}static async fromDocuments(r,n,s){const i=new this(n,s);return await i.addDocuments(r),i}static async fromExistingIndex(r,n){return new this(r,n)}},DT={};ve(DT,{FakeChatMessageHistory:()=>h4,FakeChatModel:()=>i4,FakeEmbeddings:()=>l4,FakeLLM:()=>u4,FakeListChatMessageHistory:()=>f4,FakeListChatModel:()=>o4,FakeRetriever:()=>g4,FakeRunnable:()=>y4,FakeSplitIntoListParser:()=>m4,FakeStreamingChatModel:()=>a4,FakeStreamingLLM:()=>d4,FakeTool:()=>_4,FakeTracer:()=>p4,FakeVectorStore:()=>b4,SingleRunExtractor:()=>w4,SyntheticEmbeddings:()=>c4});var UT={};ve(UT,{extendInteropZodObject:()=>kS,getInteropZodDefaultGetter:()=>IS,getInteropZodObjectShape:()=>jo,getSchemaDescription:()=>Ri,interopParse:()=>bl,interopParseAsync:()=>ld,interopSafeParse:()=>gP,interopSafeParseAsync:()=>CS,interopZodObjectMakeFieldsOptional:()=>bP,interopZodObjectPartial:()=>pg,interopZodObjectPassthrough:()=>Ep,interopZodObjectStrict:()=>nu,interopZodTransformInputSchema:()=>la,isInteropZodLiteral:()=>mP,isInteropZodObject:()=>_n,isInteropZodSchema:()=>tn,isShapelessZodSchema:()=>yP,isSimpleStringZodSchema:()=>hg,isZodArrayV4:()=>ud,isZodLiteralV3:()=>TS,isZodLiteralV4:()=>AS,isZodObjectV3:()=>fg,isZodObjectV4:()=>Gn,isZodSchema:()=>pP,isZodSchemaV3:()=>bt,isZodSchemaV4:()=>_t});var BT={};ve(BT,{agents:()=>O1,caches:()=>fx,callbacks__base:()=>gE,callbacks__manager:()=>YE,callbacks__promises:()=>VE,chat_history:()=>tx,document_loaders__base:()=>_x,document_loaders__langsmith:()=>bx,documents:()=>Ex,embeddings:()=>nx,example_selectors:()=>Ax,index:()=>PL,indexing:()=>$x,language_models__base:()=>Mx,language_models__chat_models:()=>Ux,language_models__llms:()=>Bx,load__serializable:()=>Gv,memory:()=>sx,messages:()=>ex,messages__tool:()=>fE,output_parsers:()=>Hx,output_parsers__openai_functions:()=>Xx,output_parsers__openai_tools:()=>Jx,outputs:()=>hS,prompt_values:()=>ax,prompts:()=>uT,retrievers:()=>ux,retrievers__document_compressors:()=>dT,runnables:()=>Fx,runnables__graph:()=>zS,singletons:()=>sS,stores:()=>cx,structured_query:()=>_T,tools:()=>wT,tracers__base:()=>ME,tracers__console:()=>UE,tracers__log_stream:()=>uS,tracers__run_collector:()=>ST,tracers__tracer_langchain:()=>jE,types__stream:()=>HD,utils__async_caller:()=>mS,utils__chunk_array:()=>xT,utils__env:()=>Yv,utils__event_source_parse:()=>TT,utils__function_calling:()=>IT,utils__hash:()=>hx,utils__json_patch:()=>zx,utils__json_schema:()=>FS,utils__math:()=>NT,utils__stream:()=>iS,utils__testing:()=>DT,utils__tiktoken:()=>Px,utils__types:()=>UT,vectorstores:()=>dx});function v4(t){const e={};for(let r=t;r&&r.prototype;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r.prototype,"lc_aliases"));return Object.entries(e).reduce((r,[n,s])=>(r[s]=n,r),{})}async function Al(t){const{optionalImportsMap:e={},optionalImportEntrypoints:r=[],importMap:n={},secretsMap:s={},path:i=["$"]}=this,a=i.join(".");if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&t.lc===1&&t.type==="secret"){const o=t,[c]=o.id;if(c in s)return s[c];{const l=rn(c);if(l)return l;throw new Error(`Missing key "${c}" for ${a} in load(secretsMap={})`)}}else if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&t.lc===1&&t.type==="not_implemented"){const c=JSON.stringify(t);throw new Error(`Trying to load an object that doesn't implement serialization: ${a} -> ${c}`)}else if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&"kwargs"in t&&t.lc===1){const o=t,c=JSON.stringify(o),[l,...u]=o.id.slice().reverse(),d=u.reverse(),h={langchain_core:BT,langchain:n};let f=null;const m=[d.join("/")];d[0]==="langchain_community"&&m.push(["langchain",...d.slice(1)].join("/"));const g=m.find(_=>_ in e);if(R1.concat(r).includes(d.join("/"))||g)if(g!==void 0)f=await e[g];else throw new Error(`Missing key "${d.join("/")}" for ${a} in load(optionalImportsMap={})`);else{let _;if(d[0]==="langchain"||d[0]==="langchain_core")_=h[d[0]],d.shift();else throw new Error(`Invalid namespace: ${a} -> ${c}`);if(d.length===0)throw new Error(`Invalid namespace: ${a} -> ${c}`);let E;do{if(E=d.join("__"),E in _)break;d.pop()}while(d.length>0);E in _&&(f=_[E])}if(typeof f!="object"||f===null)throw new Error(`Invalid namespace: ${a} -> ${c}`);const y=f[l]??Object.values(f).find(_=>typeof _=="function"&&Zu(_)===l);if(typeof y!="function")throw new Error(`Invalid identifer: ${a} -> ${c}`);const b=await Al.call({...this,path:[...i,"kwargs"]},o.kwargs);if(o.type==="constructor"){const _=new y(Hv(b,S1,v4(y)));return Object.defineProperty(_.constructor,"name",{value:l}),_}else throw new Error(`Invalid type: ${a} -> ${c}`)}else if(typeof t=="object"&&t!==null)return Array.isArray(t)?Promise.all(t.map((o,c)=>Al.call({...this,path:[...i,`${c}`]},o))):Object.fromEntries(await Promise.all(Object.entries(t).map(async([o,c])=>[o,await Al.call({...this,path:[...i,o]},c)])));return t}async function E4(t,e){const r=JSON.parse(t);return Al.call({...e},r)}function S4(t){return t!==null&&t.lc===1&&t.type==="constructor"&&Array.isArray(t.id)}async function Hp(t){if(t&&typeof t=="object"){if(Array.isArray(t))return await Promise.all(t.map(r=>Hp(r)));{const e={};for(const[r,n]of Object.entries(t))e[r]=await Hp(n);if(e.lc===2&&e.type==="undefined")return;if(e.lc===2&&e.type==="constructor"&&Array.isArray(e.id))try{const r=e.id[e.id.length-1];let n;switch(r){case"Set":n=Set;break;case"Map":n=Map;break;case"RegExp":n=RegExp;break;case"Error":n=Error;break;default:return e}return e.method?n[e.method](...e.args||[]):new n(...e.args||[])}catch{return e}else if(S4(e))return E4(JSON.stringify(e));return e}}return t}function yf(t,e,r,n){return{lc:2,type:"constructor",id:[t.name],method:e??null,args:r??[],kwargs:n??{}}}function x4(t){return t===void 0?{lc:2,type:"undefined"}:t instanceof Set||t instanceof Map?yf(t.constructor,void 0,[Array.from(t)]):t instanceof RegExp?yf(RegExp,void 0,[t.source,t.flags]):t instanceof Error?yf(t.constructor,void 0,[t.message]):(t==null?void 0:t.lg_name)==="Send"?{node:t.node,args:t.args}:t}var T4=class{_dumps(t){return new TextEncoder().encode(p1(t,(r,n)=>x4(n)))}async dumpsTyped(t){return t instanceof Uint8Array?["bytes",t]:["json",this._dumps(t)]}async _loads(t){const e=JSON.parse(t);return Hp(e)}async loadsTyped(t,e){if(t==="bytes")return typeof e=="string"?new TextEncoder().encode(e):e;if(t==="json")return this._loads(typeof e=="string"?e:new TextDecoder().decode(e));throw new Error(`Unknown serialization type: ${t}`)}};function jT(t){if(typeof t!="object"||t===null)return t;const e=Array.isArray(t)?[]:{};for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=jT(t[r]));return e}function FT(){return{v:4,id:qv(-2),ts:new Date().toISOString(),channel_values:{},channel_versions:{},versions_seen:{}}}function yu(t){return{v:t.v,id:t.id,ts:t.ts,channel_values:{...t.channel_values},channel_versions:{...t.channel_versions},versions_seen:jT(t.versions_seen)}}function zT(t,e){return typeof t=="number"&&typeof e=="number"?Math.sign(t-e):String(t).localeCompare(String(e))}function A4(...t){return t.reduce((e,r,n)=>n===0?r:zT(e,r)>=0?e:r)}const C4={[l1]:-1,[gl]:-2,[u1]:-3,[d1]:-4};var Wa=class extends Error{constructor(t){super(t),this.name="InvalidNamespaceError"}};function k4(t){if(t.length===0)throw new Wa("Namespace cannot be empty.");for(const e of t){if(typeof e!="string")throw new Wa(`Invalid namespace label '${e}' found in ${t}. Namespace labels must be strings, but got ${typeof e}.`);if(e.includes("."))throw new Wa(`Invalid namespace label '${e}' found in ${t}. Namespace labels cannot contain periods ('.').`);if(e==="")throw new Wa(`Namespace labels cannot be empty strings. Got ${e} in ${t}`)}if(t[0]==="langgraph")throw new Wa(`Root label for namespace cannot be "langgraph". Got: ${t}`)}var I4=class{async get(t,e){return(await this.batch([{namespace:t,key:e}]))[0]}async search(t,e={}){const{filter:r,limit:n=10,offset:s=0,query:i}=e;return(await this.batch([{namespacePrefix:t,filter:r,limit:n,offset:s,query:i}]))[0]}async put(t,e,r,n){k4(t),await this.batch([{namespace:t,key:e,value:r,index:n}])}async delete(t,e){await this.batch([{namespace:t,key:e,value:null}])}async listNamespaces(t={}){const{prefix:e,suffix:r,maxDepth:n,limit:s=100,offset:i=0}=t,a=[];return e&&a.push({matchType:"prefix",path:e}),r&&a.push({matchType:"suffix",path:r}),(await this.batch([{matchConditions:a.length?a:void 0,maxDepth:n,limit:s,offset:i}]))[0]}start(){}stop(){}};const R4=t=>"lg_name"in t&&t.lg_name==="AsyncBatchedStore"?t.store:t;var O4=class extends I4{constructor(e){super();p(this,"lg_name","AsyncBatchedStore");p(this,"store");p(this,"queue",new Map);p(this,"nextKey",0);p(this,"running",!1);p(this,"processingTask",null);this.store=R4(e)}get isRunning(){return this.running}async batch(e){throw new Error("The `batch` method is not implemented on `AsyncBatchedStore`.\n Instead, it calls the `batch` method on the wrapped store.\n If you are seeing this error, something is wrong.")}async get(e,r){return this.enqueueOperation({namespace:e,key:r})}async search(e,r){const{filter:n,limit:s=10,offset:i=0,query:a}=r||{};return this.enqueueOperation({namespacePrefix:e,filter:n,limit:s,offset:i,query:a})}async put(e,r,n){return this.enqueueOperation({namespace:e,key:r,value:n})}async delete(e,r){return this.enqueueOperation({namespace:e,key:r,value:null})}start(){this.running||(this.running=!0,this.processingTask=this.processBatchQueue())}async stop(){this.running=!1,this.processingTask&&await this.processingTask}enqueueOperation(e){return new Promise((r,n)=>{const s=this.nextKey;this.nextKey+=1,this.queue.set(s,{operation:e,resolve:r,reject:n})})}async processBatchQueue(){for(;this.running;){if(await new Promise(r=>{setTimeout(r,0)}),this.queue.size===0)continue;const e=new Map(this.queue);this.queue.clear();try{const r=Array.from(e.values()).map(({operation:s})=>s),n=await this.store.batch(r);e.forEach(({resolve:s},i)=>{const a=Array.from(e.keys()).indexOf(i);s(n[a])})}catch(r){e.forEach(({reject:n})=>{n(r)})}}}toJSON(){return{queue:this.queue,nextKey:this.nextKey,running:this.running,store:"[LangGraphStore]"}}},$4=class{constructor(t){p(this,"serde",new T4);this.serde=t||this.serde}};function VT(t){return t!=null&&t.lg_is_channel===!0}var ji=class{constructor(){p(this,"ValueType");p(this,"UpdateType");p(this,"lg_is_channel",!0)}consume(){return!1}finish(){return!1}isAvailable(){try{return this.get(),!0}catch(t){if(t.name===Qt.unminifiable_name)return!1;throw t}}};const Gp=Symbol.for("LG_IS_ONLY_BASE_CHANNEL");function Hg(t){if(t[Gp]===!0)return t;const e={};for(const r in t){if(!Object.prototype.hasOwnProperty.call(t,r))continue;const n=t[r];VT(n)&&(e[r]=n)}return Object.assign(e,{[Gp]:!0}),e}function _u(t,e){const r=Hg(t),n={};for(const s in r){if(!Object.prototype.hasOwnProperty.call(r,s))continue;const i=e.channel_values[s];n[s]=r[s].fromCheckpoint(i)}return Object.assign(n,{[Gp]:!0}),n}function di(t,e,r,n){let s;if(e===void 0)s=t.channel_values;else{s={};for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i))try{s[i]=e[i].checkpoint()}catch(a){if(a.name!==Qt.unminifiable_name)throw a}}return{v:4,id:(n==null?void 0:n.id)??qv(r),ts:new Date().toISOString(),channel_values:s,channel_versions:t.channel_versions,versions_seen:t.versions_seen}}var Wp=class qT extends ji{constructor(r,n){super();p(this,"lc_graph_name","BinaryOperatorAggregate");p(this,"value");p(this,"operator");p(this,"initialValueFactory");this.operator=r,this.initialValueFactory=n,this.value=n==null?void 0:n()}fromCheckpoint(r){const n=new qT(this.operator,this.initialValueFactory);return typeof r<"u"&&(n.value=r),n}update(r){let n=r;if(!n.length)return!1;this.value===void 0&&([this.value]=n,n=n.slice(1));for(const s of n)this.value!==void 0&&(this.value=this.operator(this.value,s));return!0}get(){if(this.value===void 0)throw new Qt;return this.value}checkpoint(){if(this.value===void 0)throw new Qt;return this.value}isAvailable(){return this.value!==void 0}},Gg=class HT extends ji{constructor(){super(...arguments);p(this,"lc_graph_name","LastValue");p(this,"value",[])}fromCheckpoint(r){const n=new HT;return typeof r<"u"&&(n.value=[r]),n}update(r){if(r.length===0)return!1;if(r.length!==1)throw new lt("LastValue can only receive one value per step.",{lc_error_code:"INVALID_CONCURRENT_GRAPH_UPDATE"});return this.value=[r[r.length-1]],!0}get(){if(this.value.length===0)throw new Qt;return this.value[0]}checkpoint(){if(this.value.length===0)throw new Qt;return this.value[0]}isAvailable(){return this.value.length!==0}},N4=class GT extends ji{constructor(){super(...arguments);p(this,"lc_graph_name","LastValueAfterFinish");p(this,"value",[]);p(this,"finished",!1)}fromCheckpoint(r){const n=new GT;if(typeof r<"u"){const[s,i]=r;n.value=[s],n.finished=i}return n}update(r){return r.length===0?!1:(this.finished=!1,this.value=[r[r.length-1]],!0)}get(){if(this.value.length===0||!this.finished)throw new Qt;return this.value[0]}checkpoint(){if(this.value.length!==0)return[this.value[0],this.finished]}consume(){return this.finished?(this.finished=!1,this.value=[],!0):!1}finish(){return!this.finished&&this.value.length>0?(this.finished=!0,!0):!1}isAvailable(){return this.value.length!==0&&this.finished}},P4=class{constructor(t){p(this,"lc_graph_name","AnnotationRoot");p(this,"spec");this.spec=t}};const De=function(t){return t?Jp(t):new Gg};De.Root=t=>new P4(t);function Jp(t){return typeof t=="object"&&t&&"reducer"in t&&t.reducer?new Wp(t.reducer,t.default):typeof t=="object"&&t&&"value"in t&&t.value?new Wp(t.value,t.default):new Gg}const et="__start__",ze="__end__",as="__input__",L4="__copy__",xr="__error__",_f="__pregel_ns_writes",zs="__pregel_send",Wg="__pregel_call",Ei="__pregel_read",vt="__pregel_checkpointer",$s="__pregel_resuming",Eo="__pregel_task_id",wu="__pregel_stream",M4="__pregel_resume_value",Cl="__pregel_resume_map",Vs="__pregel_scratchpad",kl="__pregel_previous",WT="__pregel_durability",Zp="checkpoint_id",Un="checkpoint_ns",D4="__pregel_node_finished",Xr="checkpoint_map",Ab="__pregel_abort_signals",He="__interrupt__",Cr="__resume__",Jg="__no_writes__",ka="__return__",wf="__previous__",Tt="langsmith:hidden",U4="langsmith:nostream",Cb="__self__",Yr="__pregel_tasks",jr="__pregel_push",Il="__pregel_pull",Qr="00000000-0000-0000-0000-000000000000",B4=[Tt,as,He,Cr,xr,Jg,zs,Ei,vt,WT,wu,$s,Eo,Wg,M4,Vs,kl,Xr,Un,Zp],Pt="|",fs=":",kb=Symbol.for("langgraph.command");var Uv,j4=(Uv=kb,class{constructor(t){p(this,Uv);this[kb]=t}});function Kp(t){const e=t;return e!=null&&typeof e.node=="string"&&e.args!==void 0}var bu=class{constructor(t,e){p(this,"lg_name","Send");p(this,"node");p(this,"args");this.node=t,this.args=Jo(e)}toJSON(){return{lg_name:this.lg_name,node:this.node,args:this.args}}};function Rr(t){return t instanceof bu}function JT(t){return!t||typeof t!="object"||!(He in t)?!1:Array.isArray(t[He])}var tp,rt=(tp=class extends j4{constructor(r){super(r);p(this,"lg_name","Command");p(this,"lc_direct_tool_output",!0);p(this,"graph");p(this,"update");p(this,"resume");p(this,"goto",[]);this.resume=r.resume,this.graph=r.graph,this.update=r.update,r.goto&&(this.goto=Array.isArray(r.goto)?Jo(r.goto):[Jo(r.goto)])}_updateAsTuples(){return this.update&&typeof this.update=="object"&&!Array.isArray(this.update)?Object.entries(this.update):Array.isArray(this.update)&&this.update.every(r=>Array.isArray(r)&&r.length===2&&typeof r[0]=="string")?this.update:[["__root__",this.update]]}toJSON(){var n;let r;return typeof this.goto=="string"?r=this.goto:Rr(this.goto)?r=this.goto.toJSON():r=(n=this.goto)==null?void 0:n.map(s=>typeof s=="string"?s:s.toJSON()),{lg_name:this.lg_name,update:this.update,resume:this.resume,goto:r}}},p(tp,"PARENT","__parent__"),tp);function Xt(t){return typeof t!="object"||t==null?!1:"lg_name"in t&&t.lg_name==="Command"}function Jo(t,e=new Map){if(t!=null&&typeof t=="object"){if(e.has(t))return e.get(t);let r;if(Array.isArray(t))r=[],e.set(t,r),t.forEach((n,s)=>{r[s]=Jo(n,e)});else if(Xt(t)&&!(t instanceof rt))r=new rt(t),e.set(t,r);else if(Kp(t)&&!(t instanceof bu))r=new bu(t.node,t.args),e.set(t,r);else if(Xt(t)||Rr(t))r=t,e.set(t,r);else if("lc_serializable"in t&&t.lc_serializable)r=t,e.set(t,r);else{r={},e.set(t,r);for(const[n,s]of Object.entries(t))r[n]=Jo(s,e)}return r}return t}const F4=["tags","metadata","callbacks","configurable"],z4=["tags","metadata","callbacks","runName","maxConcurrency","recursionLimit","configurable","runId","outputKeys","streamMode","store","writer","interrupt","context","interruptBefore","interruptAfter","checkpointDuring","durability","signal"],V4=25;function ZT(...t){const e={tags:[],metadata:{},callbacks:void 0,recursionLimit:V4,configurable:{}},r=Bt.getRunnableConfig();if(r!==void 0){for(const[n,s]of Object.entries(r))if(s!==void 0)if(F4.includes(n)){let i;Array.isArray(s)?i=[...s]:typeof s=="object"?n==="callbacks"&&"copy"in s&&typeof s.copy=="function"?i=s.copy():i={...s}:i=s,e[n]=i}else e[n]=s}for(const n of t)if(n!==void 0)for(const[s,i]of Object.entries(n))i!==void 0&&z4.includes(s)&&(e[s]=i);for(const[n,s]of Object.entries(e.configurable))e.metadata=e.metadata??{},!n.startsWith("__")&&(typeof s=="string"||typeof s=="number"||typeof s=="boolean")&&!(n in e.metadata)&&(e.metadata[n]=s);return e}function q4(){return Bt.getRunnableConfig()}function bf(t){return t.split(Pt).filter(e=>!e.match(/^\d+$/)).map(e=>e.split(fs)[0]).join(Pt)}function H4(t){const e=t.split(Pt);for(;e.length>1&&e[e.length-1].match(/^\d+$/);)e.pop();return e.slice(0,-1).join(Pt)}var ei=class extends Fe{constructor(e){super();p(this,"lc_namespace",["langgraph"]);p(this,"func");p(this,"tags");p(this,"config");p(this,"trace",!0);p(this,"recurse",!0);this.name=e.name??e.func.name,this.func=e.func,this.config=e.tags?{tags:e.tags}:void 0,this.trace=e.trace??this.trace,this.recurse=e.recurse??this.recurse}async _tracedInvoke(e,r,n){return new Promise((s,i)=>{const a=Ze(r,{callbacks:n==null?void 0:n.getChild()});Bt.runWithConfig(a,async()=>{try{const o=await this.func(e,a);s(o)}catch(o){i(o)}})})}async invoke(e,r){let n;const s=ZT(r),i=en(this.config,s);return this.trace?n=await this._callWithConfig(this._tracedInvoke,e,i):n=await Bt.runWithConfig(i,async()=>this.func(e,i)),Fe.isRunnable(n)&&this.recurse?await Bt.runWithConfig(i,async()=>n.invoke(e,i)):n}};function*As(t,e){if(e===void 0)yield*t;else for(const r of t)yield[e,r]}async function Ps(t){const e=[];for await(const r of await t)e.push(r);return e}function no(t){const e=[];for(const r of t)e.push(r);return e}function Gi(t,e){return t?"configurable"in t?{...t,configurable:{...t.configurable,...e}}:{...t,configurable:e}:{configurable:e}}function G4(t){return typeof t=="object"&&(t==null?void 0:t[Symbol.for("LG_SKIP_WRITE")])!==void 0}const Si={[Symbol.for("LG_PASSTHROUGH")]:!0};function Jc(t){return typeof t=="object"&&(t==null?void 0:t[Symbol.for("LG_PASSTHROUGH")])!==void 0}const vf=Symbol("IS_WRITER");var hr=class Xp extends ei{constructor(r,n){const s=`ChannelWrite<${r.map(i=>Rr(i)?i.node:"channel"in i?i.channel:"...").join(",")}>`;super({writes:r,name:s,tags:n,func:async(i,a)=>this._write(i,a??{})});p(this,"writes");this.writes=r}async _write(r,n){const s=this.writes.map(i=>Ef(i)&&Jc(i.value)?{mapper:i.mapper,value:r}:Rl(i)&&Jc(i.value)?{channel:i.channel,value:r,skipNone:i.skipNone,mapper:i.mapper}:i);return await Xp.doWrite(n,s),r}static async doWrite(r,n){var a;for(const o of n){if(Rl(o)){if(o.channel===Yr)throw new lt("Cannot write to the reserved channel TASKS");if(Jc(o.value))throw new lt("PASSTHROUGH value must be replaced")}if(Ef(o)&&Jc(o.value))throw new lt("PASSTHROUGH value must be replaced")}const s=[];for(const o of n)if(Rr(o))s.push([Yr,o]);else if(Ef(o)){const c=await o.mapper.invoke(o.value,r);c!=null&&c.length>0&&s.push(...c)}else if(Rl(o)){const c=o.mapper!==void 0?await o.mapper.invoke(o.value,r):o.value;if(G4(c)||o.skipNone&&c===void 0)continue;s.push([o.channel,c])}else throw new Error(`Invalid write entry: ${JSON.stringify(o)}`);((a=r.configurable)==null?void 0:a[zs])(s)}static isWriter(r){return r instanceof Xp||vf in r&&!!r[vf]}static registerWriter(r){return Object.defineProperty(r,vf,{value:!0})}};function Rl(t){return t!==void 0&&typeof t.channel=="string"}function Ef(t){return t!==void 0&&!Rl(t)&&Fe.isRunnable(t.mapper)}var W4=class KT extends ei{constructor(r,n,s=!1){super({func:(i,a)=>KT.doRead(a,this.channel,this.fresh,this.mapper)});p(this,"lc_graph_name","ChannelRead");p(this,"channel");p(this,"fresh",!1);p(this,"mapper");this.fresh=s,this.mapper=n,this.channel=r,this.name=Array.isArray(r)?`ChannelRead<${r.join(",")}>`:`ChannelRead<${r}>`}static doRead(r,n,s,i){var o;const a=(o=r.configurable)==null?void 0:o[Ei];if(!a)throw new Error("Runnable is not configured with a read function. Make sure to call in the context of a Pregel process");return i?i(a(n,s)):a(n,s)}};const Wi=new _s;var Zo=class so extends Zs{constructor(r){var y;const{channels:n,triggers:s,mapper:i,writers:a,bound:o,kwargs:c,metadata:l,retryPolicy:u,cachePolicy:d,tags:h,subgraphs:f,ends:m}=r,g=[...(y=r.config)!=null&&y.tags?r.config.tags:[],...h??[]];super({...r,bound:r.bound??Wi,config:{...r.config?r.config:{},tags:g}});p(this,"lc_graph_name","PregelNode");p(this,"channels");p(this,"triggers",[]);p(this,"mapper");p(this,"writers",[]);p(this,"bound",Wi);p(this,"kwargs",{});p(this,"metadata",{});p(this,"tags",[]);p(this,"retryPolicy");p(this,"cachePolicy");p(this,"subgraphs");p(this,"ends");this.channels=n,this.triggers=s,this.mapper=i,this.writers=a??this.writers,this.bound=o??this.bound,this.kwargs=c??this.kwargs,this.metadata=l??this.metadata,this.tags=g,this.retryPolicy=u,this.cachePolicy=d,this.subgraphs=f,this.ends=m}getWriters(){var n;const r=[...this.writers];for(;r.length>1&&r[r.length-1]instanceof hr&&r[r.length-2]instanceof hr;){const s=r.slice(-2),i=s[0].writes.concat(s[1].writes);r[r.length-2]=new hr(i,(n=s[0].config)==null?void 0:n.tags),r.pop()}return r}getNode(){const r=this.getWriters();if(!(this.bound===Wi&&r.length===0))return this.bound===Wi&&r.length===1?r[0]:this.bound===Wi?new Zn({first:r[0],middle:r.slice(1,r.length-1),last:r[r.length-1],omitSequenceTags:!0}):r.length>0?new Zn({first:this.bound,middle:r.slice(0,r.length-1),last:r[r.length-1],omitSequenceTags:!0}):this.bound}join(r){if(!Array.isArray(r))throw new Error("channels must be a list");if(typeof this.channels!="object")throw new Error("all channels must be named when using .join()");return new so({channels:{...this.channels,...Object.fromEntries(r.map(n=>[n,n]))},triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound,kwargs:this.kwargs,config:this.config,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy})}pipe(r){return hr.isWriter(r)?new so({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:[...this.writers,r],bound:this.bound,config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy}):this.bound===Wi?new so({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:Yt(r),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy}):new so({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound.pipe(r),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy})}};function J4(t){return"steps"in t&&Array.isArray(t.steps)}function Zg(t){return"lg_is_pregel"in t&&t.lg_is_pregel===!0}function XT(t){const e=[t];for(const r of e){if(Zg(r))return r;J4(r)&&e.push(...r.steps)}}const J=t=>BigInt(t),tt=(t,e=0)=>new DataView(t.buffer,t.byteOffset+e,t.byteLength-e),YT=J("0x9E3779B1"),QT=J("0x85EBCA77"),Z4=J("0xC2B2AE3D"),Ks=J("0x9E3779B185EBCA87"),$i=J("0xC2B2AE3D27D4EB4F"),eA=J("0x165667B19E3779F9"),Kg=J("0x85EBCA77C2B2AE63"),K4=J("0x27D4EB2F165667C5"),X4=J("0x165667919E3779F9"),Y4=J("0x9FB21C651E98DF25"),Q4=t=>{const e=t.length;if(e%2!==0)throw new Error("String should have an even number of characters");const r=e/2,n=new Uint8Array(r);let s=0,i=0;for(;i<r;){const a=t.slice(s,s+=2);n[i]=Number.parseInt(a,16),i+=1}return tt(n)},Ln=Q4("b8fe6c3923a44bbe7c01812cf721ad1cded46de9839097db7240a4a4b7b3671fcb79e64eccc0e578825ad07dccff7221b8084674f743248ee03590e6813a264c3c2852bb91c300cb88d0658b1b532ea371644897a20df94e3819ef46a9deacd8a8fa763fe39c343ff9dcbbc7c70b4f1d8a51e04bcdb45931c89f7ec9d9787364eac5ac8334d3ebc3c581a0fffa1363eb170ddd51b7f0da49d316552629d4689e2b16be587d47a1fc8ff8b8d17ad031ce45cb3a8f95160428afd7fbcabb4b407e"),ga=(J(1)<<J(128))-J(1),Pe=(J(1)<<J(64))-J(1),vu=(J(1)<<J(32))-J(1),os=64,tA=os/8,eU=8,Zc=4;function Ia(t){if(!t)throw new Error("Assert failed")}function tU(t){const e=new DataView(new ArrayBuffer(8));return e.setBigUint64(0,t,!0),e.getBigUint64(0,!1)}function rU(t){let e=t;return e=(e&J(65535))<<J(16)|(e&J(4294901760))>>J(16),e=(e&J(16711935))<<J(8)|(e&J(4278255360))>>J(8),e}function nU(t,e){return(t&vu)*(e&vu)&Pe}function sU(t,e){return(t<<e|t>>J(32)-e)&vu}function rA(t,e,r){for(let n=0;n<tA;n+=1){const s=e.getBigUint64(n*8,!0),i=s^r.getBigUint64(n*8,!0);t[n^1]+=s,t[n]+=nU(i,i>>J(32))}return t}function Ib(t,e,r,n){for(let s=0;s<n;s+=1)rA(t,tt(e,s*os),tt(r,s*8));return t}function iU(t,e){for(let r=0;r<tA;r+=1){const n=e.getBigUint64(r*8,!0);let s=t[r];s=Yp(s,J(47)),s^=n,s*=YT,t[r]=s&Pe}return t}function Kc(t,e){return nA(t[0]^e.getBigUint64(0,!0),t[1]^e.getBigUint64(eU,!0))}function Rb(t,e,r){let n=r;return n+=Kc(t.slice(0),tt(e,0*Zc)),n+=Kc(t.slice(2),tt(e,4*Zc)),n+=Kc(t.slice(4),tt(e,8*Zc)),n+=Kc(t.slice(6),tt(e,12*Zc)),Fn(n&Pe)}function aU(t,e,r,n,s){let i=t;const a=Math.floor((r.byteLength-os)/8),o=os*a,c=Math.floor((e.byteLength-1)/o);for(let l=0;l<c;l+=1)i=Ib(i,tt(e,l*o),r,a),i=s(i,tt(r,r.byteLength-os));{const l=Math.floor((e.byteLength-1-o*c)/os);i=Ib(i,tt(e,c*o),r,l),i=n(i,tt(e,e.byteLength-os),tt(r,r.byteLength-os-7))}return i}function oU(t,e){let r=new BigUint64Array([Z4,Ks,$i,eA,Kg,QT,K4,YT]);Ia(t.byteLength>128),r=aU(r,t,e,rA,iU),Ia(r.length*8===64);{const n=Rb(r,tt(e,11),J(t.byteLength)*Ks&Pe);return Rb(r,tt(e,e.byteLength-os-11),~(J(t.byteLength)*$i)&Pe)<<J(64)|n}}function nA(t,e){const r=t*e&ga;return r&Pe^r>>J(64)}function Ob(t,e,r){return nA((t.getBigUint64(0,!0)^e.getBigUint64(0,!0)+r)&Pe,(t.getBigUint64(8,!0)^e.getBigUint64(8,!0)-r)&Pe)}function Ol(t,e,r,n,s){let i=t&Pe,a=t>>J(64)&Pe;return i+=Ob(e,n,s),i^=r.getBigUint64(0,!0)+r.getBigUint64(8,!0),i&=Pe,a+=Ob(r,tt(n,16),s),a^=e.getBigUint64(0,!0)+e.getBigUint64(8,!0),a&=Pe,a<<J(64)|i}function Fn(t){let e=t;return e^=e>>J(37),e*=X4,e&=Pe,e^=e>>J(32),e}function Eu(t){let e=t;return e^=e>>J(33),e*=$i,e&=Pe,e^=e>>J(29),e*=eA,e&=Pe,e^=e>>J(32),e}function cU(t,e,r){const n=t.byteLength;Ia(n>0&&n<=3);const s=J(t.getUint8(n-1))|J(n<<8)|J(t.getUint8(0)<<16)|J(t.getUint8(n>>1)<<24),i=(J(e.getUint32(0,!0))^J(e.getUint32(4,!0)))+r,a=(s^i)&Pe,o=(J(e.getUint32(8,!0))^J(e.getUint32(12,!0)))-r,c=(sU(rU(s),J(13))^o)&Pe;return(Eu(c)&Pe)<<J(64)|Eu(a)}function Yp(t,e){return t^t>>e}function lU(t,e,r){const n=t.byteLength;Ia(n>=4&&n<=8);{const s=t.getUint32(0,!0),i=t.getUint32(n-4,!0),a=J(s)|J(i)<<J(32),o=(e.getBigUint64(16,!0)^e.getBigUint64(24,!0))+r&Pe;let l=(a^o)*(Ks+(J(n)<<J(2)))&ga;return l+=(l&Pe)<<J(65),l&=ga,l^=l>>J(67),Yp(Yp(l&Pe,J(35))*Y4&Pe,J(28))|Fn(l>>J(64))<<J(64)}}function uU(t,e,r){const n=t.byteLength;Ia(n>=9&&n<=16);{const s=(e.getBigUint64(32,!0)^e.getBigUint64(40,!0))+r&Pe,i=(e.getBigUint64(48,!0)^e.getBigUint64(56,!0))-r&Pe,a=t.getBigUint64(0,!0);let o=t.getBigUint64(n-8,!0),c=(a^o^s)*Ks;const l=(c&Pe)+(J(n-1)<<J(54));c=c&(ga^Pe)|l,o^=i,c+=o+(o&vu)*(QT-J(1))<<J(64),c&=ga,c^=tU(c>>J(64));let u=(c&Pe)*$i;return u+=(c>>J(64))*$i<<J(64),u&=ga,Fn(u&Pe)|Fn(u>>J(64))<<J(64)}}function dU(t,e){const r=t.byteLength;return Ia(r<=16),r>8?uU(t,Ln,e):r>=4?lU(t,Ln,e):r>0?cU(t,Ln,e):Eu(e^Ln.getBigUint64(64,!0)^Ln.getBigUint64(72,!0))|Eu(e^Ln.getBigUint64(80,!0)^Ln.getBigUint64(88,!0))<<J(64)}function Qp(t){return~t+J(1)&Pe}function hU(t,e,r){let n=J(t.byteLength)*Ks&Pe,s=J(t.byteLength-1)/J(32);for(;s>=0;){const o=Number(s);n=Ol(n,tt(t,16*o),tt(t,t.byteLength-16*(o+1)),tt(e,32*o),r),s-=J(1)}let i=n+(n>>J(64))&Pe;i=Fn(i);let a=(n&Pe)*Ks+(n>>J(64))*Kg+(J(t.byteLength)-r&Pe)*$i;return a&=Pe,a=Qp(Fn(a)),i|a<<J(64)}function fU(t,e,r){let n=J(t.byteLength)*Ks&Pe;for(let a=32;a<160;a+=32)n=Ol(n,tt(t,a-32),tt(t,a-16),tt(e,a-32),r);n=Fn(n&Pe)|Fn(n>>J(64))<<J(64);for(let a=160;a<=t.byteLength;a+=32)n=Ol(n,tt(t,a-32),tt(t,a-16),tt(e,3+a-160),r);n=Ol(n,tt(t,t.byteLength-16),tt(t,t.byteLength-32),tt(e,103),Qp(r));let s=n+(n>>J(64))&Pe;s=Fn(s);let i=(n&Pe)*Ks+(n>>J(64))*Kg+(J(t.byteLength)-r&Pe)*$i;return i&=Pe,i=Qp(Fn(i)),s|i<<J(64)}function oi(t,e=J(0)){const r=new TextEncoder,n=tt(typeof t=="string"?r.encode(t):t),s=n.byteLength,i=a=>a.toString(16).padStart(32,"0");return s<=16?i(dU(n,e)):s<=128?i(hU(n,Ln,e)):s<=240?i(fU(n,Ln,e)):i(oU(n,Ln))}function sA(t){return/^[0-9a-f]{32}$/.test(t)}function ya(t,e,r=!0,n=!1){try{return t[e].get()}catch(s){if(s.name===Qt.unminifiable_name){if(n)return s;if(r)return null}throw s}}function Ni(t,e,r=!0){if(Array.isArray(e)){const n={};for(const s of e)try{n[s]=ya(t,s,!r)}catch(i){if(i.name===Qt.unminifiable_name)continue}return n}else return ya(t,e)}function*pU(t,e){if(t.graph===rt.PARENT)throw new lt("There is no parent graph.");if(t.goto){let r;Array.isArray(t.goto)?r=t.goto:r=[t.goto];for(const n of r)if(Rr(n))yield[Qr,Yr,n];else if(typeof n=="string")yield[Qr,`branch:to:${n}`,"__start__"];else throw new Error(`In Command.send, expected Send or string, got ${typeof n}`)}if(t.resume)if(typeof t.resume=="object"&&Object.keys(t.resume).length&&Object.keys(t.resume).every(sA))for(const[r,n]of Object.entries(t.resume)){const s=e.filter(i=>i[0]===r&&i[1]===Cr).map(i=>i[2]).slice(0,1)??[];s.push(n),yield[r,Cr,s]}else yield[Qr,Cr,t.resume];if(t.update){if(typeof t.update!="object"||!t.update)throw new Error("Expected cmd.update to be a dict mapping channel names to update values");if(Array.isArray(t.update))for(const[r,n]of t.update)yield[Qr,r,n];else for(const[r,n]of Object.entries(t.update))yield[Qr,r,n]}}function*iA(t,e){if(e!=null)if(Array.isArray(t)&&typeof e=="object"&&!Array.isArray(e))for(const r in e)t.includes(r)&&(yield[r,e[r]]);else{if(Array.isArray(t))throw new Error('Input chunk must be an object when "inputChannels" is an array');yield[t,e]}}function*Sf(t,e,r){Array.isArray(t)?(e===!0||e.find(([n,s])=>t.includes(n)))&&(yield Ni(r,t)):(e===!0||e.some(([n,s])=>n===t))&&(yield ya(r,t))}function*mU(t,e,r){const n=e.filter(([o,c])=>{var l;return(o.config===void 0||!((l=o.config.tags)!=null&&l.includes(Tt)))&&c[0][0]!==xr&&c[0][0]!==He});if(!n.length)return;let s;n.some(([o])=>o.writes.some(([c,l])=>c===ka))?s=n.flatMap(([o])=>o.writes.filter(([c,l])=>c===ka).map(([c,l])=>[o.name,l])):Array.isArray(t)?s=n.flatMap(([o])=>{const{writes:c}=o,l={};for(const[u]of c)t.includes(u)&&(l[u]=(l[u]||0)+1);return Object.values(l).some(u=>u>1)?c.filter(([u])=>t.includes(u)).map(([u,d])=>[o.name,{[u]:d}]):[[o.name,Object.fromEntries(c.filter(([u])=>t.includes(u)))]]}):s=n.flatMap(([o])=>o.writes.filter(([c,l])=>c===t).map(([c,l])=>[o.name,l]));const i={};for(const[o,c]of s)o in i||(i[o]=[]),i[o].push(c);const a={};for(const o in i)if(i[o].length===1){const[c]=i[o];a[o]=c}else a[o]=i[o];r&&(a.__metadata__={cached:r}),yield a}function Xg(t){const e=typeof t[et];if(e==="number")return 0;if(e==="string")return"";for(const r in t){if(!Object.prototype.hasOwnProperty.call(t,r))continue;const n=typeof t[r];if(n==="number")return 0;if(n==="string")return"";break}}function $l(t,e){if(Object.keys(t).length>0){const r=Xg(e);return Object.fromEntries(Object.entries(e).filter(([n,s])=>s>(t[n]??r)))}else return e}function gU(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}function yn(t,e){return t===null?{configurable:e}:(t==null?void 0:t.configurable)===void 0?{...t,configurable:e}:{...t,configurable:{...t.configurable,...e}}}function ti(t,e){var n,s;const r=(e==null?void 0:e.parents)??{};return Object.keys(r).length>0?yn(t,{[Xr]:{...r,[((n=t.configurable)==null?void 0:n.checkpoint_ns)??""]:(s=t.configurable)==null?void 0:s.checkpoint_id}}):t}function Su(...t){const e=[...new Set(t.filter(Boolean))];if(e.length===0)return{signal:void 0,dispose:void 0};if(e.length===1)return{signal:e[0],dispose:void 0};const r=new AbortController,n=()=>{var a;const i=(a=e.find(o=>o.aborted))==null?void 0:a.reason;r.abort(i),e.forEach(o=>o.removeEventListener("abort",n))};e.forEach(i=>i.addEventListener("abort",n,{once:!0}));const s=e.find(i=>i.aborted);return s&&r.abort(s.reason),{signal:r.signal,dispose:()=>{e.forEach(i=>i.removeEventListener("abort",n))}}}const yU=(t,e)=>{if(!(!t&&!e))return t?e?Array.isArray(t)&&Array.isArray(e)?[...t,...e]:Array.isArray(t)?[...t,e]:Array.isArray(e)?[t,...e]:[t,e]:t:e};var _U=class{constructor({func:t,name:e,input:r,retry:n,cache:s,callbacks:i}){p(this,"func");p(this,"name");p(this,"input");p(this,"retry");p(this,"cache");p(this,"callbacks");p(this,"__lg_type","call");this.func=t,this.name=e,this.input=r,this.retry=n,this.cache=s,this.callbacks=i}};function wU(t){return typeof t=="object"&&t!==null&&"__lg_type"in t&&t.__lg_type==="call"}function bU(t,e){const r=new ei({func:n=>e(...n),name:t,trace:!1,recurse:!1});return new Zn({name:t,first:r,last:new hr([{channel:ka,value:Si}],[Tt])})}const vU=t=>t!==void 0?t+1:1;function EU(t,e){if(e==null)return!1;for(const r of t)if(e[r])return!0;return!1}function SU(t){let e;for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e==null?e=t[r]:e=A4(e,t[r]));return e}function Xc(t,e,r){const n=Xg(t.channel_versions),s=t.versions_seen[He]??{};let i=!1;if((t.channel_versions[et]??n)>(s[et]??n))i=!0;else for(const o in t.channel_versions)if(Object.prototype.hasOwnProperty.call(t.channel_versions,o)&&t.channel_versions[o]>(s[o]??n)){i=!0;break}const a=r.some(o=>{var c,l;return e==="*"?!((l=(c=o.config)==null?void 0:c.tags)!=null&&l.includes(Tt)):e.includes(o.name)});return i&&a}function Nl(t,e,r,n,s=!1){let i=new Set;if(Array.isArray(n))i=new Set(n.filter(o=>r.writes.some(([c,l])=>c===o)));else{for(const[o]of r.writes)if(o===n){i=new Set([o]);break}i=i||new Set}let a;if(s&&i.size>0){const o=Object.fromEntries(Object.entries(e).filter(([u,d])=>i.has(u))),c=di(t,o,-1),l=_u(o,c);Br(yu(c),l,[r],void 0,void 0),a=Ni({...e,...l},n)}else a=Ni(e,n);return a}function xf(t,e,r){for(const[n,s]of r)if([jr,Yr].includes(n)&&s!=null){if(!Rr(s))throw new lt(`Invalid packet type, expected SendProtocol, got ${JSON.stringify(s)}`);if(!(s.node in e))throw new lt(`Invalid node name "${s.node}" in Send packet`)}t(r)}const xU=new Set([Jg,jr,Cr,He,ka,xr]);function Br(t,e,r,n,s){var h,f;r.sort((m,g)=>{var _,E;const y=((_=m.path)==null?void 0:_.slice(0,3))||[],b=((E=g.path)==null?void 0:E.slice(0,3))||[];for(let C=0;C<Math.min(y.length,b.length);C+=1){if(y[C]<b[C])return-1;if(y[C]>b[C])return 1}return y.length-b.length});const i=r.some(m=>m.triggers.length>0),a=Hg(e);for(const m of r){(h=t.versions_seen)[f=m.name]??(h[f]={});for(const g of m.triggers)g in t.channel_versions&&(t.versions_seen[m.name][g]=t.channel_versions[g])}let o=SU(t.channel_versions);const c=new Set(r.flatMap(m=>m.triggers).filter(m=>!B4.includes(m)));let l=!1;for(const m of c)m in a&&a[m].consume()&&n!==void 0&&(t.channel_versions[m]=n(o),l=!0);const u={};for(const m of r)for(const[g,y]of m.writes)xU.has(g)||g in a&&(u[g]??(u[g]=[]),u[g].push(y));o!=null&&n!=null&&(o=l?n(o):o);const d=new Set;for(const[m,g]of Object.entries(u))if(m in a){const y=a[m];let b;try{b=y.update(g)}catch(_){if(_.name===lt.unminifiable_name){const E=new lt(`Invalid update for channel "${m}" with values ${JSON.stringify(g)}: ${_.message}`);throw E.lc_error_code=_.lc_error_code,E}else throw _}b&&n!==void 0&&(t.channel_versions[m]=n(o),y.isAvailable()&&d.add(m))}if(i)for(const m in a){if(!Object.prototype.hasOwnProperty.call(a,m))continue;const g=a[m];g.isAvailable()&&!d.has(m)&&g.update([])&&n!==void 0&&(t.channel_versions[m]=n(o),g.isAvailable()&&d.add(m))}if(i&&!EU(d,s))for(const m in a){if(!Object.prototype.hasOwnProperty.call(a,m))continue;const g=a[m];g.finish()&&n!==void 0&&(t.channel_versions[m]=n(o),g.isAvailable()&&d.add(m))}return d}function*TU(t,e,r){if(r.updatedChannels!=null&&r.triggerToNodes!=null){const s=new Set;for(const i of r.updatedChannels){const a=r.triggerToNodes[i];for(const o of a??[])s.add(o)}yield*[...s].sort();return}if(!(()=>{for(const s in t.channel_versions)if(t.channel_versions[s]!==null)return!1;return!0})())for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&(yield s)}function da(t,e,r,n,s,i,a){const o={},c=n[Yr];if(c!=null&&c.isAvailable()){const l=c.get().length;for(let u=0;u<l;u+=1){const d=em([jr,u],t,e,r,n,s,i,a);d!==void 0&&(o[d.id]=d)}}for(const l of TU(t,r,a)){const u=em([Il,l],t,e,r,n,s,i,a);u!==void 0&&(o[u.id]=u)}return o}function em(t,e,r,n,s,i,a,o){var f,m,g,y;const{step:c,checkpointer:l,manager:u}=o,d=i.configurable??{},h=d.checkpoint_ns??"";if(t[0]===jr&&wU(t[t.length-1])){const b=t[t.length-1],_=bU(b.name,b.func),E=[jr],C=h===""?b.name:`${h}${Pt}${b.name}`,k=ia(JSON.stringify([C,c.toString(),b.name,jr,t[1],t[2]]),e.id),R=`${C}${fs}${k}`,$=[...t.slice(0,3),!0],S={langgraph_step:c,langgraph_node:b.name,langgraph_triggers:E,langgraph_path:$,langgraph_checkpoint_ns:R};if(a){const M=[];return{name:b.name,input:b.input,proc:_,writes:M,config:Ze(en(i,{metadata:S,store:o.store??i.store}),{runName:b.name,callbacks:u==null?void 0:u.getChild(`graph:step:${c}`),configurable:{[Eo]:k,[zs]:q=>xf(se=>M.push(...se),n,q),[Ei]:(q,se=!1)=>Nl(e,s,{name:b.name,writes:M,triggers:E,path:$},q,se),[vt]:l??d[vt],[Xr]:{...d[Xr],[h]:e.id},[Vs]:Tf({pendingWrites:r??[],taskId:k,currentTaskInput:b.input,resumeMap:(f=i.configurable)==null?void 0:f[Cl],namespaceHash:oi(R)}),[kl]:e.channel_values[wf],checkpoint_id:void 0,checkpoint_ns:R}}),triggers:E,retry_policy:b.retry,cache_key:b.cache?{key:oi((b.cache.keyFunc??JSON.stringify)([b.input])),ns:[_f,b.name??"__dynamic__"],ttl:b.cache.ttl}:void 0,id:k,path:$,writers:[]}}else return{id:k,name:b.name,interrupts:[],path:$}}else if(t[0]===jr){const b=typeof t[1]=="number"?t[1]:parseInt(t[1],10);if(!((m=s[Yr])!=null&&m.isAvailable()))return;const _=s[Yr].get();if(b<0||b>=_.length)return;const E=Kp(_[b])&&!Rr(_[b])?new bu(_[b].node,_[b].args):_[b];if(!Kp(E)){console.warn(`Ignoring invalid packet ${JSON.stringify(E)} in pending sends.`);return}if(!(E.node in n)){console.warn(`Ignoring unknown node name ${E.node} in pending sends.`);return}const C=[jr],k=h===""?E.node:`${h}${Pt}${E.node}`,R=ia(JSON.stringify([k,c.toString(),E.node,jr,b.toString()]),e.id),$=`${k}${fs}${R}`;let S={langgraph_step:c,langgraph_node:E.node,langgraph_triggers:C,langgraph_path:t.slice(0,3),langgraph_checkpoint_ns:$};if(a){const M=n[E.node],B=M.getNode();if(B!==void 0){M.metadata!==void 0&&(S={...S,...M.metadata});const q=[];return{name:E.node,input:E.args,proc:B,subgraphs:M.subgraphs,writes:q,config:Ze(en(i,{metadata:S,tags:M.tags,store:o.store??i.store}),{runName:E.node,callbacks:u==null?void 0:u.getChild(`graph:step:${c}`),configurable:{[Eo]:R,[zs]:se=>xf(pe=>q.push(...pe),n,se),[Ei]:(se,pe=!1)=>Nl(e,s,{name:E.node,writes:q,triggers:C,path:t},se,pe),[vt]:l??d[vt],[Xr]:{...d[Xr],[h]:e.id},[Vs]:Tf({pendingWrites:r??[],taskId:R,currentTaskInput:E.args,resumeMap:(g=i.configurable)==null?void 0:g[Cl],namespaceHash:oi($)}),[kl]:e.channel_values[wf],checkpoint_id:void 0,checkpoint_ns:$}}),triggers:C,retry_policy:M.retryPolicy,cache_key:M.cachePolicy?{key:oi((M.cachePolicy.keyFunc??JSON.stringify)([E.args])),ns:[_f,M.name??"__dynamic__",E.node],ttl:M.cachePolicy.ttl}:void 0,id:R,path:t,writers:M.getWriters()}}}else return{id:R,name:E.node,interrupts:[],path:t}}else if(t[0]===Il){const b=t[1].toString(),_=n[b];if(_===void 0)return;if(r!=null&&r.length){const R=h===""?b:`${h}${Pt}${b}`,$=ia(JSON.stringify([R,c.toString(),b,Il,b]),e.id);if(r.some(M=>M[0]===$&&M[1]!==xr))return}const E=Xg(e.channel_versions);if(E===void 0)return;const C=e.versions_seen[b]??{},k=_.triggers.find(R=>s[R].isAvailable()?(e.channel_versions[R]??E)>(C[R]??E):!1);if(k!==void 0){const R=AU(_,s,a);if(R===void 0)return;const $=h===""?b:`${h}${Pt}${b}`,S=ia(JSON.stringify([$,c.toString(),b,Il,[k]]),e.id),M=`${$}${fs}${S}`;let B={langgraph_step:c,langgraph_node:b,langgraph_triggers:[k],langgraph_path:t,langgraph_checkpoint_ns:M};if(a){const q=_.getNode();if(q!==void 0){_.metadata!==void 0&&(B={...B,..._.metadata});const se=[];return{name:b,input:R,proc:q,subgraphs:_.subgraphs,writes:se,config:Ze(en(i,{metadata:B,tags:_.tags,store:o.store??i.store}),{runName:b,callbacks:u==null?void 0:u.getChild(`graph:step:${c}`),configurable:{[Eo]:S,[zs]:pe=>xf(j=>{se.push(...j)},n,pe),[Ei]:(pe,j=!1)=>Nl(e,s,{name:b,writes:se,triggers:[k],path:t},pe,j),[vt]:l??d[vt],[Xr]:{...d[Xr],[h]:e.id},[Vs]:Tf({pendingWrites:r??[],taskId:S,currentTaskInput:R,resumeMap:(y=i.configurable)==null?void 0:y[Cl],namespaceHash:oi(M)}),[kl]:e.channel_values[wf],checkpoint_id:void 0,checkpoint_ns:M}}),triggers:[k],retry_policy:_.retryPolicy,cache_key:_.cachePolicy?{key:oi((_.cachePolicy.keyFunc??JSON.stringify)([R])),ns:[_f,_.name??"__dynamic__",b],ttl:_.cachePolicy.ttl}:void 0,id:S,path:t,writers:_.getWriters()}}}else return{id:S,name:b,interrupts:[],path:t}}}}function AU(t,e,r){let n;if(typeof t.channels=="object"&&!Array.isArray(t.channels)){n={};for(const[s,i]of Object.entries(t.channels))if(t.triggers.includes(i))try{n[s]=ya(e,i,!1)}catch(a){if(a.name===Qt.unminifiable_name)return;throw a}else if(i in e)try{n[s]=ya(e,i,!1)}catch(a){if(a.name===Qt.unminifiable_name)continue;throw a}}else if(Array.isArray(t.channels)){let s=!1;for(const i of t.channels)try{n=ya(e,i,!1),s=!0;break}catch(a){if(a.name===Qt.unminifiable_name)continue;throw a}if(!s)return}else throw new Error(`Invalid channels type, expected list or dict, got ${t.channels}`);return r&&t.mapper!==void 0&&(n=t.mapper(n)),n}function Tf({pendingWrites:t,taskId:e,currentTaskInput:r,resumeMap:n,namespaceHash:s}){var c;const i=(c=t.find(([l,u])=>l===Qr&&u===Cr))==null?void 0:c[2],o={callCounter:0,interruptCounter:-1,resume:(()=>{const l=t.filter(([u,d])=>u===e&&d===Cr).flatMap(([u,d,h])=>h);if(n!=null&&s in n){const u=n[s];l.push(u)}return l})(),nullResume:i,subgraphCounter:0,currentTaskInput:r,consumeNullResume:()=>{if(o.nullResume)return delete o.nullResume,t.splice(t.findIndex(([l,u])=>l===Qr&&u===Cr),1),i}};return o}const Ko={blue:{start:"\x1B[34m",end:"\x1B[0m"},green:{start:"\x1B[32m",end:"\x1B[0m"},yellow:{start:"\x1B[33;1m",end:"\x1B[0m"}},Xo=(t,e)=>`${t.start}${e}${t.end}`;function*$b(t){var e;for(const{id:r,name:n,input:s,config:i,triggers:a,writes:o}of t){if((e=i==null?void 0:i.tags)!=null&&e.includes(Tt))continue;const c=o.filter(([l,u])=>l===r&&u===He).map(([,l])=>l);yield{id:r,name:n,input:s,triggers:a,interrupts:c}}}function CU(t){return typeof t!="object"||t===null?!1:"$writes"in t&&Array.isArray(t.$writes)}function aA(t){const e={};for(const[r,n]of t){const s=String(r);if(s in e){const i=CU(e[s])?e[s].$writes:[e[s]];i.push(n),e[s]={$writes:i}}else e[s]=n}return e}function*kU(t,e){var r;for(const[{id:n,name:s,config:i},a]of t)(r=i==null?void 0:i.tags)!=null&&r.includes(Tt)||(yield{id:n,name:s,result:aA(a.filter(([o])=>Array.isArray(e)?e.includes(o):o===e)),interrupts:a.filter(o=>o[0]===He).map(o=>o[1])})}function*IU(t,e,r,n,s,i,a,o){var d,h,f;function c(m){const g={};return m.callbacks!=null&&(g.callbacks=m.callbacks),m.configurable!=null&&(g.configurable=m.configurable),m.maxConcurrency!=null&&(g.max_concurrency=m.maxConcurrency),m.metadata!=null&&(g.metadata=m.metadata),m.recursionLimit!=null&&(g.recursion_limit=m.recursionLimit),m.runId!=null&&(g.run_id=m.runId),m.runName!=null&&(g.run_name=m.runName),m.tags!=null&&(g.tags=m.tags),g}const l=(d=t.configurable)==null?void 0:d.checkpoint_ns,u={};for(const m of s){if(!((h=m.subgraphs)!=null&&h.length?m.subgraphs:[m.proc]).find(XT))continue;let y=`${m.name}:${m.id}`;l&&(y=`${l}|${y}`),u[m.id]={configurable:{thread_id:(f=t.configurable)==null?void 0:f.thread_id,checkpoint_ns:y}}}yield{config:c(t),values:Ni(e,r),metadata:n,next:s.map(m=>m.name),tasks:oA(s,i,u,o),parentConfig:a?c(a):void 0}}function oA(t,e,r,n){return t.map(s=>{var l;const i=(l=e.find(([u,d])=>u===s.id&&d===xr))==null?void 0:l[2],a=e.filter(([u,d])=>u===s.id&&d===He).map(([,,u])=>u),o=(()=>{var d;if(i||a.length||!e.length)return;const u=e.findIndex(([h,f])=>h===s.id&&f===ka);if(u>=0)return e[u][2];if(typeof n=="string")return(d=e.find(([h,f])=>h===s.id&&f===n))==null?void 0:d[2];if(Array.isArray(n)){const h=e.filter(([f,m])=>f===s.id&&n.includes(m)).map(([,f,m])=>[f,m]);return h.length?aA(h):void 0}})();if(i)return{id:s.id,name:s.name,path:s.path,error:i,interrupts:a,result:o};const c=r==null?void 0:r[s.id];return{id:s.id,name:s.name,path:s.path,interrupts:a,...c!==void 0?{state:c}:{},result:o}})}function RU(t,e,r){console.log([`${Xo(Ko.blue,`[${t}:checkpoint]`)}`,`\x1B[1m State at the end of step ${t}:\x1B[0m
`,JSON.stringify(Ni(e,r),null,2)].join(""))}function cA(t,e){const r=e.length;console.log([`${Xo(Ko.blue,`[${t}:tasks]`)}`,`\x1B[1m Starting step ${t} with ${r} task${r===1?"":"s"}:\x1B[0m
`,e.map(n=>`- ${Xo(Ko.green,String(n.name))} -> ${JSON.stringify(n.input,null,2)}`).join(`
`)].join(""))}function OU(t,e,r){const n={};for(const[s,i]of e)r.includes(s)&&(n[s]||(n[s]=[]),n[s].push(i));console.log([`${Xo(Ko.blue,`[${t}:writes]`)}`,`\x1B[1m Finished step ${t} with writes to ${Object.keys(n).length} channel${Object.keys(n).length!==1?"s":""}:\x1B[0m
`,Object.entries(n).map(([s,i])=>`- ${Xo(Ko.yellow,s)} -> ${i.map(a=>JSON.stringify(a)).join(", ")}`).join(`
`)].join(""))}var Nb=class extends kr{constructor(e,r){const n=e.getReader(),s=r??new AbortController;super({start(i){return a();function a(){return n.read().then(({done:o,value:c})=>{if(o){i.close();return}return i.enqueue(c),a()})}}});p(this,"_abortController");p(this,"_innerReader");this._abortController=s,this._innerReader=n}async cancel(e){this._abortController.abort(e),this._innerReader.releaseLock()}get signal(){return this._abortController.signal}},lA=class extends kr{constructor(e){let r;const n=new Promise(s=>{r=s});super({start:s=>{r(s)}});p(this,"modes");p(this,"controller");p(this,"passthroughFn");p(this,"_closed",!1);n.then(s=>{this.controller=s}),this.passthroughFn=e.passthroughFn,this.modes=e.modes}get closed(){return this._closed}push(e){var r;(r=this.passthroughFn)==null||r.call(this,e),this.controller.enqueue(e)}close(){try{this.controller.close()}catch{}finally{this._closed=!0}}error(e){this.controller.error(e)}};function $U(t){return JSON.stringify(t,function(e,r){const n=this[e];if(n!=null&&typeof n=="object"&&"toDict"in n&&typeof n.toDict=="function"){const{type:s,data:i}=n.toDict();return{...i,type:s}}return r})}function NU(t){return t instanceof Error?{error:t.name,message:t.message}:{error:"Error",message:JSON.stringify(t)}}function Yg(t){return typeof t!="object"||t==null?!1:"configurable"in t&&typeof t.configurable=="object"&&t.configurable!=null}function Af(t){return!Yg(t)||!t.configurable.thread_id?null:{thread_id:t.configurable.thread_id,checkpoint_ns:t.configurable.checkpoint_ns||"",checkpoint_id:t.configurable.checkpoint_id||null,checkpoint_map:t.configurable.checkpoint_map||null}}function Pb(t){if(Yg(t)){const e=Object.fromEntries(Object.entries(t.configurable).filter(([n])=>!n.startsWith("__"))),r={...t,configurable:e};return delete r.callbacks,r}return t}function Lb(t){const e={...t,checkpoint:Af(t.config),parent_checkpoint:Af(t.parentConfig),config:Pb(t.config),parent_config:Pb(t.parentConfig),tasks:t.tasks.map(r=>{if(Yg(r.state)){const n=Af(r.state);if(n!=null){const s={...r,checkpoint:n};return delete s.state,s}}return r})};return delete e.parentConfig,e}function PU(t){const e=new TextEncoder;return new ReadableStream({async start(r){const n=s=>{r.enqueue(e.encode(`event: ${s.event}
data: ${$U(s.data)}

`))};try{for await(const s of t){const[i,a,o]=s;let c=o;if(a==="debug"){const u=o;u.type==="checkpoint"&&(c={...u,payload:Lb(u.payload)})}a==="checkpoints"&&(c=Lb(o));const l=i!=null&&i.length?`${a}|${i.join("|")}`:a;n({event:l,data:c})}}catch(s){n({event:"error",data:NU(s)})}r.close()}})}const Yc=Symbol.for("INPUT_DONE"),Cf=Symbol.for("INPUT_RESUMING"),LU=25;function MU(...t){return new lA({passthroughFn:e=>{for(const r of t)r.modes.has(e[1])&&r.push(e)},modes:new Set(t.flatMap(e=>Array.from(e.modes)))})}var DU=class extends $4{constructor(e){super();p(this,"cache");p(this,"queue",Promise.resolve());this.cache=e}async get(e){return this.enqueueOperation("get",e)}async set(e){return this.enqueueOperation("set",e)}async clear(e){return this.enqueueOperation("clear",e)}async stop(){await this.queue}enqueueOperation(e,...r){const n=this.queue.then(()=>this.cache[e](...r));return this.queue=n.then(()=>{},()=>{}),n}},UU=class uA{constructor(e){p(this,"input");p(this,"output");p(this,"config");p(this,"checkpointer");p(this,"checkpointerGetNextVersion");p(this,"channels");p(this,"checkpoint");p(this,"checkpointIdSaved");p(this,"checkpointConfig");p(this,"checkpointMetadata");p(this,"checkpointNamespace");p(this,"checkpointPendingWrites",[]);p(this,"checkpointPreviousVersions");p(this,"step");p(this,"stop");p(this,"durability");p(this,"outputKeys");p(this,"streamKeys");p(this,"nodes");p(this,"skipDoneTasks");p(this,"prevCheckpointConfig");p(this,"updatedChannels");p(this,"status","pending");p(this,"tasks",{});p(this,"stream");p(this,"checkpointerPromises",[]);p(this,"isNested");p(this,"_checkpointerChainedPromise",Promise.resolve());p(this,"store");p(this,"cache");p(this,"manager");p(this,"interruptAfter");p(this,"interruptBefore");p(this,"toInterrupt",[]);p(this,"debug",!1);p(this,"triggerToNodes");this.input=e.input,this.checkpointer=e.checkpointer,this.checkpointer!==void 0?this.checkpointerGetNextVersion=this.checkpointer.getNextVersion.bind(this.checkpointer):this.checkpointerGetNextVersion=vU,this.checkpoint=e.checkpoint,this.checkpointMetadata=e.checkpointMetadata,this.checkpointPreviousVersions=e.checkpointPreviousVersions,this.channels=e.channels,this.checkpointPendingWrites=e.checkpointPendingWrites,this.step=e.step,this.stop=e.stop,this.config=e.config,this.checkpointConfig=e.checkpointConfig,this.isNested=e.isNested,this.manager=e.manager,this.outputKeys=e.outputKeys,this.streamKeys=e.streamKeys,this.nodes=e.nodes,this.skipDoneTasks=e.skipDoneTasks,this.store=e.store,this.cache=e.cache?new DU(e.cache):void 0,this.stream=e.stream,this.checkpointNamespace=e.checkpointNamespace,this.prevCheckpointConfig=e.prevCheckpointConfig,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.durability=e.durability,this.debug=e.debug,this.triggerToNodes=e.triggerToNodes}get isResuming(){var c,l,u,d,h;let e=!1;if(et in this.checkpoint.channel_versions)e=!0;else for(const f in this.checkpoint.channel_versions)if(Object.prototype.hasOwnProperty.call(this.checkpoint.channel_versions,f)){e=!0;break}const n=((c=this.config.configurable)==null?void 0:c[$s])!==void 0&&((l=this.config.configurable)==null?void 0:l[$s]),s=this.input===null||this.input===void 0,i=Xt(this.input)&&this.input.resume!=null,a=this.input===Cf,o=!this.isNested&&((u=this.config.metadata)==null?void 0:u.run_id)!==void 0&&((d=this.checkpointMetadata)==null?void 0:d.run_id)!==void 0&&this.config.metadata.run_id===((h=this.checkpointMetadata)==null?void 0:h.run_id);return e&&(n||s||i||a||o)}static async initialize(e){var E,C,k,R,$,S,M,B,q,se,pe,j;let{config:r,stream:n}=e;n!==void 0&&((E=r.configurable)==null?void 0:E[wu])!==void 0&&(n=MU(n,r.configurable[wu]));const s=r.configurable?!("checkpoint_id"in r.configurable):!0,i=(C=r.configurable)==null?void 0:C[Vs];r.configurable&&i&&(i.subgraphCounter>0&&(r=yn(r,{[Un]:[r.configurable[Un],i.subgraphCounter.toString()].join(Pt)})),i.subgraphCounter+=1);const a=Ei in(r.configurable??{});!a&&((k=r.configurable)==null?void 0:k.checkpoint_ns)!==void 0&&((R=r.configurable)==null?void 0:R.checkpoint_ns)!==""&&(r=yn(r,{checkpoint_ns:"",checkpoint_id:void 0}));let o=r;(($=r.configurable)==null?void 0:$[Xr])!==void 0&&((B=(S=r.configurable)==null?void 0:S[Xr])!=null&&B[(M=r.configurable)==null?void 0:M.checkpoint_ns])&&(o=yn(r,{checkpoint_id:r.configurable[Xr][(q=r.configurable)==null?void 0:q.checkpoint_ns]}));const c=((pe=(se=r.configurable)==null?void 0:se.checkpoint_ns)==null?void 0:pe.split(Pt))??[],l=await((j=e.checkpointer)==null?void 0:j.getTuple(o))??{config:r,checkpoint:FT(),metadata:{source:"input",step:-2,parents:{}},pendingWrites:[]};o={...r,...l.config,configurable:{checkpoint_ns:"",...r.configurable,...l.config.configurable}};const u=l.parentConfig,d=yu(l.checkpoint),h={...l.metadata},f=l.pendingWrites??[],m=_u(e.channelSpecs,d),g=(h.step??0)+1,y=g+(r.recursionLimit??LU)+1,b={...d.channel_versions},_=e.store?new O4(e.store):void 0;return _&&await _.start(),new uA({input:e.input,config:r,checkpointer:e.checkpointer,checkpoint:d,checkpointMetadata:h,checkpointConfig:o,prevCheckpointConfig:u,checkpointNamespace:c,channels:m,isNested:a,manager:e.manager,skipDoneTasks:s,step:g,stop:y,checkpointPreviousVersions:b,checkpointPendingWrites:f,outputKeys:e.outputKeys??[],streamKeys:e.streamKeys??[],nodes:e.nodes,stream:n,store:_,cache:e.cache,interruptAfter:e.interruptAfter,interruptBefore:e.interruptBefore,durability:e.durability,debug:e.debug,triggerToNodes:e.triggerToNodes})}_checkpointerPutAfterPrevious(e){this._checkpointerChainedPromise=this._checkpointerChainedPromise.then(()=>{var r;return(r=this.checkpointer)==null?void 0:r.put(e.config,e.checkpoint,e.metadata,e.newVersions)}),this.checkpointerPromises.push(this._checkpointerChainedPromise)}putWrites(e,r){var a;let n=r;if(n.length===0)return;n.every(([o])=>o in C4)&&(n=Array.from(new Map(n.map(o=>[o[0],o])).values())),this.checkpointPendingWrites=this.checkpointPendingWrites.filter(o=>o[0]!==e);for(const[o,c]of n)this.checkpointPendingWrites.push([e,o,c]);const s=yn(this.checkpointConfig,{[Un]:((a=this.config.configurable)==null?void 0:a.checkpoint_ns)??"",[Zp]:this.checkpoint.id});if(this.durability!=="exit"&&this.checkpointer!=null&&this.checkpointerPromises.push(this.checkpointer.putWrites(s,n,e)),this.tasks&&this._outputWrites(e,n),!r.length||!this.cache||!this.tasks)return;const i=this.tasks[e];i==null||i.cache_key==null||r[0][0]===xr||r[0][0]===He||this.cache.set([{key:[i.cache_key.ns,i.cache_key.key],value:i.writes,ttl:i.cache_key.ttl}])}_outputWrites(e,r,n=!1){var i,a;const s=this.tasks[e];if(s!==void 0){if(s.config!==void 0&&(s.config.tags??[]).includes(Tt))return;if(r.length>0)if(r[0][0]===He){if(((i=s.path)==null?void 0:i[0])===jr&&((a=s.path)==null?void 0:a.at(-1))===!0)return;const o=r.filter(c=>c[0]===He).flatMap(c=>c[1]);this._emit([["updates",{[He]:o}],["values",{[He]:o}]])}else r[0][0]!==xr&&this._emit(no(As(mU(this.outputKeys,[[s,r]],n),"updates")));n||this._emit(no(As(kU([[s,r]],this.streamKeys),"tasks")))}}async _matchCachedWrites(){if(!this.cache)return[];const e=[],r=([a,o])=>`ns:${a.join(",")}|key:${o}`,n=[],s={};for(const a of Object.values(this.tasks))a.cache_key!=null&&!a.writes.length&&(n.push([a.cache_key.ns,a.cache_key.key]),s[r([a.cache_key.ns,a.cache_key.key])]=a);if(n.length===0)return[];const i=await this.cache.get(n);for(const{key:a,value:o}of i){const c=s[r(a)];c!=null&&(c.writes.push(...o),e.push({task:c,result:o}))}return e}async tick(e){var i,a,o;this.store&&!this.store.isRunning&&await((i=this.store)==null?void 0:i.start());const{inputKeys:r=[]}=e;if(this.status!=="pending")throw new Error(`Cannot tick when status is no longer "pending". Current status: "${this.status}"`);if(![Yc,Cf].includes(this.input))await this._first(r);else{if(this.toInterrupt.length>0)throw this.status="interrupt_before",new pa;if(Object.values(this.tasks).every(c=>c.writes.length>0)){const c=Object.values(this.tasks).flatMap(u=>u.writes);this.updatedChannels=Br(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion,this.triggerToNodes);const l=await Ps(As(Sf(this.outputKeys,c,this.channels),"values"));if(this._emit(l),this.checkpointPendingWrites=[],await this._putCheckpoint({source:"loop"}),Xc(this.checkpoint,this.interruptAfter,Object.values(this.tasks)))throw this.status="interrupt_after",new pa;((a=this.config.configurable)==null?void 0:a[$s])!==void 0&&((o=this.config.configurable)==null||delete o[$s])}else return!1}if(this.step>this.stop)return this.status="out_of_steps",!1;const n=da(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.config,!0,{step:this.step,checkpointer:this.checkpointer,isResuming:this.isResuming,manager:this.manager,store:this.store,stream:this.stream,triggerToNodes:this.triggerToNodes,updatedChannels:this.updatedChannels});if(this.tasks=n,this.checkpointer&&this._emit(await Ps(As(IU(this.checkpointConfig,this.channels,this.streamKeys,this.checkpointMetadata,Object.values(this.tasks),this.checkpointPendingWrites,this.prevCheckpointConfig,this.outputKeys),"checkpoints"))),Object.values(this.tasks).length===0)return this.status="done",!1;if(this.skipDoneTasks&&this.checkpointPendingWrites.length>0){for(const[c,l,u]of this.checkpointPendingWrites){if(l===xr||l===He||l===Cr)continue;const d=Object.values(this.tasks).find(h=>h.id===c);d&&d.writes.push([l,u])}for(const c of Object.values(this.tasks))c.writes.length>0&&this._outputWrites(c.id,c.writes,!0)}if(Object.values(this.tasks).every(c=>c.writes.length>0))return this.tick({inputKeys:r});if(Xc(this.checkpoint,this.interruptBefore,Object.values(this.tasks)))throw this.status="interrupt_before",new pa;const s=await Ps(As($b(Object.values(this.tasks)),"tasks"));return this._emit(s),!0}async finishAndHandleError(e){this.durability==="exit"&&(!this.isNested||typeof e<"u"||this.checkpointNamespace.every(n=>!n.includes(fs)))&&(this._putCheckpoint(this.checkpointMetadata),this._flushPendingWrites());const r=this._suppressInterrupt(e);return(r||e===void 0)&&(this.output=Ni(this.channels,this.outputKeys)),r&&(this.tasks!==void 0&&this.checkpointPendingWrites.length>0&&Object.values(this.tasks).some(n=>n.writes.length>0)&&(this.updatedChannels=Br(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion,this.triggerToNodes),this._emit(no(As(Sf(this.outputKeys,Object.values(this.tasks).flatMap(n=>n.writes),this.channels),"values")))),fi(e)&&!e.interrupts.length&&this._emit([["updates",{[He]:[]}],["values",{[He]:[]}]])),r}async acceptPush(e,r,n){var a,o;if(((a=this.interruptAfter)==null?void 0:a.length)>0&&Xc(this.checkpoint,this.interruptAfter,[e])){this.toInterrupt.push(e);return}const s=em([jr,e.path??[],r,e.id,n],this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,e.config??{},!0,{step:this.step,checkpointer:this.checkpointer,manager:this.manager,store:this.store,stream:this.stream});if(!s)return;if(((o=this.interruptBefore)==null?void 0:o.length)>0&&Xc(this.checkpoint,this.interruptBefore,[s])){this.toInterrupt.push(s);return}this._emit(no(As($b([s]),"tasks"))),this.debug&&cA(this.step,[s]),this.tasks[s.id]=s,this.skipDoneTasks&&this._matchWrites({[s.id]:s});const i=await this._matchCachedWrites();for(const{task:c}of i)this._outputWrites(c.id,c.writes,!0);return s}_suppressInterrupt(e){return fi(e)&&!this.isNested}async _first(e){var a;const{configurable:r}=this.config,n=r==null?void 0:r[Vs];if(n&&n.nullResume!==void 0&&this.putWrites(Qr,[[Cr,n.nullResume]]),Xt(this.input)){const o=this.input.resume!=null;if(this.input.resume!=null&&typeof this.input.resume=="object"&&Object.keys(this.input.resume).every(sA)&&((a=this.config).configurable??(a.configurable={}),this.config.configurable[Cl]=this.input.resume),o&&this.checkpointer==null)throw new Error("Cannot use Command(resume=...) without checkpointer");const c={};for(const[l,u,d]of pU(this.input,this.checkpointPendingWrites))c[l]??(c[l]=[]),c[l].push([u,d]);if(Object.keys(c).length===0)throw new Ky("Received empty Command input");for(const[l,u]of Object.entries(c))this.putWrites(l,u)}const s=(this.checkpointPendingWrites??[]).filter(o=>o[0]===Qr).map(o=>o.slice(1));s.length>0&&Br(this.checkpoint,this.channels,[{name:as,writes:s,triggers:[]}],this.checkpointerGetNextVersion,this.triggerToNodes);const i=Xt(this.input)&&s.length>0;if(this.isResuming||i){for(const c in this.channels)if(Object.prototype.hasOwnProperty.call(this.channels,c)&&this.checkpoint.channel_versions[c]!==void 0){const l=this.checkpoint.channel_versions[c];this.checkpoint.versions_seen[He]={...this.checkpoint.versions_seen[He],[c]:l}}const o=await Ps(As(Sf(this.outputKeys,!0,this.channels),"values"));this._emit(o)}if(this.isResuming)this.input=Cf;else if(i)await this._putCheckpoint({source:"input"}),this.input=Yc;else{const o=await Ps(iA(e,this.input));if(o.length>0){const c=da(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.config,!0,{step:this.step});this.updatedChannels=Br(this.checkpoint,this.channels,Object.values(c).concat([{name:as,writes:o,triggers:[]}]),this.checkpointerGetNextVersion,this.triggerToNodes),await this._putCheckpoint({source:"input"}),this.input=Yc}else if($s in(this.config.configurable??{}))this.input=Yc;else throw new Ky(`Received no input writes for ${JSON.stringify(e,null,2)}`)}this.isNested||(this.config=yn(this.config,{[$s]:this.isResuming}))}_emit(e){for(const[r,n]of e)if(this.stream.modes.has(r)&&this.stream.push([this.checkpointNamespace,r,n]),(r==="checkpoints"||r==="tasks")&&this.stream.modes.has("debug")){const s=r==="checkpoints"?this.step-1:this.step,i=new Date().toISOString(),a=r==="checkpoints"?"checkpoint":typeof n=="object"&&n!=null&&"result"in n?"task_result":"task";this.stream.push([this.checkpointNamespace,"debug",{step:s,type:a,timestamp:i,payload:n}])}}_putCheckpoint(e){var i;const r=this.checkpointMetadata===e,n=this.checkpointer!=null&&(this.durability!=="exit"||r),s=a=>{var l,u,d;this.prevCheckpointConfig=(u=(l=this.checkpointConfig)==null?void 0:l.configurable)!=null&&u.checkpoint_id?this.checkpointConfig:void 0,this.checkpointConfig=yn(this.checkpointConfig,{[Un]:((d=this.config.configurable)==null?void 0:d.checkpoint_ns)??""});const o={...this.checkpoint.channel_versions},c=$l(this.checkpointPreviousVersions,o);this.checkpointPreviousVersions=o,this._checkpointerPutAfterPrevious({config:{...this.checkpointConfig},checkpoint:yu(a),metadata:{...this.checkpointMetadata},newVersions:c}),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_id:this.checkpoint.id}}};r||(this.checkpointMetadata={...e,step:this.step,parents:((i=this.config.configurable)==null?void 0:i[Xr])??{}}),this.checkpoint=di(this.checkpoint,n?this.channels:void 0,this.step,r?{id:this.checkpoint.id}:void 0),n&&s(this.checkpoint),r||(this.step+=1)}_flushPendingWrites(){var n;if(this.checkpointer==null||this.checkpointPendingWrites.length===0)return;const e=yn(this.checkpointConfig,{[Un]:((n=this.config.configurable)==null?void 0:n.checkpoint_ns)??"",[Zp]:this.checkpoint.id}),r={};for(const[s,i,a]of this.checkpointPendingWrites)r[s]??(r[s]=[]),r[s].push([i,a]);for(const[s,i]of Object.entries(r))this.checkpointerPromises.push(this.checkpointer.putWrites(e,i,s))}_matchWrites(e){for(const[r,n,s]of this.checkpointPendingWrites){if(n===xr||n===He||n===Cr)continue;const i=Object.values(e).find(a=>a.id===r);i&&i.writes.push([n,s])}for(const r of Object.values(e))r.writes.length>0&&this._outputWrites(r.id,r.writes,!0)}};function BU(t){return St(t==null?void 0:t.message)}var jU=class extends La{constructor(e){super();p(this,"name","StreamMessagesHandler");p(this,"streamFn");p(this,"metadatas",{});p(this,"seen",{});p(this,"emittedChatModelRunIds",{});p(this,"stableMessageIdMap",{});p(this,"lc_prefer_streaming",!0);this.streamFn=e}_emit(e,r,n,s=!1){var a;if(s&&r.id!==void 0&&this.seen[r.id]!==void 0)return;let i=r.id;n!=null&&(Hm(r)?i??(i=`run-${n}-tool-${r.tool_call_id}`):((i==null||i===`run-${n}`)&&(i=this.stableMessageIdMap[n]??i??`run-${n}`),(a=this.stableMessageIdMap)[n]??(a[n]=i))),i!==r.id&&(r.id=i,r.lc_kwargs.id=i),r.id!=null&&(this.seen[r.id]=r),this.streamFn([e[0],"messages",[r,e[1]]])}handleChatModelStart(e,r,n,s,i,a,o,c){o&&(!a||!a.includes(U4)&&!a.includes("nostream"))&&(this.metadatas[n]=[o.langgraph_checkpoint_ns.split("|"),{tags:a,name:c,...o}])}handleLLMNewToken(e,r,n,s,i,a){const o=a==null?void 0:a.chunk;this.emittedChatModelRunIds[n]=!0,this.metadatas[n]!==void 0&&(BU(o)?this._emit(this.metadatas[n],o.message,n):this._emit(this.metadatas[n],new At({content:e}),n))}handleLLMEnd(e,r){var n,s;if(this.metadatas[r]!==void 0){if(!this.emittedChatModelRunIds[r]){const i=(s=(n=e.generations)==null?void 0:n[0])==null?void 0:s[0];St(i==null?void 0:i.message)&&this._emit(this.metadatas[r],i==null?void 0:i.message,r,!0),delete this.emittedChatModelRunIds[r]}delete this.metadatas[r],delete this.stableMessageIdMap[r]}}handleLLMError(e,r){delete this.metadatas[r]}handleChainStart(e,r,n,s,i,a,o,c){if(a!==void 0&&c===a.langgraph_node&&(i===void 0||!i.includes(Tt))&&(this.metadatas[n]=[a.langgraph_checkpoint_ns.split("|"),{tags:i,name:c,...a}],typeof r=="object")){for(const l of Object.values(r))if((St(l)||$o(l))&&l.id!==void 0)this.seen[l.id]=l;else if(Array.isArray(l))for(const u of l)(St(u)||$o(u))&&u.id!==void 0&&(this.seen[u.id]=u)}}handleChainEnd(e,r){const n=this.metadatas[r];if(delete this.metadatas[r],n!==void 0){if(St(e))this._emit(n,e,r,!0);else if(Array.isArray(e))for(const s of e)St(s)&&this._emit(n,s,r,!0);else if(e!=null&&typeof e=="object"){for(const s of Object.values(e))if(St(s))this._emit(n,s,r,!0);else if(Array.isArray(s))for(const i of s)St(i)&&this._emit(n,i,r,!0)}}}handleChainError(e,r){delete this.metadatas[r]}};const FU=500,zU=2,VU=128e3,qU=3,HU=[400,401,402,403,404,405,406,407,409],GU=t=>{var r,n;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||t.name==="GraphValueError"||(t==null?void 0:t.code)==="ECONNABORTED")return!1;const e=((r=t==null?void 0:t.response)==null?void 0:r.status)??(t==null?void 0:t.status);return!(e&&HU.includes(+e)||((n=t==null?void 0:t.error)==null?void 0:n.code)==="insufficient_quota")};async function dA(t,e,r,n){var u;const s=t.retry_policy??e;let i=s!==void 0?s.initialInterval??FU:0,a=0,o,c,{config:l}=t;for(r&&(l=yn(l,r)),l={...l,signal:n};!(n!=null&&n.aborted);){t.writes.splice(0,t.writes.length),o=void 0;try{c=await t.proc.invoke(t.input,l);break}catch(d){if(o=d,o.pregelTaskId=t.id,VI(o)){const g=(u=l==null?void 0:l.configurable)==null?void 0:u.checkpoint_ns,y=o.command;if(y.graph===g){for(const b of t.writers)await b.invoke(y,l);o=void 0;break}else if(y.graph===rt.PARENT){const b=H4(g);o.command=new rt({...o.command,graph:b})}}if(ml(o)||s===void 0||(a+=1,a>=(s.maxAttempts??qU))||!(s.retryOn??GU)(o))break;i=Math.min(s.maxInterval??VU,i*(s.backoffFactor??zU));const f=s.jitter?Math.floor(i+Math.random()*1e3):i;await new Promise(g=>setTimeout(g,f));const m=o.name??o.constructor.unminifiable_name??o.constructor.name;((s==null?void 0:s.logWarning)??!0)&&console.log(`Retrying task "${String(t.name)}" after ${i.toFixed(2)}ms (attempt ${a}) after ${m}: ${o}`),l=yn(l,{[$s]:!0})}}return{task:t,result:c,error:o,signalAborted:n==null?void 0:n.aborted}}const tm=Symbol.for("promiseAdded");function WU(){const t={next:()=>{},wait:Promise.resolve(tm)};function e(r){t.next=()=>{t.wait=new Promise(e),r(tm)}}return t.wait=new Promise(e),t}var JU=class{constructor({loop:t,nodeFinished:e}){p(this,"nodeFinished");p(this,"loop");this.loop=t,this.nodeFinished=e}async tick(t={}){const{timeout:e,retryPolicy:r,onStepWrite:n,maxConcurrency:s}=t,i=new Set;let a;const o=new AbortController,c=o.signal,l=e?AbortSignal.timeout(e):void 0,u=Object.values(this.loop.tasks).filter(m=>m.writes.length===0),{signals:d,disposeCombinedSignal:h}=this._initializeAbortSignals({exceptionSignal:c,stepTimeoutSignal:l,signal:t.signal}),f=this._executeTasksWithRetry(u,{signals:d,retryPolicy:r,maxConcurrency:s});for await(const{task:m,error:g,signalAborted:y}of f)this._commit(m,g),fi(g)||ml(g)&&!fi(a)?a=g:g&&(i.size===0||!y)&&(o.abort(),i.add(g));if(h==null||h(),n==null||n(this.loop.step,Object.values(this.loop.tasks).map(m=>m.writes).flat()),i.size===1)throw Array.from(i)[0];if(i.size>1)throw new AggregateError(Array.from(i),`Multiple errors occurred during superstep ${this.loop.step}. See the "errors" field of this exception for more details.`);if(fi(a)||ml(a)&&this.loop.isNested)throw a}_initializeAbortSignals({exceptionSignal:t,stepTimeoutSignal:e,signal:r}){var l;const n=((l=this.loop.config.configurable)==null?void 0:l[Ab])??{},s=n.externalAbortSignal??r,i=e??n.timeoutAbortSignal,{signal:a,dispose:o}=Su(s,i,t),c={externalAbortSignal:s,timeoutAbortSignal:i,composedAbortSignal:a};return this.loop.config=yn(this.loop.config,{[Ab]:c}),{signals:c,disposeCombinedSignal:o}}async*_executeTasksWithRetry(t,e){var h,f,m;const{retryPolicy:r,maxConcurrency:n,signals:s}=e??{},i=WU(),a={},o={executingTasksMap:a,barrier:i,retryPolicy:r,scheduleTask:async(g,y,b)=>this.loop.acceptPush(g,y,b)};if((h=s==null?void 0:s.composedAbortSignal)!=null&&h.aborted)throw new Error("Abort");let c=0,l;const u=Su(s==null?void 0:s.externalAbortSignal,s==null?void 0:s.timeoutAbortSignal),d=u.signal?new Promise((g,y)=>{var b;l=()=>y(new Error("Abort")),(b=u.signal)==null||b.addEventListener("abort",l,{once:!0})}):void 0;for(;(c===0||Object.keys(a).length>0)&&t.length;){for(;Object.values(a).length<(n??t.length)&&c<t.length;c+=1){const y=t[c];a[y.id]=dA(y,r,{[Wg]:Pl==null?void 0:Pl.bind(o,this,y)},s==null?void 0:s.composedAbortSignal).catch(b=>{var _;return{task:y,error:b,signalAborted:(_=s==null?void 0:s.composedAbortSignal)==null?void 0:_.aborted}})}const g=await Promise.race([...Object.values(a),...d?[d]:[],i.wait]);g!==tm&&(yield g,l!=null&&((f=u.signal)==null||f.removeEventListener("abort",l),(m=u.dispose)==null||m.call(u)),delete a[g.task.id])}}_commit(t,e){var r;if(e!==void 0)if(fi(e)){if(e.interrupts.length){const n=e.interrupts.map(i=>[He,i]),s=t.writes.filter(i=>i[0]===Cr);s.length&&n.push(...s),this.loop.putWrites(t.id,n)}}else ml(e)&&t.writes.length?this.loop.putWrites(t.id,t.writes):this.loop.putWrites(t.id,[[xr,{message:e.message,name:e.name}]]);else this.nodeFinished&&(((r=t.config)==null?void 0:r.tags)==null||!t.config.tags.includes(Tt))&&this.nodeFinished(String(t.name)),t.writes.length===0&&t.writes.push([Jg,null]),this.loop.putWrites(t.id,t.writes)}};async function Pl(t,e,r,n,s,i={}){var d,h;const a=(h=(d=e.config)==null?void 0:d.configurable)==null?void 0:h[Vs];if(!a)throw new Error(`BUG: No scratchpad found on task ${e.name}__${e.id}`);const o=a.callCounter;a.callCounter+=1;const c=new _U({func:r,name:n,input:s,cache:i.cache,retry:i.retry,callbacks:i.callbacks}),l=await this.scheduleTask(e,o,c);if(!l)return;const u=this.executingTasksMap[l.id];if(u!==void 0)return u;if(l.writes.length>0){const f=l.writes.filter(([g])=>g===ka),m=l.writes.filter(([g])=>g===xr);if(f.length>0){if(f.length===1)return Promise.resolve(f[0][1]);throw new Error(`BUG: multiple returns found for task ${l.name}__${l.id}`)}if(m.length>0){if(m.length===1){const g=m[0][1],y=g instanceof Error?g:new Error(String(g));return Promise.reject(y)}throw new Error(`BUG: multiple errors found for task ${l.name}__${l.id}`)}return}else{const f=dA(l,i.retry,{[Wg]:Pl.bind(this,t,l)});return this.executingTasksMap[l.id]=f,this.barrier.next(),f.then(({result:m,error:g})=>g?Promise.reject(g):m)}}var Qn=class extends Error{constructor(t){super(t),this.name="GraphValidationError"}};function ZU({nodes:t,channels:e,inputChannels:r,outputChannels:n,streamChannels:s,interruptAfterNodes:i,interruptBeforeNodes:a}){if(!e)throw new Qn("Channels not provided");const o=new Set,c=new Set;for(const[l,u]of Object.entries(t)){if(l===He)throw new Qn(`"Node name ${He} is reserved"`);if(u.constructor===Zo)u.triggers.forEach(d=>o.add(d));else throw new Qn(`Invalid node type ${typeof u}, expected PregelNode`)}for(const l of o)if(!(l in e))throw new Qn(`Subscribed channel '${String(l)}' not in channels`);if(Array.isArray(r)){if(r.every(l=>!o.has(l)))throw new Qn(`None of the input channels ${r} are subscribed to by any node`)}else if(!o.has(r))throw new Qn(`Input channel ${String(r)} is not subscribed to by any node`);Array.isArray(n)?n.forEach(l=>c.add(l)):c.add(n),s&&!Array.isArray(s)?c.add(s):Array.isArray(s)&&s.forEach(l=>c.add(l));for(const l of c)if(!(l in e))throw new Qn(`Output channel '${String(l)}' not in channels`);if(i&&i!=="*"){for(const l of i)if(!(l in t))throw new Qn(`Node ${String(l)} not in nodes`)}if(a&&a!=="*"){for(const l of a)if(!(l in t))throw new Qn(`Node ${String(l)} not in nodes`)}}function Mb(t,e){if(Array.isArray(t)){for(const r of t)if(!(r in e))throw new Error(`Key ${String(r)} not found in channels`)}else if(!(t in e))throw new Error(`Key ${String(t)} not found in channels`)}var KU=class hA extends ji{constructor(r){super();p(this,"lc_graph_name","Topic");p(this,"unique",!1);p(this,"accumulate",!1);p(this,"seen");p(this,"values");this.unique=(r==null?void 0:r.unique)??this.unique,this.accumulate=(r==null?void 0:r.accumulate)??this.accumulate,this.seen=new Set,this.values=[]}fromCheckpoint(r){const n=new hA({unique:this.unique,accumulate:this.accumulate});return typeof r<"u"&&(n.seen=new Set(r[0]),n.values=r[1]),n}update(r){let n=!1;this.accumulate||(n=this.values.length>0,this.values=[]);const s=r.flat();if(s.length>0)if(this.unique)for(const i of s)this.seen.has(i)||(n=!0,this.seen.add(i),this.values.push(i));else n=!0,this.values.push(...s);return n}get(){if(this.values.length===0)throw new Qt;return this.values}checkpoint(){return[[...this.seen],this.values]}isAvailable(){return this.values.length!==0}};function XU(t){var c,l,u;const e=Bt.getRunnableConfig();if(!e)throw new Error("Called interrupt() outside the context of a graph.");const r=e.configurable;if(!r)throw new Error("No configurable found in config");if(!r[vt])throw new pl("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=r[Vs];s.interruptCounter+=1;const i=s.interruptCounter;if(s.resume.length>0&&i<s.resume.length)return(c=r[zs])==null||c.call(r,[[Cr,s.resume]]),s.resume[i];if(s.nullResume!==void 0){if(s.resume.length!==i)throw new Error(`Resume length mismatch: ${s.resume.length} !== ${i}`);const d=s.consumeNullResume();return s.resume.push(d),(l=r[zs])==null||l.call(r,[[Cr,s.resume]]),d}const a=(u=r[Un])==null?void 0:u.split(Pt),o=a?oi(a.join(Pt)):void 0;throw new pa([{id:o,value:t}])}var YU=class{static subscribeTo(t,e){const{key:r,tags:n}={key:void 0,tags:void 0,...e??{}};if(Array.isArray(t)&&r!==void 0)throw new Error("Can't specify a key when subscribing to multiple channels");let s;typeof t=="string"?r?s={[r]:t}:s=[t]:s=Object.fromEntries(t.map(a=>[a,a]));const i=Array.isArray(t)?t:[t];return new Zo({channels:s,triggers:i,tags:n})}static writeTo(t,e){const r=[];for(const n of t)r.push({channel:n,value:Si,skipNone:!1});for(const[n,s]of Object.entries(e??{}))Fe.isRunnable(s)||typeof s=="function"?r.push({channel:n,value:Si,skipNone:!0,mapper:Yt(s)}):r.push({channel:n,value:s,skipNone:!1});return new hr(r)}},QU=class extends Fe{constructor(){super(...arguments);p(this,"lc_namespace",["langgraph","pregel"])}invoke(e,r){throw new Error("Not implemented")}withConfig(e){return super.withConfig(e)}stream(e,r){return super.stream(e,r)}},eB=class extends QU{constructor(e){super(e);p(this,"lc_namespace",["langgraph","pregel"]);p(this,"lg_is_pregel",!0);p(this,"nodes");p(this,"channels");p(this,"inputChannels");p(this,"outputChannels");p(this,"autoValidate",!0);p(this,"streamMode",["values"]);p(this,"streamChannels");p(this,"interruptAfter");p(this,"interruptBefore");p(this,"stepTimeout");p(this,"debug",!1);p(this,"checkpointer");p(this,"retryPolicy");p(this,"config");p(this,"store");p(this,"cache");p(this,"userInterrupt");p(this,"triggerToNodes",{});let{streamMode:r}=e;if(r!=null&&!Array.isArray(r)&&(r=[r]),this.nodes=e.nodes,this.channels=e.channels,Yr in this.channels&&"lc_graph_name"in this.channels[Yr]&&this.channels[Yr].lc_graph_name!=="Topic")throw new Error(`Channel '${Yr}' is reserved and cannot be used in the graph.`);this.channels[Yr]=new KU({accumulate:!1}),this.autoValidate=e.autoValidate??this.autoValidate,this.streamMode=r??this.streamMode,this.inputChannels=e.inputChannels,this.outputChannels=e.outputChannels,this.streamChannels=e.streamChannels??this.streamChannels,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.stepTimeout=e.stepTimeout??this.stepTimeout,this.debug=e.debug??this.debug,this.checkpointer=e.checkpointer,this.retryPolicy=e.retryPolicy,this.config=e.config,this.store=e.store,this.cache=e.cache,this.name=e.name,this.triggerToNodes=e.triggerToNodes??this.triggerToNodes,this.userInterrupt=e.userInterrupt,this.autoValidate&&this.validate()}static lc_name(){return"LangGraph"}withConfig(e){const r=en(this.config,e);return new this.constructor({...this,config:r})}validate(){var e;ZU({nodes:this.nodes,channels:this.channels,outputChannels:this.outputChannels,inputChannels:this.inputChannels,streamChannels:this.streamChannels,interruptAfterNodes:this.interruptAfter,interruptBeforeNodes:this.interruptBefore});for(const[r,n]of Object.entries(this.nodes))for(const s of n.triggers)(e=this.triggerToNodes)[s]??(e[s]=[]),this.triggerToNodes[s].push(r);return this}get streamChannelsList(){return Array.isArray(this.streamChannels)?this.streamChannels:this.streamChannels?[this.streamChannels]:Object.keys(this.channels)}get streamChannelsAsIs(){return this.streamChannels?this.streamChannels:Object.keys(this.channels)}async getGraphAsync(e){return this.getGraph(e)}*getSubgraphs(e,r){var n;for(const[s,i]of Object.entries(this.nodes)){if(e!==void 0&&!e.startsWith(s))continue;const a=(n=i.subgraphs)!=null&&n.length?i.subgraphs:[i.bound];for(const o of a){const c=XT(o);if(c!==void 0){if(s===e){yield[s,c];return}if(e===void 0&&(yield[s,c]),r){let l=e;e!==void 0&&(l=e.slice(s.length+1));for(const[u,d]of c.getSubgraphs(l,r))yield[`${s}${Pt}${u}`,d]}}}}}async*getSubgraphsAsync(e,r){yield*this.getSubgraphs(e,r)}async _prepareStateSnapshot({config:e,saved:r,subgraphCheckpointer:n,applyPendingWrites:s=!1}){var h,f,m,g,y,b,_,E;if(r===void 0)return{values:{},next:[],config:e,tasks:[]};const i=_u(this.channels,r.checkpoint);if((h=r.pendingWrites)!=null&&h.length){const C=r.pendingWrites.filter(([k,R])=>k===Qr).map(([k,R,$])=>[String(R),$]);C.length>0&&Br(r.checkpoint,i,[{name:as,writes:C,triggers:[]}],void 0,this.triggerToNodes)}const a=Object.values(da(r.checkpoint,r.pendingWrites,this.nodes,i,r.config,!0,{step:(((f=r.metadata)==null?void 0:f.step)??-1)+1,store:this.store})),o=await Ps(this.getSubgraphsAsync()),c=((m=r.config.configurable)==null?void 0:m.checkpoint_ns)??"",l={};for(const C of a){const k=o.find(([$])=>$===C.name);if(!k)continue;let R=`${String(C.name)}${fs}${C.id}`;if(c&&(R=`${c}${Pt}${R}`),n===void 0){const $={configurable:{thread_id:(g=r.config.configurable)==null?void 0:g.thread_id,checkpoint_ns:R}};l[C.id]=$}else{const $={configurable:{[vt]:n,thread_id:(y=r.config.configurable)==null?void 0:y.thread_id,checkpoint_ns:R}},S=k[1];l[C.id]=await S.getState($,{subgraphs:!0})}}if(s&&((b=r.pendingWrites)!=null&&b.length)){const C=Object.fromEntries(a.map(R=>[R.id,R]));for(const[R,$,S]of r.pendingWrites)[xr,He,gl].includes($)||R in C&&C[R].writes.push([String($),S]);const k=a.filter(R=>R.writes.length>0);k.length>0&&Br(r.checkpoint,i,k,void 0,this.triggerToNodes)}let u=r==null?void 0:r.metadata;u&&((E=(_=r==null?void 0:r.config)==null?void 0:_.configurable)!=null&&E.thread_id)&&(u={...u,thread_id:r.config.configurable.thread_id});const d=a.filter(C=>C.writes.length===0).map(C=>C.name);return{values:Ni(i,this.streamChannelsAsIs),next:d,tasks:oA(a,(r==null?void 0:r.pendingWrites)??[],l,this.streamChannelsAsIs),metadata:u,config:ti(r.config,r.metadata),createdAt:r.checkpoint.ts,parentConfig:r.parentConfig}}async getState(e,r){var c,l,u,d;const n=((c=e.configurable)==null?void 0:c[vt])??this.checkpointer;if(!n)throw new pl("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=((l=e.configurable)==null?void 0:l.checkpoint_ns)??"";if(s!==""&&((u=e.configurable)==null?void 0:u[vt])===void 0){const h=bf(s);for await(const[f,m]of this.getSubgraphsAsync(h,!0))if(f===h)return await m.getState(Gi(e,{[vt]:n}),{subgraphs:r==null?void 0:r.subgraphs});throw new Error(`Subgraph with namespace "${h}" not found.`)}const i=en(this.config,e),a=await n.getTuple(e);return await this._prepareStateSnapshot({config:i,saved:a,subgraphCheckpointer:r!=null&&r.subgraphs?n:void 0,applyPendingWrites:!((d=e.configurable)!=null&&d.checkpoint_id)})}async*getStateHistory(e,r){var a,o,c;const n=((a=e.configurable)==null?void 0:a[vt])??this.checkpointer;if(!n)throw new pl("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=((o=e.configurable)==null?void 0:o.checkpoint_ns)??"";if(s!==""&&((c=e.configurable)==null?void 0:c[vt])===void 0){const l=bf(s);for await(const[u,d]of this.getSubgraphsAsync(l,!0))if(u===l){yield*d.getStateHistory(Gi(e,{[vt]:n}),r);return}throw new Error(`Subgraph with namespace "${l}" not found.`)}const i=en(this.config,e,{configurable:{checkpoint_ns:s}});for await(const l of n.list(i,r))yield this._prepareStateSnapshot({config:l.config,saved:l})}async bulkUpdateState(e,r){var o,c,l;const n=((o=e.configurable)==null?void 0:o[vt])??this.checkpointer;if(!n)throw new pl("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});if(r.length===0)throw new Error("No supersteps provided");if(r.some(u=>u.updates.length===0))throw new Error("No updates provided");const s=((c=e.configurable)==null?void 0:c.checkpoint_ns)??"";if(s!==""&&((l=e.configurable)==null?void 0:l[vt])===void 0){const u=bf(s);for await(const[,d]of this.getSubgraphsAsync(u,!0))return await d.bulkUpdateState(Gi(e,{[vt]:n}),r);throw new Error(`Subgraph "${u}" not found`)}const i=async(u,d)=>{var q,se,pe,j,z,G,ie,ce,te,le,Ee;const h=this.config?en(this.config,u):u,f=await n.getTuple(h),m=f!==void 0?yu(f.checkpoint):FT(),g={...f==null?void 0:f.checkpoint.channel_versions},y=((q=f==null?void 0:f.metadata)==null?void 0:q.step)??-1;let b=Gi(h,{checkpoint_ns:((se=h.configurable)==null?void 0:se.checkpoint_ns)??""}),_=h.metadata??{};f!=null&&f.config.configurable&&(b=Gi(h,f.config.configurable),_={...f.metadata,..._});const{values:E,asNode:C}=d[0];if(E==null&&C===void 0){if(d.length>1)throw new lt("Cannot create empty checkpoint with multiple updates");const W=await n.put(b,di(m,void 0,y),{source:"update",step:y+1,parents:((pe=f==null?void 0:f.metadata)==null?void 0:pe.parents)??{}},{});return ti(W,f?f.metadata:void 0)}const k=_u(this.channels,m);if(E===null&&C===ze){if(d.length>1)throw new lt("Cannot apply multiple updates when clearing state");if(f){const X=da(m,f.pendingWrites||[],this.nodes,k,f.config,!0,{step:(((j=f.metadata)==null?void 0:j.step)??-1)+1,checkpointer:n,store:this.store}),ae=(f.pendingWrites||[]).filter(V=>V[0]===Qr).map(V=>V.slice(1));ae.length>0&&Br(m,k,[{name:as,writes:ae,triggers:[]}],n.getNextVersion.bind(n),this.triggerToNodes);for(const[V,A,x]of f.pendingWrites||[])[xr,He,gl].includes(A)||V in X&&X[V].writes.push([A,x]);Br(m,k,Object.values(X),n.getNextVersion.bind(n),this.triggerToNodes)}const W=await n.put(b,di(m,k,y),{..._,source:"update",step:y+1,parents:((z=f==null?void 0:f.metadata)==null?void 0:z.parents)??{}},$l(g,m.channel_versions));return ti(W,f?f.metadata:void 0)}if(C===L4){if(d.length>1)throw new lt("Cannot copy checkpoint with multiple updates");if(f==null)throw new lt("Cannot copy a non-existent checkpoint");const W=V=>!Array.isArray(V)||V.length===0?!1:V.every(A=>Array.isArray(A)&&A.length===2),X=di(m,void 0,y),ae=await n.put(f.parentConfig??Gi(f.config,{checkpoint_id:void 0}),X,{source:"fork",step:y+1,parents:((G=f.metadata)==null?void 0:G.parents)??{}},{});if(W(E)){const V=da(X,f.pendingWrites,this.nodes,k,ae,!1,{step:y+2}),A=Object.values(V).reduce((D,{name:N,id:ke})=>(D[N]??(D[N]=[]),D[N].push({id:ke}),D),{}),x=E.reduce((D,N)=>{var ft,zt;const[ke,$e]=N;D[$e]??(D[$e]=[]);const Je=D[$e].length,at=(zt=(ft=A[$e])==null?void 0:ft[Je])==null?void 0:zt.id;return D[$e].push({values:ke,asNode:$e,taskId:at}),D},{});return i(ti(ae,f.metadata),Object.values(x).flat())}return ti(ae,f.metadata)}if(C===as){if(d.length>1)throw new lt("Cannot apply multiple updates when updating as input");const W=await Ps(iA(this.inputChannels,E));if(W.length===0)throw new lt(`Received no input writes for ${JSON.stringify(this.inputChannels,null,2)}`);Br(m,k,[{name:as,writes:W,triggers:[]}],n.getNextVersion.bind(this.checkpointer),this.triggerToNodes);const X=((ie=f==null?void 0:f.metadata)==null?void 0:ie.step)!=null?f.metadata.step+1:-1,ae=await n.put(b,di(m,k,X),{source:"input",step:X,parents:((ce=f==null?void 0:f.metadata)==null?void 0:ce.parents)??{}},$l(g,m.channel_versions));return await n.putWrites(ae,W,ia(as,m.id)),ti(ae,f?f.metadata:void 0)}if(((te=h.configurable)==null?void 0:te.checkpoint_id)===void 0&&(f==null?void 0:f.pendingWrites)!==void 0&&f.pendingWrites.length>0){const W=da(m,f.pendingWrites,this.nodes,k,f.config,!0,{store:this.store,checkpointer:this.checkpointer,step:(((le=f.metadata)==null?void 0:le.step)??-1)+1}),X=(f.pendingWrites??[]).filter(V=>V[0]===Qr).map(V=>V.slice(1));X.length>0&&Br(f.checkpoint,k,[{name:as,writes:X,triggers:[]}],void 0,this.triggerToNodes);for(const[V,A,x]of f.pendingWrites)[xr,He,gl].includes(A)||W[V]===void 0||W[V].writes.push([A,x]);const ae=Object.values(W).filter(V=>V.writes.length>0);ae.length>0&&Br(m,k,ae,void 0,this.triggerToNodes)}const R=Object.values(m.versions_seen).map(W=>Object.values(W)).flat().find(W=>!!W),$=[];if(d.length===1){let{values:W,asNode:X,taskId:ae}=d[0];if(X===void 0&&Object.keys(this.nodes).length===1)[X]=Object.keys(this.nodes);else if(X===void 0&&R===void 0)typeof this.inputChannels=="string"&&this.nodes[this.inputChannels]!==void 0&&(X=this.inputChannels);else if(X===void 0){const V=Object.entries(m.versions_seen).map(([A,x])=>Object.values(x).map(D=>[D,A])).flat().filter(([A,x])=>x!==He).sort(([A],[x])=>zT(A,x));V&&(V.length===1?X=V[0][1]:V[V.length-1][0]!==V[V.length-2][0]&&(X=V[V.length-1][1]))}if(X===void 0)throw new lt('Ambiguous update, specify "asNode"');$.push({values:W,asNode:X,taskId:ae})}else for(const{asNode:W,values:X,taskId:ae}of d){if(W==null)throw new lt('"asNode" is required when applying multiple updates');$.push({values:X,asNode:W,taskId:ae})}const S=[];for(const{asNode:W,values:X,taskId:ae}of $){if(this.nodes[W]===void 0)throw new lt(`Node "${W.toString()}" does not exist`);const V=this.nodes[W].getWriters();if(!V.length)throw new lt(`No writers found for node "${W.toString()}"`);S.push({name:W,input:X,proc:V.length>1?Zn.from(V,{omitSequenceTags:!0}):V[0],writes:[],triggers:[He],id:ae??ia(He,m.id),writers:[]})}for(const W of S)await W.proc.invoke(W.input,Ze({...h,store:(h==null?void 0:h.store)??this.store},{runName:h.runName??`${this.getName()}UpdateState`,configurable:{[zs]:X=>W.writes.push(...X),[Ei]:(X,ae=!1)=>Nl(m,k,W,X,ae)}}));for(const W of S){const X=W.writes.filter(ae=>ae[0]!==jr);f!==void 0&&X.length>0&&await n.putWrites(b,X,W.id)}Br(m,k,S,n.getNextVersion.bind(this.checkpointer),this.triggerToNodes);const M=$l(g,m.channel_versions),B=await n.put(b,di(m,k,y+1),{source:"update",step:y+1,parents:((Ee=f==null?void 0:f.metadata)==null?void 0:Ee.parents)??{}},M);for(const W of S){const X=W.writes.filter(ae=>ae[0]===jr);X.length>0&&await n.putWrites(B,X,W.id)}return ti(B,f?f.metadata:void 0)};let a=e;for(const{updates:u}of r)a=await i(a,u);return a}async updateState(e,r,n){return this.bulkUpdateState(e,[{updates:[{values:r,asNode:n}]}])}_defaults(e){var k,R,$;const{debug:r,streamMode:n,inputKeys:s,outputKeys:i,interruptAfter:a,interruptBefore:o,...c}=e;let l=!0;const u=r!==void 0?r:this.debug;let d=i;d===void 0?d=this.streamChannelsAsIs:Mb(d,this.channels);let h=s;h===void 0?h=this.inputChannels:Mb(h,this.channels);const f=o??this.interruptBefore??[],m=a??this.interruptAfter??[];let g;n!==void 0?(g=Array.isArray(n)?n:[n],l=typeof n=="string"):(((k=e.configurable)==null?void 0:k[Eo])!==void 0?g=["values"]:g=this.streamMode,l=!0);let y;if(this.checkpointer===!1)y=void 0;else if(e!==void 0&&((R=e.configurable)==null?void 0:R[vt])!==void 0)y=e.configurable[vt];else{if(this.checkpointer===!0)throw new Error("checkpointer: true cannot be used for root graphs.");y=this.checkpointer}const b=e.store??this.store,_=e.cache??this.cache;if(e.durability!=null&&e.checkpointDuring!=null)throw new Error("Cannot use both `durability` and `checkpointDuring` at the same time.");const E=(()=>{if(e.checkpointDuring!=null)return e.checkpointDuring===!1?"exit":"async"})(),C=e.durability??E??(($=e==null?void 0:e.configurable)==null?void 0:$[WT])??"async";return[u,g,h,d,c,f,m,y,b,l,_,C]}async stream(e,r){var a;const n=new AbortController,s={recursionLimit:(a=this.config)==null?void 0:a.recursionLimit,...r,signal:Su(r==null?void 0:r.signal,n.signal).signal},i=await super.stream(e,s);return new Nb((r==null?void 0:r.encoding)==="text/event-stream"?PU(i):i,n)}streamEvents(e,r,n){var a,o;const s=new AbortController,i={recursionLimit:(a=this.config)==null?void 0:a.recursionLimit,...r,callbacks:yU((o=this.config)==null?void 0:o.callbacks,r==null?void 0:r.callbacks),signal:Su(r==null?void 0:r.signal,s.signal).signal};return new Nb(super.streamEvents(e,i,n),s)}async _validateInput(e){return e}async _validateContext(e){return e}async*_streamIterator(e,r){const n="version"in(r??{})?void 0:(r==null?void 0:r.encoding)??void 0,s=r==null?void 0:r.subgraphs,i=ZT(this.config,r);if(i.recursionLimit===void 0||i.recursionLimit<1)throw new Error('Passed "recursionLimit" must be at least 1.');if(this.checkpointer!==void 0&&this.checkpointer!==!1&&i.configurable===void 0)throw new Error('Checkpointer requires one or more of the following "configurable" keys: "thread_id", "checkpoint_ns", "checkpoint_id"');const a=await this._validateInput(e),{runId:o,...c}=i,[l,u,,d,h,f,m,g,y,b,_,E]=this._defaults(c);typeof h.context<"u"?h.context=await this._validateContext(h.context):h.configurable=await this._validateContext(h.configurable);const C=new lA({modes:new Set(u)});if(this.checkpointer===!0){h.configurable??(h.configurable={});const se=h.configurable[Un]??"";h.configurable[Un]=se.split(Pt).map(pe=>pe.split(fs)[0]).join(Pt)}if(u.includes("messages")){const se=new jU(j=>C.push(j)),{callbacks:pe}=h;if(pe===void 0)h.callbacks=[se];else if(Array.isArray(pe))h.callbacks=pe.concat(se);else{const j=pe.copy();j.addHandler(se,!0),h.callbacks=j}}h.writer??(h.writer=se=>{var j,z,G;if(!u.includes("custom"))return;const pe=(G=(z=(j=q4())==null?void 0:j.configurable)==null?void 0:z[Un])==null?void 0:G.split(Pt).slice(0,-1);C.push([pe??[],"custom",se])}),h.interrupt??(h.interrupt=this.userInterrupt??XU);const k=await Ar(h),R=await(k==null?void 0:k.handleChainStart(this.toJSON(),gU(e,"input"),o,void 0,void 0,void 0,(h==null?void 0:h.runName)??this.getName())),$=Hg(this.channels);let S,M;const q=(async()=>{var se,pe,j;try{S=await UU.initialize({input:a,config:h,checkpointer:g,nodes:this.nodes,channelSpecs:$,outputKeys:d,streamKeys:this.streamChannelsAsIs,store:y,cache:_,stream:C,interruptAfter:m,interruptBefore:f,manager:R,debug:this.debug,triggerToNodes:this.triggerToNodes,durability:E});const z=new JU({loop:S,nodeFinished:(se=h.configurable)==null?void 0:se[D4]});r!=null&&r.subgraphs&&(S.config.configurable={...S.config.configurable,[wu]:S.stream}),await this._runLoop({loop:S,runner:z,debug:l,config:h}),E==="sync"&&await Promise.all((S==null?void 0:S.checkpointerPromises)??[])}catch(z){M=z}finally{try{S&&(await((pe=S.store)==null?void 0:pe.stop()),await((j=S.cache)==null?void 0:j.stop())),await Promise.all((S==null?void 0:S.checkpointerPromises)??[])}catch(z){M=M??z}M?C.error(M):C.close()}})();try{for await(const se of C){if(se===void 0)throw new Error("Data structure error.");const[pe,j,z]=se;if(u.includes(j)){if(n==="text/event-stream"){s?yield[pe,j,z]:yield[null,j,z];continue}s&&!b?yield[pe,j,z]:b?s?yield[pe,z]:yield z:yield[j,z]}}}catch(se){throw await(R==null?void 0:R.handleChainError(M)),se}finally{await q}await(R==null?void 0:R.handleChainEnd((S==null?void 0:S.output)??{},o,void 0,void 0,void 0))}async invoke(e,r){const n=(r==null?void 0:r.streamMode)??"values",s={...r,outputKeys:(r==null?void 0:r.outputKeys)??this.outputChannels,streamMode:n,encoding:void 0},i=[],a=await this.stream(e,s),o=[];let c;for await(const l of a)n==="values"?JT(l)?o.push(l[He]):c=l:i.push(l);if(n==="values"){if(o.length>0){const l=o.flat(1);if(c==null)return{[He]:l};if(typeof c=="object")return{...c,[He]:l}}return c}return i}async _runLoop(e){const{loop:r,runner:n,debug:s,config:i}=e;let a;try{for(;await r.tick({inputKeys:this.inputChannels});){for(const{task:o}of await r._matchCachedWrites())r._outputWrites(o.id,o.writes,!0);s&&RU(r.checkpointMetadata.step,r.channels,this.streamChannelsList),s&&cA(r.step,Object.values(r.tasks)),await n.tick({timeout:this.stepTimeout,retryPolicy:this.retryPolicy,onStepWrite:(o,c)=>{s&&OU(o,c,this.streamChannelsList)},maxConcurrency:i.maxConcurrency,signal:i.signal})}if(r.status==="out_of_steps")throw new zI([`Recursion limit of ${i.recursionLimit} reached`,"without hitting a stop condition. You can increase the",'limit by setting the "recursionLimit" config key.'].join(" "),{lc_error_code:"GRAPH_RECURSION_LIMIT"})}catch(o){if(a=o,!await r.finishAndHandleError(a))throw o}finally{a===void 0&&await r.finishAndHandleError()}}async clearCache(){var e;await((e=this.cache)==null?void 0:e.clear([]))}},Ra=class fA extends ji{constructor(r=!0){super();p(this,"lc_graph_name","EphemeralValue");p(this,"guard");p(this,"value",[]);this.guard=r}fromCheckpoint(r){const n=new fA(this.guard);return typeof r<"u"&&(n.value=[r]),n}update(r){if(r.length===0){const n=this.value.length>0;return this.value=[],n}if(r.length!==1&&this.guard)throw new lt("EphemeralValue can only receive one value per step.");return this.value=[r[r.length-1]],!0}get(){if(this.value.length===0)throw new Qt;return this.value[0]}checkpoint(){if(this.value.length===0)throw new Qt;return this.value[0]}isAvailable(){return this.value.length!==0}};const tB=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Db(t){return typeof t=="string"&&tB.test(t)}var Wt=[];for(var kf=0;kf<256;++kf)Wt.push((kf+256).toString(16).slice(1));function rB(t,e=0){return(Wt[t[e+0]]+Wt[t[e+1]]+Wt[t[e+2]]+Wt[t[e+3]]+"-"+Wt[t[e+4]]+Wt[t[e+5]]+"-"+Wt[t[e+6]]+Wt[t[e+7]]+"-"+Wt[t[e+8]]+Wt[t[e+9]]+"-"+Wt[t[e+10]]+Wt[t[e+11]]+Wt[t[e+12]]+Wt[t[e+13]]+Wt[t[e+14]]+Wt[t[e+15]]).toLowerCase()}var Qc,nB=new Uint8Array(16);function sB(){if(!Qc&&(Qc=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Qc))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Qc(nB)}var iB=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Ub={randomUUID:iB};function Bb(t,e,r){if(Ub.randomUUID&&!t)return Ub.randomUUID();t=t||{};var n=t.random||(t.rng||sB)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,rB(n)}var pA=class{constructor(t){p(this,"path");p(this,"ends");Fe.isRunnable(t.path)?this.path=t.path:this.path=Yt(t.path).withConfig({runName:"Branch"}),this.ends=Array.isArray(t.pathMap)?t.pathMap.reduce((e,r)=>(e[r]=r,e),{}):t.pathMap}run(t,e){return hr.registerWriter(new ei({name:"<branch_run>",trace:!1,func:async(r,n)=>{try{return await this._route(r,n,t,e)}catch(s){throw s.name===Fv.unminifiable_name&&console.warn(`[WARN]: 'NodeInterrupt' thrown in conditional edge. This is likely a bug in your graph implementation.
NodeInterrupt should only be thrown inside a node, not in edge conditions.`),s}}}))}async _route(t,e,r,n){let s=await this.path.invoke(n?n(e):t,e);Array.isArray(s)||(s=[s]);let i;if(this.ends?i=s.map(o=>Rr(o)?o:this.ends[o]):i=s,i.some(o=>!o))throw new Error("Branch condition returned unknown or null destination");if(i.filter(Rr).some(o=>o.node===ze))throw new lt("Cannot send a packet to the END node");return await r(i,e)??t}},aB=class{constructor(){p(this,"nodes");p(this,"edges");p(this,"branches");p(this,"entryPoint");p(this,"compiled",!1);this.nodes={},this.edges=new Set,this.branches={}}warnIfCompiled(t){this.compiled&&console.warn(t)}get allEdges(){return this.edges}addNode(...t){function e(n){return n.length>=1&&typeof n[0]!="string"}const r=e(t)?Array.isArray(t[0])?t[0]:Object.entries(t[0]):[[t[0],t[1],t[2]]];if(r.length===0)throw new Error("No nodes provided in `addNode`");for(const[n,s,i]of r){for(const o of[Pt,fs])if(n.includes(o))throw new Error(`"${o}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),n in this.nodes)throw new Error(`Node \`${n}\` already present.`);if(n===ze)throw new Error(`Node \`${n}\` is reserved.`);const a=Yt(s);this.nodes[n]={runnable:a,metadata:i==null?void 0:i.metadata,subgraphs:Zg(a)?[a]:i==null?void 0:i.subgraphs,ends:i==null?void 0:i.ends}}return this}addEdge(t,e){if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),t===ze)throw new Error("END cannot be a start node");if(e===et)throw new Error("START cannot be an end node");if(Array.from(this.edges).some(([r])=>r===t)&&!("channels"in this))throw new Error(`Already found path for ${t}. For multiple edges, use StateGraph.`);return this.edges.add([t,e]),this}addConditionalEdges(t,e,r){var i,a;const n=typeof t=="object"?t:{source:t,path:e,pathMap:r};if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),!Fe.isRunnable(n.path)){const o=Array.isArray(n.pathMap)?n.pathMap.join(","):Object.keys(n.pathMap??{}).join(",");n.path=Yt(n.path).withConfig({runName:`Branch<${n.source}${o!==""?`,${o}`:""}>`.slice(0,63)})}const s=n.path.getName()==="RunnableLambda"?"condition":n.path.getName();if(this.branches[n.source]&&this.branches[n.source][s])throw new Error(`Condition \`${s}\` already present for node \`${t}\``);return(i=this.branches)[a=n.source]??(i[a]={}),this.branches[n.source][s]=new pA(n),this}setEntryPoint(t){return this.warnIfCompiled("Setting the entry point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(et,t)}setFinishPoint(t){return this.warnIfCompiled("Setting a finish point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(t,ze)}compile({checkpointer:t,interruptBefore:e,interruptAfter:r,name:n}={}){this.validate([...Array.isArray(e)?e:[],...Array.isArray(r)?r:[]]);const s=new mA({builder:this,checkpointer:t,interruptAfter:r,interruptBefore:e,autoValidate:!1,nodes:{},channels:{[et]:new Ra,[ze]:new Ra},inputChannels:et,outputChannels:ze,streamChannels:[],streamMode:"values",name:n});for(const[i,a]of Object.entries(this.nodes))s.attachNode(i,a);for(const[i,a]of this.edges)s.attachEdge(i,a);for(const[i,a]of Object.entries(this.branches))for(const[o,c]of Object.entries(a))s.attachBranch(i,o,c);return s.validate()}validate(t){const e=new Set([...this.allEdges].map(([n,s])=>n));for(const[n]of Object.entries(this.branches))e.add(n);for(const n of e)if(n!==et&&!(n in this.nodes))throw new Error(`Found edge starting at unknown node \`${n}\``);const r=new Set([...this.allEdges].map(([n,s])=>s));for(const[n,s]of Object.entries(this.branches))for(const i of Object.values(s))if(i.ends!=null)for(const a of Object.values(i.ends))r.add(a);else{r.add(ze);for(const a of Object.keys(this.nodes))a!==n&&r.add(a)}for(const n of Object.values(this.nodes))for(const s of n.ends??[])r.add(s);for(const n of Object.keys(this.nodes))if(!r.has(n))throw new qI([`Node \`${n}\` is not reachable.`,"","If you are returning Command objects from your node,",'make sure you are passing names of potential destination nodes as an "ends" array','into ".addNode(..., { ends: ["node1", "node2"] })".'].join(`
`),{lc_error_code:"UNREACHABLE_NODE"});for(const n of r)if(n!==ze&&!(n in this.nodes))throw new Error(`Found edge ending at unknown node \`${n}\``);if(t){for(const n of t)if(!(n in this.nodes))throw new Error(`Interrupt node \`${n}\` is not present`)}this.compiled=!0}},mA=class extends eB{constructor({builder:e,...r}){super(r);p(this,"builder");this.builder=e}attachNode(e,r){this.channels[e]=new Ra,this.nodes[e]=new Zo({channels:[],triggers:[],metadata:r.metadata,subgraphs:r.subgraphs,ends:r.ends}).pipe(r.runnable).pipe(new hr([{channel:e,value:Si}],[Tt])),this.streamChannels.push(e)}attachEdge(e,r){if(r===ze){if(e===et)throw new Error("Cannot have an edge from START to END");this.nodes[e].writers.push(new hr([{channel:ze,value:Si}],[Tt]))}else this.nodes[r].triggers.push(e),this.nodes[r].channels.push(e)}attachBranch(e,r,n){e===et&&!this.nodes[et]&&(this.nodes[et]=YU.subscribeTo(et,{tags:[Tt]})),this.nodes[e].pipe(n.run(i=>{const a=i.map(o=>Rr(o)?o:{channel:o===ze?ze:`branch:${e}:${r}:${o}`,value:Si});return new hr(a,[Tt])}));const s=n.ends?Object.values(n.ends):Object.keys(this.nodes);for(const i of s)if(i!==ze){const a=`branch:${e}:${r}:${i}`;this.channels[a]=new Ra,this.nodes[i].triggers.push(a),this.nodes[i].channels.push(a)}}async getGraphAsync(e){var l,u,d,h;const r=e==null?void 0:e.xray,n=new qo,s={[et]:n.addNode({schema:Wc()},et)},i={};let a={};r&&(a=Object.fromEntries((await Ps(this.getSubgraphsAsync())).filter(f=>jb(f[1]))));function o(f,m,g,y=!1){if(m===ze&&i[ze]===void 0&&(i[ze]=n.addNode({schema:Wc()},ze)),s[f]!==void 0){if(i[m]===void 0)throw new Error(`End node ${m} not found!`);return n.addEdge(s[f],i[m],g!==m?g:void 0,y)}}for(const[f,m]of Object.entries(this.builder.nodes)){const g=sr(f),y=m.runnable,b=m.metadata??{};if((l=this.interruptBefore)!=null&&l.includes(f)&&((u=this.interruptAfter)!=null&&u.includes(f))?b.__interrupt="before,after":(d=this.interruptBefore)!=null&&d.includes(f)?b.__interrupt="before":(h=this.interruptAfter)!=null&&h.includes(f)&&(b.__interrupt="after"),r){const _=typeof r=="number"?r-1:r,E=a[f]!==void 0?await a[f].getGraphAsync({...e,xray:_}):y.getGraph(e);if(E.trimFirstNode(),E.trimLastNode(),Object.keys(E.nodes).length>1){let R=function(S){return S?S.lc_runnable:!1},$=function(S,M){if(S!==void 0&&!Db(S))return S;if(R(M))try{let B=M.getName();return B=B.startsWith("Runnable")?B.slice(8):B,B}catch{return M.getName()}else return M.name??"UnknownSchema"};const[C,k]=n.extend(E,g);if(C===void 0)throw new Error(`Could not extend subgraph "${f}" due to missing entrypoint.`);k!==void 0&&(s[g]={name:$(k.id,k.data),...k}),i[g]={name:$(C.id,C.data),...C}}else{const C=n.addNode(y,g,b);s[g]=C,i[g]=C}}else{const _=n.addNode(y,g,b);s[g]=_,i[g]=_}}const c=[...this.builder.allEdges].sort(([f],[m])=>f<m?-1:m>f?1:0);for(const[f,m]of c)o(sr(f),sr(m));for(const[f,m]of Object.entries(this.builder.branches)){const g={...Object.fromEntries(Object.keys(this.builder.nodes).filter(y=>y!==f).map(y=>[sr(y),sr(y)])),[ze]:ze};for(const y of Object.values(m)){let b;y.ends!==void 0?b=y.ends:b=g;for(const[_,E]of Object.entries(b))o(sr(f),sr(E),_,!0)}}for(const[f,m]of Object.entries(this.builder.nodes))if(m.ends!==void 0)for(const g of m.ends)o(sr(f),sr(g),void 0,!0);return n}getGraph(e){var l,u,d,h;const r=e==null?void 0:e.xray,n=new qo,s={[et]:n.addNode({schema:Wc()},et)},i={};let a={};r&&(a=Object.fromEntries(no(this.getSubgraphs()).filter(f=>jb(f[1]))));function o(f,m,g,y=!1){return m===ze&&i[ze]===void 0&&(i[ze]=n.addNode({schema:Wc()},ze)),n.addEdge(s[f],i[m],g!==m?g:void 0,y)}for(const[f,m]of Object.entries(this.builder.nodes)){const g=sr(f),y=m.runnable,b=m.metadata??{};if((l=this.interruptBefore)!=null&&l.includes(f)&&((u=this.interruptAfter)!=null&&u.includes(f))?b.__interrupt="before,after":(d=this.interruptBefore)!=null&&d.includes(f)?b.__interrupt="before":(h=this.interruptAfter)!=null&&h.includes(f)&&(b.__interrupt="after"),r){const _=typeof r=="number"?r-1:r,E=a[f]!==void 0?a[f].getGraph({...e,xray:_}):y.getGraph(e);if(E.trimFirstNode(),E.trimLastNode(),Object.keys(E.nodes).length>1){let R=function(S){return S?S.lc_runnable:!1},$=function(S,M){if(S!==void 0&&!Db(S))return S;if(R(M))try{let B=M.getName();return B=B.startsWith("Runnable")?B.slice(8):B,B}catch{return M.getName()}else return M.name??"UnknownSchema"};const[C,k]=n.extend(E,g);if(C===void 0)throw new Error(`Could not extend subgraph "${f}" due to missing entrypoint.`);k!==void 0&&(s[g]={name:$(k.id,k.data),...k}),i[g]={name:$(C.id,C.data),...C}}else{const C=n.addNode(y,g,b);s[g]=C,i[g]=C}}else{const _=n.addNode(y,g,b);s[g]=_,i[g]=_}}const c=[...this.builder.allEdges].sort(([f],[m])=>f<m?-1:m>f?1:0);for(const[f,m]of c)o(sr(f),sr(m));for(const[f,m]of Object.entries(this.builder.branches)){const g={...Object.fromEntries(Object.keys(this.builder.nodes).filter(y=>y!==f).map(y=>[sr(y),sr(y)])),[ze]:ze};for(const y of Object.values(m)){let b;y.ends!==void 0?b=y.ends:b=g;for(const[_,E]of Object.entries(b))o(sr(f),sr(E),_,!0)}}return n}};function jb(t){return typeof t.attachNode=="function"&&typeof t.attachEdge=="function"}function sr(t){return t==="subgraph"?`"${t}"`:t}const gi=(t,e)=>t.size===e.size&&[...t].every(r=>e.has(r));var oB=class gA extends ji{constructor(r){super();p(this,"lc_graph_name","NamedBarrierValue");p(this,"names");p(this,"seen");this.names=r,this.seen=new Set}fromCheckpoint(r){const n=new gA(this.names);return typeof r<"u"&&(n.seen=new Set(r)),n}update(r){let n=!1;for(const s of r)if(this.names.has(s))this.seen.has(s)||(this.seen.add(s),n=!0);else throw new lt(`Value ${JSON.stringify(s)} not in names ${JSON.stringify(this.names)}`);return n}get(){if(!gi(this.names,this.seen))throw new Qt}checkpoint(){return[...this.seen]}consume(){return this.seen&&this.names&&gi(this.seen,this.names)?(this.seen=new Set,!0):!1}isAvailable(){return!!this.names&&gi(this.names,this.seen)}},cB=class yA extends ji{constructor(r){super();p(this,"lc_graph_name","NamedBarrierValueAfterFinish");p(this,"names");p(this,"seen");p(this,"finished");this.names=r,this.seen=new Set,this.finished=!1}fromCheckpoint(r){const n=new yA(this.names);if(typeof r<"u"){const[s,i]=r;n.seen=new Set(s),n.finished=i}return n}update(r){let n=!1;for(const s of r)if(this.names.has(s)&&!this.seen.has(s))this.seen.add(s),n=!0;else if(!this.names.has(s))throw new lt(`Value ${JSON.stringify(s)} not in names ${JSON.stringify(this.names)}`);return n}get(){if(!this.finished||!gi(this.names,this.seen))throw new Qt}checkpoint(){return[[...this.seen],this.finished]}consume(){return this.finished&&this.seen&&this.names&&gi(this.seen,this.names)?(this.seen=new Set,this.finished=!1,!0):!1}finish(){return!this.finished&&this.names&&gi(this.names,this.seen)?(this.finished=!0,!0):!1}isAvailable(){return this.finished&&!!this.names&&gi(this.names,this.seen)}};const lB="lg:";var uB=class{constructor(){p(this,"_map",new WeakMap);p(this,"_extensionCache",new Map)}get(t){return this._map.get(t)}extend(t,e){const r=this.get(t);this._map.set(t,e(r))}remove(t){return this._map.delete(t),this}has(t){return this._map.has(t)}getChannelsForSchema(t){const e={},r=jo(t);for(const[n,s]of Object.entries(r)){const i=this.get(s);i!=null&&i.reducer?e[n]=new Wp(i.reducer.fn,i.default):e[n]=new Gg}return e}getExtendedChannelSchemas(t,e){if(Object.keys(e).length===0)return t;const r=Object.entries(e).filter(([,i])=>i===!0).sort(([i],[a])=>i.localeCompare(a)).map(([i,a])=>`${i}:${a}`).join("|"),n=this._extensionCache.get(r)??new WeakMap;if(n.has(t))return n.get(t);let s=t;if(e.withReducerSchema||e.withJsonSchemaExtrasAsDescription){const i=Object.entries(jo(t)).map(([a,o])=>{var u;const c=this.get(o);let l=e.withReducerSchema?((u=c==null?void 0:c.reducer)==null?void 0:u.schema)??o:o;if(e.withJsonSchemaExtrasAsDescription&&(c!=null&&c.jsonSchemaExtra)){const d=Ri(l)??Ri(o),h=JSON.stringify({...c.jsonSchemaExtra,description:d});l=l.describe(`${lB}${h}`)}return[a,l]});s=kS(t,Object.fromEntries(i)),bt(s)&&(s._def.unknownKeys="strip")}return e.asPartial&&(s=pg(s)),n.set(t,s),this._extensionCache.set(r,n),s}};const xu=new uB;function dB(t,e){var r;if(e.reducer&&!e.default){const n=IS(t);n!=null&&(e.default=n)}if(e.reducer){const n=Object.assign(t,{lg_reducer_schema:((r=e.reducer)==null?void 0:r.schema)??t});return xu.extend(n,()=>e),n}else return xu.extend(t,()=>e),t}const us="__root__",rm=Symbol.for("langgraph.state.partial");var _A=class extends aB{constructor(e,r){var s,i;super();p(this,"channels",{});p(this,"waitingEdges",new Set);p(this,"_schemaDefinition");p(this,"_schemaRuntimeDefinition");p(this,"_inputDefinition");p(this,"_inputRuntimeDefinition");p(this,"_outputDefinition");p(this,"_outputRuntimeDefinition");p(this,"_schemaDefinitions",new Map);p(this,"_metaRegistry",xu);p(this,"_configSchema");p(this,"_configRuntimeSchema");p(this,"_interrupt");p(this,"_writer");if(_B(e)){const a=this._metaRegistry.getChannelsForSchema(e.state),o=e.input!=null?this._metaRegistry.getChannelsForSchema(e.input):a,c=e.output!=null?this._metaRegistry.getChannelsForSchema(e.output):a;this._schemaDefinition=a,this._schemaRuntimeDefinition=e.state,this._inputDefinition=o,this._inputRuntimeDefinition=e.input??rm,this._outputDefinition=c,this._outputRuntimeDefinition=e.output??e.state}else if(_n(e)){const a=this._metaRegistry.getChannelsForSchema(e);this._schemaDefinition=a,this._schemaRuntimeDefinition=e,this._inputDefinition=a,this._inputRuntimeDefinition=rm,this._outputDefinition=a,this._outputRuntimeDefinition=e}else if(yB(e))this._schemaDefinition=e.input.spec,this._inputDefinition=e.input.spec,this._outputDefinition=e.output.spec;else if(gB(e))this._schemaDefinition=e.stateSchema.spec,this._inputDefinition=((s=e.input)==null?void 0:s.spec)??this._schemaDefinition,this._outputDefinition=((i=e.output)==null?void 0:i.spec)??this._schemaDefinition;else if(pB(e)||Fb(e)){const a=Fb(e)?e.spec:e;this._schemaDefinition=a}else if(mB(e)){const a=hB(e.channels);this._schemaDefinition=a}else throw new Error("Invalid StateGraph input. Make sure to pass a valid Annotation.Root or Zod schema.");this._inputDefinition??(this._inputDefinition=this._schemaDefinition),this._outputDefinition??(this._outputDefinition=this._schemaDefinition),this._addSchema(this._schemaDefinition),this._addSchema(this._inputDefinition),this._addSchema(this._outputDefinition);function n(a){return typeof a=="object"&&a!=null&&!("spec"in a)&&!_n(a)}n(r)?(_n(r.context)&&(this._configRuntimeSchema=r.context),this._interrupt=r.interrupt,this._writer=r.writer):_n(r)&&(this._configRuntimeSchema=r)}get allEdges(){return new Set([...this.edges,...Array.from(this.waitingEdges).flatMap(([e,r])=>e.map(n=>[n,r]))])}_addSchema(e){if(!this._schemaDefinitions.has(e)){this._schemaDefinitions.set(e,e);for(const[r,n]of Object.entries(e)){let s;if(typeof n=="function"?s=n():s=n,this.channels[r]!==void 0){if(this.channels[r]!==s&&s.lc_graph_name!=="LastValue")throw new Error(`Channel "${r}" already exists with a different type.`)}else this.channels[r]=s}}}addNode(...e){function r(s){return s.length>=1&&typeof s[0]!="string"}const n=r(e)?Array.isArray(e[0])?e[0]:Object.entries(e[0]).map(([s,i])=>[s,i]):[[e[0],e[1],e[2]]];if(n.length===0)throw new Error("No nodes provided in `addNode`");for(const[s,i,a]of n){if(s in this.channels)throw new Error(`${s} is already being used as a state attribute (a.k.a. a channel), cannot also be used as a node name.`);for(const d of[Pt,fs])if(s.includes(d))throw new Error(`"${d}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),s in this.nodes)throw new Error(`Node \`${s}\` already present.`);if(s===ze||s===et)throw new Error(`Node \`${s}\` is reserved.`);let o=this._schemaDefinition;(a==null?void 0:a.input)!==void 0&&(_n(a.input)?o=this._metaRegistry.getChannelsForSchema(a.input):a.input.spec!==void 0&&(o=a.input.spec)),o!==void 0&&this._addSchema(o);let c;Fe.isRunnable(i)?c=i:typeof i=="function"?c=new ei({func:i,name:s,trace:!1}):c=Yt(i);let l=a==null?void 0:a.cachePolicy;typeof l=="boolean"&&(l=l?{}:void 0);const u={runnable:c,retryPolicy:a==null?void 0:a.retryPolicy,cachePolicy:l,metadata:a==null?void 0:a.metadata,input:o??this._schemaDefinition,subgraphs:Zg(c)?[c]:a==null?void 0:a.subgraphs,ends:a==null?void 0:a.ends,defer:a==null?void 0:a.defer};this.nodes[s]=u}return this}addEdge(e,r){if(typeof e=="string")return super.addEdge(e,r);this.compiled&&console.warn("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph.");for(const n of e){if(n===ze)throw new Error("END cannot be a start node");if(!Object.keys(this.nodes).some(s=>s===n))throw new Error(`Need to add a node named "${n}" first`)}if(r===ze)throw new Error("END cannot be an end node");if(!Object.keys(this.nodes).some(n=>n===r))throw new Error(`Need to add a node named "${r}" first`);return this.waitingEdges.add([e,r]),this}addSequence(e){const r=Array.isArray(e)?e:Object.entries(e);if(r.length===0)throw new Error("Sequence requires at least one node.");let n;for(const[s,i,a]of r){if(s in this.nodes)throw new Error(`Node names must be unique: node with the name "${s}" already exists.`);const o=s;this.addNode(o,i,a),n!=null&&this.addEdge(n,o),n=o}return this}compile({checkpointer:e,store:r,cache:n,interruptBefore:s,interruptAfter:i,name:a,description:o}={}){this.validate([...Array.isArray(s)?s:[],...Array.isArray(i)?i:[]]);const c=Object.keys(this._schemaDefinitions.get(this._outputDefinition)),l=c.length===1&&c[0]===us?us:c,u=Object.keys(this.channels),d=u.length===1&&u[0]===us?us:u,h=this._interrupt,f=new fB({builder:this,checkpointer:e,interruptAfter:i,interruptBefore:s,autoValidate:!1,nodes:{},channels:{...this.channels,[et]:new Ra},inputChannels:et,outputChannels:l,streamChannels:d,streamMode:"updates",store:r,cache:n,name:a,description:o,userInterrupt:h});f.attachNode(et);for(const[m,g]of Object.entries(this.nodes))f.attachNode(m,g);f.attachBranch(et,Cb,zb(),{withReader:!1});for(const[m]of Object.entries(this.nodes))f.attachBranch(m,Cb,zb(),{withReader:!1});for(const[m,g]of this.edges)f.attachEdge(m,g);for(const[m,g]of this.waitingEdges)f.attachEdge(m,g);for(const[m,g]of Object.entries(this.branches))for(const[y,b]of Object.entries(g))f.attachBranch(m,y,b);return f.validate()}};function hB(t){const e={};for(const[r,n]of Object.entries(t))e[r]=Jp(n);return e}var fB=class extends mA{constructor({description:e,...r}){super(r);p(this,"description");p(this,"_metaRegistry",xu);this.description=e}attachNode(e,r){let n;e===et?n=Object.entries(this.builder._schemaDefinitions.get(this.builder._inputDefinition)).map(([c])=>c):n=Object.keys(this.builder.channels);function s(c){if(Xt(c))return c.graph===rt.PARENT?null:c._updateAsTuples();if(Array.isArray(c)&&c.length>0&&c.some(l=>Xt(l))){const l=[];for(const u of c)if(Xt(u)){if(u.graph===rt.PARENT)continue;l.push(...u._updateAsTuples())}else l.push([us,u]);return l}else if(c!=null)return[[us,c]];return null}const i=e;function a(c){if(c){if(Xt(c))return c.graph===rt.PARENT?null:c._updateAsTuples().filter(([l])=>n.includes(l));if(Array.isArray(c)&&c.length>0&&c.some(Xt)){const l=[];for(const u of c)if(Xt(u)){if(u.graph===rt.PARENT)continue;l.push(...u._updateAsTuples().filter(([d])=>n.includes(d)))}else{const d=a(u);d&&l.push(...d??[])}return l}else{if(typeof c=="object"&&!Array.isArray(c))return Object.entries(c).filter(([l])=>n.includes(l));{const l=Array.isArray(c)?"array":typeof c;throw new lt(`Expected node "${i.toString()}" to return an object or an array containing at least one Command object, received ${l}`,{lc_error_code:"INVALID_GRAPH_NODE_RETURN_VALUE"})}}}else return null}const o=[{value:Si,mapper:new ei({func:n.length&&n[0]===us?s:a,trace:!1,recurse:!1})}];if(e===et)this.nodes[e]=new Zo({tags:[Tt],triggers:[et],channels:[et],writers:[new hr(o,[Tt])]});else{const c=(r==null?void 0:r.input)??this.builder._schemaDefinition,l=Object.fromEntries(Object.keys(this.builder._schemaDefinitions.get(c)).map(h=>[h,h])),u=Object.keys(l).length===1&&us in l,d=`branch:to:${e}`;this.channels[d]=r!=null&&r.defer?new N4:new Ra(!1),this.nodes[e]=new Zo({triggers:[d],channels:u?Object.keys(l):l,writers:[new hr(o,[Tt])],mapper:u?void 0:h=>Object.fromEntries(Object.entries(h).filter(([f])=>f in l)),bound:r==null?void 0:r.runnable,metadata:r==null?void 0:r.metadata,retryPolicy:r==null?void 0:r.retryPolicy,cachePolicy:r==null?void 0:r.cachePolicy,subgraphs:r==null?void 0:r.subgraphs,ends:r==null?void 0:r.ends})}}attachEdge(e,r){if(r!==ze){if(typeof e=="string")this.nodes[e].writers.push(new hr([{channel:`branch:to:${r}`,value:null}],[Tt]));else if(Array.isArray(e)){const n=`join:${e.join("+")}:${r}`;this.channels[n]=this.builder.nodes[r].defer?new cB(new Set(e)):new oB(new Set(e)),this.nodes[r].triggers.push(n);for(const s of e)this.nodes[s].writers.push(new hr([{channel:n,value:s}],[Tt]))}}}attachBranch(e,r,n,s={withReader:!0}){const i=async(a,o)=>{const c=a.filter(u=>u!==ze);if(!c.length)return;const l=c.map(u=>Rr(u)?u:{channel:u===ze?u:`branch:to:${u}`,value:e});await hr.doWrite({...o,tags:(o.tags??[]).concat([Tt])},l)};this.nodes[e].writers.push(n.run(i,s.withReader?a=>W4.doRead(a,this.streamChannels??this.outputChannels,!0):void 0))}async _validateInput(e){if(e==null)return e;const r=(()=>{const n=this.builder._inputRuntimeDefinition,s=this.builder._schemaRuntimeDefinition,i=a=>{if(a!=null)return this._metaRegistry.getExtendedChannelSchemas(a,{withReducerSchema:!0})};if(_n(n))return i(n);if(n===rm)return pg(i(s))})();if(Xt(e)){const n=e;return e.update&&r!=null&&(n.update=bl(r,e.update)),n}return r!=null?bl(r,e):e}isInterrupted(e){return JT(e)}async _validateContext(e){const r=this.builder._configRuntimeSchema;return _n(r)&&bl(r,e),e}};function pB(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)&&Object.keys(t).length>0&&Object.values(t).every(e=>typeof e=="function"||VT(e))}function Fb(t){return typeof t=="object"&&t!==null&&"lc_graph_name"in t&&t.lc_graph_name==="AnnotationRoot"}function mB(t){return typeof t=="object"&&t!==null&&t.channels!==void 0}function gB(t){return typeof t=="object"&&t!==null&&t.stateSchema!==void 0}function yB(t){return typeof t=="object"&&t!==null&&t.stateSchema===void 0&&t.input!==void 0&&t.output!==void 0}function _B(t){return!(typeof t!="object"||t==null||!("state"in t)||!_n(t.state)||"input"in t&&!_n(t.input)||"output"in t&&!_n(t.output))}function wB(t){if(Rr(t))return[t];const e=[];Xt(t)?e.push(t):Array.isArray(t)&&e.push(...t.filter(Xt));const r=[];for(const n of e){if(n.graph===rt.PARENT)throw new zv(n);Rr(n.goto)||typeof n.goto=="string"?r.push(n.goto):Array.isArray(n.goto)&&r.push(...n.goto)}return r}function zb(){const t=new ei({func:wB,tags:[Tt],trace:!1,recurse:!1,name:"<control_branch>"});return new pA({path:t})}const bB="__remove_all__";function Qg(t,e){const r=Array.isArray(t)?t:[t],n=Array.isArray(e)?e:[e],s=r.map(Hn),i=n.map(Hn);for(const u of s)(u.id===null||u.id===void 0)&&(u.id=Bb(),u.lc_kwargs.id=u.id);let a;for(let u=0;u<i.length;u+=1){const d=i[u];(d.id===null||d.id===void 0)&&(d.id=Bb(),d.lc_kwargs.id=d.id),d.getType()==="remove"&&d.id===bB&&(a=u)}if(a!=null)return i.slice(a+1);const o=[...s],c=new Map(o.map((u,d)=>[u.id,d])),l=new Set;for(const u of i){const d=c.get(u.id);if(d!==void 0)u.getType()==="remove"?l.add(u.id):(l.delete(u.id),o[d]=u);else{if(u.getType()==="remove")throw new Error(`Attempting to delete a message with an ID that doesn't exist ('${u.id}')`);c.set(u.id,o.length),o.push(u)}}return o.filter(u=>!l.has(u.id))}const vB=De.Root({messages:De({reducer:Qg,default:()=>[]})}),EB={reducer:{fn:Qg},jsonSchemaExtra:{langgraph_type:"messages"},default:()=>[]};jt({messages:dB(XP(),EB)});const SB=40,xB=35,TB=50,AB=2,CB=5,Vb=3,If=3,el={ASSET:"Asset",ENTITY:"Entity"},ri={SPOOFING:"Spoofing",TAMPERING:"Tampering",REPUDIATION:"Repudiation",INFORMATION_DISCLOSURE:"Information Disclosure",DENIAL_OF_SERVICE:"Denial of Service",ELEVATION_OF_PRIVILEGE:"Elevation of Privilege"},Rf={LOW:"Low",MEDIUM:"Medium",HIGH:"High"},kB=jt({summary:it().describe(`A short headline summary of max ${SB} words`)}),IB=jt({type:Ip([el.ASSET,el.ENTITY]).describe(`Type, one of ${el.ASSET} or ${el.ENTITY}`),name:it().describe("The name of the asset"),description:it().describe("The description of the asset or entity")}),RB=jt({assets:Bs(IB).describe("The list of assets")}),OB=jt({flow_description:it().describe("The description of the data flow"),source_entity:it().describe("The source entity/asset of the data flow"),target_entity:it().describe("The target entity/asset of the data flow")}),$B=jt({purpose:it().describe("The purpose of the trust boundary"),source_entity:it().describe("The source entity/asset of the trust boundary"),target_entity:it().describe("The target entity/asset of the trust boundary")}),NB=jt({category:it().describe("Actor Category"),description:it().describe("One sentence describing their relevance to this architecture"),example:it().describe("Brief list of 1-2 specific actor types")}),PB=jt({data_flows:Bs(OB).describe("The list of data flows"),trust_boundaries:Bs($B).describe("The list of trust boundaries"),threat_sources:Bs(NB).describe("The list of threat actors")}),LB=jt({name:it().describe("A concise, descriptive name for the threat that clearly identifies the security concern"),stride_category:Ip([ri.SPOOFING,ri.TAMPERING,ri.REPUDIATION,ri.INFORMATION_DISCLOSURE,ri.DENIAL_OF_SERVICE,ri.ELEVATION_OF_PRIVILEGE]).describe(`The STRIDE category classification: One of ${Object.values(ri).join(", ")}`),description:it().describe(`A comprehensive description of the threat scenario, including how it could be executed and its potential consequences. Must be between ${xB} and ${TB} words. Follow threat grammar: [Threat Actor] + [Action] + [Asset/Target] + [Negative Outcome]`),target:it().describe("The specific asset, component, system, or data element that could be compromised by this threat"),impact:it().describe("The potential business, technical, or operational consequences if this threat is successfully exploited. Consider confidentiality, integrity, and availability impacts"),likelihood:Ip([Rf.LOW,Rf.MEDIUM,Rf.HIGH]).describe("The probability of threat occurrence based on factors like attacker motivation, capability, opportunity, and existing controls"),mitigations:Bs(it()).min(AB).max(CB).describe("Specific security controls, countermeasures, or design changes that can prevent, detect, or reduce the impact of this threat"),source:it().describe("The threat actor or agent who could execute this threat"),prerequisites:Bs(it()).default([]).describe("Required conditions, access levels, knowledge, or system states that must exist for this threat to be viable"),vector:it().describe("The attack vector or pathway through which the threat could be delivered or executed"),starred:gg().default(!1).optional().describe("User-defined flag for prioritization or tracking. Ignored by automated threat modeling agents")}),wA=jt({threats:Bs(LB).describe("The list of threats")}),bA=jt({stop:gg().describe("Should continue evaluation further threats or the catalog is comprehensive and complete."),gap:it().optional().default("").describe("The identited list of gaps discovered to improve the threat catalog. Required only when 'stop' is False. ")});function vA(t,e){if(!t)return e;if(!e)return t;const r=new Set(t.threats.map(s=>s.name)),n=e.threats.filter(s=>!r.has(s.name));return{threats:[...t.threats,...n]}}function EA(t,e){return t?e?[...t,...e]:t:e||[]}function st(t,e){return e??t}const MB=De.Root({job_id:De({reducer:st}),summary:De({reducer:st}),assets:De({reducer:st}),image_data:De({reducer:st}),system_architecture:De({reducer:st}),description:De({reducer:st}),assumptions:De({reducer:st}),threat_list:De({reducer:vA}),iteration:De({reducer:st}),retry:De({reducer:st}),s3_location:De({reducer:st}),title:De({reducer:st}),owner:De({reducer:st}),stop:De({reducer:st}),gap:De({reducer:EA}),replay:De({reducer:st}),instructions:De({reducer:st})}),DB=De.Root({...vB.spec,threat_list:De({reducer:vA}),tool_use:De({reducer:st,default:()=>0}),gap_tool_use:De({reducer:st,default:()=>0}),assets:De({reducer:st}),image_data:De({reducer:st}),system_architecture:De({reducer:st}),description:De({reducer:st}),assumptions:De({reducer:st}),gap:De({reducer:EA}),instructions:De({reducer:st}),job_id:De({reducer:st}),retry:De({reducer:st}),iteration:De({reducer:st}),replay:De({reducer:st})});class UB{constructor(){this.store=new Map}run(e,r,...n){const s=this.store;this.store=new Map(s),this.store.set("current",e);try{return r(...n)}finally{this.store=s}}getStore(){return this.store.get("current")}enterWith(e){this.store.set("current",e)}disable(){this.store.delete("current")}exit(e,...r){const n=this.store;this.store=new Map;try{return e(...r)}finally{this.store=n}}}function BB(){Bt.initializeGlobalInstance(new UB)}BB();class Fi{constructor(e,r,n){this.image_data=e,this.description=r,this.assumptions=n;const s=Wu();this.supportsCaching=(s==null?void 0:s.provider)==="bedrock"}_formatAssetList(e){return!e||!e.assets||!Array.isArray(e.assets)||e.assets.length===0?"No assets identified yet.":e.assets.map(n=>`  - ${n.name}`).join(`
`)}_formatThreatSources(e){return!e||!e.threat_sources||!Array.isArray(e.threat_sources)||e.threat_sources.length===0?"No threat sources identified yet.":e.threat_sources.map(n=>`  - ${n.category}`).join(`
`)}base_msg(e=!1,r=!0){const n=i=>i?String(i).replace(/\0/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").trim():"",s=[{type:"text",text:"<architecture_diagram>"},{type:"image_url",image_url:{url:`data:image/jpeg;base64,${this.image_data}`}},{type:"text",text:"</architecture_diagram>"}];if(r){const i=n(this.description),a=n(this.assumptions);s.push({type:"text",text:`<description>${i}</description>`},{type:"text",text:`<assumptions>${a}</assumptions>`})}return e&&this.supportsCaching&&s.push({cachePoint:{type:"default"}}),s}createSummaryMessage(e=40){const r=[{type:"text",text:`Generate a short headline summary of max ${e} words this architecture using the diagram and description if available`}],n=this.base_msg();return n.push(...r),new ut({content:n})}createAssetMessage(){const e=[{type:"text",text:"Identify Assets"}],r=this.base_msg();return r.push(...e),new ut({content:r})}createSystemFlowsMessage(e){const n=[{type:"text",text:`<identified_assets_and_entities>${typeof e=="string"?e:JSON.stringify(e)}</identified_assets_and_entities>`},{type:"text",text:"Identify system flows"}],s=this.base_msg();return s.push(...n),new ut({content:s})}createThreatMessage(e,r){const n=typeof e=="string"?e:JSON.stringify(e),s=typeof r=="string"?r:JSON.stringify(r),i=[{type:"text",text:`<identified_assets_and_entities>${n}</identified_assets_and_entities>`},{type:"text",text:`<data_flow>${s}</data_flow>`},{type:"text",text:`<valid_values_for_threats>
**IMPORTANT: When creating threats using the add_threats tool, you MUST use ONLY these values:**

**Valid Target Assets (for the 'target' field):**
${this._formatAssetList(e)}

**Valid Threat Sources (for the 'source' field):**
${this._formatThreatSources(r)}

Using any other values will result in validation errors.
</valid_values_for_threats>`},{type:"text",text:"Define threats and mitigations for the solution"}],a=this.base_msg();return a.push(...i),new ut({content:a})}createThreatImproveMessage(e,r,n,s){const i=typeof e=="string"?e:JSON.stringify(e),a=typeof r=="string"?r:JSON.stringify(r),o=typeof n=="string"?n:JSON.stringify(n),c=[{type:"text",text:`<identified_assets_and_entities>${i}</identified_assets_and_entities>`},{type:"text",text:`<data_flow>${a}</data_flow>`},{type:"text",text:`<valid_values_for_threats>
**IMPORTANT: When creating threats using the add_threats tool, you MUST use ONLY these values:**

**Valid Target Assets (for the 'target' field):**
${this._formatAssetList(e)}

**Valid Threat Sources (for the 'source' field):**
${this._formatThreatSources(r)}

Using any other values will result in validation errors.
</valid_values_for_threats>`}];this.supportsCaching&&c.push({cachePoint:{type:"default"}}),c.push({type:"text",text:`<threats>${o}</threats>`},{type:"text",text:`<gap>${s}</gap>`},{type:"text",text:"Identify missing threats and respective mitigations for the solution"});const l=this.base_msg(!0);return l.push(...c),new ut({content:l})}createGapAnalysisMessage(e,r,n,s){const i=f=>f?String(f).replace(/\0/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").trim():"",a=f=>{if(!f)return"";try{const m=typeof f=="string"?f:JSON.stringify(f);return i(m)}catch(m){return console.error("Error stringifying data:",m),""}},o=a(e),c=a(r),l=a(n);let u="";Array.isArray(s)?u=s.map(f=>i(String(f))).join(`
`):typeof s=="string"?u=i(s):s&&(u=i(String(s)));const d=[{type:"text",text:`<identified_assets_and_entities>${o}</identified_assets_and_entities>`},{type:"text",text:`<data_flow>${c}</data_flow>`}];this.supportsCaching&&d.push({cachePoint:{type:"default"}}),d.push({type:"text",text:`<threats>${l}</threats>`},{type:"text",text:`<previous_gap>${u}</previous_gap>
`},{type:"text",text:"Identify missing threats and respective mitigations for the solution"});const h=this.base_msg(!0);return h.push(...d),new ut({content:h})}createThreatAgentMessage(e=!0){const r=[];e||r.push({type:"text",text:"Currently the threat catalog is empty. No threats have been cataloged yet."}),r.push({type:"text",text:"Create the comprehensive threat catalog while honoring the ground rules."}),this.supportsCaching&&r.push({cachePoint:{type:"default"}});const n=this.base_msg(!0,!1);return n.push(...r),new ut({content:n})}}function zi(t){return!t||t.length===0?" ":t.join(`
`)}const jB=40;function FB(t){return!t||!t.assets||t.assets.length===0?"No assets identified yet.":t.assets.map(r=>r.name).map(r=>`  - ${r}`).join(`
`)}function zB(t){return!t||!t.threat_sources||t.threat_sources.length===0?"No threat sources identified yet.":t.threat_sources.map(r=>r.category).map(r=>`  - ${r}`).join(`
`)}function VB(){return`<instruction>
   Use the information provided by the user to generate a short headline summary of max ${jB} words.
   </instruction> 

      `}function qB(){return`<instruction>
   You are an expert in all security domains and threat modeling. Your role is to carefully review a given architecture and identify key assets and entities that require protection. Follow these steps:

   1. Review the provided inputs carefully:

         * <architecture_diagram>: Architecture Diagram of the solution in scope for threat modeling.
         * <description>: [Description of the solution provided by the user]
         * <assumptions>: [Assumptions provided by the user]

   2. Identify the most critical assets within the system, such as sensitive data, databases, communication channels, or APIs. These are components that need protection.

   3. Identify the key entities involved, such as users, services, or systems interacting with the system.

   4. For each identified asset or entity, provide the following information in the specified format:

   Type: [Asset or Entity]
   Name: [Asset/Entity Name]
   Description: [Brief description of the asset/entity]
   </instruction> 

      `}function HB(){return`
<task>
You are an expert in all security domains and threat modeling. Your goal is to systematically analyze the given system architecture and identify critical security elements: data flows, trust boundaries, and relevant threat actors. Your analysis must be comprehensive, architecturally-grounded, and focused on elements that impact the security posture of the system.
</task>

<instructions>

1. Review the provided inputs carefully:

   * <architecture_diagram>: Architecture Diagram of the solution in scope for threat modeling.
   * <description>: [Description of the solution provided by the user]
   * <assumptions>: [Assumptions provided by the user]
   * <identified_assets_and_entities>: Inventory of key assets and entities in the architecture.

2. Data Flow Analysis:

   **Definition**: Data flows represent the movement of information between system components, including the path, direction, and security context of the data movement.

   **Identification approach**:
   - Map all significant data movements between identified assets and entities
   - Consider both internal flows (within trust boundaries) and external flows (crossing trust boundaries)
   - Focus on flows involving sensitive data, authentication credentials, or business-critical information
   - Include bidirectional flows where relevant
   - Consider both primary operational flows and secondary flows (logs, backups, monitoring)

   **Use the following format for each data flow**:
   <data_flow_definition>
   flow_description: [Clear description of what data moves and how]
   source_entity: [Source entity name from assets inventory]
   target_entity: [Target entity name from assets inventory]
   assets: [List of specific assets/data types involved in this flow]
   flow_type: [Internal/External/Cross-boundary]
   criticality: [High/Medium/Low - based on data sensitivity and business impact]
   </data_flow_definition>

3. Trust Boundary Analysis:

   **Definition**: Trust boundaries are logical or physical barriers where the level of trust changes, typically representing transitions between different security domains, ownership, or control levels.

   **Identification criteria**:
   - Network boundaries (internal to external networks, DMZ transitions)
   - Process boundaries (different applications, services, or execution contexts)
   - Physical boundaries (on-premises to cloud, different data centers)
   - Organizational boundaries (internal systems to third-party services)
   - Administrative boundaries (different management domains or privilege levels)

   **Use the following format for each trust boundary**:
   <trust_boundary>
   purpose: [Security purpose and what trust level change occurs]
   source_entity: [Entity on the higher trust side]
   target_entity: [Entity on the lower trust side]
   boundary_type: [Network/Process/Physical/Organizational/Administrative]
   security_controls: [Existing controls at this boundary, if known]
   </trust_boundary>

4. Threat Actor Analysis:

   **Definition**: Threat actors are individuals, groups, or entities with the potential to compromise the system's security objectives. **Critically, threat actors must be within the customer's sphere of control or responsibility** - focus only on actors the customer can realistically defend against or whose actions the customer is responsible for mitigating.

   **Scoping Principles** (Exclusion Rules):
   1. **Exclude infrastructure provider employees**: Do not include cloud provider staff (AWS, Azure, GCP administrators) as threat actors
   2. **Exclude managed service provider personnel**: Do not include MSP staff operating outside customer control (unless they have direct access to customer data)
   3. **Exclude vendor responsibility threats**: In SaaS or PaaS scenarios, exclude threat actors that are the vendor's responsibility to defend against
   4. **Exclude hardware/physical layer threats**: Do not include hardware manufacturers or physical datacenter staff
   5. **Focus on customer responsibility boundary**: Only include threat actors whose actions fall within the customer's security responsibility

   **Explicit Examples of EXCLUDED Threat Actors**:
   - ❌ Cloud provider employees (AWS/Azure/GCP administrators)
   - ❌ SaaS platform internal staff (Salesforce/Workday employees)
   - ❌ Managed service provider personnel (unless direct customer data access)
   - ❌ Infrastructure hosting provider staff
   - ❌ Hardware manufacturers

   **Output format**: Present threat actors in a concise table format:

   | Category | Description | Examples |
   |----------|-------------|----------|
   | [Actor Category] | [One sentence describing their relevance to this architecture] | [Brief list of 1-2 specific actor types] |

   **Standard threat actor categories to consider**:
   - Legitimate Users (unintentional threats from authorized users)
   - Malicious Internal Actors (employees or contractors with insider access)
   - External Threat Actors (attackers targeting exposed services)
   - Untrusted Data Suppliers (third-party integrations)
   - Unauthorized External Users (no legitimate access)
   - Compromised Accounts or Components (legitimate credentials used maliciously)

   **Selection criteria**:
   - Only include categories with clear relevance to the architecture
   - **Focus on actor types within customer's responsibility scope**
   - Maximum 5-7 threat actor categories
   - Focus on actor types, not attack methods
   - Keep descriptions to ONE concise sentence
   - Examples should be 2-5 words each

   **Output constraints**:
   - No attack scenarios or narratives
   - No detailed technical descriptions
   - No step-by-step attack explanations
   - Focus on WHO might attack, not HOW

5. Analysis guidelines:

   **Completeness requirements**:
   - Address all identified assets and entities from the provided inventory
   - Consider the full system lifecycle (deployment, operation, maintenance, decommissioning)
   - Include both automated and manual processes
   - Account for emergency or disaster recovery scenarios if mentioned

   **Contextual alignment**:
   - Respect the stated assumptions and constraints
   - Focus on elements relevant to the described solution and deployment model
   - Consider the organization's threat landscape based on provided context
   - Align with the technical architecture and technology stack described

   **Responsibility boundary awareness**:
   - Consider the deployment model (IaaS, PaaS, SaaS, on-premises, or hybrid)
   - Respect the shared responsibility model for cloud or managed services
   - Focus threat actors on customer-controlled layers only
   - Exclude provider-side threats unless the customer has direct mitigation responsibility
   - Document assumptions about trust placed in infrastructure providers

   **Prioritization approach**:
   - Prioritize high-criticality flows involving sensitive data
   - Focus on trust boundaries with significant security implications
   - Emphasize threat actors with realistic access to the described architecture

6. Quality control checklist:

   **Data Flows**:
   * [ ] Are all significant data movements between assets identified?
   * [ ] Are both internal and cross-boundary flows covered?
   * [ ] Is the criticality assessment based on data sensitivity and business impact?
   * [ ] Are flow descriptions specific and technically accurate?

   **Trust Boundaries**:
   * [ ] Are all significant trust level transitions identified?
   * [ ] Is the security purpose of each boundary clearly articulated?
   * [ ] Are different types of boundaries (network, process, physical, etc.) considered?
   * [ ] Do boundaries align with the described architecture?

   **Threat Actors**:
   * [ ] Is the output in table format with Category, Description, Examples columns?
   * [ ] Are descriptions limited to ONE sentence?
   * [ ] Are examples brief (2-5 words each)?
   * [ ] Is the total count reasonable (typically 5-7 categories)?
   * [ ] Does the analysis avoid attack scenarios and technical details?

   **Overall Analysis**:
   * [ ] Does the analysis cover all provided assets and entities?
   * [ ] Is the analysis consistent with stated assumptions?
   * [ ] Are security-critical elements prioritized appropriately?
   * [ ] Would this analysis support effective threat modeling?
</instructions>
`}function Tu(t=null,e=null){const r=`You are an expert threat modeling compliance auditor. Evaluate the threat catalog for completeness and quality.

<compliance_audit>
Review the catalog for:

1. **Compliance Violations**
   - Threats using invalid target assets (not in provided asset list)
   - Threats using invalid threat sources (not in provided threat source categories)
   - Threats violating stated assumptions
   - Threats outside customer control boundaries

2. **High-Value Coverage Gaps**
   - Missing threats with BOTH high likelihood AND high impact
   - Uncovered critical assets with realistic attack vectors
   - Missing threat sources that have clear attack paths
   - Gaps in STRIDE coverage for high-value components

3. **Quality Issues**
   - Unrealistic or theoretical threats
   - Duplicate threats with different wording
   - Vague or non-actionable mitigations
   - Missing attack chain relationships

</compliance_audit>

<decision_logic>
Set stop = TRUE if:
- All critical assets have appropriate coverage
- All realistic threat sources are addressed
- No high-value gaps remain (high likelihood + high impact)
- All threats comply with validation rules

Set stop = FALSE if any high-value gaps or compliance violations exist.
</decision_logic>

<output_format>
**Compliance Status**: [Pass/Fail]
**High-Value Gaps**: [Count]
**Quality Issues**: [Count]

For each gap/issue:
- Category: [Compliance/Coverage/Quality]
- Description: [Specific issue]
- Impact: [Why this matters]
- Recommendation: [Specific action]

**Decision**: [STOP/CONTINUE]
</output_format>
      `;let n="";if(e){const s=`<valid_threat_source_categories>
The following threat source categories are valid for this architecture:

${e}

Any threats using sources not in this list are compliance violations.
</valid_threat_source_categories>

`;n+=s}if(t){const s=`<important_instructions>
${t}
</important_instructions>

`;n+=s}return n+=r,[{type:"text",text:n}]}function Ll(t=null){const e=`
You are an expert threat modeling specialist tasked with enriching an existing threat catalog using STRIDE methodology. You will identify new, actionable, and realistic threats that respect all provided constraints.

<critical_instructions>
BEFORE generating any threat, you MUST:
1. If <assumptions> are provided: Verify it doesn't violate any assumption
2. Verify the threat actor exists in <data_flow> threat_sources
3. Confirm it's not a duplicate of existing threats
4. Ensure it's within customer control boundary
5. Validate the threat is realistic and plausible

If a potential threat fails ANY of these checks, DO NOT include it.
</critical_instructions>

<assumption_enforcement>
**WHEN ASSUMPTIONS ARE PROVIDED:**
Assumptions define what is already secure or out of scope. These are non-negotiable constraints:
- If an assumption states "X is trusted", DO NOT generate threats about X being compromised
- If an assumption states "Y is already implemented", DO NOT suggest Y as a mitigation
- If an assumption defines a security boundary, RESPECT it completely
- Assumptions override all other considerations

**WHEN NO ASSUMPTIONS ARE PROVIDED:**
Use reasonable security baselines for the given context:
- Assume standard security best practices are NOT necessarily in place
- Consider common misconfigurations and oversights
- Focus on threats the customer can realistically address

WHY THIS MATTERS: When provided, assumptions reflect security decisions already made by the system owner. Violating them wastes time and undermines credibility.
</assumption_enforcement>

<threat_realism_guidance>
Every threat must be REALISTIC and PLAUSIBLE. Apply these filters:

**Generate threats that:**
- Have documented real-world precedent or clear attack paths
- Can be executed with reasonable attacker resources/skill
- Target common vulnerabilities or misconfigurations
- Have logical cause-and-effect relationships
- Are relevant to the specific system architecture

**Avoid threats that:**
- Require nation-state resources for low-value targets
- Depend on multiple highly unlikely events occurring simultaneously
- Assume attackers have unrealistic capabilities (e.g., "break AES-256 encryption")
- Are purely theoretical without practical attack vectors
- Ignore basic economics of attacks (effort vs. reward)

**Reality Check Questions:**
- Has this type of attack happened before in similar systems?
- Would a rational attacker invest resources in this approach?
- Is the attack technically feasible with current knowledge/tools?
- Does the attack path make practical sense?
</threat_realism_guidance>

<threat_generation_process>
For EACH potential threat, follow this exact sequence:

**1. Assumption Check (Conditional)**
   - IF assumptions exist: Ask "Does this threat contradict any assumption?"
     - If YES → Skip this threat entirely
     - If NO → Continue to step 2
   - IF no assumptions provided: Continue to step 2

**2. Realism Validation**
   - Ask: "Is this threat plausible and realistic?"
   - Review against <threat_realism_guidance>
   - If NO → Skip this threat entirely
   - If YES → Continue to step 3

**3. Source Validation**
   - Find the exact threat source in <data_flow> threat_sources
   - Ask: "Is this actor explicitly listed?"
   - If NO → Skip this threat entirely
   - If YES → Continue to step 4

**4. Duplication Check**
   - Compare against ALL existing threats
   - Ask: "Is this meaningfully different?"
   - If NO → Skip this threat entirely
   - If YES → Continue to step 5

**5. Control Boundary Check**
   - Identify who can mitigate this threat
   - Ask: "Can the customer control this?"
   - If NO → Skip this threat entirely
   - If YES → Continue to step 6

**6. Gap Relevance Check**
   - Review the <gap> analysis (if provided)
   - Ask: "Does this address an identified gap?"
   - If NO → Consider if it's still valuable
   - If YES → Proceed to format the threat

Only after passing ALL checks should you include the threat.
</threat_generation_process>

<shared_responsibility_boundaries>
You MUST respect these service model boundaries:

- **IaaS**: Customer controls from OS up; exclude hypervisor/hardware threats
- **PaaS**: Customer controls application and data; exclude platform runtime threats
- **SaaS**: Customer controls configuration and data; exclude application code threats

Never suggest the customer can mitigate provider-level vulnerabilities. Focus on:
- Misconfigurations the customer can fix
- Weak customer-controlled security settings
- Missing customer-implementable controls
- Insecure customer usage patterns
</shared_responsibility_boundaries>

<threat_format_template>
Structure each threat EXACTLY as:
"[Actor from data_flow] can [specific action] by [concrete method], causing [measurable impact] to [identified asset]"

Include:
- **Realism Justification**: "This threat is realistic because [real-world examples/feasible attack path]"
- **Assumption Compliance** (if assumptions provided): "This threat respects assumption X because..."
- **Gap Addressed** (if gap analysis provided): "This fills the gap in [specific area]"
- **Not a Duplicate Because**: "Unlike existing threat Y, this focuses on..."
- **Customer Control**: "The customer can mitigate this by..."
</threat_format_template>

<quality_validation>
Before finalizing your threat list:
1. **Realism check** - Are all threats practically feasible?
2. **Assumption compliance** (if provided) - Does any threat violate them?
3. **Source accuracy** - Do all match <data_flow> exactly?
4. **Duplication check** - Are threats genuinely distinct?
5. **Customer control** - Can they actually implement the mitigations?
6. **Gap coverage** (if provided) - Are you addressing identified weaknesses?

If you find any issues during validation, REMOVE those threats rather than trying to justify them.
</quality_validation>

<examples_of_realistic_threats>
**Example 1: Realistic**
✓ "Attacker can exploit default admin credentials on publicly exposed admin panel, causing unauthorized access to customer data"
- Real-world precedent: Common in breach reports
- Feasible: Requires basic scanning and credential stuffing
- Practical: Attackers routinely scan for default credentials

**Example 2: Unrealistic**
✗ "Attacker can break TLS 1.3 encryption through cryptographic breakthrough, exposing all transmitted data"
- No real-world precedent for TLS 1.3 breaks
- Requires theoretical breakthrough in mathematics
- Impractical: Nation-state level resources for minimal gain

**Example 3: Realistic with Context**
✓ "Insider with legitimate access can exfiltrate database backups through approved cloud storage sync tool, bypassing DLP controls"
- Real-world precedent: Common insider threat vector
- Feasible: Uses legitimate tools and access
- Practical: Clear attack path with available tools
</examples_of_realistic_threats>

<examples_of_assumption_respect>
**Example 1: If assumption states "Internal network is trusted"**
- WRONG: "Internal attacker can intercept traffic"
- RIGHT: "External attacker can exploit misconfigured firewall rules"

**Example 2: If assumption states "MFA is implemented for all users"**
- WRONG: "Attacker can bypass authentication without MFA"
- RIGHT: "Attacker can exploit MFA fatigue through repeated push notifications"

**Example 3: If assumption states "Cloud provider security is out of scope"**
- WRONG: "AWS S3 service could be compromised"
- RIGHT: "Misconfigured S3 bucket permissions could expose data"

**Example 4: If NO assumptions are provided**
- ACCEPTABLE: "Attacker can gain access through weak password policy, causing account compromise"
- ACCEPTABLE: "Internal user can access data without MFA, allowing unauthorized access after credential theft"
</examples_of_assumption_respect>

<output_requirements>
Generate high-quality threats that:
- Pass ALL validation checks (including realism)
- Address identified gaps (if gap analysis provided)
- Respect ALL assumptions without exception (if assumptions provided)
- Use only threat actors from data_flow
- Are realistic and practically feasible
- Provide actionable, customer-implementable mitigations
- Add genuine value beyond existing threats
- Set Starred to False

**Quality over quantity**: It's better to provide excellent, realistic, compliant threats rather than many that violate boundaries or strain credibility.
</output_requirements>
   `,r=`
<important_instructions>
         ${t}
         </important_instructions>
      `;return t?r+e:e}function GB(t=null,e=null){let r=Ll(t);if(e&&(e.assets||e.system_architecture)){const n=`

<valid_values_for_threats>
**IMPORTANT: When creating threats using the add_threats tool, you MUST use ONLY these values:**

**Valid Target Assets (for the 'target' field):**
${FB(e.assets)}

**Valid Threat Sources (for the 'source' field):**
${zB(e.system_architecture)}

Using any other values will result in validation errors.
</valid_values_for_threats>
`;r=r+n}return r}function WB(t){let r=`
You are an expert threat modeling agent tasked with generating a comprehensive threat catalog using the STRIDE methodology. Your role is to iteratively build a complete, high-quality threat catalog.

<available_tools>
- **add_threats**: Add new threats to the catalog.
- **remove_threat**: Remove threats by name.
- **read_threat_catalog**: Inspect the current catalog.
- **gap_analysis**: Analyze the catalog for gaps. This tool can be used up to 3 times.
</available_tools>


<threat_modeling_instructions>

You are conducting STRIDE-based threat modeling. These instructions are MANDATORY and override any conflicting guidance.

<absolute_requirements>
**NON-NEGOTIABLE RULES** (Violation of any rule = exclude the threat):
1. Threat actor MUST exist in <data_flow> threat_sources - no exceptions
2. IF assumptions are provided, threat MUST respect ALL of them - no exceptions  
3. Threat MUST be within customer control boundary - no exceptions
4. Threat MUST be architecturally possible - no exceptions

These rules exist because violating them wastes resources, undermines credibility, and creates unusable outputs that will be rejected by security teams.
</absolute_requirements>

<threat_validation_sequence>
For EVERY threat, execute these checks IN ORDER:

**CHECK 1: Assumption Compliance (if assumptions provided)**
- IF <assumptions> section exists:
  - Read each assumption carefully
  - Ask: "Does this threat contradict ANY assumption?"
  - If YES → STOP. Do not include this threat.
  - If NO → Continue to Check 2
- IF no assumptions provided → Continue to Check 2

**CHECK 2: Actor Verification**
- Find the threat actor in <data_flow> threat_sources
- Ask: "Is this EXACT actor listed?"
- If NO → STOP. Do not include this threat.
- If YES → Continue to Check 3

**CHECK 3: Control Boundary Test**
- Identify who can mitigate this threat
- Ask: "Can the CUSTOMER implement controls?"
- If NO → STOP. Do not include this threat.
- If YES → Continue to Check 4

**CHECK 4: Architectural Feasibility**
- Trace the threat through the architecture
- Ask: "Is this attack path technically possible?"
- If NO → STOP. Do not include this threat.
- If YES → Continue to Check 5

**CHECK 5: STRIDE Appropriateness**
- Evaluate the STRIDE category assignment
- Ask: "Does this category naturally fit this threat?"
- If NO → Recategorize or exclude
- If YES → Proceed to format the threat

Only threats passing ALL checks should be included.
</threat_validation_sequence>

<assumption_handling>
**When assumptions ARE provided:**
- Treat them as hard constraints that define security boundaries
- They represent decisions already made by the system owner
- Never generate threats that contradict stated assumptions
- Use assumptions to calibrate threat sophistication and likelihood
- Example: If "internal network is trusted" → exclude internal network attack threats

**When assumptions are NOT provided:**
- Apply security best practices and industry standards
- Consider common threat scenarios for the architecture type
- Include broader range of plausible threats
- Document your implicit assumptions in the output
- Be more comprehensive in coverage

**Why assumptions matter when present:**
Assumptions reflect implemented security controls, accepted risks, and organizational decisions. Ignoring them creates noise and recommendations that cannot or will not be implemented.
</assumption_handling>

<shared_responsibility_boundaries>
**Customer CAN control:**
- Their application code and configuration
- Data classification and access policies  
- Identity and access management settings
- Network security groups and firewall rules they configure
- Encryption key management (when customer-managed)
- API usage and integration patterns

**Customer CANNOT control (never create threats for):**
- Cloud provider infrastructure vulnerabilities
- Hypervisor security (IaaS)
- Platform runtime security (PaaS)
- SaaS application code security
- Physical datacenter security
- Provider-managed service internals

**Example Applications:**
- ✅ RIGHT: "Attacker can exploit misconfigured S3 bucket permissions"
- ❌ WRONG: "AWS S3 service could be compromised"
- ✅ RIGHT: "Attacker can bypass poorly configured IAM policies"
- ❌ WRONG: "Azure AD service could have vulnerabilities"
</shared_responsibility_boundaries>

<stride_methodology>
Apply STRIDE categories WHERE THEY NATURALLY FIT:

**Spoofing** - Identity/authentication compromise
- Apply when: Authentication mechanisms exist
- Skip when: No identity concept

**Tampering** - Unauthorized modification
- Apply when: Data integrity matters
- Skip when: Read-only/stateless

**Repudiation** - Denying actions
- Apply when: Audit requirements exist
- Skip when: No accountability needed

**Information Disclosure** - Unauthorized data access
- Apply when: Sensitive data exists
- Skip when: Only public data

**Denial of Service** - Availability attacks
- Apply when: Availability is critical
- Skip when: Non-critical/redundant

**Elevation of Privilege** - Unauthorized permission gain
- Apply when: Authorization boundaries exist
- Skip when: No privilege hierarchy

DO NOT force every category on every component.
</stride_methodology>

<threat_grammar_template>
**EXACT Format Required:**
"[source from data_flow] [prerequisites if applicable] can [specific attack action] which leads to [measurable impact], negatively impacting [identified assets]"

**Good Examples:**

*Simple threat (no prerequisites):*
"External attacker can exploit misconfigured API Gateway rate limits which leads to service unavailability, negatively impacting Customer Portal and API Services"

*Threat with prerequisites:*
"Malicious insider [after obtaining database credentials] can exfiltrate customer PII which leads to data breach, negatively impacting Customer Database and Backup Storage"

*Threat showing chain dependency:*
"External attacker [having compromised user session] can escalate privileges through IDOR vulnerability which leads to unauthorized administrative access, negatively impacting Admin Console"

**Bad Example:**
"Someone might attack the system somehow causing problems"

**Prerequisites Format:**
- Use square brackets: [prerequisite condition]
- Place immediately after source
- Be specific about what must happen first
- Example: [after successful phishing attack], [with stolen API keys], [having gained network access]

**Chain Dependencies:**
When documenting attack chains, use prerequisites to show relationships:
- Initial access threat: No prerequisites
- Follow-on threat: Include prerequisite in square brackets
- This creates clear attack chain visibility
</threat_grammar_template>

<mitigation_requirements>
Provide controls that are:

1. **Customer-implementable**
   - Within their control boundary
   - Using available tools
   - No provider changes needed

2. **Balanced control types:**
   - Preventive: Stop the attack
   - Detective: Identify the attack
   - Corrective: Respond to the attack

3. **Proportionate severity:**
   - High: Multiple layered controls
   - Medium: Standard controls
   - Low: Basic controls

**Format:**
"Implement [specific control] to [prevent/detect/correct] this threat. Configuration: [key settings]"
</mitigation_requirements>

<attack_chain_analysis>
**Identify and document:**
1. Initial access threats (entry points)
2. Lateral movement threats (propagation)
3. Privilege escalation threats (elevation)
4. Impact threats (final objectives)

**Chain Documentation:**
- Mark prerequisites: "Requires: [previous threat ID]"
- Mark enablers: "Enables: [subsequent threat IDs]"
- Note broken chains: "Gap: No threat covers [missing link]"

**Critical Chains to Always Consider:**
- Credential theft → Lateral movement → Data access
- Configuration change → Privilege escalation → System compromise
- Service account compromise → API abuse → Data exfiltration
</attack_chain_analysis>


<quality_checklist>
Before finalizing ANY threat:

□ Threat actor is EXACTLY from <data_flow> threat_sources
□ IF assumptions exist, respects EVERY assumption
□ Customer can implement the mitigations
□ Architecturally possible given the components
□ STRIDE category makes logical sense
□ Follows exact grammar template
□ Attack chain relationships documented
□ Not a duplicate of existing threats
□ Provides genuine security value

If ANY check fails → EXCLUDE that item
</quality_checklist>

<contextual_adaptation>
**With assumptions provided:**
- Use them as strict boundaries
- Generate focused, assumption-compliant threats
- Skip areas marked as trusted or out-of-scope
- Reference specific assumptions in your analysis

**Without assumptions provided:**
- Apply security best practices
- Consider broader threat landscape
- Include defense-in-depth scenarios
- Note implicit assumptions you're making
- Be more comprehensive in coverage

**Example adaptation:**
- With assumption "MFA implemented": Focus on MFA bypass techniques
- Without assumption: Include both single-factor and MFA-related threats
</contextual_adaptation>

<continuous_improvement>
**Track and Learn:**
- Document why threats were excluded (assumption violations when applicable)
- Note patterns in gaps (common missing controls)
- Identify recurring assumption conflicts (when provided)
- Flag areas where shared responsibility is unclear

**Feedback Integration:**
When previous analyses provided:
- Check if prior gaps were addressed
- Verify assumptions haven't changed (if provided in both)
- Confirm threat sources remain accurate
- Update attack chains with new threats
</continuous_improvement>

<output_quality_standards>
**Your output will be rejected if it:**
- Includes threats violating provided assumptions
- Uses threat actors not in data flows
- Suggests customer-uncontrollable mitigations
- Forces inappropriate STRIDE categories
- Contains architecturally impossible threats

**Your output will be valued if it:**
- Respects all constraints perfectly
- Handles presence/absence of assumptions appropriately
- Identifies genuine, exploitable risks
- Provides clear, actionable mitigations
- Documents attack chain relationships
- Focuses on quality over quantity
</output_quality_standards>

</threat_modeling_instructions>

*When you believe the catalog is comprehensive, stop using tools and respond that you are done with the process*
You have access to:
<descriptions>${t.description||""}</descriptions>
<assumptions>${JSON.stringify(t.assumptions||[])}</assumptions>
<identified_assets_and_entities>${JSON.stringify(t.assets)}</identified_assets_and_entities>
<data_flows>${JSON.stringify(t.system_architecture)}</data_flows>
`;return t.instructions&&(r+=`

Additional Instructions:
${t.instructions}`),r}const Tr={START:"START",ASSETS:"ASSETS",FLOW:"FLOW",THREAT:"THREAT",THREAT_RETRY:"THREAT_RETRY",FINALIZE:"FINALIZE",COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"},Au=0,SA=1,JB=15;function an(t,e){var r;if((r=t==null?void 0:t.signal)!=null&&r.aborted){console.log(`Workflow aborted, skipping ${e}`);const n=new Error("AbortError");throw n.name="AbortError",n}}function Ft(t){const e=ee.getJobStatus(t);return(e==null?void 0:e.state)===Tr.CANCELLED}function bd(t){if(t.content&&Array.isArray(t.content)&&t.content.length>0){const e=t.content[0];if(e&&typeof e=="object"){const r=e.reasoning_content;if(r&&r.text)return r.text}}if(t.additional_kwargs){const e=t.additional_kwargs.reasoning_content;if(e)return typeof e=="string"?e:e.text||null}return null}async function ZB(t,e){var n;if(console.log("Node: generateSummary"),an(e,"generateSummary"),t.summary)return console.log("Summary already exists, skipping generation"),{image_data:t.image_data};const r=t.job_id||"unknown";try{if(Ft(r)){console.log(`Job ${r} was cancelled, aborting generateSummary`);const f=new Error("AbortError");throw f.name="AbortError",f}const i=new Fi(t.image_data,t.description||"",zi(t.assumptions||[])).createSummaryMessage(40),o=[new dt({content:VB()}),i],c=(n=e.configurable)==null?void 0:n.model_summary;if(!c){const f=new Error("Summary model not found in config");throw console.error("Configuration error:",f.message),f}const l=bn(async f=>f,{name:"summary_state",description:"Generate a summary of the architecture",schema:kB}),u=c.bindTools([l]);console.log(`Invoking summary model for job ${r}`);const d=await u.invoke(o);if(an(e,"generateSummary (after model invocation)"),Ft(r)){console.log(`Job ${r} was cancelled during model invocation`);const f=new Error("AbortError");throw f.name="AbortError",f}const h=d.tool_calls[0].args;return console.log(`Summary generated successfully for job ${r}`),{image_data:t.image_data,summary:h.summary}}catch(s){if(s.name==="AbortError"||s.message==="AbortError")console.log(`generateSummary aborted for job ${r}`);else if(console.error(`Error in generateSummary for job ${r}:`,s),console.error("Error details:",{name:s.name,message:s.message}),!Ft(r))try{ee.setJobStatus(r,Tr.FAILED,t.retry||0)}catch(a){console.error(`Failed to update job status for ${r}:`,a)}throw s}}async function KB(t,e){var n,s;console.log("Node: defineAssets"),an(e,"defineAssets");const r=t.job_id||"unknown";try{if(Ft(r)){console.log(`Job ${r} was cancelled, aborting defineAssets`);const _=new Error("AbortError");throw _.name="AbortError",_}ee.setJobStatus(r,Tr.ASSETS,t.retry||0);const a=new Fi(t.image_data,t.description||"",zi(t.assumptions||[])).createAssetMessage(),c=[new dt({content:qB()}),a],l=(n=e.configurable)==null?void 0:n.model_assets;if(!l){const _=new Error("Assets model not found in config");throw console.error("Configuration error:",_.message),_}const u=((s=e.configurable)==null?void 0:s.reasoning)||0,d=bn(async _=>_,{name:"assets_list",description:"Define the list of system assets",schema:RB}),h=l.model||"",f=h.startsWith("gpt-")||h.startsWith("o1-"),m=h.includes("sonnet");let g;f?g=l.bindTools([d],{tool_choice:"assets_list"}):m?u>0?g=l.bindTools([d]):g=l.bindTools([d],{tool_choice:"any"}):g=l.bindTools([d]),console.log(`Invoking assets model for job ${r}`);const y=await g.invoke(c);if(an(e,"defineAssets (after model invocation)"),Ft(r)){console.log(`Job ${r} was cancelled during model invocation`);const _=new Error("AbortError");throw _.name="AbortError",_}const b=y.tool_calls[0].args;if(u>0){const _=bd(y);_&&ee.updateJobTrail(r,{assets:_})}return console.log(`Assets defined successfully for job ${r}`),{assets:b}}catch(i){if(i.name==="AbortError"||i.message==="AbortError")console.log(`defineAssets aborted for job ${r}`);else if(console.error(`Error in defineAssets for job ${r}:`,i),console.error("Error details:",{name:i.name,message:i.message}),!Ft(r))try{ee.setJobStatus(r,Tr.FAILED,t.retry||0)}catch(o){console.error(`Failed to update job status for ${r}:`,o)}throw i}}async function XB(t,e){var n,s;console.log("Node: defineFlows"),an(e,"defineFlows");const r=t.job_id||"unknown";try{if(Ft(r)){console.log(`Job ${r} was cancelled, aborting defineFlows`);const _=new Error("AbortError");throw _.name="AbortError",_}ee.setJobStatus(r,Tr.FLOW,t.retry||0);const a=new Fi(t.image_data,t.description||"",zi(t.assumptions||[])).createSystemFlowsMessage(t.assets),c=[new dt({content:HB()}),a],l=(n=e.configurable)==null?void 0:n.model_flows;if(!l){const _=new Error("Flows model not found in config");throw console.error("Configuration error:",_.message),_}const u=((s=e.configurable)==null?void 0:s.reasoning)||0,d=bn(async _=>_,{name:"flows_list",description:"Define data flows, trust boundaries, and threat sources",schema:PB}),h=l.model||"",f=h.startsWith("gpt-")||h.startsWith("o1-"),m=h.includes("sonnet");let g;f?g=l.bindTools([d],{tool_choice:"flows_list"}):m?u>0?g=l.bindTools([d]):g=l.bindTools([d],{tool_choice:"any"}):g=l.bindTools([d]),console.log(`Invoking flows model for job ${r}`);const y=await g.invoke(c);if(an(e,"defineFlows (after model invocation)"),Ft(r)){console.log(`Job ${r} was cancelled during model invocation`);const _=new Error("AbortError");throw _.name="AbortError",_}const b=y.tool_calls[0].args;if(u>0){const _=bd(y);_&&ee.updateJobTrail(r,{flows:_})}return console.log(`Flows defined successfully for job ${r}`),{system_architecture:b}}catch(i){if(i.name==="AbortError"||i.message==="AbortError")console.log(`defineFlows aborted for job ${r}`);else if(console.error(`Error in defineFlows for job ${r}:`,i),console.error("Error details:",{name:i.name,message:i.message}),!Ft(r))try{ee.setJobStatus(r,Tr.FAILED,t.retry||0)}catch(o){console.error(`Failed to update job status for ${r}:`,o)}throw i}}async function YB(t,e){var a,o,c;console.log("Node: defineThreats"),an(e,"defineThreats");const r=t.job_id||"unknown",n=parseInt(t.retry||0),s=parseInt(t.iteration||0),i=((a=e.configurable)==null?void 0:a.max_retry)||JB;try{if(Ft(r)){console.log(`Job ${r} was cancelled, aborting defineThreats`);const pe=new Error("AbortError");throw pe.name="AbortError",pe}const l=n>=i,u=n>=s&&s!==0;if(l||u)return console.log(`Iteration limit reached for job ${r} (retry: ${n}, iteration: ${s}, max: ${i})`),ee.setJobStatus(r,Tr.FINALIZE,n),new rt({goto:"finalize"});const d=n+1;n>0?ee.setJobStatus(r,Tr.THREAT_RETRY,d):ee.setJobStatus(r,Tr.THREAT,d);const h=t.gap||[],f=t.threat_list,m=(f==null?void 0:f.threats)||[],g=new Fi(t.image_data,t.description||"",zi(t.assumptions||[]));let y,b;n>0||m.length>0?(y=g.createThreatImproveMessage(t.assets,t.system_architecture,t.threat_list,h),t.replay&&t.instructions?b=new dt({content:Ll(t.instructions)}):b=new dt({content:Ll()})):(y=g.createThreatMessage(t.assets,t.system_architecture),t.replay&&t.instructions?b=new dt({content:GB(t.instructions)}):b=new dt({content:Ll()}));const _=[b,y],E=(o=e.configurable)==null?void 0:o.model_threats;if(!E)throw new Error("Threats model not found in config");const C=((c=e.configurable)==null?void 0:c.reasoning)||0,k=bn(async pe=>pe,{name:"threats_list",description:"Define the list of security threats",schema:wA}),R=E.model||"",$=R.startsWith("gpt-")||R.startsWith("o1-"),S=R.includes("sonnet");let M;$?M=E.bindTools([k],{tool_choice:"threats_list"}):S?C>0?M=E.bindTools([k]):M=E.bindTools([k],{tool_choice:"any"}):M=E.bindTools([k]),console.log(`Invoking threats model for job ${r} (iteration ${n+1})`);const B=await M.invoke(_);if(an(e,"defineThreats (after model invocation)"),Ft(r)){console.log(`Job ${r} was cancelled during model invocation`);const pe=new Error("AbortError");throw pe.name="AbortError",pe}const q=B.tool_calls[0].args;if(C>0){const pe=bd(B);pe&&((n===0?Au:SA)===Au?ee.updateJobTrail(r,{threats:[pe]}):ee.updateJobTrail(r,{threats:pe}))}const se=n+1;return s===0?(console.log(`Job ${r}: Auto mode (iteration 0), routing to gap analysis`),new rt({goto:"gap_analysis",update:{threat_list:q,retry:se}})):(console.log(`Job ${r}: Fixed iteration mode, looping back to threats`),new rt({goto:"define_threats",update:{threat_list:q,retry:se}}))}catch(l){if(l.name==="AbortError"||l.message==="AbortError")console.log(`defineThreats aborted for job ${r}`);else if(console.error(`Error in defineThreats for job ${r}:`,l),console.error("Error details:",{name:l.name,message:l.message}),!Ft(r))try{ee.setJobStatus(r,Tr.FAILED,t.retry||0)}catch(d){console.error(`Failed to update job status for ${r}:`,d)}throw l}}async function QB(t,e){var n,s;console.log("Node: gapAnalysis"),an(e,"gapAnalysis");const r=t.job_id||"unknown";try{if(Ft(r)){console.log(`Job ${r} was cancelled, aborting gapAnalysis`);const _=new Error("AbortError");throw _.name="AbortError",_}const a=new Fi(t.image_data,t.description||"",zi(t.assumptions||[])).createGapAnalysisMessage(t.assets,t.system_architecture,t.threat_list||"",t.gap||[]);let o;t.replay&&t.instructions?o=new dt({content:Tu(t.instructions)}):o=new dt({content:Tu()});const c=[o,a],l=(n=e.configurable)==null?void 0:n.model_gaps;if(!l){const _=new Error("Gaps model not found in config");throw console.error("Configuration error:",_.message),_}const u=((s=e.configurable)==null?void 0:s.reasoning)||0,d=bn(async _=>_,{name:"continue_threat_modeling",description:"Analyze gaps and decide whether to continue threat modeling",schema:bA}),h=l.model||"",f=h.startsWith("gpt-")||h.startsWith("o1-"),m=h.includes("sonnet");let g;f?g=l.bindTools([d],{tool_choice:"continue_threat_modeling"}):m?u>0?g=l.bindTools([d]):g=l.bindTools([d],{tool_choice:"any"}):g=l.bindTools([d]),console.log(`Invoking gap analysis model for job ${r}`);const y=await g.invoke(c);if(an(e,"gapAnalysis (after model invocation)"),Ft(r)){console.log(`Job ${r} was cancelled during model invocation`);const _=new Error("AbortError");throw _.name="AbortError",_}const b=y.tool_calls[0].args;if(u>0){const _=bd(y);_&&((parseInt(t.retry||0)===0?Au:SA)===Au?ee.updateJobTrail(r,{gaps:[_]}):ee.updateJobTrail(r,{gaps:_}))}return b.stop?(console.log(`Job ${r}: Gap analysis determined to stop, routing to finalize`),new rt({goto:"finalize"})):(console.log(`Job ${r}: Gap analysis determined to continue, routing to define_threats`),new rt({goto:"define_threats",update:{gap:[b.gap]}}))}catch(i){if(i.name==="AbortError"||i.message==="AbortError")console.log(`gapAnalysis aborted for job ${r}`);else if(console.error(`Error in gapAnalysis for job ${r}:`,i),console.error("Error details:",{name:i.name,message:i.message}),!Ft(r))try{ee.setJobStatus(r,Tr.FAILED,t.retry||0)}catch(o){console.error(`Failed to update job status for ${r}:`,o)}throw i}}async function ej(t,e){console.log("Node: finalize"),an(e,"finalize");const r=t.job_id||"unknown";try{if(Ft(r)){console.log(`Job ${r} was cancelled before finalization, aborting`);const i=new Error("AbortError");throw i.name="AbortError",i}const n=parseInt(t.retry||0);console.log(`Finalizing job ${r} with ${n} completed iterations`),ee.setJobStatus(r,Tr.FINALIZE,n);const s={job_id:r,s3_location:t.s3_location||"",owner:t.owner||"LIGHTNING_USER",title:t.title||"",summary:t.summary||"",description:t.description||"",assumptions:t.assumptions||[],assets:t.assets||null,system_architecture:t.system_architecture||null,threat_list:t.threat_list||null,retry:n,backup:null,completed_at:new Date().toISOString()};if(ee.setJobResults(r,s),await new Promise(i=>setTimeout(i,1e3)),an(e,"finalize (before completion)"),Ft(r)){console.log(`Job ${r} was cancelled during finalization delay`);const i=new Error("AbortError");throw i.name="AbortError",i}return ee.setJobStatus(r,Tr.COMPLETE,n),console.log(`Job ${r} completed successfully`),{}}catch(n){if(n.name==="AbortError"||n.message==="AbortError")console.log(`finalize aborted for job ${r} - job was cancelled`);else if(console.error(`Error in finalize for job ${r}:`,n),console.error("Error details:",{name:n.name,message:n.message}),!Ft(r))try{ee.setJobStatus(r,Tr.FAILED,t.retry||0);const i=ee.getJobResults(r)||{};ee.setJobResults(r,{...i,error:n.message||"Finalization failed",error_type:n.name||"Error",failed_at:new Date().toISOString()})}catch(i){console.error(`Failed to update job status for ${r}:`,i)}throw n}}function tj(t){if(console.log("Routing: routeReplay"),!t.replay)return"full";const e=t.job_id||"unknown";try{ee.updateJobTrail(e,{threats:[],gaps:[]});const r=ee.getJobResults(e);if(r&&r.backup){const n={...r,assets:r.backup.assets,system_architecture:r.backup.system_architecture,threat_list:r.backup.threat_list};ee.setJobResults(e,n)}return"replay"}catch(r){return console.error("Error in routeReplay:",r),"full"}}function rj(t){return console.log("Node: threatsRouter"),{}}function nj(t){console.log("Routing: routeThreatsByIteration");const e=parseInt(t.iteration||0);return e===0?(console.log(`Routing to threats_subgraph (Auto mode, iteration=${e})`),"threats_subgraph"):(console.log(`Routing to define_threats (Traditional mode, iteration=${e})`),"define_threats")}const xA=t=>Array.isArray(t)&&t.every(St),sj=t=>typeof t=="object"&&t!=null&&"messages"in t&&xA(t.messages),ij=t=>typeof t=="object"&&t!=null&&"lg_tool_call"in t;var aj=class extends ei{constructor(e,r){const{name:n,tags:s,handleToolErrors:i}=r??{};super({name:n,tags:s,func:(a,o)=>this.run(a,o)});p(this,"tools");p(this,"handleToolErrors",!0);p(this,"trace",!1);this.tools=e,this.handleToolErrors=i??this.handleToolErrors}async runTool(e,r){const n=this.tools.find(s=>s.name===e.name);try{if(n===void 0)throw new Error(`Tool "${e.name}" not found.`);const s=await n.invoke({...e,type:"tool_call"},r);return St(s)&&s.getType()==="tool"||Xt(s)?s:new fr({status:"success",name:n.name,content:typeof s=="string"?s:JSON.stringify(s),tool_call_id:e.id})}catch(s){if(!this.handleToolErrors||fi(s))throw s;return new fr({status:"error",content:`Error: ${s.message}
 Please fix your mistakes.`,name:e.name,tool_call_id:e.id??""})}}async run(e,r){var a;let n;if(ij(e))n=[await this.runTool(e.lg_tool_call,r)];else{let o;if(xA(e))o=e;else if(sj(e))o=e.messages;else throw new Error("ToolNode only accepts BaseMessage[] or { messages: BaseMessage[] } as input.");const c=new Set(o.filter(u=>u.getType()==="tool").map(u=>u.tool_call_id));let l;for(let u=o.length-1;u>=0;u-=1){const d=o[u];if(ms(d)){l=d;break}}if(l==null||!ms(l))throw new Error("ToolNode only accepts AIMessages as input.");n=await Promise.all(((a=l.tool_calls)==null?void 0:a.filter(u=>u.id==null||!c.has(u.id)).map(u=>this.runTool(u,r)))??[])}if(!n.some(Xt))return Array.isArray(e)?n:{messages:n};const s=[];let i=null;for(const o of n)Xt(o)?o.graph===rt.PARENT&&Array.isArray(o.goto)&&o.goto.every(c=>Rr(c))?i?i.goto.push(...o.goto):i=new rt({graph:rt.PARENT,goto:o.goto}):s.push(o):s.push(Array.isArray(e)?[o]:{messages:[o]});return i&&s.push(i),s}};De.Root({llmInputMessages:De({reducer:(t,e)=>Qg([],e),default:()=>[]})});const io={START:"START",ASSETS:"ASSETS",FLOW:"FLOW",THREAT:"THREAT",THREAT_RETRY:"THREAT_RETRY",FINALIZE:"FINALIZE",COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"};function tl(t){return new Promise(e=>setTimeout(e,t))}function es(t,e){var r;if((r=t==null?void 0:t.signal)!=null&&r.aborted){console.log(`Workflow aborted, skipping ${e}`);const n=new Error("AbortError");throw n.name="AbortError",n}}function rl(t){const e=ee.getJobStatus(t);return(e==null?void 0:e.state)===io.CANCELLED}function TA(t){const e=bn(async(i,a)=>{var g;console.log("Tool: add_threats invoked"),es(a,"add_threats");const o=t.tool_use||0,c=t.gap_tool_use||0,l=t.job_id||"unknown",u=t.retry||0;if(rl(l)){console.log(`Job ${l} was cancelled, aborting add_threats`);const y=new Error("AbortError");throw y.name="AbortError",y}if(o>=Vb){if(c<If){const y="You must call gap_analysis to verify the current threat model status before adding more threats.";return console.warn("Tool usage limit exceeded - gap_analysis required",{tool:"add_threats",currentUsage:o,gapToolUse:c}),y}else if(c>=If){const y="You have consumed all your tool calls. You can only delete threats or proceed to finish.";return console.warn("All tool calls consumed",{tool:"add_threats",currentUsage:o,gapToolUse:c}),y}}const d=i.threats.map(y=>({...y,starred:!1})),h=d.length,f=`${h} threats added to catalog`;ee.setJobStatus(l,io.THREAT,u,f),await tl(5e3),es(a,"add_threats");const m=Vb-(o+1);return console.log(`Added ${h} threats to catalog for job ${l}`,{remainingInvocations:m}),new rt({update:{threat_list:{threats:d},tool_use:o+1,messages:[new fr({content:`Successfully added: ${h} threats.`,tool_call_id:(g=a.toolCall)==null?void 0:g.id})]}})},{name:"add_threats",description:"Used to add new threats to the existing catalog",schema:wA}),r=bn(async(i,a)=>{var g;console.log("Tool: remove_threat invoked"),es(a,"remove_threat");const o=t.threat_list||{threats:[]},c=t.tool_use||0,l=t.job_id||"unknown",u=t.retry||0;if(rl(l)){console.log(`Job ${l} was cancelled, aborting remove_threat`);const y=new Error("AbortError");throw y.name="AbortError",y}const d=new Set(i.threats),h=o.threats.filter(y=>!d.has(y.name)),f=o.threats.length-h.length,m=`${f} threats deleted from catalog`;return ee.setJobStatus(l,io.THREAT,u,m),await tl(5e3),es(a,"remove_threat"),console.log(`Removed ${f} threats from catalog for job ${l}`),new rt({update:{threat_list:{threats:h,__overwrite:!0},messages:[new fr({content:`Successfully removed ${f} threats from the catalog`,tool_call_id:(g=a.toolCall)==null?void 0:g.id})]}})},{name:"remove_threat",description:"Used to delete threats from the existing catalog",schema:jt({threats:Bs(it()).describe("List of threat names to remove")})}),n=bn(async(i,a)=>{console.log("Tool: read_threat_catalog invoked"),es(a,"read_threat_catalog");const o=t.threat_list||{threats:[]},c=t.job_id||"unknown",l=t.retry||0;if(rl(c)){console.log(`Job ${c} was cancelled, aborting read_threat_catalog`);const f=new Error("AbortError");throw f.name="AbortError",f}ee.setJobStatus(c,io.THREAT,l,"Reviewing catalog"),await tl(5e3),es(a,"read_threat_catalog");const d=i.verbose||!1;let h="";return o.threats.length===0?h="The threat catalog is currently empty. No threats have been added yet.":d?(h=`Current Threat Catalog (${o.threats.length} threats):

`,o.threats.forEach((f,m)=>{h+=`${m+1}. ${f.name}
`,h+=`   STRIDE Category: ${f.stride_category}
`,h+=`   Description: ${f.description}
`,h+=`   Target: ${f.target}
`,h+=`   Impact: ${f.impact}
`,h+=`   Likelihood: ${f.likelihood}
`,h+=`   Source: ${f.source}
`,h+=`   Vector: ${f.vector}
`,h+=`   Prerequisites: ${f.prerequisites.join(", ")}
`,h+=`   Mitigations: ${f.mitigations.join("; ")}

`})):(h=`Current Threat Catalog (${o.threats.length} threats):
`,o.threats.forEach((f,m)=>{h+=`${m+1}. ${f.name}
`})),console.log(`Read catalog for job ${c}: ${o.threats.length} threats`),h},{name:"read_threat_catalog",description:"Read and retrieve the current list of threats from the catalog",schema:jt({verbose:gg().optional().describe("Whether to include detailed threat information")})}),s=bn(async(i,a)=>{var d,h,f,m,g,y,b,_,E,C,k,R,$;console.log("Tool: gap_analysis invoked"),es(a,"gap_analysis");const o=t.gap_tool_use||0,c=t.job_id||"unknown",l=t.retry||0;if(rl(c)){console.log(`Job ${c} was cancelled, aborting gap_analysis`);const S=new Error("AbortError");throw S.name="AbortError",S}if(o>=If){const S="You have consumed all your tool calls. You can only delete threats or proceed to finish.";return console.warn("Gap analysis limit exceeded",{tool:"gap_analysis",currentUsage:o}),S}ee.setJobStatus(c,io.THREAT,l,"Reviewing for gaps");try{let S=null;const M=t.system_architecture;M&&M.threat_sources&&M.threat_sources.length>0&&(S=M.threat_sources.map(A=>A.category).map(A=>`  - ${A}`).join(`
`));const q=new Fi(t.image_data,t.description||"",zi(t.assumptions||[])).createGapAnalysisMessage(t.assets,t.system_architecture,t.threat_list||"",t.gap||[]);let se;t.replay&&t.instructions?se=new dt({content:Tu(t.instructions,S)}):se=new dt({content:Tu(null,S)});const pe=[se,q],j=(d=a.configurable)==null?void 0:d.model_gaps;if(!j){const V="Gap analysis model not configured. Please proceed without gap analysis or configure the model.";return console.error("Gap analysis model not found in config"),V}const z=bn(async V=>V,{name:"continue_threat_modeling",description:"Analyze gaps and decide whether to continue threat modeling",schema:bA}),G=j.model||"",ie=G.startsWith("gpt-")||G.startsWith("o1-"),ce=G.includes("sonnet"),te=((h=a.configurable)==null?void 0:h.reasoning)||0;let le;ie?le=j.bindTools([z],{tool_choice:"continue_threat_modeling"}):ce?te>0?le=j.bindTools([z]):le=j.bindTools([z],{tool_choice:"any"}):le=j.bindTools([z]),console.log(`Invoking gap analysis model for job ${c}`);let Ee;try{Ee=await le.invoke(pe)}catch(V){return console.error(`Model invocation error in gap_analysis for job ${c}:`,{name:V.name,message:V.message,provider:j.model||"unknown",counters_reset:!1}),(f=V.message)!=null&&f.includes("rate limit")||(m=V.message)!=null&&m.includes("throttl")||V.status===429?"Gap analysis is temporarily unavailable due to rate limiting. Please proceed without gap analysis or try again later.":(g=V.message)!=null&&g.includes("authentication")||(y=V.message)!=null&&y.includes("unauthorized")||(b=V.message)!=null&&b.includes("invalid api key")||V.status===401||V.status===403?"Gap analysis failed due to authentication error. Please check your API credentials and proceed without gap analysis.":(_=V.message)!=null&&_.includes("timeout")||(E=V.message)!=null&&E.includes("timed out")||V.code==="ETIMEDOUT"?"Gap analysis request timed out. Please proceed without gap analysis or try again.":(C=V.message)!=null&&C.includes("content policy")||(k=V.message)!=null&&k.includes("safety")||(R=V.message)!=null&&R.includes("inappropriate")?"Gap analysis was blocked by content policy filters. Please proceed without gap analysis.":`Gap analysis failed: ${V.message||"Unknown error"}. Please proceed without gap analysis or try again.`}if(es(a,"gap_analysis"),!Ee.tool_calls||Ee.tool_calls.length===0)return console.error(`No tool calls in gap analysis response for job ${c}`,{counters_reset:!1}),"Gap analysis did not return expected results. Please proceed without gap analysis.";const W=Ee.tool_calls[0].args;await tl(5e3),es(a,"gap_analysis"),console.log(`Gap analysis completed for job ${c}:`,W,{tool_use_reset:!0});const X={gap_tool_use:o+1,tool_use:0};W.gap&&(X.gap=[W.gap]);const ae=W.stop?"Gap analysis complete. The threat catalog is comprehensive and no significant gaps were identified.":`Gap analysis identified areas for improvement: ${W.gap}`;return X.messages=[new fr({content:ae,tool_call_id:($=a.toolCall)==null?void 0:$.id})],W.stop?new rt({update:X,goto:"continue"}):new rt({update:X})}catch(S){if(console.error(`Unexpected error in gap_analysis for job ${c}:`,{name:S.name,message:S.message,stack:S.stack,counters_reset:!1}),S.name==="AbortError")throw S;return`Gap analysis encountered an unexpected error. Please proceed without gap analysis. Error: ${S.message}`}},{name:"gap_analysis",description:"Analyze the current threat catalog for gaps and completeness. Maximum 3 invocations allowed.",schema:jt({})});return[e,r,n,s]}async function oj(t){const e=TA(t);return new aj(e).invoke(t)}const cj=TA({}),So={START:"START",ASSETS:"ASSETS",FLOW:"FLOW",THREAT:"THREAT",THREAT_RETRY:"THREAT_RETRY",FINALIZE:"FINALIZE",COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"};function qb(t,e){var r;if((r=t==null?void 0:t.signal)!=null&&r.aborted){console.log(`Workflow aborted, skipping ${e}`);const n=new Error("AbortError");throw n.name="AbortError",n}}function Of(t){const e=ee.getJobStatus(t);return(e==null?void 0:e.state)===So.CANCELLED}function lj(t){const e=new Fi(t.image_data,t.description||"",zi(t.assumptions||[])),r=[],n=t.threat_list;n&&n.threats&&r.push(...n.threats.filter(a=>a.starred));const s=n&&n.threats&&n.threats.length>0,i=e.createThreatAgentMessage(s);if(r.length>0){const a=i.content;let o=`

<starred_threats>
The following threats have been marked as important by the user and must be preserved:
`;for(const c of r)o+=`- ${c.name}: ${c.description}
`;o+="</starred_threats>",Array.isArray(a)?a.push({type:"text",text:o}):i.content=a+o}return i}async function uj(t,e){var s,i,a,o,c,l,u,d,h,f,m;console.log("Node: agentNode (threat subgraph)",{tool_use:t.tool_use||0,gap_tool_use:t.gap_tool_use||0}),qb(e,"agentNode");const r=t.job_id||"unknown",n=t.retry||0;try{if(Of(r)){console.log(`Job ${r} was cancelled, aborting agentNode`);const S=new Error("AbortError");throw S.name="AbortError",S}let g=t.messages||[],y={};if(g.length===0){console.log("Initializing agent messages with system prompt and human message");const S=WB(t),M=new dt({content:S}),B=lj(t);g=[M,B]}ee.setJobStatus(r,So.THREAT,n,"Thinking");const b=(s=e.configurable)==null?void 0:s.model_threats_agent;if(!b)throw new Error("Threats agent model not found in config");const _=b.model||"",E=_.startsWith("gpt-")||_.startsWith("o1-");let C=g;E&&(C=g.map(S=>{var M;if(S._getType&&S._getType()==="ai"&&((M=S.additional_kwargs)!=null&&M.reasoning)){const{reasoning:B,...q}=S.additional_kwargs;return new ht({content:S.content,tool_calls:S.tool_calls,id:S.id,additional_kwargs:q,response_metadata:S.response_metadata})}return S}));const k=b.bindTools(cj,{tool_choice:"auto"});console.log(`Invoking threats agent model for job ${r}`);let R;try{R=await k.invoke(C)}catch(S){if(console.error(`Model invocation error in agentNode for job ${r}:`,{name:S.name,message:S.message,provider:b.model||"unknown"}),(i=S.message)!=null&&i.includes("rate limit")||(a=S.message)!=null&&a.includes("throttl")||S.status===429){const B="The AI model is currently rate limited. Please try again in a few moments.";throw console.error(`Rate limit error for job ${r}: ${B}`),new Error(B)}if((o=S.message)!=null&&o.includes("authentication")||(c=S.message)!=null&&c.includes("unauthorized")||(l=S.message)!=null&&l.includes("invalid api key")||S.status===401||S.status===403){const B="Authentication failed with the AI model provider. Please check your API credentials.";throw console.error(`Authentication error for job ${r}: ${B}`),new Error(B)}if((u=S.message)!=null&&u.includes("timeout")||(d=S.message)!=null&&d.includes("timed out")||S.code==="ETIMEDOUT"){const B="The AI model request timed out. Please try again.";throw console.error(`Timeout error for job ${r}: ${B}`),new Error(B)}if((h=S.message)!=null&&h.includes("content policy")||(f=S.message)!=null&&f.includes("safety")||(m=S.message)!=null&&m.includes("inappropriate")){const B="The request was blocked by content policy filters. Please review your input and try again.";throw console.error(`Content policy error for job ${r}: ${B}`),new Error(B)}const M=`AI model error: ${S.message||"Unknown error occurred"}`;throw console.error(`Generic model error for job ${r}: ${M}`),new Error(M)}if(qb(e,"agentNode (after model invocation)"),Of(r)){console.log(`Job ${r} was cancelled during model invocation`);const S=new Error("AbortError");throw S.name="AbortError",S}if(R.tool_calls&&R.tool_calls.length>0){const S=R.tool_calls[0].name;let M="Processing";switch(S){case"add_threats":M="Adding threats";break;case"remove_threat":M="Deleting threats";break;case"read_threat_catalog":M="Reviewing catalog";break;case"gap_analysis":M="Reviewing for gaps";break;default:M="Processing"}ee.setJobStatus(r,So.THREAT,n,M),console.log(`Agent called tool: ${S}`,{tool_use:t.tool_use||0,gap_tool_use:t.gap_tool_use||0})}const $=(t.messages||[]).length===0?[g[0],g[1],R]:[R];return new rt({update:{messages:$,...y}})}catch(g){if(g.name==="AbortError"||g.message==="AbortError")console.log(`agentNode aborted for job ${r}`);else if(console.error(`Error in agentNode for job ${r}:`,g),console.error("Error details:",{name:g.name,message:g.message,stack:g.stack}),!Of(r))try{ee.setJobStatus(r,So.FAILED,t.retry||0)}catch(b){console.error(`Failed to update job status for ${r}:`,b)}throw g}}function dj(t){console.log("Routing: shouldContinue (threat subgraph)");const e=t.messages;if(!e||e.length===0)return console.log("No messages, routing to continue"),"continue";const r=e[e.length-1];return r.tool_calls&&r.tool_calls.length>0?(console.log(`Agent made ${r.tool_calls.length} tool call(s), routing to tools`),"tools"):(console.log("No tool calls, routing to continue"),"continue")}async function hj(t,e){console.log("Node: continueOrFinish (threat subgraph)");const r=t.job_id||"unknown",n=t.retry||0,s=t.threat_list;if(!s||!s.threats||s.threats.length===0){console.log("Empty catalog detected, routing back to agent with feedback"),console.warn("Empty threat catalog validation failed",{job_id:r,retry:n});const l=new ut({content:"The threat catalog is empty. You must add threats to the catalog using the add_threats tool."});return new rt({goto:"agent",update:{messages:[l]}})}const i=new Set(["Spoofing","Tampering","Repudiation","Information Disclosure","Denial of Service","Elevation of Privilege"]),a=new Set(s.threats.map(l=>l.stride_category)),o=[...i].filter(l=>!a.has(l));if(o.length>0){console.log("Missing STRIDE categories detected, routing back to agent with feedback"),console.warn("STRIDE coverage validation failed",{job_id:r,retry:n,missing_categories:o});const l=new ut({content:`Coverage gaps detected:
- Missing STRIDE categories: ${o.join(", ")}

Please add threats to address these gaps.`});return new rt({goto:"agent",update:{messages:[l]}})}const c=t.gap_tool_use||0;if(c===0){console.log("Gap analysis not performed, routing back to agent with feedback"),console.info("Gap analysis requirement check failed",{job_id:r,retry:n,gap_tool_use:c});const l=new ut({content:"You have not performed gap analysis yet. Please use the gap_analysis tool to validate the completeness of the threat catalog before finishing."});return new rt({goto:"agent",update:{messages:[l]}})}return ee.setJobStatus(r,So.THREAT,n),console.log(`Catalog complete with ${s.threats.length} threats, routing to parent finalize`),new rt({goto:"finalize",update:{threat_list:{...s,__overwrite:!0}},graph:rt.PARENT})}function fj(){console.log("Creating threats subgraph for Auto mode");const t=new _A(DB);t.addNode("agent",uj),t.addNode("tools",oj),t.addNode("continue",hj),t.setEntryPoint("agent"),t.addConditionalEdges("agent",dj,{tools:"tools",continue:"continue"}),t.addEdge("tools","agent");const e=t.compile();return console.log("Threats subgraph compiled successfully"),e}function pj(){console.log("Creating threat modeling workflow...");const t=new _A(MB);return t.addNode("generate_summary",ZB),t.addNode("define_assets",KB),t.addNode("define_flows",XB),t.addNode("threats_router",rj),t.addNode("finalize",ej),t.addNode("define_threats",YB,{ends:["gap_analysis","define_threats","finalize"]}),t.addNode("gap_analysis",QB,{ends:["define_threats","finalize"]}),t.addNode("threats_subgraph",fj()),t.addEdge(et,"generate_summary"),t.addConditionalEdges("generate_summary",tj,{replay:"threats_router",full:"define_assets"}),t.addEdge("define_assets","define_flows"),t.addEdge("define_flows","threats_router"),t.addConditionalEdges("threats_router",nj,{threats_subgraph:"threats_subgraph",define_threats:"define_threats"}),t.addEdge("finalize",ze),console.log("Workflow compiled successfully"),t.compile()}function mj(t){return!!(typeof t=="object"&&t&&"toolSpec"in t)}function Hb(t){if(t.every(fd))return t.map(e=>({toolSpec:{name:e.function.name,description:e.function.description,inputSchema:{json:e.function.parameters}}}));if(t.every(xc))return t.map(e=>({toolSpec:{name:e.name,description:e.description,inputSchema:{json:tn(e.schema)?ar(e.schema):e.schema}}}));if(t.every(mj))return t;throw new Error("Invalid tools passed. Must be an array of StructuredToolInterface, ToolDefinition, or BedrockTool.")}function gj(t,e,r){const n=r.supportsToolChoiceValues??[];let s;if(typeof t=="string")switch(t){case"any":s={any:{}};break;case"auto":s={auto:{}};break;default:{if(!e.find(o=>{var c;return((c=o.toolSpec)==null?void 0:c.name)===t}))throw new Error(`Tool with name ${t} not found in tools list.`);s={tool:{name:t}}}}else s=t;const i=Object.keys(s)[0];if(!n.includes(i)){let a="";throw n.length?a=`Model ${r.model} does not currently support 'tool_choice' of type ${i}. The following 'tool_choice' types are supported: ${n.join(", ")}.`:a=`Model ${r.model} does not currently support 'tool_choice'.`,new Error(`${a} Please seehttps://docs.aws.amazon.com/bedrock/latest/APIReference/API_runtime_ToolChoice.htmlfor the latest documentation on models that support tool choice.`)}return s}function yj(t){if(t.includes("claude-3")||t.includes("claude-4")||t.includes("claude-opus-4")||t.includes("claude-sonnet-4"))return["auto","any","tool"];if(t.includes("mistral-large"))return["auto","any"]}const $f={document(t){switch(t){case"text/csv":return"csv";case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":return"docx";case"text/html":return"html";case"text/markdown":return"md";case"application/pdf":return"pdf";case"text/plain":return"txt";case"application/vnd.ms-excel":return"xls";case"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":return"xlsx";default:return t}},image(t){switch(t){case"image/gif":return"gif";case"image/jpeg":return"jpeg";case"image/png":return"png";case"image/webp":return"webp";default:return t}},video(t){switch(t){case"video/flv":return"flv";case"video/mkv":return"mkv";case"video/mov":return"mov";case"video/mp4":return"mp4";case"video/mpeg":return"mpeg";case"video/mpg":return"mpg";case"video/three_gp":return"three_gp";case"video/webm":return"webm";case"video/wmv":return"wmv";default:return t}}};function _j(t){return{sourceContent:[{text:typeof t.citedText=="string"?t.citedText:""}],location:{documentChunk:{documentIndex:typeof t.source=="string"?Number(t.source):void 0,start:typeof t.startIndex=="number"?t.startIndex:void 0,end:typeof t.endIndex=="number"?t.endIndex:void 0}}}}function wj(t){var n;const e=(n=t.response_metadata)==null?void 0:n.model_provider;function*r(){var s;for(const i of t.contentBlocks)if(i.type==="text")(s=i.annotations)!=null&&s.length?yield{citationsContent:{content:[{text:i.text}],citations:i.annotations.map(_j)}}:yield{text:i.text};else{if(i.type==="audio")continue;if(i.type==="code_interpreter_call")continue;if(i.type==="code_interpreter_result")continue;if(i.type==="file"){const a=$f.document(i.mimeType??"");if(i.data){const o=typeof i.data=="string"?Uint8Array.from(er.from(i.data,"base64")):i.data;yield{document:{name:i.id,format:a,source:{bytes:o}}}}else i.fileId&&i.fileId.startsWith("s3://")&&(yield{document:{name:i.id,format:a,source:{s3Location:{uri:i.fileId}}}})}else if(i.type==="image"){const a=$f.image(i.mimeType??"");if(i.data){const o=typeof i.data=="string"?Uint8Array.from(er.from(i.data,"base64")):i.data;yield{image:{format:a,source:{bytes:o}}}}else i.fileId&&i.fileId.startsWith("s3://")&&(yield{image:{format:a,source:{s3Location:{uri:i.fileId}}}})}else{if(i.type==="invalid_tool_call")continue;if(i.type==="reasoning")yield{reasoningContent:{reasoningText:{text:i.reasoning}}};else{if(i.type==="server_tool_call")continue;if(i.type==="server_tool_call_chunk")continue;if(i.type==="server_tool_call_result")continue;if(i.type==="text-plain")continue;if(i.type==="tool_call")yield{toolUse:{toolUseId:i.id,name:i.name,input:i.args}};else{if(i.type==="tool_call_chunk")continue;if(i.type==="video"){const a=$f.video(i.mimeType??"");if(i.data){const o=typeof i.data=="string"?Uint8Array.from(er.from(i.data,"base64")):i.data;yield{video:{format:a,source:{bytes:o}}}}else i.fileId&&i.fileId.startsWith("s3://")&&(yield{video:{format:a,source:{s3Location:{uri:i.fileId}}}})}else{if(i.type==="web_search_call")continue;if(i.type==="web_search_result")continue;i.type==="non_standard"&&e==="bedrock-converse"&&(yield i)}}}}}}return Array.from(r())}function ey(t){return!!(typeof t=="object"&&t!==null&&"cachePoint"in t&&t.cachePoint&&typeof t.cachePoint=="object"&&t.cachePoint!==null&&"type"in t.cachePoint&&t.cachePoint.type==="default")}function bj(t){const e=t.match(/^data:image\/(\w+);base64,/);let r;if(e){const a=e[1].toLowerCase();["gif","jpeg","png","webp"].includes(a)&&(r=a)}const n=t.replace(/^data:image\/\w+;base64,/,""),s=atob(n),i=new Uint8Array(s.length);for(let a=0;a<s.length;a+=1)i[a]=s.charCodeAt(a);return{image:{format:r,source:{bytes:i}}}}const vj={providerName:"ChatBedrockConverse",fromStandardTextBlock(t){return{text:t.text}},fromStandardImageBlock(t){let e;if(t.source_type==="url"){const r=Ci({dataUrl:t.url,asTypedArray:!0});if(r)return e=mi(r.mime_type).type,{image:{format:e,source:{bytes:r.data}}};throw new Error("Only base64 data URLs are supported for image blocks with source type 'url' with ChatBedrockConverse.")}else if(t.source_type==="base64"){if(t.mime_type&&(e=mi(t.mime_type).subtype),e&&!["gif","jpeg","png","webp"].includes(e))throw new Error(`Unsupported image mime type: "${t.mime_type}" ChatBedrockConverse only supports "image/gif", "image/jpeg", "image/png", and "image/webp" formats.`);return{image:{format:e,source:{bytes:Uint8Array.from(atob(t.data),r=>r.charCodeAt(0))}}}}else throw t.source_type==="id"?new Error("Image source type 'id' not supported with ChatBedrockConverse."):new Error(`Unsupported image source type: "${t.source_type}" with ChatBedrockConverse.`)},fromStandardFileBlock(t){var n,s,i;const e={"text/csv":"csv","application/msword":"doc","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","text/html":"html","text/markdown":"md","application/pdf":"pdf","text/plain":"txt","application/vnd.ms-excel":"xls","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx"},r=((n=t.metadata)==null?void 0:n.name)??((s=t.metadata)==null?void 0:s.filename)??((i=t.metadata)==null?void 0:i.title);if(t.source_type==="text")return{document:{name:r,format:"txt",source:{bytes:new TextEncoder().encode(t.text)}}};if(t.source_type==="url"){const a=Ci({dataUrl:t.url,asTypedArray:!0});if(a){const o=mi(a.mime_type??t.mime_type),c=`${o.type}/${o.subtype}`,l=e[c];return{document:{name:r,format:l,source:{bytes:a.data}}}}throw new Error("Only base64 data URLs are supported for file blocks with source type 'url' with ChatBedrockConverse.")}if(t.source_type==="base64"){let a;if(t.mime_type){const o=mi(t.mime_type),c=`${o.type}/${o.subtype}`;if(a=e[c],a===void 0)throw new Error(`Unsupported file mime type: "${t.mime_type}" ChatBedrockConverse only supports ${Object.keys(e).join(", ")} formats.`)}return{document:{name:r,format:a,source:{bytes:Uint8Array.from(atob(t.data),o=>o.charCodeAt(0))}}}}throw t.source_type==="id"?new Error("File source type 'id' not supported with ChatBedrockConverse."):new Error(`Unsupported file source type: "${t.source_type}" with ChatBedrockConverse.`)}};function AA({block:t,onUnknown:e="throw"}){if(typeof t=="string")return{text:t};if(Sn(t))return Xu(t,vj);if(t.type==="text")return{text:t.text};if(t.type==="image_url")return bj(typeof t.image_url=="string"?t.image_url:t.image_url.url);if(t.type==="document"&&t.document!==void 0)return{document:t.document};if(t.type==="image"&&t.image!==void 0)return{image:t.image};if(ey(t))return{cachePoint:{type:"default"}};if(e==="throw")throw new Error(`Unsupported content block type: ${t.type}`);return t}function Ej(t){if(typeof t.content=="string")return[{text:t.content}];if(Array.isArray(t.content)&&t.content.length>0){const e=[];for(const r of t.content)if(r.type==="text"&&typeof r.text=="string")e.push({text:r.text});else if(ey(r))e.push({cachePoint:{type:"default"}});else break;if(t.content.length===e.length)return e}throw new Error("System message content must be either a string, or an array of text blocks, optionally including a cache point.")}function Sj(t){var r;if(t.response_metadata.response_format==="v1")return{role:"assistant",content:wj(t)};const e={role:"assistant",content:[]};if(typeof t.content=="string"&&t.content!=="")(r=e.content)==null||r.push({text:t.content});else if(Array.isArray(t.content)){const n=Cj(t.content),s=[];n.forEach(i=>{var a;if(i.type==="text"&&i.text!=="")if(((a=i.text)==null?void 0:a.replace(/\n/g,"").trim())===""){if(s.length>0){const c=`${s[s.length-1].text}${i.text}`;s[s.length-1].text=c}}else s.push({text:i.text});else if(i.type==="reasoning_content")s.push({reasoningContent:Aj(i)});else if(ey(i))s.push({cachePoint:{type:"default"}});else{const o=Object.fromEntries(Object.entries(i).filter(([c])=>c!=="type"));throw new Error(`Unsupported content block type: ${i.type} with content of ${JSON.stringify(o,null,2)}`)}}),e.content=[...e.content?e.content:[],...s]}return t.tool_calls&&t.tool_calls.length&&(e.content=[...e.content?e.content:[],...t.tool_calls.map(n=>({toolUse:{toolUseId:n.id,name:n.name,input:n.args}}))]),e}function xj(t){if(t.content==="")throw new Error(`Invalid message content: empty string. '${t.type}' must contain non-empty content.`);return{role:"user",content:(Array.isArray(t.content)?t.content:[t.content]).map(n=>AA({block:n,onUnknown:"throw"}))}}function Tj(t){const e=t;return typeof e.content=="string"?{role:"user",content:[{toolResult:{toolUseId:e.tool_call_id,content:[{text:e.content}]}}]}:{role:"user",content:[{toolResult:{toolUseId:e.tool_call_id,content:t.content.map(r=>{const n=AA({block:r,onUnknown:"returnUnmodified"});return n!==r?n:{json:r}})}}]}}function Gb(t){const e=t.reduce((s,i)=>(dt.isInstance(i)&&s.push(...Ej(i)),s),[]);return{converseMessages:t.filter(s=>!dt.isInstance(s)).map(s=>{if(ht.isInstance(s))return Sj(s);if(ut.isInstance(s)||Kn.isInstance(s))return xj(s);if(fr.isInstance(s))return Tj(s);throw new Error(`Unsupported message type: ${s.type}`)}).reduce((s,i)=>{var o,c;const a=s[s.length-1];return a&&a.role==="user"&&((o=a.content)!=null&&o.some(l=>"toolResult"in l))&&i.role==="user"&&((c=i.content)!=null&&c.some(l=>"toolResult"in l))?a.content=a.content.concat(i.content):s.push(i),s},[]),converseSystem:e}}function Aj(t){if(t.type!=="reasoning_content")throw new Error("Invalid reasoning content");if("reasoningText"in t)return{reasoningText:t.reasoningText};if("redactedContent"in t)return{redactedContent:er.from(t.redactedContent,"base64")};throw new Error("Invalid reasoning content")}function Cj(t){const e=[];let r={};for(const n of t){if(n.type!=="reasoning_content"){Object.keys(r).length>0&&(e.push(r),r={}),e.push(n);continue}if("reasoningText"in n&&typeof n.reasoningText=="object"){"redactedContent"in r&&(e.push(r),r={});const{text:s,signature:i}=n.reasoningText,{text:a,signature:o}="reasoningText"in r?r.reasoningText:{};r={type:"reasoning_content",reasoningText:{...r.reasoningText??{},...a!==void 0||s!==void 0?{text:(a??"")+(s??"")}:{},...o!==void 0||i!==void 0?{signature:(o??"")+(i??"")}:{}}},"signature"in n.reasoningText&&(e.push(r),r={})}if("redactedContent"in n){"reasoningText"in r&&(e.push(r),r={});const{redactedContent:s}=n;r={type:"reasoning_content",redactedContent:("redactedContent"in r?r.redactedContent:"")+s}}}return Object.keys(r).length>0&&e.push(r),e}function kj(t,e){var s;if(!t.content)throw new Error("No message content found in response.");if(t.role!=="assistant")throw new Error(`Unsupported message role received in ChatBedrockConverse response: ${t.role}`);let r;"$metadata"in e&&e.$metadata&&typeof e.$metadata=="object"&&"requestId"in e.$metadata&&(r=e.$metadata.requestId);let n;if(e.usage){const i=e.usage.inputTokens??0,a=e.usage.outputTokens??0;n={input_tokens:i,output_tokens:a,total_tokens:e.usage.totalTokens??i+a}}if(((s=t.content)==null?void 0:s.length)===1&&"text"in t.content[0]&&typeof t.content[0].text=="string")return new ht({content:t.content[0].text,response_metadata:{...e,model_provider:"bedrock-converse"},usage_metadata:n,id:r});{const i=[],a=[];return t.content.forEach(o=>{"cachePoint"in o?a.push({type:"cache_point",cachePoint:o.cachePoint}):"citationsContent"in o?a.push({type:"citations_content",citationsContent:o.citationsContent}):"document"in o?a.push({type:"document",document:o.document}):"guardContent"in o?a.push({type:"guard_content",guardContent:o.guardContent}):"image"in o?a.push({type:"image",image:o.image}):"reasoningContent"in o?a.push(Nj(o.reasoningContent)):"text"in o&&typeof o.text=="string"?a.push({type:"text",text:o.text}):"toolResult"in o?a.push({type:"tool_result",toolResult:o.toolResult}):"toolUse"in o&&o.toolUse&&o.toolUse.name&&o.toolUse.input&&typeof o.toolUse.input=="object"?i.push({id:o.toolUse.toolUseId,name:o.toolUse.name,args:o.toolUse.input,type:"tool_call"}):"video"in o&&a.push({type:"video",video:o.video})}),new ht({content:a.length?a:"",tool_calls:i.length?i:void 0,response_metadata:{...e,model_provider:"bedrock-converse"},usage_metadata:n,id:r})}}function Ij(t){if(!t.delta)throw new Error("No delta found in content block.");if(typeof t.delta.text=="string")return new mr({text:t.delta.text,message:new At({content:t.delta.text})});if(t.delta.toolUse){const e=t.contentBlockIndex;return new mr({text:"",message:new At({content:"",tool_call_chunks:[{args:t.delta.toolUse.input,index:e,type:"tool_call_chunk"}]})})}else{if(t.delta.reasoningContent)return new mr({text:"",message:new At({content:[$j(t.delta.reasoningContent)]})});throw new Error(`Unsupported content block type(s): ${JSON.stringify(t.delta,null,2)}`)}}function Rj(t){var r;const e=t.contentBlockIndex;if((r=t.start)!=null&&r.toolUse)return new mr({text:"",message:new At({content:"",tool_call_chunks:[{name:t.start.toolUse.name,id:t.start.toolUse.toolUseId,index:e,type:"tool_call_chunk"}]})});throw new Error("Unsupported content block start event.")}function Oj(t,e){var i,a,o;const r=((i=t.usage)==null?void 0:i.inputTokens)??0,n=((a=t.usage)==null?void 0:a.outputTokens)??0,s={input_tokens:r,output_tokens:n,total_tokens:((o=t.usage)==null?void 0:o.totalTokens)??r+n};return new mr({text:"",message:new At({content:"",usage_metadata:e.streamUsage?s:void 0,response_metadata:{metadata:t,model_provider:"bedrock-converse"}})})}function $j(t){const{text:e,redactedContent:r,signature:n}=t;if(typeof e=="string")return{type:"reasoning_content",reasoningText:{text:e}};if(n)return{type:"reasoning_content",reasoningText:{signature:n}};if(r)return{type:"reasoning_content",redactedContent:er.from(r).toString("base64")};throw new Error("Invalid reasoning content")}function Nj(t){const{reasoningText:e,redactedContent:r}=t;if(e)return{type:"reasoning_content",reasoningText:e};if(r)return{type:"reasoning_content",redactedContent:er.from(r).toString("base64")};throw new Error("Invalid reasoning content")}function Pj(t){const e=t.signer,r=t.signer,n=Object.assign(t,{eventSigner:e,messageSigner:r}),s=n.eventStreamPayloadHandlerProvider(n);return Object.assign(n,{eventStreamPayloadHandler:s})}const Lj=t=>({setHttpHandler(e){t.httpHandler=e},httpHandler(){return t.httpHandler},updateHttpClientConfig(e,r){var n;(n=t.httpHandler)==null||n.updateHttpClientConfig(e,r)},httpHandlerConfigs(){return t.httpHandler.httpHandlerConfigs()}}),Mj=t=>({httpHandler:t.httpHandler()});var Yo;(function(t){t.HTTP="http",t.HTTPS="https"})(Yo||(Yo={}));var Cu;(function(t){t.MD5="md5",t.CRC32="crc32",t.CRC32C="crc32c",t.SHA1="sha1",t.SHA256="sha256"})(Cu||(Cu={}));const nm="__smithy_context";class Or{constructor(e){p(this,"method");p(this,"protocol");p(this,"hostname");p(this,"port");p(this,"path");p(this,"query");p(this,"headers");p(this,"username");p(this,"password");p(this,"fragment");p(this,"body");this.method=e.method||"GET",this.hostname=e.hostname||"localhost",this.port=e.port,this.query=e.query||{},this.headers=e.headers||{},this.body=e.body,this.protocol=e.protocol?e.protocol.slice(-1)!==":"?`${e.protocol}:`:e.protocol:"https:",this.path=e.path?e.path.charAt(0)!=="/"?`/${e.path}`:e.path:"/",this.username=e.username,this.password=e.password,this.fragment=e.fragment}static clone(e){const r=new Or({...e,headers:{...e.headers}});return r.query&&(r.query=Dj(r.query)),r}static isInstance(e){if(!e)return!1;const r=e;return"method"in r&&"protocol"in r&&"hostname"in r&&"path"in r&&typeof r.query=="object"&&typeof r.headers=="object"}clone(){return Or.clone(this)}}function Dj(t){return Object.keys(t).reduce((e,r)=>{const n=t[r];return{...e,[r]:Array.isArray(n)?[...n]:n}},{})}class Oa{constructor(e){p(this,"statusCode");p(this,"reason");p(this,"headers");p(this,"body");this.statusCode=e.statusCode,this.reason=e.reason,this.headers=e.headers||{},this.body=e.body}static isInstance(e){if(!e)return!1;const r=e;return typeof r.statusCode=="number"&&typeof r.headers=="object"}}const Uj=t=>e=>async r=>{if(!Or.isInstance(r.request))return e(r);const{request:n}=r,{handlerProtocol:s=""}=t.requestHandler.metadata||{};if(s.indexOf("h2")>=0&&!n.headers[":authority"])delete n.headers.host,n.headers[":authority"]=n.hostname+(n.port?":"+n.port:"");else if(!n.headers.host){let i=n.hostname;n.port!=null&&(i+=`:${n.port}`),n.headers.host=i}return e(r)},Bj={name:"hostHeaderMiddleware",step:"build",priority:"low",tags:["HOST"],override:!0},jj=t=>({applyToStack:e=>{e.add(Uj(t),Bj)}}),Fj=()=>(t,e)=>async r=>{var n,s;try{const i=await t(r),{clientName:a,commandName:o,logger:c,dynamoDbDocumentClientOptions:l={}}=e,{overrideInputFilterSensitiveLog:u,overrideOutputFilterSensitiveLog:d}=l,h=u??e.inputFilterSensitiveLog,f=d??e.outputFilterSensitiveLog,{$metadata:m,...g}=i.output;return(n=c==null?void 0:c.info)==null||n.call(c,{clientName:a,commandName:o,input:h(r.input),output:f(g),metadata:m}),i}catch(i){const{clientName:a,commandName:o,logger:c,dynamoDbDocumentClientOptions:l={}}=e,{overrideInputFilterSensitiveLog:u}=l,d=u??e.inputFilterSensitiveLog;throw(s=c==null?void 0:c.error)==null||s.call(c,{clientName:a,commandName:o,input:d(r.input),error:i,metadata:i.$metadata}),i}},zj={name:"loggerMiddleware",tags:["LOGGER"],step:"initialize",override:!0},Vj=t=>({applyToStack:e=>{e.add(Fj(),zj)}}),qj={step:"build",tags:["RECURSION_DETECTION"],name:"recursionDetectionMiddleware",override:!0,priority:"low"},Hj=()=>t=>async e=>t(e),Gj=t=>({applyToStack:e=>{e.add(Hj(),qj)}}),vd=t=>t[nm]||(t[nm]={}),ps=t=>{if(typeof t=="function")return t;const e=Promise.resolve(t);return()=>e},Wj=(t,e)=>{if(!e||e.length===0)return t;const r=[];for(const n of e)for(const s of t)s.schemeId.split("#")[1]===n&&r.push(s);for(const n of t)r.find(({schemeId:s})=>s===n.schemeId)||r.push(n);return r};function Jj(t){const e=new Map;for(const r of t)e.set(r.schemeId,r);return e}const Zj=(t,e)=>(r,n)=>async s=>{var d;const i=t.httpAuthSchemeProvider(await e.httpAuthSchemeParametersProvider(t,n,s.input)),a=t.authSchemePreference?await t.authSchemePreference():[],o=Wj(i,a),c=Jj(t.httpAuthSchemes),l=vd(n),u=[];for(const h of o){const f=c.get(h.schemeId);if(!f){u.push(`HttpAuthScheme \`${h.schemeId}\` was not enabled for this service.`);continue}const m=f.identityProvider(await e.identityProviderConfigProvider(t));if(!m){u.push(`HttpAuthScheme \`${h.schemeId}\` did not have an IdentityProvider configured.`);continue}const{identityProperties:g={},signingProperties:y={}}=((d=h.propertiesExtractor)==null?void 0:d.call(h,t,n))||{};h.identityProperties=Object.assign(h.identityProperties||{},g),h.signingProperties=Object.assign(h.signingProperties||{},y),l.selectedHttpAuthScheme={httpAuthOption:h,identity:await m(h.identityProperties),signer:f.signer};break}if(!l.selectedHttpAuthScheme)throw new Error(u.join(`
`));return r(s)},Kj={step:"serialize",tags:["HTTP_AUTH_SCHEME"],name:"httpAuthSchemeMiddleware",override:!0,relation:"before",toMiddleware:"endpointV2Middleware"},Xj=(t,{httpAuthSchemeParametersProvider:e,identityProviderConfigProvider:r})=>({applyToStack:n=>{n.addRelativeTo(Zj(t,{httpAuthSchemeParametersProvider:e,identityProviderConfigProvider:r}),Kj)}}),Yj=(t,e)=>(r,n)=>async s=>{var a,o,c,l;const{response:i}=await r(s);try{const u=await e(i,t);return{response:i,output:u}}catch(u){if(Object.defineProperty(u,"$response",{value:i}),!("$metadata"in u)){const d="Deserialization error: to see the raw response, inspect the hidden field {error}.$response on this object.";try{u.message+=`
  `+d}catch{!n.logger||((o=(a=n.logger)==null?void 0:a.constructor)==null?void 0:o.name)==="NoOpLogger"?console.warn(d):(l=(c=n.logger)==null?void 0:c.warn)==null||l.call(c,d)}typeof u.$responseBodyText<"u"&&u.$response&&(u.$response.body=u.$responseBodyText);try{if(Oa.isInstance(i)){const{headers:h={}}=i,f=Object.entries(h);u.$metadata={httpStatusCode:i.statusCode,requestId:Nf(/^x-[\w-]+-request-?id$/,f),extendedRequestId:Nf(/^x-[\w-]+-id-2$/,f),cfId:Nf(/^x-[\w-]+-cf-id$/,f)}}}catch{}}throw u}},Nf=(t,e)=>(e.find(([r])=>r.match(t))||[void 0,void 0])[1],Qj=(t,e)=>(r,n)=>async s=>{var c;const i=t,a=(c=n.endpointV2)!=null&&c.url&&i.urlParser?async()=>i.urlParser(n.endpointV2.url):i.endpoint;if(!a)throw new Error("No valid endpoint provider available.");const o=await e(s.input,{...t,endpoint:a});return r({...s,request:o})},eF={name:"deserializerMiddleware",step:"deserialize",tags:["DESERIALIZER"],override:!0},CA={name:"serializerMiddleware",step:"serialize",tags:["SERIALIZER"],override:!0};function kA(t,e,r){return{applyToStack:n=>{n.add(Yj(t,r),eF),n.add(Qj(t,e),CA)}}}const tF=t=>e=>{throw e},rF=(t,e)=>{},nF=t=>(e,r)=>async n=>{if(!Or.isInstance(n.request))return e(n);const i=vd(r).selectedHttpAuthScheme;if(!i)throw new Error("No HttpAuthScheme was selected: unable to sign request");const{httpAuthOption:{signingProperties:a={}},identity:o,signer:c}=i,l=await e({...n,request:await c.sign(n.request,o,a)}).catch((c.errorHandler||tF)(a));return(c.successHandler||rF)(l.response,a),l},sF={step:"finalizeRequest",tags:["HTTP_SIGNING"],name:"httpSigningMiddleware",aliases:["apiKeyMiddleware","tokenMiddleware","awsAuthMiddleware"],override:!0,relation:"after",toMiddleware:"retryMiddleware"},iF=t=>({applyToStack:e=>{e.addRelativeTo(nF(),sF)}}),xo=t=>{if(typeof t=="function")return t;const e=Promise.resolve(t);return()=>e},IA="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Wb=Object.entries(IA).reduce((t,[e,r])=>(t[r]=Number(e),t),{}),aF=IA.split(""),_a=6,To=8,oF=63,ty=t=>{let e=t.length/4*3;t.slice(-2)==="=="?e-=2:t.slice(-1)==="="&&e--;const r=new ArrayBuffer(e),n=new DataView(r);for(let s=0;s<t.length;s+=4){let i=0,a=0;for(let l=s,u=s+3;l<=u;l++)if(t[l]!=="="){if(!(t[l]in Wb))throw new TypeError(`Invalid character ${t[l]} in base64 string.`);i|=Wb[t[l]]<<(u-l)*_a,a+=_a}else i>>=_a;const o=s/4*3;i>>=a%To;const c=Math.floor(a/To);for(let l=0;l<c;l++){const u=(c-l-1)*To;n.setUint8(o+l,(i&255<<u)>>u)}}return new Uint8Array(r)},$a=t=>new TextEncoder().encode(t),Qo=t=>typeof t=="string"?$a(t):ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength/Uint8Array.BYTES_PER_ELEMENT):new Uint8Array(t),ry=t=>{if(typeof t=="string")return t;if(typeof t!="object"||typeof t.byteOffset!="number"||typeof t.byteLength!="number")throw new Error("@smithy/util-utf8: toUtf8 encoder function only accepts string | Uint8Array.");return new TextDecoder("utf-8").decode(t)};function RA(t){let e;typeof t=="string"?e=$a(t):e=t;const r=typeof e=="object"&&typeof e.length=="number",n=typeof e=="object"&&typeof e.byteOffset=="number"&&typeof e.byteLength=="number";if(!r&&!n)throw new Error("@smithy/util-base64: toBase64 encoder function only accepts string | Uint8Array.");let s="";for(let i=0;i<e.length;i+=3){let a=0,o=0;for(let l=i,u=Math.min(i+3,e.length);l<u;l++)a|=e[l]<<(u-l-1)*To,o+=To;const c=Math.ceil(o/_a);a<<=c*_a-o;for(let l=1;l<=c;l++){const u=(c-l)*_a;s+=aF[(a&oF<<u)>>u]}s+="==".slice(0,4-c)}return s}class xi extends Uint8Array{static fromString(e,r="utf-8"){if(typeof e=="string")return r==="base64"?xi.mutate(ty(e)):xi.mutate($a(e));throw new Error(`Unsupported conversion from ${typeof e} to Uint8ArrayBlobAdapter.`)}static mutate(e){return Object.setPrototypeOf(e,xi.prototype),e}transformToString(e="utf-8"){return e==="base64"?RA(this):ry(this)}}const Ti=t=>encodeURIComponent(t).replace(/[!'()*]/g,cF),cF=t=>`%${t.charCodeAt(0).toString(16).toUpperCase()}`;function OA(t){const e=[];for(let r of Object.keys(t).sort()){const n=t[r];if(r=Ti(r),Array.isArray(n))for(let s=0,i=n.length;s<i;s++)e.push(`${r}=${Ti(n[s])}`);else{let s=r;(n||typeof n=="string")&&(s+=`=${Ti(n)}`),e.push(s)}}return e.join("&")}function Jb(t,e){return new Request(t,e)}function lF(t=0){return new Promise((e,r)=>{t&&setTimeout(()=>{const n=new Error(`Request did not complete within ${t} ms`);n.name="TimeoutError",r(n)},t)})}const Pf={supported:void 0};class ec{constructor(e){p(this,"config");p(this,"configProvider");typeof e=="function"?this.configProvider=e().then(r=>r||{}):(this.config=e??{},this.configProvider=Promise.resolve(this.config)),Pf.supported===void 0&&(Pf.supported=typeof Request<"u"&&"keepalive"in Jb("https://[::1]"))}static create(e){return typeof(e==null?void 0:e.handle)=="function"?e:new ec(e)}destroy(){}async handle(e,{abortSignal:r,requestTimeout:n}={}){var _;this.config||(this.config=await this.configProvider);const s=n??this.config.requestTimeout,i=this.config.keepAlive===!0,a=this.config.credentials;if(r!=null&&r.aborted){const E=new Error("Request aborted");return E.name="AbortError",Promise.reject(E)}let o=e.path;const c=OA(e.query||{});c&&(o+=`?${c}`),e.fragment&&(o+=`#${e.fragment}`);let l="";if(e.username!=null||e.password!=null){const E=e.username??"",C=e.password??"";l=`${E}:${C}@`}const{port:u,method:d}=e,h=`${e.protocol}//${l}${e.hostname}${u?`:${u}`:""}${o}`,f=d==="GET"||d==="HEAD"?void 0:e.body,m={body:f,headers:new Headers(e.headers),method:d,credentials:a};(_=this.config)!=null&&_.cache&&(m.cache=this.config.cache),f&&(m.duplex="half"),typeof AbortController<"u"&&(m.signal=r),Pf.supported&&(m.keepalive=i),typeof this.config.requestInit=="function"&&Object.assign(m,this.config.requestInit(e));let g=()=>{};const y=Jb(h,m),b=[fetch(y).then(E=>{const C=E.headers,k={};for(const $ of C.entries())k[$[0]]=$[1];return E.body!=null?{response:new Oa({headers:k,reason:E.statusText,statusCode:E.status,body:E.body})}:E.blob().then($=>({response:new Oa({headers:k,reason:E.statusText,statusCode:E.status,body:$})}))}),lF(s)];return r&&b.push(new Promise((E,C)=>{const k=()=>{const R=new Error("Request aborted");R.name="AbortError",C(R)};if(typeof r.addEventListener=="function"){const R=r;R.addEventListener("abort",k,{once:!0}),g=()=>R.removeEventListener("abort",k)}else r.onabort=k})),Promise.race(b).finally(g)}updateHttpClientConfig(e,r){this.config=void 0,this.configProvider=this.configProvider.then(n=>(n[e]=r,n))}httpHandlerConfigs(){return this.config??{}}}const uF=async t=>{var e;return typeof Blob=="function"&&t instanceof Blob||((e=t.constructor)==null?void 0:e.name)==="Blob"?Blob.prototype.arrayBuffer!==void 0?new Uint8Array(await t.arrayBuffer()):dF(t):hF(t)};async function dF(t){const e=await fF(t),r=ty(e);return new Uint8Array(r)}async function hF(t){const e=[],r=t.getReader();let n=!1,s=0;for(;!n;){const{done:o,value:c}=await r.read();c&&(e.push(c),s+=c.length),n=o}const i=new Uint8Array(s);let a=0;for(const o of e)i.set(o,a),a+=o.length;return i}function fF(t){return new Promise((e,r)=>{const n=new FileReader;n.onloadend=()=>{if(n.readyState!==2)return r(new Error("Reader aborted too early"));const s=n.result??"",i=s.indexOf(","),a=i>-1?i+1:s.length;e(s.substring(a))},n.onabort=()=>r(new Error("Read aborted")),n.onerror=()=>r(n.error),n.readAsDataURL(t)})}const $A={},sm={};for(let t=0;t<256;t++){let e=t.toString(16).toLowerCase();e.length===1&&(e=`0${e}`),$A[t]=e,sm[e]=t}function ny(t){if(t.length%2!==0)throw new Error("Hex encoded strings must have an even number length");const e=new Uint8Array(t.length/2);for(let r=0;r<t.length;r+=2){const n=t.slice(r,r+2).toLowerCase();if(n in sm)e[r/2]=sm[n];else throw new Error(`Cannot decode unrecognized sequence ${n} as hexadecimal`)}return e}function Fr(t){let e="";for(let r=0;r<t.byteLength;r++)e+=$A[t[r]];return e}const pF=async(t=new Uint8Array,e)=>{if(t instanceof Uint8Array)return xi.mutate(t);if(!t)return xi.mutate(new Uint8Array);const r=e.streamCollector(t);return xi.mutate(await r)};function Zb(t){return encodeURIComponent(t).replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}const Lf=t=>typeof t=="function"?t():t;function nl(t){if(typeof t=="object")return t;t=t|0;const e={};let r=0;for(const n of["httpLabel","idempotent","idempotencyToken","sensitive","httpPayload","httpResponseCode","httpQueryParams"])(t>>r++&1)===1&&(e[n]=1);return e}const Ns=class Ns{constructor(e,r){p(this,"ref");p(this,"memberName");p(this,"symbol",Ns.symbol);p(this,"name");p(this,"schema");p(this,"_isMemberSchema");p(this,"traits");p(this,"memberTraits");p(this,"normalizedTraits");this.ref=e,this.memberName=r;const n=[];let s=e,i=e;for(this._isMemberSchema=!1;Mf(s);)n.push(s[1]),s=s[0],i=Lf(s),this._isMemberSchema=!0;if(n.length>0){this.memberTraits={};for(let a=n.length-1;a>=0;--a){const o=n[a];Object.assign(this.memberTraits,nl(o))}}else this.memberTraits=0;if(i instanceof Ns){const a=this.memberTraits;Object.assign(this,i),this.memberTraits=Object.assign({},a,i.getMemberTraits(),this.getMemberTraits()),this.normalizedTraits=void 0,this.memberName=r??i.memberName;return}if(this.schema=Lf(i),mF(this.schema)?(this.name=`${this.schema[1]}#${this.schema[2]}`,this.traits=this.schema[3]):(this.name=this.memberName??String(i),this.traits=0),this._isMemberSchema&&!r)throw new Error(`@smithy/core/schema - NormalizedSchema member init ${this.getName(!0)} missing member name.`)}static[Symbol.hasInstance](e){const r=this.prototype.isPrototypeOf(e);return!r&&typeof e=="object"&&e!==null?e.symbol===this.symbol:r}static of(e){const r=Lf(e);if(r instanceof Ns)return r;if(Mf(r)){const[n,s]=r;if(n instanceof Ns)return Object.assign(n.getMergedTraits(),nl(s)),n;throw new Error(`@smithy/core/schema - may not init unwrapped member schema=${JSON.stringify(e,null,2)}.`)}return new Ns(r)}getSchema(){const e=this.schema;return e[0]===0?e[4]:e}getName(e=!1){const{name:r}=this;return!e&&r&&r.includes("#")?r.split("#")[1]:r||void 0}getMemberName(){return this.memberName}isMemberSchema(){return this._isMemberSchema}isListSchema(){const e=this.getSchema();return typeof e=="number"?e>=64&&e<128:e[0]===1}isMapSchema(){const e=this.getSchema();return typeof e=="number"?e>=128&&e<=255:e[0]===2}isStructSchema(){const e=this.getSchema();return e[0]===3||e[0]===-3}isBlobSchema(){const e=this.getSchema();return e===21||e===42}isTimestampSchema(){const e=this.getSchema();return typeof e=="number"&&e>=4&&e<=7}isUnitSchema(){return this.getSchema()==="unit"}isDocumentSchema(){return this.getSchema()===15}isStringSchema(){return this.getSchema()===0}isBooleanSchema(){return this.getSchema()===2}isNumericSchema(){return this.getSchema()===1}isBigIntegerSchema(){return this.getSchema()===17}isBigDecimalSchema(){return this.getSchema()===19}isStreaming(){const{streaming:e}=this.getMergedTraits();return!!e||this.getSchema()===42}isIdempotencyToken(){const e=i=>(i&4)===4||!!(i!=null&&i.idempotencyToken),{normalizedTraits:r,traits:n,memberTraits:s}=this;return e(r)||e(n)||e(s)}getMergedTraits(){return this.normalizedTraits??(this.normalizedTraits={...this.getOwnTraits(),...this.getMemberTraits()})}getMemberTraits(){return nl(this.memberTraits)}getOwnTraits(){return nl(this.traits)}getKeySchema(){const[e,r]=[this.isDocumentSchema(),this.isMapSchema()];if(!e&&!r)throw new Error(`@smithy/core/schema - cannot get key for non-map: ${this.getName(!0)}`);const n=this.getSchema(),s=e?15:n[4]??0;return Ja([s,0],"key")}getValueSchema(){const e=this.getSchema(),[r,n,s]=[this.isDocumentSchema(),this.isMapSchema(),this.isListSchema()],i=typeof e=="number"?63&e:e&&typeof e=="object"&&(n||s)?e[3+e[0]]:r?15:void 0;if(i!=null)return Ja([i,0],n?"value":"member");throw new Error(`@smithy/core/schema - ${this.getName(!0)} has no value member.`)}getMemberSchema(e){const r=this.getSchema();if(this.isStructSchema()&&r[4].includes(e)){const n=r[4].indexOf(e),s=r[5][n];return Ja(Mf(s)?s:[s,0],e)}if(this.isDocumentSchema())return Ja([15,0],e);throw new Error(`@smithy/core/schema - ${this.getName(!0)} has no no member=${e}.`)}getMemberSchemas(){const e={};try{for(const[r,n]of this.structIterator())e[r]=n}catch{}return e}getEventStreamMember(){if(this.isStructSchema()){for(const[e,r]of this.structIterator())if(r.isStreaming()&&r.isStructSchema())return e}return""}*structIterator(){if(this.isUnitSchema())return;if(!this.isStructSchema())throw new Error("@smithy/core/schema - cannot iterate non-struct schema.");const e=this.getSchema();for(let r=0;r<e[4].length;++r)yield[e[4][r],Ja([e[5][r],0],e[4][r])]}};p(Ns,"symbol",Symbol.for("@smithy/nor"));let tc=Ns;function Ja(t,e){if(t instanceof tc)return Object.assign(t,{memberName:e,_isMemberSchema:!0});const r=tc;return new r(t,e)}const Mf=t=>Array.isArray(t)&&t.length===2,mF=t=>Array.isArray(t)&&t.length>=5,gF=t=>{if(t!=null){if(typeof t=="number"){if((t===0||t===1)&&Iu.warn(ku(`Expected boolean, got ${typeof t}: ${t}`)),t===0)return!1;if(t===1)return!0}if(typeof t=="string"){const e=t.toLowerCase();if((e==="false"||e==="true")&&Iu.warn(ku(`Expected boolean, got ${typeof t}: ${t}`)),e==="false")return!1;if(e==="true")return!0}if(typeof t=="boolean")return t;throw new TypeError(`Expected boolean, got ${typeof t}: ${t}`)}},yF=t=>{if(t!=null){if(typeof t=="string"){const e=parseFloat(t);if(!Number.isNaN(e))return String(e)!==String(t)&&Iu.warn(ku(`Expected number but observed string: ${t}`)),e}if(typeof t=="number")return t;throw new TypeError(`Expected number, got ${typeof t}: ${t}`)}},_F=t=>{if(t!=null){if(Number.isInteger(t)&&!Number.isNaN(t))return t;throw new TypeError(`Expected integer, got ${typeof t}: ${t}`)}},sy=t=>wF(t,32),wF=(t,e)=>{const r=_F(t);if(r!==void 0&&bF(r,e)!==r)throw new TypeError(`Expected ${e}-bit integer, got ${t}`);return r},bF=(t,e)=>{switch(e){case 32:return Int32Array.of(t)[0];case 16:return Int16Array.of(t)[0];case 8:return Int8Array.of(t)[0]}},vF=(t,e)=>{if(t==null)throw new TypeError(`Expected a non-null value for ${e}`);return t},NA=t=>{if(t==null)return;if(typeof t=="object"&&!Array.isArray(t))return t;const e=Array.isArray(t)?"array":typeof t;throw new TypeError(`Expected object, got ${e}: ${t}`)},Ne=t=>{if(t!=null){if(typeof t=="string")return t;if(["boolean","number","bigint"].includes(typeof t))return Iu.warn(ku(`Expected string, got ${typeof t}: ${t}`)),String(t);throw new TypeError(`Expected string, got ${typeof t}: ${t}`)}},EF=t=>{if(t==null)return;const e=NA(t),r=Object.entries(e).filter(([,n])=>n!=null).map(([n])=>n);if(r.length===0)throw new TypeError("Unions must have exactly one non-null member. None were found.");if(r.length>1)throw new TypeError(`Unions must have exactly one non-null member. Keys ${r} were not null.`);return e},im=t=>typeof t=="string"?SF(t):yF(t),SF=t=>{switch(t){case"NaN":return NaN;case"Infinity":return 1/0;case"-Infinity":return-1/0;default:throw new Error(`Unable to parse float value: ${t}`)}},ku=t=>String(new TypeError(t).stack||t).split(`
`).slice(0,5).filter(e=>!e.includes("stackTraceWarning")).join(`
`),Iu={warn:console.warn},Kb=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ir=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0")),xF=()=>{if(Kb)return Kb();const t=new Uint8Array(16);return crypto.getRandomValues(t),t[6]=t[6]&15|64,t[8]=t[8]&63|128,ir[t[0]]+ir[t[1]]+ir[t[2]]+ir[t[3]]+"-"+ir[t[4]]+ir[t[5]]+"-"+ir[t[6]]+ir[t[7]]+"-"+ir[t[8]]+ir[t[9]]+"-"+ir[t[10]]+ir[t[11]]+ir[t[12]]+ir[t[13]]+ir[t[14]]+ir[t[15]]},TF=(t,e,r,n,s,i)=>{if(e!=null&&e[r]!==void 0){const a=n();if(a.length<=0)throw new Error("Empty value provided for input HTTP label: "+r+".");t=t.replace(s,i?a.split("/").map(o=>Zb(o)).join("/"):Zb(a))}else throw new Error("No value provided for input HTTP label: "+r+".");return t};function PA(t,e){return new AF(t,e)}class AF{constructor(e,r){p(this,"input");p(this,"context");p(this,"query",{});p(this,"method","");p(this,"headers",{});p(this,"path","");p(this,"body",null);p(this,"hostname","");p(this,"resolvePathStack",[]);this.input=e,this.context=r}async build(){const{hostname:e,protocol:r="https",port:n,path:s}=await this.context.endpoint();this.path=s;for(const i of this.resolvePathStack)i(this.path);return new Or({protocol:r,hostname:this.hostname||e,port:n,method:this.method,path:this.path,query:this.query,body:this.body,headers:this.headers})}hn(e){return this.hostname=e,this}bp(e){return this.resolvePathStack.push(r=>{this.path=`${r!=null&&r.endsWith("/")?r.slice(0,-1):r||""}`+e}),this}p(e,r,n,s){return this.resolvePathStack.push(i=>{this.path=TF(i,this.input,e,r,n,s)}),this}h(e){return this.headers=e,this}q(e){return this.query=e,this}b(e){return this.body=e,this}m(e){return this.method=e,this}}function CF(t,e,r){t.__smithy_context?t.__smithy_context.features||(t.__smithy_context.features={}):t.__smithy_context={features:{}},t.__smithy_context.features[e]=r}class kF{constructor(e){p(this,"authSchemes",new Map);for(const[r,n]of Object.entries(e))n!==void 0&&this.authSchemes.set(r,n)}getIdentityProvider(e){return this.authSchemes.get(e)}}class IF{async sign(e,r,n){const s=Or.clone(e);if(!r.token)throw new Error("request could not be signed with `token` since the `token` is not defined");return s.headers.Authorization=`Bearer ${r.token}`,s}}const RF=t=>function(r){return iy(r)&&r.expiration.getTime()-Date.now()<t},OF=3e5,LA=RF(OF),iy=t=>t.expiration!==void 0,MA=(t,e,r)=>{if(t===void 0)return;const n=typeof t!="function"?async()=>Promise.resolve(t):t;let s,i,a,o=!1;const c=async l=>{i||(i=n(l));try{s=await i,a=!0,o=!1}finally{i=void 0}return s};return e===void 0?async l=>((!a||l!=null&&l.forceRefresh)&&(s=await c(l)),s):async l=>((!a||l!=null&&l.forceRefresh)&&(s=await c(l)),o?s:r(s)?(e(s)&&await c(l),s):(o=!0,s))},$F=void 0;function NF(t){return t===void 0?!0:typeof t=="string"&&t.length<=50}function PF(t){const e=xo(t.userAgentAppId??$F),{customUserAgent:r}=t;return Object.assign(t,{customUserAgent:typeof r=="string"?[[r]]:r,userAgentAppId:async()=>{var s,i;const n=await e();if(!NF(n)){const a=((i=(s=t.logger)==null?void 0:s.constructor)==null?void 0:i.name)==="NoOpLogger"||!t.logger?console:t.logger;typeof n!="string"?a==null||a.warn("userAgentAppId must be a string or undefined."):n.length>50&&(a==null||a.warn("The provided userAgentAppId exceeds the maximum length of 50 characters."))}return n}})}class LF{constructor({size:e,params:r}){p(this,"capacity");p(this,"data",new Map);p(this,"parameters",[]);this.capacity=e??50,r&&(this.parameters=r)}get(e,r){const n=this.hash(e);if(n===!1)return r();if(!this.data.has(n)){if(this.data.size>this.capacity+10){const s=this.data.keys();let i=0;for(;;){const{value:a,done:o}=s.next();if(this.data.delete(a),o||++i>10)break}}this.data.set(n,r())}return this.data.get(n)}size(){return this.data.size}hash(e){let r="";const{parameters:n}=this;if(n.length===0)return!1;for(const s of n){const i=String(e[s]??"");if(i.includes("|;"))return!1;r+=i+"|;"}return r}}const MF=new RegExp("^(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}$"),DA=t=>MF.test(t)||t.startsWith("[")&&t.endsWith("]"),DF=new RegExp("^(?!.*-$)(?!-)[a-zA-Z0-9-]{1,63}$"),Ed=(t,e=!1)=>{if(!e)return DF.test(t);const r=t.split(".");for(const n of r)if(!Ed(n))return!1;return!0},Ru={},rc="endpoints";function Xs(t){return typeof t!="object"||t==null?t:"ref"in t?`$${Xs(t.ref)}`:"fn"in t?`${t.fn}(${(t.argv||[]).map(Xs).join(", ")})`:JSON.stringify(t,null,2)}class Hr extends Error{constructor(e){super(e),this.name="EndpointError"}}const UF=(t,e)=>t===e,BF=t=>{const e=t.split("."),r=[];for(const n of e){const s=n.indexOf("[");if(s!==-1){if(n.indexOf("]")!==n.length-1)throw new Hr(`Path: '${t}' does not end with ']'`);const i=n.slice(s+1,-1);if(Number.isNaN(parseInt(i)))throw new Hr(`Invalid array index: '${i}' in path: '${t}'`);s!==0&&r.push(n.slice(0,s)),r.push(i)}else r.push(n)}return r},UA=(t,e)=>BF(e).reduce((r,n)=>{if(typeof r!="object")throw new Hr(`Index '${n}' in '${e}' not found in '${JSON.stringify(t)}'`);return Array.isArray(r)?r[parseInt(n)]:r[n]},t),jF=t=>t!=null,FF=t=>!t,Df={[Yo.HTTP]:80,[Yo.HTTPS]:443},zF=t=>{const e=(()=>{try{if(t instanceof URL)return t;if(typeof t=="object"&&"hostname"in t){const{hostname:h,port:f,protocol:m="",path:g="",query:y={}}=t,b=new URL(`${m}//${h}${f?`:${f}`:""}${g}`);return b.search=Object.entries(y).map(([_,E])=>`${_}=${E}`).join("&"),b}return new URL(t)}catch{return null}})();if(!e)return console.error(`Unable to parse ${JSON.stringify(t)} as a whatwg URL.`),null;const r=e.href,{host:n,hostname:s,pathname:i,protocol:a,search:o}=e;if(o)return null;const c=a.slice(0,-1);if(!Object.values(Yo).includes(c))return null;const l=DA(s),u=r.includes(`${n}:${Df[c]}`)||typeof t=="string"&&t.includes(`${n}:${Df[c]}`),d=`${n}${u?`:${Df[c]}`:""}`;return{scheme:c,authority:d,path:i,normalizedPath:i.endsWith("/")?i:`${i}/`,isIp:l}},VF=(t,e)=>t===e,qF=(t,e,r,n)=>e>=r||t.length<r?null:n?t.substring(t.length-r,t.length-e):t.substring(e,r),HF=t=>encodeURIComponent(t).replace(/[!*'()]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`),GF={booleanEquals:UF,getAttr:UA,isSet:jF,isValidHostLabel:Ed,not:FF,parseURL:zF,stringEquals:VF,substring:qF,uriEncode:HF},BA=(t,e)=>{const r=[],n={...e.endpointParams,...e.referenceRecord};let s=0;for(;s<t.length;){const i=t.indexOf("{",s);if(i===-1){r.push(t.slice(s));break}r.push(t.slice(s,i));const a=t.indexOf("}",i);if(a===-1){r.push(t.slice(i));break}t[i+1]==="{"&&t[a+1]==="}"&&(r.push(t.slice(i+1,a)),s=a+2);const o=t.substring(i+1,a);if(o.includes("#")){const[c,l]=o.split("#");r.push(UA(n[c],l))}else r.push(n[o]);s=a+1}return r.join("")},WF=({ref:t},e)=>({...e.endpointParams,...e.referenceRecord})[t],Sd=(t,e,r)=>{if(typeof t=="string")return BA(t,r);if(t.fn)return FA.callFunction(t,r);if(t.ref)return WF(t,r);throw new Hr(`'${e}': ${String(t)} is not a string, function or reference.`)},jA=({fn:t,argv:e},r)=>{const n=e.map(i=>["boolean","number"].includes(typeof i)?i:FA.evaluateExpression(i,"arg",r)),s=t.split(".");return s[0]in Ru&&s[1]!=null?Ru[s[0]][s[1]](...n):GF[t](...n)},FA={evaluateExpression:Sd,callFunction:jA},JF=({assign:t,...e},r)=>{var s,i;if(t&&t in r.referenceRecord)throw new Hr(`'${t}' is already defined in Reference Record.`);const n=jA(e,r);return(i=(s=r.logger)==null?void 0:s.debug)==null||i.call(s,`${rc} evaluateCondition: ${Xs(e)} = ${Xs(n)}`),{result:n===""?!0:!!n,...t!=null&&{toAssign:{name:t,value:n}}}},ay=(t=[],e)=>{var n,s;const r={};for(const i of t){const{result:a,toAssign:o}=JF(i,{...e,referenceRecord:{...e.referenceRecord,...r}});if(!a)return{result:a};o&&(r[o.name]=o.value,(s=(n=e.logger)==null?void 0:n.debug)==null||s.call(n,`${rc} assign: ${o.name} := ${Xs(o.value)}`))}return{result:!0,referenceRecord:r}},ZF=(t,e)=>Object.entries(t).reduce((r,[n,s])=>({...r,[n]:s.map(i=>{const a=Sd(i,"Header value entry",e);if(typeof a!="string")throw new Hr(`Header '${n}' value '${a}' is not a string`);return a})}),{}),zA=(t,e)=>Object.entries(t).reduce((r,[n,s])=>({...r,[n]:qA.getEndpointProperty(s,e)}),{}),VA=(t,e)=>{if(Array.isArray(t))return t.map(r=>VA(r,e));switch(typeof t){case"string":return BA(t,e);case"object":if(t===null)throw new Hr(`Unexpected endpoint property: ${t}`);return qA.getEndpointProperties(t,e);case"boolean":return t;default:throw new Hr(`Unexpected endpoint property type: ${typeof t}`)}},qA={getEndpointProperty:VA,getEndpointProperties:zA},KF=(t,e)=>{const r=Sd(t,"Endpoint URL",e);if(typeof r=="string")try{return new URL(r)}catch(n){throw console.error(`Failed to construct URL with ${r}`,n),n}throw new Hr(`Endpoint URL must be a string, got ${typeof r}`)},XF=(t,e)=>{var u,d;const{conditions:r,endpoint:n}=t,{result:s,referenceRecord:i}=ay(r,e);if(!s)return;const a={...e,referenceRecord:{...e.referenceRecord,...i}},{url:o,properties:c,headers:l}=n;return(d=(u=e.logger)==null?void 0:u.debug)==null||d.call(u,`${rc} Resolving endpoint from template: ${Xs(n)}`),{...l!=null&&{headers:ZF(l,a)},...c!=null&&{properties:zA(c,a)},url:KF(o,a)}},YF=(t,e)=>{const{conditions:r,error:n}=t,{result:s,referenceRecord:i}=ay(r,e);if(s)throw new Hr(Sd(n,"Error",{...e,referenceRecord:{...e.referenceRecord,...i}}))},HA=(t,e)=>{for(const r of t)if(r.type==="endpoint"){const n=XF(r,e);if(n)return n}else if(r.type==="error")YF(r,e);else if(r.type==="tree"){const n=GA.evaluateTreeRule(r,e);if(n)return n}else throw new Hr(`Unknown endpoint rule: ${r}`);throw new Hr("Rules evaluation failed")},QF=(t,e)=>{const{conditions:r,rules:n}=t,{result:s,referenceRecord:i}=ay(r,e);if(s)return GA.evaluateRules(n,{...e,referenceRecord:{...e.referenceRecord,...i}})},GA={evaluateRules:HA,evaluateTreeRule:QF},e3=(t,e)=>{var l,u,d,h;const{endpointParams:r,logger:n}=e,{parameters:s,rules:i}=t;(u=(l=e.logger)==null?void 0:l.debug)==null||u.call(l,`${rc} Initial EndpointParams: ${Xs(r)}`);const a=Object.entries(s).filter(([,f])=>f.default!=null).map(([f,m])=>[f,m.default]);if(a.length>0)for(const[f,m]of a)r[f]=r[f]??m;const o=Object.entries(s).filter(([,f])=>f.required).map(([f])=>f);for(const f of o)if(r[f]==null)throw new Hr(`Missing required parameter: '${f}'`);const c=HA(i,{endpointParams:r,logger:n,referenceRecord:{}});return(h=(d=e.logger)==null?void 0:d.debug)==null||h.call(d,`${rc} Resolved endpoint: ${Xs(c)}`),c},WA=(t,e=!1)=>{if(e){for(const r of t.split("."))if(!WA(r))return!1;return!0}return!(!Ed(t)||t.length<3||t.length>63||t!==t.toLowerCase()||DA(t))},Xb=":",t3="/",r3=t=>{const e=t.split(Xb);if(e.length<6)return null;const[r,n,s,i,a,...o]=e;if(r!=="arn"||n===""||s===""||o.join(Xb)==="")return null;const c=o.map(l=>l.split(t3)).flat();return{partition:n,service:s,region:i,accountId:a,resourceId:c}},n3=[{id:"aws",outputs:{dnsSuffix:"amazonaws.com",dualStackDnsSuffix:"api.aws",implicitGlobalRegion:"us-east-1",name:"aws",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^(us|eu|ap|sa|ca|me|af|il|mx)\\-\\w+\\-\\d+$",regions:{"af-south-1":{description:"Africa (Cape Town)"},"ap-east-1":{description:"Asia Pacific (Hong Kong)"},"ap-east-2":{description:"Asia Pacific (Taipei)"},"ap-northeast-1":{description:"Asia Pacific (Tokyo)"},"ap-northeast-2":{description:"Asia Pacific (Seoul)"},"ap-northeast-3":{description:"Asia Pacific (Osaka)"},"ap-south-1":{description:"Asia Pacific (Mumbai)"},"ap-south-2":{description:"Asia Pacific (Hyderabad)"},"ap-southeast-1":{description:"Asia Pacific (Singapore)"},"ap-southeast-2":{description:"Asia Pacific (Sydney)"},"ap-southeast-3":{description:"Asia Pacific (Jakarta)"},"ap-southeast-4":{description:"Asia Pacific (Melbourne)"},"ap-southeast-5":{description:"Asia Pacific (Malaysia)"},"ap-southeast-6":{description:"Asia Pacific (New Zealand)"},"ap-southeast-7":{description:"Asia Pacific (Thailand)"},"aws-global":{description:"aws global region"},"ca-central-1":{description:"Canada (Central)"},"ca-west-1":{description:"Canada West (Calgary)"},"eu-central-1":{description:"Europe (Frankfurt)"},"eu-central-2":{description:"Europe (Zurich)"},"eu-north-1":{description:"Europe (Stockholm)"},"eu-south-1":{description:"Europe (Milan)"},"eu-south-2":{description:"Europe (Spain)"},"eu-west-1":{description:"Europe (Ireland)"},"eu-west-2":{description:"Europe (London)"},"eu-west-3":{description:"Europe (Paris)"},"il-central-1":{description:"Israel (Tel Aviv)"},"me-central-1":{description:"Middle East (UAE)"},"me-south-1":{description:"Middle East (Bahrain)"},"mx-central-1":{description:"Mexico (Central)"},"sa-east-1":{description:"South America (Sao Paulo)"},"us-east-1":{description:"US East (N. Virginia)"},"us-east-2":{description:"US East (Ohio)"},"us-west-1":{description:"US West (N. California)"},"us-west-2":{description:"US West (Oregon)"}}},{id:"aws-cn",outputs:{dnsSuffix:"amazonaws.com.cn",dualStackDnsSuffix:"api.amazonwebservices.com.cn",implicitGlobalRegion:"cn-northwest-1",name:"aws-cn",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^cn\\-\\w+\\-\\d+$",regions:{"aws-cn-global":{description:"aws-cn global region"},"cn-north-1":{description:"China (Beijing)"},"cn-northwest-1":{description:"China (Ningxia)"}}},{id:"aws-eusc",outputs:{dnsSuffix:"amazonaws.eu",dualStackDnsSuffix:"api.amazonwebservices.eu",implicitGlobalRegion:"eusc-de-east-1",name:"aws-eusc",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^eusc\\-(de)\\-\\w+\\-\\d+$",regions:{"eusc-de-east-1":{description:"EU (Germany)"}}},{id:"aws-iso",outputs:{dnsSuffix:"c2s.ic.gov",dualStackDnsSuffix:"api.aws.ic.gov",implicitGlobalRegion:"us-iso-east-1",name:"aws-iso",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-iso\\-\\w+\\-\\d+$",regions:{"aws-iso-global":{description:"aws-iso global region"},"us-iso-east-1":{description:"US ISO East"},"us-iso-west-1":{description:"US ISO WEST"}}},{id:"aws-iso-b",outputs:{dnsSuffix:"sc2s.sgov.gov",dualStackDnsSuffix:"api.aws.scloud",implicitGlobalRegion:"us-isob-east-1",name:"aws-iso-b",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-isob\\-\\w+\\-\\d+$",regions:{"aws-iso-b-global":{description:"aws-iso-b global region"},"us-isob-east-1":{description:"US ISOB East (Ohio)"},"us-isob-west-1":{description:"US ISOB West"}}},{id:"aws-iso-e",outputs:{dnsSuffix:"cloud.adc-e.uk",dualStackDnsSuffix:"api.cloud-aws.adc-e.uk",implicitGlobalRegion:"eu-isoe-west-1",name:"aws-iso-e",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^eu\\-isoe\\-\\w+\\-\\d+$",regions:{"aws-iso-e-global":{description:"aws-iso-e global region"},"eu-isoe-west-1":{description:"EU ISOE West"}}},{id:"aws-iso-f",outputs:{dnsSuffix:"csp.hci.ic.gov",dualStackDnsSuffix:"api.aws.hci.ic.gov",implicitGlobalRegion:"us-isof-south-1",name:"aws-iso-f",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-isof\\-\\w+\\-\\d+$",regions:{"aws-iso-f-global":{description:"aws-iso-f global region"},"us-isof-east-1":{description:"US ISOF EAST"},"us-isof-south-1":{description:"US ISOF SOUTH"}}},{id:"aws-us-gov",outputs:{dnsSuffix:"amazonaws.com",dualStackDnsSuffix:"api.aws",implicitGlobalRegion:"us-gov-west-1",name:"aws-us-gov",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-gov\\-\\w+\\-\\d+$",regions:{"aws-us-gov-global":{description:"aws-us-gov global region"},"us-gov-east-1":{description:"AWS GovCloud (US-East)"},"us-gov-west-1":{description:"AWS GovCloud (US-West)"}}}],s3={partitions:n3};let i3=s3;const a3=t=>{const{partitions:e}=i3;for(const n of e){const{regions:s,outputs:i}=n;for(const[a,o]of Object.entries(s))if(a===t)return{...i,...o}}for(const n of e){const{regionRegex:s,outputs:i}=n;if(new RegExp(s).test(t))return{...i}}const r=e.find(n=>n.id==="aws");if(!r)throw new Error("Provided region was not found in the partition array or regex, and default partition with id 'aws' doesn't exist.");return{...r.outputs}},JA={isVirtualHostableS3Bucket:WA,parseArn:r3,partition:a3};Ru.aws=JA;function o3(t){const e={};if(t=t.replace(/^\?/,""),t)for(const r of t.split("&")){let[n,s=null]=r.split("=");n=decodeURIComponent(n),s&&(s=decodeURIComponent(s)),n in e?Array.isArray(e[n])?e[n].push(s):e[n]=[e[n],s]:e[n]=s}return e}const Ou=t=>{if(typeof t=="string")return Ou(new URL(t));const{hostname:e,pathname:r,port:n,protocol:s,search:i}=t;let a;return i&&(a=o3(i)),{hostname:e,port:n?parseInt(n):void 0,protocol:s,path:r,query:a}};function c3(t,e,r){return t.$source||(t.$source={}),t.$source[e]=r,t}function Rn(t,e,r){t.__aws_sdk_context?t.__aws_sdk_context.features||(t.__aws_sdk_context.features={}):t.__aws_sdk_context={features:{}},t.__aws_sdk_context.features[e]=r}const Yb=t=>{var e,r;return Oa.isInstance(t)?((e=t.headers)==null?void 0:e.date)??((r=t.headers)==null?void 0:r.Date):void 0},ZA=t=>new Date(Date.now()+t),l3=(t,e)=>Math.abs(ZA(e).getTime()-t)>=3e5,Qb=(t,e)=>{const r=Date.parse(t);return l3(r,e)?r-Date.now():e},Ao=(t,e)=>{if(!e)throw new Error(`Property \`${t}\` is not resolved for AWS SDK SigV4Auth`);return e},u3=async t=>{var l,u,d;const e=Ao("context",t.context),r=Ao("config",t.config),n=(d=(u=(l=e.endpointV2)==null?void 0:l.properties)==null?void 0:u.authSchemes)==null?void 0:d[0],i=await Ao("signer",r.signer)(n),a=t==null?void 0:t.signingRegion,o=t==null?void 0:t.signingRegionSet,c=t==null?void 0:t.signingName;return{config:r,signer:i,signingRegion:a,signingRegionSet:o,signingName:c}};class d3{async sign(e,r,n){var d;if(!Or.isInstance(e))throw new Error("The request is not an instance of `HttpRequest` and cannot be signed");const s=await u3(n),{config:i,signer:a}=s;let{signingRegion:o,signingName:c}=s;const l=n.context;if(((d=l==null?void 0:l.authSchemes)==null?void 0:d.length)??!1){const[h,f]=l.authSchemes;(h==null?void 0:h.name)==="sigv4a"&&(f==null?void 0:f.name)==="sigv4"&&(o=(f==null?void 0:f.signingRegion)??o,c=(f==null?void 0:f.signingName)??c)}return await a.sign(e,{signingDate:ZA(i.systemClockOffset),signingRegion:o,signingService:c})}errorHandler(e){return r=>{const n=r.ServerTime??Yb(r.$response);if(n){const s=Ao("config",e.config),i=s.systemClockOffset;s.systemClockOffset=Qb(n,s.systemClockOffset),s.systemClockOffset!==i&&r.$metadata&&(r.$metadata.clockSkewCorrected=!0)}throw r}}successHandler(e,r){const n=Yb(e);if(n){const s=Ao("config",r.config);s.systemClockOffset=Qb(n,s.systemClockOffset)}}}const h3=(t,e,r)=>{let n,s,i,a=!1;const o=async()=>{s||(s=t());try{n=await s,i=!0,a=!1}finally{s=void 0}return n};return async c=>((!i||c!=null&&c.forceRefresh)&&(n=await o()),n)},f3="X-Amz-Algorithm",p3="X-Amz-Credential",KA="X-Amz-Date",m3="X-Amz-SignedHeaders",g3="X-Amz-Expires",XA="X-Amz-Signature",YA="X-Amz-Security-Token",QA="authorization",eC=KA.toLowerCase(),y3="date",_3=[QA,eC,y3],w3=XA.toLowerCase(),am="x-amz-content-sha256",b3=YA.toLowerCase(),v3={authorization:!0,"cache-control":!0,connection:!0,expect:!0,from:!0,"keep-alive":!0,"max-forwards":!0,pragma:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,"x-amzn-trace-id":!0},E3=/^proxy-/,S3=/^sec-/,Uf="AWS4-HMAC-SHA256",x3="AWS4-HMAC-SHA256-PAYLOAD",T3="UNSIGNED-PAYLOAD",A3=50,tC="aws4_request",C3=3600*24*7,sl={},Bf=[],jf=(t,e,r)=>`${t}/${e}/${r}/${tC}`,k3=async(t,e,r,n,s)=>{const i=await e0(t,e.secretAccessKey,e.accessKeyId),a=`${r}:${n}:${s}:${Fr(i)}:${e.sessionToken}`;if(a in sl)return sl[a];for(Bf.push(a);Bf.length>A3;)delete sl[Bf.shift()];let o=`AWS4${e.secretAccessKey}`;for(const c of[r,n,s,tC])o=await e0(t,o,c);return sl[a]=o},e0=(t,e,r)=>{const n=new t(e);return n.update(Qo(r)),n.digest()},t0=({headers:t},e,r)=>{const n={};for(const s of Object.keys(t).sort()){if(t[s]==null)continue;const i=s.toLowerCase();(i in v3||e!=null&&e.has(i)||E3.test(i)||S3.test(i))&&(!r||r&&!r.has(i))||(n[i]=t[s].trim().replace(/\s+/g," "))}return n},I3=t=>typeof ArrayBuffer=="function"&&t instanceof ArrayBuffer||Object.prototype.toString.call(t)==="[object ArrayBuffer]",Ff=async({headers:t,body:e},r)=>{for(const n of Object.keys(t))if(n.toLowerCase()===am)return t[n];if(e==null)return"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855";if(typeof e=="string"||ArrayBuffer.isView(e)||I3(e)){const n=new r;return n.update(Qo(e)),Fr(await n.digest())}return T3};class R3{format(e){const r=[];for(const i of Object.keys(e)){const a=$a(i);r.push(Uint8Array.from([a.byteLength]),a,this.formatHeaderValue(e[i]))}const n=new Uint8Array(r.reduce((i,a)=>i+a.byteLength,0));let s=0;for(const i of r)n.set(i,s),s+=i.byteLength;return n}formatHeaderValue(e){switch(e.type){case"boolean":return Uint8Array.from([e.value?0:1]);case"byte":return Uint8Array.from([2,e.value]);case"short":const r=new DataView(new ArrayBuffer(3));return r.setUint8(0,3),r.setInt16(1,e.value,!1),new Uint8Array(r.buffer);case"integer":const n=new DataView(new ArrayBuffer(5));return n.setUint8(0,4),n.setInt32(1,e.value,!1),new Uint8Array(n.buffer);case"long":const s=new Uint8Array(9);return s[0]=5,s.set(e.value.bytes,1),s;case"binary":const i=new DataView(new ArrayBuffer(3+e.value.byteLength));i.setUint8(0,6),i.setUint16(1,e.value.byteLength,!1);const a=new Uint8Array(i.buffer);return a.set(e.value,3),a;case"string":const o=$a(e.value),c=new DataView(new ArrayBuffer(3+o.byteLength));c.setUint8(0,7),c.setUint16(1,o.byteLength,!1);const l=new Uint8Array(c.buffer);return l.set(o,3),l;case"timestamp":const u=new Uint8Array(9);return u[0]=8,u.set($3.fromNumber(e.value.valueOf()).bytes,1),u;case"uuid":if(!O3.test(e.value))throw new Error(`Invalid UUID received: ${e.value}`);const d=new Uint8Array(17);return d[0]=9,d.set(ny(e.value.replace(/\-/g,"")),1),d}}}var r0;(function(t){t[t.boolTrue=0]="boolTrue",t[t.boolFalse=1]="boolFalse",t[t.byte=2]="byte",t[t.short=3]="short",t[t.integer=4]="integer",t[t.long=5]="long",t[t.byteArray=6]="byteArray",t[t.string=7]="string",t[t.timestamp=8]="timestamp",t[t.uuid=9]="uuid"})(r0||(r0={}));const O3=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/;let $3=class rC{constructor(e){p(this,"bytes");if(this.bytes=e,e.byteLength!==8)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(e){if(e>9223372036854776e3||e<-9223372036854776e3)throw new Error(`${e} is too large (or, if negative, too small) to represent as an Int64`);const r=new Uint8Array(8);for(let n=7,s=Math.abs(Math.round(e));n>-1&&s>0;n--,s/=256)r[n]=s;return e<0&&n0(r),new rC(r)}valueOf(){const e=this.bytes.slice(0),r=e[0]&128;return r&&n0(e),parseInt(Fr(e),16)*(r?-1:1)}toString(){return String(this.valueOf())}};function n0(t){for(let e=0;e<8;e++)t[e]^=255;for(let e=7;e>-1&&(t[e]++,t[e]===0);e--);}const N3=(t,e)=>{t=t.toLowerCase();for(const r of Object.keys(e))if(t===r.toLowerCase())return!0;return!1},P3=(t,e={})=>{var s,i;const{headers:r,query:n={}}=Or.clone(t);for(const a of Object.keys(r)){const o=a.toLowerCase();(o.slice(0,6)==="x-amz-"&&!((s=e.unhoistableHeaders)!=null&&s.has(o))||(i=e.hoistableHeaders)!=null&&i.has(o))&&(n[a]=r[a],delete r[a])}return{...t,headers:r,query:n}},s0=t=>{t=Or.clone(t);for(const e of Object.keys(t.headers))_3.indexOf(e.toLowerCase())>-1&&delete t.headers[e];return t},L3=({query:t={}})=>{const e=[],r={};for(const n of Object.keys(t)){if(n.toLowerCase()===w3)continue;const s=Ti(n);e.push(s);const i=t[n];typeof i=="string"?r[s]=`${s}=${Ti(i)}`:Array.isArray(i)&&(r[s]=i.slice(0).reduce((a,o)=>a.concat([`${s}=${Ti(o)}`]),[]).sort().join("&"))}return e.sort().map(n=>r[n]).filter(n=>n).join("&")},M3=t=>D3(t).toISOString().replace(/\.\d{3}Z$/,"Z"),D3=t=>typeof t=="number"?new Date(t*1e3):typeof t=="string"?Number(t)?new Date(Number(t)*1e3):new Date(t):t;class U3{constructor({applyChecksum:e,credentials:r,region:n,service:s,sha256:i,uriEscapePath:a=!0}){p(this,"service");p(this,"regionProvider");p(this,"credentialProvider");p(this,"sha256");p(this,"uriEscapePath");p(this,"applyChecksum");this.service=s,this.sha256=i,this.uriEscapePath=a,this.applyChecksum=typeof e=="boolean"?e:!0,this.regionProvider=ps(n),this.credentialProvider=ps(r)}createCanonicalRequest(e,r,n){const s=Object.keys(r).sort();return`${e.method}
${this.getCanonicalPath(e)}
${L3(e)}
${s.map(i=>`${i}:${r[i]}`).join(`
`)}

${s.join(";")}
${n}`}async createStringToSign(e,r,n,s){const i=new this.sha256;i.update(Qo(n));const a=await i.digest();return`${s}
${e}
${r}
${Fr(a)}`}getCanonicalPath({path:e}){if(this.uriEscapePath){const r=[];for(const i of e.split("/"))(i==null?void 0:i.length)!==0&&i!=="."&&(i===".."?r.pop():r.push(i));const n=`${e!=null&&e.startsWith("/")?"/":""}${r.join("/")}${r.length>0&&(e!=null&&e.endsWith("/"))?"/":""}`;return Ti(n).replace(/%2F/g,"/")}return e}validateResolvedCredentials(e){if(typeof e!="object"||typeof e.accessKeyId!="string"||typeof e.secretAccessKey!="string")throw new Error("Resolved credential object is not valid")}formatDate(e){const r=M3(e).replace(/[\-:]/g,"");return{longDate:r,shortDate:r.slice(0,8)}}getCanonicalHeaderList(e){return Object.keys(e).sort().join(";")}}class i0 extends U3{constructor({applyChecksum:r,credentials:n,region:s,service:i,sha256:a,uriEscapePath:o=!0}){super({applyChecksum:r,credentials:n,region:s,service:i,sha256:a,uriEscapePath:o});p(this,"headerFormatter",new R3)}async presign(r,n={}){const{signingDate:s=new Date,expiresIn:i=3600,unsignableHeaders:a,unhoistableHeaders:o,signableHeaders:c,hoistableHeaders:l,signingRegion:u,signingService:d}=n,h=await this.credentialProvider();this.validateResolvedCredentials(h);const f=u??await this.regionProvider(),{longDate:m,shortDate:g}=this.formatDate(s);if(i>C3)return Promise.reject("Signature version 4 presigned URLs must have an expiration date less than one week in the future");const y=jf(g,f,d??this.service),b=P3(s0(r),{unhoistableHeaders:o,hoistableHeaders:l});h.sessionToken&&(b.query[YA]=h.sessionToken),b.query[f3]=Uf,b.query[p3]=`${h.accessKeyId}/${y}`,b.query[KA]=m,b.query[g3]=i.toString(10);const _=t0(b,a,c);return b.query[m3]=this.getCanonicalHeaderList(_),b.query[XA]=await this.getSignature(m,y,this.getSigningKey(h,f,g,d),this.createCanonicalRequest(b,_,await Ff(r,this.sha256))),b}async sign(r,n){return typeof r=="string"?this.signString(r,n):r.headers&&r.payload?this.signEvent(r,n):r.message?this.signMessage(r,n):this.signRequest(r,n)}async signEvent({headers:r,payload:n},{signingDate:s=new Date,priorSignature:i,signingRegion:a,signingService:o}){const c=a??await this.regionProvider(),{shortDate:l,longDate:u}=this.formatDate(s),d=jf(l,c,o??this.service),h=await Ff({headers:{},body:n},this.sha256),f=new this.sha256;f.update(r);const m=Fr(await f.digest()),g=[x3,u,d,i,m,h].join(`
`);return this.signString(g,{signingDate:s,signingRegion:c,signingService:o})}async signMessage(r,{signingDate:n=new Date,signingRegion:s,signingService:i}){return this.signEvent({headers:this.headerFormatter.format(r.message.headers),payload:r.message.body},{signingDate:n,signingRegion:s,signingService:i,priorSignature:r.priorSignature}).then(o=>({message:r.message,signature:o}))}async signString(r,{signingDate:n=new Date,signingRegion:s,signingService:i}={}){const a=await this.credentialProvider();this.validateResolvedCredentials(a);const o=s??await this.regionProvider(),{shortDate:c}=this.formatDate(n),l=new this.sha256(await this.getSigningKey(a,o,c,i));return l.update(Qo(r)),Fr(await l.digest())}async signRequest(r,{signingDate:n=new Date,signableHeaders:s,unsignableHeaders:i,signingRegion:a,signingService:o}={}){const c=await this.credentialProvider();this.validateResolvedCredentials(c);const l=a??await this.regionProvider(),u=s0(r),{longDate:d,shortDate:h}=this.formatDate(n),f=jf(h,l,o??this.service);u.headers[eC]=d,c.sessionToken&&(u.headers[b3]=c.sessionToken);const m=await Ff(u,this.sha256);!N3(am,u.headers)&&this.applyChecksum&&(u.headers[am]=m);const g=t0(u,i,s),y=await this.getSignature(d,f,this.getSigningKey(c,l,h,o),this.createCanonicalRequest(u,g,m));return u.headers[QA]=`${Uf} Credential=${c.accessKeyId}/${f}, SignedHeaders=${this.getCanonicalHeaderList(g)}, Signature=${y}`,u}async getSignature(r,n,s,i){const a=await this.createStringToSign(r,n,i,Uf),o=new this.sha256(await s);return o.update(Qo(a)),Fr(await o.digest())}getSigningKey(r,n,s,i){return k3(this.sha256,r,s,n,i||this.service)}}const B3=t=>{let e=t.credentials,r=!!t.credentials,n;Object.defineProperty(t,"credentials",{set(l){l&&l!==e&&l!==n&&(r=!0),e=l;const u=j3(t,{credentials:e,credentialDefaultProvider:t.credentialDefaultProvider}),d=F3(t,u);r&&!d.attributed?(n=async h=>d(h).then(f=>c3(f,"CREDENTIALS_CODE","e")),n.memoized=d.memoized,n.configBound=d.configBound,n.attributed=!0):n=d},get(){return n},enumerable:!0,configurable:!0}),t.credentials=e;const{signingEscapePath:s=!0,systemClockOffset:i=t.systemClockOffset||0,sha256:a}=t;let o;return t.signer?o=xo(t.signer):t.regionInfoProvider?o=()=>xo(t.region)().then(async l=>[await t.regionInfoProvider(l,{useFipsEndpoint:await t.useFipsEndpoint(),useDualstackEndpoint:await t.useDualstackEndpoint()})||{},l]).then(([l,u])=>{const{signingRegion:d,signingService:h}=l;t.signingRegion=t.signingRegion||d||u,t.signingName=t.signingName||h||t.serviceId;const f={...t,credentials:t.credentials,region:t.signingRegion,service:t.signingName,sha256:a,uriEscapePath:s},m=t.signerConstructor||i0;return new m(f)}):o=async l=>{l=Object.assign({},{name:"sigv4",signingName:t.signingName||t.defaultSigningName,signingRegion:await xo(t.region)(),properties:{}},l);const u=l.signingRegion,d=l.signingName;t.signingRegion=t.signingRegion||u,t.signingName=t.signingName||d||t.serviceId;const h={...t,credentials:t.credentials,region:t.signingRegion,service:t.signingName,sha256:a,uriEscapePath:s},f=t.signerConstructor||i0;return new f(h)},Object.assign(t,{systemClockOffset:i,signingEscapePath:s,signer:o})};function j3(t,{credentials:e,credentialDefaultProvider:r}){let n;return e?e!=null&&e.memoized?n=e:n=MA(e,LA,iy):r?n=xo(r(Object.assign({},t,{parentClientConfig:t}))):n=async()=>{throw new Error("@aws-sdk/core::resolveAwsSdkSigV4Config - `credentials` not provided and no credentialDefaultProvider was configured.")},n.memoized=!0,n}function F3(t,e){if(e.configBound)return e;const r=async n=>e({...n,callerClientConfig:t});return r.memoized=e.memoized,r.configBound=!0,r}const a0=typeof TextEncoder=="function"?new TextEncoder:null,z3=t=>{if(typeof t=="string"){if(a0)return a0.encode(t).byteLength;let e=t.length;for(let r=e-1;r>=0;r--){const n=t.charCodeAt(r);n>127&&n<=2047?e++:n>2047&&n<=65535&&(e+=2),n>=56320&&n<=57343&&r--}return e}else{if(typeof t.byteLength=="number")return t.byteLength;if(typeof t.size=="number")return t.size}throw new Error(`Body Length computation failed for ${t}`)},ni=(t,e)=>{const r=[];if(t&&r.push(t),e)for(const n of e)r.push(n);return r},Cs=(t,e)=>`${t||"anonymous"}${e&&e.length>0?` (a.k.a. ${e.join(",")})`:""}`,$u=()=>{let t=[],e=[],r=!1;const n=new Set,s=d=>d.sort((h,f)=>o0[f.step]-o0[h.step]||c0[f.priority||"normal"]-c0[h.priority||"normal"]),i=d=>{let h=!1;const f=m=>{const g=ni(m.name,m.aliases);if(g.includes(d)){h=!0;for(const y of g)n.delete(y);return!1}return!0};return t=t.filter(f),e=e.filter(f),h},a=d=>{let h=!1;const f=m=>{if(m.middleware===d){h=!0;for(const g of ni(m.name,m.aliases))n.delete(g);return!1}return!0};return t=t.filter(f),e=e.filter(f),h},o=d=>{var h;return t.forEach(f=>{d.add(f.middleware,{...f})}),e.forEach(f=>{d.addRelativeTo(f.middleware,{...f})}),(h=d.identifyOnResolve)==null||h.call(d,u.identifyOnResolve()),d},c=d=>{const h=[];return d.before.forEach(f=>{f.before.length===0&&f.after.length===0?h.push(f):h.push(...c(f))}),h.push(d),d.after.reverse().forEach(f=>{f.before.length===0&&f.after.length===0?h.push(f):h.push(...c(f))}),h},l=(d=!1)=>{const h=[],f=[],m={};return t.forEach(y=>{const b={...y,before:[],after:[]};for(const _ of ni(b.name,b.aliases))m[_]=b;h.push(b)}),e.forEach(y=>{const b={...y,before:[],after:[]};for(const _ of ni(b.name,b.aliases))m[_]=b;f.push(b)}),f.forEach(y=>{if(y.toMiddleware){const b=m[y.toMiddleware];if(b===void 0){if(d)return;throw new Error(`${y.toMiddleware} is not found when adding ${Cs(y.name,y.aliases)} middleware ${y.relation} ${y.toMiddleware}`)}y.relation==="after"&&b.after.push(y),y.relation==="before"&&b.before.push(y)}}),s(h).map(c).reduce((y,b)=>(y.push(...b),y),[])},u={add:(d,h={})=>{const{name:f,override:m,aliases:g}=h,y={step:"initialize",priority:"normal",middleware:d,...h},b=ni(f,g);if(b.length>0){if(b.some(_=>n.has(_))){if(!m)throw new Error(`Duplicate middleware name '${Cs(f,g)}'`);for(const _ of b){const E=t.findIndex(k=>{var R;return k.name===_||((R=k.aliases)==null?void 0:R.some($=>$===_))});if(E===-1)continue;const C=t[E];if(C.step!==y.step||y.priority!==C.priority)throw new Error(`"${Cs(C.name,C.aliases)}" middleware with ${C.priority} priority in ${C.step} step cannot be overridden by "${Cs(f,g)}" middleware with ${y.priority} priority in ${y.step} step.`);t.splice(E,1)}}for(const _ of b)n.add(_)}t.push(y)},addRelativeTo:(d,h)=>{const{name:f,override:m,aliases:g}=h,y={middleware:d,...h},b=ni(f,g);if(b.length>0){if(b.some(_=>n.has(_))){if(!m)throw new Error(`Duplicate middleware name '${Cs(f,g)}'`);for(const _ of b){const E=e.findIndex(k=>{var R;return k.name===_||((R=k.aliases)==null?void 0:R.some($=>$===_))});if(E===-1)continue;const C=e[E];if(C.toMiddleware!==y.toMiddleware||C.relation!==y.relation)throw new Error(`"${Cs(C.name,C.aliases)}" middleware ${C.relation} "${C.toMiddleware}" middleware cannot be overridden by "${Cs(f,g)}" middleware ${y.relation} "${y.toMiddleware}" middleware.`);e.splice(E,1)}}for(const _ of b)n.add(_)}e.push(y)},clone:()=>o($u()),use:d=>{d.applyToStack(u)},remove:d=>typeof d=="string"?i(d):a(d),removeByTag:d=>{let h=!1;const f=m=>{const{tags:g,name:y,aliases:b}=m;if(g&&g.includes(d)){const _=ni(y,b);for(const E of _)n.delete(E);return h=!0,!1}return!0};return t=t.filter(f),e=e.filter(f),h},concat:d=>{var f;const h=o($u());return h.use(d),h.identifyOnResolve(r||h.identifyOnResolve()||(((f=d.identifyOnResolve)==null?void 0:f.call(d))??!1)),h},applyToStack:o,identify:()=>l(!0).map(d=>{const h=d.step??d.relation+" "+d.toMiddleware;return Cs(d.name,d.aliases)+" - "+h}),identifyOnResolve(d){return typeof d=="boolean"&&(r=d),r},resolve:(d,h)=>{for(const f of l().map(m=>m.middleware).reverse())d=f(d,h);return r&&console.log(u.identify()),d}};return u},o0={initialize:5,serialize:4,build:3,finalizeRequest:2,deserialize:1},c0={high:3,normal:2,low:1};class V3{constructor(e){p(this,"config");p(this,"middlewareStack",$u());p(this,"initConfig");p(this,"handlers");this.config=e}send(e,r,n){const s=typeof r!="function"?r:void 0,i=typeof r=="function"?r:n,a=s===void 0&&this.config.cacheMiddleware===!0;let o;if(a){this.handlers||(this.handlers=new WeakMap);const c=this.handlers;c.has(e.constructor)?o=c.get(e.constructor):(o=e.resolveMiddleware(this.middlewareStack,this.config,s),c.set(e.constructor,o))}else delete this.handlers,o=e.resolveMiddleware(this.middlewareStack,this.config,s);if(i)o(e).then(c=>i(null,c.output),c=>i(c)).catch(()=>{});else return o(e).then(c=>c.output)}destroy(){var e,r,n;(n=(r=(e=this.config)==null?void 0:e.requestHandler)==null?void 0:r.destroy)==null||n.call(r),delete this.handlers}}const zf="***SensitiveInformation***";function om(t,e){if(e==null)return e;const r=tc.of(t);if(r.getMergedTraits().sensitive)return zf;if(r.isListSchema()){if(!!r.getValueSchema().getMergedTraits().sensitive)return zf}else if(r.isMapSchema()){if(!!r.getKeySchema().getMergedTraits().sensitive||!!r.getValueSchema().getMergedTraits().sensitive)return zf}else if(r.isStructSchema()&&typeof e=="object"){const n=e,s={};for(const[i,a]of r.structIterator())n[i]!=null&&(s[i]=om(a,n[i]));return s}return e}class oy{constructor(){p(this,"middlewareStack",$u());p(this,"schema")}static classBuilder(){return new q3}resolveMiddlewareWithContext(e,r,n,{middlewareFn:s,clientName:i,commandName:a,inputFilterSensitiveLog:o,outputFilterSensitiveLog:c,smithyContext:l,additionalContext:u,CommandCtor:d}){for(const y of s.bind(this)(d,e,r,n))this.middlewareStack.use(y);const h=e.concat(this.middlewareStack),{logger:f}=r,m={logger:f,clientName:i,commandName:a,inputFilterSensitiveLog:o,outputFilterSensitiveLog:c,[nm]:{commandInstance:this,...l},...u},{requestHandler:g}=r;return h.resolve(y=>g.handle(y.request,n||{}),m)}}class q3{constructor(){p(this,"_init",()=>{});p(this,"_ep",{});p(this,"_middlewareFn",()=>[]);p(this,"_commandName","");p(this,"_clientName","");p(this,"_additionalContext",{});p(this,"_smithyContext",{});p(this,"_inputFilterSensitiveLog");p(this,"_outputFilterSensitiveLog");p(this,"_serializer",null);p(this,"_deserializer",null);p(this,"_operationSchema")}init(e){this._init=e}ep(e){return this._ep=e,this}m(e){return this._middlewareFn=e,this}s(e,r,n={}){return this._smithyContext={service:e,operation:r,...n},this}c(e={}){return this._additionalContext=e,this}n(e,r){return this._clientName=e,this._commandName=r,this}f(e=n=>n,r=n=>n){return this._inputFilterSensitiveLog=e,this._outputFilterSensitiveLog=r,this}ser(e){return this._serializer=e,this}de(e){return this._deserializer=e,this}sc(e){return this._operationSchema=e,this._smithyContext.operationSchema=e,this}build(){const e=this;let r;return r=class extends oy{constructor(...[s]){super();p(this,"input");p(this,"serialize",e._serializer);p(this,"deserialize",e._deserializer);this.input=s??{},e._init(this),this.schema=e._operationSchema}static getEndpointParameterInstructions(){return e._ep}resolveMiddleware(s,i,a){const o=e._operationSchema,c=(o==null?void 0:o[4])??(o==null?void 0:o.input),l=(o==null?void 0:o[5])??(o==null?void 0:o.output);return this.resolveMiddlewareWithContext(s,i,a,{CommandCtor:r,middlewareFn:e._middlewareFn,clientName:e._clientName,commandName:e._commandName,inputFilterSensitiveLog:e._inputFilterSensitiveLog??(o?om.bind(null,c):u=>u),outputFilterSensitiveLog:e._outputFilterSensitiveLog??(o?om.bind(null,l):u=>u),smithyContext:e._smithyContext,additionalContext:e._additionalContext})}}}}const ws="***SensitiveInformation***";class ha extends Error{constructor(r){super(r.message);p(this,"$fault");p(this,"$response");p(this,"$retryable");p(this,"$metadata");Object.setPrototypeOf(this,Object.getPrototypeOf(this).constructor.prototype),this.name=r.name,this.$fault=r.$fault,this.$metadata=r.$metadata}static isInstance(r){if(!r)return!1;const n=r;return ha.prototype.isPrototypeOf(n)||!!n.$fault&&!!n.$metadata&&(n.$fault==="client"||n.$fault==="server")}static[Symbol.hasInstance](r){if(!r)return!1;const n=r;return this===ha?ha.isInstance(r):ha.isInstance(r)?n.name&&this.name?this.prototype.isPrototypeOf(r)||n.name===this.name:this.prototype.isPrototypeOf(r):!1}}const Gr=(t,e={})=>{Object.entries(e).filter(([,n])=>n!==void 0).forEach(([n,s])=>{(t[n]==null||t[n]==="")&&(t[n]=s)});const r=t.message||t.Message||"UnknownError";return t.message=r,delete t.Message,t},H3=({output:t,parsedBody:e,exceptionCtor:r,errorCode:n})=>{const s=W3(t),i=s.httpStatusCode?s.httpStatusCode+"":void 0,a=new r({name:(e==null?void 0:e.code)||(e==null?void 0:e.Code)||n||i||"UnknownError",$fault:"client",$metadata:s});throw Gr(a,e)},G3=t=>({output:e,parsedBody:r,errorCode:n})=>{H3({output:e,parsedBody:r,exceptionCtor:t,errorCode:n})},W3=t=>({httpStatusCode:t.statusCode,requestId:t.headers["x-amzn-requestid"]??t.headers["x-amzn-request-id"]??t.headers["x-amz-request-id"],extendedRequestId:t.headers["x-amz-id-2"],cfId:t.headers["x-amz-cf-id"]}),J3=t=>{switch(t){case"standard":return{retryMode:"standard",connectionTimeout:3100};case"in-region":return{retryMode:"standard",connectionTimeout:1100};case"cross-region":return{retryMode:"standard",connectionTimeout:3100};case"mobile":return{retryMode:"standard",connectionTimeout:3e4};default:return{}}},Z3=t=>{const e=[];for(const r in Cu){const n=Cu[r];t[n]!==void 0&&e.push({algorithmId:()=>n,checksumConstructor:()=>t[n]})}return{addChecksumAlgorithm(r){e.push(r)},checksumAlgorithms(){return e}}},K3=t=>{const e={};return t.checksumAlgorithms().forEach(r=>{e[r.algorithmId()]=r.checksumConstructor()}),e},X3=t=>({setRetryStrategy(e){t.retryStrategy=e},retryStrategy(){return t.retryStrategy}}),Y3=t=>{const e={};return e.retryStrategy=t.retryStrategy(),e},Q3=t=>Object.assign(Z3(t),X3(t)),e6=t=>Object.assign(K3(t),Y3(t));class nC{trace(){}debug(){}info(){}warn(){}error(){}}function Nr(t,e,r){let n,s;n={},s=t;for(const i of Object.keys(s)){if(!Array.isArray(s[i])){n[i]=s[i];continue}sC(n,null,s,i)}return n}const Te=(t,e)=>{const r={};for(const n in e)sC(r,t,e,n);return r},sC=(t,e,r,n)=>{if(e!==null){let a=r[n];typeof a=="function"&&(a=[,a]);const[o=t6,c=r6,l=n]=a;(typeof o=="function"&&o(e[l])||typeof o!="function"&&o)&&(t[n]=c(e[l]));return}let[s,i]=r[n];if(typeof i=="function"){let a;const o=s===void 0&&(a=i())!=null,c=typeof s=="function"&&!!s(void 0)||typeof s!="function"&&!!s;o?t[n]=a:c&&(t[n]=i())}else{const a=s===void 0&&i!=null,o=typeof s=="function"&&!!s(i)||typeof s!="function"&&!!s;(a||o)&&(t[n]=i)}},t6=t=>t!=null,r6=t=>t,l0=t=>{if(t!==t)return"NaN";switch(t){case 1/0:return"Infinity";case-1/0:return"-Infinity";default:return t}},ne=t=>{if(t==null)return{};if(Array.isArray(t))return t.filter(e=>e!=null).map(ne);if(typeof t=="object"){const e={};for(const r of Object.keys(t))t[r]!=null&&(e[r]=ne(t[r]));return e}return t},n6=(t,e)=>pF(t,e).then(r=>((e==null?void 0:e.utf8Encoder)??ry)(r)),Wr=(t,e)=>n6(t,e).then(r=>{if(r.length)try{return JSON.parse(r)}catch(n){throw(n==null?void 0:n.name)==="SyntaxError"&&Object.defineProperty(n,"$responseBodyText",{value:r}),n}return{}}),s6=async(t,e)=>{const r=await Wr(t,e);return r.message=r.message??r.Message,r},i6=(t,e)=>{const r=(i,a)=>Object.keys(i).find(o=>o.toLowerCase()===a.toLowerCase()),n=i=>{let a=i;return typeof a=="number"&&(a=a.toString()),a.indexOf(",")>=0&&(a=a.split(",")[0]),a.indexOf(":")>=0&&(a=a.split(":")[0]),a.indexOf("#")>=0&&(a=a.split("#")[1]),a},s=r(t.headers,"x-amzn-errortype");if(s!==void 0)return n(t.headers[s]);if(e&&typeof e=="object"){const i=r(e,"code");if(i&&e[i]!==void 0)return n(e[i]);if(e.__type!==void 0)return n(e.__type)}},on=t=>{if(t!=null)return typeof t=="object"&&"__type"in t&&delete t.__type,EF(t)},a6=/\d{12}\.ddb/;async function o6(t,e,r){var i,a,o,c,l,u,d;const n=r.request;if(((i=n==null?void 0:n.headers)==null?void 0:i["smithy-protocol"])==="rpc-v2-cbor"&&Rn(t,"PROTOCOL_RPC_V2_CBOR","M"),typeof e.retryStrategy=="function"){const h=await e.retryStrategy();typeof h.acquireInitialRetryToken=="function"?(o=(a=h.constructor)==null?void 0:a.name)!=null&&o.includes("Adaptive")?Rn(t,"RETRY_MODE_ADAPTIVE","F"):Rn(t,"RETRY_MODE_STANDARD","E"):Rn(t,"RETRY_MODE_LEGACY","D")}if(typeof e.accountIdEndpointMode=="function"){const h=t.endpointV2;switch(String((c=h==null?void 0:h.url)==null?void 0:c.hostname).match(a6)&&Rn(t,"ACCOUNT_ID_ENDPOINT","O"),await((l=e.accountIdEndpointMode)==null?void 0:l.call(e))){case"disabled":Rn(t,"ACCOUNT_ID_MODE_DISABLED","Q");break;case"preferred":Rn(t,"ACCOUNT_ID_MODE_PREFERRED","P");break;case"required":Rn(t,"ACCOUNT_ID_MODE_REQUIRED","R");break}}const s=(d=(u=t.__smithy_context)==null?void 0:u.selectedHttpAuthScheme)==null?void 0:d.identity;if(s!=null&&s.$source){const h=s;h.accountId&&Rn(t,"RESOLVED_ACCOUNT_ID","T");for(const[f,m]of Object.entries(h.$source??{}))Rn(t,f,m)}}const u0="user-agent",Vf="x-amz-user-agent",d0=" ",qf="/",c6=/[^\!\$\%\&\'\*\+\-\.\^\_\`\|\~\d\w]/g,l6=/[^\!\$\%\&\'\*\+\-\.\^\_\`\|\~\d\w\#]/g,h0="-",u6=1024;function d6(t){let e="";for(const r in t){const n=t[r];if(e.length+n.length+1<=u6){e.length?e+=","+n:e+=n;continue}break}return e}const h6=t=>(e,r)=>async n=>{var f,m,g,y;const{request:s}=n;if(!Or.isInstance(s))return e(n);const{headers:i}=s,a=((f=r==null?void 0:r.userAgent)==null?void 0:f.map(il))||[],o=(await t.defaultUserAgentProvider()).map(il);await o6(r,t,n);const c=r;o.push(`m/${d6(Object.assign({},(m=r.__smithy_context)==null?void 0:m.features,(g=c.__aws_sdk_context)==null?void 0:g.features))}`);const l=((y=t==null?void 0:t.customUserAgent)==null?void 0:y.map(il))||[],u=await t.userAgentAppId();u&&o.push(il([`app/${u}`]));const d=[].concat([...o,...a,...l]).join(d0),h=[...o.filter(b=>b.startsWith("aws-sdk-")),...l].join(d0);return t.runtime!=="browser"?(h&&(i[Vf]=i[Vf]?`${i[u0]} ${h}`:h),i[u0]=d):i[Vf]=d,e({...n,request:s})},il=t=>{var a;const e=t[0].split(qf).map(o=>o.replace(c6,h0)).join(qf),r=(a=t[1])==null?void 0:a.replace(l6,h0),n=e.indexOf(qf),s=e.substring(0,n);let i=e.substring(n+1);return s==="api"&&(i=i.toLowerCase()),[s,i,r].filter(o=>o&&o.length>0).reduce((o,c,l)=>{switch(l){case 0:return c;case 1:return`${o}/${c}`;default:return`${o}#${c}`}},"")},f6={name:"getUserAgentMiddleware",step:"build",priority:"low",tags:["SET_USER_AGENT","USER_AGENT"],override:!0},p6=t=>({applyToStack:e=>{e.add(h6(t),f6)}});function m6(t,e,r,n){function s(i){return i instanceof r?i:new r(function(a){a(i)})}return new(r||(r=Promise))(function(i,a){function o(u){try{l(n.next(u))}catch(d){a(d)}}function c(u){try{l(n.throw(u))}catch(d){a(d)}}function l(u){u.done?i(u.value):s(u.value).then(o,c)}l((n=n.apply(t,e||[])).next())})}function g6(t,e){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,s,i,a=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(l){return function(u){return c([l,u])}}function c(l){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,l[0]&&(r=0)),r;)try{if(n=1,s&&(i=l[0]&2?s.return:l[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,l[1])).done)return i;switch(s=0,i&&(l=[l[0]&2,i.value]),l[0]){case 0:case 1:i=l;break;case 4:return r.label++,{value:l[1],done:!1};case 5:r.label++,s=l[1],l=[0];continue;case 7:l=r.ops.pop(),r.trys.pop();continue;default:if(i=r.trys,!(i=i.length>0&&i[i.length-1])&&(l[0]===6||l[0]===2)){r=0;continue}if(l[0]===3&&(!i||l[1]>i[0]&&l[1]<i[3])){r.label=l[1];break}if(l[0]===6&&r.label<i[1]){r.label=i[1],i=l;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(l);break}i[2]&&r.ops.pop(),r.trys.pop();continue}l=e.call(t,r)}catch(u){l=[6,u],s=0}finally{n=i=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function y6(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}const _6=t=>new TextEncoder().encode(t);var w6=typeof er<"u"&&er.from?function(t){return er.from(t,"utf8")}:_6;function nc(t){return t instanceof Uint8Array?t:typeof t=="string"?w6(t):ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength/Uint8Array.BYTES_PER_ELEMENT):new Uint8Array(t)}function cm(t){return typeof t=="string"?t.length===0:t.byteLength===0}function b6(t){if(!Uint32Array.from){for(var e=new Uint32Array(t.length),r=0;r<t.length;)e[r]=t[r],r+=1;return e}return Uint32Array.from(t)}var iC=(function(){function t(){this.checksum=4294967295}return t.prototype.update=function(e){var r,n;try{for(var s=y6(e),i=s.next();!i.done;i=s.next()){var a=i.value;this.checksum=this.checksum>>>8^E6[(this.checksum^a)&255]}}catch(o){r={error:o}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return this},t.prototype.digest=function(){return(this.checksum^4294967295)>>>0},t})(),v6=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],E6=b6(v6);class Co{constructor(e){p(this,"bytes");if(this.bytes=e,e.byteLength!==8)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(e){if(e>9223372036854776e3||e<-9223372036854776e3)throw new Error(`${e} is too large (or, if negative, too small) to represent as an Int64`);const r=new Uint8Array(8);for(let n=7,s=Math.abs(Math.round(e));n>-1&&s>0;n--,s/=256)r[n]=s;return e<0&&f0(r),new Co(r)}valueOf(){const e=this.bytes.slice(0),r=e[0]&128;return r&&f0(e),parseInt(Fr(e),16)*(r?-1:1)}toString(){return String(this.valueOf())}}function f0(t){for(let e=0;e<8;e++)t[e]^=255;for(let e=7;e>-1&&(t[e]++,t[e]===0);e--);}class S6{constructor(e,r){p(this,"toUtf8");p(this,"fromUtf8");this.toUtf8=e,this.fromUtf8=r}format(e){const r=[];for(const i of Object.keys(e)){const a=this.fromUtf8(i);r.push(Uint8Array.from([a.byteLength]),a,this.formatHeaderValue(e[i]))}const n=new Uint8Array(r.reduce((i,a)=>i+a.byteLength,0));let s=0;for(const i of r)n.set(i,s),s+=i.byteLength;return n}formatHeaderValue(e){switch(e.type){case"boolean":return Uint8Array.from([e.value?0:1]);case"byte":return Uint8Array.from([2,e.value]);case"short":const r=new DataView(new ArrayBuffer(3));return r.setUint8(0,3),r.setInt16(1,e.value,!1),new Uint8Array(r.buffer);case"integer":const n=new DataView(new ArrayBuffer(5));return n.setUint8(0,4),n.setInt32(1,e.value,!1),new Uint8Array(n.buffer);case"long":const s=new Uint8Array(9);return s[0]=5,s.set(e.value.bytes,1),s;case"binary":const i=new DataView(new ArrayBuffer(3+e.value.byteLength));i.setUint8(0,6),i.setUint16(1,e.value.byteLength,!1);const a=new Uint8Array(i.buffer);return a.set(e.value,3),a;case"string":const o=this.fromUtf8(e.value),c=new DataView(new ArrayBuffer(3+o.byteLength));c.setUint8(0,7),c.setUint16(1,o.byteLength,!1);const l=new Uint8Array(c.buffer);return l.set(o,3),l;case"timestamp":const u=new Uint8Array(9);return u[0]=8,u.set(Co.fromNumber(e.value.valueOf()).bytes,1),u;case"uuid":if(!$6.test(e.value))throw new Error(`Invalid UUID received: ${e.value}`);const d=new Uint8Array(17);return d[0]=9,d.set(ny(e.value.replace(/\-/g,"")),1),d}}parse(e){const r={};let n=0;for(;n<e.byteLength;){const s=e.getUint8(n++),i=this.toUtf8(new Uint8Array(e.buffer,e.byteOffset+n,s));switch(n+=s,e.getUint8(n++)){case 0:r[i]={type:m0,value:!0};break;case 1:r[i]={type:m0,value:!1};break;case 2:r[i]={type:x6,value:e.getInt8(n++)};break;case 3:r[i]={type:T6,value:e.getInt16(n,!1)},n+=2;break;case 4:r[i]={type:A6,value:e.getInt32(n,!1)},n+=4;break;case 5:r[i]={type:C6,value:new Co(new Uint8Array(e.buffer,e.byteOffset+n,8))},n+=8;break;case 6:const a=e.getUint16(n,!1);n+=2,r[i]={type:k6,value:new Uint8Array(e.buffer,e.byteOffset+n,a)},n+=a;break;case 7:const o=e.getUint16(n,!1);n+=2,r[i]={type:I6,value:this.toUtf8(new Uint8Array(e.buffer,e.byteOffset+n,o))},n+=o;break;case 8:r[i]={type:R6,value:new Date(new Co(new Uint8Array(e.buffer,e.byteOffset+n,8)).valueOf())},n+=8;break;case 9:const c=new Uint8Array(e.buffer,e.byteOffset+n,16);n+=16,r[i]={type:O6,value:`${Fr(c.subarray(0,4))}-${Fr(c.subarray(4,6))}-${Fr(c.subarray(6,8))}-${Fr(c.subarray(8,10))}-${Fr(c.subarray(10))}`};break;default:throw new Error("Unrecognized header type tag")}}return r}}var p0;(function(t){t[t.boolTrue=0]="boolTrue",t[t.boolFalse=1]="boolFalse",t[t.byte=2]="byte",t[t.short=3]="short",t[t.integer=4]="integer",t[t.long=5]="long",t[t.byteArray=6]="byteArray",t[t.string=7]="string",t[t.timestamp=8]="timestamp",t[t.uuid=9]="uuid"})(p0||(p0={}));const m0="boolean",x6="byte",T6="short",A6="integer",C6="long",k6="binary",I6="string",R6="timestamp",O6="uuid",$6=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/,aC=4,Rs=aC*2,ci=4,N6=Rs+ci*2;function P6({byteLength:t,byteOffset:e,buffer:r}){if(t<N6)throw new Error("Provided message too short to accommodate event stream message overhead");const n=new DataView(r,e,t),s=n.getUint32(0,!1);if(t!==s)throw new Error("Reported message length does not match received message length");const i=n.getUint32(aC,!1),a=n.getUint32(Rs,!1),o=n.getUint32(t-ci,!1),c=new iC().update(new Uint8Array(r,e,Rs));if(a!==c.digest())throw new Error(`The prelude checksum specified in the message (${a}) does not match the calculated CRC32 checksum (${c.digest()})`);if(c.update(new Uint8Array(r,e+Rs,t-(Rs+ci))),o!==c.digest())throw new Error(`The message checksum (${c.digest()}) did not match the expected value of ${o}`);return{headers:new DataView(r,e+Rs+ci,i),body:new Uint8Array(r,e+Rs+ci+i,s-i-(Rs+ci+ci))}}class oC{constructor(e,r){p(this,"headerMarshaller");p(this,"messageBuffer");p(this,"isEndOfStream");this.headerMarshaller=new S6(e,r),this.messageBuffer=[],this.isEndOfStream=!1}feed(e){this.messageBuffer.push(this.decode(e))}endOfStream(){this.isEndOfStream=!0}getMessage(){const e=this.messageBuffer.pop(),r=this.isEndOfStream;return{getMessage(){return e},isEndOfStream(){return r}}}getAvailableMessages(){const e=this.messageBuffer;this.messageBuffer=[];const r=this.isEndOfStream;return{getMessages(){return e},isEndOfStream(){return r}}}encode({headers:e,body:r}){const n=this.headerMarshaller.format(e),s=n.byteLength+r.byteLength+16,i=new Uint8Array(s),a=new DataView(i.buffer,i.byteOffset,i.byteLength),o=new iC;return a.setUint32(0,s,!1),a.setUint32(4,n.byteLength,!1),a.setUint32(8,o.update(i.subarray(0,8)).digest(),!1),i.set(n,12),i.set(r,n.byteLength+12),a.setUint32(s-4,o.update(i.subarray(8,s-4)).digest(),!1),i}decode(e){const{headers:r,body:n}=P6(e);return{headers:this.headerMarshaller.parse(r),body:n}}formatHeaders(e){return this.headerMarshaller.format(e)}}class L6{constructor(e){p(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.inputStream)yield this.options.decoder.decode(e)}}class M6{constructor(e){p(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.messageStream)yield this.options.encoder.encode(e);this.options.includeEndFrame&&(yield new Uint8Array(0))}}class D6{constructor(e){p(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.messageStream){const r=await this.options.deserializer(e);r!==void 0&&(yield r)}}}class U6{constructor(e){p(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.inputStream)yield this.options.serializer(e)}}const B6=(t,e,r,n)=>{let s=t;const i={start(){},async transform(a,o){try{const c=new Date(Date.now()+await n()),l={":date":{type:"timestamp",value:c}},u=await e.sign({message:{body:a,headers:l},priorSignature:s},{signingDate:c});s=u.signature;const d=r.encode({headers:{...l,":chunk-signature":{type:"binary",value:ny(u.signature)}},body:a});o.enqueue(d)}catch(c){o.error(c)}}};return new TransformStream({...i})};class j6{constructor(e){p(this,"messageSigner");p(this,"eventStreamCodec");p(this,"systemClockOffsetProvider");this.messageSigner=e.messageSigner,this.eventStreamCodec=new oC(e.utf8Encoder,e.utf8Decoder),this.systemClockOffsetProvider=async()=>e.systemClockOffset??0}async handle(e,r,n={}){const s=r.request,{body:i,headers:a,query:o}=s;if(!(i instanceof ReadableStream))throw new Error("Eventstream payload must be a ReadableStream.");const c=new TransformStream;s.body=c.readable;let l;try{l=await e(r)}catch(m){throw s.body.cancel(),m}const d=((a.authorization||"").match(/Signature=([\w]+)$/)||[])[1]||o&&o["X-Amz-Signature"]||"",h=B6(d,await this.messageSigner(),this.eventStreamCodec,this.systemClockOffsetProvider);return i.pipeThrough(h).pipeThrough(c),l}}const F6=t=>new j6(t),cC=t=>t.protocol==="ws:"||t.protocol==="wss:";class z6{constructor(e){p(this,"signer");this.signer=e.signer}presign(e,r={}){return this.signer.presign(e,r)}async sign(e,r){return Or.isInstance(e)&&cC(e)?{...await this.signer.presign({...e,body:""},{...r,expiresIn:60,unsignableHeaders:new Set(Object.keys(e.headers).filter(s=>s!=="host"))}),body:e.body}:this.signer.sign(e,r)}}const V6=t=>{const{signer:e}=t;return Object.assign(t,{signer:async r=>{const n=await e(r);if(q6(n))return new z6({signer:n});throw new Error("Expected WebsocketSignatureV4 signer, please check the client constructor.")}})},q6=t=>!!t;function H6(t){const{port:e,query:r}=t;let{protocol:n,path:s,hostname:i}=t;n&&n.slice(-1)!==":"&&(n+=":"),e&&(i+=`:${e}`),s&&s.charAt(0)!=="/"&&(s=`/${s}`);let a=r?OA(r):"";a&&a[0]!=="?"&&(a=`?${a}`);let o="";if(t.username!=null||t.password!=null){const l=t.username??"",u=t.password??"";o=`${l}:${u}@`}let c="";return t.fragment&&(c=`#${t.fragment}`),`${n}//${o}${i}${s}${a}${c}`}function G6(t){let e=0,r=0,n=null,s=null;const i=o=>{if(typeof o!="number")throw new Error("Attempted to allocate an event message where size was not a number: "+o);e=o,r=4,n=new Uint8Array(o),new DataView(n.buffer).setUint32(0,o,!1)},a=async function*(){const o=t[Symbol.asyncIterator]();for(;;){const{value:c,done:l}=await o.next();if(l){if(e)if(e===r)yield n;else throw new Error("Truncated event message received.");else return;return}const u=c.length;let d=0;for(;d<u;){if(!n){const f=u-d;s||(s=new Uint8Array(4));const m=Math.min(4-r,f);if(s.set(c.slice(d,d+m),r),r+=m,d+=m,r<4)break;i(new DataView(s.buffer).getUint32(0,!1)),s=null}const h=Math.min(e-r,u-d);n.set(c.slice(d,d+h),r),r+=h,d+=h,e&&e===r&&(yield n,n=null,e=0,r=0)}}};return{[Symbol.asyncIterator]:a}}function W6(t,e){return async function(r){const{value:n}=r.headers[":message-type"];if(n==="error"){const s=new Error(r.headers[":error-message"].value||"UnknownError");throw s.name=r.headers[":error-code"].value,s}else if(n==="exception"){const s=r.headers[":exception-type"].value,i={[s]:r},a=await t(i);if(a.$unknown){const o=new Error(e(r.body));throw o.name=s,o}throw a[s]}else if(n==="event"){const s={[r.headers[":event-type"].value]:r},i=await t(s);return i.$unknown?void 0:i}else throw Error(`Unrecognizable event type: ${r.headers[":event-type"].value}`)}}let J6=class{constructor({utf8Encoder:e,utf8Decoder:r}){p(this,"eventStreamCodec");p(this,"utfEncoder");this.eventStreamCodec=new oC(e,r),this.utfEncoder=e}deserialize(e,r){const n=G6(e);return new D6({messageStream:new L6({inputStream:n,decoder:this.eventStreamCodec}),deserializer:W6(r,this.utfEncoder)})}serialize(e,r){return new M6({messageStream:new U6({inputStream:e,serializer:r}),encoder:this.eventStreamCodec,includeEndFrame:!0})}};const lC=t=>({[Symbol.asyncIterator]:async function*(){const e=t.getReader();try{for(;;){const{done:r,value:n}=await e.read();if(r)return;yield n}}finally{e.releaseLock()}}}),uC=t=>{const e=t[Symbol.asyncIterator]();return new ReadableStream({async pull(r){const{done:n,value:s}=await e.next();if(n)return r.close();r.enqueue(s)}})};class Z6{constructor({utf8Encoder:e,utf8Decoder:r}){p(this,"universalMarshaller");this.universalMarshaller=new J6({utf8Decoder:r,utf8Encoder:e})}deserialize(e,r){const n=K6(e)?lC(e):e;return this.universalMarshaller.deserialize(n,r)}serialize(e,r){const n=this.universalMarshaller.serialize(e,r);return typeof ReadableStream=="function"?uC(n):n}}const K6=t=>typeof ReadableStream=="function"&&t instanceof ReadableStream,X6=t=>new Z6(t),Y6=2e3;class cy{constructor(e,r=new ec){p(this,"metadata",{handlerProtocol:"websocket/h1.1"});p(this,"config");p(this,"configPromise");p(this,"httpHandler");p(this,"sockets",{});this.httpHandler=r,typeof e=="function"?(this.config={},this.configPromise=e().then(n=>this.config=n??{})):(this.config=e??{},this.configPromise=Promise.resolve(this.config))}static create(e,r=new ec){return typeof(e==null?void 0:e.handle)=="function"?e:new cy(e,r)}destroy(){for(const[e,r]of Object.entries(this.sockets)){for(const n of r)n.close(1e3,"Socket closed through destroy() call");delete this.sockets[e]}}async handle(e){if(!cC(e))return this.httpHandler.handle(e);const r=H6(e),n=new WebSocket(r);this.sockets[r]||(this.sockets[r]=[]),this.sockets[r].push(n),n.binaryType="arraybuffer",this.config=await this.configPromise;const{connectionTimeout:s=Y6}=this.config;await this.waitForReady(n,s);const{body:i}=e,a=Q6(i),o=this.connect(n,a),c=e8(o);return{response:new Oa({statusCode:200,body:c})}}updateHttpClientConfig(e,r){this.configPromise=this.configPromise.then(n=>(n[e]=r,n))}httpHandlerConfigs(){return this.config??{}}removeNotUsableSockets(e){this.sockets[e]=(this.sockets[e]??[]).filter(r=>![WebSocket.CLOSING,WebSocket.CLOSED].includes(r.readyState))}waitForReady(e,r){return new Promise((n,s)=>{const i=setTimeout(()=>{this.removeNotUsableSockets(e.url),s({$metadata:{httpStatusCode:500}})},r);e.onopen=()=>{clearTimeout(i),n()}})}connect(e,r){let n,s=!1,i=()=>{},a=()=>{};e.onmessage=l=>{a({done:!1,value:new Uint8Array(l.data)})},e.onerror=l=>{s=!0,e.close(),i(l)},e.onclose=()=>{this.removeNotUsableSockets(e.url),!s&&(n?i(n):a({done:!0,value:void 0}))};const o={[Symbol.asyncIterator]:()=>({next:()=>new Promise((l,u)=>{a=l,i=u})})};return(async()=>{try{for await(const l of r)e.send(l)}catch(l){n=l}finally{e.close(1e3)}})(),o}}const Q6=t=>t[Symbol.asyncIterator]?t:t8(t)?lC(t):{[Symbol.asyncIterator]:async function*(){yield t}},e8=t=>typeof ReadableStream=="function"?uC(t):t,t8=t=>typeof ReadableStream=="function"&&t instanceof ReadableStream,r8=!1,n8=!1,g0=new Set,s8=(t,e=Ed)=>{if(!g0.has(t)&&!e(t))throw new Error(`Region not accepted: region="${t}" is not a valid hostname component.`);g0.add(t)},dC=t=>typeof t=="string"&&(t.startsWith("fips-")||t.endsWith("-fips")),i8=t=>dC(t)?["fips-aws-global","aws-fips"].includes(t)?"us-east-1":t.replace(/fips-(dkr-|prod-)?|-fips/,""):t,a8=t=>{const{region:e,useFipsEndpoint:r}=t;if(!e)throw new Error("Region is missing");return Object.assign(t,{region:async()=>{const n=typeof e=="function"?await e():e,s=i8(n);return s8(s),s},useFipsEndpoint:async()=>{const n=typeof e=="string"?e:await e();return dC(n)?!0:typeof r!="function"?Promise.resolve(!!r):r()}})},o8=t=>Object.assign(t,{eventStreamMarshaller:t.eventStreamSerdeProvider(t)}),y0="content-length";function c8(t){return e=>async r=>{const n=r.request;if(Or.isInstance(n)){const{body:s,headers:i}=n;if(s&&Object.keys(i).map(a=>a.toLowerCase()).indexOf(y0)===-1)try{const a=t(s);n.headers={...n.headers,[y0]:String(a)}}catch{}}return e({...r,request:n})}}const l8={step:"build",tags:["SET_CONTENT_LENGTH","CONTENT_LENGTH"],name:"contentLengthMiddleware",override:!0},u8=t=>({applyToStack:e=>{e.add(c8(t.bodyLengthChecker),l8)}}),d8=async t=>{const e=(t==null?void 0:t.Bucket)||"";if(typeof t.Bucket=="string"&&(t.Bucket=e.replace(/#/g,encodeURIComponent("#")).replace(/\?/g,encodeURIComponent("?"))),g8(e)){if(t.ForcePathStyle===!0)throw new Error("Path-style addressing cannot be used with ARN buckets")}else(!m8(e)||e.indexOf(".")!==-1&&!String(t.Endpoint).startsWith("http:")||e.toLowerCase()!==e||e.length<3)&&(t.ForcePathStyle=!0);return t.DisableMultiRegionAccessPoints&&(t.disableMultiRegionAccessPoints=!0,t.DisableMRAP=!0),t},h8=/^[a-z0-9][a-z0-9\.\-]{1,61}[a-z0-9]$/,f8=/(\d+\.){3}\d+/,p8=/\.\./,m8=t=>h8.test(t)&&!f8.test(t)&&!p8.test(t),g8=t=>{const[e,r,n,,,s]=t.split(":"),i=e==="arn"&&t.split(":").length>=6,a=!!(i&&r&&n&&s);if(i&&!a)throw new Error(`Invalid ARN: ${t} was an invalid ARN.`);return a},y8=(t,e,r)=>{const n=async()=>{const s=r[t]??r[e];return typeof s=="function"?s():s};return t==="credentialScope"||e==="CredentialScope"?async()=>{const s=typeof r.credentials=="function"?await r.credentials():r.credentials;return(s==null?void 0:s.credentialScope)??(s==null?void 0:s.CredentialScope)}:t==="accountId"||e==="AccountId"?async()=>{const s=typeof r.credentials=="function"?await r.credentials():r.credentials;return(s==null?void 0:s.accountId)??(s==null?void 0:s.AccountId)}:t==="endpoint"||e==="endpoint"?async()=>{if(r.isCustomEndpoint===!1)return;const s=await n();if(s&&typeof s=="object"){if("url"in s)return s.url.href;if("hostname"in s){const{protocol:i,hostname:a,port:o,path:c}=s;return`${i}//${a}${o?":"+o:""}${c}`}}return s}:n},hC=async t=>{},fC=t=>typeof t=="object"?"url"in t?Ou(t.url):t:Ou(t),_8=async(t,e,r,n)=>{if(!r.isCustomEndpoint){let a;r.serviceConfiguredEndpoint?a=await r.serviceConfiguredEndpoint():a=await hC(r.serviceId),a&&(r.endpoint=()=>Promise.resolve(fC(a)),r.isCustomEndpoint=!0)}const s=await w8(t,e,r);if(typeof r.endpointProvider!="function")throw new Error("config.endpointProvider is not set.");return r.endpointProvider(s,n)},w8=async(t,e,r)=>{var i;const n={},s=((i=e==null?void 0:e.getEndpointParameterInstructions)==null?void 0:i.call(e))||{};for(const[a,o]of Object.entries(s))switch(o.type){case"staticContextParams":n[a]=o.value;break;case"contextParams":n[a]=t[o.name];break;case"clientContextParams":case"builtInParams":n[a]=await y8(o.name,a,r)();break;case"operationContextParams":n[a]=o.get(t);break;default:throw new Error("Unrecognized endpoint parameter instruction: "+JSON.stringify(o))}return Object.keys(s).length===0&&Object.assign(n,r),String(r.serviceId).toLowerCase()==="s3"&&await d8(n),n},b8=({config:t,instructions:e})=>(r,n)=>async s=>{var o,c,l;t.isCustomEndpoint&&CF(n,"ENDPOINT_OVERRIDE","N");const i=await _8(s.input,{getEndpointParameterInstructions(){return e}},{...t},n);n.endpointV2=i,n.authSchemes=(o=i.properties)==null?void 0:o.authSchemes;const a=(c=n.authSchemes)==null?void 0:c[0];if(a){n.signing_region=a.signingRegion,n.signing_service=a.signingName;const u=vd(n),d=(l=u==null?void 0:u.selectedHttpAuthScheme)==null?void 0:l.httpAuthOption;d&&(d.signingProperties=Object.assign(d.signingProperties||{},{signing_region:a.signingRegion,signingRegion:a.signingRegion,signing_service:a.signingName,signingName:a.signingName,signingRegionSet:a.signingRegionSet},a.properties))}return r({...s})},v8={step:"serialize",tags:["ENDPOINT_PARAMETERS","ENDPOINT_V2","ENDPOINT"],name:"endpointV2Middleware",override:!0,relation:"before",toMiddleware:CA.name},pC=(t,e)=>({applyToStack:r=>{r.addRelativeTo(b8({config:t,instructions:e}),v8)}}),E8=t=>{const e=t.tls??!0,{endpoint:r,useDualstackEndpoint:n,useFipsEndpoint:s}=t,i=r!=null?async()=>fC(await ps(r)()):void 0,o=Object.assign(t,{endpoint:i,tls:e,isCustomEndpoint:!!r,useDualstackEndpoint:ps(n??!1),useFipsEndpoint:ps(s??!1)});let c;return o.serviceConfiguredEndpoint=async()=>(t.serviceId&&!c&&(c=hC(t.serviceId)),c),o};var Na;(function(t){t.STANDARD="standard",t.ADAPTIVE="adaptive"})(Na||(Na={}));const Nu=3,S8=Na.STANDARD,x8=["BandwidthLimitExceeded","EC2ThrottledException","LimitExceededException","PriorRequestNotComplete","ProvisionedThroughputExceededException","RequestLimitExceeded","RequestThrottled","RequestThrottledException","SlowDown","ThrottledException","Throttling","ThrottlingException","TooManyRequestsException","TransactionInProgressException"],T8=["TimeoutError","RequestTimeout","RequestTimeoutException"],A8=[500,502,503,504],C8=["ECONNRESET","ECONNREFUSED","EPIPE","ETIMEDOUT"],k8=["EHOSTUNREACH","ENETUNREACH","ENOTFOUND"],I8=t=>(t==null?void 0:t.$retryable)!==void 0,R8=t=>{var e;return(e=t.$metadata)==null?void 0:e.clockSkewCorrected},O8=t=>{const e=new Set(["Failed to fetch","NetworkError when attempting to fetch resource","The Internet connection appears to be offline","Load failed","Network request failed"]);return t&&t instanceof TypeError?e.has(t.message):!1},mC=t=>{var e,r;return((e=t.$metadata)==null?void 0:e.httpStatusCode)===429||x8.includes(t.name)||((r=t.$retryable)==null?void 0:r.throttling)==!0},ly=(t,e=0)=>{var r;return I8(t)||R8(t)||T8.includes(t.name)||C8.includes((t==null?void 0:t.code)||"")||k8.includes((t==null?void 0:t.code)||"")||A8.includes(((r=t.$metadata)==null?void 0:r.httpStatusCode)||0)||O8(t)||t.cause!==void 0&&e<=10&&ly(t.cause,e+1)},$8=t=>{var e;if(((e=t.$metadata)==null?void 0:e.httpStatusCode)!==void 0){const r=t.$metadata.httpStatusCode;return 500<=r&&r<=599&&!ly(t)}return!1},Gu=class Gu{constructor(e){p(this,"beta");p(this,"minCapacity");p(this,"minFillRate");p(this,"scaleConstant");p(this,"smooth");p(this,"currentCapacity",0);p(this,"enabled",!1);p(this,"lastMaxRate",0);p(this,"measuredTxRate",0);p(this,"requestCount",0);p(this,"fillRate");p(this,"lastThrottleTime");p(this,"lastTimestamp",0);p(this,"lastTxRateBucket");p(this,"maxCapacity");p(this,"timeWindow",0);this.beta=(e==null?void 0:e.beta)??.7,this.minCapacity=(e==null?void 0:e.minCapacity)??1,this.minFillRate=(e==null?void 0:e.minFillRate)??.5,this.scaleConstant=(e==null?void 0:e.scaleConstant)??.4,this.smooth=(e==null?void 0:e.smooth)??.8;const r=this.getCurrentTimeInSeconds();this.lastThrottleTime=r,this.lastTxRateBucket=Math.floor(this.getCurrentTimeInSeconds()),this.fillRate=this.minFillRate,this.maxCapacity=this.minCapacity}getCurrentTimeInSeconds(){return Date.now()/1e3}async getSendToken(){return this.acquireTokenBucket(1)}async acquireTokenBucket(e){if(this.enabled){if(this.refillTokenBucket(),e>this.currentCapacity){const r=(e-this.currentCapacity)/this.fillRate*1e3;await new Promise(n=>Gu.setTimeoutFn(n,r))}this.currentCapacity=this.currentCapacity-e}}refillTokenBucket(){const e=this.getCurrentTimeInSeconds();if(!this.lastTimestamp){this.lastTimestamp=e;return}const r=(e-this.lastTimestamp)*this.fillRate;this.currentCapacity=Math.min(this.maxCapacity,this.currentCapacity+r),this.lastTimestamp=e}updateClientSendingRate(e){let r;if(this.updateMeasuredRate(),mC(e)){const s=this.enabled?Math.min(this.measuredTxRate,this.fillRate):this.measuredTxRate;this.lastMaxRate=s,this.calculateTimeWindow(),this.lastThrottleTime=this.getCurrentTimeInSeconds(),r=this.cubicThrottle(s),this.enableTokenBucket()}else this.calculateTimeWindow(),r=this.cubicSuccess(this.getCurrentTimeInSeconds());const n=Math.min(r,2*this.measuredTxRate);this.updateTokenBucketRate(n)}calculateTimeWindow(){this.timeWindow=this.getPrecise(Math.pow(this.lastMaxRate*(1-this.beta)/this.scaleConstant,1/3))}cubicThrottle(e){return this.getPrecise(e*this.beta)}cubicSuccess(e){return this.getPrecise(this.scaleConstant*Math.pow(e-this.lastThrottleTime-this.timeWindow,3)+this.lastMaxRate)}enableTokenBucket(){this.enabled=!0}updateTokenBucketRate(e){this.refillTokenBucket(),this.fillRate=Math.max(e,this.minFillRate),this.maxCapacity=Math.max(e,this.minCapacity),this.currentCapacity=Math.min(this.currentCapacity,this.maxCapacity)}updateMeasuredRate(){const e=this.getCurrentTimeInSeconds(),r=Math.floor(e*2)/2;if(this.requestCount++,r>this.lastTxRateBucket){const n=this.requestCount/(r-this.lastTxRateBucket);this.measuredTxRate=this.getPrecise(n*this.smooth+this.measuredTxRate*(1-this.smooth)),this.requestCount=0,this.lastTxRateBucket=r}}getPrecise(e){return parseFloat(e.toFixed(8))}};p(Gu,"setTimeoutFn",setTimeout);let lm=Gu;const um=100,gC=20*1e3,N8=500,_0=500,P8=5,L8=10,M8=1,D8="amz-sdk-invocation-id",U8="amz-sdk-request",B8=()=>{let t=um;return{computeNextBackoffDelay:n=>Math.floor(Math.min(gC,Math.random()*2**n*t)),setDelayBase:n=>{t=n}}},w0=({retryDelay:t,retryCount:e,retryCost:r})=>({getRetryCount:()=>e,getRetryDelay:()=>Math.min(gC,t),getRetryCost:()=>r});class yC{constructor(e){p(this,"maxAttempts");p(this,"mode",Na.STANDARD);p(this,"capacity",_0);p(this,"retryBackoffStrategy",B8());p(this,"maxAttemptsProvider");this.maxAttempts=e,this.maxAttemptsProvider=typeof e=="function"?e:async()=>e}async acquireInitialRetryToken(e){return w0({retryDelay:um,retryCount:0})}async refreshRetryTokenForRetry(e,r){const n=await this.getMaxAttempts();if(this.shouldRetry(e,r,n)){const s=r.errorType;this.retryBackoffStrategy.setDelayBase(s==="THROTTLING"?N8:um);const i=this.retryBackoffStrategy.computeNextBackoffDelay(e.getRetryCount()),a=r.retryAfterHint?Math.max(r.retryAfterHint.getTime()-Date.now()||0,i):i,o=this.getCapacityCost(s);return this.capacity-=o,w0({retryDelay:a,retryCount:e.getRetryCount()+1,retryCost:o})}throw new Error("No retry token available")}recordSuccess(e){this.capacity=Math.max(_0,this.capacity+(e.getRetryCost()??M8))}getCapacity(){return this.capacity}async getMaxAttempts(){try{return await this.maxAttemptsProvider()}catch{return console.warn(`Max attempts provider could not resolve. Using default of ${Nu}`),Nu}}shouldRetry(e,r,n){return e.getRetryCount()+1<n&&this.capacity>=this.getCapacityCost(r.errorType)&&this.isRetryableError(r.errorType)}getCapacityCost(e){return e==="TRANSIENT"?L8:P8}isRetryableError(e){return e==="THROTTLING"||e==="TRANSIENT"}}class j8{constructor(e,r){p(this,"maxAttemptsProvider");p(this,"rateLimiter");p(this,"standardRetryStrategy");p(this,"mode",Na.ADAPTIVE);this.maxAttemptsProvider=e;const{rateLimiter:n}=r??{};this.rateLimiter=n??new lm,this.standardRetryStrategy=new yC(e)}async acquireInitialRetryToken(e){return await this.rateLimiter.getSendToken(),this.standardRetryStrategy.acquireInitialRetryToken(e)}async refreshRetryTokenForRetry(e,r){return this.rateLimiter.updateClientSendingRate(r),this.standardRetryStrategy.refreshRetryTokenForRetry(e,r)}recordSuccess(e){this.rateLimiter.updateClientSendingRate({}),this.standardRetryStrategy.recordSuccess(e)}}const F8=t=>t instanceof Error?t:t instanceof Object?Object.assign(new Error,t):typeof t=="string"?new Error(t):new Error(`AWS SDK error wrapper for ${t}`),z8=t=>{const{retryStrategy:e,retryMode:r,maxAttempts:n}=t,s=ps(n??Nu);return Object.assign(t,{maxAttempts:s,retryStrategy:async()=>e||(await ps(r)()===Na.ADAPTIVE?new j8(s):new yC(s))})},V8=t=>(t==null?void 0:t.body)instanceof ReadableStream,q8=t=>(e,r)=>async n=>{var a;let s=await t.retryStrategy();const i=await t.maxAttempts();if(H8(s)){s=s;let o=await s.acquireInitialRetryToken(r.partition_id),c=new Error,l=0,u=0;const{request:d}=n,h=Or.isInstance(d);for(h&&(d.headers[D8]=xF());;)try{h&&(d.headers[U8]=`attempt=${l+1}; max=${i}`);const{response:f,output:m}=await e(n);return s.recordSuccess(o),m.$metadata.attempts=l+1,m.$metadata.totalRetryDelay=u,{response:f,output:m}}catch(f){const m=G8(f);if(c=F8(f),h&&V8(d))throw(a=r.logger instanceof nC?console:r.logger)==null||a.warn("An error was encountered in a non-retryable streaming request."),c;try{o=await s.refreshRetryTokenForRetry(o,m)}catch{throw c.$metadata||(c.$metadata={}),c.$metadata.attempts=l+1,c.$metadata.totalRetryDelay=u,c}l=o.getRetryCount();const g=o.getRetryDelay();u+=g,await new Promise(y=>setTimeout(y,g))}}else return s=s,s!=null&&s.mode&&(r.userAgent=[...r.userAgent||[],["cfg/retry-mode",s.mode]]),s.retry(e,n)},H8=t=>typeof t.acquireInitialRetryToken<"u"&&typeof t.refreshRetryTokenForRetry<"u"&&typeof t.recordSuccess<"u",G8=t=>{const e={error:t,errorType:W8(t)},r=K8(t.$response);return r&&(e.retryAfterHint=r),e},W8=t=>mC(t)?"THROTTLING":ly(t)?"TRANSIENT":$8(t)?"SERVER_ERROR":"CLIENT_ERROR",J8={name:"retryMiddleware",tags:["RETRY"],step:"finalizeRequest",priority:"high",override:!0},Z8=t=>({applyToStack:e=>{e.add(q8(t),J8)}}),K8=t=>{if(!Oa.isInstance(t))return;const e=Object.keys(t.headers).find(i=>i.toLowerCase()==="retry-after");if(!e)return;const r=t.headers[e],n=Number(r);return Number.isNaN(n)?new Date(r):new Date(n*1e3)},X8=async(t,e,r)=>({operation:vd(e).operation,region:await ps(t.region)()||(()=>{throw new Error("expected `region` to be configured for `aws.auth#sigv4`")})()});function Y8(t){return{schemeId:"aws.auth#sigv4",signingProperties:{name:"bedrock",region:t.region},propertiesExtractor:(e,r)=>({signingProperties:{config:e,context:r}})}}function Q8(t){return{schemeId:"smithy.api#httpBearerAuth",propertiesExtractor:({profile:e,filepath:r,configFilepath:n,ignoreCache:s},i)=>({identityProperties:{profile:e,filepath:r,configFilepath:n,ignoreCache:s}})}}const e5=t=>{const e=[];switch(t.operation){default:e.push(Y8(t)),e.push(Q8())}return e},t5=t=>{const e=MA(t.token,LA,iy),r=B3(t);return Object.assign(r,{authSchemePreference:ps(t.authSchemePreference??[]),token:e})},r5=t=>Object.assign(t,{useDualstackEndpoint:t.useDualstackEndpoint??!1,useFipsEndpoint:t.useFipsEndpoint??!1,defaultSigningName:"bedrock"}),_C={UseFIPS:{type:"builtInParams",name:"useFipsEndpoint"},Endpoint:{type:"builtInParams",name:"endpoint"},Region:{type:"builtInParams",name:"region"},UseDualStack:{type:"builtInParams",name:"useDualstackEndpoint"}},n5="3.917.0",s5={version:n5};var wC={name:"SHA-256"},b0={name:"HMAC",hash:wC},i5=new Uint8Array([227,176,196,66,152,252,28,20,154,251,244,200,153,111,185,36,39,174,65,228,100,155,147,76,164,149,153,27,120,82,184,85]);const a5={};function Ml(){return typeof window<"u"?window:typeof self<"u"?self:a5}var o5=(function(){function t(e){this.toHash=new Uint8Array(0),this.secret=e,this.reset()}return t.prototype.update=function(e){if(!cm(e)){var r=nc(e),n=new Uint8Array(this.toHash.byteLength+r.byteLength);n.set(this.toHash,0),n.set(r,this.toHash.byteLength),this.toHash=n}},t.prototype.digest=function(){var e=this;return this.key?this.key.then(function(r){return Ml().crypto.subtle.sign(b0,r,e.toHash).then(function(n){return new Uint8Array(n)})}):cm(this.toHash)?Promise.resolve(i5):Promise.resolve().then(function(){return Ml().crypto.subtle.digest(wC,e.toHash)}).then(function(r){return Promise.resolve(new Uint8Array(r))})},t.prototype.reset=function(){var e=this;this.toHash=new Uint8Array(0),this.secret&&this.secret!==void 0&&(this.key=new Promise(function(r,n){Ml().crypto.subtle.importKey("raw",nc(e.secret),b0,!1,["sign"]).then(r,n)}),this.key.catch(function(){}))},t})(),Kr=64,c5=32,l5=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),u5=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],d5=Math.pow(2,53)-1,Dl=(function(){function t(){this.state=Int32Array.from(u5),this.temp=new Int32Array(64),this.buffer=new Uint8Array(64),this.bufferLength=0,this.bytesHashed=0,this.finished=!1}return t.prototype.update=function(e){if(this.finished)throw new Error("Attempted to update an already finished hash.");var r=0,n=e.byteLength;if(this.bytesHashed+=n,this.bytesHashed*8>d5)throw new Error("Cannot hash more than 2^53 - 1 bits");for(;n>0;)this.buffer[this.bufferLength++]=e[r++],n--,this.bufferLength===Kr&&(this.hashBuffer(),this.bufferLength=0)},t.prototype.digest=function(){if(!this.finished){var e=this.bytesHashed*8,r=new DataView(this.buffer.buffer,this.buffer.byteOffset,this.buffer.byteLength),n=this.bufferLength;if(r.setUint8(this.bufferLength++,128),n%Kr>=Kr-8){for(var s=this.bufferLength;s<Kr;s++)r.setUint8(s,0);this.hashBuffer(),this.bufferLength=0}for(var s=this.bufferLength;s<Kr-8;s++)r.setUint8(s,0);r.setUint32(Kr-8,Math.floor(e/4294967296),!0),r.setUint32(Kr-4,e),this.hashBuffer(),this.finished=!0}for(var i=new Uint8Array(c5),s=0;s<8;s++)i[s*4]=this.state[s]>>>24&255,i[s*4+1]=this.state[s]>>>16&255,i[s*4+2]=this.state[s]>>>8&255,i[s*4+3]=this.state[s]>>>0&255;return i},t.prototype.hashBuffer=function(){for(var e=this,r=e.buffer,n=e.state,s=n[0],i=n[1],a=n[2],o=n[3],c=n[4],l=n[5],u=n[6],d=n[7],h=0;h<Kr;h++){if(h<16)this.temp[h]=(r[h*4]&255)<<24|(r[h*4+1]&255)<<16|(r[h*4+2]&255)<<8|r[h*4+3]&255;else{var f=this.temp[h-2],m=(f>>>17|f<<15)^(f>>>19|f<<13)^f>>>10;f=this.temp[h-15];var g=(f>>>7|f<<25)^(f>>>18|f<<14)^f>>>3;this.temp[h]=(m+this.temp[h-7]|0)+(g+this.temp[h-16]|0)}var y=(((c>>>6|c<<26)^(c>>>11|c<<21)^(c>>>25|c<<7))+(c&l^~c&u)|0)+(d+(l5[h]+this.temp[h]|0)|0)|0,b=((s>>>2|s<<30)^(s>>>13|s<<19)^(s>>>22|s<<10))+(s&i^s&a^i&a)|0;d=u,u=l,l=c,c=o+y|0,o=a,a=i,i=s,s=y+b|0}n[0]+=s,n[1]+=i,n[2]+=a,n[3]+=o,n[4]+=c,n[5]+=l,n[6]+=u,n[7]+=d},t})(),h5=(function(){function t(e){this.secret=e,this.hash=new Dl,this.reset()}return t.prototype.update=function(e){if(!(cm(e)||this.error))try{this.hash.update(nc(e))}catch(r){this.error=r}},t.prototype.digestSync=function(){if(this.error)throw this.error;return this.outer?(this.outer.finished||this.outer.update(this.hash.digest()),this.outer.digest()):this.hash.digest()},t.prototype.digest=function(){return m6(this,void 0,void 0,function(){return g6(this,function(e){return[2,this.digestSync()]})})},t.prototype.reset=function(){if(this.hash=new Dl,this.secret){this.outer=new Dl;var e=f5(this.secret),r=new Uint8Array(Kr);r.set(e);for(var n=0;n<Kr;n++)e[n]^=54,r[n]^=92;this.hash.update(e),this.outer.update(r);for(var n=0;n<e.byteLength;n++)e[n]=0}},t})();function f5(t){var e=nc(t);if(e.byteLength>Kr){var r=new Dl;r.update(e),e=r.digest()}var n=new Uint8Array(Kr);return n.set(e),n}var p5=["decrypt","digest","encrypt","exportKey","generateKey","importKey","sign","verify"];function m5(t){if(g5(t)&&typeof t.crypto.subtle=="object"){var e=t.crypto.subtle;return y5(e)}return!1}function g5(t){if(typeof t=="object"&&typeof t.crypto=="object"){var e=t.crypto.getRandomValues;return typeof e=="function"}return!1}function y5(t){return t&&p5.every(function(e){return typeof t[e]=="function"})}var _5=(function(){function t(e){m5(Ml())?this.hash=new o5(e):this.hash=new h5(e)}return t.prototype.update=function(e,r){this.hash.update(nc(e))},t.prototype.digest=function(){return this.hash.digest()},t.prototype.reset=function(){this.hash.reset()},t})();const w5=({serviceId:t,clientVersion:e})=>async r=>{var f,m,g;const n=typeof window<"u"?window.navigator:void 0,s=(n==null?void 0:n.userAgent)??"",i=((f=n==null?void 0:n.userAgentData)==null?void 0:f.platform)??v0.os(s)??"other",a=void 0,o=((m=n==null?void 0:n.userAgentData)==null?void 0:m.brands)??[],c=o[o.length-1],l=(c==null?void 0:c.brand)??v0.browser(s)??"unknown",u=(c==null?void 0:c.version)??"unknown",d=[["aws-sdk-js",e],["ua","2.1"],[`os/${i}`,a],["lang/js"],["md/browser",`${l}_${u}`]];t&&d.push([`api/${t}`,e]);const h=await((g=r==null?void 0:r.userAgentAppId)==null?void 0:g.call(r));return h&&d.push([`app/${h}`]),d},v0={os(t){if(/iPhone|iPad|iPod/.test(t))return"iOS";if(/Macintosh|Mac OS X/.test(t))return"macOS";if(/Windows NT/.test(t))return"Windows";if(/Android/.test(t))return"Android";if(/Linux/.test(t))return"Linux"},browser(t){if(/EdgiOS|EdgA|Edg\//.test(t))return"Microsoft Edge";if(/Firefox\//.test(t))return"Firefox";if(/Chrome\//.test(t))return"Chrome";if(/Safari\//.test(t))return"Safari"}},b5=t=>()=>Promise.reject(t),bC="required",Bn="fn",jn="argv",ja="ref",E0=!0,S0="isSet",sc="booleanEquals",Ji="error",Za="endpoint",ur="tree",uy="PartitionResult",x0={[bC]:!1,type:"String"},T0={[bC]:!0,default:!1,type:"Boolean"},A0={[ja]:"Endpoint"},vC={[Bn]:sc,[jn]:[{[ja]:"UseFIPS"},!0]},EC={[Bn]:sc,[jn]:[{[ja]:"UseDualStack"},!0]},On={},C0={[Bn]:"getAttr",[jn]:[{[ja]:uy},"supportsFIPS"]},k0={[Bn]:sc,[jn]:[!0,{[Bn]:"getAttr",[jn]:[{[ja]:uy},"supportsDualStack"]}]},I0=[vC],R0=[EC],O0=[{[ja]:"Region"}],v5={parameters:{Region:x0,UseDualStack:T0,UseFIPS:T0,Endpoint:x0},rules:[{conditions:[{[Bn]:S0,[jn]:[A0]}],rules:[{conditions:I0,error:"Invalid Configuration: FIPS and custom endpoint are not supported",type:Ji},{rules:[{conditions:R0,error:"Invalid Configuration: Dualstack and custom endpoint are not supported",type:Ji},{endpoint:{url:A0,properties:On,headers:On},type:Za}],type:ur}],type:ur},{rules:[{conditions:[{[Bn]:S0,[jn]:O0}],rules:[{conditions:[{[Bn]:"aws.partition",[jn]:O0,assign:uy}],rules:[{conditions:[vC,EC],rules:[{conditions:[{[Bn]:sc,[jn]:[E0,C0]},k0],rules:[{rules:[{endpoint:{url:"https://bedrock-runtime-fips.{Region}.{PartitionResult#dualStackDnsSuffix}",properties:On,headers:On},type:Za}],type:ur}],type:ur},{error:"FIPS and DualStack are enabled, but this partition does not support one or both",type:Ji}],type:ur},{conditions:I0,rules:[{conditions:[{[Bn]:sc,[jn]:[C0,E0]}],rules:[{rules:[{endpoint:{url:"https://bedrock-runtime-fips.{Region}.{PartitionResult#dnsSuffix}",properties:On,headers:On},type:Za}],type:ur}],type:ur},{error:"FIPS is enabled but this partition does not support FIPS",type:Ji}],type:ur},{conditions:R0,rules:[{conditions:[k0],rules:[{rules:[{endpoint:{url:"https://bedrock-runtime.{Region}.{PartitionResult#dualStackDnsSuffix}",properties:On,headers:On},type:Za}],type:ur}],type:ur},{error:"DualStack is enabled but this partition does not support DualStack",type:Ji}],type:ur},{rules:[{endpoint:{url:"https://bedrock-runtime.{Region}.{PartitionResult#dnsSuffix}",properties:On,headers:On},type:Za}],type:ur}],type:ur}],type:ur},{error:"Invalid Configuration: Missing Region",type:Ji}],type:ur}]},E5=v5,S5=new LF({size:50,params:["Endpoint","Region","UseDualStack","UseFIPS"]}),x5=(t,e={})=>S5.get(t,()=>e3(E5,{endpointParams:t,logger:e.logger}));Ru.aws=JA;const T5=t=>({apiVersion:"2023-09-30",base64Decoder:(t==null?void 0:t.base64Decoder)??ty,base64Encoder:(t==null?void 0:t.base64Encoder)??RA,disableHostPrefix:(t==null?void 0:t.disableHostPrefix)??!1,endpointProvider:(t==null?void 0:t.endpointProvider)??x5,extensions:(t==null?void 0:t.extensions)??[],httpAuthSchemeProvider:(t==null?void 0:t.httpAuthSchemeProvider)??e5,httpAuthSchemes:(t==null?void 0:t.httpAuthSchemes)??[{schemeId:"aws.auth#sigv4",identityProvider:e=>e.getIdentityProvider("aws.auth#sigv4"),signer:new d3},{schemeId:"smithy.api#httpBearerAuth",identityProvider:e=>e.getIdentityProvider("smithy.api#httpBearerAuth"),signer:new IF}],logger:(t==null?void 0:t.logger)??new nC,serviceId:(t==null?void 0:t.serviceId)??"Bedrock Runtime",urlParser:(t==null?void 0:t.urlParser)??Ou,utf8Decoder:(t==null?void 0:t.utf8Decoder)??$a,utf8Encoder:(t==null?void 0:t.utf8Encoder)??ry}),A5=["in-region","cross-region","mobile","standard","legacy"],C5=({defaultsMode:t}={})=>h3(async()=>{const e=typeof t=="function"?await t():t;switch(e==null?void 0:e.toLowerCase()){case"auto":return Promise.resolve(k5()?"mobile":"standard");case"mobile":case"in-region":case"cross-region":case"standard":case"legacy":return Promise.resolve(e==null?void 0:e.toLocaleLowerCase());case void 0:return Promise.resolve("legacy");default:throw new Error(`Invalid parameter for "defaultsMode", expect ${A5.join(", ")}, got ${e}`)}}),k5=()=>{var e;const t=window==null?void 0:window.navigator;if(t!=null&&t.connection){const{effectiveType:r,rtt:n,downlink:s}=t==null?void 0:t.connection;if(typeof r=="string"&&r!=="4g"||Number(n)>100||Number(s)<10)return!0}return((e=t==null?void 0:t.userAgentData)==null?void 0:e.mobile)||typeof(t==null?void 0:t.maxTouchPoints)=="number"&&(t==null?void 0:t.maxTouchPoints)>1},I5=t=>{const e=C5(t),r=()=>e().then(J3),n=T5(t);return{...n,...t,runtime:"browser",defaultsMode:e,bodyLengthChecker:(t==null?void 0:t.bodyLengthChecker)??z3,credentialDefaultProvider:(t==null?void 0:t.credentialDefaultProvider)??(s=>()=>Promise.reject(new Error("Credential is missing"))),defaultUserAgentProvider:(t==null?void 0:t.defaultUserAgentProvider)??w5({serviceId:n.serviceId,clientVersion:s5.version}),eventStreamPayloadHandlerProvider:(t==null?void 0:t.eventStreamPayloadHandlerProvider)??F6,eventStreamSerdeProvider:(t==null?void 0:t.eventStreamSerdeProvider)??X6,maxAttempts:(t==null?void 0:t.maxAttempts)??Nu,region:(t==null?void 0:t.region)??b5("Region is missing"),requestHandler:cy.create((t==null?void 0:t.requestHandler)??r,ec.create(r)),retryMode:(t==null?void 0:t.retryMode)??(async()=>(await r()).retryMode||S8),sha256:(t==null?void 0:t.sha256)??_5,streamCollector:(t==null?void 0:t.streamCollector)??uF,useDualstackEndpoint:(t==null?void 0:t.useDualstackEndpoint)??(()=>Promise.resolve(r8)),useFipsEndpoint:(t==null?void 0:t.useFipsEndpoint)??(()=>Promise.resolve(n8))}},R5=t=>({setRegion(e){t.region=e},region(){return t.region}}),O5=t=>({region:t.region()}),$5=t=>{const e=t.httpAuthSchemes;let r=t.httpAuthSchemeProvider,n=t.credentials,s=t.token;return{setHttpAuthScheme(i){const a=e.findIndex(o=>o.schemeId===i.schemeId);a===-1?e.push(i):e.splice(a,1,i)},httpAuthSchemes(){return e},setHttpAuthSchemeProvider(i){r=i},httpAuthSchemeProvider(){return r},setCredentials(i){n=i},credentials(){return n},setToken(i){s=i},token(){return s}}},N5=t=>({httpAuthSchemes:t.httpAuthSchemes(),httpAuthSchemeProvider:t.httpAuthSchemeProvider(),credentials:t.credentials(),token:t.token()}),P5=(t,e)=>{const r=Object.assign(R5(t),Q3(t),Lj(t),$5(t));return e.forEach(n=>n.configure(r)),Object.assign(t,O5(r),e6(r),Mj(r),N5(r))};class L5 extends V3{constructor(...[r]){const n=I5(r||{});super(n);p(this,"config");this.initConfig=n;const s=r5(n),i=PF(s),a=z8(i),o=a8(a),c=o,l=E8(c),u=o8(l),d=t5(u),h=Pj(d),f=V6(h),m=P5(f,(r==null?void 0:r.extensions)||[]);this.config=m,this.middlewareStack.use(p6(this.config)),this.middlewareStack.use(Z8(this.config)),this.middlewareStack.use(u8(this.config)),this.middlewareStack.use(jj(this.config)),this.middlewareStack.use(Vj(this.config)),this.middlewareStack.use(Gj(this.config)),this.middlewareStack.use(Xj(this.config,{httpAuthSchemeParametersProvider:X8,identityProviderConfigProvider:async g=>new kF({"aws.auth#sigv4":g.credentials,"smithy.api#httpBearerAuth":g.token})})),this.middlewareStack.use(iF(this.config))}destroy(){super.destroy()}}class _r extends ha{constructor(e){super(e),Object.setPrototypeOf(this,_r.prototype)}}class dy extends _r{constructor(r){super({name:"AccessDeniedException",$fault:"client",...r});p(this,"name","AccessDeniedException");p(this,"$fault","client");Object.setPrototypeOf(this,dy.prototype)}}var $0;(function(t){t.visit=(e,r)=>e.s3OutputDataConfig!==void 0?r.s3OutputDataConfig(e.s3OutputDataConfig):r._(e.$unknown[0],e.$unknown[1])})($0||($0={}));class hy extends _r{constructor(r){super({name:"InternalServerException",$fault:"server",...r});p(this,"name","InternalServerException");p(this,"$fault","server");Object.setPrototypeOf(this,hy.prototype)}}class fy extends _r{constructor(r){super({name:"ThrottlingException",$fault:"client",...r});p(this,"name","ThrottlingException");p(this,"$fault","client");Object.setPrototypeOf(this,fy.prototype)}}class py extends _r{constructor(r){super({name:"ValidationException",$fault:"client",...r});p(this,"name","ValidationException");p(this,"$fault","client");Object.setPrototypeOf(this,py.prototype)}}class my extends _r{constructor(r){super({name:"ConflictException",$fault:"client",...r});p(this,"name","ConflictException");p(this,"$fault","client");Object.setPrototypeOf(this,my.prototype)}}class gy extends _r{constructor(r){super({name:"ResourceNotFoundException",$fault:"client",...r});p(this,"name","ResourceNotFoundException");p(this,"$fault","client");Object.setPrototypeOf(this,gy.prototype)}}class yy extends _r{constructor(r){super({name:"ServiceQuotaExceededException",$fault:"client",...r});p(this,"name","ServiceQuotaExceededException");p(this,"$fault","client");Object.setPrototypeOf(this,yy.prototype)}}class _y extends _r{constructor(r){super({name:"ServiceUnavailableException",$fault:"server",...r});p(this,"name","ServiceUnavailableException");p(this,"$fault","server");Object.setPrototypeOf(this,_y.prototype)}}var N0;(function(t){t.visit=(e,r)=>e.bytes!==void 0?r.bytes(e.bytes):r._(e.$unknown[0],e.$unknown[1])})(N0||(N0={}));var P0;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.image!==void 0?r.image(e.image):r._(e.$unknown[0],e.$unknown[1])})(P0||(P0={}));var L0;(function(t){t.visit=(e,r)=>e.valid!==void 0?r.valid(e.valid):e.invalid!==void 0?r.invalid(e.invalid):e.satisfiable!==void 0?r.satisfiable(e.satisfiable):e.impossible!==void 0?r.impossible(e.impossible):e.translationAmbiguous!==void 0?r.translationAmbiguous(e.translationAmbiguous):e.tooComplex!==void 0?r.tooComplex(e.tooComplex):e.noTranslations!==void 0?r.noTranslations(e.noTranslations):r._(e.$unknown[0],e.$unknown[1])})(L0||(L0={}));var M0;(function(t){t.visit=(e,r)=>e.documentChar!==void 0?r.documentChar(e.documentChar):e.documentPage!==void 0?r.documentPage(e.documentPage):e.documentChunk!==void 0?r.documentChunk(e.documentChunk):r._(e.$unknown[0],e.$unknown[1])})(M0||(M0={}));var D0;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):r._(e.$unknown[0],e.$unknown[1])})(D0||(D0={}));var U0;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):r._(e.$unknown[0],e.$unknown[1])})(U0||(U0={}));var B0;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):r._(e.$unknown[0],e.$unknown[1])})(B0||(B0={}));var dm;(function(t){t.visit=(e,r)=>e.bytes!==void 0?r.bytes(e.bytes):e.s3Location!==void 0?r.s3Location(e.s3Location):e.text!==void 0?r.text(e.text):e.content!==void 0?r.content(e.content):r._(e.$unknown[0],e.$unknown[1])})(dm||(dm={}));var hm;(function(t){t.visit=(e,r)=>e.bytes!==void 0?r.bytes(e.bytes):r._(e.$unknown[0],e.$unknown[1])})(hm||(hm={}));var fm;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.image!==void 0?r.image(e.image):r._(e.$unknown[0],e.$unknown[1])})(fm||(fm={}));var pm;(function(t){t.visit=(e,r)=>e.bytes!==void 0?r.bytes(e.bytes):e.s3Location!==void 0?r.s3Location(e.s3Location):r._(e.$unknown[0],e.$unknown[1])})(pm||(pm={}));var mm;(function(t){t.visit=(e,r)=>e.reasoningText!==void 0?r.reasoningText(e.reasoningText):e.redactedContent!==void 0?r.redactedContent(e.redactedContent):r._(e.$unknown[0],e.$unknown[1])})(mm||(mm={}));var gm;(function(t){t.visit=(e,r)=>e.bytes!==void 0?r.bytes(e.bytes):e.s3Location!==void 0?r.s3Location(e.s3Location):r._(e.$unknown[0],e.$unknown[1])})(gm||(gm={}));var ym;(function(t){t.visit=(e,r)=>e.json!==void 0?r.json(e.json):e.text!==void 0?r.text(e.text):e.image!==void 0?r.image(e.image):e.document!==void 0?r.document(e.document):e.video!==void 0?r.video(e.video):r._(e.$unknown[0],e.$unknown[1])})(ym||(ym={}));var _m;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.image!==void 0?r.image(e.image):e.document!==void 0?r.document(e.document):e.video!==void 0?r.video(e.video):e.toolUse!==void 0?r.toolUse(e.toolUse):e.toolResult!==void 0?r.toolResult(e.toolResult):e.guardContent!==void 0?r.guardContent(e.guardContent):e.cachePoint!==void 0?r.cachePoint(e.cachePoint):e.reasoningContent!==void 0?r.reasoningContent(e.reasoningContent):e.citationsContent!==void 0?r.citationsContent(e.citationsContent):r._(e.$unknown[0],e.$unknown[1])})(_m||(_m={}));var j0;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):r._(e.$unknown[0],e.$unknown[1])})(j0||(j0={}));var wm;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.guardContent!==void 0?r.guardContent(e.guardContent):e.cachePoint!==void 0?r.cachePoint(e.cachePoint):r._(e.$unknown[0],e.$unknown[1])})(wm||(wm={}));var F0;(function(t){t.visit=(e,r)=>e.auto!==void 0?r.auto(e.auto):e.any!==void 0?r.any(e.any):e.tool!==void 0?r.tool(e.tool):r._(e.$unknown[0],e.$unknown[1])})(F0||(F0={}));var bm;(function(t){t.visit=(e,r)=>e.json!==void 0?r.json(e.json):r._(e.$unknown[0],e.$unknown[1])})(bm||(bm={}));var vm;(function(t){t.visit=(e,r)=>e.toolSpec!==void 0?r.toolSpec(e.toolSpec):e.cachePoint!==void 0?r.cachePoint(e.cachePoint):r._(e.$unknown[0],e.$unknown[1])})(vm||(vm={}));var z0;(function(t){t.visit=(e,r)=>e.message!==void 0?r.message(e.message):r._(e.$unknown[0],e.$unknown[1])})(z0||(z0={}));class wy extends _r{constructor(r){super({name:"ModelErrorException",$fault:"client",...r});p(this,"name","ModelErrorException");p(this,"$fault","client");p(this,"originalStatusCode");p(this,"resourceName");Object.setPrototypeOf(this,wy.prototype),this.originalStatusCode=r.originalStatusCode,this.resourceName=r.resourceName}}class by extends _r{constructor(r){super({name:"ModelNotReadyException",$fault:"client",...r});p(this,"name","ModelNotReadyException");p(this,"$fault","client");p(this,"$retryable",{});Object.setPrototypeOf(this,by.prototype)}}class vy extends _r{constructor(r){super({name:"ModelTimeoutException",$fault:"client",...r});p(this,"name","ModelTimeoutException");p(this,"$fault","client");Object.setPrototypeOf(this,vy.prototype)}}var V0;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.redactedContent!==void 0?r.redactedContent(e.redactedContent):e.signature!==void 0?r.signature(e.signature):r._(e.$unknown[0],e.$unknown[1])})(V0||(V0={}));var q0;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.toolUse!==void 0?r.toolUse(e.toolUse):e.reasoningContent!==void 0?r.reasoningContent(e.reasoningContent):e.citation!==void 0?r.citation(e.citation):r._(e.$unknown[0],e.$unknown[1])})(q0||(q0={}));var H0;(function(t){t.visit=(e,r)=>e.toolUse!==void 0?r.toolUse(e.toolUse):r._(e.$unknown[0],e.$unknown[1])})(H0||(H0={}));class Ey extends _r{constructor(r){super({name:"ModelStreamErrorException",$fault:"client",...r});p(this,"name","ModelStreamErrorException");p(this,"$fault","client");p(this,"originalStatusCode");p(this,"originalMessage");Object.setPrototypeOf(this,Ey.prototype),this.originalStatusCode=r.originalStatusCode,this.originalMessage=r.originalMessage}}var G0;(function(t){t.visit=(e,r)=>e.messageStart!==void 0?r.messageStart(e.messageStart):e.contentBlockStart!==void 0?r.contentBlockStart(e.contentBlockStart):e.contentBlockDelta!==void 0?r.contentBlockDelta(e.contentBlockDelta):e.contentBlockStop!==void 0?r.contentBlockStop(e.contentBlockStop):e.messageStop!==void 0?r.messageStop(e.messageStop):e.metadata!==void 0?r.metadata(e.metadata):e.internalServerException!==void 0?r.internalServerException(e.internalServerException):e.modelStreamErrorException!==void 0?r.modelStreamErrorException(e.modelStreamErrorException):e.validationException!==void 0?r.validationException(e.validationException):e.throttlingException!==void 0?r.throttlingException(e.throttlingException):e.serviceUnavailableException!==void 0?r.serviceUnavailableException(e.serviceUnavailableException):r._(e.$unknown[0],e.$unknown[1])})(G0||(G0={}));var W0;(function(t){t.visit=(e,r)=>e.chunk!==void 0?r.chunk(e.chunk):r._(e.$unknown[0],e.$unknown[1])})(W0||(W0={}));var J0;(function(t){t.visit=(e,r)=>e.chunk!==void 0?r.chunk(e.chunk):e.internalServerException!==void 0?r.internalServerException(e.internalServerException):e.modelStreamErrorException!==void 0?r.modelStreamErrorException(e.modelStreamErrorException):e.validationException!==void 0?r.validationException(e.validationException):e.throttlingException!==void 0?r.throttlingException(e.throttlingException):e.modelTimeoutException!==void 0?r.modelTimeoutException(e.modelTimeoutException):e.serviceUnavailableException!==void 0?r.serviceUnavailableException(e.serviceUnavailableException):r._(e.$unknown[0],e.$unknown[1])})(J0||(J0={}));var Z0;(function(t){t.visit=(e,r)=>e.chunk!==void 0?r.chunk(e.chunk):e.internalServerException!==void 0?r.internalServerException(e.internalServerException):e.modelStreamErrorException!==void 0?r.modelStreamErrorException(e.modelStreamErrorException):e.validationException!==void 0?r.validationException(e.validationException):e.throttlingException!==void 0?r.throttlingException(e.throttlingException):e.modelTimeoutException!==void 0?r.modelTimeoutException(e.modelTimeoutException):e.serviceUnavailableException!==void 0?r.serviceUnavailableException(e.serviceUnavailableException):r._(e.$unknown[0],e.$unknown[1])})(Z0||(Z0={}));var K0;(function(t){t.visit=(e,r)=>e.invokeModel!==void 0?r.invokeModel(e.invokeModel):e.converse!==void 0?r.converse(e.converse):r._(e.$unknown[0],e.$unknown[1])})(K0||(K0={}));const ic=t=>({...t,...t.logic&&{logic:ws},...t.naturalLanguage&&{naturalLanguage:ws}}),xd=t=>({...t,...t.premises&&{premises:t.premises.map(e=>ic(e))},...t.claims&&{claims:t.claims.map(e=>ic(e))}}),X0=t=>({...t,...t.text&&{text:ws}}),Td=t=>({...t,...t.premises&&{premises:t.premises.map(e=>ic(e))},...t.claims&&{claims:t.claims.map(e=>ic(e))},...t.untranslatedPremises&&{untranslatedPremises:t.untranslatedPremises.map(e=>X0(e))},...t.untranslatedClaims&&{untranslatedClaims:t.untranslatedClaims.map(e=>X0(e))}}),M5=t=>({...t,...t.translation&&{translation:Td(t.translation)},...t.logicWarning&&{logicWarning:xd(t.logicWarning)}}),D5=t=>({...t,...t.translation&&{translation:Td(t.translation)},...t.logicWarning&&{logicWarning:xd(t.logicWarning)}}),Em=t=>({...t,...t.statements&&{statements:t.statements.map(e=>ic(e))}}),U5=t=>({...t,...t.translation&&{translation:Td(t.translation)},...t.claimsTrueScenario&&{claimsTrueScenario:Em(t.claimsTrueScenario)},...t.claimsFalseScenario&&{claimsFalseScenario:Em(t.claimsFalseScenario)},...t.logicWarning&&{logicWarning:xd(t.logicWarning)}}),B5=t=>({...t}),j5=t=>({...t,...t.translation&&{translation:Td(t.translation)},...t.claimsTrueScenario&&{claimsTrueScenario:Em(t.claimsTrueScenario)},...t.logicWarning&&{logicWarning:xd(t.logicWarning)}}),F5=t=>{if(t.valid!==void 0)return{valid:j5(t.valid)};if(t.invalid!==void 0)return{invalid:D5(t.invalid)};if(t.satisfiable!==void 0)return{satisfiable:U5(t.satisfiable)};if(t.impossible!==void 0)return{impossible:M5(t.impossible)};if(t.translationAmbiguous!==void 0)return{translationAmbiguous:B5(t.translationAmbiguous)};if(t.tooComplex!==void 0)return{tooComplex:t.tooComplex};if(t.noTranslations!==void 0)return{noTranslations:t.noTranslations};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},z5=t=>({...t,...t.findings&&{findings:t.findings.map(e=>F5(e))}}),Y0=t=>({...t,...t.automatedReasoningPolicy&&{automatedReasoningPolicy:z5(t.automatedReasoningPolicy)}}),SC=t=>{if(t.text!==void 0)return{text:t.text};if(t.image!==void 0)return{image:ws};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},V5=t=>{if(t.text!==void 0)return{text:t.text};if(t.image!==void 0)return{image:t.image};if(t.document!==void 0)return{document:t.document};if(t.video!==void 0)return{video:t.video};if(t.toolUse!==void 0)return{toolUse:t.toolUse};if(t.toolResult!==void 0)return{toolResult:t.toolResult};if(t.guardContent!==void 0)return{guardContent:SC(t.guardContent)};if(t.cachePoint!==void 0)return{cachePoint:t.cachePoint};if(t.reasoningContent!==void 0)return{reasoningContent:ws};if(t.citationsContent!==void 0)return{citationsContent:t.citationsContent};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},Sy=t=>({...t,...t.content&&{content:t.content.map(e=>V5(e))}}),xC=t=>{if(t.text!==void 0)return{text:t.text};if(t.guardContent!==void 0)return{guardContent:SC(t.guardContent)};if(t.cachePoint!==void 0)return{cachePoint:t.cachePoint};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},q5=t=>({...t,...t.messages&&{messages:t.messages.map(e=>Sy(e))},...t.system&&{system:t.system.map(e=>xC(e))},...t.toolConfig&&{toolConfig:t.toolConfig},...t.promptVariables&&{promptVariables:ws},...t.requestMetadata&&{requestMetadata:ws}}),H5=t=>{if(t.message!==void 0)return{message:Sy(t.message)};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},G5=t=>({...t,...t.inputAssessment&&{inputAssessment:Object.entries(t.inputAssessment).reduce((e,[r,n])=>(e[r]=Y0(n),e),{})},...t.outputAssessments&&{outputAssessments:Object.entries(t.outputAssessments).reduce((e,[r,n])=>(e[r]=n.map(s=>Y0(s)),e),{})}}),W5=t=>({...t,...t.guardrail&&{guardrail:G5(t.guardrail)}}),J5=t=>({...t,...t.output&&{output:H5(t.output)},...t.trace&&{trace:W5(t.trace)}}),Z5=t=>({...t,...t.messages&&{messages:t.messages.map(e=>Sy(e))},...t.system&&{system:t.system.map(e=>xC(e))},...t.toolConfig&&{toolConfig:t.toolConfig},...t.promptVariables&&{promptVariables:ws},...t.requestMetadata&&{requestMetadata:ws}}),K5=t=>({...t,...t.stream&&{stream:"STREAMING_CONTENT"}}),X5=async(t,e)=>{const r=PA(t,e),n={"content-type":"application/json"};r.bp("/model/{modelId}/converse"),r.p("modelId",()=>t.modelId,"{modelId}",!1);let s;return s=JSON.stringify(Te(t,{additionalModelRequestFields:i=>Tc(i),additionalModelResponseFieldPaths:i=>ne(i),guardrailConfig:i=>ne(i),inferenceConfig:i=>PC(i),messages:i=>LC(i,e),performanceConfig:i=>ne(i),promptVariables:i=>ne(i),requestMetadata:i=>ne(i),system:i=>MC(i,e),toolConfig:i=>DC(i)})),r.m("POST").h(n).b(s),r.build()},Y5=async(t,e)=>{const r=PA(t,e),n={"content-type":"application/json"};r.bp("/model/{modelId}/converse-stream"),r.p("modelId",()=>t.modelId,"{modelId}",!1);let s;return s=JSON.stringify(Te(t,{additionalModelRequestFields:i=>Tc(i),additionalModelResponseFieldPaths:i=>ne(i),guardrailConfig:i=>ne(i),inferenceConfig:i=>PC(i),messages:i=>LC(i,e),performanceConfig:i=>ne(i),promptVariables:i=>ne(i),requestMetadata:i=>ne(i),system:i=>MC(i,e),toolConfig:i=>DC(i)})),r.m("POST").h(n).b(s),r.build()},Q5=async(t,e)=>{if(t.statusCode!==200&&t.statusCode>=300)return TC(t,e);const r=Nr({$metadata:Pr(t)}),n=vF(NA(await Wr(t.body,e)),"body"),s=Te(n,{additionalModelResponseFields:i=>Ad(i),metrics:ne,output:i=>V9(on(i),e),performanceConfig:ne,stopReason:Ne,trace:i=>G9(i),usage:ne});return Object.assign(r,s),r},e9=async(t,e)=>{if(t.statusCode!==200&&t.statusCode>=300)return TC(t,e);const r=Nr({$metadata:Pr(t)}),n=t.body;return r.stream=l9(n,e),r},TC=async(t,e)=>{const r={...t,body:await s6(t.body,e)},n=i6(t,r.body);switch(n){case"AccessDeniedException":case"com.amazonaws.bedrockruntime#AccessDeniedException":throw await r9(r);case"InternalServerException":case"com.amazonaws.bedrockruntime#InternalServerException":throw await AC(r);case"ResourceNotFoundException":case"com.amazonaws.bedrockruntime#ResourceNotFoundException":throw await o9(r);case"ServiceQuotaExceededException":case"com.amazonaws.bedrockruntime#ServiceQuotaExceededException":throw await c9(r);case"ServiceUnavailableException":case"com.amazonaws.bedrockruntime#ServiceUnavailableException":throw await kC(r);case"ThrottlingException":case"com.amazonaws.bedrockruntime#ThrottlingException":throw await IC(r);case"ValidationException":case"com.amazonaws.bedrockruntime#ValidationException":throw await RC(r);case"ModelErrorException":case"com.amazonaws.bedrockruntime#ModelErrorException":throw await s9(r);case"ModelNotReadyException":case"com.amazonaws.bedrockruntime#ModelNotReadyException":throw await i9(r);case"ModelTimeoutException":case"com.amazonaws.bedrockruntime#ModelTimeoutException":throw await a9(r);case"ModelStreamErrorException":case"com.amazonaws.bedrockruntime#ModelStreamErrorException":throw await CC(r);case"ConflictException":case"com.amazonaws.bedrockruntime#ConflictException":throw await n9(r);default:const s=r.body;return t9({output:t,parsedBody:s,errorCode:n})}},t9=G3(_r),r9=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne});Object.assign(r,s);const i=new dy({$metadata:Pr(t),...r});return Gr(i,t.body)},n9=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne});Object.assign(r,s);const i=new my({$metadata:Pr(t),...r});return Gr(i,t.body)},AC=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne});Object.assign(r,s);const i=new hy({$metadata:Pr(t),...r});return Gr(i,t.body)},s9=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne,originalStatusCode:sy,resourceName:Ne});Object.assign(r,s);const i=new wy({$metadata:Pr(t),...r});return Gr(i,t.body)},i9=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne});Object.assign(r,s);const i=new by({$metadata:Pr(t),...r});return Gr(i,t.body)},CC=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne,originalMessage:Ne,originalStatusCode:sy});Object.assign(r,s);const i=new Ey({$metadata:Pr(t),...r});return Gr(i,t.body)},a9=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne});Object.assign(r,s);const i=new vy({$metadata:Pr(t),...r});return Gr(i,t.body)},o9=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne});Object.assign(r,s);const i=new gy({$metadata:Pr(t),...r});return Gr(i,t.body)},c9=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne});Object.assign(r,s);const i=new yy({$metadata:Pr(t),...r});return Gr(i,t.body)},kC=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne});Object.assign(r,s);const i=new _y({$metadata:Pr(t),...r});return Gr(i,t.body)},IC=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne});Object.assign(r,s);const i=new fy({$metadata:Pr(t),...r});return Gr(i,t.body)},RC=async(t,e)=>{const r=Nr({}),n=t.body,s=Te(n,{message:Ne});Object.assign(r,s);const i=new py({$metadata:Pr(t),...r});return Gr(i,t.body)},l9=(t,e)=>e.eventStreamMarshaller.deserialize(t,async r=>r.messageStart!=null?{messageStart:await m9(r.messageStart,e)}:r.contentBlockStart!=null?{contentBlockStart:await d9(r.contentBlockStart,e)}:r.contentBlockDelta!=null?{contentBlockDelta:await u9(r.contentBlockDelta,e)}:r.contentBlockStop!=null?{contentBlockStop:await h9(r.contentBlockStop,e)}:r.messageStop!=null?{messageStop:await g9(r.messageStop,e)}:r.metadata!=null?{metadata:await f9(r.metadata,e)}:r.internalServerException!=null?{internalServerException:await p9(r.internalServerException,e)}:r.modelStreamErrorException!=null?{modelStreamErrorException:await y9(r.modelStreamErrorException,e)}:r.validationException!=null?{validationException:await b9(r.validationException,e)}:r.throttlingException!=null?{throttlingException:await w9(r.throttlingException,e)}:r.serviceUnavailableException!=null?{serviceUnavailableException:await _9(r.serviceUnavailableException,e)}:{$unknown:r}),u9=async(t,e)=>{const r={},n=await Wr(t.body,e);return Object.assign(r,F9(n,e)),r},d9=async(t,e)=>{const r={},n=await Wr(t.body,e);return Object.assign(r,ne(n)),r},h9=async(t,e)=>{const r={},n=await Wr(t.body,e);return Object.assign(r,ne(n)),r},f9=async(t,e)=>{const r={},n=await Wr(t.body,e);return Object.assign(r,q9(n)),r},p9=async(t,e)=>{const r={...t,body:await Wr(t.body,e)};return AC(r)},m9=async(t,e)=>{const r={},n=await Wr(t.body,e);return Object.assign(r,ne(n)),r},g9=async(t,e)=>{const r={},n=await Wr(t.body,e);return Object.assign(r,gz(n)),r},y9=async(t,e)=>{const r={...t,body:await Wr(t.body,e)};return CC(r)},_9=async(t,e)=>{const r={...t,body:await Wr(t.body,e)};return kC(r)},w9=async(t,e)=>{const r={...t,body:await Wr(t.body,e)};return IC(r)},b9=async(t,e)=>{const r={...t,body:await Wr(t.body,e)};return RC(r)},v9=(t,e)=>_m.visit(t,{cachePoint:r=>({cachePoint:ne(r)}),citationsContent:r=>({citationsContent:ne(r)}),document:r=>({document:OC(r,e)}),guardContent:r=>({guardContent:$C(r,e)}),image:r=>({image:NC(r,e)}),reasoningContent:r=>({reasoningContent:k9(r,e)}),text:r=>({text:r}),toolResult:r=>({toolResult:$9(r,e)}),toolUse:r=>({toolUse:D9(r)}),video:r=>({video:UC(r,e)}),_:(r,n)=>({[r]:n})}),E9=(t,e)=>t.filter(r=>r!=null).map(r=>v9(r,e)),OC=(t,e)=>Te(t,{citations:ne,context:[],format:[],name:[],source:r=>S9(r,e)}),S9=(t,e)=>dm.visit(t,{bytes:r=>({bytes:e.base64Encoder(r)}),content:r=>({content:ne(r)}),s3Location:r=>({s3Location:ne(r)}),text:r=>({text:r}),_:(r,n)=>({[r]:n})}),$C=(t,e)=>fm.visit(t,{image:r=>({image:x9(r,e)}),text:r=>({text:ne(r)}),_:(r,n)=>({[r]:n})}),x9=(t,e)=>Te(t,{format:[],source:r=>T9(r,e)}),T9=(t,e)=>hm.visit(t,{bytes:r=>({bytes:e.base64Encoder(r)}),_:(r,n)=>({[r]:n})}),NC=(t,e)=>Te(t,{format:[],source:r=>A9(r,e)}),A9=(t,e)=>pm.visit(t,{bytes:r=>({bytes:e.base64Encoder(r)}),s3Location:r=>({s3Location:ne(r)}),_:(r,n)=>({[r]:n})}),PC=(t,e)=>Te(t,{maxTokens:[],stopSequences:ne,temperature:l0,topP:l0}),C9=(t,e)=>Te(t,{content:r=>E9(r,e),role:[]}),LC=(t,e)=>t.filter(r=>r!=null).map(r=>C9(r,e)),k9=(t,e)=>mm.visit(t,{reasoningText:r=>({reasoningText:ne(r)}),redactedContent:r=>({redactedContent:e.base64Encoder(r)}),_:(r,n)=>({[r]:n})}),I9=(t,e)=>wm.visit(t,{cachePoint:r=>({cachePoint:ne(r)}),guardContent:r=>({guardContent:$C(r,e)}),text:r=>({text:r}),_:(r,n)=>({[r]:n})}),MC=(t,e)=>t.filter(r=>r!=null).map(r=>I9(r,e)),R9=(t,e)=>vm.visit(t,{cachePoint:r=>({cachePoint:ne(r)}),toolSpec:r=>({toolSpec:M9(r)}),_:(r,n)=>({[r]:n})}),DC=(t,e)=>Te(t,{toolChoice:ne,tools:r=>L9(r)}),O9=(t,e)=>bm.visit(t,{json:r=>({json:Tc(r)}),_:(r,n)=>({[r]:n})}),$9=(t,e)=>Te(t,{content:r=>P9(r,e),status:[],toolUseId:[]}),N9=(t,e)=>ym.visit(t,{document:r=>({document:OC(r,e)}),image:r=>({image:NC(r,e)}),json:r=>({json:Tc(r)}),text:r=>({text:r}),video:r=>({video:UC(r,e)}),_:(r,n)=>({[r]:n})}),P9=(t,e)=>t.filter(r=>r!=null).map(r=>N9(r,e)),L9=(t,e)=>t.filter(r=>r!=null).map(r=>R9(r)),M9=(t,e)=>Te(t,{description:[],inputSchema:r=>O9(r),name:[]}),D9=(t,e)=>Te(t,{input:r=>Tc(r),name:[],toolUseId:[]}),UC=(t,e)=>Te(t,{format:[],source:r=>U9(r,e)}),U9=(t,e)=>gm.visit(t,{bytes:r=>({bytes:e.base64Encoder(r)}),s3Location:r=>({s3Location:ne(r)}),_:(r,n)=>({[r]:n})}),Tc=(t,e)=>t,B9=(t,e)=>t.cachePoint!=null?{cachePoint:ne(t.cachePoint)}:t.citationsContent!=null?{citationsContent:ne(t.citationsContent)}:t.document!=null?{document:BC(t.document,e)}:t.guardContent!=null?{guardContent:dz(on(t.guardContent),e)}:t.image!=null?{image:zC(t.image,e)}:t.reasoningContent!=null?{reasoningContent:yz(on(t.reasoningContent),e)}:Ne(t.text)!==void 0?{text:Ne(t.text)}:t.toolResult!=null?{toolResult:wz(t.toolResult,e)}:t.toolUse!=null?{toolUse:Ez(t.toolUse)}:t.video!=null?{video:VC(t.video,e)}:{$unknown:Object.entries(t)[0]},j9=(t,e)=>t.citation!=null?{citation:ne(t.citation)}:t.reasoningContent!=null?{reasoningContent:_z(on(t.reasoningContent),e)}:Ne(t.text)!==void 0?{text:Ne(t.text)}:t.toolUse!=null?{toolUse:ne(t.toolUse)}:{$unknown:Object.entries(t)[0]},F9=(t,e)=>Te(t,{contentBlockIndex:sy,delta:r=>j9(on(r),e)}),z9=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>B9(on(n),e)),V9=(t,e)=>t.message!=null?{message:mz(t.message,e)}:{$unknown:Object.entries(t)[0]},q9=(t,e)=>Te(t,{metrics:ne,performanceConfig:ne,trace:r=>H9(r),usage:ne}),H9=(t,e)=>Te(t,{guardrail:r=>FC(r),promptRouter:ne}),G9=(t,e)=>Te(t,{guardrail:r=>FC(r),promptRouter:ne}),BC=(t,e)=>Te(t,{citations:ne,context:Ne,format:Ne,name:Ne,source:r=>W9(on(r),e)}),W9=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:t.content!=null?{content:ne(t.content)}:t.s3Location!=null?{s3Location:ne(t.s3Location)}:Ne(t.text)!==void 0?{text:Ne(t.text)}:{$unknown:Object.entries(t)[0]},jC=(t,e)=>Te(t,{automatedReasoningPolicy:r=>tz(r),contentPolicy:ne,contextualGroundingPolicy:r=>uz(r),invocationMetrics:ne,sensitiveInformationPolicy:ne,topicPolicy:ne,wordPolicy:ne}),J9=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>jC(n)),Z9=(t,e)=>Object.entries(t).reduce((r,[n,s])=>(s===null||(r[n]=J9(s)),r),{}),K9=(t,e)=>Object.entries(t).reduce((r,[n,s])=>(s===null||(r[n]=jC(s)),r),{}),X9=(t,e)=>t.impossible!=null?{impossible:Q9(t.impossible)}:t.invalid!=null?{invalid:ez(t.invalid)}:t.noTranslations!=null?{noTranslations:ne(t.noTranslations)}:t.satisfiable!=null?{satisfiable:rz(t.satisfiable)}:t.tooComplex!=null?{tooComplex:ne(t.tooComplex)}:t.translationAmbiguous!=null?{translationAmbiguous:nz(t.translationAmbiguous)}:t.valid!=null?{valid:oz(t.valid)}:{$unknown:Object.entries(t)[0]},Y9=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>X9(on(n))),Q9=(t,e)=>Te(t,{contradictingRules:ne,logicWarning:ne,translation:r=>Ac(r)}),ez=(t,e)=>Te(t,{contradictingRules:ne,logicWarning:ne,translation:r=>Ac(r)}),tz=(t,e)=>Te(t,{findings:r=>Y9(r)}),rz=(t,e)=>Te(t,{claimsFalseScenario:ne,claimsTrueScenario:ne,logicWarning:ne,translation:r=>Ac(r)}),Ac=(t,e)=>Te(t,{claims:ne,confidence:im,premises:ne,untranslatedClaims:ne,untranslatedPremises:ne}),nz=(t,e)=>Te(t,{differenceScenarios:ne,options:r=>az(r)}),sz=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>Ac(n)),iz=(t,e)=>Te(t,{translations:r=>sz(r)}),az=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>iz(n)),oz=(t,e)=>Te(t,{claimsTrueScenario:ne,logicWarning:ne,supportingRules:ne,translation:r=>Ac(r)}),cz=(t,e)=>Te(t,{action:Ne,detected:gF,score:im,threshold:im,type:Ne}),lz=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>cz(n)),uz=(t,e)=>Te(t,{filters:r=>lz(r)}),dz=(t,e)=>t.image!=null?{image:hz(t.image,e)}:t.text!=null?{text:ne(t.text)}:{$unknown:Object.entries(t)[0]},hz=(t,e)=>Te(t,{format:Ne,source:r=>fz(on(r),e)}),fz=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:{$unknown:Object.entries(t)[0]},FC=(t,e)=>Te(t,{actionReason:Ne,inputAssessment:r=>K9(r),modelOutput:ne,outputAssessments:r=>Z9(r)}),zC=(t,e)=>Te(t,{format:Ne,source:r=>pz(on(r),e)}),pz=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:t.s3Location!=null?{s3Location:ne(t.s3Location)}:{$unknown:Object.entries(t)[0]},mz=(t,e)=>Te(t,{content:r=>z9(r,e),role:Ne}),gz=(t,e)=>Te(t,{additionalModelResponseFields:r=>Ad(r),stopReason:Ne}),yz=(t,e)=>t.reasoningText!=null?{reasoningText:ne(t.reasoningText)}:t.redactedContent!=null?{redactedContent:e.base64Decoder(t.redactedContent)}:{$unknown:Object.entries(t)[0]},_z=(t,e)=>t.redactedContent!=null?{redactedContent:e.base64Decoder(t.redactedContent)}:Ne(t.signature)!==void 0?{signature:Ne(t.signature)}:Ne(t.text)!==void 0?{text:Ne(t.text)}:{$unknown:Object.entries(t)[0]},wz=(t,e)=>Te(t,{content:r=>vz(r,e),status:Ne,toolUseId:Ne}),bz=(t,e)=>t.document!=null?{document:BC(t.document,e)}:t.image!=null?{image:zC(t.image,e)}:t.json!=null?{json:Ad(t.json)}:Ne(t.text)!==void 0?{text:Ne(t.text)}:t.video!=null?{video:VC(t.video,e)}:{$unknown:Object.entries(t)[0]},vz=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>bz(on(n),e)),Ez=(t,e)=>Te(t,{input:r=>Ad(r),name:Ne,toolUseId:Ne}),VC=(t,e)=>Te(t,{format:Ne,source:r=>Sz(on(r),e)}),Sz=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:t.s3Location!=null?{s3Location:ne(t.s3Location)}:{$unknown:Object.entries(t)[0]},Ad=(t,e)=>t,Pr=t=>({httpStatusCode:t.statusCode,requestId:t.headers["x-amzn-requestid"]??t.headers["x-amzn-request-id"]??t.headers["x-amz-request-id"],extendedRequestId:t.headers["x-amz-id-2"],cfId:t.headers["x-amz-cf-id"]});class xz extends oy.classBuilder().ep(_C).m(function(e,r,n,s){return[kA(n,this.serialize,this.deserialize),pC(n,e.getEndpointParameterInstructions())]}).s("AmazonBedrockFrontendService","Converse",{}).n("BedrockRuntimeClient","ConverseCommand").f(q5,J5).ser(X5).de(Q5).build(){}class Tz extends oy.classBuilder().ep(_C).m(function(e,r,n,s){return[kA(n,this.serialize,this.deserialize),pC(n,e.getEndpointParameterInstructions())]}).s("AmazonBedrockFrontendService","ConverseStream",{eventStream:{output:!0}}).n("BedrockRuntimeClient","ConverseStreamCommand").f(Z5,K5).ser(Y5).de(e9).build(){}const Az=()=>async()=>{throw new Error("Credential provider not available in browser. Please pass credentials directly.")},Cz=Az;var qC=class extends Bi{constructor(e){super(e??{});p(this,"model","anthropic.claude-3-haiku-20240307-v1:0");p(this,"streaming",!1);p(this,"region");p(this,"temperature");p(this,"maxTokens");p(this,"endpointHost");p(this,"topP");p(this,"additionalModelRequestFields");p(this,"streamUsage",!0);p(this,"guardrailConfig");p(this,"performanceConfig");p(this,"client");p(this,"clientOptions");p(this,"supportsToolChoiceValues");const{profile:r,filepath:n,configFilepath:s,ignoreCache:i,mfaCodeProvider:a,roleAssumer:o,roleArn:c,webIdentityTokenFile:l,roleAssumerWithWebIdentity:u,...d}=e??{},h=(d==null?void 0:d.credentials)??Cz(),f=(d==null?void 0:d.region)??rn("AWS_DEFAULT_REGION");if(!f)throw new Error("Please set the AWS_DEFAULT_REGION environment variable or pass it to the constructor as the region field.");this.client=(e==null?void 0:e.client)??new L5({...e==null?void 0:e.clientOptions,region:f,credentials:h,endpoint:d.endpointHost?`https://${d.endpointHost}`:void 0}),this.region=f,this.model=(d==null?void 0:d.model)??this.model,this.streaming=(d==null?void 0:d.streaming)??this.streaming,this.temperature=d==null?void 0:d.temperature,this.maxTokens=d==null?void 0:d.maxTokens,this.endpointHost=d==null?void 0:d.endpointHost,this.topP=d==null?void 0:d.topP,this.additionalModelRequestFields=d==null?void 0:d.additionalModelRequestFields,this.streamUsage=(d==null?void 0:d.streamUsage)??this.streamUsage,this.guardrailConfig=d==null?void 0:d.guardrailConfig,this.performanceConfig=d==null?void 0:d.performanceConfig,this.clientOptions=d==null?void 0:d.clientOptions,(d==null?void 0:d.supportsToolChoiceValues)===void 0?this.supportsToolChoiceValues=yj(this.model):this.supportsToolChoiceValues=d.supportsToolChoiceValues}static lc_name(){return"ChatBedrockConverse"}get lc_secrets(){return{apiKey:"API_KEY_NAME"}}get lc_aliases(){return{apiKey:"API_KEY_NAME"}}getLsParams(e){var n,s;const r=this.invocationParams(e);return{ls_provider:"amazon_bedrock",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:((n=r.inferenceConfig)==null?void 0:n.temperature)??this.temperature,ls_max_tokens:((s=r.inferenceConfig)==null?void 0:s.maxTokens)??void 0,ls_stop:e.stop}}bindTools(e,r){return this.withConfig({tools:Hb(e),...r})}_llmType(){return"chat_bedrock_converse"}invocationParams(e){let r;if(e!=null&&e.tools&&e.tools.length){const n=Hb(e.tools);r={tools:n,toolChoice:e.tool_choice?gj(e.tool_choice,n,{model:this.model,supportsToolChoiceValues:this.supportsToolChoiceValues}):void 0}}return{inferenceConfig:{maxTokens:this.maxTokens,temperature:this.temperature,topP:this.topP,stopSequences:e==null?void 0:e.stop},toolConfig:r,additionalModelRequestFields:this.additionalModelRequestFields??(e==null?void 0:e.additionalModelRequestFields),guardrailConfig:this.guardrailConfig??(e==null?void 0:e.guardrailConfig),performanceConfig:e==null?void 0:e.performanceConfig}}async _generate(e,r,n){if(this.streaming){const s=this._streamResponseChunks(e,r,n);let i;for await(const a of s)i===void 0?i=a:i=i.concat(a);if(i===void 0)throw new Error("Could not parse final output from Bedrock streaming call.");return{generations:[i],llmOutput:i.generationInfo}}return this._generateNonStreaming(e,r,n)}async _generateNonStreaming(e,r,n){const{converseMessages:s,converseSystem:i}=Gb(e),a=this.invocationParams(r),o=new xz({modelId:this.model,messages:s,system:i,requestMetadata:r.requestMetadata,...a}),c=await this.client.send(o,{abortSignal:r.signal}),{output:l,...u}=c;if(!(l!=null&&l.message))throw new Error("No message found in Bedrock response.");const d=kj(l.message,u);return{generations:[{text:typeof d.content=="string"?d.content:"",message:d}]}}async*_streamResponseChunks(e,r,n){const{converseMessages:s,converseSystem:i}=Gb(e),a=this.invocationParams(r);let{streamUsage:o}=this;r.streamUsage!==void 0&&(o=r.streamUsage);const c=new Tz({modelId:this.model,messages:s,system:i,requestMetadata:r.requestMetadata,...a}),l=await this.client.send(c,{abortSignal:r.signal});if(l.stream)for await(const u of l.stream)if(u.contentBlockStart)yield Rj(u.contentBlockStart);else if(u.contentBlockDelta){const d=Ij(u.contentBlockDelta);yield d,await(n==null?void 0:n.handleLLMNewToken(d.text,void 0,void 0,void 0,void 0,{chunk:d}))}else u.metadata?yield Oj(u.metadata,{streamUsage:o}):yield new mr({text:"",message:new At({content:"",response_metadata:{...u}})})}withStructuredOutput(e,r){const n=e,s=r==null?void 0:r.name,i=Ri(n)??"A function available to call.",a=r==null?void 0:r.method,o=r==null?void 0:r.includeRaw;if(a==="jsonMode")throw new Error("ChatBedrockConverse does not support 'jsonMode'.");let c=s??"extract",l;tn(n)?l=[{type:"function",function:{name:c,description:i,parameters:ar(n)}}]:("name"in n&&(c=n.name),l=[{type:"function",function:{name:c,description:i,parameters:n}}]);const u=this.supportsToolChoiceValues??[];let d;u.includes("tool")?d={tool_choice:l[0].function.name}:u.includes("any")&&(d={tool_choice:"any"});const h=this.bindTools(l,d),f=Cn.from(b=>{if(!b.tool_calls||b.tool_calls.length===0)throw new Error("No tool calls found in the response.");const _=b.tool_calls.find(E=>E.name===c);if(!_)throw new Error(`No tool call found with name ${c}.`);return _.args});if(!o)return h.pipe(f).withConfig({runName:"StructuredOutput"});const m=_s.assign({parsed:(b,_)=>f.invoke(b.raw,_)}),g=_s.assign({parsed:()=>null}),y=m.withFallbacks({fallbacks:[g]});return Zn.from([{raw:h},y]).withConfig({runName:"StructuredOutputRunnable"})}};const Ai=t=>t();function Cc(t){return t?!!(/^o\d/.test(t??"")||t.startsWith("gpt-5")&&!t.startsWith("gpt-5-chat")):!1}function kz(t){return t.role!=="system"&&t.role!=="developer"&&t.role!=="assistant"&&t.role!=="user"&&t.role!=="function"&&t.role!=="tool"&&console.warn(`Unknown message role: ${t.role}`),t.role}function kc(t){const e=t._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!Kn.isInstance(t))throw new Error("Invalid generic chat message");return kz(t);default:throw new Error(`Unknown message type: ${e}`)}}function Iz(t){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:r,azureOpenAIApiKey:n,azureOpenAIBasePath:s,baseURL:i,azureADTokenProvider:a,azureOpenAIEndpoint:o}=t;if((n||a)&&s&&e)return`${s}/${e}`;if((n||a)&&o&&e)return`${o}/openai/deployments/${e}`;if(n||a){if(!r)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${r}.openai.azure.com/openai/deployments/${e}`}return i}function Rz(t,e){let r;return xc(t)?r=OT(t):r=t,(e==null?void 0:e.strict)!==void 0&&(r.function.strict=e.strict),r}function Oz(t){return t.anyOf!==void 0&&Array.isArray(t.anyOf)}function $z(t){const e=["namespace functions {",""];for(const r of t)r.description&&e.push(`// ${r.description}`),Object.keys(r.parameters.properties??{}).length>0?(e.push(`type ${r.name} = (_: {`),e.push(HC(r.parameters,0)),e.push("}) => any;")):e.push(`type ${r.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function HC(t,e){var n;const r=[];for(const[s,i]of Object.entries(t.properties??{}))i.description&&e<2&&r.push(`// ${i.description}`),(n=t.required)!=null&&n.includes(s)?r.push(`${s}: ${Pu(i,e)},`):r.push(`${s}?: ${Pu(i,e)},`);return r.map(s=>" ".repeat(e)+s).join(`
`)}function Pu(t,e){if(Oz(t))return t.anyOf.map(r=>Pu(r,e)).join(" | ");switch(t.type){case"string":return t.enum?t.enum.map(r=>`"${r}"`).join(" | "):"string";case"number":return t.enum?t.enum.map(r=>`${r}`).join(" | "):"number";case"integer":return t.enum?t.enum.map(r=>`${r}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",HC(t,e+2),"}"].join(`
`);case"array":return t.items?`${Pu(t.items,e)}[]`:"any[]";default:return""}}function GC(t){if(t)return t==="any"||t==="required"?"required":t==="auto"?"auto":t==="none"?"none":typeof t=="string"?{type:"function",function:{name:t}}:t}function xy(t){return"type"in t&&t.type!=="function"}function Nz(t){return t!=null&&typeof t=="object"&&"type"in t&&t.type!=="function"}function Lu(t){return typeof t=="object"&&t!==null&&"metadata"in t&&typeof t.metadata=="object"&&t.metadata!==null&&"customTool"in t.metadata&&typeof t.metadata.customTool=="object"&&t.metadata.customTool!==null}function WC(t){return"type"in t&&t.type==="custom"&&"custom"in t&&typeof t.custom=="object"&&t.custom!==null}function Pz(t){if(t.type==="custom_tool_call")return{...t,type:"tool_call",call_id:t.id,id:t.call_id,name:t.name,isCustomTool:!0,args:{input:t.input}}}function Lz(t){return t.type==="tool_call"&&"isCustomTool"in t&&t.isCustomTool===!0}function Mz(t){const e=()=>{if(t.custom.format){if(t.custom.format.type==="grammar")return{type:"grammar",definition:t.custom.format.grammar.definition,syntax:t.custom.format.grammar.syntax};if(t.custom.format.type==="text")return{type:"text"}}};return{type:"custom",name:t.custom.name,description:t.custom.description,format:e()}}function Dz(t){const e=()=>{if(t.format){if(t.format.type==="grammar")return{type:"grammar",grammar:{definition:t.format.definition,syntax:t.format.syntax}};if(t.format.type==="text")return{type:"text"}}};return{type:"custom",custom:{name:t.name,description:t.description,format:e()}}}function Sm(t){return typeof t=="object"&&t!==null&&("name"in t&&t.name==="AbortError"||"message"in t&&String(t.message).includes("FetchRequestCanceledException"))}const xm=t=>{if(t instanceof Error)return t;if(typeof t=="object"&&t!==null){try{if(Object.prototype.toString.call(t)==="[object Error]"){const e=new Error(t.message,t.cause?{cause:t.cause}:{});return t.stack&&(e.stack=t.stack),t.cause&&!e.cause&&(e.cause=t.cause),t.name&&(e.name=t.name),e}}catch{}try{return new Error(JSON.stringify(t))}catch{}}return new Error(t)};class we extends Error{}class tr extends we{constructor(e,r,n,s){super(`${tr.makeMessage(e,r,n)}`),this.status=e,this.headers=s,this.requestID=s==null?void 0:s.get("x-request-id"),this.error=r;const i=r;this.code=i==null?void 0:i.code,this.param=i==null?void 0:i.param,this.type=i==null?void 0:i.type}static makeMessage(e,r,n){const s=r!=null&&r.message?typeof r.message=="string"?r.message:JSON.stringify(r.message):r?JSON.stringify(r):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,r,n,s){if(!e||!s)return new Cd({message:n,cause:xm(r)});const i=r==null?void 0:r.error;return e===400?new JC(e,i,n,s):e===401?new ZC(e,i,n,s):e===403?new KC(e,i,n,s):e===404?new XC(e,i,n,s):e===409?new YC(e,i,n,s):e===422?new QC(e,i,n,s):e===429?new ek(e,i,n,s):e>=500?new tk(e,i,n,s):new tr(e,i,n,s)}}class zr extends tr{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Cd extends tr{constructor({message:e,cause:r}){super(void 0,void 0,e||"Connection error.",void 0),r&&(this.cause=r)}}class kd extends Cd{constructor({message:e}={}){super({message:e??"Request timed out."})}}class JC extends tr{}class ZC extends tr{}class KC extends tr{}class XC extends tr{}class YC extends tr{}class QC extends tr{}class ek extends tr{}class tk extends tr{}class rk extends we{constructor(){super("Could not parse response content as the length limit was reached")}}class nk extends we{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class ao extends Error{constructor(e){super(e)}}function Mu(t){return t!==void 0&&"function"in t&&t.function!==void 0}function Uz(t,e){const r={...t};return Object.defineProperties(r,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),r}function Ty(t){return(t==null?void 0:t.$brand)==="auto-parseable-response-format"}function Ic(t){return(t==null?void 0:t.$brand)==="auto-parseable-tool"}function Bz(t,e){return!e||!sk(e)?{...t,choices:t.choices.map(r=>(ik(r.message.tool_calls),{...r,message:{...r.message,parsed:null,...r.message.tool_calls?{tool_calls:r.message.tool_calls}:void 0}}))}:Ay(t,e)}function Ay(t,e){const r=t.choices.map(n=>{var s;if(n.finish_reason==="length")throw new rk;if(n.finish_reason==="content_filter")throw new nk;return ik(n.message.tool_calls),{...n,message:{...n.message,...n.message.tool_calls?{tool_calls:((s=n.message.tool_calls)==null?void 0:s.map(i=>Fz(e,i)))??void 0}:void 0,parsed:n.message.content&&!n.message.refusal?jz(e,n.message.content):null}}});return{...t,choices:r}}function jz(t,e){var r,n;return((r=t.response_format)==null?void 0:r.type)!=="json_schema"?null:((n=t.response_format)==null?void 0:n.type)==="json_schema"?"$parseRaw"in t.response_format?t.response_format.$parseRaw(e):JSON.parse(e):null}function Fz(t,e){var n;const r=(n=t.tools)==null?void 0:n.find(s=>{var i;return Mu(s)&&((i=s.function)==null?void 0:i.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:Ic(r)?r.$parseRaw(e.function.arguments):r!=null&&r.function.strict?JSON.parse(e.function.arguments):null}}}function zz(t,e){var n;if(!t||!("tools"in t)||!t.tools)return!1;const r=(n=t.tools)==null?void 0:n.find(s=>{var i;return Mu(s)&&((i=s.function)==null?void 0:i.name)===e.function.name});return Mu(r)&&(Ic(r)||(r==null?void 0:r.function.strict)||!1)}function sk(t){var e;return Ty(t.response_format)?!0:((e=t.tools)==null?void 0:e.some(r=>Ic(r)||r.type==="function"&&r.function.strict===!0))??!1}function ik(t){for(const e of t||[])if(e.type!=="function")throw new we(`Currently only \`function\` tool calls are supported; Received \`${e.type}\``)}function Vz(t){for(const e of t??[]){if(e.type!=="function")throw new we(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new we(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}const qz=Symbol("Let zodToJsonSchema decide on which parser to use"),Q0={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Hz=t=>typeof t=="string"?{...Q0,basePath:["#"],definitions:{},name:t}:{...Q0,basePath:["#"],definitions:{},...t},Tm=t=>"_def"in t?t._def:t;function Gz(t){if(!t)return!0;for(const e in t)return!1;return!0}const Wz=t=>{const e=Hz(t),r=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:r,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([n,s])=>[Tm(s),{def:Tm(s),path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}};function ak(t,e,r,n){n!=null&&n.errorMessages&&r&&(t.errorMessage={...t.errorMessage,[e]:r})}function Qe(t,e,r,n,s){t[e]=r,ak(t,e,n,s)}function Jz(){return{}}function Zz(t,e){var n,s;const r={type:"array"};return((s=(n=t.type)==null?void 0:n._def)==null?void 0:s.typeName)!==U.ZodAny&&(r.items=We(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&Qe(r,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&Qe(r,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(Qe(r,"minItems",t.exactLength.value,t.exactLength.message,e),Qe(r,"maxItems",t.exactLength.value,t.exactLength.message,e)),r}function Kz(t,e){const r={type:"integer",format:"int64"};if(!t.checks)return r;for(const n of t.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?Qe(r,"minimum",n.value,n.message,e):Qe(r,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(r.exclusiveMinimum=!0),Qe(r,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?Qe(r,"maximum",n.value,n.message,e):Qe(r,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(r.exclusiveMaximum=!0),Qe(r,"maximum",n.value,n.message,e));break;case"multipleOf":Qe(r,"multipleOf",n.value,n.message,e);break}return r}function Xz(){return{type:"boolean"}}function Yz(t,e){return We(t.type._def,e)}const Qz=(t,e)=>We(t.innerType._def,e);function ok(t,e,r){const n=r??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((s,i)=>ok(t,e,s))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return eV(t,e)}}const eV=(t,e)=>{const r={type:"integer",format:"unix-time"};if(e.target==="openApi3")return r;for(const n of t.checks)switch(n.kind){case"min":Qe(r,"minimum",n.value,n.message,e);break;case"max":Qe(r,"maximum",n.value,n.message,e);break}return r};function tV(t,e){return{...We(t.innerType._def,e),default:t.defaultValue()}}function rV(t,e,r){return e.effectStrategy==="input"?We(t.schema._def,e,r):{}}function nV(t){return{type:"string",enum:[...t.values]}}const sV=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function iV(t,e){const r=[We(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),We(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return r.forEach(i=>{if(sV(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(n=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;a=c}else n=void 0;s.push(a)}}),s.length?{allOf:s,...n}:void 0}function aV(t,e){const r=typeof t.value;return r!=="bigint"&&r!=="number"&&r!=="boolean"&&r!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:r==="bigint"?"integer":r,enum:[t.value]}:{type:r==="bigint"?"integer":r,const:t.value}}let Hf;const si={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Hf===void 0&&(Hf=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Hf),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function ck(t,e){const r={type:"string"};function n(s){return e.patternStrategy==="escape"?oV(s):s}if(t.checks)for(const s of t.checks)switch(s.kind){case"min":Qe(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,s.value):s.value,s.message,e);break;case"max":Qe(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":hn(r,"email",s.message,e);break;case"format:idn-email":hn(r,"idn-email",s.message,e);break;case"pattern:zod":fn(r,si.email,s.message,e);break}break;case"url":hn(r,"uri",s.message,e);break;case"uuid":hn(r,"uuid",s.message,e);break;case"regex":fn(r,s.regex,s.message,e);break;case"cuid":fn(r,si.cuid,s.message,e);break;case"cuid2":fn(r,si.cuid2,s.message,e);break;case"startsWith":fn(r,RegExp(`^${n(s.value)}`),s.message,e);break;case"endsWith":fn(r,RegExp(`${n(s.value)}$`),s.message,e);break;case"datetime":hn(r,"date-time",s.message,e);break;case"date":hn(r,"date",s.message,e);break;case"time":hn(r,"time",s.message,e);break;case"duration":hn(r,"duration",s.message,e);break;case"length":Qe(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,s.value):s.value,s.message,e),Qe(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,s.value):s.value,s.message,e);break;case"includes":{fn(r,RegExp(n(s.value)),s.message,e);break}case"ip":{s.version!=="v6"&&hn(r,"ipv4",s.message,e),s.version!=="v4"&&hn(r,"ipv6",s.message,e);break}case"emoji":fn(r,si.emoji,s.message,e);break;case"ulid":{fn(r,si.ulid,s.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{hn(r,"binary",s.message,e);break}case"contentEncoding:base64":{Qe(r,"contentEncoding","base64",s.message,e);break}case"pattern:zod":{fn(r,si.base64,s.message,e);break}}break}case"nanoid":fn(r,si.nanoid,s.message,e)}return r}const oV=t=>Array.from(t).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),hn=(t,e,r,n)=>{var s;t.format||(s=t.anyOf)!=null&&s.some(i=>i.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&n.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...r&&n.errorMessages&&{errorMessage:{format:r}}})):Qe(t,"format",e,r,n)},fn=(t,e,r,n)=>{var s;t.pattern||(s=t.allOf)!=null&&s.some(i=>i.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&n.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:ev(e,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):Qe(t,"pattern",ev(e,n),r,n)},ev=(t,e)=>{var l;const r=typeof t=="function"?t():t;if(!e.applyRegexFlags||!r.flags)return r.source;const n={i:r.flags.includes("i"),m:r.flags.includes("m"),s:r.flags.includes("s")},s=n.i?r.source.toLowerCase():r.source;let i="",a=!1,o=!1,c=!1;for(let u=0;u<s.length;u++){if(a){i+=s[u],a=!1;continue}if(n.i){if(o){if(s[u].match(/[a-z]/)){c?(i+=s[u],i+=`${s[u-2]}-${s[u]}`.toUpperCase(),c=!1):s[u+1]==="-"&&((l=s[u+2])!=null&&l.match(/[a-z]/))?(i+=s[u],c=!0):i+=`${s[u]}${s[u].toUpperCase()}`;continue}}else if(s[u].match(/[a-z]/)){i+=`[${s[u]}${s[u].toUpperCase()}]`;continue}}if(n.m){if(s[u]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(s[u]==="$"){i+=`($|(?=[\r
]))`;continue}}if(n.s&&s[u]==="."){i+=o?`${s[u]}\r
`:`[${s[u]}\r
]`;continue}i+=s[u],s[u]==="\\"?a=!0:o&&s[u]==="]"?o=!1:!o&&s[u]==="["&&(o=!0)}try{const u=new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return i};function lk(t,e){var n,s,i,a;if(e.target==="openApi3"&&((n=t.keyType)==null?void 0:n._def.typeName)===U.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((o,c)=>({...o,[c]:We(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]})??{}}),{}),additionalProperties:!1};const r={type:"object",additionalProperties:We(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return r;if(((s=t.keyType)==null?void 0:s._def.typeName)===U.ZodString&&((i=t.keyType._def.checks)!=null&&i.length)){const o=Object.entries(ck(t.keyType._def,e)).reduce((c,[l,u])=>l==="type"?c:{...c,[l]:u},{});return{...r,propertyNames:o}}else if(((a=t.keyType)==null?void 0:a._def.typeName)===U.ZodEnum)return{...r,propertyNames:{enum:t.keyType._def.values}};return r}function cV(t,e){if(e.mapStrategy==="record")return lk(t,e);const r=We(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},n=We(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[r,n],minItems:2,maxItems:2}}}function lV(t){const e=t.values,n=Object.keys(t.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(n.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:n}}function uV(){return{not:{}}}function dV(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Du={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function hV(t,e){if(e.target==="openApi3")return tv(t,e);const r=t.options instanceof Map?Array.from(t.options.values()):t.options;if(r.every(n=>n._def.typeName in Du&&(!n._def.checks||!n._def.checks.length))){const n=r.reduce((s,i)=>{const a=Du[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:n.length>1?n:n[0]}}else if(r.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=r.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":if(i._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(n.length===r.length){const s=n.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:r.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(r.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:r.reduce((n,s)=>[...n,...s._def.values.filter(i=>!n.includes(i))],[])};return tv(t,e)}const tv=(t,e)=>{const r=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((n,s)=>We(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return r.length?{anyOf:r}:void 0};function fV(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:Du[t.innerType._def.typeName],nullable:!0}:{type:[Du[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=We(t.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const r=We(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}function pV(t,e){const r={type:"number"};if(!t.checks)return r;for(const n of t.checks)switch(n.kind){case"int":r.type="integer",ak(r,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?Qe(r,"minimum",n.value,n.message,e):Qe(r,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(r.exclusiveMinimum=!0),Qe(r,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?Qe(r,"maximum",n.value,n.message,e):Qe(r,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(r.exclusiveMaximum=!0),Qe(r,"maximum",n.value,n.message,e));break;case"multipleOf":Qe(r,"multipleOf",n.value,n.message,e);break}return r}function mV(t,e){return e.removeAdditionalStrategy==="strict"?t.catchall._def.typeName==="ZodNever"?t.unknownKeys!=="strict":We(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":We(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function gV(t,e){const r={type:"object",...Object.entries(t.shape()).reduce((n,[s,i])=>{var c;if(i===void 0||i._def===void 0)return n;const a=[...e.currentPath,"properties",s],o=We(i._def,{...e,currentPath:a,propertyPath:a});if(o===void 0)return n;if(e.openaiStrictMode&&i.isOptional()&&!i.isNullable()&&typeof((c=i._def)==null?void 0:c.defaultValue)>"u")throw new Error(`Zod field at \`${a.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...n.properties,[s]:o},required:i.isOptional()&&!e.openaiStrictMode?n.required:[...n.required,s]}},{properties:{},required:[]}),additionalProperties:mV(t,e)};return r.required.length||delete r.required,r}const yV=(t,e)=>{if(e.propertyPath&&e.currentPath.slice(0,e.propertyPath.length).toString()===e.propertyPath.toString())return We(t.innerType._def,{...e,currentPath:e.currentPath});const r=We(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return r?{anyOf:[{not:{}},r]}:{}},_V=(t,e)=>{if(e.pipeStrategy==="input")return We(t.in._def,e);if(e.pipeStrategy==="output")return We(t.out._def,e);const r=We(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=We(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",r?"1":"0"]});return{allOf:[r,n].filter(s=>s!==void 0)}};function wV(t,e){return We(t.type._def,e)}function bV(t,e){const n={type:"array",uniqueItems:!0,items:We(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&Qe(n,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&Qe(n,"maxItems",t.maxSize.value,t.maxSize.message,e),n}function vV(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((r,n)=>We(r._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[]),additionalItems:We(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((r,n)=>We(r._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[])}}function EV(){return{not:{}}}function SV(){return{}}const xV=(t,e)=>We(t.innerType._def,e);function We(t,e,r=!1){var a;const n=e.seen.get(t);if(e.override){const o=(a=e.override)==null?void 0:a.call(e,t,e,n,r);if(o!==qz)return o}if(n&&!r){const o=TV(n,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const i=CV(t,t.typeName,e,r);return i&&kV(t,e,i),s.jsonSchema=i,i}const TV=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"extract-to-root":const r=t.path.slice(e.basePath.length+1).join("_");return r!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[r]=t.def),{$ref:[...e.basePath,e.definitionPath,r].join("/")};case"relative":return{$ref:AV(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((n,s)=>e.currentPath[s]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},AV=(t,e)=>{let r=0;for(;r<t.length&&r<e.length&&t[r]===e[r];r++);return[(t.length-r).toString(),...e.slice(r)].join("/")},CV=(t,e,r,n)=>{switch(e){case U.ZodString:return ck(t,r);case U.ZodNumber:return pV(t,r);case U.ZodObject:return gV(t,r);case U.ZodBigInt:return Kz(t,r);case U.ZodBoolean:return Xz();case U.ZodDate:return ok(t,r);case U.ZodUndefined:return EV();case U.ZodNull:return dV(r);case U.ZodArray:return Zz(t,r);case U.ZodUnion:case U.ZodDiscriminatedUnion:return hV(t,r);case U.ZodIntersection:return iV(t,r);case U.ZodTuple:return vV(t,r);case U.ZodRecord:return lk(t,r);case U.ZodLiteral:return aV(t,r);case U.ZodEnum:return nV(t);case U.ZodNativeEnum:return lV(t);case U.ZodNullable:return fV(t,r);case U.ZodOptional:return yV(t,r);case U.ZodMap:return cV(t,r);case U.ZodSet:return bV(t,r);case U.ZodLazy:return We(t.getter()._def,r);case U.ZodPromise:return wV(t,r);case U.ZodNaN:case U.ZodNever:return uV();case U.ZodEffects:return rV(t,r,n);case U.ZodAny:return Jz();case U.ZodUnknown:return SV();case U.ZodDefault:return tV(t,r);case U.ZodBranded:return Yz(t,r);case U.ZodReadonly:return xV(t,r);case U.ZodCatch:return Qz(t,r);case U.ZodPipeline:return _V(t,r);case U.ZodFunction:case U.ZodVoid:case U.ZodSymbol:return;default:return(s=>{})()}},kV=(t,e,r)=>(t.description&&(r.description=t.description,e.markdownDescription&&(r.markdownDescription=t.description)),r),IV=(t,e)=>{const r=Wz(e),n=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,s=We(t._def,n===void 0?r:{...r,currentPath:[...r.basePath,r.definitionPath,n]},!1)??{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(s.title=i);const a=(()=>{if(Gz(r.definitions))return;const c={},l=new Set;for(let u=0;u<500;u++){const d=Object.entries(r.definitions).filter(([h])=>!l.has(h));if(d.length===0)break;for(const[h,f]of d)c[h]=We(Tm(f),{...r,currentPath:[...r.basePath,r.definitionPath,h]},!0)??{},l.add(h)}return c})(),o=n===void 0?a?{...s,[r.definitionPath]:a}:s:r.nameStrategy==="duplicate-ref"?{...s,...a||r.seenRefs.size?{[r.definitionPath]:{...a,...r.seenRefs.size?{[n]:s}:void 0}}:void 0}:{$ref:[...r.$refStrategy==="relative"?[]:r.basePath,r.definitionPath,n].join("/"),[r.definitionPath]:{...a,[n]:s}};return r.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":r.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function RV(t,e){return!e||!$V(e)?{...t,output_parsed:null,output:t.output.map(r=>r.type==="function_call"?{...r,parsed_arguments:null}:r.type==="message"?{...r,content:r.content.map(n=>({...n,parsed:null}))}:r)}:uk(t,e)}function uk(t,e){const r=t.output.map(s=>{if(s.type==="function_call")return{...s,parsed_arguments:LV(e,s)};if(s.type==="message"){const i=s.content.map(a=>a.type==="output_text"?{...a,parsed:OV(e,a.text)}:a);return{...s,content:i}}return s}),n=Object.assign({},t,{output:r});return Object.getOwnPropertyDescriptor(t,"output_text")||Am(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const s of n.output)if(s.type==="message"){for(const i of s.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),n}function OV(t,e){var r,n,s,i;return((n=(r=t.text)==null?void 0:r.format)==null?void 0:n.type)!=="json_schema"?null:"$parseRaw"in((s=t.text)==null?void 0:s.format)?((i=t.text)==null?void 0:i.format).$parseRaw(e):JSON.parse(e)}function $V(t){var e;return!!Ty((e=t.text)==null?void 0:e.format)}function NV(t){return(t==null?void 0:t.$brand)==="auto-parseable-tool"}function PV(t,e){return t.find(r=>r.type==="function"&&r.name===e)}function LV(t,e){const r=PV(t.tools??[],e.name);return{...e,...e,parsed_arguments:NV(r)?r.$parseRaw(e.arguments):r!=null&&r.strict?JSON.parse(e.arguments):null}}function Am(t){const e=[];for(const r of t.output)if(r.type==="message")for(const n of r.content)n.type==="output_text"&&e.push(n.text);t.output_text=e.join("")}function MV(t){if(t.type!=="object")throw new Error(`Root schema must have type: 'object' but got type: ${t.type?`'${t.type}'`:"undefined"}`);const e=structuredClone(t);return rs(e,[],e)}function Cm(t){if(typeof t=="boolean")return!1;if(t.type==="null")return!0;for(const e of t.oneOf??[])if(Cm(e))return!0;for(const e of t.anyOf??[])if(Cm(e))return!0;return!1}function rs(t,e,r){if(typeof t=="boolean")throw new TypeError(`Expected object schema but got boolean; path=${e.join("/")}`);if(!li(t))throw new TypeError(`Expected ${JSON.stringify(t)} to be an object; path=${e.join("/")}`);const n=t.$defs;if(li(n))for(const[h,f]of Object.entries(n))rs(f,[...e,"$defs",h],r);const s=t.definitions;if(li(s))for(const[h,f]of Object.entries(s))rs(f,[...e,"definitions",h],r);t.type==="object"&&!("additionalProperties"in t)&&(t.additionalProperties=!1);const a=t.required??[],o=t.properties;if(li(o)){for(const[h,f]of Object.entries(o))if(!Cm(f)&&!a.includes(h))throw new Error(`Zod field at \`${[...e,"properties",h].join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);t.required=Object.keys(o),t.properties=Object.fromEntries(Object.entries(o).map(([h,f])=>[h,rs(f,[...e,"properties",h],r)]))}const c=t.items;li(c)&&(t.items=rs(c,[...e,"items"],r));const l=t.anyOf;Array.isArray(l)&&(t.anyOf=l.map((h,f)=>rs(h,[...e,"anyOf",String(f)],r)));const u=t.allOf;if(Array.isArray(u))if(u.length===1){const h=rs(u[0],[...e,"allOf","0"],r);Object.assign(t,h),delete t.allOf}else t.allOf=u.map((h,f)=>rs(h,[...e,"allOf",String(f)],r));t.default===null&&delete t.default;const d=t.$ref;if(d&&UV(t,1)){if(typeof d!="string")throw new TypeError(`Received non-string $ref - ${d}; path=${e.join("/")}`);const h=DV(r,d);if(typeof h=="boolean")throw new Error(`Expected \`$ref: ${d}\` to resolve to an object schema but got boolean`);if(!li(h))throw new Error(`Expected \`$ref: ${d}\` to resolve to an object but got ${JSON.stringify(h)}`);return Object.assign(t,{...h,...t}),delete t.$ref,rs(t,e,r)}return t}function DV(t,e){if(!e.startsWith("#/"))throw new Error(`Unexpected $ref format ${JSON.stringify(e)}; Does not start with #/`);const r=e.slice(2).split("/");let n=t;for(const s of r){if(!li(n))throw new Error(`encountered non-object entry while resolving ${e} - ${JSON.stringify(n)}`);const i=n[s];if(i===void 0)throw new Error(`Key ${s} not found while resolving ${e}`);n=i}return n}function li(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function UV(t,e){let r=0;for(const n in t)if(r++,r>e)return!0;return!1}function BV(t,e){return IV(t,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function jV(t){return MV(ru(t,{target:"draft-7"}))}function FV(t){return"_zod"in t}function zV(t,e,r){return Uz({type:"json_schema",json_schema:{...r,name:e,strict:!0,schema:FV(t)?jV(t):BV(t,{name:e})}},n=>t.parse(JSON.parse(n)))}const rv=["jsonSchema","functionCalling","jsonMode"];function VV(t,e){if(typeof e<"u"&&!rv.includes(e))throw new Error(`Invalid method: ${e}. Supported methods are: ${rv.join(", ")}`);const r=!t.startsWith("gpt-3")&&!t.startsWith("gpt-4-")&&t!=="gpt-4";if(r&&!e)return"jsonSchema";if(!r&&e==="jsonSchema")throw new Error(`JSON Schema is not supported for model "${t}". Please use a different method, e.g. "functionCalling" or "jsonMode".`);return e??"functionCalling"}function qV(t,e){const r={...t};return Object.defineProperties(r,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),r}function HV(t,e,r){if(bt(t))return zV(t,e,r);if(_t(t))return qV({type:"json_schema",json_schema:{...r,name:e,strict:!0,schema:ru(t,{cycles:"ref",reused:"ref",override(n){n.jsonSchema.title=e}})}},n=>cd(t,JSON.parse(n)));throw new Error("Unsupported schema response format")}function GV(t,e){if(e&&typeof e=="object"&&"images"in e&&Array.isArray(e.images)){const r=e.images.filter(n=>{var s;return typeof((s=n==null?void 0:n.image_url)==null?void 0:s.url)=="string"}).map(n=>({type:"image",url:n.image_url.url}));return[{type:"text",text:t},...r]}return t}function nv(t){var n,s,i,a;const e={...((n=t==null?void 0:t.input_tokens_details)==null?void 0:n.cached_tokens)!=null&&{cache_read:(s=t==null?void 0:t.input_tokens_details)==null?void 0:s.cached_tokens}},r={...((i=t==null?void 0:t.output_tokens_details)==null?void 0:i.reasoning_tokens)!=null&&{reasoning:(a=t==null?void 0:t.output_tokens_details)==null?void 0:a.reasoning_tokens}};return{input_tokens:(t==null?void 0:t.input_tokens)??0,output_tokens:(t==null?void 0:t.output_tokens)??0,total_tokens:(t==null?void 0:t.total_tokens)??0,input_token_details:e,output_token_details:r}}function Ce(t,e,r,n,s){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,r),r}function P(t,e,r,n){if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?n:r==="a"?n.call(t):n?n.value:e.get(t)}let dk=function(){const{crypto:t}=globalThis;if(t!=null&&t.randomUUID)return dk=t.randomUUID.bind(t),t.randomUUID();const e=new Uint8Array(1),r=t?()=>t.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,n=>(+n^r()&15>>+n/4).toString(16))};const WV=/^[a-z][a-z0-9+.-]*:/i,JV=t=>WV.test(t);let vr=t=>(vr=Array.isArray,vr(t)),sv=vr;function hk(t){return typeof t!="object"?{}:t??{}}function ZV(t){if(!t)return!0;for(const e in t)return!1;return!0}function KV(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Gf(t){return t!=null&&typeof t=="object"&&!Array.isArray(t)}const XV=(t,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new we(`${t} must be an integer`);if(e<0)throw new we(`${t} must be a positive integer`);return e},YV=t=>{try{return JSON.parse(t)}catch{return}},Rc=t=>new Promise(e=>setTimeout(e,t)),ra="6.7.0",QV=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function eq(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const tq=()=>{var r;const t=eq();if(t==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ra,"X-Stainless-OS":av(Deno.build.os),"X-Stainless-Arch":iv(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((r=Deno.version)==null?void 0:r.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ra,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(t==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ra,"X-Stainless-OS":av(globalThis.process.platform??"unknown"),"X-Stainless-Arch":iv(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const e=rq();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ra,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ra,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function rq(){if(typeof navigator>"u"||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:r}of t){const n=r.exec(navigator.userAgent);if(n){const s=n[1]||0,i=n[2]||0,a=n[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}const iv=t=>t==="x32"?"x32":t==="x86_64"||t==="x64"?"x64":t==="arm"?"arm":t==="aarch64"||t==="arm64"?"arm64":t?`other:${t}`:"unknown",av=t=>(t=t.toLowerCase(),t.includes("ios")?"iOS":t==="android"?"Android":t==="darwin"?"MacOS":t==="win32"?"Windows":t==="freebsd"?"FreeBSD":t==="openbsd"?"OpenBSD":t==="linux"?"Linux":t?`Other:${t}`:"Unknown");let ov;const nq=()=>ov??(ov=tq());function sq(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function fk(...t){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...t)}function pk(t){let e=Symbol.asyncIterator in t?t[Symbol.asyncIterator]():t[Symbol.iterator]();return fk({start(){},async pull(r){const{done:n,value:s}=await e.next();n?r.close():r.enqueue(s)},async cancel(){var r;await((r=e.return)==null?void 0:r.call(e))}})}function mk(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const r=await e.read();return r!=null&&r.done&&e.releaseLock(),r}catch(r){throw e.releaseLock(),r}},async return(){const r=e.cancel();return e.releaseLock(),await r,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function iq(t){var n,s;if(t===null||typeof t!="object")return;if(t[Symbol.asyncIterator]){await((s=(n=t[Symbol.asyncIterator]()).return)==null?void 0:s.call(n));return}const e=t.getReader(),r=e.cancel();e.releaseLock(),await r}const aq=({headers:t,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)}),gk="RFC3986",yk=t=>String(t),cv={RFC1738:t=>String(t).replace(/%20/g,"+"),RFC3986:yk},oq="RFC1738";let km=(t,e)=>(km=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),km(t,e));const $n=(()=>{const t=[];for(let e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t})(),Wf=1024,cq=(t,e,r,n,s)=>{if(t.length===0)return t;let i=t;if(typeof t=="symbol"?i=Symbol.prototype.toString.call(t):typeof t!="string"&&(i=String(t)),r==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let a="";for(let o=0;o<i.length;o+=Wf){const c=i.length>=Wf?i.slice(o,o+Wf):i,l=[];for(let u=0;u<c.length;++u){let d=c.charCodeAt(u);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||s===oq&&(d===40||d===41)){l[l.length]=c.charAt(u);continue}if(d<128){l[l.length]=$n[d];continue}if(d<2048){l[l.length]=$n[192|d>>6]+$n[128|d&63];continue}if(d<55296||d>=57344){l[l.length]=$n[224|d>>12]+$n[128|d>>6&63]+$n[128|d&63];continue}u+=1,d=65536+((d&1023)<<10|c.charCodeAt(u)&1023),l[l.length]=$n[240|d>>18]+$n[128|d>>12&63]+$n[128|d>>6&63]+$n[128|d&63]}a+=l.join("")}return a};function lq(t){return!t||typeof t!="object"?!1:!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))}function lv(t,e){if(vr(t)){const r=[];for(let n=0;n<t.length;n+=1)r.push(e(t[n]));return r}return e(t)}const _k={brackets(t){return String(t)+"[]"},comma:"comma",indices(t,e){return String(t)+"["+e+"]"},repeat(t){return String(t)}},wk=function(t,e){Array.prototype.push.apply(t,vr(e)?e:[e])};let uv;const $t={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:cq,encodeValuesOnly:!1,format:gk,formatter:yk,indices:!1,serializeDate(t){return(uv??(uv=Function.prototype.call.bind(Date.prototype.toISOString)))(t)},skipNulls:!1,strictNullHandling:!1};function uq(t){return typeof t=="string"||typeof t=="number"||typeof t=="boolean"||typeof t=="symbol"||typeof t=="bigint"}const Jf={};function bk(t,e,r,n,s,i,a,o,c,l,u,d,h,f,m,g,y,b){let _=t,E=b,C=0,k=!1;for(;(E=E.get(Jf))!==void 0&&!k;){const B=E.get(t);if(C+=1,typeof B<"u"){if(B===C)throw new RangeError("Cyclic object value");k=!0}typeof E.get(Jf)>"u"&&(C=0)}if(typeof l=="function"?_=l(e,_):_ instanceof Date?_=h==null?void 0:h(_):r==="comma"&&vr(_)&&(_=lv(_,function(B){return B instanceof Date?h==null?void 0:h(B):B})),_===null){if(i)return c&&!g?c(e,$t.encoder,y,"key",f):e;_=""}if(uq(_)||lq(_)){if(c){const B=g?e:c(e,$t.encoder,y,"key",f);return[(m==null?void 0:m(B))+"="+(m==null?void 0:m(c(_,$t.encoder,y,"value",f)))]}return[(m==null?void 0:m(e))+"="+(m==null?void 0:m(String(_)))]}const R=[];if(typeof _>"u")return R;let $;if(r==="comma"&&vr(_))g&&c&&(_=lv(_,c)),$=[{value:_.length>0?_.join(",")||null:void 0}];else if(vr(l))$=l;else{const B=Object.keys(_);$=u?B.sort(u):B}const S=o?String(e).replace(/\./g,"%2E"):String(e),M=n&&vr(_)&&_.length===1?S+"[]":S;if(s&&vr(_)&&_.length===0)return M+"[]";for(let B=0;B<$.length;++B){const q=$[B],se=typeof q=="object"&&typeof q.value<"u"?q.value:_[q];if(a&&se===null)continue;const pe=d&&o?q.replace(/\./g,"%2E"):q,j=vr(_)?typeof r=="function"?r(M,pe):M:M+(d?"."+pe:"["+pe+"]");b.set(t,C);const z=new WeakMap;z.set(Jf,b),wk(R,bk(se,j,r,n,s,i,a,o,r==="comma"&&g&&vr(_)?null:c,l,u,d,h,f,m,g,y,z))}return R}function dq(t=$t){if(typeof t.allowEmptyArrays<"u"&&typeof t.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof t.encodeDotInKeys<"u"&&typeof t.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(t.encoder!==null&&typeof t.encoder<"u"&&typeof t.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=t.charset||$t.charset;if(typeof t.charset<"u"&&t.charset!=="utf-8"&&t.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let r=gk;if(typeof t.format<"u"){if(!km(cv,t.format))throw new TypeError("Unknown format option provided.");r=t.format}const n=cv[r];let s=$t.filter;(typeof t.filter=="function"||vr(t.filter))&&(s=t.filter);let i;if(t.arrayFormat&&t.arrayFormat in _k?i=t.arrayFormat:"indices"in t?i=t.indices?"indices":"repeat":i=$t.arrayFormat,"commaRoundTrip"in t&&typeof t.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=typeof t.allowDots>"u"?t.encodeDotInKeys?!0:$t.allowDots:!!t.allowDots;return{addQueryPrefix:typeof t.addQueryPrefix=="boolean"?t.addQueryPrefix:$t.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof t.allowEmptyArrays=="boolean"?!!t.allowEmptyArrays:$t.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof t.charsetSentinel=="boolean"?t.charsetSentinel:$t.charsetSentinel,commaRoundTrip:!!t.commaRoundTrip,delimiter:typeof t.delimiter>"u"?$t.delimiter:t.delimiter,encode:typeof t.encode=="boolean"?t.encode:$t.encode,encodeDotInKeys:typeof t.encodeDotInKeys=="boolean"?t.encodeDotInKeys:$t.encodeDotInKeys,encoder:typeof t.encoder=="function"?t.encoder:$t.encoder,encodeValuesOnly:typeof t.encodeValuesOnly=="boolean"?t.encodeValuesOnly:$t.encodeValuesOnly,filter:s,format:r,formatter:n,serializeDate:typeof t.serializeDate=="function"?t.serializeDate:$t.serializeDate,skipNulls:typeof t.skipNulls=="boolean"?t.skipNulls:$t.skipNulls,sort:typeof t.sort=="function"?t.sort:null,strictNullHandling:typeof t.strictNullHandling=="boolean"?t.strictNullHandling:$t.strictNullHandling}}function hq(t,e={}){let r=t;const n=dq(e);let s,i;typeof n.filter=="function"?(i=n.filter,r=i("",r)):vr(n.filter)&&(i=n.filter,s=i);const a=[];if(typeof r!="object"||r===null)return"";const o=_k[n.arrayFormat],c=o==="comma"&&n.commaRoundTrip;s||(s=Object.keys(r)),n.sort&&s.sort(n.sort);const l=new WeakMap;for(let h=0;h<s.length;++h){const f=s[h];n.skipNulls&&r[f]===null||wk(a,bk(r[f],f,o,c,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,l))}const u=a.join(n.delimiter);let d=n.addQueryPrefix===!0?"?":"";return n.charsetSentinel&&(n.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}function fq(t){let e=0;for(const s of t)e+=s.length;const r=new Uint8Array(e);let n=0;for(const s of t)r.set(s,n),n+=s.length;return r}let dv;function Cy(t){let e;return(dv??(e=new globalThis.TextEncoder,dv=e.encode.bind(e)))(t)}let hv;function fv(t){let e;return(hv??(e=new globalThis.TextDecoder,hv=e.decode.bind(e)))(t)}var Mr,Dr;class Id{constructor(){Mr.set(this,void 0),Dr.set(this,void 0),Ce(this,Mr,new Uint8Array),Ce(this,Dr,null)}decode(e){if(e==null)return[];const r=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Cy(e):e;Ce(this,Mr,fq([P(this,Mr,"f"),r]));const n=[];let s;for(;(s=pq(P(this,Mr,"f"),P(this,Dr,"f")))!=null;){if(s.carriage&&P(this,Dr,"f")==null){Ce(this,Dr,s.index);continue}if(P(this,Dr,"f")!=null&&(s.index!==P(this,Dr,"f")+1||s.carriage)){n.push(fv(P(this,Mr,"f").subarray(0,P(this,Dr,"f")-1))),Ce(this,Mr,P(this,Mr,"f").subarray(P(this,Dr,"f"))),Ce(this,Dr,null);continue}const i=P(this,Dr,"f")!==null?s.preceding-1:s.preceding,a=fv(P(this,Mr,"f").subarray(0,i));n.push(a),Ce(this,Mr,P(this,Mr,"f").subarray(s.index)),Ce(this,Dr,null)}return n}flush(){return P(this,Mr,"f").length?this.decode(`
`):[]}}Mr=new WeakMap,Dr=new WeakMap;Id.NEWLINE_CHARS=new Set([`
`,"\r"]);Id.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function pq(t,e){for(let s=e??0;s<t.length;s++){if(t[s]===10)return{preceding:s,index:s+1,carriage:!1};if(t[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function mq(t){for(let n=0;n<t.length-1;n++){if(t[n]===10&&t[n+1]===10||t[n]===13&&t[n+1]===13)return n+2;if(t[n]===13&&t[n+1]===10&&n+3<t.length&&t[n+2]===13&&t[n+3]===10)return n+4}return-1}const Uu={off:0,error:200,warn:300,info:400,debug:500},pv=(t,e,r)=>{if(t){if(KV(Uu,t))return t;Jt(r).warn(`${e} was set to ${JSON.stringify(t)}, expected one of ${JSON.stringify(Object.keys(Uu))}`)}};function oo(){}function al(t,e,r){return!e||Uu[t]>Uu[r]?oo:e[t].bind(e)}const gq={error:oo,warn:oo,info:oo,debug:oo};let mv=new WeakMap;function Jt(t){const e=t.logger,r=t.logLevel??"off";if(!e)return gq;const n=mv.get(e);if(n&&n[0]===r)return n[1];const s={error:al("error",e,r),warn:al("warn",e,r),info:al("info",e,r),debug:al("debug",e,r)};return mv.set(e,[r,s]),s}const ui=t=>(t.options&&(t.options={...t.options},delete t.options.headers),t.headers&&(t.headers=Object.fromEntries((t.headers instanceof Headers?[...t.headers]:Object.entries(t.headers)).map(([e,r])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":r]))),"retryOfRequestLogID"in t&&(t.retryOfRequestLogID&&(t.retryOf=t.retryOfRequestLogID),delete t.retryOfRequestLogID),t);var Ka;class zn{constructor(e,r,n){this.iterator=e,Ka.set(this,void 0),this.controller=r,Ce(this,Ka,n)}static fromSSEResponse(e,r,n){let s=!1;const i=n?Jt(n):console;async function*a(){if(s)throw new we("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(const c of yq(e,r))if(!o){if(c.data.startsWith("[DONE]")){o=!0;continue}if(c.event===null||!c.event.startsWith("thread.")){let l;try{l=JSON.parse(c.data)}catch(u){throw i.error("Could not parse message into JSON:",c.data),i.error("From chunk:",c.raw),u}if(l&&l.error)throw new tr(void 0,l.error,void 0,e.headers);yield l}else{let l;try{l=JSON.parse(c.data)}catch(u){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),u}if(c.event=="error")throw new tr(void 0,l.error,l.message,void 0);yield{event:c.event,data:l}}}o=!0}catch(c){if(Sm(c))return;throw c}finally{o||r.abort()}}return new zn(a,r,n)}static fromReadableStream(e,r,n){let s=!1;async function*i(){const o=new Id,c=mk(e);for await(const l of c)for(const u of o.decode(l))yield u;for(const l of o.flush())yield l}async function*a(){if(s)throw new we("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(const c of i())o||c&&(yield JSON.parse(c));o=!0}catch(c){if(Sm(c))return;throw c}finally{o||r.abort()}}return new zn(a,r,n)}[(Ka=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],r=[],n=this.iterator(),s=i=>({next:()=>{if(i.length===0){const a=n.next();e.push(a),r.push(a)}return i.shift()}});return[new zn(()=>s(e),this.controller,P(this,Ka,"f")),new zn(()=>s(r),this.controller,P(this,Ka,"f"))]}toReadableStream(){const e=this;let r;return fk({async start(){r=e[Symbol.asyncIterator]()},async pull(n){try{const{value:s,done:i}=await r.next();if(i)return n.close();const a=Cy(JSON.stringify(s)+`
`);n.enqueue(a)}catch(s){n.error(s)}},async cancel(){var n;await((n=r.return)==null?void 0:n.call(r))}})}}async function*yq(t,e){if(!t.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new we("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new we("Attempted to iterate over a response with no body");const r=new wq,n=new Id,s=mk(t.body);for await(const i of _q(s))for(const a of n.decode(i)){const o=r.decode(a);o&&(yield o)}for(const i of n.flush()){const a=r.decode(i);a&&(yield a)}}async function*_q(t){let e=new Uint8Array;for await(const r of t){if(r==null)continue;const n=r instanceof ArrayBuffer?new Uint8Array(r):typeof r=="string"?Cy(r):r;let s=new Uint8Array(e.length+n.length);s.set(e),s.set(n,e.length),e=s;let i;for(;(i=mq(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}class wq{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[r,n,s]=bq(e,":");return s.startsWith(" ")&&(s=s.substring(1)),r==="event"?this.event=s:r==="data"&&this.data.push(s),null}}function bq(t,e){const r=t.indexOf(e);return r!==-1?[t.substring(0,r),e,t.substring(r+e.length)]:[t,"",""]}async function vk(t,e){const{response:r,requestLogID:n,retryOfRequestLogID:s,startTime:i}=e,a=await(async()=>{var d;if(e.options.stream)return Jt(t).debug("response",r.status,r.url,r.headers,r.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(r,e.controller,t):zn.fromSSEResponse(r,e.controller,t);if(r.status===204)return null;if(e.options.__binaryResponse)return r;const o=r.headers.get("content-type"),c=(d=o==null?void 0:o.split(";")[0])==null?void 0:d.trim();if((c==null?void 0:c.includes("application/json"))||(c==null?void 0:c.endsWith("+json"))){const h=await r.json();return Ek(h,r)}return await r.text()})();return Jt(t).debug(`[${n}] response parsed`,ui({retryOfRequestLogID:s,url:r.url,status:r.status,body:a,durationMs:Date.now()-i})),a}function Ek(t,e){return!t||typeof t!="object"||Array.isArray(t)?t:Object.defineProperty(t,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var co;class Rd extends Promise{constructor(e,r,n=vk){super(s=>{s(null)}),this.responsePromise=r,this.parseResponse=n,co.set(this,void 0),Ce(this,co,e)}_thenUnwrap(e){return new Rd(P(this,co,"f"),this.responsePromise,async(r,n)=>Ek(e(await this.parseResponse(r,n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,r]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:r,request_id:r.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(P(this,co,"f"),e))),this.parsedPromise}then(e,r){return this.parse().then(e,r)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}co=new WeakMap;var ol;class ky{constructor(e,r,n,s){ol.set(this,void 0),Ce(this,ol,e),this.options=s,this.response=r,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new we("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await P(this,ol,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(ol=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const r of e.getPaginatedItems())yield r}}class vq extends Rd{constructor(e,r,n){super(e,r,async(s,i)=>new n(s,i.response,await vk(s,i),i.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const r of e)yield r}}class Od extends ky{constructor(e,r,n,s){super(e,r,n,s),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class kt extends ky{constructor(e,r,n,s){super(e,r,n,s),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var n;const e=this.getPaginatedItems(),r=(n=e[e.length-1])==null?void 0:n.id;return r?{...this.options,query:{...hk(this.options.query),after:r}}:null}}class Bu extends ky{constructor(e,r,n,s){super(e,r,n,s),this.data=n.data||[],this.has_more=n.has_more||!1,this.last_id=n.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const e=this.last_id;return e?{...this.options,query:{...hk(this.options.query),after:e}}:null}}const Sk=()=>{var t;if(typeof File>"u"){const{process:e}=globalThis,r=typeof((t=e==null?void 0:e.versions)==null?void 0:t.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(r?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function ko(t,e,r){return Sk(),new File(t,e??"unknown_file",r)}function Ul(t){return(typeof t=="object"&&t!==null&&("name"in t&&t.name&&String(t.name)||"url"in t&&t.url&&String(t.url)||"filename"in t&&t.filename&&String(t.filename)||"path"in t&&t.path&&String(t.path))||"").split(/[\\/]/).pop()||void 0}const Iy=t=>t!=null&&typeof t=="object"&&typeof t[Symbol.asyncIterator]=="function",gv=async(t,e)=>Im(t.body)?{...t,body:await xk(t.body,e)}:t,Pi=async(t,e)=>({...t,body:await xk(t.body,e)}),yv=new WeakMap;function Eq(t){const e=typeof t=="function"?t:t.fetch,r=yv.get(e);if(r)return r;const n=(async()=>{try{const s="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new s(i).text()}catch{return!0}})();return yv.set(e,n),n}const xk=async(t,e)=>{if(!await Eq(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const r=new FormData;return await Promise.all(Object.entries(t||{}).map(([n,s])=>Rm(r,n,s))),r},Tk=t=>t instanceof Blob&&"name"in t,Sq=t=>typeof t=="object"&&t!==null&&(t instanceof Response||Iy(t)||Tk(t)),Im=t=>{if(Sq(t))return!0;if(Array.isArray(t))return t.some(Im);if(t&&typeof t=="object"){for(const e in t)if(Im(t[e]))return!0}return!1},Rm=async(t,e,r)=>{if(r!==void 0){if(r==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")t.append(e,String(r));else if(r instanceof Response)t.append(e,ko([await r.blob()],Ul(r)));else if(Iy(r))t.append(e,ko([await new Response(pk(r)).blob()],Ul(r)));else if(Tk(r))t.append(e,r,Ul(r));else if(Array.isArray(r))await Promise.all(r.map(n=>Rm(t,e+"[]",n)));else if(typeof r=="object")await Promise.all(Object.entries(r).map(([n,s])=>Rm(t,`${e}[${n}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${r} instead`)}},Ak=t=>t!=null&&typeof t=="object"&&typeof t.size=="number"&&typeof t.type=="string"&&typeof t.text=="function"&&typeof t.slice=="function"&&typeof t.arrayBuffer=="function",xq=t=>t!=null&&typeof t=="object"&&typeof t.name=="string"&&typeof t.lastModified=="number"&&Ak(t),Tq=t=>t!=null&&typeof t=="object"&&typeof t.url=="string"&&typeof t.blob=="function";async function Aq(t,e,r){if(Sk(),t=await t,xq(t))return t instanceof File?t:ko([await t.arrayBuffer()],t.name);if(Tq(t)){const s=await t.blob();return e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()),ko(await Om(s),e,r)}const n=await Om(t);if(e||(e=Ul(t)),!(r!=null&&r.type)){const s=n.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof s=="string"&&(r={...r,type:s})}return ko(n,e,r)}async function Om(t){var r;let e=[];if(typeof t=="string"||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)e.push(t);else if(Ak(t))e.push(t instanceof Blob?t:await t.arrayBuffer());else if(Iy(t))for await(const n of t)e.push(...await Om(n));else{const n=(r=t==null?void 0:t.constructor)==null?void 0:r.name;throw new Error(`Unexpected data type: ${typeof t}${n?`; constructor: ${n}`:""}${Cq(t)}`)}return e}function Cq(t){return typeof t!="object"||t===null?"":`; props: [${Object.getOwnPropertyNames(t).map(r=>`"${r}"`).join(", ")}]`}class ge{constructor(e){this._client=e}}function Ck(t){return t.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const _v=Object.freeze(Object.create(null)),kq=(t=Ck)=>function(r,...n){if(r.length===1)return r[0];let s=!1;const i=[],a=r.reduce((u,d,h)=>{var g;/[?#]/.test(d)&&(s=!0);const f=n[h];let m=(s?encodeURIComponent:t)(""+f);return h!==n.length&&(f==null||typeof f=="object"&&f.toString===((g=Object.getPrototypeOf(Object.getPrototypeOf(f.hasOwnProperty??_v)??_v))==null?void 0:g.toString))&&(m=f+"",i.push({start:u.length+d.length,length:m.length,error:`Value of type ${Object.prototype.toString.call(f).slice(8,-1)} is not a valid path parameter`})),u+d+(h===n.length?"":m)},""),o=a.split(/[?#]/,1)[0],c=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let l;for(;(l=c.exec(o))!==null;)i.push({start:l.index,length:l[0].length,error:`Value "${l[0]}" can't be safely passed as a path parameter`});if(i.sort((u,d)=>u.start-d.start),i.length>0){let u=0;const d=i.reduce((h,f)=>{const m=" ".repeat(f.start-u),g="^".repeat(f.length);return u=f.start+f.length,h+m+g},"");throw new we(`Path parameters result in path with invalid segments:
${i.map(h=>h.error).join(`
`)}
${a}
${d}`)}return a},H=kq(Ck);let kk=class extends ge{list(e,r={},n){return this._client.getAPIList(H`/chat/completions/${e}/messages`,kt,{query:r,...n})}};const ju=t=>(t==null?void 0:t.role)==="assistant",Ik=t=>(t==null?void 0:t.role)==="tool";var $m,Bl,jl,lo,uo,Fl,ho,ns,fo,Fu,zu,na,Rk;class Ry{constructor(){$m.add(this),this.controller=new AbortController,Bl.set(this,void 0),jl.set(this,()=>{}),lo.set(this,()=>{}),uo.set(this,void 0),Fl.set(this,()=>{}),ho.set(this,()=>{}),ns.set(this,{}),fo.set(this,!1),Fu.set(this,!1),zu.set(this,!1),na.set(this,!1),Ce(this,Bl,new Promise((e,r)=>{Ce(this,jl,e,"f"),Ce(this,lo,r,"f")})),Ce(this,uo,new Promise((e,r)=>{Ce(this,Fl,e,"f"),Ce(this,ho,r,"f")})),P(this,Bl,"f").catch(()=>{}),P(this,uo,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},P(this,$m,"m",Rk).bind(this))},0)}_connected(){this.ended||(P(this,jl,"f").call(this),this._emit("connect"))}get ended(){return P(this,fo,"f")}get errored(){return P(this,Fu,"f")}get aborted(){return P(this,zu,"f")}abort(){this.controller.abort()}on(e,r){return(P(this,ns,"f")[e]||(P(this,ns,"f")[e]=[])).push({listener:r}),this}off(e,r){const n=P(this,ns,"f")[e];if(!n)return this;const s=n.findIndex(i=>i.listener===r);return s>=0&&n.splice(s,1),this}once(e,r){return(P(this,ns,"f")[e]||(P(this,ns,"f")[e]=[])).push({listener:r,once:!0}),this}emitted(e){return new Promise((r,n)=>{Ce(this,na,!0),e!=="error"&&this.once("error",n),this.once(e,r)})}async done(){Ce(this,na,!0),await P(this,uo,"f")}_emit(e,...r){if(P(this,fo,"f"))return;e==="end"&&(Ce(this,fo,!0),P(this,Fl,"f").call(this));const n=P(this,ns,"f")[e];if(n&&(P(this,ns,"f")[e]=n.filter(s=>!s.once),n.forEach(({listener:s})=>s(...r))),e==="abort"){const s=r[0];!P(this,na,"f")&&!(n!=null&&n.length)&&Promise.reject(s),P(this,lo,"f").call(this,s),P(this,ho,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=r[0];!P(this,na,"f")&&!(n!=null&&n.length)&&Promise.reject(s),P(this,lo,"f").call(this,s),P(this,ho,"f").call(this,s),this._emit("end")}}_emitFinal(){}}Bl=new WeakMap,jl=new WeakMap,lo=new WeakMap,uo=new WeakMap,Fl=new WeakMap,ho=new WeakMap,ns=new WeakMap,fo=new WeakMap,Fu=new WeakMap,zu=new WeakMap,na=new WeakMap,$m=new WeakSet,Rk=function(e){if(Ce(this,Fu,!0),e instanceof Error&&e.name==="AbortError"&&(e=new zr),e instanceof zr)return Ce(this,zu,!0),this._emit("abort",e);if(e instanceof we)return this._emit("error",e);if(e instanceof Error){const r=new we(e.message);return r.cause=e,this._emit("error",r)}return this._emit("error",new we(String(e)))};function Iq(t){return typeof t.parse=="function"}var dr,Nm,Vu,Pm,Lm,Mm,Ok,$k;const Rq=10;class Nk extends Ry{constructor(){super(...arguments),dr.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var n;this._chatCompletions.push(e),this._emit("chatCompletion",e);const r=(n=e.choices[0])==null?void 0:n.message;return r&&this._addMessage(r),e}_addMessage(e,r=!0){if("content"in e||(e.content=null),this.messages.push(e),r){if(this._emit("message",e),Ik(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(ju(e)&&e.tool_calls)for(const n of e.tool_calls)n.type==="function"&&this._emit("functionToolCall",n.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new we("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),P(this,dr,"m",Nm).call(this)}async finalMessage(){return await this.done(),P(this,dr,"m",Vu).call(this)}async finalFunctionToolCall(){return await this.done(),P(this,dr,"m",Pm).call(this)}async finalFunctionToolCallResult(){return await this.done(),P(this,dr,"m",Lm).call(this)}async totalUsage(){return await this.done(),P(this,dr,"m",Mm).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const r=P(this,dr,"m",Vu).call(this);r&&this._emit("finalMessage",r);const n=P(this,dr,"m",Nm).call(this);n&&this._emit("finalContent",n);const s=P(this,dr,"m",Pm).call(this);s&&this._emit("finalFunctionToolCall",s);const i=P(this,dr,"m",Lm).call(this);i!=null&&this._emit("finalFunctionToolCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",P(this,dr,"m",Mm).call(this))}async _createChatCompletion(e,r,n){const s=n==null?void 0:n.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),P(this,dr,"m",Ok).call(this,r);const i=await e.chat.completions.create({...r,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Ay(i,r))}async _runChatCompletion(e,r,n){for(const s of r.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,r,n)}async _runTools(e,r,n){var f,m,g;const s="tool",{tool_choice:i="auto",stream:a,...o}=r,c=typeof i!="string"&&i.type==="function"&&((f=i==null?void 0:i.function)==null?void 0:f.name),{maxChatCompletions:l=Rq}=n||{},u=r.tools.map(y=>{if(Ic(y)){if(!y.$callback)throw new we("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:y.$callback,name:y.function.name,description:y.function.description||"",parameters:y.function.parameters,parse:y.$parseRaw,strict:!0}}}return y}),d={};for(const y of u)y.type==="function"&&(d[y.function.name||y.function.function.name]=y.function);const h="tools"in r?u.map(y=>y.type==="function"?{type:"function",function:{name:y.function.name||y.function.function.name,parameters:y.function.parameters,description:y.function.description,strict:y.function.strict}}:y):void 0;for(const y of r.messages)this._addMessage(y,!1);for(let y=0;y<l;++y){const _=(m=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:h,messages:[...this.messages]},n)).choices[0])==null?void 0:m.message;if(!_)throw new we("missing message in ChatCompletion response");if(!((g=_.tool_calls)!=null&&g.length))return;for(const E of _.tool_calls){if(E.type!=="function")continue;const C=E.id,{name:k,arguments:R}=E.function,$=d[k];if($){if(c&&c!==k){const q=`Invalid tool_call: ${JSON.stringify(k)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:s,tool_call_id:C,content:q});continue}}else{const q=`Invalid tool_call: ${JSON.stringify(k)}. Available options are: ${Object.keys(d).map(se=>JSON.stringify(se)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:C,content:q});continue}let S;try{S=Iq($)?await $.parse(R):R}catch(q){const se=q instanceof Error?q.message:String(q);this._addMessage({role:s,tool_call_id:C,content:se});continue}const M=await $.function(S,this),B=P(this,dr,"m",$k).call(this,M);if(this._addMessage({role:s,tool_call_id:C,content:B}),c)return}}}}dr=new WeakSet,Nm=function(){return P(this,dr,"m",Vu).call(this).content??null},Vu=function(){let e=this.messages.length;for(;e-- >0;){const r=this.messages[e];if(ju(r))return{...r,content:r.content??null,refusal:r.refusal??null}}throw new we("stream ended without producing a ChatCompletionMessage with role=assistant")},Pm=function(){var e,r;for(let n=this.messages.length-1;n>=0;n--){const s=this.messages[n];if(ju(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(r=s.tool_calls.filter(i=>i.type==="function").at(-1))==null?void 0:r.function}},Lm=function(){for(let e=this.messages.length-1;e>=0;e--){const r=this.messages[e];if(Ik(r)&&r.content!=null&&typeof r.content=="string"&&this.messages.some(n=>{var s;return n.role==="assistant"&&((s=n.tool_calls)==null?void 0:s.some(i=>i.type==="function"&&i.id===r.tool_call_id))}))return r.content}},Mm=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:r}of this._chatCompletions)r&&(e.completion_tokens+=r.completion_tokens,e.prompt_tokens+=r.prompt_tokens,e.total_tokens+=r.total_tokens);return e},Ok=function(e){if(e.n!=null&&e.n>1)throw new we("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},$k=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Oy extends Nk{static runTools(e,r,n){const s=new Oy,i={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,r,i)),s}_addMessage(e,r=!0){super._addMessage(e,r),ju(e)&&e.content&&this._emit("content",e.content)}}const Pk=1,Lk=2,Mk=4,Dk=8,Uk=16,Bk=32,jk=64,Fk=128,zk=256,Vk=Fk|zk,qk=Uk|Bk|Vk|jk,Hk=Pk|Lk|qk,Gk=Mk|Dk,Oq=Hk|Gk,Dt={STR:Pk,NUM:Lk,ARR:Mk,OBJ:Dk,NULL:Uk,BOOL:Bk,NAN:jk,INFINITY:Fk,MINUS_INFINITY:zk,INF:Vk,SPECIAL:qk,ATOM:Hk,COLLECTION:Gk,ALL:Oq};class $q extends Error{}class Nq extends Error{}function Pq(t,e=Dt.ALL){if(typeof t!="string")throw new TypeError(`expecting str, got ${typeof t}`);if(!t.trim())throw new Error(`${t} is empty`);return Lq(t.trim(),e)}const Lq=(t,e)=>{const r=t.length;let n=0;const s=h=>{throw new $q(`${h} at position ${n}`)},i=h=>{throw new Nq(`${h} at position ${n}`)},a=()=>(d(),n>=r&&s("Unexpected end of input"),t[n]==='"'?o():t[n]==="{"?c():t[n]==="["?l():t.substring(n,n+4)==="null"||Dt.NULL&e&&r-n<4&&"null".startsWith(t.substring(n))?(n+=4,null):t.substring(n,n+4)==="true"||Dt.BOOL&e&&r-n<4&&"true".startsWith(t.substring(n))?(n+=4,!0):t.substring(n,n+5)==="false"||Dt.BOOL&e&&r-n<5&&"false".startsWith(t.substring(n))?(n+=5,!1):t.substring(n,n+8)==="Infinity"||Dt.INFINITY&e&&r-n<8&&"Infinity".startsWith(t.substring(n))?(n+=8,1/0):t.substring(n,n+9)==="-Infinity"||Dt.MINUS_INFINITY&e&&1<r-n&&r-n<9&&"-Infinity".startsWith(t.substring(n))?(n+=9,-1/0):t.substring(n,n+3)==="NaN"||Dt.NAN&e&&r-n<3&&"NaN".startsWith(t.substring(n))?(n+=3,NaN):u()),o=()=>{const h=n;let f=!1;for(n++;n<r&&(t[n]!=='"'||f&&t[n-1]==="\\");)f=t[n]==="\\"?!f:!1,n++;if(t.charAt(n)=='"')try{return JSON.parse(t.substring(h,++n-Number(f)))}catch(m){i(String(m))}else if(Dt.STR&e)try{return JSON.parse(t.substring(h,n-Number(f))+'"')}catch{return JSON.parse(t.substring(h,t.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},c=()=>{n++,d();const h={};try{for(;t[n]!=="}";){if(d(),n>=r&&Dt.OBJ&e)return h;const f=o();d(),n++;try{const m=a();Object.defineProperty(h,f,{value:m,writable:!0,enumerable:!0,configurable:!0})}catch(m){if(Dt.OBJ&e)return h;throw m}d(),t[n]===","&&n++}}catch{if(Dt.OBJ&e)return h;s("Expected '}' at end of object")}return n++,h},l=()=>{n++;const h=[];try{for(;t[n]!=="]";)h.push(a()),d(),t[n]===","&&n++}catch{if(Dt.ARR&e)return h;s("Expected ']' at end of array")}return n++,h},u=()=>{if(n===0){t==="-"&&Dt.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t)}catch(f){if(Dt.NUM&e)try{return t[t.length-1]==="."?JSON.parse(t.substring(0,t.lastIndexOf("."))):JSON.parse(t.substring(0,t.lastIndexOf("e")))}catch{}i(String(f))}}const h=n;for(t[n]==="-"&&n++;t[n]&&!",]}".includes(t[n]);)n++;n==r&&!(Dt.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(t.substring(h,n))}catch{t.substring(h,n)==="-"&&Dt.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t.substring(h,t.lastIndexOf("e")))}catch(m){i(String(m))}}},d=()=>{for(;n<r&&` 
\r	`.includes(t[n]);)n++};return a()},wv=t=>Pq(t,Dt.ALL^Dt.NUM);var Rt,ts,Zi,ks,Zf,cl,Kf,Xf,Yf,ll,Qf,bv;class ac extends Nk{constructor(e){super(),Rt.add(this),ts.set(this,void 0),Zi.set(this,void 0),ks.set(this,void 0),Ce(this,ts,e),Ce(this,Zi,[])}get currentChatCompletionSnapshot(){return P(this,ks,"f")}static fromReadableStream(e){const r=new ac(null);return r._run(()=>r._fromReadableStream(e)),r}static createChatCompletion(e,r,n){const s=new ac(r);return s._run(()=>s._runChatCompletion(e,{...r,stream:!0},{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,r,n){var a;super._createChatCompletion;const s=n==null?void 0:n.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),P(this,Rt,"m",Zf).call(this);const i=await e.chat.completions.create({...r,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const o of i)P(this,Rt,"m",Kf).call(this,o);if((a=i.controller.signal)!=null&&a.aborted)throw new zr;return this._addChatCompletion(P(this,Rt,"m",ll).call(this))}async _fromReadableStream(e,r){var a;const n=r==null?void 0:r.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),P(this,Rt,"m",Zf).call(this),this._connected();const s=zn.fromReadableStream(e,this.controller);let i;for await(const o of s)i&&i!==o.id&&this._addChatCompletion(P(this,Rt,"m",ll).call(this)),P(this,Rt,"m",Kf).call(this,o),i=o.id;if((a=s.controller.signal)!=null&&a.aborted)throw new zr;return this._addChatCompletion(P(this,Rt,"m",ll).call(this))}[(ts=new WeakMap,Zi=new WeakMap,ks=new WeakMap,Rt=new WeakSet,Zf=function(){this.ended||Ce(this,ks,void 0)},cl=function(r){let n=P(this,Zi,"f")[r.index];return n||(n={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},P(this,Zi,"f")[r.index]=n,n)},Kf=function(r){var s,i,a,o,c,l,u,d,h,f,m,g,y,b,_;if(this.ended)return;const n=P(this,Rt,"m",bv).call(this,r);this._emit("chunk",r,n);for(const E of r.choices){const C=n.choices[E.index];E.delta.content!=null&&((s=C.message)==null?void 0:s.role)==="assistant"&&((i=C.message)!=null&&i.content)&&(this._emit("content",E.delta.content,C.message.content),this._emit("content.delta",{delta:E.delta.content,snapshot:C.message.content,parsed:C.message.parsed})),E.delta.refusal!=null&&((a=C.message)==null?void 0:a.role)==="assistant"&&((o=C.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:E.delta.refusal,snapshot:C.message.refusal}),((c=E.logprobs)==null?void 0:c.content)!=null&&((l=C.message)==null?void 0:l.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(u=E.logprobs)==null?void 0:u.content,snapshot:((d=C.logprobs)==null?void 0:d.content)??[]}),((h=E.logprobs)==null?void 0:h.refusal)!=null&&((f=C.message)==null?void 0:f.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(m=E.logprobs)==null?void 0:m.refusal,snapshot:((g=C.logprobs)==null?void 0:g.refusal)??[]});const k=P(this,Rt,"m",cl).call(this,C);C.finish_reason&&(P(this,Rt,"m",Yf).call(this,C),k.current_tool_call_index!=null&&P(this,Rt,"m",Xf).call(this,C,k.current_tool_call_index));for(const R of E.delta.tool_calls??[])k.current_tool_call_index!==R.index&&(P(this,Rt,"m",Yf).call(this,C),k.current_tool_call_index!=null&&P(this,Rt,"m",Xf).call(this,C,k.current_tool_call_index)),k.current_tool_call_index=R.index;for(const R of E.delta.tool_calls??[]){const $=(y=C.message.tool_calls)==null?void 0:y[R.index];$!=null&&$.type&&(($==null?void 0:$.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(b=$.function)==null?void 0:b.name,index:R.index,arguments:$.function.arguments,parsed_arguments:$.function.parsed_arguments,arguments_delta:((_=R.function)==null?void 0:_.arguments)??""}):($==null||$.type,void 0))}}},Xf=function(r,n){var a,o,c;if(P(this,Rt,"m",cl).call(this,r).done_tool_calls.has(n))return;const i=(a=r.message.tool_calls)==null?void 0:a[n];if(!i)throw new Error("no tool call snapshot");if(!i.type)throw new Error("tool call snapshot missing `type`");if(i.type==="function"){const l=(c=(o=P(this,ts,"f"))==null?void 0:o.tools)==null?void 0:c.find(u=>Mu(u)&&u.function.name===i.function.name);this._emit("tool_calls.function.arguments.done",{name:i.function.name,index:n,arguments:i.function.arguments,parsed_arguments:Ic(l)?l.$parseRaw(i.function.arguments):l!=null&&l.function.strict?JSON.parse(i.function.arguments):null})}else i.type},Yf=function(r){var s,i;const n=P(this,Rt,"m",cl).call(this,r);if(r.message.content&&!n.content_done){n.content_done=!0;const a=P(this,Rt,"m",Qf).call(this);this._emit("content.done",{content:r.message.content,parsed:a?a.$parseRaw(r.message.content):null})}r.message.refusal&&!n.refusal_done&&(n.refusal_done=!0,this._emit("refusal.done",{refusal:r.message.refusal})),(s=r.logprobs)!=null&&s.content&&!n.logprobs_content_done&&(n.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:r.logprobs.content})),(i=r.logprobs)!=null&&i.refusal&&!n.logprobs_refusal_done&&(n.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:r.logprobs.refusal}))},ll=function(){if(this.ended)throw new we("stream has ended, this shouldn't happen");const r=P(this,ks,"f");if(!r)throw new we("request ended without sending any chunks");return Ce(this,ks,void 0),Ce(this,Zi,[]),Mq(r,P(this,ts,"f"))},Qf=function(){var n;const r=(n=P(this,ts,"f"))==null?void 0:n.response_format;return Ty(r)?r:null},bv=function(r){var n,s,i,a;let o=P(this,ks,"f");const{choices:c,...l}=r;o?Object.assign(o,l):o=Ce(this,ks,{...l,choices:[]});for(const{delta:u,finish_reason:d,index:h,logprobs:f=null,...m}of r.choices){let g=o.choices[h];if(g||(g=o.choices[h]={finish_reason:d,index:h,message:{},logprobs:f,...m}),f)if(!g.logprobs)g.logprobs=Object.assign({},f);else{const{content:R,refusal:$,...S}=f;Object.assign(g.logprobs,S),R&&((n=g.logprobs).content??(n.content=[]),g.logprobs.content.push(...R)),$&&((s=g.logprobs).refusal??(s.refusal=[]),g.logprobs.refusal.push(...$))}if(d&&(g.finish_reason=d,P(this,ts,"f")&&sk(P(this,ts,"f")))){if(d==="length")throw new rk;if(d==="content_filter")throw new nk}if(Object.assign(g,m),!u)continue;const{content:y,refusal:b,function_call:_,role:E,tool_calls:C,...k}=u;if(Object.assign(g.message,k),b&&(g.message.refusal=(g.message.refusal||"")+b),E&&(g.message.role=E),_&&(g.message.function_call?(_.name&&(g.message.function_call.name=_.name),_.arguments&&((i=g.message.function_call).arguments??(i.arguments=""),g.message.function_call.arguments+=_.arguments)):g.message.function_call=_),y&&(g.message.content=(g.message.content||"")+y,!g.message.refusal&&P(this,Rt,"m",Qf).call(this)&&(g.message.parsed=wv(g.message.content))),C){g.message.tool_calls||(g.message.tool_calls=[]);for(const{index:R,id:$,type:S,function:M,...B}of C){const q=(a=g.message.tool_calls)[R]??(a[R]={});Object.assign(q,B),$&&(q.id=$),S&&(q.type=S),M&&(q.function??(q.function={name:M.name??"",arguments:""})),M!=null&&M.name&&(q.function.name=M.name),M!=null&&M.arguments&&(q.function.arguments+=M.arguments,zz(P(this,ts,"f"),q)&&(q.function.parsed_arguments=wv(q.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],r=[];let n=!1;return this.on("chunk",s=>{const i=r.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(const s of r)s.resolve(void 0);r.length=0}),this.on("abort",s=>{n=!0;for(const i of r)i.reject(s);r.length=0}),this.on("error",s=>{n=!0;for(const i of r)i.reject(s);r.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>r.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new zn(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Mq(t,e){const{id:r,choices:n,created:s,model:i,system_fingerprint:a,...o}=t,c={...o,id:r,choices:n.map(({message:l,finish_reason:u,index:d,logprobs:h,...f})=>{if(!u)throw new we(`missing finish_reason for choice ${d}`);const{content:m=null,function_call:g,tool_calls:y,...b}=l,_=l.role;if(!_)throw new we(`missing role for choice ${d}`);if(g){const{arguments:E,name:C}=g;if(E==null)throw new we(`missing function_call.arguments for choice ${d}`);if(!C)throw new we(`missing function_call.name for choice ${d}`);return{...f,message:{content:m,function_call:{arguments:E,name:C},role:_,refusal:l.refusal??null},finish_reason:u,index:d,logprobs:h}}return y?{...f,index:d,finish_reason:u,logprobs:h,message:{...b,role:_,content:m,refusal:l.refusal??null,tool_calls:y.map((E,C)=>{const{function:k,type:R,id:$,...S}=E,{arguments:M,name:B,...q}=k||{};if($==null)throw new we(`missing choices[${d}].tool_calls[${C}].id
${ul(t)}`);if(R==null)throw new we(`missing choices[${d}].tool_calls[${C}].type
${ul(t)}`);if(B==null)throw new we(`missing choices[${d}].tool_calls[${C}].function.name
${ul(t)}`);if(M==null)throw new we(`missing choices[${d}].tool_calls[${C}].function.arguments
${ul(t)}`);return{...S,id:$,type:R,function:{...q,name:B,arguments:M}}})}}:{...f,message:{...b,content:m,role:_,refusal:l.refusal??null},finish_reason:u,index:d,logprobs:h}}),created:s,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return Bz(c,e)}function ul(t){return JSON.stringify(t)}class qu extends ac{static fromReadableStream(e){const r=new qu(null);return r._run(()=>r._fromReadableStream(e)),r}static runTools(e,r,n){const s=new qu(r),i={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,r,i)),s}}let $y=class extends ge{constructor(){super(...arguments),this.messages=new kk(this._client)}create(e,r){return this._client.post("/chat/completions",{body:e,...r,stream:e.stream??!1})}retrieve(e,r){return this._client.get(H`/chat/completions/${e}`,r)}update(e,r,n){return this._client.post(H`/chat/completions/${e}`,{body:r,...n})}list(e={},r){return this._client.getAPIList("/chat/completions",kt,{query:e,...r})}delete(e,r){return this._client.delete(H`/chat/completions/${e}`,r)}parse(e,r){return Vz(e.tools),this._client.chat.completions.create(e,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(n=>Ay(n,e))}runTools(e,r){return e.stream?qu.runTools(this._client,e,r):Oy.runTools(this._client,e,r)}stream(e,r){return ac.createChatCompletion(this._client,e,r)}};$y.Messages=kk;class Ny extends ge{constructor(){super(...arguments),this.completions=new $y(this._client)}}Ny.Completions=$y;const Wk=Symbol("brand.privateNullableHeaders");function*Dq(t){if(!t)return;if(Wk in t){const{values:n,nulls:s}=t;yield*n.entries();for(const i of s)yield[i,null];return}let e=!1,r;t instanceof Headers?r=t.entries():sv(t)?r=t:(e=!0,r=Object.entries(t??{}));for(let n of r){const s=n[0];if(typeof s!="string")throw new TypeError("expected header name to be a string");const i=sv(n[1])?n[1]:[n[1]];let a=!1;for(const o of i)o!==void 0&&(e&&!a&&(a=!0,yield[s,null]),yield[s,o])}}const ue=t=>{const e=new Headers,r=new Set;for(const n of t){const s=new Set;for(const[i,a]of Dq(n)){const o=i.toLowerCase();s.has(o)||(e.delete(i),s.add(o)),a===null?(e.delete(i),r.add(o)):(e.append(i,a),r.delete(o))}}return{[Wk]:!0,values:e,nulls:r}};class Jk extends ge{create(e,r){return this._client.post("/audio/speech",{body:e,...r,headers:ue([{Accept:"application/octet-stream"},r==null?void 0:r.headers]),__binaryResponse:!0})}}class Zk extends ge{create(e,r){return this._client.post("/audio/transcriptions",Pi({body:e,...r,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class Kk extends ge{create(e,r){return this._client.post("/audio/translations",Pi({body:e,...r,__metadata:{model:e.model}},this._client))}}class Oc extends ge{constructor(){super(...arguments),this.transcriptions=new Zk(this._client),this.translations=new Kk(this._client),this.speech=new Jk(this._client)}}Oc.Transcriptions=Zk;Oc.Translations=Kk;Oc.Speech=Jk;class Xk extends ge{create(e,r){return this._client.post("/batches",{body:e,...r})}retrieve(e,r){return this._client.get(H`/batches/${e}`,r)}list(e={},r){return this._client.getAPIList("/batches",kt,{query:e,...r})}cancel(e,r){return this._client.post(H`/batches/${e}/cancel`,r)}}class Yk extends ge{create(e,r){return this._client.post("/assistants",{body:e,...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,r){return this._client.get(H`/assistants/${e}`,{...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,r,n){return this._client.post(H`/assistants/${e}`,{body:r,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e={},r){return this._client.getAPIList("/assistants",kt,{query:e,...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,r){return this._client.delete(H`/assistants/${e}`,{...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}let Qk=class extends ge{create(e,r){return this._client.post("/realtime/sessions",{body:e,...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}};class eI extends ge{create(e,r){return this._client.post("/realtime/transcription_sessions",{body:e,...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}let $d=class extends ge{constructor(){super(...arguments),this.sessions=new Qk(this._client),this.transcriptionSessions=new eI(this._client)}};$d.Sessions=Qk;$d.TranscriptionSessions=eI;class tI extends ge{create(e,r){return this._client.post("/chatkit/sessions",{body:e,...r,headers:ue([{"OpenAI-Beta":"chatkit_beta=v1"},r==null?void 0:r.headers])})}cancel(e,r){return this._client.post(H`/chatkit/sessions/${e}/cancel`,{...r,headers:ue([{"OpenAI-Beta":"chatkit_beta=v1"},r==null?void 0:r.headers])})}}let rI=class extends ge{retrieve(e,r){return this._client.get(H`/chatkit/threads/${e}`,{...r,headers:ue([{"OpenAI-Beta":"chatkit_beta=v1"},r==null?void 0:r.headers])})}list(e={},r){return this._client.getAPIList("/chatkit/threads",Bu,{query:e,...r,headers:ue([{"OpenAI-Beta":"chatkit_beta=v1"},r==null?void 0:r.headers])})}delete(e,r){return this._client.delete(H`/chatkit/threads/${e}`,{...r,headers:ue([{"OpenAI-Beta":"chatkit_beta=v1"},r==null?void 0:r.headers])})}listItems(e,r={},n){return this._client.getAPIList(H`/chatkit/threads/${e}/items`,Bu,{query:r,...n,headers:ue([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}};class Nd extends ge{constructor(){super(...arguments),this.sessions=new tI(this._client),this.threads=new rI(this._client)}}Nd.Sessions=tI;Nd.Threads=rI;class nI extends ge{create(e,r,n){return this._client.post(H`/threads/${e}/messages`,{body:r,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,r,n){const{thread_id:s}=r;return this._client.get(H`/threads/${s}/messages/${e}`,{...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,r,n){const{thread_id:s,...i}=r;return this._client.post(H`/threads/${s}/messages/${e}`,{body:i,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e,r={},n){return this._client.getAPIList(H`/threads/${e}/messages`,kt,{query:r,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,r,n){const{thread_id:s}=r;return this._client.delete(H`/threads/${s}/messages/${e}`,{...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}class sI extends ge{retrieve(e,r,n){const{thread_id:s,run_id:i,...a}=r;return this._client.get(H`/threads/${s}/runs/${i}/steps/${e}`,{query:a,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e,r,n){const{thread_id:s,...i}=r;return this._client.getAPIList(H`/threads/${s}/runs/${e}/steps`,kt,{query:i,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}const Uq=t=>{if(typeof er<"u"){const e=er.from(t,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(t),r=e.length,n=new Uint8Array(r);for(let s=0;s<r;s++)n[s]=e.charCodeAt(s);return Array.from(new Float32Array(n.buffer))}};var ep={};const Ki=t=>{var e,r,n,s;if(typeof globalThis.process<"u")return((e=ep==null?void 0:ep[t])==null?void 0:e.trim())??void 0;if(typeof globalThis.Deno<"u")return(s=(n=(r=globalThis.Deno.env)==null?void 0:r.get)==null?void 0:n.call(r,t))==null?void 0:s.trim()};var Zt,yi,Dm,Mn,zl,gn,_i,fa,hi,Hu,Ur,Vl,ql,Io,po,mo,vv,Ev,Sv,xv,Tv,Av,Cv;class Ro extends Ry{constructor(){super(...arguments),Zt.add(this),Dm.set(this,[]),Mn.set(this,{}),zl.set(this,{}),gn.set(this,void 0),_i.set(this,void 0),fa.set(this,void 0),hi.set(this,void 0),Hu.set(this,void 0),Ur.set(this,void 0),Vl.set(this,void 0),ql.set(this,void 0),Io.set(this,void 0)}[(Dm=new WeakMap,Mn=new WeakMap,zl=new WeakMap,gn=new WeakMap,_i=new WeakMap,fa=new WeakMap,hi=new WeakMap,Hu=new WeakMap,Ur=new WeakMap,Vl=new WeakMap,ql=new WeakMap,Io=new WeakMap,Zt=new WeakSet,Symbol.asyncIterator)](){const e=[],r=[];let n=!1;return this.on("event",s=>{const i=r.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(const s of r)s.resolve(void 0);r.length=0}),this.on("abort",s=>{n=!0;for(const i of r)i.reject(s);r.length=0}),this.on("error",s=>{n=!0;for(const i of r)i.reject(s);r.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>r.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const r=new yi;return r._run(()=>r._fromReadableStream(e)),r}async _fromReadableStream(e,r){var i;const n=r==null?void 0:r.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=zn.fromReadableStream(e,this.controller);for await(const a of s)P(this,Zt,"m",po).call(this,a);if((i=s.controller.signal)!=null&&i.aborted)throw new zr;return this._addRun(P(this,Zt,"m",mo).call(this))}toReadableStream(){return new zn(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,r,n,s){const i=new yi;return i._run(()=>i._runToolAssistantStream(e,r,n,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,r,n,s){var c;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},o=await e.submitToolOutputs(r,a,{...s,signal:this.controller.signal});this._connected();for await(const l of o)P(this,Zt,"m",po).call(this,l);if((c=o.controller.signal)!=null&&c.aborted)throw new zr;return this._addRun(P(this,Zt,"m",mo).call(this))}static createThreadAssistantStream(e,r,n){const s=new yi;return s._run(()=>s._threadAssistantStream(e,r,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,r,n,s){const i=new yi;return i._run(()=>i._runAssistantStream(e,r,n,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return P(this,Vl,"f")}currentRun(){return P(this,ql,"f")}currentMessageSnapshot(){return P(this,gn,"f")}currentRunStepSnapshot(){return P(this,Io,"f")}async finalRunSteps(){return await this.done(),Object.values(P(this,Mn,"f"))}async finalMessages(){return await this.done(),Object.values(P(this,zl,"f"))}async finalRun(){if(await this.done(),!P(this,_i,"f"))throw Error("Final run was not received.");return P(this,_i,"f")}async _createThreadAssistantStream(e,r,n){var o;const s=n==null?void 0:n.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const i={...r,stream:!0},a=await e.createAndRun(i,{...n,signal:this.controller.signal});this._connected();for await(const c of a)P(this,Zt,"m",po).call(this,c);if((o=a.controller.signal)!=null&&o.aborted)throw new zr;return this._addRun(P(this,Zt,"m",mo).call(this))}async _createAssistantStream(e,r,n,s){var c;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},o=await e.create(r,a,{...s,signal:this.controller.signal});this._connected();for await(const l of o)P(this,Zt,"m",po).call(this,l);if((c=o.controller.signal)!=null&&c.aborted)throw new zr;return this._addRun(P(this,Zt,"m",mo).call(this))}static accumulateDelta(e,r){for(const[n,s]of Object.entries(r)){if(!e.hasOwnProperty(n)){e[n]=s;continue}let i=e[n];if(i==null){e[n]=s;continue}if(n==="index"||n==="type"){e[n]=s;continue}if(typeof i=="string"&&typeof s=="string")i+=s;else if(typeof i=="number"&&typeof s=="number")i+=s;else if(Gf(i)&&Gf(s))i=this.accumulateDelta(i,s);else if(Array.isArray(i)&&Array.isArray(s)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...s);continue}for(const a of s){if(!Gf(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);const o=a.index;if(o==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const c=i[o];c==null?i.push(a):i[o]=this.accumulateDelta(c,a)}continue}else throw Error(`Unhandled record type: ${n}, deltaValue: ${s}, accValue: ${i}`);e[n]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,r,n){return await this._createThreadAssistantStream(r,e,n)}async _runAssistantStream(e,r,n,s){return await this._createAssistantStream(r,e,n,s)}async _runToolAssistantStream(e,r,n,s){return await this._createToolAssistantStream(r,e,n,s)}}yi=Ro,po=function(e){if(!this.ended)switch(Ce(this,Vl,e),P(this,Zt,"m",Sv).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":P(this,Zt,"m",Cv).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":P(this,Zt,"m",Ev).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":P(this,Zt,"m",vv).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},mo=function(){if(this.ended)throw new we("stream has ended, this shouldn't happen");if(!P(this,_i,"f"))throw Error("Final run has not been received");return P(this,_i,"f")},vv=function(e){const[r,n]=P(this,Zt,"m",Tv).call(this,e,P(this,gn,"f"));Ce(this,gn,r),P(this,zl,"f")[r.id]=r;for(const s of n){const i=r.content[s.index];(i==null?void 0:i.type)=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,r),e.data.delta.content)for(const s of e.data.delta.content){if(s.type=="text"&&s.text){let i=s.text,a=r.content[s.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=P(this,fa,"f")){if(P(this,hi,"f"))switch(P(this,hi,"f").type){case"text":this._emit("textDone",P(this,hi,"f").text,P(this,gn,"f"));break;case"image_file":this._emit("imageFileDone",P(this,hi,"f").image_file,P(this,gn,"f"));break}Ce(this,fa,s.index)}Ce(this,hi,r.content[s.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(P(this,fa,"f")!==void 0){const s=e.data.content[P(this,fa,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,P(this,gn,"f"));break;case"text":this._emit("textDone",s.text,P(this,gn,"f"));break}}P(this,gn,"f")&&this._emit("messageDone",e.data),Ce(this,gn,void 0)}},Ev=function(e){const r=P(this,Zt,"m",xv).call(this,e);switch(Ce(this,Io,r),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&n.step_details.type=="tool_calls"&&n.step_details.tool_calls&&r.step_details.type=="tool_calls")for(const i of n.step_details.tool_calls)i.index==P(this,Hu,"f")?this._emit("toolCallDelta",i,r.step_details.tool_calls[i.index]):(P(this,Ur,"f")&&this._emit("toolCallDone",P(this,Ur,"f")),Ce(this,Hu,i.index),Ce(this,Ur,r.step_details.tool_calls[i.index]),P(this,Ur,"f")&&this._emit("toolCallCreated",P(this,Ur,"f")));this._emit("runStepDelta",e.data.delta,r);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Ce(this,Io,void 0),e.data.step_details.type=="tool_calls"&&P(this,Ur,"f")&&(this._emit("toolCallDone",P(this,Ur,"f")),Ce(this,Ur,void 0)),this._emit("runStepDone",e.data,r);break}},Sv=function(e){P(this,Dm,"f").push(e),this._emit("event",e)},xv=function(e){switch(e.event){case"thread.run.step.created":return P(this,Mn,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let r=P(this,Mn,"f")[e.data.id];if(!r)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const s=yi.accumulateDelta(r,n.delta);P(this,Mn,"f")[e.data.id]=s}return P(this,Mn,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":P(this,Mn,"f")[e.data.id]=e.data;break}if(P(this,Mn,"f")[e.data.id])return P(this,Mn,"f")[e.data.id];throw new Error("No snapshot available")},Tv=function(e,r){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!r)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const i of s.delta.content)if(i.index in r.content){let a=r.content[i.index];r.content[i.index]=P(this,Zt,"m",Av).call(this,i,a)}else r.content[i.index]=i,n.push(i);return[r,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(r)return[r,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Av=function(e,r){return yi.accumulateDelta(r,e)},Cv=function(e){switch(Ce(this,ql,e.data),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":Ce(this,_i,e.data),P(this,Ur,"f")&&(this._emit("toolCallDone",P(this,Ur,"f")),Ce(this,Ur,void 0));break}};let Py=class extends ge{constructor(){super(...arguments),this.steps=new sI(this._client)}create(e,r,n){const{include:s,...i}=r;return this._client.post(H`/threads/${e}/runs`,{query:{include:s},body:i,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers]),stream:r.stream??!1})}retrieve(e,r,n){const{thread_id:s}=r;return this._client.get(H`/threads/${s}/runs/${e}`,{...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,r,n){const{thread_id:s,...i}=r;return this._client.post(H`/threads/${s}/runs/${e}`,{body:i,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e,r={},n){return this._client.getAPIList(H`/threads/${e}/runs`,kt,{query:r,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}cancel(e,r,n){const{thread_id:s}=r;return this._client.post(H`/threads/${s}/runs/${e}/cancel`,{...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}async createAndPoll(e,r,n){const s=await this.create(e,r,n);return await this.poll(s.id,{thread_id:e},n)}createAndStream(e,r,n){return Ro.createAssistantStream(e,this._client.beta.threads.runs,r,n)}async poll(e,r,n){var i;const s=ue([n==null?void 0:n.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=n==null?void 0:n.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const{data:a,response:o}=await this.retrieve(e,r,{...n,headers:{...n==null?void 0:n.headers,...s}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let c=5e3;if(n!=null&&n.pollIntervalMs)c=n.pollIntervalMs;else{const l=o.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(c=u)}}await Rc(c);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,r,n){return Ro.createAssistantStream(e,this._client.beta.threads.runs,r,n)}submitToolOutputs(e,r,n){const{thread_id:s,...i}=r;return this._client.post(H`/threads/${s}/runs/${e}/submit_tool_outputs`,{body:i,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers]),stream:r.stream??!1})}async submitToolOutputsAndPoll(e,r,n){const s=await this.submitToolOutputs(e,r,n);return await this.poll(s.id,r,n)}submitToolOutputsStream(e,r,n){return Ro.createToolAssistantStream(e,this._client.beta.threads.runs,r,n)}};Py.Steps=sI;class Pd extends ge{constructor(){super(...arguments),this.runs=new Py(this._client),this.messages=new nI(this._client)}create(e={},r){return this._client.post("/threads",{body:e,...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,r){return this._client.get(H`/threads/${e}`,{...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,r,n){return this._client.post(H`/threads/${e}`,{body:r,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,r){return this._client.delete(H`/threads/${e}`,{...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}createAndRun(e,r){return this._client.post("/threads/runs",{body:e,...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers]),stream:e.stream??!1})}async createAndRunPoll(e,r){const n=await this.createAndRun(e,r);return await this.runs.poll(n.id,{thread_id:n.thread_id},r)}createAndRunStream(e,r){return Ro.createThreadAssistantStream(e,this._client.beta.threads,r)}}Pd.Runs=Py;Pd.Messages=nI;class Fa extends ge{constructor(){super(...arguments),this.realtime=new $d(this._client),this.chatkit=new Nd(this._client),this.assistants=new Yk(this._client),this.threads=new Pd(this._client)}}Fa.Realtime=$d;Fa.ChatKit=Nd;Fa.Assistants=Yk;Fa.Threads=Pd;class iI extends ge{create(e,r){return this._client.post("/completions",{body:e,...r,stream:e.stream??!1})}}class aI extends ge{retrieve(e,r,n){const{container_id:s}=r;return this._client.get(H`/containers/${s}/files/${e}/content`,{...n,headers:ue([{Accept:"application/binary"},n==null?void 0:n.headers]),__binaryResponse:!0})}}let Ly=class extends ge{constructor(){super(...arguments),this.content=new aI(this._client)}create(e,r,n){return this._client.post(H`/containers/${e}/files`,Pi({body:r,...n},this._client))}retrieve(e,r,n){const{container_id:s}=r;return this._client.get(H`/containers/${s}/files/${e}`,n)}list(e,r={},n){return this._client.getAPIList(H`/containers/${e}/files`,kt,{query:r,...n})}delete(e,r,n){const{container_id:s}=r;return this._client.delete(H`/containers/${s}/files/${e}`,{...n,headers:ue([{Accept:"*/*"},n==null?void 0:n.headers])})}};Ly.Content=aI;class My extends ge{constructor(){super(...arguments),this.files=new Ly(this._client)}create(e,r){return this._client.post("/containers",{body:e,...r})}retrieve(e,r){return this._client.get(H`/containers/${e}`,r)}list(e={},r){return this._client.getAPIList("/containers",kt,{query:e,...r})}delete(e,r){return this._client.delete(H`/containers/${e}`,{...r,headers:ue([{Accept:"*/*"},r==null?void 0:r.headers])})}}My.Files=Ly;class oI extends ge{create(e,r,n){const{include:s,...i}=r;return this._client.post(H`/conversations/${e}/items`,{query:{include:s},body:i,...n})}retrieve(e,r,n){const{conversation_id:s,...i}=r;return this._client.get(H`/conversations/${s}/items/${e}`,{query:i,...n})}list(e,r={},n){return this._client.getAPIList(H`/conversations/${e}/items`,Bu,{query:r,...n})}delete(e,r,n){const{conversation_id:s}=r;return this._client.delete(H`/conversations/${s}/items/${e}`,n)}}class Dy extends ge{constructor(){super(...arguments),this.items=new oI(this._client)}create(e={},r){return this._client.post("/conversations",{body:e,...r})}retrieve(e,r){return this._client.get(H`/conversations/${e}`,r)}update(e,r,n){return this._client.post(H`/conversations/${e}`,{body:r,...n})}delete(e,r){return this._client.delete(H`/conversations/${e}`,r)}}Dy.Items=oI;class cI extends ge{create(e,r){const n=!!e.encoding_format;let s=n?e.encoding_format:"base64";n&&Jt(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const i=this._client.post("/embeddings",{body:{...e,encoding_format:s},...r});return n?i:(Jt(this._client).debug("embeddings/decoding base64 embeddings from base64"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(o=>{const c=o.embedding;o.embedding=Uq(c)}),a)))}}class lI extends ge{retrieve(e,r,n){const{eval_id:s,run_id:i}=r;return this._client.get(H`/evals/${s}/runs/${i}/output_items/${e}`,n)}list(e,r,n){const{eval_id:s,...i}=r;return this._client.getAPIList(H`/evals/${s}/runs/${e}/output_items`,kt,{query:i,...n})}}class Uy extends ge{constructor(){super(...arguments),this.outputItems=new lI(this._client)}create(e,r,n){return this._client.post(H`/evals/${e}/runs`,{body:r,...n})}retrieve(e,r,n){const{eval_id:s}=r;return this._client.get(H`/evals/${s}/runs/${e}`,n)}list(e,r={},n){return this._client.getAPIList(H`/evals/${e}/runs`,kt,{query:r,...n})}delete(e,r,n){const{eval_id:s}=r;return this._client.delete(H`/evals/${s}/runs/${e}`,n)}cancel(e,r,n){const{eval_id:s}=r;return this._client.post(H`/evals/${s}/runs/${e}`,n)}}Uy.OutputItems=lI;class By extends ge{constructor(){super(...arguments),this.runs=new Uy(this._client)}create(e,r){return this._client.post("/evals",{body:e,...r})}retrieve(e,r){return this._client.get(H`/evals/${e}`,r)}update(e,r,n){return this._client.post(H`/evals/${e}`,{body:r,...n})}list(e={},r){return this._client.getAPIList("/evals",kt,{query:e,...r})}delete(e,r){return this._client.delete(H`/evals/${e}`,r)}}By.Runs=Uy;let uI=class extends ge{create(e,r){return this._client.post("/files",Pi({body:e,...r},this._client))}retrieve(e,r){return this._client.get(H`/files/${e}`,r)}list(e={},r){return this._client.getAPIList("/files",kt,{query:e,...r})}delete(e,r){return this._client.delete(H`/files/${e}`,r)}content(e,r){return this._client.get(H`/files/${e}/content`,{...r,headers:ue([{Accept:"application/binary"},r==null?void 0:r.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:r=5e3,maxWait:n=1800*1e3}={}){const s=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await Rc(r),a=await this.retrieve(e),Date.now()-i>n)throw new kd({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}};class dI extends ge{}let hI=class extends ge{run(e,r){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...r})}validate(e,r){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...r})}};class jy extends ge{constructor(){super(...arguments),this.graders=new hI(this._client)}}jy.Graders=hI;class fI extends ge{create(e,r,n){return this._client.getAPIList(H`/fine_tuning/checkpoints/${e}/permissions`,Od,{body:r,method:"post",...n})}retrieve(e,r={},n){return this._client.get(H`/fine_tuning/checkpoints/${e}/permissions`,{query:r,...n})}delete(e,r,n){const{fine_tuned_model_checkpoint:s}=r;return this._client.delete(H`/fine_tuning/checkpoints/${s}/permissions/${e}`,n)}}let Fy=class extends ge{constructor(){super(...arguments),this.permissions=new fI(this._client)}};Fy.Permissions=fI;class pI extends ge{list(e,r={},n){return this._client.getAPIList(H`/fine_tuning/jobs/${e}/checkpoints`,kt,{query:r,...n})}}class zy extends ge{constructor(){super(...arguments),this.checkpoints=new pI(this._client)}create(e,r){return this._client.post("/fine_tuning/jobs",{body:e,...r})}retrieve(e,r){return this._client.get(H`/fine_tuning/jobs/${e}`,r)}list(e={},r){return this._client.getAPIList("/fine_tuning/jobs",kt,{query:e,...r})}cancel(e,r){return this._client.post(H`/fine_tuning/jobs/${e}/cancel`,r)}listEvents(e,r={},n){return this._client.getAPIList(H`/fine_tuning/jobs/${e}/events`,kt,{query:r,...n})}pause(e,r){return this._client.post(H`/fine_tuning/jobs/${e}/pause`,r)}resume(e,r){return this._client.post(H`/fine_tuning/jobs/${e}/resume`,r)}}zy.Checkpoints=pI;class za extends ge{constructor(){super(...arguments),this.methods=new dI(this._client),this.jobs=new zy(this._client),this.checkpoints=new Fy(this._client),this.alpha=new jy(this._client)}}za.Methods=dI;za.Jobs=zy;za.Checkpoints=Fy;za.Alpha=jy;class mI extends ge{}class Vy extends ge{constructor(){super(...arguments),this.graderModels=new mI(this._client)}}Vy.GraderModels=mI;class gI extends ge{createVariation(e,r){return this._client.post("/images/variations",Pi({body:e,...r},this._client))}edit(e,r){return this._client.post("/images/edits",Pi({body:e,...r,stream:e.stream??!1},this._client))}generate(e,r){return this._client.post("/images/generations",{body:e,...r,stream:e.stream??!1})}}class yI extends ge{retrieve(e,r){return this._client.get(H`/models/${e}`,r)}list(e){return this._client.getAPIList("/models",Od,e)}delete(e,r){return this._client.delete(H`/models/${e}`,r)}}class _I extends ge{create(e,r){return this._client.post("/moderations",{body:e,...r})}}class wI extends ge{accept(e,r,n){return this._client.post(H`/realtime/calls/${e}/accept`,{body:r,...n,headers:ue([{Accept:"*/*"},n==null?void 0:n.headers])})}hangup(e,r){return this._client.post(H`/realtime/calls/${e}/hangup`,{...r,headers:ue([{Accept:"*/*"},r==null?void 0:r.headers])})}refer(e,r,n){return this._client.post(H`/realtime/calls/${e}/refer`,{body:r,...n,headers:ue([{Accept:"*/*"},n==null?void 0:n.headers])})}reject(e,r={},n){return this._client.post(H`/realtime/calls/${e}/reject`,{body:r,...n,headers:ue([{Accept:"*/*"},n==null?void 0:n.headers])})}}class bI extends ge{create(e,r){return this._client.post("/realtime/client_secrets",{body:e,...r})}}class Ld extends ge{constructor(){super(...arguments),this.clientSecrets=new bI(this._client),this.calls=new wI(this._client)}}Ld.ClientSecrets=bI;Ld.Calls=wI;var Xi,dl,Is,hl,kv,Iv,Rv,Ov;class qy extends Ry{constructor(e){super(),Xi.add(this),dl.set(this,void 0),Is.set(this,void 0),hl.set(this,void 0),Ce(this,dl,e)}static createResponse(e,r,n){const s=new qy(r);return s._run(()=>s._createOrRetrieveResponse(e,r,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,r,n){var o;const s=n==null?void 0:n.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),P(this,Xi,"m",kv).call(this);let i,a=null;"response_id"in r?(i=await e.responses.retrieve(r.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),a=r.starting_after??null):i=await e.responses.create({...r,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const c of i)P(this,Xi,"m",Iv).call(this,c,a);if((o=i.controller.signal)!=null&&o.aborted)throw new zr;return P(this,Xi,"m",Rv).call(this)}[(dl=new WeakMap,Is=new WeakMap,hl=new WeakMap,Xi=new WeakSet,kv=function(){this.ended||Ce(this,Is,void 0)},Iv=function(r,n){if(this.ended)return;const s=(a,o)=>{(n==null||o.sequence_number>n)&&this._emit(a,o)},i=P(this,Xi,"m",Ov).call(this,r);switch(s("event",r),r.type){case"response.output_text.delta":{const a=i.output[r.output_index];if(!a)throw new we(`missing output at index ${r.output_index}`);if(a.type==="message"){const o=a.content[r.content_index];if(!o)throw new we(`missing content at index ${r.content_index}`);if(o.type!=="output_text")throw new we(`expected content to be 'output_text', got ${o.type}`);s("response.output_text.delta",{...r,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const a=i.output[r.output_index];if(!a)throw new we(`missing output at index ${r.output_index}`);a.type==="function_call"&&s("response.function_call_arguments.delta",{...r,snapshot:a.arguments});break}default:s(r.type,r);break}},Rv=function(){if(this.ended)throw new we("stream has ended, this shouldn't happen");const r=P(this,Is,"f");if(!r)throw new we("request ended without sending any events");Ce(this,Is,void 0);const n=Bq(r,P(this,dl,"f"));return Ce(this,hl,n),n},Ov=function(r){var s;let n=P(this,Is,"f");if(!n){if(r.type!=="response.created")throw new we(`When snapshot hasn't been set yet, expected 'response.created' event, got ${r.type}`);return n=Ce(this,Is,r.response),n}switch(r.type){case"response.output_item.added":{n.output.push(r.item);break}case"response.content_part.added":{const i=n.output[r.output_index];if(!i)throw new we(`missing output at index ${r.output_index}`);const a=i.type,o=r.part;a==="message"&&o.type!=="reasoning_text"?i.content.push(o):a==="reasoning"&&o.type==="reasoning_text"&&(i.content||(i.content=[]),i.content.push(o));break}case"response.output_text.delta":{const i=n.output[r.output_index];if(!i)throw new we(`missing output at index ${r.output_index}`);if(i.type==="message"){const a=i.content[r.content_index];if(!a)throw new we(`missing content at index ${r.content_index}`);if(a.type!=="output_text")throw new we(`expected content to be 'output_text', got ${a.type}`);a.text+=r.delta}break}case"response.function_call_arguments.delta":{const i=n.output[r.output_index];if(!i)throw new we(`missing output at index ${r.output_index}`);i.type==="function_call"&&(i.arguments+=r.delta);break}case"response.reasoning_text.delta":{const i=n.output[r.output_index];if(!i)throw new we(`missing output at index ${r.output_index}`);if(i.type==="reasoning"){const a=(s=i.content)==null?void 0:s[r.content_index];if(!a)throw new we(`missing content at index ${r.content_index}`);if(a.type!=="reasoning_text")throw new we(`expected content to be 'reasoning_text', got ${a.type}`);a.text+=r.delta}break}case"response.completed":{Ce(this,Is,r.response);break}}return n},Symbol.asyncIterator)](){const e=[],r=[];let n=!1;return this.on("event",s=>{const i=r.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(const s of r)s.resolve(void 0);r.length=0}),this.on("abort",s=>{n=!0;for(const i of r)i.reject(s);r.length=0}),this.on("error",s=>{n=!0;for(const i of r)i.reject(s);r.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>r.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=P(this,hl,"f");if(!e)throw new we("stream ended without producing a ChatCompletion");return e}}function Bq(t,e){return RV(t,e)}class vI extends ge{list(e,r={},n){return this._client.getAPIList(H`/responses/${e}/input_items`,kt,{query:r,...n})}}class EI extends ge{count(e={},r){return this._client.post("/responses/input_tokens",{body:e,...r})}}class Md extends ge{constructor(){super(...arguments),this.inputItems=new vI(this._client),this.inputTokens=new EI(this._client)}create(e,r){return this._client.post("/responses",{body:e,...r,stream:e.stream??!1})._thenUnwrap(n=>("object"in n&&n.object==="response"&&Am(n),n))}retrieve(e,r={},n){return this._client.get(H`/responses/${e}`,{query:r,...n,stream:(r==null?void 0:r.stream)??!1})._thenUnwrap(s=>("object"in s&&s.object==="response"&&Am(s),s))}delete(e,r){return this._client.delete(H`/responses/${e}`,{...r,headers:ue([{Accept:"*/*"},r==null?void 0:r.headers])})}parse(e,r){return this._client.responses.create(e,r)._thenUnwrap(n=>uk(n,e))}stream(e,r){return qy.createResponse(this._client,e,r)}cancel(e,r){return this._client.post(H`/responses/${e}/cancel`,r)}}Md.InputItems=vI;Md.InputTokens=EI;class SI extends ge{create(e,r,n){return this._client.post(H`/uploads/${e}/parts`,Pi({body:r,...n},this._client))}}class Hy extends ge{constructor(){super(...arguments),this.parts=new SI(this._client)}create(e,r){return this._client.post("/uploads",{body:e,...r})}cancel(e,r){return this._client.post(H`/uploads/${e}/cancel`,r)}complete(e,r,n){return this._client.post(H`/uploads/${e}/complete`,{body:r,...n})}}Hy.Parts=SI;const jq=async t=>{const e=await Promise.allSettled(t),r=e.filter(s=>s.status==="rejected");if(r.length){for(const s of r)console.error(s.reason);throw new Error(`${r.length} promise(s) failed - see the above errors`)}const n=[];for(const s of e)s.status==="fulfilled"&&n.push(s.value);return n};class xI extends ge{create(e,r,n){return this._client.post(H`/vector_stores/${e}/file_batches`,{body:r,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,r,n){const{vector_store_id:s}=r;return this._client.get(H`/vector_stores/${s}/file_batches/${e}`,{...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}cancel(e,r,n){const{vector_store_id:s}=r;return this._client.post(H`/vector_stores/${s}/file_batches/${e}/cancel`,{...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}async createAndPoll(e,r,n){const s=await this.create(e,r);return await this.poll(e,s.id,n)}listFiles(e,r,n){const{vector_store_id:s,...i}=r;return this._client.getAPIList(H`/vector_stores/${s}/file_batches/${e}/files`,kt,{query:i,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}async poll(e,r,n){var i;const s=ue([n==null?void 0:n.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=n==null?void 0:n.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const{data:a,response:o}=await this.retrieve(r,{vector_store_id:e},{...n,headers:s}).withResponse();switch(a.status){case"in_progress":let c=5e3;if(n!=null&&n.pollIntervalMs)c=n.pollIntervalMs;else{const l=o.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(c=u)}}await Rc(c);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:r,fileIds:n=[]},s){if(r==null||r.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const i=(s==null?void 0:s.maxConcurrency)??5,a=Math.min(i,r.length),o=this._client,c=r.values(),l=[...n];async function u(h){for(let f of h){const m=await o.files.create({file:f,purpose:"assistants"},s);l.push(m.id)}}const d=Array(a).fill(c).map(u);return await jq(d),await this.createAndPoll(e,{file_ids:l})}}class TI extends ge{create(e,r,n){return this._client.post(H`/vector_stores/${e}/files`,{body:r,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,r,n){const{vector_store_id:s}=r;return this._client.get(H`/vector_stores/${s}/files/${e}`,{...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,r,n){const{vector_store_id:s,...i}=r;return this._client.post(H`/vector_stores/${s}/files/${e}`,{body:i,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e,r={},n){return this._client.getAPIList(H`/vector_stores/${e}/files`,kt,{query:r,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,r,n){const{vector_store_id:s}=r;return this._client.delete(H`/vector_stores/${s}/files/${e}`,{...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}async createAndPoll(e,r,n){const s=await this.create(e,r,n);return await this.poll(e,s.id,n)}async poll(e,r,n){var i;const s=ue([n==null?void 0:n.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=n==null?void 0:n.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const a=await this.retrieve(r,{vector_store_id:e},{...n,headers:s}).withResponse(),o=a.data;switch(o.status){case"in_progress":let c=5e3;if(n!=null&&n.pollIntervalMs)c=n.pollIntervalMs;else{const l=a.response.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(c=u)}}await Rc(c);break;case"failed":case"completed":return o}}}async upload(e,r,n){const s=await this._client.files.create({file:r,purpose:"assistants"},n);return this.create(e,{file_id:s.id},n)}async uploadAndPoll(e,r,n){const s=await this.upload(e,r,n);return await this.poll(e,s.id,n)}content(e,r,n){const{vector_store_id:s}=r;return this._client.getAPIList(H`/vector_stores/${s}/files/${e}/content`,Od,{...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}class Dd extends ge{constructor(){super(...arguments),this.files=new TI(this._client),this.fileBatches=new xI(this._client)}create(e,r){return this._client.post("/vector_stores",{body:e,...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,r){return this._client.get(H`/vector_stores/${e}`,{...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,r,n){return this._client.post(H`/vector_stores/${e}`,{body:r,...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e={},r){return this._client.getAPIList("/vector_stores",kt,{query:e,...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,r){return this._client.delete(H`/vector_stores/${e}`,{...r,headers:ue([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}search(e,r,n){return this._client.getAPIList(H`/vector_stores/${e}/search`,Od,{body:r,method:"post",...n,headers:ue([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}Dd.Files=TI;Dd.FileBatches=xI;class AI extends ge{create(e,r){return this._client.post("/videos",gv({body:e,...r},this._client))}retrieve(e,r){return this._client.get(H`/videos/${e}`,r)}list(e={},r){return this._client.getAPIList("/videos",Bu,{query:e,...r})}delete(e,r){return this._client.delete(H`/videos/${e}`,r)}downloadContent(e,r={},n){return this._client.get(H`/videos/${e}/content`,{query:r,...n,headers:ue([{Accept:"application/binary"},n==null?void 0:n.headers]),__binaryResponse:!0})}remix(e,r,n){return this._client.post(H`/videos/${e}/remix`,gv({body:r,...n},this._client))}}var sa,CI,Hl;class kI extends ge{constructor(){super(...arguments),sa.add(this)}async unwrap(e,r,n=this._client.webhookSecret,s=300){return await this.verifySignature(e,r,n,s),JSON.parse(e)}async verifySignature(e,r,n=this._client.webhookSecret,s=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");P(this,sa,"m",CI).call(this,n);const i=ue([r]).values,a=P(this,sa,"m",Hl).call(this,i,"webhook-signature"),o=P(this,sa,"m",Hl).call(this,i,"webhook-timestamp"),c=P(this,sa,"m",Hl).call(this,i,"webhook-id"),l=parseInt(o,10);if(isNaN(l))throw new ao("Invalid webhook timestamp format");const u=Math.floor(Date.now()/1e3);if(u-l>s)throw new ao("Webhook timestamp is too old");if(l>u+s)throw new ao("Webhook timestamp is too new");const d=a.split(" ").map(g=>g.startsWith("v1,")?g.substring(3):g),h=n.startsWith("whsec_")?er.from(n.replace("whsec_",""),"base64"):er.from(n,"utf-8"),f=c?`${c}.${o}.${e}`:`${o}.${e}`,m=await crypto.subtle.importKey("raw",h,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const g of d)try{const y=er.from(g,"base64");if(await crypto.subtle.verify("HMAC",m,y,new TextEncoder().encode(f)))return}catch{continue}throw new ao("The given webhook signature does not match the expected signature")}}sa=new WeakSet,CI=function(e){if(typeof e!="string"||e.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Hl=function(e,r){if(!e)throw new Error("Headers are required");const n=e.get(r);if(n==null)throw new Error(`Missing required header: ${r}`);return n};var Um,Gy,Gl,II;class Me{constructor({baseURL:e=Ki("OPENAI_BASE_URL"),apiKey:r=Ki("OPENAI_API_KEY"),organization:n=Ki("OPENAI_ORG_ID")??null,project:s=Ki("OPENAI_PROJECT_ID")??null,webhookSecret:i=Ki("OPENAI_WEBHOOK_SECRET")??null,...a}={}){if(Um.add(this),Gl.set(this,void 0),this.completions=new iI(this),this.chat=new Ny(this),this.embeddings=new cI(this),this.files=new uI(this),this.images=new gI(this),this.audio=new Oc(this),this.moderations=new _I(this),this.models=new yI(this),this.fineTuning=new za(this),this.graders=new Vy(this),this.vectorStores=new Dd(this),this.webhooks=new kI(this),this.beta=new Fa(this),this.batches=new Xk(this),this.uploads=new Hy(this),this.responses=new Md(this),this.realtime=new Ld(this),this.conversations=new Dy(this),this.evals=new By(this),this.containers=new My(this),this.videos=new AI(this),r===void 0)throw new we("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const o={apiKey:r,organization:n,project:s,webhookSecret:i,...a,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&QV())throw new we(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=o.baseURL,this.timeout=o.timeout??Gy.DEFAULT_TIMEOUT,this.logger=o.logger??console;const c="warn";this.logLevel=c,this.logLevel=pv(o.logLevel,"ClientOptions.logLevel",this)??pv(Ki("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??c,this.fetchOptions=o.fetchOptions,this.maxRetries=o.maxRetries??2,this.fetch=o.fetch??sq(),Ce(this,Gl,aq),this._options=o,this.apiKey=typeof r=="string"?r:"Missing Key",this.organization=n,this.project=s,this.webhookSecret=i}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:r}){}async authHeaders(e){return ue([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return hq(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${ra}`}defaultIdempotencyKey(){return`stainless-node-retry-${dk()}`}makeStatusError(e,r,n,s){return tr.generate(e,r,n,s)}async _callApiKey(){const e=this._options.apiKey;if(typeof e!="function")return!1;let r;try{r=await e()}catch(n){throw n instanceof we?n:new we(`Failed to get token from 'apiKey' function: ${n.message}`,{cause:n})}if(typeof r!="string"||!r)throw new we(`Expected 'apiKey' function argument to return a string but it returned ${r}`);return this.apiKey=r,!0}buildURL(e,r,n){const s=!P(this,Um,"m",II).call(this)&&n||this.baseURL,i=JV(e)?new URL(e):new URL(s+(s.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return ZV(a)||(r={...a,...r}),typeof r=="object"&&r&&!Array.isArray(r)&&(i.search=this.stringifyQuery(r)),i.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:r,options:n}){}get(e,r){return this.methodRequest("get",e,r)}post(e,r){return this.methodRequest("post",e,r)}patch(e,r){return this.methodRequest("patch",e,r)}put(e,r){return this.methodRequest("put",e,r)}delete(e,r){return this.methodRequest("delete",e,r)}methodRequest(e,r,n){return this.request(Promise.resolve(n).then(s=>({method:e,path:r,...s})))}request(e,r=null){return new Rd(this,this.makeRequest(e,r,void 0))}async makeRequest(e,r,n){var b,_;const s=await e,i=s.maxRetries??this.maxRetries;r==null&&(r=i),await this.prepareOptions(s);const{req:a,url:o,timeout:c}=await this.buildRequest(s,{retryCount:i-r});await this.prepareRequest(a,{url:o,options:s});const l="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),u=n===void 0?"":`, retryOf: ${n}`,d=Date.now();if(Jt(this).debug(`[${l}] sending request`,ui({retryOfRequestLogID:n,method:s.method,url:o,options:s,headers:a.headers})),(b=s.signal)!=null&&b.aborted)throw new zr;const h=new AbortController,f=await this.fetchWithTimeout(o,a,c,h).catch(xm),m=Date.now();if(f instanceof globalThis.Error){const E=`retrying, ${r} attempts remaining`;if((_=s.signal)!=null&&_.aborted)throw new zr;const C=Sm(f)||/timed? ?out/i.test(String(f)+("cause"in f?String(f.cause):""));if(r)return Jt(this).info(`[${l}] connection ${C?"timed out":"failed"} - ${E}`),Jt(this).debug(`[${l}] connection ${C?"timed out":"failed"} (${E})`,ui({retryOfRequestLogID:n,url:o,durationMs:m-d,message:f.message})),this.retryRequest(s,r,n??l);throw Jt(this).info(`[${l}] connection ${C?"timed out":"failed"} - error; no more retries left`),Jt(this).debug(`[${l}] connection ${C?"timed out":"failed"} (error; no more retries left)`,ui({retryOfRequestLogID:n,url:o,durationMs:m-d,message:f.message})),C?new kd:new Cd({cause:f})}const g=[...f.headers.entries()].filter(([E])=>E==="x-request-id").map(([E,C])=>", "+E+": "+JSON.stringify(C)).join(""),y=`[${l}${u}${g}] ${a.method} ${o} ${f.ok?"succeeded":"failed"} with status ${f.status} in ${m-d}ms`;if(!f.ok){const E=await this.shouldRetry(f);if(r&&E){const M=`retrying, ${r} attempts remaining`;return await iq(f.body),Jt(this).info(`${y} - ${M}`),Jt(this).debug(`[${l}] response error (${M})`,ui({retryOfRequestLogID:n,url:f.url,status:f.status,headers:f.headers,durationMs:m-d})),this.retryRequest(s,r,n??l,f.headers)}const C=E?"error; no more retries left":"error; not retryable";Jt(this).info(`${y} - ${C}`);const k=await f.text().catch(M=>xm(M).message),R=YV(k),$=R?void 0:k;throw Jt(this).debug(`[${l}] response error (${C})`,ui({retryOfRequestLogID:n,url:f.url,status:f.status,headers:f.headers,message:$,durationMs:Date.now()-d})),this.makeStatusError(f.status,R,$,f.headers)}return Jt(this).info(y),Jt(this).debug(`[${l}] response start`,ui({retryOfRequestLogID:n,url:f.url,status:f.status,headers:f.headers,durationMs:m-d})),{response:f,options:s,controller:h,requestLogID:l,retryOfRequestLogID:n,startTime:d}}getAPIList(e,r,n){return this.requestAPIList(r,{method:"get",path:e,...n})}requestAPIList(e,r){const n=this.makeRequest(r,null,void 0);return new vq(this,n,e)}async fetchWithTimeout(e,r,n,s){const{signal:i,method:a,...o}=r||{};i&&i.addEventListener("abort",()=>s.abort());const c=setTimeout(()=>s.abort(),n),l=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||typeof o.body=="object"&&o.body!==null&&Symbol.asyncIterator in o.body,u={signal:s.signal,...l?{duplex:"half"}:{},method:"GET",...o};a&&(u.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,u)}finally{clearTimeout(c)}}async shouldRetry(e){const r=e.headers.get("x-should-retry");return r==="true"?!0:r==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,r,n,s){let i;const a=s==null?void 0:s.get("retry-after-ms");if(a){const c=parseFloat(a);Number.isNaN(c)||(i=c)}const o=s==null?void 0:s.get("retry-after");if(o&&!i){const c=parseFloat(o);Number.isNaN(c)?i=Date.parse(o)-Date.now():i=c*1e3}if(!(i&&0<=i&&i<60*1e3)){const c=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(r,c)}return await Rc(i),this.makeRequest(e,r-1,n)}calculateDefaultRetryTimeoutMillis(e,r){const i=r-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}async buildRequest(e,{retryCount:r=0}={}){const n={...e},{method:s,path:i,query:a,defaultBaseURL:o}=n,c=this.buildURL(i,a,o);"timeout"in n&&XV("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const{bodyHeaders:l,body:u}=this.buildBody({options:n}),d=await this.buildHeaders({options:e,method:s,bodyHeaders:l,retryCount:r});return{req:{method:s,headers:d,...n.signal&&{signal:n.signal},...globalThis.ReadableStream&&u instanceof globalThis.ReadableStream&&{duplex:"half"},...u&&{body:u},...this.fetchOptions??{},...n.fetchOptions??{}},url:c,timeout:n.timeout}}async buildHeaders({options:e,method:r,bodyHeaders:n,retryCount:s}){let i={};this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const a=ue([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(s),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...nq(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,n,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:r}}){if(!e)return{bodyHeaders:void 0,body:void 0};const n=ue([r]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&n.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:pk(e)}:P(this,Gl,"f").call(this,{body:e,headers:n})}}Gy=Me,Gl=new WeakMap,Um=new WeakSet,II=function(){return this.baseURL!=="https://api.openai.com/v1"};Me.OpenAI=Gy;Me.DEFAULT_TIMEOUT=6e5;Me.OpenAIError=we;Me.APIError=tr;Me.APIConnectionError=Cd;Me.APIConnectionTimeoutError=kd;Me.APIUserAbortError=zr;Me.NotFoundError=XC;Me.ConflictError=YC;Me.RateLimitError=ek;Me.BadRequestError=JC;Me.AuthenticationError=ZC;Me.InternalServerError=tk;Me.PermissionDeniedError=KC;Me.UnprocessableEntityError=QC;Me.InvalidWebhookSignatureError=ao;Me.toFile=Aq;Me.Completions=iI;Me.Chat=Ny;Me.Embeddings=cI;Me.Files=uI;Me.Images=gI;Me.Audio=Oc;Me.Moderations=_I;Me.Models=yI;Me.FineTuning=za;Me.Graders=Vy;Me.VectorStores=Dd;Me.Webhooks=kI;Me.Beta=Fa;Me.Batches=Xk;Me.Uploads=Hy;Me.Responses=Md;Me.Realtime=Ld;Me.Conversations=Dy;Me.Evals=By;Me.Containers=My;Me.Videos=AI;var Wy=class extends Bi{constructor(e){var n,s,i;super(e??{});p(this,"temperature");p(this,"topP");p(this,"frequencyPenalty");p(this,"presencePenalty");p(this,"n");p(this,"logitBias");p(this,"model","gpt-3.5-turbo");p(this,"modelKwargs");p(this,"stop");p(this,"stopSequences");p(this,"user");p(this,"timeout");p(this,"streaming",!1);p(this,"streamUsage",!0);p(this,"maxTokens");p(this,"logprobs");p(this,"topLogprobs");p(this,"apiKey");p(this,"organization");p(this,"__includeRawResponse");p(this,"client");p(this,"clientConfig");p(this,"supportsStrictToolCalling");p(this,"audio");p(this,"modalities");p(this,"reasoning");p(this,"zdrEnabled");p(this,"service_tier");p(this,"promptCacheKey");p(this,"verbosity");p(this,"defaultOptions");p(this,"lc_serializable",!0);const r=typeof((n=e==null?void 0:e.configuration)==null?void 0:n.apiKey)=="string"?(s=e==null?void 0:e.configuration)==null?void 0:s.apiKey:void 0;this.apiKey=(e==null?void 0:e.apiKey)??r??rn("OPENAI_API_KEY"),this.organization=((i=e==null?void 0:e.configuration)==null?void 0:i.organization)??rn("OPENAI_ORGANIZATION"),this.model=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoning=e==null?void 0:e.reasoning,this.maxTokens=(e==null?void 0:e.maxCompletionTokens)??(e==null?void 0:e.maxTokens),this.promptCacheKey=(e==null?void 0:e.promptCacheKey)??this.promptCacheKey,this.verbosity=(e==null?void 0:e.verbosity)??this.verbosity,this.disableStreaming=(e==null?void 0:e.disableStreaming)===!0,this.streaming=(e==null?void 0:e.streaming)===!0,this.disableStreaming&&(this.streaming=!1),(e==null?void 0:e.streaming)===!1&&(this.disableStreaming=!0),this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),(e==null?void 0:e.service_tier)!==void 0&&(this.service_tier=e.service_tier),this.zdrEnabled=(e==null?void 0:e.zdrEnabled)??!1}_llmType(){return"openai"}static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning","service_tier"]}get lc_secrets(){return{apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{apiKey:"openai_api_key",modelName:"model"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","model","modelName","modelKwargs","stop","stopSequences","timeout","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","zdrEnabled","reasoning","promptCacheKey","verbosity"]}getLsParams(e){const r=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:r.temperature??void 0,ls_max_tokens:r.max_tokens??void 0,ls_stop:e.stop}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}_getReasoningParams(e){if(!Cc(this.model))return;let r;return this.reasoning!==void 0&&(r={...r,...this.reasoning}),(e==null?void 0:e.reasoning)!==void 0&&(r={...r,...e.reasoning}),r}_getResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&tn(e.json_schema.schema)?HV(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}_combineCallOptions(e){return{...this.defaultOptions,...e??{}}}_getClientOptions(e){if(!this.client){const n={baseURL:this.clientConfig.baseURL},s=Iz(n),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new Me(i)}return{...this.clientConfig,...e}}_convertChatOpenAIToolToCompletionsTool(e,r){return Lu(e)?Dz(e.metadata.customTool):fd(e)?(r==null?void 0:r.strict)!==void 0?{...e,function:{...e.function,strict:r.strict}}:e:Rz(e,r)}bindTools(e,r){let n;return(r==null?void 0:r.strict)!==void 0?n=r.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this.withConfig({tools:e.map(s=>xy(s)||Lu(s)?s:this._convertChatOpenAIToolToCompletionsTool(s,{strict:n})),...r})}async stream(e,r){return super.stream(e,this._combineCallOptions(r))}async invoke(e,r){return super.invoke(e,this._combineCallOptions(r))}_combineLLMOutput(...e){return e.reduce((r,n)=>(n&&n.tokenUsage&&(r.tokenUsage.completionTokens+=n.tokenUsage.completionTokens??0,r.tokenUsage.promptTokens+=n.tokenUsage.promptTokens??0,r.tokenUsage.totalTokens+=n.tokenUsage.totalTokens??0),r),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}async getNumTokensFromMessages(e){let r=0,n=0,s=0;this.model==="gpt-3.5-turbo-0301"?(n=4,s=-1):(n=3,s=1);const i=await Promise.all(e.map(async a=>{var h,f,m,g,y,b;const o=await this.getNumTokens(a.content),c=await this.getNumTokens(kc(a)),l=a.name!==void 0?s+await this.getNumTokens(a.name):0;let u=o+n+c+l;const d=a;if(d._getType()==="function"&&(u-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(u+=3),(f=d==null?void 0:d.additional_kwargs.function_call)!=null&&f.name&&(u+=await this.getNumTokens((m=d.additional_kwargs.function_call)==null?void 0:m.name)),(g=d.additional_kwargs.function_call)!=null&&g.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse((y=d.additional_kwargs.function_call)==null?void 0:y.arguments)))}catch(_){console.error("Error parsing function arguments",_,JSON.stringify(d.additional_kwargs.function_call)),u+=await this.getNumTokens((b=d.additional_kwargs.function_call)==null?void 0:b.arguments)}return r+=u,u}));return r+=3,{totalCount:r,countPerMessage:i}}async _getNumTokensFromGenerations(e){return(await Promise.all(e.map(async n=>{var s;return(s=n.message.additional_kwargs)!=null&&s.function_call?(await this.getNumTokensFromMessages([n.message])).countPerMessage[0]:await this.getNumTokens(n.message.content)}))).reduce((n,s)=>n+s,0)}async _getEstimatedTokenCountFromPrompt(e,r,n){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(r&&n!=="auto"){const i=$z(r);s+=await this.getNumTokens(i),s+=9}return r&&e.find(i=>i._getType()==="system")&&(s-=4),n==="none"?s+=1:typeof n=="object"&&(s+=await this.getNumTokens(n.name)+4),s}_getStructuredOutputMethod(e){const r={...e};if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"){if((r==null?void 0:r.method)===void 0)return"jsonSchema"}else r.method==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`);return r.method}withStructuredOutput(e,r){let n,s;const{schema:i,name:a,includeRaw:o}={...r,schema:e};if((r==null?void 0:r.strict)!==void 0&&r.method==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");const c=VV(this.model,r==null?void 0:r.method);if(c==="jsonMode"){tn(i)?s=hu.fromZodSchema(i):s=new Lp;const h=ar(i);n=this.withConfig({outputVersion:"v0",response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"json_mode"},schema:{title:a??"extract",...h}}})}else if(c==="jsonSchema"){const h={name:a??"extract",description:Ri(i),schema:i,strict:r==null?void 0:r.strict},f=ar(h.schema);if(n=this.withConfig({outputVersion:"v0",response_format:{type:"json_schema",json_schema:h},ls_structured_output_format:{kwargs:{method:"json_schema"},schema:{title:h.name,description:h.description,...f}}}),tn(i)){const m=hu.fromZodSchema(i);s=Cn.from(g=>"parsed"in g.additional_kwargs?g.additional_kwargs.parsed:m)}else s=new Lp}else{let h=a??"extract";if(tn(i)){const f=ar(i);n=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:{name:h,description:f.description,parameters:f}}],tool_choice:{type:"function",function:{name:h}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:h,...f}},...(r==null?void 0:r.strict)!==void 0?{strict:r.strict}:{}}),s=new Up({returnSingle:!0,keyName:h,zodSchema:i})}else{let f;typeof i.name=="string"&&typeof i.parameters=="object"&&i.parameters!=null?(f=i,h=i.name):(h=i.title??h,f={name:h,description:i.description??"",parameters:i});const m=ar(i);n=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:f}],tool_choice:{type:"function",function:{name:h}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:h,...m}},...(r==null?void 0:r.strict)!==void 0?{strict:r.strict}:{}}),s=new Up({returnSingle:!0,keyName:h})}}if(!o)return n.pipe(s);const l=_s.assign({parsed:(h,f)=>s.invoke(h.raw,f)}),u=_s.assign({parsed:()=>null}),d=l.withFallbacks({fallbacks:[u]});return Zn.from([{raw:n},d])}};function fl(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function RI(t){if(!t||typeof t!="object")return t;let e;return t.constructor.name===kd.name&&"message"in t&&typeof t.message=="string"?(e=new Error(t.message),e.name="TimeoutError"):t.constructor.name===zr.name&&"message"in t&&typeof t.message=="string"?(e=new Error(t.message),e.name="AbortError"):"status"in t&&t.status===400&&"message"in t&&typeof t.message=="string"&&t.message.includes("tool_calls")?e=fl(t,"INVALID_TOOL_RESULTS"):"status"in t&&t.status===401?e=fl(t,"MODEL_AUTHENTICATION"):"status"in t&&t.status===429?e=fl(t,"MODEL_RATE_LIMIT"):"status"in t&&t.status===404?e=fl(t,"MODEL_NOT_FOUND"):e=t,e}function Fq(t){if(t.type==="image"){if(t.url)return{type:"image_url",image_url:{url:t.url}};if(t.data)return{type:"image_url",image_url:{url:`data:${t.mimeType};base64,${t.data}`}}}if(t.type==="audio"&&t.data){const e=Ai(()=>{const[,r]=t.mimeType.split("/");return r==="wav"||r==="mp3"?r:"wav"});return{type:"input_audio",input_audio:{data:t.data.toString(),format:e}}}if(t.type==="file"){if(t.data)return{type:"file",file:{file_data:t.data.toString()}};if(t.fileId)return{type:"file",file:{file_id:t.fileId}}}}function zq(t,e){let r=kc(t);if(r==="system"&&Cc(e)&&(r="developer"),r==="developer")return{role:"developer",content:t.contentBlocks.filter(s=>s.type==="text")};if(r==="system")return{role:"system",content:t.contentBlocks.filter(s=>s.type==="text")};if(r==="assistant")return{role:"assistant",content:t.contentBlocks.filter(s=>s.type==="text")};if(r==="tool"&&fr.isInstance(t))return{role:"tool",tool_call_id:t.tool_call_id,content:t.contentBlocks.filter(s=>s.type==="text")};if(r==="function")return{role:"function",name:t.name??"",content:t.contentBlocks.filter(s=>s.type==="text").join("")};function*n(s){for(const i of s){i.type==="text"&&(yield{type:"text",text:i.text});const a=Fq(i);a&&(yield a)}}return{role:"user",content:Array.from(n(t.contentBlocks))}}function Vq(t){var n;const e=ms(t)&&((n=t.response_metadata)==null?void 0:n.model_provider)==="openai";function*r(){const s=Ai(()=>{try{const _=kc(t);return _==="system"||_==="developer"||_==="assistant"||_==="user"?_:"assistant"}catch{return"assistant"}});let i;const a=new Set,o=new Set,c=new Map,l=new Map;function*u(){if(!i)return;const _=i.content;(typeof _=="string"&&_.length>0||Array.isArray(_)&&_.length>0)&&(yield i),i=void 0}const d=_=>{i||(i={type:"message",role:s,content:[]}),typeof i.content=="string"?i.content=i.content.length>0?[{type:"input_text",text:i.content},..._]:[..._]:i.content.push(..._)},h=_=>{if(typeof _=="string")return _;try{return JSON.stringify(_??{})}catch{return"{}"}},f=_=>{const E=Ai(()=>{var k;const C=(k=_.metadata)==null?void 0:k.detail;return C==="low"||C==="high"||C==="auto"?C:"auto"});if(_.fileId)return{type:"input_image",detail:E,file_id:_.fileId};if(_.url)return{type:"input_image",detail:E,image_url:_.url};if(_.data){const C=typeof _.data=="string"?_.data:er.from(_.data).toString("base64"),k=_.mimeType??"image/png";return{type:"input_image",detail:E,image_url:`data:${k};base64,${C}`}}},m=_=>{var C,k,R;const E=((C=_.metadata)==null?void 0:C.filename)??((k=_.metadata)==null?void 0:k.name)??((R=_.metadata)==null?void 0:R.title);if(_.fileId&&typeof E=="string")return{type:"input_file",file_id:_.fileId,...E?{filename:E}:{}};if(_.url&&typeof E=="string")return{type:"input_file",file_url:_.url,...E?{filename:E}:{}};if(_.data&&typeof E=="string"){const $=typeof _.data=="string"?_.data:er.from(_.data).toString("base64");return{type:"input_file",file_data:`data:${_.mimeType??"application/octet-stream"};base64,${$}`,...E?{filename:E}:{}}}},g=_=>{const E=Ai(()=>{if(Array.isArray(_.summary)){const R=_.summary,$=(R==null?void 0:R.map(S=>S==null?void 0:S.text).filter(S=>typeof S=="string"))??[];if($.length>0)return $}return _.reasoning?[_.reasoning]:[]}),C=E.length>0?E.map(R=>({type:"summary_text",text:R})):[{type:"summary_text",text:""}],k={type:"reasoning",id:_.id??"",summary:C};return _.reasoning&&(k.content=[{type:"reasoning_text",text:_.reasoning}]),k},y=_=>({type:"function_call",name:_.name??"",call_id:_.id??"",arguments:h(_.args)}),b=_=>{const E=h(_.output),C=_.status==="success"?"completed":_.status==="error"?"incomplete":void 0;return{type:"function_call_output",call_id:_.toolCallId??"",output:E,...C?{status:C}:{}}};for(const _ of t.contentBlocks)if(_.type==="text")d([{type:"input_text",text:_.text}]);else if(_.type!=="invalid_tool_call"){if(_.type==="reasoning")yield*u(),yield g(_);else if(_.type==="tool_call"){yield*u();const E=_.id??"";E&&(a.add(E),c.delete(E)),yield y(_)}else if(_.type==="tool_call_chunk"){if(_.id){const E=c.get(_.id)??{name:_.name,args:[]};_.name&&(E.name=_.name),_.args&&E.args.push(_.args),c.set(_.id,E)}}else if(_.type==="server_tool_call"){yield*u();const E=_.id??"";E&&(o.add(E),l.delete(E)),yield y(_)}else if(_.type==="server_tool_call_chunk"){if(_.id){const E=l.get(_.id)??{name:_.name,args:[]};_.name&&(E.name=_.name),_.args&&E.args.push(_.args),l.set(_.id,E)}}else if(_.type==="server_tool_call_result")yield*u(),yield b(_);else if(_.type!=="audio")if(_.type==="file"){const E=m(_);E&&d([E])}else if(_.type==="image"){const E=f(_);E&&d([E])}else if(_.type==="video"){const E=m(_);E&&d([E])}else _.type==="text-plain"?_.text&&d([{type:"input_text",text:_.text}]):_.type==="non_standard"&&e&&(yield*u(),yield _.value)}yield*u();for(const[_,E]of c){if(!_||a.has(_))continue;const C=E.args.join("");!E.name&&!C||(yield{type:"function_call",call_id:_,name:E.name??"",arguments:C})}for(const[_,E]of l){if(!_||o.has(_))continue;const C=E.args.join("");!E.name&&!C||(yield{type:"function_call",call_id:_,name:E.name??"",arguments:C})}}return Array.from(r())}const OI={providerName:"ChatOpenAI",fromStandardTextBlock(t){return{type:"text",text:t.text}},fromStandardImageBlock(t){var e,r;if(t.source_type==="url")return{type:"image_url",image_url:{url:t.url,...(e=t.metadata)!=null&&e.detail?{detail:t.metadata.detail}:{}}};if(t.source_type==="base64")return{type:"image_url",image_url:{url:`data:${t.mime_type??""};base64,${t.data}`,...(r=t.metadata)!=null&&r.detail?{detail:t.metadata.detail}:{}}};throw new Error(`Image content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(t){if(t.source_type==="url"){const e=Ci({dataUrl:t.url});if(!e)throw new Error(`URL audio blocks with source_type ${t.source_type} must be formatted as a data URL for ChatOpenAI`);const r=e.mime_type||t.mime_type||"";let n;try{n=mi(r)}catch{throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`)}if(n.type!=="audio"||n.subtype!=="wav"&&n.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:n.subtype,data:e.data}}}if(t.source_type==="base64"){let e;try{e=mi(t.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`)}if(e.type!=="audio"||e.subtype!=="wav"&&e.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:e.subtype,data:t.data}}}throw new Error(`Audio content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(t){var e,r,n,s,i,a,o,c,l,u;if(t.source_type==="url"){if(!Ci({dataUrl:t.url}))throw new Error(`URL file blocks with source_type ${t.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:t.url,...(e=t.metadata)!=null&&e.filename||(r=t.metadata)!=null&&r.name?{filename:((n=t.metadata)==null?void 0:n.filename)||((s=t.metadata)==null?void 0:s.name)}:{}}}}if(t.source_type==="base64")return{type:"file",file:{file_data:`data:${t.mime_type??""};base64,${t.data}`,...(i=t.metadata)!=null&&i.filename||(a=t.metadata)!=null&&a.name||(o=t.metadata)!=null&&o.title?{filename:((c=t.metadata)==null?void 0:c.filename)||((l=t.metadata)==null?void 0:l.name)||((u=t.metadata)==null?void 0:u.title)}:{}}};if(t.source_type==="id")return{type:"file",file:{file_id:t.id}};throw new Error(`File content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)}};function $v(t,e){return t.flatMap(r=>{var a,o;if("output_version"in r.response_metadata&&((a=r.response_metadata)==null?void 0:a.output_version)==="v1")return zq(r);let n=kc(r);n==="system"&&Cc(e)&&(n="developer");const s=typeof r.content=="string"?r.content:r.content.map(c=>Sn(c)?Xu(c,OI):c),i={role:n,content:s};if(r.name!=null&&(i.name=r.name),r.additional_kwargs.function_call!=null&&(i.function_call=r.additional_kwargs.function_call,i.content=""),ms(r)&&((o=r.tool_calls)!=null&&o.length)?(i.tool_calls=r.tool_calls.map(Gx),i.content=""):(r.additional_kwargs.tool_calls!=null&&(i.tool_calls=r.additional_kwargs.tool_calls),r.tool_call_id!=null&&(i.tool_call_id=r.tool_call_id)),r.additional_kwargs.audio&&typeof r.additional_kwargs.audio=="object"&&"id"in r.additional_kwargs.audio){const c={role:"assistant",audio:{id:r.additional_kwargs.audio.id}};return[i,c]}return i})}const Yi="__openai_function_call_ids__";var qq=class extends Wy{invocationParams(t){var s;let e;(t==null?void 0:t.strict)!==void 0?e=t.strict:this.supportsStrictToolCalling!==void 0&&(e=this.supportsStrictToolCalling);const r={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:t==null?void 0:t.previous_response_id,truncation:t==null?void 0:t.truncation,include:t==null?void 0:t.include,tools:(s=t==null?void 0:t.tools)!=null&&s.length?this._reduceChatOpenAITools(t.tools,{stream:this.streaming,strict:e}):void 0,tool_choice:Nz(t==null?void 0:t.tool_choice)?t==null?void 0:t.tool_choice:(()=>{const i=GC(t==null?void 0:t.tool_choice);if(typeof i=="object"&&"type"in i){if(i.type==="function")return{type:"function",name:i.function.name};if(i.type==="allowed_tools")return{type:"allowed_tools",mode:i.allowed_tools.mode,tools:i.allowed_tools.tools};if(i.type==="custom")return{type:"custom",name:i.custom.name}}})(),text:(()=>{if(t!=null&&t.text)return t.text;const i=this._getResponseFormat(t==null?void 0:t.response_format);return(i==null?void 0:i.type)==="json_schema"?i.json_schema.schema!=null?{format:{type:"json_schema",schema:i.json_schema.schema,description:i.json_schema.description,name:i.json_schema.name,strict:i.json_schema.strict},verbosity:t==null?void 0:t.verbosity}:void 0:{format:i,verbosity:t==null?void 0:t.verbosity}})(),parallel_tool_calls:t==null?void 0:t.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,prompt_cache_key:(t==null?void 0:t.promptCacheKey)??this.promptCacheKey,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},n=this._getReasoningParams(t);return n!==void 0&&(r.reasoning=n),r}async _generate(t,e){var n;const r=this.invocationParams(e);if(r.stream){const s=this._streamResponseChunks(t,e);let i;for await(const a of s)a.message.response_metadata={...a.generationInfo,...a.message.response_metadata},i=(i==null?void 0:i.concat(a))??a;return{generations:i?[i]:[],llmOutput:{estimatedTokenUsage:(n=i==null?void 0:i.message)==null?void 0:n.usage_metadata}}}else{const s=this._convertMessagesToResponsesParams(t),i=await this.completionWithRetry({input:s,...r,stream:!1},{signal:e==null?void 0:e.signal,...e==null?void 0:e.options});return{generations:[{text:i.output_text,message:this._convertResponsesMessageToBaseMessage(i)}],llmOutput:{id:i.id,estimatedTokenUsage:i.usage?{promptTokens:i.usage.input_tokens,completionTokens:i.usage.output_tokens,totalTokens:i.usage.total_tokens}:void 0}}}}async*_streamResponseChunks(t,e,r){const n=await this.completionWithRetry({...this.invocationParams(e),input:this._convertMessagesToResponsesParams(t),stream:!0},e);for await(const s of n){const i=this._convertResponsesDeltaToBaseMessageChunk(s);i!=null&&(yield i,await(r==null?void 0:r.handleLLMNewToken(i.text||"",{prompt:e.promptIndex??0,completion:0},void 0,void 0,void 0,{chunk:i})))}}async completionWithRetry(t,e){return this.caller.call(async()=>{var n,s;const r=this._getClientOptions(e);try{return((s=(n=t.text)==null?void 0:n.format)==null?void 0:s.type)==="json_schema"&&!t.stream?await this.client.responses.parse(t,r):await this.client.responses.create(t,r)}catch(i){throw RI(i)}})}_convertResponsesMessageToBaseMessage(t){if(t.error){const o=new Error(t.error.message);throw o.name=t.error.code,o}let e;const r=[],n=[],s=[],i={model_provider:"openai",model:t.model,created_at:t.created_at,id:t.id,incomplete_details:t.incomplete_details,metadata:t.metadata,object:t.object,status:t.status,user:t.user,service_tier:t.service_tier,model_name:t.model},a={};for(const o of t.output)if(o.type==="message")e=o.id,r.push(...o.content.flatMap(c=>c.type==="output_text"?("parsed"in c&&c.parsed!=null&&(a.parsed=c.parsed),{type:"text",text:c.text,annotations:c.annotations}):c.type==="refusal"?(a.refusal=c.refusal,[]):c));else if(o.type==="function_call"){const c={function:{name:o.name,arguments:o.arguments},id:o.call_id};try{n.push(md(c,{returnId:!0}))}catch(l){let u;typeof l=="object"&&l!=null&&"message"in l&&typeof l.message=="string"&&(u=l.message),s.push(fu(c,u))}a[Yi]??(a[Yi]={}),o.id&&(a[Yi][o.call_id]=o.id)}else if(o.type==="reasoning")a.reasoning=o;else if(o.type==="custom_tool_call"){const c=Pz(o);c?n.push(c):s.push(fu(o,"Malformed custom tool call"))}else a.tool_outputs??(a.tool_outputs=[]),a.tool_outputs.push(o);return new ht({id:e,content:r,tool_calls:n,invalid_tool_calls:s,usage_metadata:nv(t.usage),additional_kwargs:a,response_metadata:i})}_convertResponsesDeltaToBaseMessageChunk(t){var c,l;const e=[];let r={},n;const s=[],i={model_provider:"openai"},a={};let o;if(t.type==="response.output_text.delta")e.push({type:"text",text:t.delta,index:t.content_index});else if(t.type==="response.output_text.annotation.added")e.push({type:"text",text:"",annotations:[t.annotation],index:t.content_index});else if(t.type==="response.output_item.added"&&t.item.type==="message")o=t.item.id;else if(t.type==="response.output_item.added"&&t.item.type==="function_call")s.push({type:"tool_call_chunk",name:t.item.name,args:t.item.arguments,id:t.item.call_id,index:t.output_index}),a[Yi]={[t.item.call_id]:t.item.id};else if(t.type==="response.output_item.done"&&["web_search_call","file_search_call","computer_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","image_generation_call","custom_tool_call"].includes(t.item.type))a.tool_outputs=[t.item];else if(t.type==="response.created")i.id=t.response.id,i.model_name=t.response.model,i.model=t.response.model;else if(t.type==="response.completed"){const u=this._convertResponsesMessageToBaseMessage(t.response);n=nv(t.response.usage),((l=(c=t.response.text)==null?void 0:c.format)==null?void 0:l.type)==="json_schema"&&(a.parsed??(a.parsed=JSON.parse(u.text)));for(const[d,h]of Object.entries(t.response))d!=="id"&&(i[d]=h)}else if(t.type==="response.function_call_arguments.delta"||t.type==="response.custom_tool_call_input.delta")s.push({type:"tool_call_chunk",args:t.delta,index:t.output_index});else if(t.type==="response.web_search_call.completed"||t.type==="response.file_search_call.completed")r={tool_outputs:{id:t.item_id,type:t.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(t.type==="response.refusal.done")a.refusal=t.refusal;else if(t.type==="response.output_item.added"&&"item"in t&&t.item.type==="reasoning"){const u=t.item.summary?t.item.summary.map((d,h)=>({...d,index:h})):void 0;a.reasoning={id:t.item.id,type:t.item.type,...u?{summary:u}:{}}}else if(t.type==="response.reasoning_summary_part.added")a.reasoning={type:"reasoning",summary:[{...t.part,index:t.summary_index}]};else if(t.type==="response.reasoning_summary_text.delta")a.reasoning={type:"reasoning",summary:[{text:t.delta,type:"summary_text",index:t.summary_index}]};else return t.type==="response.image_generation_call.partial_image",null;return new mr({text:e.map(u=>u.text).join(""),message:new At({id:o,content:e,tool_call_chunks:s,usage_metadata:n,additional_kwargs:a,response_metadata:i}),generationInfo:r})}_convertMessagesToResponsesParams(t){return t.flatMap(e=>{var i,a,o,c;const r=e.response_metadata;if((r==null?void 0:r.output_version)==="v1")return Vq(e);const n=e.additional_kwargs;let s=kc(e);if(s==="system"&&Cc(this.model)&&(s="developer"),s==="function")throw new Error("Function messages are not supported in Responses API");if(s==="tool"){const l=e;return(n==null?void 0:n.type)==="computer_call_output"?{type:"computer_call_output",output:(()=>{if(typeof l.content=="string")return{type:"computer_screenshot",image_url:l.content};if(Array.isArray(l.content)){const d=l.content.find(f=>f.type==="computer_screenshot");if(d)return d;const h=l.content.find(f=>f.type==="image_url");if(h)return{type:"computer_screenshot",image_url:typeof h.image_url=="string"?h.image_url:h.image_url.url}}throw new Error("Invalid computer call output")})(),call_id:l.tool_call_id}:(i=l.additional_kwargs)!=null&&i.customTool?{type:"custom_tool_call_output",call_id:l.tool_call_id,output:l.content}:{type:"function_call_output",call_id:l.tool_call_id,id:(a=l.id)!=null&&a.startsWith("fc_")?l.id:void 0,output:typeof l.content!="string"?JSON.stringify(l.content):l.content}}if(s==="assistant"){if(!this.zdrEnabled&&(r==null?void 0:r.output)!=null&&Array.isArray(r==null?void 0:r.output)&&(r==null?void 0:r.output.length)>0&&(r!=null&&r.output.every(m=>"type"in m)))return r==null?void 0:r.output;const l=[];if(n!=null&&n.reasoning&&!this.zdrEnabled){const m=this._convertReasoningSummary(n.reasoning);l.push(m)}let{content:u}=e;n!=null&&n.refusal&&(typeof u=="string"&&(u=[{type:"output_text",text:u,annotations:[]}]),u=[...u,{type:"refusal",refusal:n.refusal}]),(typeof u=="string"||u.length>0)&&l.push({type:"message",role:"assistant",...e.id&&!this.zdrEnabled&&e.id.startsWith("msg_")?{id:e.id}:{},content:Ai(()=>typeof u=="string"?u:u.flatMap(m=>m.type==="text"?{type:"output_text",text:m.text,annotations:m.annotations??[]}:m.type==="output_text"||m.type==="refusal"?m:[]))});const d=n==null?void 0:n[Yi];ms(e)&&((o=e.tool_calls)!=null&&o.length)?l.push(...e.tool_calls.map(m=>Lz(m)?{type:"custom_tool_call",id:m.call_id,call_id:m.id??"",input:m.args.input,name:m.name}:{type:"function_call",name:m.name,arguments:JSON.stringify(m.args),call_id:m.id,...this.zdrEnabled?{id:d==null?void 0:d[m.id]}:{}})):n!=null&&n.tool_calls&&l.push(...n.tool_calls.map(m=>({type:"function_call",name:m.function.name,call_id:m.id,arguments:m.function.arguments,...this.zdrEnabled?{id:d==null?void 0:d[m.id]}:{}})));const h=(c=r==null?void 0:r.output)!=null&&c.length?r==null?void 0:r.output:n.tool_outputs,f=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(h!=null){const m=h,g=m==null?void 0:m.filter(y=>f.includes(y.type));g.length>0&&l.push(...g)}return l}if(s==="user"||s==="system"||s==="developer"){if(typeof e.content=="string")return{type:"message",role:s,content:e.content};const l=[],u=e.content.flatMap(d=>{if(d.type==="mcp_approval_response"&&l.push({type:"mcp_approval_response",approval_request_id:d.approval_request_id,approve:d.approve}),Sn(d))return Xu(d,OI);if(d.type==="text")return{type:"input_text",text:d.text};if(d.type==="image_url"){const h=Ai(()=>{if(typeof d.image_url=="string")return d.image_url;if(typeof d.image_url=="object"&&d.image_url!==null&&"url"in d.image_url)return d.image_url.url}),f=Ai(()=>{if(typeof d.image_url=="string")return"auto";if(typeof d.image_url=="object"&&d.image_url!==null&&"detail"in d.image_url)return d.image_url.detail});return{type:"input_image",image_url:h,detail:f}}return d.type==="input_text"||d.type==="input_image"||d.type==="input_file"?d:[]});return u.length>0&&l.push({type:"message",role:s,content:u}),l}return console.warn(`Unsupported role found when converting to OpenAI Responses API: ${s}`),[]})}_convertReasoningSummary(t){const e=(t.summary.length>1?t.summary.reduce((r,n)=>{const s=r[r.length-1];return s.index===n.index?s.text+=n.text:r.push(n),r},[{...t.summary[0]}]):t.summary).map(r=>Object.fromEntries(Object.entries(r).filter(([n])=>n!=="index")));return{...t,summary:e}}_reduceChatOpenAITools(t,e){const r=[];for(const n of t)if(xy(n))n.type==="image_generation"&&(e!=null&&e.stream)&&(n.partial_images=1),r.push(n);else if(Lu(n)){const s=n.metadata.customTool;r.push({type:"custom",name:s.name,description:s.description,format:s.format})}else fd(n)?r.push({type:"function",name:n.function.name,parameters:n.function.parameters,description:n.function.description,strict:(e==null?void 0:e.strict)??null}):WC(n)&&r.push(Mz(n));return r}},Hq=class extends Wy{invocationParams(t,e){var a;let r;(t==null?void 0:t.strict)!==void 0?r=t.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling);let n={};(t==null?void 0:t.stream_options)!==void 0?n={stream_options:t.stream_options}:this.streamUsage&&(this.streaming||e!=null&&e.streaming)&&(n={stream_options:{include_usage:!0}});const s={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(t==null?void 0:t.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:t==null?void 0:t.functions,function_call:t==null?void 0:t.function_call,tools:(a=t==null?void 0:t.tools)!=null&&a.length?t.tools.map(o=>this._convertChatOpenAIToolToCompletionsTool(o,{strict:r})):void 0,tool_choice:GC(t==null?void 0:t.tool_choice),response_format:this._getResponseFormat(t==null?void 0:t.response_format),seed:t==null?void 0:t.seed,...n,parallel_tool_calls:t==null?void 0:t.parallel_tool_calls,...this.audio||t!=null&&t.audio?{audio:this.audio||(t==null?void 0:t.audio)}:{},...this.modalities||t!=null&&t.modalities?{modalities:this.modalities||(t==null?void 0:t.modalities)}:{},...this.modelKwargs,prompt_cache_key:(t==null?void 0:t.promptCacheKey)??this.promptCacheKey,verbosity:(t==null?void 0:t.verbosity)??this.verbosity};(t==null?void 0:t.prediction)!==void 0&&(s.prediction=t.prediction),this.service_tier!==void 0&&(s.service_tier=this.service_tier),(t==null?void 0:t.service_tier)!==void 0&&(s.service_tier=t.service_tier);const i=this._getReasoningParams(t);return i!==void 0&&i.effort!==void 0&&(s.reasoning_effort=i.effort),Cc(s.model)?s.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:s.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,s}async _generate(t,e,r){var a,o;const n={},s=this.invocationParams(e),i=$v(t,this.model);if(s.stream){const c=this._streamResponseChunks(t,e,r),l={};for await(const g of c){g.message.response_metadata={...g.generationInfo,...g.message.response_metadata};const y=((a=g.generationInfo)==null?void 0:a.completion)??0;l[y]===void 0?l[y]=g:l[y]=l[y].concat(g)}const u=Object.entries(l).sort(([g],[y])=>parseInt(g,10)-parseInt(y,10)).map(([g,y])=>y),{functions:d,function_call:h}=this.invocationParams(e),f=await this._getEstimatedTokenCountFromPrompt(t,d,h),m=await this._getNumTokensFromGenerations(u);return n.input_tokens=f,n.output_tokens=m,n.total_tokens=f+m,{generations:u,llmOutput:{estimatedTokenUsage:{promptTokens:n.input_tokens,completionTokens:n.output_tokens,totalTokens:n.total_tokens}}}}else{const c=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:e==null?void 0:e.signal,...e==null?void 0:e.options}),{completion_tokens:l,prompt_tokens:u,total_tokens:d,prompt_tokens_details:h,completion_tokens_details:f}=(c==null?void 0:c.usage)??{};l&&(n.output_tokens=(n.output_tokens??0)+l),u&&(n.input_tokens=(n.input_tokens??0)+u),d&&(n.total_tokens=(n.total_tokens??0)+d),((h==null?void 0:h.audio_tokens)!==null||(h==null?void 0:h.cached_tokens)!==null)&&(n.input_token_details={...(h==null?void 0:h.audio_tokens)!==null&&{audio:h==null?void 0:h.audio_tokens},...(h==null?void 0:h.cached_tokens)!==null&&{cache_read:h==null?void 0:h.cached_tokens}}),((f==null?void 0:f.audio_tokens)!==null||(f==null?void 0:f.reasoning_tokens)!==null)&&(n.output_token_details={...(f==null?void 0:f.audio_tokens)!==null&&{audio:f==null?void 0:f.audio_tokens},...(f==null?void 0:f.reasoning_tokens)!==null&&{reasoning:f==null?void 0:f.reasoning_tokens}});const m=[];for(const g of(c==null?void 0:c.choices)??[]){const b={text:((o=g.message)==null?void 0:o.content)??"",message:this._convertCompletionsMessageToBaseMessage(g.message??{role:"assistant"},c)};b.generationInfo={...g.finish_reason?{finish_reason:g.finish_reason}:{},...g.logprobs?{logprobs:g.logprobs}:{}},ms(b.message)&&(b.message.usage_metadata=n),b.message=new ht(Object.fromEntries(Object.entries(b.message).filter(([_])=>!_.startsWith("lc_")))),m.push(b)}return{generations:m,llmOutput:{tokenUsage:{promptTokens:n.input_tokens,completionTokens:n.output_tokens,totalTokens:n.total_tokens}}}}}async*_streamResponseChunks(t,e,r){var c,l,u,d,h,f,m,g,y,b;const n=$v(t,this.model),s={...this.invocationParams(e,{streaming:!0}),messages:n,stream:!0};let i;const a=await this.completionWithRetry(s,e);let o;for await(const _ of a){const E=(c=_==null?void 0:_.choices)==null?void 0:c[0];if(_.usage&&(o=_.usage),!E)continue;const{delta:C}=E;if(!C)continue;const k=this._convertCompletionsDeltaToBaseMessageChunk(C,_,i);i=C.role??i;const R={prompt:e.promptIndex??0,completion:E.index??0};if(typeof k.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const $={...R};E.finish_reason!=null&&($.finish_reason=E.finish_reason,$.system_fingerprint=_.system_fingerprint,$.model_name=_.model,$.service_tier=_.service_tier),this.logprobs&&($.logprobs=E.logprobs);const S=new mr({message:k,text:k.content,generationInfo:$});yield S,await(r==null?void 0:r.handleLLMNewToken(S.text??"",R,void 0,void 0,void 0,{chunk:S}))}if(o){const _={...((l=o.prompt_tokens_details)==null?void 0:l.audio_tokens)!==null&&{audio:(u=o.prompt_tokens_details)==null?void 0:u.audio_tokens},...((d=o.prompt_tokens_details)==null?void 0:d.cached_tokens)!==null&&{cache_read:(h=o.prompt_tokens_details)==null?void 0:h.cached_tokens}},E={...((f=o.completion_tokens_details)==null?void 0:f.audio_tokens)!==null&&{audio:(m=o.completion_tokens_details)==null?void 0:m.audio_tokens},...((g=o.completion_tokens_details)==null?void 0:g.reasoning_tokens)!==null&&{reasoning:(y=o.completion_tokens_details)==null?void 0:y.reasoning_tokens}};yield new mr({message:new At({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(_).length>0&&{input_token_details:_},...Object.keys(E).length>0&&{output_token_details:E}}}),text:""})}if((b=e.signal)!=null&&b.aborted)throw new Error("AbortError")}async completionWithRetry(t,e){const r=this._getClientOptions(e),n=t.response_format&&t.response_format.type==="json_schema";return this.caller.call(async()=>{try{return n&&!t.stream?await this.client.chat.completions.parse(t,r):await this.client.chat.completions.create(t,r)}catch(s){throw RI(s)}})}_convertCompletionsMessageToBaseMessage(t,e){var n,s;const r=t.tool_calls;switch(t.role){case"assistant":{const i=[],a=[];for(const u of r??[])try{i.push(md(u,{returnId:!0}))}catch(d){a.push(fu(u,d.message))}const o={function_call:t.function_call,tool_calls:r};this.__includeRawResponse!==void 0&&(o.__raw_response=e);const c={model_provider:"openai",model_name:e.model,...e.system_fingerprint?{usage:{...e.usage},system_fingerprint:e.system_fingerprint}:{}};t.audio&&(o.audio=t.audio);const l=GV(t.content||"",(s=(n=e.choices)==null?void 0:n[0])==null?void 0:s.message);return new ht({content:l,tool_calls:i,invalid_tool_calls:a,additional_kwargs:o,response_metadata:c,id:e.id})}default:return new Kn(t.content||"",t.role??"unknown")}}_convertCompletionsDeltaToBaseMessageChunk(t,e,r){var o,c;const n=t.role??r,s=t.content??"";let i;t.function_call?i={function_call:t.function_call}:t.tool_calls?i={tool_calls:t.tool_calls}:i={},this.__includeRawResponse&&(i.__raw_response=e),t.audio&&(i.audio={...t.audio,index:e.choices[0].index});const a={model_provider:"openai",usage:{...e.usage}};if(n==="user")return new fc({content:s,response_metadata:a});if(n==="assistant"){const l=[];if(Array.isArray(t.tool_calls))for(const u of t.tool_calls)l.push({name:(o=u.function)==null?void 0:o.name,args:(c=u.function)==null?void 0:c.arguments,id:u.id,index:u.index,type:"tool_call_chunk"});return new At({content:s,tool_call_chunks:l,additional_kwargs:i,id:e.id,response_metadata:a})}else return n==="system"?new qs({content:s,response_metadata:a}):n==="developer"?new qs({content:s,response_metadata:a,additional_kwargs:{__openai_role__:"developer"}}):n==="function"?new hc({content:s,additional_kwargs:i,name:t.name,response_metadata:a}):n==="tool"?new lc({content:s,additional_kwargs:i,tool_call_id:t.tool_call_id,response_metadata:a}):new dc({content:s,role:n,response_metadata:a})}},Gq=class $I extends Wy{constructor(r){super(r);p(this,"useResponsesApi",!1);p(this,"responses");p(this,"completions");this.fields=r,this.useResponsesApi=(r==null?void 0:r.useResponsesApi)??!1,this.responses=(r==null?void 0:r.responses)??new qq(r),this.completions=(r==null?void 0:r.completions)??new Hq(r)}get lc_serializable_keys(){return[...super.lc_serializable_keys,"useResponsesApi"]}get callKeys(){return[...super.callKeys,"useResponsesApi"]}_useResponsesApi(r){var a,o,c,l,u;const n=(a=r==null?void 0:r.tools)==null?void 0:a.some(xy),s=(r==null?void 0:r.previous_response_id)!=null||(r==null?void 0:r.text)!=null||(r==null?void 0:r.truncation)!=null||(r==null?void 0:r.include)!=null||((o=r==null?void 0:r.reasoning)==null?void 0:o.summary)!=null||((c=this.reasoning)==null?void 0:c.summary)!=null,i=((l=r==null?void 0:r.tools)==null?void 0:l.some(WC))||((u=r==null?void 0:r.tools)==null?void 0:u.some(Lu));return this.useResponsesApi||n||s||i}getLsParams(r){const n=this._combineCallOptions(r);return this._useResponsesApi(r)?this.responses.getLsParams(n):this.completions.getLsParams(n)}invocationParams(r){const n=this._combineCallOptions(r);return this._useResponsesApi(r)?this.responses.invocationParams(n):this.completions.invocationParams(n)}async _generate(r,n,s){return this._useResponsesApi(n)?this.responses._generate(r,n):this.completions._generate(r,n,s)}async*_streamResponseChunks(r,n,s){if(this._useResponsesApi(n)){yield*this.responses._streamResponseChunks(r,this._combineCallOptions(n),s);return}yield*this.completions._streamResponseChunks(r,this._combineCallOptions(n),s)}withConfig(r){const n=new $I(this.fields);return n.defaultOptions={...this.defaultOptions,...r},n}};const Wq={model_main:{assets:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:64e3,reasoning_budget:{1:24e3,2:48e3,3:63999}},flows:{id:"global.anthropic.claude-sonnet-4-5-20250929-v1:0",max_tokens:64e3,reasoning_budget:{1:24e3,2:48e3,3:64e3}},threats:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:64e3,reasoning_budget:{1:24e3,2:48e3,3:63999}},threats_agent:{id:"global.anthropic.claude-sonnet-4-5-20250929-v1:0",max_tokens:64e3,reasoning_budget:{1:24e3,2:48e3,3:63999}},gaps:{id:"global.anthropic.claude-sonnet-4-5-20250929-v1:0",max_tokens:64e3,reasoning_budget:{1:24e3,2:48e3,3:63999}}},model_summary:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:4e3},model_struct:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:64e3},reasoning_models:["global.anthropic.claude-haiku-4-5-20251001-v1:0","anthropic.claude-3-5-haiku-20241022-v1:0","global.anthropic.claude-sonnet-4-5-20250929-v1:0"]},Jq={openai_model_main:{assets:{id:"gpt-5-mini-2025-08-07",max_tokens:64e3,reasoning_effort:{0:"low",1:"medium",2:"high",3:"high"}},flows:{id:"gpt-5-2025-08-07",max_tokens:64e3,reasoning_effort:{0:"minimal",1:"low",2:"medium",3:"high"}},threats:{id:"gpt-5-mini-2025-08-07",max_tokens:128e3,reasoning_effort:{0:"minimal",1:"low",2:"medium",3:"high"}},threats_agent:{id:"gpt-5-2025-08-07",max_tokens:128e3,reasoning_effort:{0:"minimal",1:"low",2:"medium",3:"high"}},gaps:{id:"gpt-5-2025-08-07",max_tokens:64e3,reasoning_effort:{0:"minimal",1:"low",2:"medium",3:"high"}}},openai_model_summary:{id:"gpt-5-mini-2025-08-07",max_tokens:4e3},openai_model_struct:{id:"gpt-5-mini-2025-08-07",max_tokens:64e3},openai_reasoning_models:["gpt-5-2025-08-07","gpt-5-mini-2025-08-07"]};function Nv(t,e="bedrock"){if(!t||typeof t!="object")throw new Error("Configuration must be a valid object");if(e!=="bedrock"&&e!=="openai")throw new Error(`Invalid provider: ${e}. Must be 'bedrock' or 'openai'`);return e==="bedrock"?Zq(t):Kq(t)}function Zq(t){if(!t.model_main)throw new Error("Configuration missing model_main");if(typeof t.model_main!="object")throw new Error("Configuration model_main must be an object");const e=["assets","flows","threats","gaps"];for(const r of e)Xq(t.model_main,r);if(Pv(t,"model_summary"),Pv(t,"model_struct"),!Array.isArray(t.reasoning_models))throw new Error("Configuration reasoning_models must be an array");return!0}function Kq(t){if(!t.openai_model_main)throw new Error("Configuration missing openai_model_main");if(typeof t.openai_model_main!="object")throw new Error("Configuration openai_model_main must be an object");const e=["assets","flows","threats","gaps"];for(const r of e)Yq(t.openai_model_main,r,t.openai_reasoning_models);if(Lv(t,"openai_model_summary",t.openai_reasoning_models),Lv(t,"openai_model_struct",t.openai_reasoning_models),!Array.isArray(t.openai_reasoning_models))throw new Error("Configuration openai_reasoning_models must be an array");return!0}function Xq(t,e){if(!t[e])throw new Error(`Configuration missing model_main.${e}`);const r=t[e];if(typeof r!="object")throw new Error(`Configuration model_main.${e} must be an object`);if(!r.id)throw new Error(`Configuration missing model_main.${e}.id`);if(typeof r.id!="string"||r.id.trim()==="")throw new Error(`Configuration model_main.${e}.id must be a non-empty string`);if(typeof r.max_tokens!="number")throw new Error(`Configuration model_main.${e}.max_tokens must be a number`);if(r.max_tokens<=0||!Number.isInteger(r.max_tokens))throw new Error(`Configuration model_main.${e}.max_tokens must be a positive integer`);if(!r.reasoning_budget)throw new Error(`Configuration missing model_main.${e}.reasoning_budget`);if(typeof r.reasoning_budget!="object")throw new Error(`Configuration model_main.${e}.reasoning_budget must be an object`);const n=["1","2","3"];for(const s of n){if(!(s in r.reasoning_budget))throw new Error(`Configuration missing model_main.${e}.reasoning_budget["${s}"]`);const i=r.reasoning_budget[s];if(typeof i!="number")throw new Error(`Configuration model_main.${e}.reasoning_budget["${s}"] must be a number`);if(i<=0||!Number.isInteger(i))throw new Error(`Configuration model_main.${e}.reasoning_budget["${s}"] must be a positive integer`)}}function Yq(t,e,r=[]){if(!t[e])throw new Error(`Configuration missing openai_model_main.${e}`);const n=t[e];if(typeof n!="object")throw new Error(`Configuration openai_model_main.${e} must be an object`);if(!n.id)throw new Error(`Configuration missing openai_model_main.${e}.id`);if(typeof n.id!="string"||n.id.trim()==="")throw new Error(`Configuration openai_model_main.${e}.id must be a non-empty string`);if(!n.id.startsWith("gpt-5"))throw new Error(`Configuration openai_model_main.${e}.id must be a GPT-5 family model (e.g., gpt-5-2025-08-07 or gpt-5-mini-2025-08-07)`);if(typeof n.max_tokens!="number")throw new Error(`Configuration openai_model_main.${e}.max_tokens must be a number`);if(n.max_tokens<=0||!Number.isInteger(n.max_tokens))throw new Error(`Configuration openai_model_main.${e}.max_tokens must be a positive integer`);const s=128e3;if(n.max_tokens>s)throw new Error(`Configuration openai_model_main.${e}.max_tokens exceeds maximum allowed (${s})`);if(n.reasoning_budget)throw new Error(`Configuration openai_model_main.${e} should not contain reasoning_budget (OpenAI uses reasoning_effort parameter)`)}function Pv(t,e){if(!t[e])throw new Error(`Configuration missing ${e}`);const r=t[e];if(typeof r!="object")throw new Error(`Configuration ${e} must be an object`);if(!r.id)throw new Error(`Configuration missing ${e}.id`);if(typeof r.id!="string"||r.id.trim()==="")throw new Error(`Configuration ${e}.id must be a non-empty string`);if(typeof r.max_tokens!="number")throw new Error(`Configuration ${e}.max_tokens must be a number`);if(r.max_tokens<=0||!Number.isInteger(r.max_tokens))throw new Error(`Configuration ${e}.max_tokens must be a positive integer`)}function Lv(t,e,r=[]){if(!t[e])throw new Error(`Configuration missing ${e}`);const n=t[e];if(typeof n!="object")throw new Error(`Configuration ${e} must be an object`);if(!n.id)throw new Error(`Configuration missing ${e}.id`);if(typeof n.id!="string"||n.id.trim()==="")throw new Error(`Configuration ${e}.id must be a non-empty string`);if(!n.id.startsWith("gpt-5"))throw new Error(`Configuration ${e}.id must be a GPT-5 family model (e.g., gpt-5-2025-08-07 or gpt-5-mini-2025-08-07)`);if(typeof n.max_tokens!="number")throw new Error(`Configuration ${e}.max_tokens must be a number`);if(n.max_tokens<=0||!Number.isInteger(n.max_tokens))throw new Error(`Configuration ${e}.max_tokens must be a positive integer`);const s=128e3;if(n.max_tokens>s)throw new Error(`Configuration ${e}.max_tokens exceeds maximum allowed (${s})`);if(n.reasoning_budget)throw new Error(`Configuration ${e} should not contain reasoning_budget (OpenAI uses reasoning_effort parameter)`)}const oc={VALIDATION_ERROR:{code:400,message:"Validation failed"},UNAUTHORIZED:{code:401,message:"Unauthorized access"},NOT_FOUND:{code:404,message:"Resource not found"},CREDENTIALS_ERROR:{code:401,message:"Invalid credentials"},MODEL_ERROR:{code:422,message:"Model invocation failed"},INTERNAL_ERROR:{code:500,message:"Internal server error"},OPENAI_AUTH_ERROR:{code:401,message:"OpenAI authentication failed"},OPENAI_RATE_LIMIT_ERROR:{code:429,message:"OpenAI rate limit exceeded"},MODEL_PROVIDER_ERROR:{code:422,message:"Model provider error"}};class Ct extends Error{constructor(e,r,n=null){var s;super(r),this.name="ThreatModelingError",this.type=e,this.statusCode=((s=oc[e])==null?void 0:s.code)||500,this.jobId=n,Error.captureStackTrace&&Error.captureStackTrace(this,Ct)}toResponse(){var e;return{error:((e=oc[this.type])==null?void 0:e.message)||"Unknown error",message:this.message,job_id:this.jobId}}toFetchError(){return{response:{status:this.statusCode,data:this.toResponse()}}}}function Xn(t){return async function(...e){try{return await t(...e)}catch(r){throw r instanceof Ct?r.toFetchError():r.response&&r.response.status&&r.response.data?r:new Ct("INTERNAL_ERROR",r.message||"An unexpected error occurred",null).toFetchError()}}}function bs(t,e){const r=e.filter(n=>t[n]===void 0||t[n]===null);if(r.length>0)throw new Ct("VALIDATION_ERROR",`Missing required parameters: ${r.join(", ")}`,t.id||null)}function Qq(t){if(!t)throw new Ct("CREDENTIALS_ERROR","AWS credentials not configured",null);if(!t.accessKeyId||!t.secretAccessKey)throw new Ct("CREDENTIALS_ERROR","Invalid AWS credentials: missing accessKeyId or secretAccessKey",null);if(!t.region)throw new Ct("CREDENTIALS_ERROR","AWS region not configured",null)}class Ys extends Error{constructor(e="OpenAI API authentication failed. Please check your API key."){super(e),this.name="OpenAIAuthenticationError",this.type="OPENAI_AUTH_ERROR",this.statusCode=401,Error.captureStackTrace&&Error.captureStackTrace(this,Ys)}toResponse(){return{error:oc.OPENAI_AUTH_ERROR.message,message:this.message}}toFetchError(){return{response:{status:this.statusCode,data:this.toResponse()}}}}class Va extends Error{constructor(e="OpenAI rate limit exceeded. Please try again later or check your quota."){super(e),this.name="OpenAIRateLimitError",this.type="OPENAI_RATE_LIMIT_ERROR",this.statusCode=429,Error.captureStackTrace&&Error.captureStackTrace(this,Va)}toResponse(){return{error:oc.OPENAI_RATE_LIMIT_ERROR.message,message:this.message}}toFetchError(){return{response:{status:this.statusCode,data:this.toResponse()}}}}class Kt extends Error{constructor(e,r="unknown"){super(e),this.name="ModelProviderError",this.type="MODEL_PROVIDER_ERROR",this.statusCode=422,this.provider=r,Error.captureStackTrace&&Error.captureStackTrace(this,Kt)}toResponse(){return{error:oc.MODEL_PROVIDER_ERROR.message,message:this.message,provider:this.provider}}toFetchError(){return{response:{status:this.statusCode,data:this.toResponse()}}}}function Jy(t,e="unknown"){var s;const r=((s=t.message)==null?void 0:s.toLowerCase())||"",n=t.toString().toLowerCase();return e==="openai"?r.includes("authentication")||r.includes("api_key")||r.includes("api key")||r.includes("unauthorized")||r.includes("invalid api key")||n.includes("401")?new Ys("OpenAI API authentication failed. Please verify your API key is correct and active."):r.includes("rate_limit")||r.includes("rate limit")||r.includes("quota")||r.includes("too many requests")||n.includes("429")?new Va("OpenAI rate limit exceeded. Please wait a moment and try again, or check your account quota."):new Kt(`OpenAI API error: ${t.message}`,"openai"):e==="bedrock"?r.includes("credentials")||r.includes("access denied")||r.includes("unauthorized")?new Ct("CREDENTIALS_ERROR",`Amazon Bedrock authentication failed: ${t.message}`,null):new Kt(`Amazon Bedrock error: ${t.message}`,"bedrock"):new Kt(`Model provider error: ${t.message}`,e)}const NI=0;function Xa(t,e,r,n,s){const i=t.id,a=t.max_tokens,o={model:i,region:n.region,credentials:{accessKeyId:n.accessKeyId,secretAccessKey:n.secretAccessKey},maxTokens:a};if(n.sessionToken&&n.sessionToken.trim()&&(o.credentials.sessionToken=n.sessionToken.trim()),e>0&&r.includes(i)){const l=t.reasoning_budget[e.toString()];l?(o.additionalModelRequestFields={thinking:{type:"enabled",budget_tokens:l},anthropic_beta:["interleaved-thinking-2025-05-14"]},console.log(`Reasoning enabled for ${s}: budget=${l}, model=${i}`)):console.warn(`No reasoning budget defined for ${s} at level ${e}, using default`)}else o.temperature=NI,e>0&&console.warn(`Reasoning requested for ${s} but model ${i} does not support it`);return new qC(o)}function Mv(t,e,r){const n={model:t.id,region:e.region,credentials:{accessKeyId:e.accessKeyId,secretAccessKey:e.secretAccessKey},maxTokens:t.max_tokens,temperature:NI};return e.sessionToken&&e.sessionToken.trim()&&(n.credentials.sessionToken=e.sessionToken.trim()),console.log(`Initialized ${r} model: ${t.id}`),new qC(n)}function ii(t,e,r,n,s){var i;try{const a={model:t.id,maxTokens:t.max_tokens,apiKey:n,useResponsesApi:!0,temperature:1,model_kwargs:{store:!0}};if(r.includes(t.id)){const o=(i=t.reasoning_effort)==null?void 0:i[e];o?(a.reasoning={effort:o,summary:"detailed"},console.log(`Reasoning configured for ${s}: effort=${o}, level=${e}, model=${t.id}`)):(console.warn(`No reasoning effort defined for ${s} at level ${e}, using default minimal`),a.reasoning={effort:"minimal",summary:"detailed"})}else e>0&&console.warn(`Reasoning requested for ${s} but model ${t.id} does not support it`);return console.log(`Initialized ${s} model: ${t.id}`),new Gq(a)}catch(a){const o=Jy(a,"openai");throw console.error(`Failed to initialize OpenAI model ${s}:`,o.message),o}}function eH(t,e,r){try{console.log("Initializing OpenAI models with reasoning level:",t);const n=r.openaiApiKey;if(!n||n.trim()==="")throw new Ys("OpenAI API key is missing. Please provide a valid API key.");const s=ii(e.openai_model_main.assets,t,e.openai_reasoning_models,n,"assets"),i=ii(e.openai_model_main.flows,t,e.openai_reasoning_models,n,"flows"),a=ii(e.openai_model_main.threats,t,e.openai_reasoning_models,n,"threats"),o=ii(e.openai_model_main.threats_agent,t,e.openai_reasoning_models,n,"threats_agent"),c=ii(e.openai_model_main.gaps,t,e.openai_reasoning_models,n,"gaps"),l=ii(e.openai_model_summary,0,e.openai_reasoning_models,n,"summary"),u=ii(e.openai_model_struct,0,e.openai_reasoning_models,n,"struct");return console.log("All OpenAI models initialized successfully"),{assets_model:s,flows_model:i,threats_model:a,threats_agent_model:o,gaps_model:c,summary_model:l,struct_model:u}}catch(n){if(n instanceof Ys||n instanceof Va||n instanceof Kt)throw n;const s=Jy(n,"openai");throw console.error("Failed to initialize OpenAI models:",s.message),s}}function tH(t,e,r){console.log("Initializing Bedrock models with reasoning level:",t);const n=Xa(e.model_main.assets,t,e.reasoning_models,r,"assets"),s=Xa(e.model_main.flows,t,e.reasoning_models,r,"flows"),i=Xa(e.model_main.threats,t,e.reasoning_models,r,"threats"),a=Xa(e.model_main.threats_agent,t,e.reasoning_models,r,"threats_agent"),o=Xa(e.model_main.gaps,t,e.reasoning_models,r,"gaps"),c=Mv(e.model_summary,r,"summary"),l=Mv(e.model_struct,r,"struct");return console.log("All Bedrock models initialized successfully"),{assets_model:n,flows_model:s,threats_model:i,threats_agent_model:a,gaps_model:o,summary_model:c,struct_model:l}}function rH(t=0,e=null){try{const r=Wu();if(!r)throw new Kt("Provider credentials not configured","unknown");if(!r.provider)throw new Kt("No provider configuration found","unknown");const n=r.provider;if(n==="bedrock"){const s=e||Wq;if(Nv(s,"bedrock"),!r.accessKeyId||!r.secretAccessKey)throw new Kt("Invalid AWS credentials: missing accessKeyId or secretAccessKey","bedrock");return tH(t,s,r)}else if(n==="openai"){const s=e||Jq;if(Nv(s,"openai"),!r.openaiApiKey)throw new Ys("Invalid OpenAI credentials: missing API key");return eH(t,s,r)}else throw new Kt(`Unsupported provider: ${n}`,n)}catch(r){throw r instanceof Ys||r instanceof Va||r instanceof Kt?(console.error("Model initialization failed:",r.message),r):(console.error("Failed to initialize models:",r),r.message.includes("credentials")||r.message.includes("API key")?new Kt("Provider credentials are invalid or missing: "+r.message,"unknown"):r.message.includes("Configuration")?new Kt("Model configuration is invalid: "+r.message,"unknown"):r.message.includes("provider")?new Kt("Provider configuration error: "+r.message,"unknown"):new Kt("Failed to initialize models: "+r.message,"unknown"))}}const Sr={START:"START",ASSETS:"ASSETS",FLOW:"FLOW",THREAT:"THREAT",THREAT_RETRY:"THREAT_RETRY",FINALIZE:"FINALIZE",COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"},cs=new Map;function nH(t=0){try{const e=Wu();e&&e.provider==="bedrock"&&Qq(e);const r=rH(t);return{configurable:{model_assets:r.assets_model,model_flows:r.flows_model,model_threats:r.threats_model,model_threats_agent:r.threats_agent_model,model_gaps:r.gaps_model,model_summary:r.summary_model,model_struct:r.struct_model,reasoning:t>0,max_retry:15},recursionLimit:50}}catch(e){throw e instanceof Ys||e instanceof Va||e instanceof Kt||e instanceof Ct?e:new Kt(`Failed to initialize model configuration: ${e.message}`,"unknown")}}function sH(t){const{id:e,s3_location:r,iteration:n,description:s,assumptions:i,title:a,instructions:o}=t;let c=null;if(r){const l=ee.getUploadedFile(r);if(l)try{const u=JSON.parse(l);c=u.data||null,!c&&u.error&&console.warn(`Image data not available: ${u.error}`)}catch{c=l}}return{job_id:e,s3_location:r||"",owner:"LIGHTNING_USER",title:a||"",description:s||"",assumptions:i||[],iteration:n||0,retry:0,image_data:c,replay:!1,instructions:o||null,summary:null,assets:null,system_architecture:null,threat_list:null,gap:[],stop:!1}}function iH(t,e){const{iteration:r,instructions:n}=e,s=ee.getJobResults(t);if(!s)throw new Ct("NOT_FOUND",`Job ${t} not found for replay`,t);const i={assets:s.assets,system_architecture:s.system_architecture,threat_list:s.threat_list};ee.updateJobResults(t,{backup:i});let a=null;if(s.s3_location){const c=ee.getUploadedFile(s.s3_location);if(c)try{const l=JSON.parse(c);a=l.data||null,!a&&l.error&&console.warn(`Image data not available: ${l.error}`)}catch{a=c}}let o=null;if(s.threat_list){const c={...s.threat_list};c.threats=(c.threats||[]).filter(l=>l.starred===!0),o=c}return{job_id:t,s3_location:s.s3_location||"",owner:"LIGHTNING_USER",title:s.title||"",description:s.description||"",assumptions:s.assumptions||[],iteration:r||0,retry:0,image_data:a,replay:!0,instructions:n||null,summary:s.summary||null,assets:s.assets||null,system_architecture:s.system_architecture||null,threat_list:o,gap:[],stop:!1}}async function aH(t){const{s3_location:e,id:r,iteration:n,reasoning:s,description:i,assumptions:a,title:o,replay:c=!1,instructions:l}=t,u=r||Bv();try{let d;return c?d=iH(u,{iteration:n,reasoning:s,instructions:l}):d=sH({id:u,s3_location:e,iteration:n,reasoning:s,description:i,assumptions:a,title:o,instructions:l}),ee.setJobStatus(u,Sr.START,0),ee.setJobTrail(u,{id:u,assets:"",flows:"",gaps:[],threats:[]}),c||ee.addJobToIndex(u,{title:o||"",owner:"LIGHTNING_USER",s3_location:e||""}),oH(u,d,s||1),{id:u}}catch(d){throw console.error("Error executing agent:",d),ee.setJobStatus(u,Sr.FAILED,0),d instanceof Ct?d:new Ct("INTERNAL_ERROR",`Failed to execute agent: ${d.message}`,u)}}function oH(t,e,r){const n=typeof AbortController<"u";n||console.warn("AbortController not available, interruption will not be supported");const s=n?new AbortController:null,i=(async()=>{try{console.log(`Starting background execution for job ${t}`);const a=nH(r);s&&(a.signal=s.signal);const o=pj();console.log("Invoking workflow...");const c=await o.invoke(e,a);if(!cs.has(t)){console.log(`Job ${t} was cancelled during execution, skipping completion`);return}console.log(`Workflow completed for job ${t}`),console.log(`Job ${t} completed successfully`),cs.delete(t)}catch(a){if(a.name==="AbortError"||a.message==="AbortError"||s&&s.signal.aborted){console.log(`Job ${t} was aborted - interruption successful`),cs.delete(t);return}let c=a;const l=Wu();if(l&&l.provider&&(c=Jy(a,l.provider)),console.error(`Background execution failed for job ${t}:`,c),console.error("Error details:",{name:c.name,message:c.message,type:c.type||"unknown",stack:c.stack}),!cs.has(t)){console.log(`Job ${t} was cancelled during error handling, skipping status update`);return}const d=ee.getJobStatus(t),h=(d==null?void 0:d.retry)||0;try{ee.setJobStatus(t,Sr.FAILED,h);const f=ee.getJobResults(t)||{};ee.setJobResults(t,{...f,error:c.message||"Unknown error",error_type:c.type||c.name||"Error",provider:(l==null?void 0:l.provider)||"unknown",failed_at:new Date().toISOString()})}catch(f){console.error(`Failed to store error state for job ${t}:`,f)}cs.delete(t)}})();cs.set(t,{abortController:s,status:"RUNNING",startTime:Date.now(),workflowPromise:i}),setTimeout(()=>i,0)}function ZH(t){const e=ee.getJobStatus(t);return e?[Sr.START,Sr.ASSETS,Sr.FLOW,Sr.THREAT,Sr.THREAT_RETRY,Sr.FINALIZE].includes(e.state):!1}function KH(t){const e=cs.get(t);if(!e){console.log(`Interruption requested for job ${t}, but job not found in active jobs registry`);const r=ee.getJobStatus(t);return r&&(console.log(`Job ${t} exists in storage with status: ${r.state}`),![Sr.COMPLETE,Sr.FAILED,Sr.CANCELLED].includes(r.state))?(console.log(`Updating orphaned job ${t} to CANCELLED state`),ee.setJobStatus(t,Sr.CANCELLED,r.retry||0),!0):!1}console.log(`Interrupting job ${t} (started at ${new Date(e.startTime).toISOString()})`);try{e.abortController?(e.abortController.abort(),console.log(`Abort signal sent for job ${t}`)):console.warn(`No AbortController available for job ${t}, interruption may not be immediate`);const r=ee.getJobStatus(t);r?(ee.setJobStatus(t,Sr.CANCELLED,r.retry||0),console.log(`Job ${t} status updated to CANCELLED`)):console.warn(`Job ${t} status not found during interruption, may have been cleared`);try{const n=ee.getJobResults(t)||{};ee.setJobResults(t,{...n,cancelled_at:new Date().toISOString(),cancellation_reason:"User requested interruption"})}catch(n){console.error(`Failed to store cancellation metadata for job ${t}:`,n)}return cs.delete(t),console.log(`Job ${t} interrupted successfully and removed from active registry`),!0}catch(r){return console.error(`Error during interruption of job ${t}:`,r),cs.delete(t),!0}}const cH=Xn(async(t,e,r,n,s,i,a=!1,o=null,c=null)=>(console.log("startThreatModeling called",{key:t,iteration:e,reasoning:r,title:n,replay:a,id:o}),a?bs({iteration:e,reasoning:r,id:o},["iteration","reasoning","id"]):bs({iteration:e,reasoning:r,title:n,description:s},["iteration","reasoning","title","description"]),{data:await aH({s3_location:t,id:o,iteration:e,reasoning:r,description:s,assumptions:i||[],title:n,replay:a,instructions:c})})),lH=Xn(async(t,e)=>{if(console.log("updateTm called",{id:t,payload:e}),bs({id:t},["id"]),!e||typeof e!="object")throw new Ct("VALIDATION_ERROR","Payload must be an object",t);const r=ee.getJobResults(t);if(!r)throw new Ct("NOT_FOUND",`Job ${t} not found`,t);const n=["owner","s3_location","job_id"],s=Object.keys(e).filter(a=>!n.includes(a)).reduce((a,o)=>(a[o]=e[o],a),{});if(!r.backup){const a={assets:r.assets,system_architecture:r.system_architecture,threat_list:r.threat_list};s.backup=a}return ee.updateJobResults(t,s),{data:ee.getJobResults(t)}}),uH=Xn(async t=>{console.log("restoreTm called",{id:t}),bs({id:t},["id"]);const e=ee.getJobResults(t);if(!e)throw new Ct("NOT_FOUND",`Job ${t} not found`,t);if(!e.backup)throw new Ct("NOT_FOUND",`No backup found for job ${t}`,t);const r={...e,assets:e.backup.assets,system_architecture:e.backup.system_architecture,threat_list:e.backup.threat_list};ee.setJobResults(t,r);const n=ee.getJobStatus(t);return n&&ee.setJobStatus(t,"COMPLETE",n.retry||0),{data:!0}}),dH=Xn(async(t="image/png")=>{console.log("generateUrl called",{fileType:t});const e=Bv();return{data:{presigned:`lightning://upload/${e}`,name:e}}}),hH=Xn(async t=>{console.log("getDownloadUrl called",{fileName:t}),bs({fileName:t},["fileName"]);const e=ee.getUploadedFile(t);if(!e)throw new Ct("NOT_FOUND",`File ${t} not found`,null);try{let r,n;try{const o=JSON.parse(e);if(o.data&&o.type)n=o.data,r=o.type;else throw new Error("Invalid JSON format")}catch{const c=e.match(/^data:([^;]+);base64,(.+)$/);if(!c)throw new Error("Invalid data format - not JSON or data URL");r=c[1],n=c[2]}const s=atob(n),i=new Uint8Array(s.length);for(let o=0;o<s.length;o++)i[o]=s.charCodeAt(o);return new Blob([i],{type:r})}catch(r){throw new Ct("INTERNAL_ERROR",`Failed to retrieve file: ${r.message}`,null)}}),fH=Xn(async t=>{bs({id:t},["id"]);const e=ee.getJobStatus(t);return e?{data:{id:e.id,state:e.state,retry:e.retry||0,detail:e.detail!==void 0?e.detail:null}}:{data:{id:t,state:"Not Found",retry:0,detail:null}}}),pH=Xn(async t=>{console.log("getThreatModelingTrail called",{id:t}),bs({id:t},["id"]);const e=ee.getJobTrail(t);return e?{data:{id:e.id,assets:e.assets||"",flows:e.flows||"",gaps:e.gaps||[],threats:e.threats||[]}}:{data:{id:t,assets:"",flows:"",gaps:[],threats:[]}}}),mH=Xn(async t=>{console.log("getThreatModelingResults called",{id:t}),bs({id:t},["id"]);const e=ee.getJobResults(t);return e?{data:{job_id:t,state:"Found",item:e}}:{data:{job_id:t,state:"Not Found",item:null}}}),gH=Xn(async()=>(console.log("getThreatModelingAllResults called"),{data:{catalogs:ee.getAllJobs().map(r=>ee.getJobResults(r.id)||r).filter(Boolean)}})),yH=Xn(async t=>{console.log("deleteTm called",{id:t}),bs({id:t},["id"]);const e=ee.getJobResults(t);if(!e)throw new Ct("NOT_FOUND",`Job ${t} not found`,t);return e.s3_location&&ee.deleteUploadedFile(e.s3_location),ee.clearJobData(t),{data:{job_id:t,state:"Deleted"}}}),XH=cH,YH=lH,QH=uH,eG=dH,tG=hH,rG=fH,nG=pH,sG=mH,iG=gH,aG=yH;export{oc as ERROR_TYPES,Ct as ThreatModelingError,lG as clearCredentials,aG as deleteTm,eG as generateUrl,Wu as getCredentials,tG as getDownloadUrl,iG as getThreatModelingAllResults,sG as getThreatModelingResults,rG as getThreatModelingStatus,nG as getThreatModelingTrail,uG as hasValidCredentials,KH as interruptJob,ZH as isJobExecuting,QH as restoreTm,dG as setCredentials,XH as startThreatModeling,ee as stateManager,YH as updateTm};
//# sourceMappingURL=index-B8K1dSFS.js.map
