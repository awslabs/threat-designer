var FS=Object.defineProperty;var jS=(t,e,r)=>e in t?FS(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var f=(t,e,r)=>jS(t,typeof e!="symbol"?e+"":e,r);import{g as ki,a as L_}from"./index-Z4-Pj7gZ.js";import{c as C6,h as k6,s as I6}from"./index-Z4-Pj7gZ.js";const At=[];for(let t=0;t<256;++t)At.push((t+256).toString(16).slice(1));function zS(t,e=0){return(At[t[e+0]]+At[t[e+1]]+At[t[e+2]]+At[t[e+3]]+"-"+At[t[e+4]]+At[t[e+5]]+"-"+At[t[e+6]]+At[t[e+7]]+"-"+At[t[e+8]]+At[t[e+9]]+"-"+At[t[e+10]]+At[t[e+11]]+At[t[e+12]]+At[t[e+13]]+At[t[e+14]]+At[t[e+15]]).toLowerCase()}let gu;const VS=new Uint8Array(16);function GS(){if(!gu){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");gu=crypto.getRandomValues.bind(crypto)}return gu(VS)}const HS=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ap={randomUUID:HS};function qS(t,e,r){var s;t=t||{};const n=t.random??((s=t.rng)==null?void 0:s.call(t))??GS();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,zS(n)}function D_(t,e,r){return Ap.randomUUID&&!t?Ap.randomUUID():qS(t)}const ht={JOB_STATUS:"tm_job_status_",JOB_RESULTS:"tm_job_results_",JOB_TRAIL:"tm_job_trail_",ALL_JOBS:"tm_all_jobs",UPLOADED_FILES:"tm_uploaded_files_",AWS_CREDENTIALS:"tm_aws_credentials"},yu={COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"};class WS{setJobStatus(e,r,n=0){const s={id:e,state:r,retry:n,owner:"LIGHTNING_USER",updated_at:new Date().toISOString()};sessionStorage.setItem(`${ht.JOB_STATUS}${e}`,JSON.stringify(s))}getJobStatus(e){const r=sessionStorage.getItem(`${ht.JOB_STATUS}${e}`);if(!r)return null;try{return JSON.parse(r)}catch(n){return console.error("Failed to parse job status:",n),null}}setJobResults(e,r){sessionStorage.setItem(`${ht.JOB_RESULTS}${e}`,JSON.stringify(r))}getJobResults(e){const r=sessionStorage.getItem(`${ht.JOB_RESULTS}${e}`);if(!r)return null;try{return JSON.parse(r)}catch(n){return console.error("Failed to parse job results:",n),null}}updateJobResults(e,r){const s={...this.getJobResults(e)||{},...r};this.setJobResults(e,s)}setJobTrail(e,r){sessionStorage.setItem(`${ht.JOB_TRAIL}${e}`,JSON.stringify(r))}getJobTrail(e){const r=sessionStorage.getItem(`${ht.JOB_TRAIL}${e}`);if(!r)return null;try{return JSON.parse(r)}catch(n){return console.error("Failed to parse job trail:",n),null}}updateJobTrail(e,r){const n=this.getJobTrail(e)||{id:e,assets:"",flows:"",gaps:[],threats:[]},s={...n};r.assets!==void 0&&(s.assets=r.assets),r.flows!==void 0&&(s.flows=r.flows),r.gaps!==void 0&&(s.gaps=Array.isArray(r.gaps)?[...n.gaps||[],...r.gaps]:[...n.gaps||[],r.gaps]),r.threats!==void 0&&(s.threats=Array.isArray(r.threats)?[...n.threats||[],...r.threats]:[...n.threats||[],r.threats]),this.setJobTrail(e,s)}addJobToIndex(e,r){const n=this.getAllJobs(),s=n.findIndex(a=>a.id===e),i={id:e,...r,created_at:r.created_at||new Date().toISOString()};s>=0?n[s]={...n[s],...i}:n.push(i),sessionStorage.setItem(ht.ALL_JOBS,JSON.stringify(n))}getAllJobs(){const e=sessionStorage.getItem(ht.ALL_JOBS);if(!e)return[];try{return JSON.parse(e)}catch(r){return console.error("Failed to parse all jobs:",r),[]}}removeJobFromIndex(e){const n=this.getAllJobs().filter(s=>s.id!==e);sessionStorage.setItem(ht.ALL_JOBS,JSON.stringify(n))}storeUploadedFile(e,r){sessionStorage.setItem(`${ht.UPLOADED_FILES}${e}`,r)}getUploadedFile(e){return sessionStorage.getItem(`${ht.UPLOADED_FILES}${e}`)}deleteUploadedFile(e){sessionStorage.removeItem(`${ht.UPLOADED_FILES}${e}`)}clearJobData(e){sessionStorage.removeItem(`${ht.JOB_STATUS}${e}`),sessionStorage.removeItem(`${ht.JOB_RESULTS}${e}`),sessionStorage.removeItem(`${ht.JOB_TRAIL}${e}`),this.removeJobFromIndex(e)}clearAllData(){const e=sessionStorage.getItem(ht.AWS_CREDENTIALS);this.getAllJobs().forEach(n=>{this.clearJobData(n.id)}),sessionStorage.removeItem(ht.ALL_JOBS),Object.keys(sessionStorage).forEach(n=>{n.startsWith(ht.UPLOADED_FILES)&&sessionStorage.removeItem(n)}),e&&sessionStorage.setItem(ht.AWS_CREDENTIALS,e)}isJobActive(e){const r=this.getJobStatus(e);return r?![yu.CANCELLED,yu.COMPLETE,yu.FAILED].includes(r.state):!1}}const ce=new WS;var Ds=class extends Error{constructor(e,r){let n=e??"";r!=null&&r.lc_error_code&&(n=`${n}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langgraph/${r.lc_error_code}/
`);super(n);f(this,"lc_error_code");this.lc_error_code=r==null?void 0:r.lc_error_code}},M_=class extends Ds{get is_bubble_up(){return!0}},JS=class extends Ds{constructor(t,e){super(t,e),this.name="GraphRecursionError"}static get unminifiable_name(){return"GraphRecursionError"}},ko=class extends Ds{constructor(t,e){super(t,e),this.name="GraphValueError"}static get unminifiable_name(){return"GraphValueError"}},ai=class extends M_{constructor(e,r){super(JSON.stringify(e,null,2),r);f(this,"interrupts");this.name="GraphInterrupt",this.interrupts=e??[]}static get unminifiable_name(){return"GraphInterrupt"}},U_=class extends ai{constructor(t,e){super([{value:t}],e),this.name="NodeInterrupt"}static get unminifiable_name(){return"NodeInterrupt"}},B_=class extends M_{constructor(e){super();f(this,"command");this.name="ParentCommand",this.command=e}static get unminifiable_name(){return"ParentCommand"}};function ZS(t){return t!==void 0&&t.name===B_.unminifiable_name}function Io(t){return t!==void 0&&t.is_bubble_up===!0}function Xs(t){return t!==void 0&&[ai.unminifiable_name,U_.unminifiable_name].includes(t.name)}var Cp=class extends Ds{constructor(t,e){super(t,e),this.name="EmptyInputError"}static get unminifiable_name(){return"EmptyInputError"}},Nt=class extends Ds{constructor(t,e){super(t,e),this.name="EmptyChannelError"}static get unminifiable_name(){return"EmptyChannelError"}},Xe=class extends Ds{constructor(t,e){super(t,e),this.name="InvalidUpdateError"}static get unminifiable_name(){return"InvalidUpdateError"}},KS=class extends Ds{constructor(t,e){super(t,e),this.name="UnreachableNodeError"}static get unminifiable_name(){return"UnreachableNodeError"}};const XS=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function YS(t){return typeof t=="string"&&XS.test(t)}function F_(t){if(!YS(t))throw TypeError("Invalid UUID");var e,r=new Uint8Array(16);return r[0]=(e=parseInt(t.slice(0,8),16))>>>24,r[1]=e>>>16&255,r[2]=e>>>8&255,r[3]=e&255,r[4]=(e=parseInt(t.slice(9,13),16))>>>8,r[5]=e&255,r[6]=(e=parseInt(t.slice(14,18),16))>>>8,r[7]=e&255,r[8]=(e=parseInt(t.slice(19,23),16))>>>8,r[9]=e&255,r[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,r[11]=e/4294967296&255,r[12]=e>>>24&255,r[13]=e>>>16&255,r[14]=e>>>8&255,r[15]=e&255,r}var Ct=[];for(var _u=0;_u<256;++_u)Ct.push((_u+256).toString(16).slice(1));function Dc(t,e=0){return(Ct[t[e+0]]+Ct[t[e+1]]+Ct[t[e+2]]+Ct[t[e+3]]+"-"+Ct[t[e+4]]+Ct[t[e+5]]+"-"+Ct[t[e+6]]+Ct[t[e+7]]+"-"+Ct[t[e+8]]+Ct[t[e+9]]+"-"+Ct[t[e+10]]+Ct[t[e+11]]+Ct[t[e+12]]+Ct[t[e+13]]+Ct[t[e+14]]+Ct[t[e+15]]).toLowerCase()}var eo,QS=new Uint8Array(16);function ex(){if(!eo&&(eo=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!eo))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return eo(QS)}var wu,to,vu=0,bu=0;function tx(t,e,r){var n=0,s=e||new Array(16);t=t||{};var i=t.node,a=t.clockseq;if(t._v6||(i||(i=wu),a==null&&(a=to)),i==null||a==null){var o=t.random||(t.rng||ex)();i==null&&(i=[o[0],o[1],o[2],o[3],o[4],o[5]],!wu&&!t._v6&&(i[0]|=1,wu=i)),a==null&&(a=(o[6]<<8|o[7])&16383,to===void 0&&!t._v6&&(to=a))}var c=t.msecs!==void 0?t.msecs:Date.now(),u=t.nsecs!==void 0?t.nsecs:bu+1,l=c-vu+(u-bu)/1e4;if(l<0&&t.clockseq===void 0&&(a=a+1&16383),(l<0||c>vu)&&t.nsecs===void 0&&(u=0),u>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");vu=c,bu=u,to=a,c+=122192928e5;var d=((c&268435455)*1e4+u)%4294967296;s[n++]=d>>>24&255,s[n++]=d>>>16&255,s[n++]=d>>>8&255,s[n++]=d&255;var h=c/4294967296*1e4&268435455;s[n++]=h>>>8&255,s[n++]=h&255,s[n++]=h>>>24&15|16,s[n++]=h>>>16&255,s[n++]=a>>>8|128,s[n++]=a&255;for(var p=0;p<6;++p)s[n+p]=i[p];return e||Dc(s)}function rx(t){var e=typeof t=="string"?F_(t):t,r=nx(e);return typeof t=="string"?Dc(r):r}function nx(t,e=!1){return Uint8Array.of((t[6]&15)<<4|t[7]>>4&15,(t[7]&15)<<4|(t[4]&240)>>4,(t[4]&15)<<4|(t[5]&240)>>4,(t[5]&15)<<4|(t[0]&240)>>4,(t[0]&15)<<4|(t[1]&240)>>4,(t[1]&15)<<4|(t[2]&240)>>4,96|t[2]&15,t[3],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}function sx(t){t=unescape(encodeURIComponent(t));for(var e=[],r=0;r<t.length;++r)e.push(t.charCodeAt(r));return e}var ix="6ba7b810-9dad-11d1-80b4-00c04fd430c8",ax="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function ox(t,e,r){function n(s,i,a,o){var c;if(typeof s=="string"&&(s=sx(s)),typeof i=="string"&&(i=F_(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var u=new Uint8Array(16+s.length);if(u.set(i),u.set(s,i.length),u=r(u),u[6]=u[6]&15|e,u[8]=u[8]&63|128,a){o=o||0;for(var l=0;l<16;++l)a[o+l]=u[l];return a}return Dc(u)}try{n.name=t}catch{}return n.DNS=ix,n.URL=ax,n}function cx(t,e,r,n){switch(t){case 0:return e&r^~e&n;case 1:return e^r^n;case 2:return e&r^e&n^r&n;case 3:return e^r^n}}function Eu(t,e){return t<<e|t>>>32-e}function ux(t){var e=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var n=unescape(encodeURIComponent(t));t=[];for(var s=0;s<n.length;++s)t.push(n.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var i=t.length/4+2,a=Math.ceil(i/16),o=new Array(a),c=0;c<a;++c){for(var u=new Uint32Array(16),l=0;l<16;++l)u[l]=t[c*64+l*4]<<24|t[c*64+l*4+1]<<16|t[c*64+l*4+2]<<8|t[c*64+l*4+3];o[c]=u}o[a-1][14]=(t.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var h=new Uint32Array(80),p=0;p<16;++p)h[p]=o[d][p];for(var m=16;m<80;++m)h[m]=Eu(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var _=r[0],v=r[1],y=r[2],E=r[3],b=r[4],I=0;I<80;++I){var k=Math.floor(I/20),R=Eu(_,5)+cx(k,v,y,E)+b+e[k]+h[I]>>>0;b=E,E=y,y=Eu(v,30)>>>0,v=_,_=R}r[0]=r[0]+_>>>0,r[1]=r[1]+v>>>0,r[2]=r[2]+y>>>0,r[3]=r[3]+E>>>0,r[4]=r[4]+b>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,r[0]&255,r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,r[1]&255,r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,r[2]&255,r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,r[3]&255,r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,r[4]&255]}var lx=ox("v5",80,ux);function kp(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(t,s).enumerable})),r.push.apply(r,n)}return r}function Ip(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};e%2?kp(Object(r),!0).forEach(function(n){dx(t,n,r[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):kp(Object(r)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(r,n))})}return t}function dx(t,e,r){return(e=hx(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function hx(t){var e=fx(t,"string");return typeof e=="symbol"?e:e+""}function fx(t,e){if(typeof t!="object"||!t)return t;var r=t[Symbol.toPrimitive];if(r!==void 0){var n=r.call(t,e);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function px(t={},e,r=0){var n=tx(Ip(Ip({},t),{},{_v6:!0}),new Uint8Array(16));return n=rx(n),Dc(n)}function j_(t){return px({clockseq:t})}function Ys(t,e){const r=e.replace(/-/g,"").match(/.{2}/g).map(n=>parseInt(n,16));return lx(t,new Uint8Array(r))}const mx="__error__",Ro="__scheduled__",gx="__interrupt__",yx="__resume__";var Rp="[...]",_x="[Circular]",Yo=[],Qs=[];function wx(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function vx(t,e,r,n){typeof n>"u"&&(n=wx()),bd(t,"",0,[],void 0,0,n);var s;try{Qs.length===0?s=JSON.stringify(t,e,r):s=JSON.stringify(t,bx(e),r)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Yo.length!==0;){var i=Yo.pop();i.length===4?Object.defineProperty(i[0],i[1],i[3]):i[0][i[1]]=i[2]}}return s}function Su(t,e,r,n){var s=Object.getOwnPropertyDescriptor(n,r);s.get!==void 0?s.configurable?(Object.defineProperty(n,r,{value:t}),Yo.push([n,r,e,s])):Qs.push([e,r,t]):(n[r]=t,Yo.push([n,r,e]))}function bd(t,e,r,n,s,i,a){i+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<n.length;o++)if(n[o]===t){Su(_x,t,e,s);return}if(typeof a.depthLimit<"u"&&i>a.depthLimit){Su(Rp,t,e,s);return}if(typeof a.edgesLimit<"u"&&r+1>a.edgesLimit){Su(Rp,t,e,s);return}if(n.push(t),Array.isArray(t))for(o=0;o<t.length;o++)bd(t[o],o,o,n,t,i,a);else{var c=Object.keys(t);for(o=0;o<c.length;o++){var u=c[o];bd(t[u],u,o,n,t,i,a)}}n.pop()}}function bx(t){return t=typeof t<"u"?t:function(e,r){return r},function(e,r){if(Qs.length>0)for(var n=0;n<Qs.length;n++){var s=Qs[n];if(s[1]===e&&s[0]===r){r=s[2],Qs.splice(n,1);break}}return t.call(this,e,r)}}var xu,Op;function Ex(){return Op||(Op=1,xu=function(t,e){if(typeof t!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,t.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}),xu}var Sx=Ex();const xx=ki(Sx);var ro={exports:{}},Np;function Tx(){if(Np)return ro.exports;Np=1;const t=/[\p{Lu}]/u,e=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,n=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,i=new RegExp("^"+s.source),a=new RegExp(s.source+n.source,"gu"),o=new RegExp("\\d+"+n.source,"gu"),c=(h,p,m)=>{let _=!1,v=!1,y=!1;for(let E=0;E<h.length;E++){const b=h[E];_&&t.test(b)?(h=h.slice(0,E)+"-"+h.slice(E),_=!1,y=v,v=!0,E++):v&&y&&e.test(b)?(h=h.slice(0,E-1)+"-"+h.slice(E-1),y=v,v=!1,_=!0):(_=p(b)===b&&m(b)!==b,y=v,v=m(b)===b&&p(b)!==b)}return h},u=(h,p)=>(r.lastIndex=0,h.replace(r,m=>p(m))),l=(h,p)=>(a.lastIndex=0,o.lastIndex=0,h.replace(a,(m,_)=>p(_)).replace(o,m=>p(m))),d=(h,p)=>{if(!(typeof h=="string"||Array.isArray(h)))throw new TypeError("Expected the input to be `string | string[]`");if(p={pascalCase:!1,preserveConsecutiveUppercase:!1,...p},Array.isArray(h)?h=h.map(y=>y.trim()).filter(y=>y.length).join("-"):h=h.trim(),h.length===0)return"";const m=p.locale===!1?y=>y.toLowerCase():y=>y.toLocaleLowerCase(p.locale),_=p.locale===!1?y=>y.toUpperCase():y=>y.toLocaleUpperCase(p.locale);return h.length===1?p.pascalCase?_(h):m(h):(h!==m(h)&&(h=c(h,m,_)),h=h.replace(i,""),p.preserveConsecutiveUppercase?h=u(h,m):h=m(h),p.pascalCase&&(h=_(h.charAt(0))+h.slice(1)),l(h,_))};return ro.exports=d,ro.exports.default=d,ro.exports}var Ax=Tx();const Cx=ki(Ax);function kx(t,e){return(e==null?void 0:e[t])||xx(t)}function Ix(t,e){return(e==null?void 0:e[t])||Cx(t)}function z_(t,e,r){const n={};for(const s in t)Object.hasOwn(t,s)&&(n[e(s,r)]=t[s]);return n}var Rx=Object.defineProperty,me=(t,e)=>{for(var r in e)Rx(t,r,{get:e[r],enumerable:!0})},V_={};me(V_,{Serializable:()=>Or,get_lc_unique_name:()=>Mc});function $p(t){return Array.isArray(t)?[...t]:{...t}}function Ox(t,e){const r=$p(t);for(const[n,s]of Object.entries(e)){const[i,...a]=n.split(".").reverse();let o=r;for(const c of a.reverse()){if(o[c]===void 0)break;o[c]=$p(o[c]),o=o[c]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[s]})}return r}function Mc(t){const e=Object.getPrototypeOf(t);return typeof t.lc_name=="function"&&(typeof e.lc_name!="function"||t.lc_name()!==e.lc_name())?t.lc_name():t.name}var Or=class G_{constructor(e,...r){f(this,"lc_serializable",!1);f(this,"lc_kwargs");this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([n])=>{var s;return(s=this.lc_serializable_keys)==null?void 0:s.includes(n)})):this.lc_kwargs=e??{}}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Mc(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof G_||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},r={},n=Object.keys(this.lc_kwargs).reduce((s,i)=>(s[i]=i in this?this[i]:this.lc_kwargs[i],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(r,Reflect.get(s,"lc_secrets",this)),Object.assign(n,Reflect.get(s,"lc_attributes",this));return Object.keys(r).forEach(s=>{let i=this,a=n;const[o,...c]=s.split(".").reverse();for(const u of c.reverse()){if(!(u in i)||i[u]===void 0)return;(!(u in a)||a[u]===void 0)&&(typeof i[u]=="object"&&i[u]!=null?a[u]={}:Array.isArray(i[u])&&(a[u]=[])),i=i[u],a=a[u]}o in i&&i[o]!==void 0&&(a[o]=a[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:z_(Object.keys(r).length?Ox(n,r):n,kx,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function Nx(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var H_={exports:{}},st=H_.exports={},Yr,Qr;function Ed(){throw new Error("setTimeout has not been defined")}function Sd(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?Yr=setTimeout:Yr=Ed}catch{Yr=Ed}try{typeof clearTimeout=="function"?Qr=clearTimeout:Qr=Sd}catch{Qr=Sd}})();function q_(t){if(Yr===setTimeout)return setTimeout(t,0);if((Yr===Ed||!Yr)&&setTimeout)return Yr=setTimeout,setTimeout(t,0);try{return Yr(t,0)}catch{try{return Yr.call(null,t,0)}catch{return Yr.call(this,t,0)}}}function $x(t){if(Qr===clearTimeout)return clearTimeout(t);if((Qr===Sd||!Qr)&&clearTimeout)return Qr=clearTimeout,clearTimeout(t);try{return Qr(t)}catch{try{return Qr.call(null,t)}catch{return Qr.call(this,t)}}}var xn=[],oi=!1,vs,Oo=-1;function Px(){!oi||!vs||(oi=!1,vs.length?xn=vs.concat(xn):Oo=-1,xn.length&&W_())}function W_(){if(!oi){var t=q_(Px);oi=!0;for(var e=xn.length;e;){for(vs=xn,xn=[];++Oo<e;)vs&&vs[Oo].run();Oo=-1,e=xn.length}vs=null,oi=!1,$x(t)}}st.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)e[r-1]=arguments[r];xn.push(new J_(t,e)),xn.length===1&&!oi&&q_(W_)};function J_(t,e){this.fun=t,this.array=e}J_.prototype.run=function(){this.fun.apply(null,this.array)};st.title="browser";st.browser=!0;st.env={};st.argv=[];st.version="";st.versions={};function Mn(){}st.on=Mn;st.addListener=Mn;st.once=Mn;st.off=Mn;st.removeListener=Mn;st.removeAllListeners=Mn;st.emit=Mn;st.prependListener=Mn;st.prependOnceListener=Mn;st.listeners=function(t){return[]};st.binding=function(t){throw new Error("process.binding is not supported")};st.cwd=function(){return"/"};st.chdir=function(t){throw new Error("process.chdir is not supported")};st.umask=function(){return 0};var Lx=H_.exports;const on=Nx(Lx);var Tu={},Z_={};me(Z_,{getEnv:()=>ew,getEnvironmentVariable:()=>cn,getRuntimeEnvironment:()=>tw,isBrowser:()=>K_,isDeno:()=>Uc,isJsDom:()=>Y_,isNode:()=>Q_,isWebWorker:()=>X_});const K_=()=>typeof window<"u"&&typeof window.document<"u",X_=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Y_=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Uc=()=>typeof Deno<"u",Q_=()=>typeof on<"u"&&typeof on.versions<"u"&&typeof on.versions.node<"u"&&!Uc(),ew=()=>{let t;return K_()?t="browser":Q_()?t="node":X_()?t="webworker":Y_()?t="jsdom":Uc()?t="deno":t="other",t};let Au;function tw(){return Au===void 0&&(Au={library:"langchain-js",runtime:ew()}),Au}function cn(t){try{return typeof on<"u"?Tu==null?void 0:Tu[t]:Uc()?Deno==null?void 0:Deno.env.get(t):void 0}catch{return}}const Dx=[];var Mx={};function Rn(t){return typeof t=="object"&&t!==null&&"type"in t&&typeof t.type=="string"&&"source_type"in t&&(t.source_type==="url"||t.source_type==="base64"||t.source_type==="text"||t.source_type==="id")}function Fh(t){return Rn(t)&&t.source_type==="url"&&"url"in t&&typeof t.url=="string"}function jh(t){return Rn(t)&&t.source_type==="base64"&&"data"in t&&typeof t.data=="string"}function Ux(t){return Rn(t)&&t.source_type==="text"&&"text"in t&&typeof t.text=="string"}function rw(t){return Rn(t)&&t.source_type==="id"&&"id"in t&&typeof t.id=="string"}function nw(t){if(Rn(t)){if(t.source_type==="url")return{type:"image_url",image_url:{url:t.url}};if(t.source_type==="base64"){if(!t.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${t.mime_type};base64,${t.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function Vi(t){const e=t.split(";")[0].split("/");if(e.length!==2)throw new Error(`Invalid mime type: "${t}" - does not match type/subtype format.`);const r=e[0].trim(),n=e[1].trim();if(r===""||n==="")throw new Error(`Invalid mime type: "${t}" - type or subtype is empty.`);const s={};for(const i of t.split(";").slice(1)){const a=i.split("=");if(a.length!==2)throw new Error(`Invalid parameter syntax in mime type: "${t}".`);const o=a[0].trim(),c=a[1].trim();if(o==="")throw new Error(`Invalid parameter syntax in mime type: "${t}".`);s[o]=c}return{type:r,subtype:n,parameters:s}}function ca({dataUrl:t,asTypedArray:e=!1}){const r=t.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let n;if(r){n=r[1].toLowerCase();const s=e?Uint8Array.from(atob(r[2]),i=>i.charCodeAt(0)):r[2];return{mime_type:n,data:s}}}function sw(t,e){if(t.type==="text"){if(!e.fromStandardTextBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardTextBlock\` method.`);return e.fromStandardTextBlock(t)}if(t.type==="image"){if(!e.fromStandardImageBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardImageBlock\` method.`);return e.fromStandardImageBlock(t)}if(t.type==="audio"){if(!e.fromStandardAudioBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardAudioBlock\` method.`);return e.fromStandardAudioBlock(t)}if(t.type==="file"){if(!e.fromStandardFileBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardFileBlock\` method.`);return e.fromStandardFileBlock(t)}throw new Error(`Unable to convert content block type '${t.type}' to provider-specific format: not recognized.`)}function pe(t,e){return Ee(t)&&t.type===e}function Ee(t){return typeof t=="object"&&t!==null}function un(t){return Array.isArray(t)}function re(t){return typeof t=="string"}function Br(t){return typeof t=="number"}function zh(t){return t instanceof Uint8Array}function Pp(t){try{return JSON.parse(t)}catch{return}}const ua=t=>t();function Bx(t){if(t.type==="char_location"&&re(t.document_title)&&Br(t.start_char_index)&&Br(t.end_char_index)&&re(t.cited_text)){const{document_title:e,start_char_index:r,end_char_index:n,cited_text:s,...i}=t;return{...i,type:"citation",source:"char",title:e??void 0,startIndex:r,endIndex:n,citedText:s}}if(t.type==="page_location"&&re(t.document_title)&&Br(t.start_page_number)&&Br(t.end_page_number)&&re(t.cited_text)){const{document_title:e,start_page_number:r,end_page_number:n,cited_text:s,...i}=t;return{...i,type:"citation",source:"page",title:e??void 0,startIndex:r,endIndex:n,citedText:s}}if(t.type==="content_block_location"&&re(t.document_title)&&Br(t.start_block_index)&&Br(t.end_block_index)&&re(t.cited_text)){const{document_title:e,start_block_index:r,end_block_index:n,cited_text:s,...i}=t;return{...i,type:"citation",source:"block",title:e??void 0,startIndex:r,endIndex:n,citedText:s}}if(t.type==="web_search_result_location"&&re(t.url)&&re(t.title)&&re(t.encrypted_index)&&re(t.cited_text)){const{url:e,title:r,encrypted_index:n,cited_text:s,...i}=t;return{...i,type:"citation",source:"url",url:e,title:r,startIndex:Number(n),endIndex:Number(n),citedText:s}}if(t.type==="search_result_location"&&re(t.source)&&re(t.title)&&Br(t.start_block_index)&&Br(t.end_block_index)&&re(t.cited_text)){const{source:e,title:r,start_block_index:n,end_block_index:s,cited_text:i,...a}=t;return{...a,type:"citation",source:"search",url:e,title:r??void 0,startIndex:n,endIndex:s,citedText:i}}}function iw(t){if(pe(t,"document")&&Ee(t.source)&&"type"in t.source){if(t.source.type==="base64"&&re(t.source.media_type)&&re(t.source.data))return{type:"file",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&re(t.source.url))return{type:"file",url:t.source.url};if(t.source.type==="file"&&re(t.source.file_id))return{type:"file",fileId:t.source.file_id};if(t.source.type==="text"&&re(t.source.data))return{type:"file",mimeType:String(t.source.media_type??"text/plain"),data:t.source.data}}else if(pe(t,"image")&&Ee(t.source)&&"type"in t.source){if(t.source.type==="base64"&&re(t.source.media_type)&&re(t.source.data))return{type:"image",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&re(t.source.url))return{type:"image",url:t.source.url};if(t.source.type==="file"&&re(t.source.file_id))return{type:"image",fileId:t.source.file_id}}}function Fx(t){function*e(){for(const r of t){const n=iw(r);n?yield n:yield r}}return Array.from(e())}function Lp(t){function*e(){var n;const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const s of r){if(pe(s,"text")&&re(s.text)){const{text:i,citations:a,...o}=s;if(un(a)&&a.length){const c=a.reduce((u,l)=>{const d=Bx(l);return d?[...u,d]:u},[]);yield{...o,type:"text",text:i,annotations:c};continue}else{yield{...o,type:"text",text:i};continue}}else if(pe(s,"thinking")&&re(s.thinking)){const{thinking:i,signature:a,...o}=s;yield{...o,type:"reasoning",reasoning:i,signature:a};continue}else if(pe(s,"redacted_thinking")){yield{type:"non_standard",value:s};continue}else if(pe(s,"tool_use")&&re(s.name)&&re(s.id)){yield{type:"tool_call",id:s.id,name:s.name,args:s.input};continue}else if(pe(s,"input_json_delta")){if(zx(t)&&((n=t.tool_call_chunks)!=null&&n.length)){const i=t.tool_call_chunks[0];yield{type:"tool_call_chunk",id:i.id,name:i.name,args:i.args,index:i.index};continue}}else if(pe(s,"server_tool_use")&&re(s.name)&&re(s.id)){const{name:i,id:a}=s;if(i==="web_search"){const o=ua(()=>{if(typeof s.input=="string")return s.input;if(Ee(s.input)&&re(s.input.query))return s.input.query;if(re(s.partial_json)){const c=Pp(s.partial_json);if(c!=null&&c.query)return c.query}return""});yield{id:a,type:"server_tool_call",name:"web_search",args:{query:o}};continue}else if(s.name==="code_execution"){const o=ua(()=>{if(typeof s.input=="string")return s.input;if(Ee(s.input)&&re(s.input.code))return s.input.code;if(re(s.partial_json)){const c=Pp(s.partial_json);if(c!=null&&c.code)return c.code}return""});yield{id:a,type:"server_tool_call",name:"code_execution",args:{code:o}};continue}}else if(pe(s,"web_search_tool_result")&&re(s.tool_use_id)&&un(s.content)){const{content:i,tool_use_id:a}=s,o=i.reduce((c,u)=>pe(u,"web_search_result")?[...c,u.url]:c,[]);yield{type:"server_tool_call_result",name:"web_search",toolCallId:a,status:"success",output:{urls:o}};continue}else if(pe(s,"code_execution_tool_result")&&re(s.tool_use_id)&&Ee(s.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(pe(s,"mcp_tool_use")){yield{id:s.id,type:"server_tool_call",name:"mcp_tool_use",args:s.input};continue}else if(pe(s,"mcp_tool_result")&&re(s.tool_use_id)&&Ee(s.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(pe(s,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:s.input};continue}else if(pe(s,"search_result")){yield{id:s.id,type:"non_standard",value:s};continue}else if(pe(s,"tool_result")){yield{id:s.id,type:"non_standard",value:s};continue}else{const i=iw(s);if(i){yield i;continue}}yield{type:"non_standard",value:s}}}return Array.from(e())}const jx={translateContent:Lp,translateContentChunk:Lp};function zx(t){return typeof(t==null?void 0:t._getType)=="function"&&typeof t.concat=="function"&&t._getType()==="ai"}function Vx(t){return Fh(t)?{type:t.type,mimeType:t.mime_type,url:t.url,metadata:t.metadata}:jh(t)?{type:t.type,mimeType:t.mime_type??"application/octet-stream",data:t.data,metadata:t.metadata}:rw(t)?{type:t.type,mimeType:t.mime_type,fileId:t.id,metadata:t.metadata}:t}function Gx(t){return t.map(Vx)}function Hx(t){return!!(pe(t,"image_url")&&Ee(t.image_url)||pe(t,"input_audio")&&Ee(t.input_audio)||pe(t,"file")&&Ee(t.file))}function qx(t){if(pe(t,"image_url")&&Ee(t.image_url)&&re(t.image_url.url)){const e=ca({dataUrl:t.image_url.url});return e?{type:"image",mimeType:e.mime_type,data:e.data}:{type:"image",url:t.image_url.url}}else{if(pe(t,"input_audio")&&Ee(t.input_audio)&&re(t.input_audio.data)&&re(t.input_audio.format))return{type:"audio",data:t.input_audio.data,mimeType:`audio/${t.input_audio.format}`};if(pe(t,"file")&&Ee(t.file)&&re(t.file.data)){const e=ca({dataUrl:t.file.data});if(e)return{type:"file",data:e.data,mimeType:e.mime_type};if(re(t.file.file_id))return{type:"file",fileId:t.file.file_id}}}return t}function Wx(t){const e=[];typeof t.content=="string"?e.push({type:"text",text:t.content}):e.push(...Vh(t.content));for(const r of t.tool_calls??[])e.push({type:"tool_call",id:r.id,name:r.name,args:r.args});return e}function Jx(t){const e=[];typeof t.content=="string"?e.push({type:"text",text:t.content}):e.push(...Vh(t.content));for(const r of t.tool_calls??[])e.push({type:"tool_call",id:r.id,name:r.name,args:r.args});return e}function Vh(t){const e=[];for(const r of t)Hx(r)?e.push(qx(r)):e.push(r);return e}function Zx(t){if(t.type==="url_citation"){const{url:e,title:r,start_index:n,end_index:s}=t;return{type:"citation",url:e,title:r,startIndex:n,endIndex:s}}if(t.type==="file_citation"){const{file_id:e,filename:r,index:n}=t;return{type:"citation",title:r,startIndex:n,endIndex:n,fileId:e}}return t}function aw(t){function*e(){var n;Ee((n=t.additional_kwargs)==null?void 0:n.reasoning)&&un(t.additional_kwargs.reasoning.summary)&&(yield{type:"reasoning",reasoning:t.additional_kwargs.reasoning.summary.reduce((i,a)=>Ee(a)&&re(a.text)?`${i}${a.text}`:i,"")});const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const s of r)if(pe(s,"text")){const{text:i,annotations:a,...o}=s;Array.isArray(a)?yield{...o,type:"text",text:String(i),annotations:a.map(Zx)}:yield{...o,type:"text",text:String(i)}}for(const s of t.tool_calls??[])yield{type:"tool_call",id:s.id,name:s.name,args:s.args};if(Ee(t.additional_kwargs)&&un(t.additional_kwargs.tool_outputs))for(const s of t.additional_kwargs.tool_outputs){if(pe(s,"web_search_call")){yield{id:s.id,type:"server_tool_call",name:"web_search",args:{query:s.query}};continue}else if(pe(s,"file_search_call")){yield{id:s.id,type:"server_tool_call",name:"file_search",args:{query:s.query}};continue}else if(pe(s,"computer_call")){yield{type:"non_standard",value:s};continue}else if(pe(s,"code_interpreter_call")){if(re(s.code)&&(yield{id:s.id,type:"server_tool_call",name:"code_interpreter",args:{code:s.code}}),un(s.outputs)){const i=ua(()=>{if(s.status!=="in_progress"){if(s.status==="completed")return 0;if(s.status==="incomplete")return 127;if(s.status!=="interpreting"&&s.status==="failed")return 1}});for(const a of s.outputs)if(pe(a,"logs")){yield{type:"server_tool_call_result",toolCallId:s.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:i??0,stderr:[0,void 0].includes(i)?void 0:String(a.logs),stdout:[0,void 0].includes(i)?String(a.logs):void 0}};continue}}continue}else if(pe(s,"mcp_call")){yield{id:s.id,type:"server_tool_call",name:"mcp_call",args:s.input};continue}else if(pe(s,"mcp_list_tools")){yield{id:s.id,type:"server_tool_call",name:"mcp_list_tools",args:s.input};continue}else if(pe(s,"mcp_approval_request")){yield{type:"non_standard",value:s};continue}else if(pe(s,"image_generation_call")){yield{type:"non_standard",value:s};continue}Ee(s)&&(yield{type:"non_standard",value:s})}}return Array.from(e())}function Kx(t){function*e(){yield*aw(t);for(const r of t.tool_call_chunks??[])yield{type:"tool_call_chunk",id:r.id,name:r.name,args:r.args}}return Array.from(e())}const Xx={translateContent:t=>typeof t.content=="string"?Wx(t):aw(t),translateContentChunk:t=>typeof t.content=="string"?Jx(t):Kx(t)};function ow(t){return typeof t=="object"&&t!==null&&"type"in t&&"content"in t&&(typeof t.content=="string"||Array.isArray(t.content))}const Cu=Symbol.for("langchain.message");function Ms(t,e){return typeof t=="string"?t===""?e:typeof e=="string"?t+e:Array.isArray(e)&&e.some(r=>Rn(r))?[{type:"text",source_type:"text",text:t},...e]:[{type:"text",text:t},...e]:Array.isArray(e)?Ua(t,e)??[...t,...e]:e===""?t:Array.isArray(t)&&t.some(r=>Rn(r))?[...t,{type:"file",source_type:"text",text:e}]:[...t,{type:"text",text:e}]}function cw(t,e){return t==="error"||e==="error"?"error":"success"}function Yx(t,e){function r(n,s){if(typeof n!="object"||n===null||n===void 0)return n;if(s>=e)return Array.isArray(n)?"[Array]":"[Object]";if(Array.isArray(n))return n.map(a=>r(a,s+1));const i={};for(const a of Object.keys(n))i[a]=r(n[a],s+1);return i}return JSON.stringify(r(t,0),null,2)}var $_,Ir=class extends Or{constructor(e){const r=typeof e=="string"||Array.isArray(e)?{content:e}:e;r.additional_kwargs||(r.additional_kwargs={}),r.response_metadata||(r.response_metadata={});super(r);f(this,"lc_namespace",["langchain_core","messages"]);f(this,"lc_serializable",!0);f(this,$_,!0);f(this,"id");f(this,"name");f(this,"content");f(this,"additional_kwargs");f(this,"response_metadata");this.name=r.name,r.content===void 0&&r.contentBlocks!==void 0?(this.content=r.contentBlocks,this.response_metadata={output_version:"v1",...r.response_metadata}):r.content!==void 0?(this.content=r.content??[],this.response_metadata=r.response_metadata):(this.content=[],this.response_metadata=r.response_metadata),this.additional_kwargs=r.additional_kwargs,this.id=r.id}get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}_getType(){return this.type}getType(){return this._getType()}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}get contentBlocks(){const e=typeof this.content=="string"?[{type:"text",text:this.content}]:this.content;return[Gx,Vh,Fx].reduce((s,i)=>i(s),e)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(e){return typeof e=="object"&&e!==null&&Cu in e&&e[Cu]===!0&&ow(e)}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[($_=Cu,Symbol.toStringTag)](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const r=Yx(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${r}`}};function Qx(t){return Array.isArray(t)&&t.every(e=>typeof e.index=="number")}function Ut(t={},e={}){const r={...t};for(const[n,s]of Object.entries(e))if(r[n]==null)r[n]=s;else{if(s==null)continue;if(typeof r[n]!=typeof s||Array.isArray(r[n])!==Array.isArray(s))throw new Error(`field[${n}] already exists in the message chunk, but with a different type.`);if(typeof r[n]=="string"){if(n==="type")continue;["id","name","output_version","model_provider"].includes(n)?r[n]=s:r[n]+=s}else if(typeof r[n]=="object"&&!Array.isArray(r[n]))r[n]=Ut(r[n],s);else if(Array.isArray(r[n]))r[n]=Ua(r[n],s);else{if(r[n]===s)continue;console.warn(`field[${n}] already exists in this message chunk and value has unsupported type.`)}}return r}function Ua(t,e){if(!(t===void 0&&e===void 0)){if(t===void 0||e===void 0)return t||e;{const r=[...t];for(const n of e)if(typeof n=="object"&&n!==null&&"index"in n&&typeof n.index=="number"){const s=r.findIndex(i=>{const a=typeof i=="object",o="index"in i&&i.index===n.index,c="id"in i&&"id"in n&&(i==null?void 0:i.id)===(n==null?void 0:n.id),u=!("id"in i)||!(i!=null&&i.id)||!("id"in n)||!(n!=null&&n.id);return a&&o&&(c||u)});s!==-1&&typeof r[s]=="object"&&r[s]!==null?r[s]=Ut(r[s],n):r.push(n)}else{if(typeof n=="object"&&n!==null&&"text"in n&&n.text==="")continue;r.push(n)}return r}}}function uw(t,e){if(!t&&!e)throw new Error("Cannot merge two undefined objects.");if(!t||!e)return t||e;if(typeof t!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof t}
Right ${typeof e}`);if(typeof t=="string"&&typeof e=="string")return t+e;if(Array.isArray(t)&&Array.isArray(e))return Ua(t,e);if(typeof t=="object"&&typeof e=="object")return Ut(t,e);if(t===e)return t;throw new Error(`Can not merge objects of different types.
Left ${t}
Right ${e}`)}var Us=class extends Ir{static isInstance(t){return super.isInstance(t)&&"concat"in t&&typeof t.concat=="function"}};function lw(t){return typeof t.role=="string"}function vt(t){return typeof(t==null?void 0:t._getType)=="function"}function la(t){return vt(t)&&typeof t.concat=="function"}var dw={};me(dw,{ToolMessage:()=>On,ToolMessageChunk:()=>Bc,defaultToolCallParser:()=>Hh,isDirectToolOutput:()=>Gh,isToolMessage:()=>qh,isToolMessageChunk:()=>hw});function Gh(t){return t!=null&&typeof t=="object"&&"lc_direct_tool_output"in t&&t.lc_direct_tool_output===!0}var On=class extends Ir{constructor(e,r,n){const s=typeof e=="string"||Array.isArray(e)?{content:e,name:n,tool_call_id:r}:e;super(s);f(this,"lc_direct_tool_output",!0);f(this,"type","tool");f(this,"status");f(this,"tool_call_id");f(this,"metadata");f(this,"artifact");this.tool_call_id=s.tool_call_id,this.artifact=s.artifact,this.status=s.status,this.metadata=s.metadata}static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}static isInstance(e){return super.isInstance(e)&&e.type==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},Bc=class extends Us{constructor(e){super(e);f(this,"type","tool");f(this,"tool_call_id");f(this,"status");f(this,"artifact");this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}concat(e){const r=this.constructor;return new r({content:Ms(this.content,e.content),additional_kwargs:Ut(this.additional_kwargs,e.additional_kwargs),response_metadata:Ut(this.response_metadata,e.response_metadata),artifact:uw(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:cw(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function Hh(t){const e=[],r=[];for(const n of t)if(n.function){const s=n.function.name;try{const i=JSON.parse(n.function.arguments);e.push({name:s||"",args:i||{},id:n.id})}catch{r.push({name:s,args:n.function.arguments,id:n.id,error:"Malformed args."})}}else continue;return[e,r]}function qh(t){return typeof t=="object"&&t!==null&&"getType"in t&&typeof t.getType=="function"&&t.getType()==="tool"}function hw(t){return t._getType()==="tool"}const eT=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Xi(t){return typeof t=="string"&&eT.test(t)}function tT(t){if(!Xi(t))throw TypeError("Invalid UUID");var e,r=new Uint8Array(16);return r[0]=(e=parseInt(t.slice(0,8),16))>>>24,r[1]=e>>>16&255,r[2]=e>>>8&255,r[3]=e&255,r[4]=(e=parseInt(t.slice(9,13),16))>>>8,r[5]=e&255,r[6]=(e=parseInt(t.slice(14,18),16))>>>8,r[7]=e&255,r[8]=(e=parseInt(t.slice(19,23),16))>>>8,r[9]=e&255,r[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,r[11]=e/4294967296&255,r[12]=e>>>24&255,r[13]=e>>>16&255,r[14]=e>>>8&255,r[15]=e&255,r}var kt=[];for(var ku=0;ku<256;++ku)kt.push((ku+256).toString(16).slice(1));function fw(t,e=0){return(kt[t[e+0]]+kt[t[e+1]]+kt[t[e+2]]+kt[t[e+3]]+"-"+kt[t[e+4]]+kt[t[e+5]]+"-"+kt[t[e+6]]+kt[t[e+7]]+"-"+kt[t[e+8]]+kt[t[e+9]]+"-"+kt[t[e+10]]+kt[t[e+11]]+kt[t[e+12]]+kt[t[e+13]]+kt[t[e+14]]+kt[t[e+15]]).toLowerCase()}var no,rT=new Uint8Array(16);function nT(){if(!no&&(no=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!no))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return no(rT)}function sT(t){t=unescape(encodeURIComponent(t));for(var e=[],r=0;r<t.length;++r)e.push(t.charCodeAt(r));return e}var iT="6ba7b810-9dad-11d1-80b4-00c04fd430c8",aT="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function oT(t,e,r){function n(s,i,a,o){var c;if(typeof s=="string"&&(s=sT(s)),typeof i=="string"&&(i=tT(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var u=new Uint8Array(16+s.length);if(u.set(i),u.set(s,i.length),u=r(u),u[6]=u[6]&15|e,u[8]=u[8]&63|128,a){o=o||0;for(var l=0;l<16;++l)a[o+l]=u[l];return a}return fw(u)}try{n.name=t}catch{}return n.DNS=iT,n.URL=aT,n}var cT=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Dp={randomUUID:cT};function wn(t,e,r){if(Dp.randomUUID&&!t)return Dp.randomUUID();t=t||{};var n=t.random||(t.rng||nT)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,fw(n)}function uT(t,e,r,n){switch(t){case 0:return e&r^~e&n;case 1:return e^r^n;case 2:return e&r^e&n^r&n;case 3:return e^r^n}}function Iu(t,e){return t<<e|t>>>32-e}function lT(t){var e=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var n=unescape(encodeURIComponent(t));t=[];for(var s=0;s<n.length;++s)t.push(n.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var i=t.length/4+2,a=Math.ceil(i/16),o=new Array(a),c=0;c<a;++c){for(var u=new Uint32Array(16),l=0;l<16;++l)u[l]=t[c*64+l*4]<<24|t[c*64+l*4+1]<<16|t[c*64+l*4+2]<<8|t[c*64+l*4+3];o[c]=u}o[a-1][14]=(t.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var h=new Uint32Array(80),p=0;p<16;++p)h[p]=o[d][p];for(var m=16;m<80;++m)h[m]=Iu(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var _=r[0],v=r[1],y=r[2],E=r[3],b=r[4],I=0;I<80;++I){var k=Math.floor(I/20),R=Iu(_,5)+uT(k,v,y,E)+b+e[k]+h[I]>>>0;b=E,E=y,y=Iu(v,30)>>>0,v=_,_=R}r[0]=r[0]+_>>>0,r[1]=r[1]+v>>>0,r[2]=r[2]+y>>>0,r[3]=r[3]+E>>>0,r[4]=r[4]+b>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,r[0]&255,r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,r[1]&255,r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,r[2]&255,r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,r[3]&255,r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,r[4]&255]}var Mp=oT("v5",80,lT),pw={};me(pw,{BaseCallbackHandler:()=>Ii,callbackHandlerPrefersStreaming:()=>Wh,isBaseCallbackHandler:()=>mw});var dT=class{};function Wh(t){return"lc_prefer_streaming"in t&&t.lc_prefer_streaming}var Ii=class extends dT{constructor(e){super();f(this,"lc_serializable",!1);f(this,"lc_kwargs");f(this,"ignoreLLM",!1);f(this,"ignoreChain",!1);f(this,"ignoreAgent",!1);f(this,"ignoreRetriever",!1);f(this,"ignoreCustomEvent",!1);f(this,"raiseError",!1);f(this,"awaitHandlers",cn("LANGCHAIN_CALLBACKS_BACKGROUND")==="false");this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Mc(this.constructor)]}copy(){return new this.constructor(this)}toJSON(){return Or.prototype.toJSON.call(this)}toJSONNotImplemented(){return Or.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class r extends Ii{constructor(){super();f(this,"name",wn());Object.assign(this,e)}}return new r}};const mw=t=>{const e=t;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"},hT=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function fT(t){return typeof t=="string"&&hT.test(t)}function pT(t){if(!fT(t))throw TypeError("Invalid UUID");var e,r=new Uint8Array(16);return r[0]=(e=parseInt(t.slice(0,8),16))>>>24,r[1]=e>>>16&255,r[2]=e>>>8&255,r[3]=e&255,r[4]=(e=parseInt(t.slice(9,13),16))>>>8,r[5]=e&255,r[6]=(e=parseInt(t.slice(14,18),16))>>>8,r[7]=e&255,r[8]=(e=parseInt(t.slice(19,23),16))>>>8,r[9]=e&255,r[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,r[11]=e/4294967296&255,r[12]=e>>>24&255,r[13]=e>>>16&255,r[14]=e>>>8&255,r[15]=e&255,r}var It=[];for(var Ru=0;Ru<256;++Ru)It.push((Ru+256).toString(16).slice(1));function gw(t,e=0){return(It[t[e+0]]+It[t[e+1]]+It[t[e+2]]+It[t[e+3]]+"-"+It[t[e+4]]+It[t[e+5]]+"-"+It[t[e+6]]+It[t[e+7]]+"-"+It[t[e+8]]+It[t[e+9]]+"-"+It[t[e+10]]+It[t[e+11]]+It[t[e+12]]+It[t[e+13]]+It[t[e+14]]+It[t[e+15]]).toLowerCase()}var so,mT=new Uint8Array(16);function gT(){if(!so&&(so=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!so))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return so(mT)}function yT(t){t=unescape(encodeURIComponent(t));for(var e=[],r=0;r<t.length;++r)e.push(t.charCodeAt(r));return e}var _T="6ba7b810-9dad-11d1-80b4-00c04fd430c8",wT="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function vT(t,e,r){function n(s,i,a,o){var c;if(typeof s=="string"&&(s=yT(s)),typeof i=="string"&&(i=pT(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var u=new Uint8Array(16+s.length);if(u.set(i),u.set(s,i.length),u=r(u),u[6]=u[6]&15|e,u[8]=u[8]&63|128,a){o=o||0;for(var l=0;l<16;++l)a[o+l]=u[l];return a}return gw(u)}try{n.name=t}catch{}return n.DNS=_T,n.URL=wT,n}var bT=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Up={randomUUID:bT};function Js(t,e,r){if(Up.randomUUID&&!t)return Up.randomUUID();t=t||{};var n=t.random||(t.rng||gT)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,gw(n)}function ET(t,e,r,n){switch(t){case 0:return e&r^~e&n;case 1:return e^r^n;case 2:return e&r^e&n^r&n;case 3:return e^r^n}}function Ou(t,e){return t<<e|t>>>32-e}function ST(t){var e=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var n=unescape(encodeURIComponent(t));t=[];for(var s=0;s<n.length;++s)t.push(n.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var i=t.length/4+2,a=Math.ceil(i/16),o=new Array(a),c=0;c<a;++c){for(var u=new Uint32Array(16),l=0;l<16;++l)u[l]=t[c*64+l*4]<<24|t[c*64+l*4+1]<<16|t[c*64+l*4+2]<<8|t[c*64+l*4+3];o[c]=u}o[a-1][14]=(t.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var h=new Uint32Array(80),p=0;p<16;++p)h[p]=o[d][p];for(var m=16;m<80;++m)h[m]=Ou(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var _=r[0],v=r[1],y=r[2],E=r[3],b=r[4],I=0;I<80;++I){var k=Math.floor(I/20),R=Ou(_,5)+ET(k,v,y,E)+b+e[k]+h[I]>>>0;b=E,E=y,y=Ou(v,30)>>>0,v=_,_=R}r[0]=r[0]+_>>>0,r[1]=r[1]+v>>>0,r[2]=r[2]+y>>>0,r[3]=r[3]+E>>>0,r[4]=r[4]+b>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,r[0]&255,r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,r[1]&255,r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,r[2]&255,r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,r[3]&255,r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,r[4]&255]}var Bp=vT("v5",80,ST);const xT="gen_ai.operation.name",TT="gen_ai.system",Fp="gen_ai.request.model",AT="gen_ai.response.model",jp="gen_ai.usage.input_tokens",zp="gen_ai.usage.output_tokens",Vp="gen_ai.usage.total_tokens",CT="gen_ai.request.max_tokens",kT="gen_ai.request.temperature",IT="gen_ai.request.top_p",RT="gen_ai.request.frequency_penalty",OT="gen_ai.request.presence_penalty",NT="gen_ai.response.finish_reasons",$T="gen_ai.prompt",PT="gen_ai.completion",LT="gen_ai.request.extra_query",DT="gen_ai.request.extra_body",MT="gen_ai.serialized.name",UT="gen_ai.serialized.signature",BT="gen_ai.serialized.doc",FT="gen_ai.response.id",jT="gen_ai.response.service_tier",zT="gen_ai.response.system_fingerprint",VT="gen_ai.usage.input_token_details",GT="gen_ai.usage.output_token_details",HT="langsmith.trace.session_id",qT="langsmith.trace.session_name",WT="langsmith.span.kind",JT="langsmith.trace.name",ZT="langsmith.metadata",Gp="langsmith.span.tags",KT="langsmith.request.streaming",XT="langsmith.request.headers",YT=(...t)=>fetch(...t),yw=Symbol.for("ls:fetch_implementation"),QT=()=>{const t=globalThis[yw];return t?typeof t=="function"&&"Headers"in t&&"Request"in t&&"Response"in t:!1},eA=t=>async(...e)=>{if(t||Qt("DEBUG")==="true"){const[n,s]=e;console.log(`→ ${(s==null?void 0:s.method)||"GET"} ${n}`)}const r=await(globalThis[yw]??YT)(...e);return(t||Qt("DEBUG")==="true")&&console.log(`← ${r.status} ${r.statusText} ${r.url}`),r},_w=()=>Qt("PROJECT")??fn("LANGCHAIN_SESSION")??"default",ww="0.3.74";var Yi={};let Jr;const tA=()=>typeof window<"u"&&typeof window.document<"u",rA=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",nA=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),vw=()=>typeof Deno<"u",sA=()=>typeof on<"u"&&typeof on.versions<"u"&&typeof on.versions.node<"u"&&!vw(),bw=()=>Jr||(typeof Bun<"u"?Jr="bun":tA()?Jr="browser":sA()?Jr="node":rA()?Jr="webworker":nA()?Jr="jsdom":vw()?Jr="deno":Jr="other",Jr);let Nu;function Ew(){if(Nu===void 0){const t=bw(),e=aA();Nu={library:"langsmith",runtime:t,sdk:"langsmith-js",sdk_version:ww,...e}}return Nu}function Sw(){const t=iA(),e={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[n,s]of Object.entries(t))typeof s=="string"&&!r.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[n]=s);return e}function iA(){const t={};try{if(typeof on<"u"&&Yi)for(const[e,r]of Object.entries(Yi))(e.startsWith("LANGCHAIN_")||e.startsWith("LANGSMITH_"))&&r!=null&&((e.toLowerCase().includes("key")||e.toLowerCase().includes("secret")||e.toLowerCase().includes("token"))&&typeof r=="string"?t[e]=r.slice(0,2)+"*".repeat(r.length-4)+r.slice(-2):t[e]=r)}catch{}return t}function fn(t){try{return typeof on<"u"?Yi==null?void 0:Yi[t]:void 0}catch{return}}function Qt(t){return fn(`LANGSMITH_${t}`)||fn(`LANGCHAIN_${t}`)}let $u;function aA(){if($u!==void 0)return $u;const t=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const r of t){const n=fn(r);n!==void 0&&(e[r]=n)}return $u=e,e}function xw(){return fn("OTEL_ENABLED")==="true"||Qt("OTEL_ENABLED")==="true"}class oA{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...r){!this.hasWarned&&xw()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let n;if(r.length===1&&typeof r[0]=="function"?n=r[0]:r.length===2&&typeof r[1]=="function"?n=r[1]:r.length===3&&typeof r[2]=="function"&&(n=r[2]),typeof n=="function")return n()}}class cA{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new oA})}getTracer(e,r){return this.mockTracer}getActiveSpan(){}setSpan(e,r){return e}getSpan(e){}setSpanContext(e,r){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}}class uA{active(){return{}}with(e,r){return r()}}const Pu=Symbol.for("ls:otel_trace"),Lu=Symbol.for("ls:otel_context"),Hp=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),lA=new cA,dA=new uA;class hA{getTraceInstance(){return globalThis[Pu]??lA}getContextInstance(){return globalThis[Lu]??dA}initializeGlobalInstances(e){globalThis[Pu]===void 0&&(globalThis[Pu]=e.trace),globalThis[Lu]===void 0&&(globalThis[Lu]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[Hp]=e}getDefaultOTLPTracerComponents(){return globalThis[Hp]??void 0}}const Jh=new hA;function Tw(){return Jh.getTraceInstance()}function fA(){return Jh.getContextInstance()}function pA(){return Jh.getDefaultOTLPTracerComponents()}const mA={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function gA(t){return mA[t]||t}class yA{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,r){for(const n of e)try{if(!n.run)continue;if(n.operation==="post"){const s=this.createSpanForRun(n,n.run,r.get(n.id));s&&!n.run.end_time&&this.spans.set(n.id,s)}else this.updateSpanForRun(n,n.run)}catch(s){console.error(`Error processing operation ${n.id}:`,s)}}createSpanForRun(e,r,n){const s=n&&Tw().getSpan(n);if(s)try{return this.finishSpanSetup(s,r,e)}catch(i){console.error(`Failed to create span for run ${e.id}:`,i);return}}finishSpanSetup(e,r,n){return this.setSpanAttributes(e,r,n),r.error?(e.setStatus({code:2}),e.recordException(new Error(r.error))):e.setStatus({code:1}),r.end_time&&e.end(new Date(r.end_time)),e}updateSpanForRun(e,r){try{const n=this.spans.get(e.id);if(!n){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(n,r,e),r.error?(n.setStatus({code:2}),n.recordException(new Error(r.error))):n.setStatus({code:1});const s=r.end_time;s&&(n.end(new Date(s)),this.spans.delete(e.id))}catch(n){console.error(`Failed to update span for run ${e.id}:`,n)}}extractModelName(e){var r;if((r=e.extra)!=null&&r.metadata){const n=e.extra.metadata;if(n.ls_model_name)return n.ls_model_name;if(n.invocation_params){const s=n.invocation_params;if(s.model)return s.model;if(s.model_name)return s.model_name}}}setSpanAttributes(e,r,n){var o;if("run_type"in r&&r.run_type){e.setAttribute(WT,r.run_type);const c=gA(r.run_type||"chain");e.setAttribute(xT,c)}"name"in r&&r.name&&e.setAttribute(JT,r.name),"session_id"in r&&r.session_id&&e.setAttribute(HT,r.session_id),"session_name"in r&&r.session_name&&e.setAttribute(qT,r.session_name),this.setGenAiSystem(e,r);const s=this.extractModelName(r);s&&e.setAttribute(Fp,s),"prompt_tokens"in r&&typeof r.prompt_tokens=="number"&&e.setAttribute(jp,r.prompt_tokens),"completion_tokens"in r&&typeof r.completion_tokens=="number"&&e.setAttribute(zp,r.completion_tokens),"total_tokens"in r&&typeof r.total_tokens=="number"&&e.setAttribute(Vp,r.total_tokens),this.setInvocationParameters(e,r);const i=((o=r.extra)==null?void 0:o.metadata)||{};for(const[c,u]of Object.entries(i))u!=null&&e.setAttribute(`${ZT}.${c}`,String(u));const a=r.tags;if(a&&Array.isArray(a)?e.setAttribute(Gp,a.join(", ")):a&&e.setAttribute(Gp,String(a)),"serialized"in r&&typeof r.serialized=="object"){const c=r.serialized;c.name&&e.setAttribute(MT,String(c.name)),c.signature&&e.setAttribute(UT,String(c.signature)),c.doc&&e.setAttribute(BT,String(c.doc))}this.setIOAttributes(e,n)}setGenAiSystem(e,r){let n="langchain";const s=this.extractModelName(r);if(s){const i=s.toLowerCase();i.includes("anthropic")||i.startsWith("claude")?n="anthropic":i.includes("bedrock")?n="aws.bedrock":i.includes("azure")&&i.includes("openai")?n="az.ai.openai":i.includes("azure")&&i.includes("inference")?n="az.ai.inference":i.includes("cohere")?n="cohere":i.includes("deepseek")?n="deepseek":i.includes("gemini")?n="gemini":i.includes("groq")?n="groq":i.includes("watson")||i.includes("ibm")?n="ibm.watsonx.ai":i.includes("mistral")?n="mistral_ai":i.includes("gpt")||i.includes("openai")?n="openai":i.includes("perplexity")||i.includes("sonar")?n="perplexity":i.includes("vertex")?n="vertex_ai":(i.includes("xai")||i.includes("grok"))&&(n="xai")}e.setAttribute(TT,n)}setInvocationParameters(e,r){var s,i;if(!((i=(s=r.extra)==null?void 0:s.metadata)!=null&&i.invocation_params))return;const n=r.extra.metadata.invocation_params;n.max_tokens!==void 0&&e.setAttribute(CT,n.max_tokens),n.temperature!==void 0&&e.setAttribute(kT,n.temperature),n.top_p!==void 0&&e.setAttribute(IT,n.top_p),n.frequency_penalty!==void 0&&e.setAttribute(RT,n.frequency_penalty),n.presence_penalty!==void 0&&e.setAttribute(OT,n.presence_penalty)}setIOAttributes(e,r){if(r.run.inputs)try{const n=r.run.inputs;typeof n=="object"&&n!==null&&(n.model&&Array.isArray(n.messages)&&e.setAttribute(Fp,n.model),n.stream!==void 0&&e.setAttribute(KT,n.stream),n.extra_headers&&e.setAttribute(XT,JSON.stringify(n.extra_headers)),n.extra_query&&e.setAttribute(LT,JSON.stringify(n.extra_query)),n.extra_body&&e.setAttribute(DT,JSON.stringify(n.extra_body))),e.setAttribute($T,JSON.stringify(n))}catch(n){console.debug(`Failed to process inputs for run ${r.id}`,n)}if(r.run.outputs)try{const n=r.run.outputs,s=this.getUnifiedRunTokens(n);if(s&&(e.setAttribute(jp,s[0]),e.setAttribute(zp,s[1]),e.setAttribute(Vp,s[0]+s[1])),n&&typeof n=="object"){if(n.model&&e.setAttribute(AT,String(n.model)),n.id&&e.setAttribute(FT,n.id),n.choices&&Array.isArray(n.choices)){const i=n.choices.map(a=>a.finish_reason).filter(a=>a).map(String);i.length>0&&e.setAttribute(NT,i.join(", "))}if(n.service_tier&&e.setAttribute(jT,n.service_tier),n.system_fingerprint&&e.setAttribute(zT,n.system_fingerprint),n.usage_metadata&&typeof n.usage_metadata=="object"){const i=n.usage_metadata;i.input_token_details&&e.setAttribute(VT,JSON.stringify(i.input_token_details)),i.output_token_details&&e.setAttribute(GT,JSON.stringify(i.output_token_details))}}e.setAttribute(PT,JSON.stringify(n))}catch(n){console.debug(`Failed to process outputs for run ${r.id}`,n)}}getUnifiedRunTokens(e){if(!e)return null;let r=this.extractUnifiedRunTokens(e.usage_metadata);if(r)return r;const n=Object.keys(e);for(const a of n){const o=e[a];if(!(!o||typeof o!="object")&&(r=this.extractUnifiedRunTokens(o.usage_metadata),r||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(r=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),r)))return r}const s=e.generations||[];if(!Array.isArray(s))return null;const i=Array.isArray(s[0])?s.flat():s;for(const a of i)if(typeof a=="object"&&a.message&&typeof a.message=="object"&&a.message.kwargs&&typeof a.message.kwargs=="object"&&(r=this.extractUnifiedRunTokens(a.message.kwargs.usage_metadata),r))return r;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}var Mi={exports:{}},Du={},Mu,qp;function _A(){if(qp)return Mu;qp=1;function t(e,r){typeof r=="boolean"&&(r={forever:r}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=r||{},this._maxRetryTime=r&&r.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return Mu=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var r=new Date().getTime();if(e&&r-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},n),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,r){this._fn=e,r&&(r.timeout&&(this._operationTimeout=r.timeout),r.cb&&(this._operationTimeoutCb=r.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},r=null,n=0,s=0;s<this._errors.length;s++){var i=this._errors[s],a=i.message,o=(e[a]||0)+1;e[a]=o,o>=n&&(r=i,n=o)}return r},Mu}var Wp;function wA(){return Wp||(Wp=1,(function(t){var e=_A();t.operation=function(r){var n=t.timeouts(r);return new e(n,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})},t.timeouts=function(r){if(r instanceof Array)return[].concat(r);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in r)n[s]=r[s];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],a=0;a<n.retries;a++)i.push(this.createTimeout(a,n));return r&&r.forever&&!i.length&&i.push(this.createTimeout(a,n)),i.sort(function(o,c){return o-c}),i},t.createTimeout=function(r,n){var s=n.randomize?Math.random()+1:1,i=Math.round(s*Math.max(n.minTimeout,1)*Math.pow(n.factor,r));return i=Math.min(i,n.maxTimeout),i},t.wrap=function(r,n,s){if(n instanceof Array&&(s=n,n=null),!s){s=[];for(var i in r)typeof r[i]=="function"&&s.push(i)}for(var a=0;a<s.length;a++){var o=s[a],c=r[o];r[o]=(function(l){var d=t.operation(n),h=Array.prototype.slice.call(arguments,1),p=h.pop();h.push(function(m){d.retry(m)||(m&&(arguments[0]=d.mainError()),p.apply(this,arguments))}),d.attempt(function(){l.apply(r,h)})}).bind(r,c),r[o].options=n}}})(Du)),Du}var Uu,Jp;function vA(){return Jp||(Jp=1,Uu=wA()),Uu}var Zp;function bA(){if(Zp)return Mi.exports;Zp=1;const t=vA(),e=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class r extends Error{constructor(o){super(),o instanceof Error?(this.originalError=o,{message:o}=o):(this.originalError=new Error(o),this.originalError.stack=this.stack),this.name="AbortError",this.message=o}}const n=(a,o,c)=>{const u=c.retries-(o-1);return a.attemptNumber=o,a.retriesLeft=u,a},s=a=>e.includes(a),i=(a,o)=>new Promise((c,u)=>{o={onFailedAttempt:()=>{},retries:10,...o};const l=t.operation(o);l.attempt(async d=>{try{c(await a(d))}catch(h){if(!(h instanceof Error)){u(new TypeError(`Non-error was thrown: "${h}". You should only throw errors.`));return}if(h instanceof r)l.stop(),u(h.originalError);else if(h instanceof TypeError&&!s(h.message))l.stop(),u(h);else{n(h,d,o);try{await o.onFailedAttempt(h)}catch(p){u(p);return}l.retry(h)||u(l.mainError())}}})});return Mi.exports=i,Mi.exports.default=i,Mi.exports.AbortError=r,Mi.exports}var EA=bA();const Qo=ki(EA);var io={},Bu={exports:{}},Kp;function SA(){return Kp||(Kp=1,(function(t){var e=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function s(c,u,l){this.fn=c,this.context=u,this.once=l||!1}function i(c,u,l,d,h){if(typeof l!="function")throw new TypeError("The listener must be a function");var p=new s(l,d||c,h),m=r?r+u:u;return c._events[m]?c._events[m].fn?c._events[m]=[c._events[m],p]:c._events[m].push(p):(c._events[m]=p,c._eventsCount++),c}function a(c,u){--c._eventsCount===0?c._events=new n:delete c._events[u]}function o(){this._events=new n,this._eventsCount=0}o.prototype.eventNames=function(){var u=[],l,d;if(this._eventsCount===0)return u;for(d in l=this._events)e.call(l,d)&&u.push(r?d.slice(1):d);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(l)):u},o.prototype.listeners=function(u){var l=r?r+u:u,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,p=d.length,m=new Array(p);h<p;h++)m[h]=d[h].fn;return m},o.prototype.listenerCount=function(u){var l=r?r+u:u,d=this._events[l];return d?d.fn?1:d.length:0},o.prototype.emit=function(u,l,d,h,p,m){var _=r?r+u:u;if(!this._events[_])return!1;var v=this._events[_],y=arguments.length,E,b;if(v.fn){switch(v.once&&this.removeListener(u,v.fn,void 0,!0),y){case 1:return v.fn.call(v.context),!0;case 2:return v.fn.call(v.context,l),!0;case 3:return v.fn.call(v.context,l,d),!0;case 4:return v.fn.call(v.context,l,d,h),!0;case 5:return v.fn.call(v.context,l,d,h,p),!0;case 6:return v.fn.call(v.context,l,d,h,p,m),!0}for(b=1,E=new Array(y-1);b<y;b++)E[b-1]=arguments[b];v.fn.apply(v.context,E)}else{var I=v.length,k;for(b=0;b<I;b++)switch(v[b].once&&this.removeListener(u,v[b].fn,void 0,!0),y){case 1:v[b].fn.call(v[b].context);break;case 2:v[b].fn.call(v[b].context,l);break;case 3:v[b].fn.call(v[b].context,l,d);break;case 4:v[b].fn.call(v[b].context,l,d,h);break;default:if(!E)for(k=1,E=new Array(y-1);k<y;k++)E[k-1]=arguments[k];v[b].fn.apply(v[b].context,E)}}return!0},o.prototype.on=function(u,l,d){return i(this,u,l,d,!1)},o.prototype.once=function(u,l,d){return i(this,u,l,d,!0)},o.prototype.removeListener=function(u,l,d,h){var p=r?r+u:u;if(!this._events[p])return this;if(!l)return a(this,p),this;var m=this._events[p];if(m.fn)m.fn===l&&(!h||m.once)&&(!d||m.context===d)&&a(this,p);else{for(var _=0,v=[],y=m.length;_<y;_++)(m[_].fn!==l||h&&!m[_].once||d&&m[_].context!==d)&&v.push(m[_]);v.length?this._events[p]=v.length===1?v[0]:v:a(this,p)}return this},o.prototype.removeAllListeners=function(u){var l;return u?(l=r?r+u:u,this._events[l]&&a(this,l)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,t.exports=o})(Bu)),Bu.exports}var Ui={exports:{}},Fu,Xp;function xA(){return Xp||(Xp=1,Fu=(t,e)=>(e=e||(()=>{}),t.then(r=>new Promise(n=>{n(e())}).then(()=>r),r=>new Promise(n=>{n(e())}).then(()=>{throw r})))),Fu}var Yp;function TA(){if(Yp)return Ui.exports;Yp=1;const t=xA();class e extends Error{constructor(s){super(s),this.name="TimeoutError"}}const r=(n,s,i)=>new Promise((a,o)=>{if(typeof s!="number"||s<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(s===1/0){a(n);return}const c=setTimeout(()=>{if(typeof i=="function"){try{a(i())}catch(d){o(d)}return}const u=typeof i=="string"?i:`Promise timed out after ${s} milliseconds`,l=i instanceof Error?i:new e(u);typeof n.cancel=="function"&&n.cancel(),o(l)},s);t(n.then(a,o),()=>{clearTimeout(c)})});return Ui.exports=r,Ui.exports.default=r,Ui.exports.TimeoutError=e,Ui.exports}var ao={},oo={},Qp;function AA(){if(Qp)return oo;Qp=1,Object.defineProperty(oo,"__esModule",{value:!0});function t(e,r,n){let s=0,i=e.length;for(;i>0;){const a=i/2|0;let o=s+a;n(e[o],r)<=0?(s=++o,i-=a+1):i=a}return s}return oo.default=t,oo}var em;function CA(){if(em)return ao;em=1,Object.defineProperty(ao,"__esModule",{value:!0});const t=AA();class e{constructor(){this._queue=[]}enqueue(n,s){s=Object.assign({priority:0},s);const i={priority:s.priority,run:n};if(this.size&&this._queue[this.size-1].priority>=s.priority){this._queue.push(i);return}const a=t.default(this._queue,i,(o,c)=>c.priority-o.priority);this._queue.splice(a,0,i)}dequeue(){const n=this._queue.shift();return n==null?void 0:n.run}filter(n){return this._queue.filter(s=>s.priority===n.priority).map(s=>s.run)}get size(){return this._queue.length}}return ao.default=e,ao}var tm;function kA(){if(tm)return io;tm=1,Object.defineProperty(io,"__esModule",{value:!0});const t=SA(),e=TA(),r=CA(),n=()=>{},s=new e.TimeoutError;class i extends t{constructor(o){var c,u,l,d;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=n,this._resolveIdle=n,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:r.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(u=(c=o.intervalCap)===null||c===void 0?void 0:c.toString())!==null&&u!==void 0?u:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(d=(l=o.interval)===null||l===void 0?void 0:l.toString())!==null&&d!==void 0?d:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=n,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=n,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const o=Date.now();if(this._intervalId===void 0){const c=this._intervalEnd-o;if(c<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},c)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const c=this._queue.dequeue();return c?(this.emit("active"),c(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,c={}){return new Promise((u,l)=>{const d=async()=>{this._pendingCount++,this._intervalCount++;try{const h=this._timeout===void 0&&c.timeout===void 0?o():e.default(Promise.resolve(o()),c.timeout===void 0?this._timeout:c.timeout,()=>{(c.throwOnTimeout===void 0?this._throwOnTimeout:c.throwOnTimeout)&&l(s)});u(await h)}catch(h){l(h)}this._next()};this._queue.enqueue(d,c),this._tryToStartAnother(),this.emit("add")})}async addAll(o,c){return Promise.all(o.map(async u=>this.add(u,c)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{const c=this._resolveEmpty;this._resolveEmpty=()=>{c(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{const c=this._resolveIdle;this._resolveIdle=()=>{c(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}}return io.default=i,io}var IA=kA();const An=ki(IA),RA=[429,500,502,503,504];let rm=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in An?this.queue=new An.default({concurrency:this.maxConcurrency}):this.queue=new An({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...r){const n=this.onFailedResponseHook;return this.queue.add(()=>Qo(()=>e(...r).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.name==="TimeoutError"||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;const i=s==null?void 0:s.response;if(n&&await n(i))return;const a=(i==null?void 0:i.status)??(s==null?void 0:s.status);if(a&&!RA.includes(+a))throw s},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,r,...n){return e.signal?Promise.race([this.call(r,...n),new Promise((s,i)=>{var a;(a=e.signal)==null||a.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(r,...n)}};function nm(t){return typeof(t==null?void 0:t._getType)=="function"}function sm(t){const e={type:t._getType(),data:{content:t.content}};return t!=null&&t.additional_kwargs&&Object.keys(t.additional_kwargs).length>0&&(e.data.additional_kwargs={...t.additional_kwargs}),e}const OA=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function xe(t,e){if(!OA.test(t)){const r=e!==void 0?`Invalid UUID for ${e}: ${t}`:`Invalid UUID: ${t}`;throw new Error(r)}return t}const im={};function xd(t){im[t]||(console.warn(t),im[t]=!0)}var co={exports:{}},ju,am;function Fc(){if(am)return ju;am=1;const t="2.0.0",e=256,r=Number.MAX_SAFE_INTEGER||9007199254740991,n=16,s=e-6;return ju={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:s,MAX_SAFE_INTEGER:r,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:t,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},ju}var zu,om;function jc(){if(om)return zu;om=1;var t={};return zu=typeof on=="object"&&t&&t.NODE_DEBUG&&/\bsemver\b/i.test(t.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{},zu}var cm;function Ba(){return cm||(cm=1,(function(t,e){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:s}=Fc(),i=jc();e=t.exports={};const a=e.re=[],o=e.safeRe=[],c=e.src=[],u=e.safeSrc=[],l=e.t={};let d=0;const h="[a-zA-Z0-9-]",p=[["\\s",1],["\\d",s],[h,n]],m=v=>{for(const[y,E]of p)v=v.split(`${y}*`).join(`${y}{0,${E}}`).split(`${y}+`).join(`${y}{1,${E}}`);return v},_=(v,y,E)=>{const b=m(y),I=d++;i(v,I,y),l[v]=I,c[I]=y,u[I]=b,a[I]=new RegExp(y,E?"g":void 0),o[I]=new RegExp(b,E?"g":void 0)};_("NUMERICIDENTIFIER","0|[1-9]\\d*"),_("NUMERICIDENTIFIERLOOSE","\\d+"),_("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),_("MAINVERSION",`(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})`),_("MAINVERSIONLOOSE",`(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})`),_("PRERELEASEIDENTIFIER",`(?:${c[l.NONNUMERICIDENTIFIER]}|${c[l.NUMERICIDENTIFIER]})`),_("PRERELEASEIDENTIFIERLOOSE",`(?:${c[l.NONNUMERICIDENTIFIER]}|${c[l.NUMERICIDENTIFIERLOOSE]})`),_("PRERELEASE",`(?:-(${c[l.PRERELEASEIDENTIFIER]}(?:\\.${c[l.PRERELEASEIDENTIFIER]})*))`),_("PRERELEASELOOSE",`(?:-?(${c[l.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[l.PRERELEASEIDENTIFIERLOOSE]})*))`),_("BUILDIDENTIFIER",`${h}+`),_("BUILD",`(?:\\+(${c[l.BUILDIDENTIFIER]}(?:\\.${c[l.BUILDIDENTIFIER]})*))`),_("FULLPLAIN",`v?${c[l.MAINVERSION]}${c[l.PRERELEASE]}?${c[l.BUILD]}?`),_("FULL",`^${c[l.FULLPLAIN]}$`),_("LOOSEPLAIN",`[v=\\s]*${c[l.MAINVERSIONLOOSE]}${c[l.PRERELEASELOOSE]}?${c[l.BUILD]}?`),_("LOOSE",`^${c[l.LOOSEPLAIN]}$`),_("GTLT","((?:<|>)?=?)"),_("XRANGEIDENTIFIERLOOSE",`${c[l.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),_("XRANGEIDENTIFIER",`${c[l.NUMERICIDENTIFIER]}|x|X|\\*`),_("XRANGEPLAIN",`[v=\\s]*(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:${c[l.PRERELEASE]})?${c[l.BUILD]}?)?)?`),_("XRANGEPLAINLOOSE",`[v=\\s]*(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:${c[l.PRERELEASELOOSE]})?${c[l.BUILD]}?)?)?`),_("XRANGE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAIN]}$`),_("XRANGELOOSE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAINLOOSE]}$`),_("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),_("COERCE",`${c[l.COERCEPLAIN]}(?:$|[^\\d])`),_("COERCEFULL",c[l.COERCEPLAIN]+`(?:${c[l.PRERELEASE]})?(?:${c[l.BUILD]})?(?:$|[^\\d])`),_("COERCERTL",c[l.COERCE],!0),_("COERCERTLFULL",c[l.COERCEFULL],!0),_("LONETILDE","(?:~>?)"),_("TILDETRIM",`(\\s*)${c[l.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",_("TILDE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAIN]}$`),_("TILDELOOSE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAINLOOSE]}$`),_("LONECARET","(?:\\^)"),_("CARETTRIM",`(\\s*)${c[l.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",_("CARET",`^${c[l.LONECARET]}${c[l.XRANGEPLAIN]}$`),_("CARETLOOSE",`^${c[l.LONECARET]}${c[l.XRANGEPLAINLOOSE]}$`),_("COMPARATORLOOSE",`^${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]})$|^$`),_("COMPARATOR",`^${c[l.GTLT]}\\s*(${c[l.FULLPLAIN]})$|^$`),_("COMPARATORTRIM",`(\\s*)${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]}|${c[l.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",_("HYPHENRANGE",`^\\s*(${c[l.XRANGEPLAIN]})\\s+-\\s+(${c[l.XRANGEPLAIN]})\\s*$`),_("HYPHENRANGELOOSE",`^\\s*(${c[l.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[l.XRANGEPLAINLOOSE]})\\s*$`),_("STAR","(<|>)?=?\\s*\\*"),_("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),_("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(co,co.exports)),co.exports}var Vu,um;function Zh(){if(um)return Vu;um=1;const t=Object.freeze({loose:!0}),e=Object.freeze({});return Vu=n=>n?typeof n!="object"?t:n:e,Vu}var Gu,lm;function Aw(){if(lm)return Gu;lm=1;const t=/^[0-9]+$/,e=(n,s)=>{if(typeof n=="number"&&typeof s=="number")return n===s?0:n<s?-1:1;const i=t.test(n),a=t.test(s);return i&&a&&(n=+n,s=+s),n===s?0:i&&!a?-1:a&&!i?1:n<s?-1:1};return Gu={compareIdentifiers:e,rcompareIdentifiers:(n,s)=>e(s,n)},Gu}var Hu,dm;function qt(){if(dm)return Hu;dm=1;const t=jc(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:r}=Fc(),{safeRe:n,t:s}=Ba(),i=Zh(),{compareIdentifiers:a}=Aw();class o{constructor(u,l){if(l=i(l),u instanceof o){if(u.loose===!!l.loose&&u.includePrerelease===!!l.includePrerelease)return u;u=u.version}else if(typeof u!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof u}".`);if(u.length>e)throw new TypeError(`version is longer than ${e} characters`);t("SemVer",u,l),this.options=l,this.loose=!!l.loose,this.includePrerelease=!!l.includePrerelease;const d=u.trim().match(l.loose?n[s.LOOSE]:n[s.FULL]);if(!d)throw new TypeError(`Invalid Version: ${u}`);if(this.raw=u,this.major=+d[1],this.minor=+d[2],this.patch=+d[3],this.major>r||this.major<0)throw new TypeError("Invalid major version");if(this.minor>r||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>r||this.patch<0)throw new TypeError("Invalid patch version");d[4]?this.prerelease=d[4].split(".").map(h=>{if(/^[0-9]+$/.test(h)){const p=+h;if(p>=0&&p<r)return p}return h}):this.prerelease=[],this.build=d[5]?d[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(u){if(t("SemVer.compare",this.version,this.options,u),!(u instanceof o)){if(typeof u=="string"&&u===this.version)return 0;u=new o(u,this.options)}return u.version===this.version?0:this.compareMain(u)||this.comparePre(u)}compareMain(u){return u instanceof o||(u=new o(u,this.options)),this.major<u.major?-1:this.major>u.major?1:this.minor<u.minor?-1:this.minor>u.minor?1:this.patch<u.patch?-1:this.patch>u.patch?1:0}comparePre(u){if(u instanceof o||(u=new o(u,this.options)),this.prerelease.length&&!u.prerelease.length)return-1;if(!this.prerelease.length&&u.prerelease.length)return 1;if(!this.prerelease.length&&!u.prerelease.length)return 0;let l=0;do{const d=this.prerelease[l],h=u.prerelease[l];if(t("prerelease compare",l,d,h),d===void 0&&h===void 0)return 0;if(h===void 0)return 1;if(d===void 0)return-1;if(d===h)continue;return a(d,h)}while(++l)}compareBuild(u){u instanceof o||(u=new o(u,this.options));let l=0;do{const d=this.build[l],h=u.build[l];if(t("build compare",l,d,h),d===void 0&&h===void 0)return 0;if(h===void 0)return 1;if(d===void 0)return-1;if(d===h)continue;return a(d,h)}while(++l)}inc(u,l,d){if(u.startsWith("pre")){if(!l&&d===!1)throw new Error("invalid increment argument: identifier is empty");if(l){const h=`-${l}`.match(this.options.loose?n[s.PRERELEASELOOSE]:n[s.PRERELEASE]);if(!h||h[1]!==l)throw new Error(`invalid identifier: ${l}`)}}switch(u){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",l,d);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",l,d);break;case"prepatch":this.prerelease.length=0,this.inc("patch",l,d),this.inc("pre",l,d);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",l,d),this.inc("pre",l,d);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const h=Number(d)?1:0;if(this.prerelease.length===0)this.prerelease=[h];else{let p=this.prerelease.length;for(;--p>=0;)typeof this.prerelease[p]=="number"&&(this.prerelease[p]++,p=-2);if(p===-1){if(l===this.prerelease.join(".")&&d===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(h)}}if(l){let p=[l,h];d===!1&&(p=[l]),a(this.prerelease[0],l)===0?isNaN(this.prerelease[1])&&(this.prerelease=p):this.prerelease=p}break}default:throw new Error(`invalid increment argument: ${u}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return Hu=o,Hu}var qu,hm;function Ri(){if(hm)return qu;hm=1;const t=qt();return qu=(r,n,s=!1)=>{if(r instanceof t)return r;try{return new t(r,n)}catch(i){if(!s)return null;throw i}},qu}var Wu,fm;function NA(){if(fm)return Wu;fm=1;const t=Ri();return Wu=(r,n)=>{const s=t(r,n);return s?s.version:null},Wu}var Ju,pm;function $A(){if(pm)return Ju;pm=1;const t=Ri();return Ju=(r,n)=>{const s=t(r.trim().replace(/^[=v]+/,""),n);return s?s.version:null},Ju}var Zu,mm;function PA(){if(mm)return Zu;mm=1;const t=qt();return Zu=(r,n,s,i,a)=>{typeof s=="string"&&(a=i,i=s,s=void 0);try{return new t(r instanceof t?r.version:r,s).inc(n,i,a).version}catch{return null}},Zu}var Ku,gm;function LA(){if(gm)return Ku;gm=1;const t=Ri();return Ku=(r,n)=>{const s=t(r,null,!0),i=t(n,null,!0),a=s.compare(i);if(a===0)return null;const o=a>0,c=o?s:i,u=o?i:s,l=!!c.prerelease.length;if(!!u.prerelease.length&&!l){if(!u.patch&&!u.minor)return"major";if(u.compareMain(c)===0)return u.minor&&!u.patch?"minor":"patch"}const h=l?"pre":"";return s.major!==i.major?h+"major":s.minor!==i.minor?h+"minor":s.patch!==i.patch?h+"patch":"prerelease"},Ku}var Xu,ym;function DA(){if(ym)return Xu;ym=1;const t=qt();return Xu=(r,n)=>new t(r,n).major,Xu}var Yu,_m;function MA(){if(_m)return Yu;_m=1;const t=qt();return Yu=(r,n)=>new t(r,n).minor,Yu}var Qu,wm;function UA(){if(wm)return Qu;wm=1;const t=qt();return Qu=(r,n)=>new t(r,n).patch,Qu}var el,vm;function BA(){if(vm)return el;vm=1;const t=Ri();return el=(r,n)=>{const s=t(r,n);return s&&s.prerelease.length?s.prerelease:null},el}var tl,bm;function qr(){if(bm)return tl;bm=1;const t=qt();return tl=(r,n,s)=>new t(r,s).compare(new t(n,s)),tl}var rl,Em;function FA(){if(Em)return rl;Em=1;const t=qr();return rl=(r,n,s)=>t(n,r,s),rl}var nl,Sm;function jA(){if(Sm)return nl;Sm=1;const t=qr();return nl=(r,n)=>t(r,n,!0),nl}var sl,xm;function Kh(){if(xm)return sl;xm=1;const t=qt();return sl=(r,n,s)=>{const i=new t(r,s),a=new t(n,s);return i.compare(a)||i.compareBuild(a)},sl}var il,Tm;function zA(){if(Tm)return il;Tm=1;const t=Kh();return il=(r,n)=>r.sort((s,i)=>t(s,i,n)),il}var al,Am;function VA(){if(Am)return al;Am=1;const t=Kh();return al=(r,n)=>r.sort((s,i)=>t(i,s,n)),al}var ol,Cm;function zc(){if(Cm)return ol;Cm=1;const t=qr();return ol=(r,n,s)=>t(r,n,s)>0,ol}var cl,km;function Xh(){if(km)return cl;km=1;const t=qr();return cl=(r,n,s)=>t(r,n,s)<0,cl}var ul,Im;function Cw(){if(Im)return ul;Im=1;const t=qr();return ul=(r,n,s)=>t(r,n,s)===0,ul}var ll,Rm;function kw(){if(Rm)return ll;Rm=1;const t=qr();return ll=(r,n,s)=>t(r,n,s)!==0,ll}var dl,Om;function Yh(){if(Om)return dl;Om=1;const t=qr();return dl=(r,n,s)=>t(r,n,s)>=0,dl}var hl,Nm;function Qh(){if(Nm)return hl;Nm=1;const t=qr();return hl=(r,n,s)=>t(r,n,s)<=0,hl}var fl,$m;function Iw(){if($m)return fl;$m=1;const t=Cw(),e=kw(),r=zc(),n=Yh(),s=Xh(),i=Qh();return fl=(o,c,u,l)=>{switch(c){case"===":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o===u;case"!==":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o!==u;case"":case"=":case"==":return t(o,u,l);case"!=":return e(o,u,l);case">":return r(o,u,l);case">=":return n(o,u,l);case"<":return s(o,u,l);case"<=":return i(o,u,l);default:throw new TypeError(`Invalid operator: ${c}`)}},fl}var pl,Pm;function GA(){if(Pm)return pl;Pm=1;const t=qt(),e=Ri(),{safeRe:r,t:n}=Ba();return pl=(i,a)=>{if(i instanceof t)return i;if(typeof i=="number"&&(i=String(i)),typeof i!="string")return null;a=a||{};let o=null;if(!a.rtl)o=i.match(a.includePrerelease?r[n.COERCEFULL]:r[n.COERCE]);else{const p=a.includePrerelease?r[n.COERCERTLFULL]:r[n.COERCERTL];let m;for(;(m=p.exec(i))&&(!o||o.index+o[0].length!==i.length);)(!o||m.index+m[0].length!==o.index+o[0].length)&&(o=m),p.lastIndex=m.index+m[1].length+m[2].length;p.lastIndex=-1}if(o===null)return null;const c=o[2],u=o[3]||"0",l=o[4]||"0",d=a.includePrerelease&&o[5]?`-${o[5]}`:"",h=a.includePrerelease&&o[6]?`+${o[6]}`:"";return e(`${c}.${u}.${l}${d}${h}`,a)},pl}var ml,Lm;function HA(){if(Lm)return ml;Lm=1;class t{constructor(){this.max=1e3,this.map=new Map}get(r){const n=this.map.get(r);if(n!==void 0)return this.map.delete(r),this.map.set(r,n),n}delete(r){return this.map.delete(r)}set(r,n){if(!this.delete(r)&&n!==void 0){if(this.map.size>=this.max){const i=this.map.keys().next().value;this.delete(i)}this.map.set(r,n)}return this}}return ml=t,ml}var gl,Dm;function Wr(){if(Dm)return gl;Dm=1;const t=/\s+/g;class e{constructor(U,B){if(B=s(B),U instanceof e)return U.loose===!!B.loose&&U.includePrerelease===!!B.includePrerelease?U:new e(U.raw,B);if(U instanceof i)return this.raw=U.value,this.set=[[U]],this.formatted=void 0,this;if(this.options=B,this.loose=!!B.loose,this.includePrerelease=!!B.includePrerelease,this.raw=U.trim().replace(t," "),this.set=this.raw.split("||").map(te=>this.parseRange(te.trim())).filter(te=>te.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const te=this.set[0];if(this.set=this.set.filter(ae=>!_(ae[0])),this.set.length===0)this.set=[te];else if(this.set.length>1){for(const ae of this.set)if(ae.length===1&&v(ae[0])){this.set=[ae];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let U=0;U<this.set.length;U++){U>0&&(this.formatted+="||");const B=this.set[U];for(let te=0;te<B.length;te++)te>0&&(this.formatted+=" "),this.formatted+=B[te].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(U){const te=((this.options.includePrerelease&&p)|(this.options.loose&&m))+":"+U,ae=n.get(te);if(ae)return ae;const Q=this.options.loose,le=Q?c[u.HYPHENRANGELOOSE]:c[u.HYPHENRANGE];U=U.replace(le,ee(this.options.includePrerelease)),a("hyphen replace",U),U=U.replace(c[u.COMPARATORTRIM],l),a("comparator trim",U),U=U.replace(c[u.TILDETRIM],d),a("tilde trim",U),U=U.replace(c[u.CARETTRIM],h),a("caret trim",U);let ve=U.split(" ").map(G=>E(G,this.options)).join(" ").split(/\s+/).map(G=>se(G,this.options));Q&&(ve=ve.filter(G=>(a("loose invalid filter",G,this.options),!!G.match(c[u.COMPARATORLOOSE])))),a("range list",ve);const z=new Map,K=ve.map(G=>new i(G,this.options));for(const G of K){if(_(G))return[G];z.set(G.value,G)}z.size>1&&z.has("")&&z.delete("");const ne=[...z.values()];return n.set(te,ne),ne}intersects(U,B){if(!(U instanceof e))throw new TypeError("a Range is required");return this.set.some(te=>y(te,B)&&U.set.some(ae=>y(ae,B)&&te.every(Q=>ae.every(le=>Q.intersects(le,B)))))}test(U){if(!U)return!1;if(typeof U=="string")try{U=new o(U,this.options)}catch{return!1}for(let B=0;B<this.set.length;B++)if(Te(this.set[B],U,this.options))return!0;return!1}}gl=e;const r=HA(),n=new r,s=Zh(),i=Vc(),a=jc(),o=qt(),{safeRe:c,t:u,comparatorTrimReplace:l,tildeTrimReplace:d,caretTrimReplace:h}=Ba(),{FLAG_INCLUDE_PRERELEASE:p,FLAG_LOOSE:m}=Fc(),_=M=>M.value==="<0.0.0-0",v=M=>M.value==="",y=(M,U)=>{let B=!0;const te=M.slice();let ae=te.pop();for(;B&&te.length;)B=te.every(Q=>ae.intersects(Q,U)),ae=te.pop();return B},E=(M,U)=>(M=M.replace(c[u.BUILD],""),a("comp",M,U),M=R(M,U),a("caret",M),M=I(M,U),a("tildes",M),M=T(M,U),a("xrange",M),M=q(M,U),a("stars",M),M),b=M=>!M||M.toLowerCase()==="x"||M==="*",I=(M,U)=>M.trim().split(/\s+/).map(B=>k(B,U)).join(" "),k=(M,U)=>{const B=U.loose?c[u.TILDELOOSE]:c[u.TILDE];return M.replace(B,(te,ae,Q,le,ve)=>{a("tilde",M,te,ae,Q,le,ve);let z;return b(ae)?z="":b(Q)?z=`>=${ae}.0.0 <${+ae+1}.0.0-0`:b(le)?z=`>=${ae}.${Q}.0 <${ae}.${+Q+1}.0-0`:ve?(a("replaceTilde pr",ve),z=`>=${ae}.${Q}.${le}-${ve} <${ae}.${+Q+1}.0-0`):z=`>=${ae}.${Q}.${le} <${ae}.${+Q+1}.0-0`,a("tilde return",z),z})},R=(M,U)=>M.trim().split(/\s+/).map(B=>P(B,U)).join(" "),P=(M,U)=>{a("caret",M,U);const B=U.loose?c[u.CARETLOOSE]:c[u.CARET],te=U.includePrerelease?"-0":"";return M.replace(B,(ae,Q,le,ve,z)=>{a("caret",M,ae,Q,le,ve,z);let K;return b(Q)?K="":b(le)?K=`>=${Q}.0.0${te} <${+Q+1}.0.0-0`:b(ve)?Q==="0"?K=`>=${Q}.${le}.0${te} <${Q}.${+le+1}.0-0`:K=`>=${Q}.${le}.0${te} <${+Q+1}.0.0-0`:z?(a("replaceCaret pr",z),Q==="0"?le==="0"?K=`>=${Q}.${le}.${ve}-${z} <${Q}.${le}.${+ve+1}-0`:K=`>=${Q}.${le}.${ve}-${z} <${Q}.${+le+1}.0-0`:K=`>=${Q}.${le}.${ve}-${z} <${+Q+1}.0.0-0`):(a("no pr"),Q==="0"?le==="0"?K=`>=${Q}.${le}.${ve}${te} <${Q}.${le}.${+ve+1}-0`:K=`>=${Q}.${le}.${ve}${te} <${Q}.${+le+1}.0-0`:K=`>=${Q}.${le}.${ve} <${+Q+1}.0.0-0`),a("caret return",K),K})},T=(M,U)=>(a("replaceXRanges",M,U),M.split(/\s+/).map(B=>H(B,U)).join(" ")),H=(M,U)=>{M=M.trim();const B=U.loose?c[u.XRANGELOOSE]:c[u.XRANGE];return M.replace(B,(te,ae,Q,le,ve,z)=>{a("xRange",M,te,ae,Q,le,ve,z);const K=b(Q),ne=K||b(le),G=ne||b(ve),A=G;return ae==="="&&A&&(ae=""),z=U.includePrerelease?"-0":"",K?ae===">"||ae==="<"?te="<0.0.0-0":te="*":ae&&A?(ne&&(le=0),ve=0,ae===">"?(ae=">=",ne?(Q=+Q+1,le=0,ve=0):(le=+le+1,ve=0)):ae==="<="&&(ae="<",ne?Q=+Q+1:le=+le+1),ae==="<"&&(z="-0"),te=`${ae+Q}.${le}.${ve}${z}`):ne?te=`>=${Q}.0.0${z} <${+Q+1}.0.0-0`:G&&(te=`>=${Q}.${le}.0${z} <${Q}.${+le+1}.0-0`),a("xRange return",te),te})},q=(M,U)=>(a("replaceStars",M,U),M.trim().replace(c[u.STAR],"")),se=(M,U)=>(a("replaceGTE0",M,U),M.trim().replace(c[U.includePrerelease?u.GTE0PRE:u.GTE0],"")),ee=M=>(U,B,te,ae,Q,le,ve,z,K,ne,G,A)=>(b(te)?B="":b(ae)?B=`>=${te}.0.0${M?"-0":""}`:b(Q)?B=`>=${te}.${ae}.0${M?"-0":""}`:le?B=`>=${B}`:B=`>=${B}${M?"-0":""}`,b(K)?z="":b(ne)?z=`<${+K+1}.0.0-0`:b(G)?z=`<${K}.${+ne+1}.0-0`:A?z=`<=${K}.${ne}.${G}-${A}`:M?z=`<${K}.${ne}.${+G+1}-0`:z=`<=${z}`,`${B} ${z}`.trim()),Te=(M,U,B)=>{for(let te=0;te<M.length;te++)if(!M[te].test(U))return!1;if(U.prerelease.length&&!B.includePrerelease){for(let te=0;te<M.length;te++)if(a(M[te].semver),M[te].semver!==i.ANY&&M[te].semver.prerelease.length>0){const ae=M[te].semver;if(ae.major===U.major&&ae.minor===U.minor&&ae.patch===U.patch)return!0}return!1}return!0};return gl}var yl,Mm;function Vc(){if(Mm)return yl;Mm=1;const t=Symbol("SemVer ANY");class e{static get ANY(){return t}constructor(l,d){if(d=r(d),l instanceof e){if(l.loose===!!d.loose)return l;l=l.value}l=l.trim().split(/\s+/).join(" "),a("comparator",l,d),this.options=d,this.loose=!!d.loose,this.parse(l),this.semver===t?this.value="":this.value=this.operator+this.semver.version,a("comp",this)}parse(l){const d=this.options.loose?n[s.COMPARATORLOOSE]:n[s.COMPARATOR],h=l.match(d);if(!h)throw new TypeError(`Invalid comparator: ${l}`);this.operator=h[1]!==void 0?h[1]:"",this.operator==="="&&(this.operator=""),h[2]?this.semver=new o(h[2],this.options.loose):this.semver=t}toString(){return this.value}test(l){if(a("Comparator.test",l,this.options.loose),this.semver===t||l===t)return!0;if(typeof l=="string")try{l=new o(l,this.options)}catch{return!1}return i(l,this.operator,this.semver,this.options)}intersects(l,d){if(!(l instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(l.value,d).test(this.value):l.operator===""?l.value===""?!0:new c(this.value,d).test(l.semver):(d=r(d),d.includePrerelease&&(this.value==="<0.0.0-0"||l.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||l.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&l.operator.startsWith(">")||this.operator.startsWith("<")&&l.operator.startsWith("<")||this.semver.version===l.semver.version&&this.operator.includes("=")&&l.operator.includes("=")||i(this.semver,"<",l.semver,d)&&this.operator.startsWith(">")&&l.operator.startsWith("<")||i(this.semver,">",l.semver,d)&&this.operator.startsWith("<")&&l.operator.startsWith(">")))}}yl=e;const r=Zh(),{safeRe:n,t:s}=Ba(),i=Iw(),a=jc(),o=qt(),c=Wr();return yl}var _l,Um;function Gc(){if(Um)return _l;Um=1;const t=Wr();return _l=(r,n,s)=>{try{n=new t(n,s)}catch{return!1}return n.test(r)},_l}var wl,Bm;function qA(){if(Bm)return wl;Bm=1;const t=Wr();return wl=(r,n)=>new t(r,n).set.map(s=>s.map(i=>i.value).join(" ").trim().split(" ")),wl}var vl,Fm;function WA(){if(Fm)return vl;Fm=1;const t=qt(),e=Wr();return vl=(n,s,i)=>{let a=null,o=null,c=null;try{c=new e(s,i)}catch{return null}return n.forEach(u=>{c.test(u)&&(!a||o.compare(u)===-1)&&(a=u,o=new t(a,i))}),a},vl}var bl,jm;function JA(){if(jm)return bl;jm=1;const t=qt(),e=Wr();return bl=(n,s,i)=>{let a=null,o=null,c=null;try{c=new e(s,i)}catch{return null}return n.forEach(u=>{c.test(u)&&(!a||o.compare(u)===1)&&(a=u,o=new t(a,i))}),a},bl}var El,zm;function ZA(){if(zm)return El;zm=1;const t=qt(),e=Wr(),r=zc();return El=(s,i)=>{s=new e(s,i);let a=new t("0.0.0");if(s.test(a)||(a=new t("0.0.0-0"),s.test(a)))return a;a=null;for(let o=0;o<s.set.length;++o){const c=s.set[o];let u=null;c.forEach(l=>{const d=new t(l.semver.version);switch(l.operator){case">":d.prerelease.length===0?d.patch++:d.prerelease.push(0),d.raw=d.format();case"":case">=":(!u||r(d,u))&&(u=d);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${l.operator}`)}}),u&&(!a||r(a,u))&&(a=u)}return a&&s.test(a)?a:null},El}var Sl,Vm;function KA(){if(Vm)return Sl;Vm=1;const t=Wr();return Sl=(r,n)=>{try{return new t(r,n).range||"*"}catch{return null}},Sl}var xl,Gm;function ef(){if(Gm)return xl;Gm=1;const t=qt(),e=Vc(),{ANY:r}=e,n=Wr(),s=Gc(),i=zc(),a=Xh(),o=Qh(),c=Yh();return xl=(l,d,h,p)=>{l=new t(l,p),d=new n(d,p);let m,_,v,y,E;switch(h){case">":m=i,_=o,v=a,y=">",E=">=";break;case"<":m=a,_=c,v=i,y="<",E="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(s(l,d,p))return!1;for(let b=0;b<d.set.length;++b){const I=d.set[b];let k=null,R=null;if(I.forEach(P=>{P.semver===r&&(P=new e(">=0.0.0")),k=k||P,R=R||P,m(P.semver,k.semver,p)?k=P:v(P.semver,R.semver,p)&&(R=P)}),k.operator===y||k.operator===E||(!R.operator||R.operator===y)&&_(l,R.semver))return!1;if(R.operator===E&&v(l,R.semver))return!1}return!0},xl}var Tl,Hm;function XA(){if(Hm)return Tl;Hm=1;const t=ef();return Tl=(r,n,s)=>t(r,n,">",s),Tl}var Al,qm;function YA(){if(qm)return Al;qm=1;const t=ef();return Al=(r,n,s)=>t(r,n,"<",s),Al}var Cl,Wm;function QA(){if(Wm)return Cl;Wm=1;const t=Wr();return Cl=(r,n,s)=>(r=new t(r,s),n=new t(n,s),r.intersects(n,s)),Cl}var kl,Jm;function eC(){if(Jm)return kl;Jm=1;const t=Gc(),e=qr();return kl=(r,n,s)=>{const i=[];let a=null,o=null;const c=r.sort((h,p)=>e(h,p,s));for(const h of c)t(h,n,s)?(o=h,a||(a=h)):(o&&i.push([a,o]),o=null,a=null);a&&i.push([a,null]);const u=[];for(const[h,p]of i)h===p?u.push(h):!p&&h===c[0]?u.push("*"):p?h===c[0]?u.push(`<=${p}`):u.push(`${h} - ${p}`):u.push(`>=${h}`);const l=u.join(" || "),d=typeof n.raw=="string"?n.raw:String(n);return l.length<d.length?l:n},kl}var Il,Zm;function tC(){if(Zm)return Il;Zm=1;const t=Wr(),e=Vc(),{ANY:r}=e,n=Gc(),s=qr(),i=(d,h,p={})=>{if(d===h)return!0;d=new t(d,p),h=new t(h,p);let m=!1;e:for(const _ of d.set){for(const v of h.set){const y=c(_,v,p);if(m=m||y!==null,y)continue e}if(m)return!1}return!0},a=[new e(">=0.0.0-0")],o=[new e(">=0.0.0")],c=(d,h,p)=>{if(d===h)return!0;if(d.length===1&&d[0].semver===r){if(h.length===1&&h[0].semver===r)return!0;p.includePrerelease?d=a:d=o}if(h.length===1&&h[0].semver===r){if(p.includePrerelease)return!0;h=o}const m=new Set;let _,v;for(const T of d)T.operator===">"||T.operator===">="?_=u(_,T,p):T.operator==="<"||T.operator==="<="?v=l(v,T,p):m.add(T.semver);if(m.size>1)return null;let y;if(_&&v){if(y=s(_.semver,v.semver,p),y>0)return null;if(y===0&&(_.operator!==">="||v.operator!=="<="))return null}for(const T of m){if(_&&!n(T,String(_),p)||v&&!n(T,String(v),p))return null;for(const H of h)if(!n(T,String(H),p))return!1;return!0}let E,b,I,k,R=v&&!p.includePrerelease&&v.semver.prerelease.length?v.semver:!1,P=_&&!p.includePrerelease&&_.semver.prerelease.length?_.semver:!1;R&&R.prerelease.length===1&&v.operator==="<"&&R.prerelease[0]===0&&(R=!1);for(const T of h){if(k=k||T.operator===">"||T.operator===">=",I=I||T.operator==="<"||T.operator==="<=",_){if(P&&T.semver.prerelease&&T.semver.prerelease.length&&T.semver.major===P.major&&T.semver.minor===P.minor&&T.semver.patch===P.patch&&(P=!1),T.operator===">"||T.operator===">="){if(E=u(_,T,p),E===T&&E!==_)return!1}else if(_.operator===">="&&!n(_.semver,String(T),p))return!1}if(v){if(R&&T.semver.prerelease&&T.semver.prerelease.length&&T.semver.major===R.major&&T.semver.minor===R.minor&&T.semver.patch===R.patch&&(R=!1),T.operator==="<"||T.operator==="<="){if(b=l(v,T,p),b===T&&b!==v)return!1}else if(v.operator==="<="&&!n(v.semver,String(T),p))return!1}if(!T.operator&&(v||_)&&y!==0)return!1}return!(_&&I&&!v&&y!==0||v&&k&&!_&&y!==0||P||R)},u=(d,h,p)=>{if(!d)return h;const m=s(d.semver,h.semver,p);return m>0?d:m<0||h.operator===">"&&d.operator===">="?h:d},l=(d,h,p)=>{if(!d)return h;const m=s(d.semver,h.semver,p);return m<0?d:m>0||h.operator==="<"&&d.operator==="<="?h:d};return Il=i,Il}var Rl,Km;function rC(){if(Km)return Rl;Km=1;const t=Ba(),e=Fc(),r=qt(),n=Aw(),s=Ri(),i=NA(),a=$A(),o=PA(),c=LA(),u=DA(),l=MA(),d=UA(),h=BA(),p=qr(),m=FA(),_=jA(),v=Kh(),y=zA(),E=VA(),b=zc(),I=Xh(),k=Cw(),R=kw(),P=Yh(),T=Qh(),H=Iw(),q=GA(),se=Vc(),ee=Wr(),Te=Gc(),M=qA(),U=WA(),B=JA(),te=ZA(),ae=KA(),Q=ef(),le=XA(),ve=YA(),z=QA(),K=eC(),ne=tC();return Rl={parse:s,valid:i,clean:a,inc:o,diff:c,major:u,minor:l,patch:d,prerelease:h,compare:p,rcompare:m,compareLoose:_,compareBuild:v,sort:y,rsort:E,gt:b,lt:I,eq:k,neq:R,gte:P,lte:T,cmp:H,coerce:q,Comparator:se,Range:ee,satisfies:Te,toComparators:M,maxSatisfying:U,minSatisfying:B,minVersion:te,validRange:ae,outside:Q,gtr:le,ltr:ve,intersects:z,simplifyRange:K,subset:ne,SemVer:r,re:t.re,src:t.src,tokens:t.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:n.compareIdentifiers,rcompareIdentifiers:n.rcompareIdentifiers},Rl}rC();function Fn(t){if(!t||t.split("/").length>2||t.startsWith("/")||t.endsWith("/")||t.split(":").length>2)throw new Error(`Invalid identifier format: ${t}`);const[e,r]=t.split(":"),n=r||"latest";if(e.includes("/")){const[s,i]=e.split("/",2);if(!s||!i)throw new Error(`Invalid identifier format: ${t}`);return[s,i,n]}else{if(!e)throw new Error(`Invalid identifier format: ${t}`);return["-",e,n]}}class nC extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function fe(t,e,r){let n;if(t.ok){r&&(n=await t.text());return}if(t.status===403)try{const a=await t.json();(a==null?void 0:a.error)==="org_scoped_key_requires_workspace"&&(n="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const o=new Error(`${t.status} ${t.statusText}`);throw o.status=t==null?void 0:t.status,o}if(n===void 0)try{n=await t.text()}catch{n=""}const s=`Failed to ${e}. Received status [${t.status}]: ${t.statusText}. Message: ${n}`;if(t.status===409)throw new nC(s);const i=new Error(s);throw i.status=t.status,i}const Rw="ERR_CONFLICTING_ENDPOINTS";class sC extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:Rw}),this.name="ConflictingEndpointsError"}}function iC(t){return typeof t=="object"&&t!==null&&t.code===Rw}var Xm="[...]",aC={result:"[Circular]"},ec=[],ei=[];const oC=new TextEncoder;function cC(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function uo(t){return oC.encode(t)}function Ow(t){if(t&&typeof t=="object"&&t!==null){if(t instanceof Map)return Object.fromEntries(t);if(t instanceof Set)return Array.from(t);if(t instanceof Date)return t.toISOString();if(t instanceof RegExp)return t.toString();if(t instanceof Error)return{name:t.name,message:t.message}}else if(typeof t=="bigint")return t.toString();return t}function uC(t){return function(e,r){return Ow(r)}}function dr(t,e,r,n,s){var i;try{const a=JSON.stringify(t,uC(r),n);return uo(a)}catch(a){if(!((i=a.message)!=null&&i.includes("Converting circular structure to JSON")))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),uo("[Unserializable]");Qt("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof s>"u"&&(s=cC()),Td(t,"",0,[],void 0,0,s);let o;try{ei.length===0?o=JSON.stringify(t,r,n):o=JSON.stringify(t,lC(r),n)}catch{return uo("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;ec.length!==0;){const c=ec.pop();c.length===4?Object.defineProperty(c[0],c[1],c[3]):c[0][c[1]]=c[2]}}return uo(o)}}function Ol(t,e,r,n){var s=Object.getOwnPropertyDescriptor(n,r);s.get!==void 0?s.configurable?(Object.defineProperty(n,r,{value:t}),ec.push([n,r,e,s])):ei.push([e,r,t]):(n[r]=t,ec.push([n,r,e]))}function Td(t,e,r,n,s,i,a){i+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<n.length;o++)if(n[o]===t){Ol(aC,t,e,s);return}if(typeof a.depthLimit<"u"&&i>a.depthLimit){Ol(Xm,t,e,s);return}if(typeof a.edgesLimit<"u"&&r+1>a.edgesLimit){Ol(Xm,t,e,s);return}if(n.push(t),Array.isArray(t))for(o=0;o<t.length;o++)Td(t[o],o,o,n,t,i,a);else{t=Ow(t);var c=Object.keys(t);for(o=0;o<c.length;o++){var u=c[o];Td(t[u],u,o,n,t,i,a)}}n.pop()}}function lC(t){return t=typeof t<"u"?t:function(e,r){return r},function(e,r){if(ei.length>0)for(var n=0;n<ei.length;n++){var s=ei[n];if(s[1]===e&&s[0]===r){r=s[2],ei.splice(n,1);break}}return t.call(this,e,r)}}function Ym(t,e){const r=Ew(),n=e??Sw(),s=t.extra??{},i=s.metadata;return t.extra={...s,runtime:{...r,...s==null?void 0:s.runtime},metadata:{...n,...n.revision_id||"revision_id"in t&&t.revision_id?{revision_id:("revision_id"in t?t.revision_id:void 0)??n.revision_id}:{},...i}},t}const dC=t=>{const e=(t==null?void 0:t.toString())??Qt("TRACING_SAMPLING_RATE");if(e===void 0)return;const r=parseFloat(e);if(r<0||r>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${r}`);return r},hC=t=>{const r=t.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return r==="localhost"||r==="127.0.0.1"||r==="::1"};async function fC(t){const e=[];for await(const r of t)e.push(r);return e}function lo(t){if(t!==void 0)return t.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const pC=async t=>{if((t==null?void 0:t.status)===429){const e=parseInt(t.headers.get("retry-after")??"10",10)*1e3;if(e>0)return await new Promise(r=>setTimeout(r,e)),!0}return!1};function Qm(t){return typeof t=="number"?Number(t.toFixed(4)):t}class mC{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let r;const n=new Promise(i=>{r=i}),s=dr(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:r,itemPromise:n,size:s}),this.sizeBytes+=s,n}pop({upToSizeBytes:e,upToSize:r}){var i;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const n=[];let s=0;for(;s+(((i=this.peek())==null?void 0:i.size)??0)<e&&this.items.length>0&&n.length<r;){const a=this.items.shift();a&&(n.push(a),s+=a.size,this.sizeBytes-=a.size)}if(n.length===0&&this.items.length>0){const a=this.items.shift();n.push(a),s+=a.size,this.sizeBytes-=a.size}return[n.map(a=>({action:a.action,item:a.payload,otelContext:a.otelContext,apiKey:a.apiKey,apiUrl:a.apiUrl})),()=>n.forEach(a=>a.itemPromiseResolve())]}}const gC=24*1024*1024,yC=1e4,_C=100,eg="https://api.smith.langchain.com";let tf=class Ad{get _fetch(){return this.fetchImplementation||eA(this.debug)}constructor(e={}){var n;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new mC}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:fn("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:fn("LANGSMITH_DEBUG")==="true"});const r=Ad.getDefaultClientConfig();if(this.tracingSampleRate=dC(e.tracingSamplingRate),this.apiUrl=lo(e.apiUrl??r.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=lo(e.apiKey??r.apiKey),this.webUrl=lo(e.webUrl??r.webUrl),(n=this.webUrl)!=null&&n.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=lo(e.workspaceId??Qt("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new rm({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation,this.batchIngestCaller=new rm({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:pC,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??r.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??r.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,xw()&&(this.langSmithToOTELTranslator=new yA),this.cachedLSEnvVarsForMetadata=Sw()}static getDefaultClientConfig(){const e=Qt("API_KEY"),r=Qt("ENDPOINT")??eg,n=Qt("HIDE_INPUTS")==="true",s=Qt("HIDE_OUTPUTS")==="true";return{apiUrl:r,apiKey:e,webUrl:void 0,hideInputs:n,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:hC(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${ww}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const r={...e};return r.inputs!==void 0&&(r.inputs=await this.processInputs(r.inputs)),r.outputs!==void 0&&(r.outputs=await this.processOutputs(r.outputs)),r}async _getResponse(e,r){const n=(r==null?void 0:r.toString())??"",s=`${this.apiUrl}${e}?${n}`;return await this.caller.call(async()=>{const a=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(a,`fetch ${e}`),a})}async _get(e,r){return(await this._getResponse(e,r)).json()}async*_getPaginated(e,r=new URLSearchParams,n){let s=Number(r.get("offset"))||0;const i=Number(r.get("limit"))||100;for(;;){r.set("offset",String(s)),r.set("limit",String(i));const a=`${this.apiUrl}${e}?${r}`,o=await this.caller.call(async()=>{const u=await this._fetch(a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(u,`fetch ${e}`),u}),c=n?n(await o.json()):await o.json();if(c.length===0||(yield c,c.length<i))break;s+=c.length}}async*_getCursorPaginatedList(e,r=null,n="POST",s="runs"){const i=r?{...r}:{};for(;;){const a=JSON.stringify(i),c=await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await fe(l,`fetch ${e}`),l})).json();if(!c||!c[s])break;yield c[s];const u=c.cursors;if(!u||!u.next)break;i.cursor=u.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,r=!1){if(this.tracingSampleRate===void 0)return e;if(r){const n=[];for(const s of e)this.filteredPostUuids.has(s.trace_id)?s.id===s.trace_id&&this.filteredPostUuids.delete(s.trace_id):n.push(s);return n}else{const n=[];for(const s of e){const i=s.trace_id??s.id;this.filteredPostUuids.has(i)||(s.id===i?this._shouldSample()?n.push(s):this.filteredPostUuids.add(i):n.push(s))}return n}}async _getBatchSizeLimitBytes(){var r;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((r=e.batch_ingest_config)==null?void 0:r.size_limit_bytes)??gC}async _getBatchSizeLimit(){var r;const e=await this._ensureServerInfo();return this.batchSizeLimit??((r=e.batch_ingest_config)==null?void 0:r.size_limit)??_C}async _getDatasetExamplesMultiPartSupport(){var r;return((r=(await this._ensureServerInfo()).instance_flags)==null?void 0:r.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:r}){const n=[];for(;this.autoBatchQueue.items.length>0;){const[s,i]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:r});if(!s.length){i();break}const a=s.reduce((u,l)=>{const d=l.apiUrl??this.apiUrl,h=l.apiKey??this.apiKey,m=l.apiKey===this.apiKey&&l.apiUrl===this.apiUrl?"default":`${d}|${h}`;return u[m]||(u[m]=[]),u[m].push(l),u},{}),o=[];for(const[u,l]of Object.entries(a)){const d=this._processBatch(l,{apiUrl:u==="default"?void 0:u.split("|")[0],apiKey:u==="default"?void 0:u.split("|")[1]});o.push(d)}const c=Promise.all(o).finally(i);n.push(c)}return Promise.all(n)}async _processBatch(e,r){var n,s;if(e.length)try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(e);else{const i={runCreates:e.filter(o=>o.action==="create").map(o=>o.item),runUpdates:e.filter(o=>o.action==="update").map(o=>o.item)},a=await this._ensureServerInfo();if((n=a==null?void 0:a.batch_ingest_config)!=null&&n.use_multipart_endpoint){const o=(s=a==null?void 0:a.instance_flags)==null?void 0:s.gzip_body_enabled;await this.multipartIngestRuns(i,{...r,useGzip:o})}else await this.batchIngestRuns(i,r)}}catch(i){console.error("Error exporting batch:",i)}}_sendBatchToOTELTranslator(e){if(this.langSmithToOTELTranslator!==void 0){const r=new Map,n=[];for(const s of e)s.item.id&&s.otelContext&&(r.set(s.item.id,s.otelContext),s.action==="create"?n.push({operation:"post",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}):n.push({operation:"patch",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}));this.langSmithToOTELTranslator.exportBatch(n,r)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=Ym(e.item,this.cachedLSEnvVarsForMetadata);const r=this.autoBatchQueue.push(e);if(this.manualFlushMode)return r;const n=await this._getBatchSizeLimitBytes(),s=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>n||this.autoBatchQueue.items.length>s)&&this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:s}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:s})},this.autoBatchAggregationDelayMs)),r}async _getServerInfo(){const r=await(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(yC),...this.fetchOptions});return await fe(n,"get server info"),n})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(r,null,2)+`
`),r}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),r=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:r})}_cloneCurrentOTELContext(){const e=Tw(),r=fA();if(this.langSmithToOTELTranslator!==void 0){const n=e.getActiveSpan();if(n)return e.setSpan(r.active(),n)}}async createRun(e,r){if(!this._filterForSampling([e]).length)return;const n={...this.headers,"Content-Type":"application/json"},s=e.project_name;delete e.project_name;const i=await this.prepareRunCreateOrUpdateInputs({session_name:s,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){const c=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:i,otelContext:c,apiKey:r==null?void 0:r.apiKey,apiUrl:r==null?void 0:r.apiUrl}).catch(console.error);return}const a=Ym(i,this.cachedLSEnvVarsForMetadata);(r==null?void 0:r.apiKey)!==void 0&&(n["x-api-key"]=r.apiKey),(r==null?void 0:r.workspaceId)!==void 0&&(n["x-tenant-id"]=r.workspaceId);const o=dr(a,`Creating run with id: ${a.id}`);await this.caller.call(async()=>{const c=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await fe(c,"create run",!0),c})}async batchIngestRuns({runCreates:e,runUpdates:r},n){if(e===void 0&&r===void 0)return;let s=await Promise.all((e==null?void 0:e.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[]),i=await Promise.all((r==null?void 0:r.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[]);if(s.length>0&&i.length>0){const c=s.reduce((l,d)=>(d.id&&(l[d.id]=d),l),{}),u=[];for(const l of i)l.id!==void 0&&c[l.id]?c[l.id]={...c[l.id],...l}:u.push(l);s=Object.values(c),i=u}const a={post:s,patch:i};if(!a.post.length&&!a.patch.length)return;const o={post:[],patch:[]};for(const c of["post","patch"]){const u=c,l=a[u].reverse();let d=l.pop();for(;d!==void 0;)o[u].push(d),d=l.pop()}if(o.post.length>0||o.patch.length>0){const c=o.post.map(u=>u.id).concat(o.patch.map(u=>u.id)).join(",");await this._postBatchIngestRuns(dr(o,`Ingesting runs with ids: ${c}`),n)}}async _postBatchIngestRuns(e,r){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"};(r==null?void 0:r.apiKey)!==void 0&&(n["x-api-key"]=r.apiKey),await this.batchIngestCaller.call(async()=>{const s=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/batch`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await fe(s,"batch create run",!0),s})}async multipartIngestRuns({runCreates:e,runUpdates:r},n){if(e===void 0&&r===void 0)return;const s={};let i=[];for(const d of e??[]){const h=await this.prepareRunCreateOrUpdateInputs(d);h.id!==void 0&&h.attachments!==void 0&&(s[h.id]=h.attachments),delete h.attachments,i.push(h)}let a=[];for(const d of r??[])a.push(await this.prepareRunCreateOrUpdateInputs(d));if(i.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(a.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(i.length>0&&a.length>0){const d=i.reduce((p,m)=>(m.id&&(p[m.id]=m),p),{}),h=[];for(const p of a)p.id!==void 0&&d[p.id]?d[p.id]={...d[p.id],...p}:h.push(p);i=Object.values(d),a=h}if(i.length===0&&a.length===0)return;const u=[],l=[];for(const[d,h]of[["post",i],["patch",a]])for(const p of h){const{inputs:m,outputs:_,events:v,extra:y,error:E,serialized:b,attachments:I,...k}=p,R={inputs:m,outputs:_,events:v,extra:y,error:E,serialized:b},P=dr(k,`Serializing for multipart ingestion of run with id: ${k.id}`);l.push({name:`${d}.${k.id}`,payload:new Blob([P],{type:`application/json; length=${P.length}`})});for(const[T,H]of Object.entries(R)){if(H===void 0)continue;const q=dr(H,`Serializing ${T} for multipart ingestion of run with id: ${k.id}`);l.push({name:`${d}.${k.id}.${T}`,payload:new Blob([q],{type:`application/json; length=${q.length}`})})}if(k.id!==void 0){const T=s[k.id];if(T){delete s[k.id];for(const[H,q]of Object.entries(T)){let se,ee;if(Array.isArray(q)?[se,ee]=q:(se=q.mimeType,ee=q.data),H.includes(".")){console.warn(`Skipping attachment '${H}' for run ${k.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}l.push({name:`attachment.${k.id}.${H}`,payload:new Blob([ee],{type:`${se}; length=${ee.byteLength}`})})}}}u.push(`trace=${k.trace_id},id=${k.id}`)}await this._sendMultipartRequest(l,u.join("; "),n)}async _createNodeFetchBody(e,r){const n=[];for(const a of e)n.push(new Blob([`--${r}\r
`])),n.push(new Blob([`Content-Disposition: form-data; name="${a.name}"\r
`,`Content-Type: ${a.payload.type}\r
\r
`])),n.push(a.payload),n.push(new Blob([`\r
`]));return n.push(new Blob([`--${r}--\r
`])),await new Blob(n).arrayBuffer()}async _createMultipartStream(e,r){const n=new TextEncoder;return new ReadableStream({async start(i){const a=async o=>{typeof o=="string"?i.enqueue(n.encode(o)):i.enqueue(o)};for(const o of e){await a(`--${r}\r
`),await a(`Content-Disposition: form-data; name="${o.name}"\r
`),await a(`Content-Type: ${o.payload.type}\r
\r
`);const u=o.payload.stream().getReader();try{let l;for(;!(l=await u.read()).done;)i.enqueue(l.value)}finally{u.releaseLock()}await a(`\r
`)}await a(`--${r}--\r
`),i.close()}})}async _sendMultipartRequest(e,r,n){const s="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),i=QT(),a=()=>this._createNodeFetchBody(e,s),o=()=>this._createMultipartStream(e,s),c=async u=>this.batchIngestCaller.call(async()=>{const l=await u(),d={...this.headers,"Content-Type":`multipart/form-data; boundary=${s}`};(n==null?void 0:n.apiKey)!==void 0&&(d["x-api-key"]=n.apiKey);let h=l;n!=null&&n.useGzip&&typeof l=="object"&&"pipeThrough"in l&&(h=l.pipeThrough(new CompressionStream("gzip")),d["Content-Encoding"]="gzip");const p=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/multipart`,{method:"POST",headers:d,body:h,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(p,"Failed to send multipart request",!0),p});try{let u,l=!1;!i&&!this.multipartStreamingDisabled&&bw()!=="bun"?(l=!0,u=await c(o)):u=await c(a),(!this.multipartStreamingDisabled||l)&&u.status===422&&((n==null?void 0:n.apiUrl)??this.apiUrl)!==eg&&(console.warn(`Streaming multipart upload to ${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${r}".`),this.multipartStreamingDisabled=!0,u=await c(a))}catch(u){console.warn(`${u.message.trim()}

Context: ${r}`)}}async updateRun(e,r,n){xe(e),r.inputs&&(r.inputs=await this.processInputs(r.inputs)),r.outputs&&(r.outputs=await this.processOutputs(r.outputs));const s={...r,id:e};if(!this._filterForSampling([s],!0).length)return;if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){const o=this._cloneCurrentOTELContext();if(r.end_time!==void 0&&s.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:n==null?void 0:n.apiKey,apiUrl:n==null?void 0:n.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:n==null?void 0:n.apiKey,apiUrl:n==null?void 0:n.apiUrl}).catch(console.error);return}const i={...this.headers,"Content-Type":"application/json"};(n==null?void 0:n.apiKey)!==void 0&&(i["x-api-key"]=n.apiKey),(n==null?void 0:n.workspaceId)!==void 0&&(i["x-tenant-id"]=n.workspaceId);const a=dr(r,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const o=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await fe(o,"update run",!0),o})}async readRun(e,{loadChildRuns:r}={loadChildRuns:!1}){xe(e);let n=await this._get(`/runs/${e}`);return r&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:r,projectOpts:n}){if(r!==void 0){let s;r.session_id?s=r.session_id:n!=null&&n.projectName?s=(await this.readProject({projectName:n==null?void 0:n.projectName})).id:n!=null&&n.projectId?s=n==null?void 0:n.projectId:s=(await this.readProject({projectName:Qt("PROJECT")||"default"})).id;const i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${s}/r/${r.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){var i;const r=await fC(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),n={},s={};r.sort((a,o)=>((a==null?void 0:a.dotted_order)??"").localeCompare((o==null?void 0:o.dotted_order)??""));for(const a of r){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);(i=a.dotted_order)!=null&&i.startsWith(e.dotted_order??"")&&a.id!==e.id&&(a.parent_run_id in n||(n[a.parent_run_id]=[]),n[a.parent_run_id].push(a),s[a.id]=a)}e.child_runs=n[e.id]||[];for(const a in n)a!==e.id&&(s[a].child_runs=n[a]);return e}async*listRuns(e){const{projectId:r,projectName:n,parentRunId:s,traceId:i,referenceExampleId:a,startTime:o,executionOrder:c,isRoot:u,runType:l,error:d,id:h,query:p,filter:m,traceFilter:_,treeFilter:v,limit:y,select:E,order:b}=e;let I=[];if(r&&(I=Array.isArray(r)?r:[r]),n){const T=Array.isArray(n)?n:[n],H=await Promise.all(T.map(q=>this.readProject({projectName:q}).then(se=>se.id)));I.push(...H)}const k=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],R={session:I.length?I:null,run_type:l,reference_example:a,query:p,filter:m,trace_filter:_,tree_filter:v,execution_order:c,parent_run:s,start_time:o?o.toISOString():null,error:d,id:h,limit:y,trace:i,select:E||k,is_root:u,order:b};R.select.includes("child_run_ids")&&xd("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let P=0;for await(const T of this._getCursorPaginatedList("/runs/query",R))if(y){if(P>=y)break;if(T.length+P>y){yield*T.slice(0,y-P);break}P+=T.length,yield*T}else yield*T}async*listGroupRuns(e){const{projectId:r,projectName:n,groupBy:s,filter:i,startTime:a,endTime:o,limit:c,offset:u}=e,d={session_id:r||(await this.readProject({projectName:n})).id,group_by:s,filter:i,start_time:a?a.toISOString():null,end_time:o?o.toISOString():null,limit:Number(c)||100};let h=Number(u)||0;const p="/runs/group",m=`${this.apiUrl}${p}`;for(;;){const _={...d,offset:h},v=Object.fromEntries(Object.entries(_).filter(([R,P])=>P!==void 0)),y=JSON.stringify(v),b=await(await this.caller.call(async()=>{const R=await this._fetch(m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:y});return await fe(R,`Failed to fetch ${p}`),R})).json(),{groups:I,total:k}=b;if(I.length===0)break;for(const R of I)yield R;if(h+=I.length,h>=k)break}}async getRunStats({id:e,trace:r,parentRun:n,runType:s,projectNames:i,projectIds:a,referenceExampleIds:o,startTime:c,endTime:u,error:l,query:d,filter:h,traceFilter:p,treeFilter:m,isRoot:_,dataSourceType:v}){let y=a||[];i&&(y=[...a||[],...await Promise.all(i.map(P=>this.readProject({projectName:P}).then(T=>T.id)))]);const b=Object.fromEntries(Object.entries({id:e,trace:r,parent_run:n,run_type:s,session:y,reference_example:o,start_time:c,end_time:u,error:l,query:d,filter:h,trace_filter:p,tree_filter:m,is_root:_,data_source_type:v}).filter(([P,T])=>T!==void 0)),I=JSON.stringify(b);return await(await this.caller.call(async()=>{const P=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:I});return await fe(P,"get run stats"),P})).json()}async shareRun(e,{shareId:r}={}){const n={run_id:e,share_token:r||Js()};xe(e);const s=JSON.stringify(n),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await fe(o,"share run"),o})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){xe(e),await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(r,"unshare run",!0),r})}async readRunSharedLink(e){xe(e);const n=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(s,"read run shared link"),s})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:r}={}){const n=new URLSearchParams({share_token:e});if(r!==void 0)for(const a of r)n.append("id",a);return xe(e),await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(a,"list shared runs"),a})).json()}async readDatasetSharedSchema(e,r){if(!e&&!r)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:r})).id),xe(e);const s=await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(i,"read dataset shared schema"),i})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,r){if(!e&&!r)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:r})).id);const n={dataset_id:e};xe(e);const s=JSON.stringify(n),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await fe(o,"share dataset"),o})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){xe(e),await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(r,"unshare dataset",!0),r})}async readSharedDataset(e){return xe(e),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(s,"read shared dataset"),s})).json()}async listSharedExamples(e,r){const n={};r!=null&&r.exampleIds&&(n.id=r.exampleIds);const s=new URLSearchParams;Object.entries(n).forEach(([o,c])=>{Array.isArray(c)?c.forEach(u=>s.append(o,u)):s.append(o,c)});const i=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(o,"list shared examples"),o}),a=await i.json();if(!i.ok)throw"detail"in a?new Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(a.detail)?a.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${i.status} ${i.statusText}`);return a.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:r=null,metadata:n=null,upsert:s=!1,projectExtra:i=null,referenceDatasetId:a=null}){const o=s?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,u=i||{};n&&(u.metadata=n);const l={name:e,extra:u,description:r};a!==null&&(l.reference_dataset_id=a);const d=JSON.stringify(l);return await(await this.caller.call(async()=>{const m=await this._fetch(c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await fe(m,"create project"),m})).json()}async updateProject(e,{name:r=null,description:n=null,metadata:s=null,projectExtra:i=null,endTime:a=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=i;s&&(c={...c||{},metadata:s});const u=JSON.stringify({name:r,extra:c,description:n,end_time:a?new Date(a).toISOString():null});return await(await this.caller.call(async()=>{const h=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await fe(h,"update project"),h})).json()}async hasProject({projectId:e,projectName:r}){let n="/sessions";const s=new URLSearchParams;if(e!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)xe(e),n+=`/${e}`;else if(r!==void 0)s.append("name",r);else throw new Error("Must provide projectName or projectId");const i=await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${n}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(a,"has project"),a});try{const a=await i.json();return i.ok?Array.isArray(a)?a.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:r,includeStats:n}){let s="/sessions";const i=new URLSearchParams;if(e!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)xe(e),s+=`/${e}`;else if(r!==void 0)i.append("name",r);else throw new Error("Must provide projectName or projectId");n!==void 0&&i.append("include_stats",n.toString());const a=await this._get(s,i);let o;if(Array.isArray(a)){if(a.length===0)throw new Error(`Project[id=${e}, name=${r}] not found`);o=a[0]}else o=a;return o}async getProjectUrl({projectId:e,projectName:r}){if(e===void 0&&r===void 0)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:r}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:r}){if(e===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:r}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${n.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const r of this._getPaginated("/sessions",e))return this._tenantId=r[0].tenant_id,r[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:r,nameContains:n,referenceDatasetId:s,referenceDatasetName:i,includeStats:a,datasetVersion:o,referenceFree:c,metadata:u}={}){const l=new URLSearchParams;if(e!==void 0)for(const d of e)l.append("id",d);if(r!==void 0&&l.append("name",r),n!==void 0&&l.append("name_contains",n),s!==void 0)l.append("reference_dataset",s);else if(i!==void 0){const d=await this.readDataset({datasetName:i});l.append("reference_dataset",d.id)}a!==void 0&&l.append("include_stats",a.toString()),o!==void 0&&l.append("dataset_version",o),c!==void 0&&l.append("reference_free",c.toString()),u!==void 0&&l.append("metadata",JSON.stringify(u));for await(const d of this._getPaginated("/sessions",l))yield*d}async deleteProject({projectId:e,projectName:r}){let n;if(e===void 0&&r===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?n=(await this.readProject({projectName:r})).id:n=e,xe(n),await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(s,`delete session ${n} (${r})`,!0),s})}async uploadCsv({csvFile:e,fileName:r,inputKeys:n,outputKeys:s,description:i,dataType:a,name:o}){const c=`${this.apiUrl}/datasets/upload`,u=new FormData;return u.append("file",e,r),n.forEach(h=>{u.append("input_keys",h)}),s.forEach(h=>{u.append("output_keys",h)}),i&&u.append("description",i),a&&u.append("data_type",a),o&&u.append("name",o),await(await this.caller.call(async()=>{const h=await this._fetch(c,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await fe(h,"upload CSV"),h})).json()}async createDataset(e,{description:r,dataType:n,inputsSchema:s,outputsSchema:i,metadata:a}={}){const o={name:e,description:r,extra:a?{metadata:a}:void 0};n&&(o.data_type=n),s&&(o.inputs_schema_definition=s),i&&(o.outputs_schema_definition=i);const c=JSON.stringify(o);return await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await fe(d,"create dataset"),d})).json()}async readDataset({datasetId:e,datasetName:r}){let n="/datasets";const s=new URLSearchParams({limit:"1"});if(e&&r)throw new Error("Must provide either datasetName or datasetId, not both");if(e)xe(e),n+=`/${e}`;else if(r)s.append("name",r);else throw new Error("Must provide datasetName or datasetId");const i=await this._get(n,s);let a;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${e}, name=${r}] not found`);a=i[0]}else a=i;return a}async hasDataset({datasetId:e,datasetName:r}){try{return await this.readDataset({datasetId:e,datasetName:r}),!0}catch(n){if(n instanceof Error&&n.message.toLocaleLowerCase().includes("not found"))return!1;throw n}}async diffDatasetVersions({datasetId:e,datasetName:r,fromVersion:n,toVersion:s}){let i=e;if(i===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:r})).id);const a=new URLSearchParams({from_version:typeof n=="string"?n:n.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,a)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:r}){const n="/datasets";if(e===void 0)if(r!==void 0)e=(await this.readDataset({datasetName:r})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${n}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:r=0,datasetIds:n,datasetName:s,datasetNameContains:i,metadata:a}={}){const o="/datasets",c=new URLSearchParams({limit:e.toString(),offset:r.toString()});if(n!==void 0)for(const u of n)c.append("id",u);s!==void 0&&c.append("name",s),i!==void 0&&c.append("name_contains",i),a!==void 0&&c.append("metadata",JSON.stringify(a));for await(const u of this._getPaginated(o,c))yield*u}async updateDataset(e){const{datasetId:r,datasetName:n,...s}=e;if(!r&&!n)throw new Error("Must provide either datasetName or datasetId");const i=r??(await this.readDataset({datasetName:n})).id;xe(i);const a=JSON.stringify(s);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await fe(c,"update dataset"),c})).json()}async updateDatasetTag(e){const{datasetId:r,datasetName:n,asOf:s,tag:i}=e;if(!r&&!n)throw new Error("Must provide either datasetName or datasetId");const a=r??(await this.readDataset({datasetName:n})).id;xe(a);const o=JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:i});await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await fe(c,"update dataset tags",!0),c})}async deleteDataset({datasetId:e,datasetName:r}){let n="/datasets",s=e;if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(r!==void 0&&(s=(await this.readDataset({datasetName:r})).id),s!==void 0)xe(s),n+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const i=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(i,`delete ${n}`,!0),i})}async indexDataset({datasetId:e,datasetName:r,tag:n}){let s=e;if(!s&&!r)throw new Error("Must provide either datasetName or datasetId");if(s&&r)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:r})).id),xe(s);const a=JSON.stringify({tag:n});await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await fe(c,"index dataset"),c})).json()}async similarExamples(e,r,n,{filter:s}={}){const i={limit:n,inputs:e};s!==void 0&&(i.filter=s),xe(r);const a=JSON.stringify(i);return(await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${r}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:a});return await fe(u,"fetch similar examples"),u})).json()).examples}async createExample(e,r,n){var l;if(tg(e)&&(r!==void 0||n!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let s=r?n==null?void 0:n.datasetId:e.dataset_id;const i=r?n==null?void 0:n.datasetName:e.dataset_name;if(s===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:i})).id);const a=(r?n==null?void 0:n.createdAt:e.created_at)||new Date;let o;tg(e)?o=e:o={inputs:e,outputs:r,created_at:a==null?void 0:a.toISOString(),id:n==null?void 0:n.exampleId,metadata:n==null?void 0:n.metadata,split:n==null?void 0:n.split,source_run_id:n==null?void 0:n.sourceRunId,use_source_run_io:n==null?void 0:n.useSourceRunIO,use_source_run_attachments:n==null?void 0:n.useSourceRunAttachments,attachments:n==null?void 0:n.attachments};const c=await this._uploadExamplesMultipart(s,[o]);return await this.readExample(((l=c.example_ids)==null?void 0:l[0])??Js())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const E=e;let b=E[0].dataset_id;const I=E[0].dataset_name;if(b===void 0&&I===void 0)throw new Error("Must provide either datasetName or datasetId");if(b!==void 0&&I!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");b===void 0&&(b=(await this.readDataset({datasetName:I})).id);const k=await this._uploadExamplesMultipart(b,E);return await Promise.all(k.example_ids.map(P=>this.readExample(P)))}const{inputs:r,outputs:n,metadata:s,splits:i,sourceRunIds:a,useSourceRunIOs:o,useSourceRunAttachments:c,attachments:u,exampleIds:l,datasetId:d,datasetName:h}=e;if(r===void 0)throw new Error("Must provide inputs when using legacy parameters");let p=d;const m=h;if(p===void 0&&m===void 0)throw new Error("Must provide either datasetName or datasetId");if(p!==void 0&&m!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");p===void 0&&(p=(await this.readDataset({datasetName:m})).id);const _=r.map((E,b)=>({dataset_id:p,inputs:E,outputs:n==null?void 0:n[b],metadata:s==null?void 0:s[b],split:i==null?void 0:i[b],id:l==null?void 0:l[b],attachments:u==null?void 0:u[b],source_run_id:a==null?void 0:a[b],use_source_run_io:o==null?void 0:o[b],use_source_run_attachments:c==null?void 0:c[b]})),v=await this._uploadExamplesMultipart(p,_);return await Promise.all(v.example_ids.map(E=>this.readExample(E)))}async createLLMExample(e,r,n){return this.createExample({input:e},{output:r},n)}async createChatExample(e,r,n){const s=e.map(a=>nm(a)?sm(a):a),i=nm(r)?sm(r):r;return this.createExample({input:s},{output:i},n)}async readExample(e){xe(e);const r=`/examples/${e}`,n=await this._get(r),{attachment_urls:s,...i}=n,a=i;return s&&(a.attachments=Object.entries(s).reduce((o,[c,u])=>(o[c.slice(11)]={presigned_url:u.presigned_url,mime_type:u.mime_type},o),{})),a}async*listExamples({datasetId:e,datasetName:r,exampleIds:n,asOf:s,splits:i,inlineS3Urls:a,metadata:o,limit:c,offset:u,filter:l,includeAttachments:d}={}){let h;if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(r!==void 0)h=(await this.readDataset({datasetName:r})).id;else throw new Error("Must provide a datasetName or datasetId");const p=new URLSearchParams({dataset:h}),m=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;m&&p.append("as_of",m);const _=a??!0;if(p.append("inline_s3_urls",_.toString()),n!==void 0)for(const y of n)p.append("id",y);if(i!==void 0)for(const y of i)p.append("splits",y);if(o!==void 0){const y=JSON.stringify(o);p.append("metadata",y)}c!==void 0&&p.append("limit",c.toString()),u!==void 0&&p.append("offset",u.toString()),l!==void 0&&p.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(y=>p.append("select",y));let v=0;for await(const y of this._getPaginated("/examples",p)){for(const E of y){const{attachment_urls:b,...I}=E,k=I;b&&(k.attachments=Object.entries(b).reduce((R,[P,T])=>(R[P.slice(11)]={presigned_url:T.presigned_url,mime_type:T.mime_type||void 0},R),{})),yield k,v++}if(c!==void 0&&v>=c)break}}async deleteExample(e){xe(e);const r=`/examples/${e}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(n,`delete ${r}`,!0),n})}async updateExample(e,r){let n;r?n=e:n=e.id,xe(n);let s;r?s={id:n,...r}:s=e;let i;return s.dataset_id!==void 0?i=s.dataset_id:i=(await this.readExample(n)).dataset_id,this._updateExamplesMultipart(i,[s])}async updateExamples(e){let r;return e[0].dataset_id===void 0?r=(await this.readExample(e[0].id)).dataset_id:r=e[0].dataset_id,this._updateExamplesMultipart(r,e)}async readDatasetVersion({datasetId:e,datasetName:r,asOf:n,tag:s}){let i;if(e?i=e:i=(await this.readDataset({datasetName:r})).id,xe(i),n&&s||!n&&!s)throw new Error("Exactly one of asOf and tag must be specified.");const a=new URLSearchParams;return n!==void 0&&a.append("as_of",typeof n=="string"?n:n.toISOString()),s!==void 0&&a.append("tag",s),await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}/version?${a.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(c,"read dataset version"),c})).json()}async listDatasetSplits({datasetId:e,datasetName:r,asOf:n}){let s;if(e===void 0&&r===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:r})).id:s=e,xe(s);const i=new URLSearchParams,a=n?typeof n=="string"?n:n==null?void 0:n.toISOString():void 0;return a&&i.append("as_of",a),await this._get(`/datasets/${s}/splits`,i)}async updateDatasetSplits({datasetId:e,datasetName:r,splitName:n,exampleIds:s,remove:i=!1}){let a;if(e===void 0&&r===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:r})).id:a=e,xe(a);const o={split_name:n,examples:s.map(u=>(xe(u),u)),remove:i},c=JSON.stringify(o);await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${a}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await fe(u,"update dataset splits",!0),u})}async evaluateRun(e,r,{sourceInfo:n,loadChildRuns:s,referenceExample:i}={loadChildRuns:!1}){xd("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let a;if(typeof e=="string")a=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)a=e;else throw new Error(`Invalid run type: ${typeof e}`);a.reference_example_id!==null&&a.reference_example_id!==void 0&&(i=await this.readExample(a.reference_example_id));const o=await r.evaluateRun(a,i),[c,u]=await this._logEvaluationFeedback(o,a,n);return u[0]}async createFeedback(e,r,{score:n,value:s,correction:i,comment:a,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:u,feedbackId:l,feedbackConfig:d,projectId:h,comparativeExperimentId:p}){var E;if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const m={type:c??"api",metadata:o??{}};u!==void 0&&(m==null?void 0:m.metadata)!==void 0&&!m.metadata.__run&&(m.metadata.__run={run_id:u}),(m==null?void 0:m.metadata)!==void 0&&((E=m.metadata.__run)==null?void 0:E.run_id)!==void 0&&xe(m.metadata.__run.run_id);const _={id:l??Js(),run_id:e,key:r,score:Qm(n),value:s,correction:i,comment:a,feedback_source:m,comparative_experiment_id:p,feedbackConfig:d,session_id:h},v=JSON.stringify(_),y=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const b=await this._fetch(y,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:v});return await fe(b,"create feedback",!0),b}),_}async updateFeedback(e,{score:r,value:n,correction:s,comment:i}){const a={};r!=null&&(a.score=Qm(r)),n!=null&&(a.value=n),s!=null&&(a.correction=s),i!=null&&(a.comment=i),xe(e);const o=JSON.stringify(a);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await fe(c,"update feedback",!0),c})}async readFeedback(e){xe(e);const r=`/feedback/${e}`;return await this._get(r)}async deleteFeedback(e){xe(e);const r=`/feedback/${e}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(n,`delete ${r}`,!0),n})}async*listFeedback({runIds:e,feedbackKeys:r,feedbackSourceTypes:n}={}){const s=new URLSearchParams;if(e)for(const i of e)xe(i),s.append("run",i);if(r)for(const i of r)s.append("key",i);if(n)for(const i of n)s.append("source",i);for await(const i of this._getPaginated("/feedback",s))yield*i}async createPresignedFeedbackToken(e,r,{expiration:n,feedbackConfig:s}={}){const i={run_id:e,feedback_key:r,feedback_config:s};n?typeof n=="string"?i.expires_at=n:(n!=null&&n.hours||n!=null&&n.minutes||n!=null&&n.days)&&(i.expires_in=n):i.expires_in={hours:3};const a=JSON.stringify(i);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await fe(c,"create presigned feedback token"),c})).json()}async createComparativeExperiment({name:e,experimentIds:r,referenceDatasetId:n,createdAt:s,description:i,metadata:a,id:o}){var d;if(r.length===0)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:r[0]})).reference_dataset_id),!n==null)throw new Error("A reference dataset is required");const c={id:o,name:e,experiment_ids:r,reference_dataset_id:n,description:i,created_at:(d=s??new Date)==null?void 0:d.toISOString(),extra:{}};a&&(c.extra.metadata=a);const u=JSON.stringify(c);return(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await fe(h,"create comparative experiment"),h})).json()}async*listPresignedFeedbackTokens(e){xe(e);const r=new URLSearchParams({run_id:e});for await(const n of this._getPaginated("/feedback/tokens",r))yield*n}_selectEvalResults(e){let r;return"results"in e?r=e.results:Array.isArray(e)?r=e:r=[e],r}async _logEvaluationFeedback(e,r,n){const s=this._selectEvalResults(e),i=[];for(const a of s){let o=n||{};a.evaluatorInfo&&(o={...a.evaluatorInfo,...o});let c=null;a.targetRunId?c=a.targetRunId:r&&(c=r.id),i.push(await this.createFeedback(c,a.key,{score:a.score,value:a.value,comment:a.comment,correction:a.correction,sourceInfo:o,sourceRunId:a.sourceRunId,feedbackConfig:a.feedbackConfig,feedbackSourceType:"model"}))}return[s,i]}async logEvaluationFeedback(e,r,n){const[s]=await this._logEvaluationFeedback(e,r,n);return s}async*listAnnotationQueues(e={}){const{queueIds:r,name:n,nameContains:s,limit:i}=e,a=new URLSearchParams;r&&r.forEach((c,u)=>{xe(c,`queueIds[${u}]`),a.append("ids",c)}),n&&a.append("name",n),s&&a.append("name_contains",s),a.append("limit",(i!==void 0?Math.min(i,100):100).toString());let o=0;for await(const c of this._getPaginated("/annotation-queues",a))if(yield*c,o++,i!==void 0&&o>=i)break}async createAnnotationQueue(e){const{name:r,description:n,queueId:s,rubricInstructions:i}=e,a={name:r,description:n,id:s||Js(),rubric_instructions:i},o=JSON.stringify(Object.fromEntries(Object.entries(a).filter(([u,l])=>l!==void 0)));return(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await fe(u,"create annotation queue"),u})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${xe(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(n,"read annotation queue"),n})).json()}async updateAnnotationQueue(e,r){const{name:n,description:s,rubricInstructions:i}=r,a=JSON.stringify({name:n,description:s,rubric_instructions:i});await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/annotation-queues/${xe(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await fe(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${xe(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(r,"delete annotation queue",!0),r})}async addRunsToAnnotationQueue(e,r){const n=JSON.stringify(r.map((s,i)=>xe(s,`runIds[${i}]`).toString()));await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/annotation-queues/${xe(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await fe(s,"add runs to annotation queue",!0),s})}async getRunFromAnnotationQueue(e,r){const n=`/annotation-queues/${xe(e,"queueId")}/run`;return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${n}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(i,"get run from annotation queue"),i})).json()}async deleteRunFromAnnotationQueue(e,r){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${xe(e,"queueId")}/runs/${xe(r,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(n,"delete run from annotation queue",!0),n})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${xe(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(n,"get size from annotation queue"),n})).json()}async _currentTenantIsOwner(e){const r=await this._getSettings();return e=="-"||r.tenant_handle===e}async _ownerConflictError(e,r){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${n.tenant_handle}

      Requested tenant: ${r}`)}async _getLatestCommitHash(e){const n=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(s,"get latest commit hash"),s})).json();if(n.commits.length!==0)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,r){const[n,s,i]=Fn(e),a=JSON.stringify({like:r});return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/likes/${n}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await fe(c,`${r?"like":"unlike"} prompt`),c})).json()}async _getPromptUrl(e){const[r,n,s]=Fn(e);if(await this._currentTenantIsOwner(r)){const i=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${n}/${s.substring(0,8)}?organizationId=${i.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${i.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${r}/${n}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${r}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const r of this._getPaginated(`/commits/${e}/`,new URLSearchParams,n=>n.commits))yield*r}async*listPrompts(e){const r=new URLSearchParams;r.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),r.append("sort_direction","desc"),r.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&r.append("is_public",e.isPublic.toString()),e!=null&&e.query&&r.append("query",e.query);for await(const n of this._getPaginated("/repos",r,s=>s.repos))yield*n}async getPrompt(e){const[r,n,s]=Fn(e),i=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return(o==null?void 0:o.status)===404?null:(await fe(o,"get prompt"),o)}),a=await(i==null?void 0:i.json());return a!=null&&a.repo?a.repo:null}async createPrompt(e,r){const n=await this._getSettings();if(r!=null&&r.isPublic&&!n.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,i,a]=Fn(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const o={repo_handle:i,...(r==null?void 0:r.description)&&{description:r.description},...(r==null?void 0:r.readme)&&{readme:r.readme},...(r==null?void 0:r.tags)&&{tags:r.tags},is_public:!!(r!=null&&r.isPublic)},c=JSON.stringify(o),u=await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await fe(d,"create prompt"),d}),{repo:l}=await u.json();return l}async createCommit(e,r,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,i,a]=Fn(e),o=(n==null?void 0:n.parentCommitHash)==="latest"||!(n!=null&&n.parentCommitHash)?await this._getLatestCommitHash(`${s}/${i}`):n==null?void 0:n.parentCommitHash,c={manifest:JSON.parse(JSON.stringify(r)),parent_commit:o},u=JSON.stringify(c),d=await(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/commits/${s}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await fe(h,"create commit"),h})).json();return this._getPromptUrl(`${s}/${i}${d.commit_hash?`:${d.commit_hash}`:""}`)}async updateExamplesMultipart(e,r=[]){return this._updateExamplesMultipart(e,r)}async _updateExamplesMultipart(e,r=[]){var a;if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const o of r){const c=o.id,u={...o.metadata&&{metadata:o.metadata},...o.split&&{split:o.split}},l=dr(u,`Serializing body for example with id: ${c}`),d=new Blob([l],{type:"application/json"});if(n.append(c,d),o.inputs){const h=dr(o.inputs,`Serializing inputs for example with id: ${c}`),p=new Blob([h],{type:"application/json"});n.append(`${c}.inputs`,p)}if(o.outputs){const h=dr(o.outputs,`Serializing outputs whle updating example with id: ${c}`),p=new Blob([h],{type:"application/json"});n.append(`${c}.outputs`,p)}if(o.attachments)for(const[h,p]of Object.entries(o.attachments)){let m,_;Array.isArray(p)?[m,_]=p:(m=p.mimeType,_=p.data);const v=new Blob([_],{type:`${m}; length=${_.byteLength}`});n.append(`${c}.attachment.${h}`,v)}if(o.attachments_operations){const h=dr(o.attachments_operations,`Serializing attachments while updating example with id: ${c}`),p=new Blob([h],{type:"application/json"});n.append(`${c}.attachments_operations`,p)}}const s=e??((a=r[0])==null?void 0:a.dataset_id);return(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${s}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await fe(o,"update examples"),o})).json()}async uploadExamplesMultipart(e,r=[]){return this._uploadExamplesMultipart(e,r)}async _uploadExamplesMultipart(e,r=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const i of r){const a=(i.id??Js()).toString(),o={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split},...i.source_run_id&&{source_run_id:i.source_run_id},...i.use_source_run_io&&{use_source_run_io:i.use_source_run_io},...i.use_source_run_attachments&&{use_source_run_attachments:i.use_source_run_attachments}},c=dr(o,`Serializing body for uploaded example with id: ${a}`),u=new Blob([c],{type:"application/json"});if(n.append(a,u),i.inputs){const l=dr(i.inputs,`Serializing inputs for uploaded example with id: ${a}`),d=new Blob([l],{type:"application/json"});n.append(`${a}.inputs`,d)}if(i.outputs){const l=dr(i.outputs,`Serializing outputs for uploaded example with id: ${a}`),d=new Blob([l],{type:"application/json"});n.append(`${a}.outputs`,d)}if(i.attachments)for(const[l,d]of Object.entries(i.attachments)){let h,p;Array.isArray(d)?[h,p]=d:(h=d.mimeType,p=d.data);const m=new Blob([p],{type:`${h}; length=${p.byteLength}`});n.append(`${a}.attachment.${l}`,m)}}return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await fe(i,"upload examples"),i})).json()}async updatePrompt(e,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,s]=Fn(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const i={};if((r==null?void 0:r.description)!==void 0&&(i.description=r.description),(r==null?void 0:r.readme)!==void 0&&(i.readme=r.readme),(r==null?void 0:r.tags)!==void 0&&(i.tags=r.tags),(r==null?void 0:r.isPublic)!==void 0&&(i.is_public=r.isPublic),(r==null?void 0:r.isArchived)!==void 0&&(i.is_archived=r.isArchived),Object.keys(i).length===0)throw new Error("No valid update options provided");const a=JSON.stringify(i);return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/repos/${n}/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await fe(c,"update prompt"),c})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,n,s]=Fn(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("delete a prompt",r);return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(a,"delete prompt"),a})).json()}async pullPromptCommit(e,r){const[n,s,i]=Fn(e),o=await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/commits/${n}/${s}/${i}${r!=null&&r.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fe(c,"pull prompt commit"),c})).json();return{owner:n,repo:s,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,r){const n=await this.pullPromptCommit(e,{includeModel:r==null?void 0:r.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,r){return await this.promptExists(e)?r&&Object.keys(r).some(s=>s!=="object")&&await this.updatePrompt(e,{description:r==null?void 0:r.description,readme:r==null?void 0:r.readme,tags:r==null?void 0:r.tags,isPublic:r==null?void 0:r.isPublic}):await this.createPrompt(e,{description:r==null?void 0:r.description,readme:r==null?void 0:r.readme,tags:r==null?void 0:r.tags,isPublic:r==null?void 0:r.isPublic}),r!=null&&r.object?await this.createCommit(e,r==null?void 0:r.object,{parentCommitHash:r==null?void 0:r.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,r={}){const{sourceApiUrl:n=this.apiUrl,datasetName:s}=r,[i,a]=this.parseTokenOrUrl(e,n),o=new Ad({apiUrl:i,apiKey:"placeholder"}),c=await o.readSharedDataset(a),u=s||c.name;try{if(await this.hasDataset({datasetId:u})){console.log(`Dataset ${u} already exists in your tenant. Skipping.`);return}}catch{}const l=await o.listSharedExamples(a),d=await this.createDataset(u,{description:c.description,dataType:c.data_type||"kv",inputsSchema:c.inputs_schema_definition??void 0,outputsSchema:c.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(h=>h.inputs),outputs:l.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${u}. You should delete it manually.`),h}}parseTokenOrUrl(e,r,n=2,s="dataset"){try{return xe(e),[r,e]}catch{}try{const a=new URL(e).pathname.split("/").filter(o=>o!=="");if(a.length>=n){const o=a[a.length-n];return[r,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}async awaitPendingTraceBatches(){var e,r;if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:n})=>n),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await((r=(e=pA())==null?void 0:e.DEFAULT_LANGSMITH_SPAN_PROCESSOR)==null?void 0:r.forceFlush())}};function tg(t){return"dataset_id"in t||"dataset_name"in t}const wC=t=>!!["TRACING_V2","TRACING"].find(r=>Qt(r)==="true"),Nl=Symbol.for("lc:context_variables");function vC(t){return t.replace(/[-:.]/g,"")}function Nw(t,e,r=1){const n=r.toFixed(0).slice(0,3).padStart(3,"0"),s=`${new Date(t).toISOString().slice(0,-1)}${n}Z`;return{dottedOrder:vC(s)+e,microsecondPrecisionDatestring:s}}class tc{constructor(e,r,n,s){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=r,this.project_name=n,this.replicas=s}static fromHeader(e){const r=e.split(",");let n={},s=[],i,a;for(const o of r){const[c,u]=o.split("="),l=decodeURIComponent(u);c==="langsmith-metadata"?n=JSON.parse(l):c==="langsmith-tags"?s=l.split(","):c==="langsmith-project"?i=l:c==="langsmith-replicas"&&(a=JSON.parse(l))}return new tc(n,s,i,a)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class Xt{constructor(e){var o;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),bC(e)){Object.assign(this,{...e});return}const r=Xt.getDefaultConfig(),{metadata:n,...s}=e,i=s.client??Xt.getSharedClient(),a={...n,...(o=s==null?void 0:s.extra)==null?void 0:o.metadata};if(s.extra={...s.extra,metadata:a},Object.assign(this,{...r,...s,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=AC(this.replicas),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){const{dottedOrder:c,microsecondPrecisionDatestring:u}=Nw(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+c:this.dotted_order=c,this._serialized_start_time=u}}set metadata(e){var r;this.extra={...this.extra,metadata:{...(r=this.extra)==null?void 0:r.metadata,...e}}}get metadata(){var e;return(e=this.extra)==null?void 0:e.metadata}static getDefaultConfig(){return{id:Js(),run_type:"chain",project_name:_w(),child_runs:[],api_url:fn("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:fn("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return Xt.sharedClient||(Xt.sharedClient=new tf),Xt.sharedClient}createChild(e){var c,u,l,d,h,p;const r=this.child_execution_order+1,n=new Xt({...e,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:r,child_execution_order:r});Nl in this&&(n[Nl]=this[Nl]);const s=Symbol.for("lc:child_config"),i=((c=e.extra)==null?void 0:c[s])??this.extra[s];if(SC(i)){const m={...i},_=EC(m.callbacks)?(l=(u=m.callbacks).copy)==null?void 0:l.call(u):void 0;_&&(Object.assign(_,{_parentRunId:n.id}),(p=(h=(d=_.handlers)==null?void 0:d.find($w))==null?void 0:h.updateFromRunTree)==null||p.call(h,n),m.callbacks=_),n.extra[s]=m}const a=new Set;let o=this;for(;o!=null&&!a.has(o.id);)a.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,r),o=o.parent_run;return this.child_runs.push(n),n}async end(e,r,n=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??r,this.end_time=this.end_time??n,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,r,n=!0){var o,c;const s=e.extra??{};if(((o=s==null?void 0:s.runtime)==null?void 0:o.library)===void 0&&(s.runtime||(s.runtime={}),r))for(const[u,l]of Object.entries(r))s.runtime[u]||(s.runtime[u]=l);let i,a;return n?(a=((c=e.parent_run)==null?void 0:c.id)??e.parent_run_id,i=[]):(i=e.child_runs.map(u=>this._convertToCreate(u,r,n)),a=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:i,parent_run_id:a,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_remapForProject(e,r,n=!0){const s=this._convertToCreate(this,r,n);if(e===this.project_name)return s;const i=d=>Bp(`${d}:${e}`,Bp.DNS),a=i(s.id),o=s.trace_id?i(s.trace_id):void 0,c=s.parent_run_id?i(s.parent_run_id):void 0;let u;if(s.dotted_order){const d=xC(s.dotted_order),h=[];for(let m=0;m<d.length-1;m++){const[_,v]=d[m],y=i(v);h.push(_.toISOString().replace(/[-:]/g,"").replace(".","")+y)}const[p]=d[d.length-1];h.push(p.toISOString().replace(/[-:]/g,"").replace(".","")+a),u=h.join(".")}else u=void 0;return{...s,id:a,trace_id:o,parent_run_id:c,dotted_order:u,session_name:e}}async postRun(e=!0){try{const r=Ew();if(this.replicas&&this.replicas.length>0)for(const{projectName:n,apiKey:s,apiUrl:i,workspaceId:a}of this.replicas){const o=this._remapForProject(n??this.project_name,r,!0);await this.client.createRun(o,{apiKey:s,apiUrl:i,workspaceId:a})}else{const n=this._convertToCreate(this,r,e);await this.client.createRun(n)}if(!e){xd("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const n of this.child_runs)await n.postRun(!1)}}catch(r){console.error(`Error in postRun for run ${this.id}:`,r)}}async patchRun(e){var r;if(this.replicas&&this.replicas.length>0)for(const{projectName:n,apiKey:s,apiUrl:i,workspaceId:a,updates:o}of this.replicas){const c=this._remapForProject(n??this.project_name),u={id:c.id,outputs:c.outputs,error:c.error,parent_run_id:c.parent_run_id,session_name:c.session_name,reference_example_id:c.reference_example_id,end_time:c.end_time,dotted_order:c.dotted_order,trace_id:c.trace_id,events:c.events,tags:c.tags,extra:c.extra,attachments:this.attachments,...o};e!=null&&e.excludeInputs||(u.inputs=c.inputs),await this.client.updateRun(c.id,u,{apiKey:s,apiUrl:i,workspaceId:a})}else try{const n={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:((r=this.parent_run)==null?void 0:r.id)??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e!=null&&e.excludeInputs||(n.inputs=this.inputs),await this.client.updateRun(this.id,n)}catch(n){console.error(`Error in patchRun for run ${this.id}`,n)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,r){var u,l,d,h;const n=e==null?void 0:e.callbacks;let s,i,a,o=wC();if(n){const p=((u=n==null?void 0:n.getParentRunId)==null?void 0:u.call(n))??"",m=(l=n==null?void 0:n.handlers)==null?void 0:l.find(_=>(_==null?void 0:_.name)=="langchain_tracer");s=(d=m==null?void 0:m.getRun)==null?void 0:d.call(m,p),i=m==null?void 0:m.projectName,a=m==null?void 0:m.client,o=o||!!m}return s?new Xt({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:a,tracingEnabled:o,project_name:i,tags:[...new Set(((s==null?void 0:s.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(h=s==null?void 0:s.extra)==null?void 0:h.metadata,...e==null?void 0:e.metadata}}}).createChild(r):new Xt({...r,client:a,tracingEnabled:o,project_name:i})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,r){var u;const n="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=n["langsmith-trace"];if(!s||typeof s!="string")return;const i=s.trim(),a=i.split(".").map(l=>{const[d,h]=l.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:h}}),o=a[0].uuid,c={...r,name:(r==null?void 0:r.name)??"parent",run_type:(r==null?void 0:r.run_type)??"chain",start_time:(r==null?void 0:r.start_time)??Date.now(),id:(u=a.at(-1))==null?void 0:u.uuid,trace_id:o,dotted_order:i};if(n.baggage&&typeof n.baggage=="string"){const l=tc.fromHeader(n.baggage);c.metadata=l.metadata,c.tags=l.tags,c.project_name=l.project_name,c.replicas=l.replicas}return new Xt(c)}toHeaders(e){var n;const r={"langsmith-trace":this.dotted_order,baggage:new tc((n=this.extra)==null?void 0:n.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[s,i]of Object.entries(r))e.set(s,i);return r}}Object.defineProperty(Xt,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function bC(t){return t!=null&&typeof t.createChild=="function"&&typeof t.postRun=="function"}function $w(t){return typeof t=="object"&&t!=null&&typeof t.name=="string"&&t.name==="langchain_tracer"}function rg(t){return Array.isArray(t)&&t.some(e=>$w(e))}function EC(t){return typeof t=="object"&&t!=null&&Array.isArray(t.handlers)}function SC(t){var e;return t!=null&&typeof t.callbacks=="object"&&(rg((e=t.callbacks)==null?void 0:e.handlers)||rg(t.callbacks))}function xC(t){return t.split(".").map(r=>{const n=r.slice(0,-36),s=r.slice(-36),i=parseInt(n.slice(0,4)),a=parseInt(n.slice(4,6))-1,o=parseInt(n.slice(6,8)),c=parseInt(n.slice(9,11)),u=parseInt(n.slice(11,13)),l=parseInt(n.slice(13,15)),d=parseInt(n.slice(15,21));return[new Date(i,a,o,c,u,l,d/1e3),s]})}function TC(){const t=fn("LANGSMITH_RUNS_ENDPOINTS");if(!t)return[];try{const e=JSON.parse(t);if(Array.isArray(e)){const r=[];for(const n of e){if(typeof n!="object"||n===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof n}`);continue}if(typeof n.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_url}`);continue}if(typeof n.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_key}`);continue}r.push({apiUrl:n.api_url.replace(/\/$/,""),apiKey:n.api_key})}return r}else if(typeof e=="object"&&e!==null){CC(e);const r=[];for(const[n,s]of Object.entries(e)){const i=n.replace(/\/$/,"");if(typeof s=="string")r.push({apiUrl:i,apiKey:s});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${n}: expected string, got ${typeof s}`);continue}}return r}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS – must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof e}`),[]}catch(e){if(iC(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS – must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function AC(t){return t?t.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):TC()}function CC(t){if(Object.keys(t).length>0&&Qt("ENDPOINT"))throw new sC}var Pw={};me(Pw,{BaseTracer:()=>Un,isBaseTracer:()=>Zs});const kC=t=>{if(t)return t.events=t.events??[],t.child_runs=t.child_runs??[],t};function Cd(t,e){if(t)return new Xt({...t,start_time:t._serialized_start_time??t.start_time,parent_run:Cd(e),child_runs:t.child_runs.map(r=>Cd(r)).filter(r=>r!==void 0),extra:{...t.extra,runtime:tw()},tracingEnabled:!1})}function $l(t,e){return t&&!Array.isArray(t)&&typeof t=="object"?t:{[e]:t}}function Zs(t){return typeof t._addRunToRunMap=="function"}var Un=class extends Ii{constructor(e){super(...arguments);f(this,"runMap",new Map);f(this,"runTreeMap",new Map);f(this,"usesRunTreeMap",!1)}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?kC(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,r){e.child_runs.push(r)}_addRunToRunMap(e){const{dottedOrder:r,microsecondPrecisionDatestring:n}=Nw(new Date(e.start_time).getTime(),e.id,e.execution_order),s={...e},i=this.getRunById(s.parent_run_id);if(s.parent_run_id!==void 0?i&&(this._addChildRun(i,s),i.child_execution_order=Math.max(i.child_execution_order,s.child_execution_order),s.trace_id=i.trace_id,i.dotted_order!==void 0&&(s.dotted_order=[i.dotted_order,r].join("."),s._serialized_start_time=n)):(s.trace_id=s.id,s.dotted_order=r,s._serialized_start_time=n),this.usesRunTreeMap){const a=Cd(s,i);a!==void 0&&this.runTreeMap.set(s.id,a)}else this.runMap.set(s.id,s);return s}async _endTrace(e){var n;const r=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);r?r.child_execution_order=Math.max(r.child_execution_order,e.child_execution_order):await this.persistRun(e),await((n=this.onRunUpdate)==null?void 0:n.call(this,e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const r=e!==void 0&&this.getRunById(e);return r?r.child_execution_order+1:1}_createRunForLLMStart(e,r,n,s,i,a,o,c){const u=this._getExecutionOrder(s),l=Date.now(),d=o?{...i,metadata:o}:i,h={id:n,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:r},execution_order:u,child_runs:[],child_execution_order:u,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,r,n,s,i,a,o,c){var l,d;const u=this.getRunById(n)??this._createRunForLLMStart(e,r,n,s,i,a,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onLLMStart)==null?void 0:d.call(this,u)),u}_createRunForChatModelStart(e,r,n,s,i,a,o,c){const u=this._getExecutionOrder(s),l=Date.now(),d=o?{...i,metadata:o}:i,h={id:n,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:r},execution_order:u,child_runs:[],child_execution_order:u,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,r,n,s,i,a,o,c){var l,d;const u=this.getRunById(n)??this._createRunForChatModelStart(e,r,n,s,i,a,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onLLMStart)==null?void 0:d.call(this,u)),u}async handleLLMEnd(e,r,n,s,i){var o;const a=this.getRunById(r);if(!a||(a==null?void 0:a.run_type)!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.outputs=e,a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await((o=this.onLLMEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleLLMError(e,r,n,s,i){var o;const a=this.getRunById(r);if(!a||(a==null?void 0:a.run_type)!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await((o=this.onLLMError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}_createRunForChainStart(e,r,n,s,i,a,o,c){const u=this._getExecutionOrder(s),l=Date.now(),d={id:n,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:r,execution_order:u,child_execution_order:u,run_type:o??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(d)}async handleChainStart(e,r,n,s,i,a,o,c){var l,d;const u=this.getRunById(n)??this._createRunForChainStart(e,r,n,s,i,a,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onChainStart)==null?void 0:d.call(this,u)),u}async handleChainEnd(e,r,n,s,i){var o;const a=this.getRunById(r);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=$l(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=$l(i.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleChainError(e,r,n,s,i){var o;const a=this.getRunById(r);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=$l(i.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}_createRunForToolStart(e,r,n,s,i,a,o){const c=this._getExecutionOrder(s),u=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{input:r},execution_order:c,child_execution_order:c,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleToolStart(e,r,n,s,i,a,o){var u,l;const c=this.getRunById(n)??this._createRunForToolStart(e,r,n,s,i,a,o);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((l=this.onToolStart)==null?void 0:l.call(this,c)),c}async handleToolEnd(e,r){var s;const n=this.getRunById(r);if(!n||(n==null?void 0:n.run_type)!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleToolError(e,r){var s;const n=this.getRunById(r);if(!n||(n==null?void 0:n.run_type)!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleAgentAction(e,r){var i;const n=this.getRunById(r);if(!n||(n==null?void 0:n.run_type)!=="chain")return;const s=n;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((i=this.onAgentAction)==null?void 0:i.call(this,n))}async handleAgentEnd(e,r){var s;const n=this.getRunById(r);!n||(n==null?void 0:n.run_type)!=="chain"||(n.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,n)))}_createRunForRetrieverStart(e,r,n,s,i,a,o){const c=this._getExecutionOrder(s),u=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{query:r},execution_order:c,child_execution_order:c,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,r,n,s,i,a,o){var u,l;const c=this.getRunById(n)??this._createRunForRetrieverStart(e,r,n,s,i,a,o);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((l=this.onRetrieverStart)==null?void 0:l.call(this,c)),c}async handleRetrieverEnd(e,r){var s;const n=this.getRunById(r);if(!n||(n==null?void 0:n.run_type)!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleRetrieverError(e,r){var s;const n=this.getRunById(r);if(!n||(n==null?void 0:n.run_type)!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,n)),await this._endTrace(n),n}async handleText(e,r){var s;const n=this.getRunById(r);!n||(n==null?void 0:n.run_type)!=="chain"||(n.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,n)))}async handleLLMNewToken(e,r,n,s,i,a){var c;const o=this.getRunById(n);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:r,chunk:a==null?void 0:a.chunk}}),await((c=this.onLLMNewToken)==null?void 0:c.call(this,o,e,{chunk:a==null?void 0:a.chunk})),o}},No={exports:{}};No.exports;var ng;function IC(){return ng||(ng=1,(function(t){const r=(i=0)=>a=>`\x1B[${38+i};5;${a}m`,n=(i=0)=>(a,o,c)=>`\x1B[${38+i};2;${a};${o};${c}m`;function s(){const i=new Map,a={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};a.color.gray=a.color.blackBright,a.bgColor.bgGray=a.bgColor.bgBlackBright,a.color.grey=a.color.blackBright,a.bgColor.bgGrey=a.bgColor.bgBlackBright;for(const[o,c]of Object.entries(a)){for(const[u,l]of Object.entries(c))a[u]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},c[u]=a[u],i.set(l[0],l[1]);Object.defineProperty(a,o,{value:c,enumerable:!1})}return Object.defineProperty(a,"codes",{value:i,enumerable:!1}),a.color.close="\x1B[39m",a.bgColor.close="\x1B[49m",a.color.ansi256=r(),a.color.ansi16m=n(),a.bgColor.ansi256=r(10),a.bgColor.ansi16m=n(10),Object.defineProperties(a,{rgbToAnsi256:{value:(o,c,u)=>o===c&&c===u?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(u/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:u}=c.groups;u.length===3&&(u=u.split("").map(d=>d+d).join(""));const l=Number.parseInt(u,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>a.rgbToAnsi256(...a.hexToRgb(o)),enumerable:!1}}),a}Object.defineProperty(t,"exports",{enumerable:!0,get:s})})(No)),No.exports}var RC=IC();const Lw=ki(RC);var Dw={};me(Dw,{ConsoleCallbackHandler:()=>kd});function Bt(t,e){return`${t.open}${e}${t.close}`}function br(t,e){try{return JSON.stringify(t,null,2)}catch{return e}}function sg(t){return typeof t=="string"?t.trim():t==null?t:br(t,t.toString())}function jn(t){if(!t.end_time)return"";const e=t.end_time-t.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:Kt}=Lw;var kd=class extends Un{constructor(){super(...arguments);f(this,"name","console_callback_handler")}persistRun(e){return Promise.resolve()}getParents(e){const r=[];let n=e;for(;n.parent_run_id;){const s=this.runMap.get(n.parent_run_id);if(s)r.push(s),n=s;else break}return r}getBreadcrumbs(e){const n=[...this.getParents(e).reverse(),e].map((s,i,a)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return i===a.length-1?Bt(Lw.bold,o):o}).join(" > ");return Bt(Kt.grey,n)}onChainStart(e){const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.green,"[chain/start]")} [${r}] Entering Chain run with input: ${br(e.inputs,"[inputs]")}`)}onChainEnd(e){const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.cyan,"[chain/end]")} [${r}] [${jn(e)}] Exiting Chain run with output: ${br(e.outputs,"[outputs]")}`)}onChainError(e){const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.red,"[chain/error]")} [${r}] [${jn(e)}] Chain run errored with error: ${br(e.error,"[error]")}`)}onLLMStart(e){const r=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${Bt(Kt.green,"[llm/start]")} [${r}] Entering LLM run with input: ${br(n,"[inputs]")}`)}onLLMEnd(e){const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.cyan,"[llm/end]")} [${r}] [${jn(e)}] Exiting LLM run with output: ${br(e.outputs,"[response]")}`)}onLLMError(e){const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.red,"[llm/error]")} [${r}] [${jn(e)}] LLM run errored with error: ${br(e.error,"[error]")}`)}onToolStart(e){const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.green,"[tool/start]")} [${r}] Entering Tool run with input: "${sg(e.inputs.input)}"`)}onToolEnd(e){var n;const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.cyan,"[tool/end]")} [${r}] [${jn(e)}] Exiting Tool run with output: "${sg((n=e.outputs)==null?void 0:n.output)}"`)}onToolError(e){const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.red,"[tool/error]")} [${r}] [${jn(e)}] Tool run errored with error: ${br(e.error,"[error]")}`)}onRetrieverStart(e){const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.green,"[retriever/start]")} [${r}] Entering Retriever run with input: ${br(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.cyan,"[retriever/end]")} [${r}] [${jn(e)}] Exiting Retriever run with output: ${br(e.outputs,"[outputs]")}`)}onRetrieverError(e){const r=this.getBreadcrumbs(e);console.log(`${Bt(Kt.red,"[retriever/error]")} [${r}] [${jn(e)}] Retriever run errored with error: ${br(e.error,"[error]")}`)}onAgentAction(e){const r=e,n=this.getBreadcrumbs(e);console.log(`${Bt(Kt.blue,"[agent/action]")} [${n}] Agent selected action: ${br(r.actions[r.actions.length-1],"[action]")}`)}};let Pl;const Mw=()=>{if(Pl===void 0){const t=cn("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Pl=new tf(t)}return Pl};let OC=class{getStore(){}run(e,r){return r()}};const Ll=Symbol.for("ls:tracing_async_local_storage"),NC=new OC;let $C=class{getInstance(){return globalThis[Ll]??NC}initializeGlobalInstance(e){globalThis[Ll]===void 0&&(globalThis[Ll]=e)}};const PC=new $C;function LC(t=!1){const e=PC.getInstance().getStore();if(!t&&e===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function rf(t){return typeof t=="function"&&"langsmith:traceable"in t}var Uw={};me(Uw,{LangChainTracer:()=>$o});var $o=class Bw extends Un{constructor(r={}){super(r);f(this,"name","langchain_tracer");f(this,"projectName");f(this,"exampleId");f(this,"client");f(this,"replicas");f(this,"usesRunTreeMap",!0);const{exampleId:n,projectName:s,client:i,replicas:a}=r;this.projectName=s??_w(),this.replicas=a,this.exampleId=n,this.client=i??Mw();const o=Bw.getTraceableRunTree();o&&this.updateFromRunTree(o)}async persistRun(r){}async onRunCreate(r){const n=this.getRunTreeWithTracingConfig(r.id);await(n==null?void 0:n.postRun())}async onRunUpdate(r){const n=this.getRunTreeWithTracingConfig(r.id);await(n==null?void 0:n.patchRun())}getRun(r){return this.runTreeMap.get(r)}updateFromRunTree(r){this.runTreeMap.set(r.id,r);let n=r;const s=new Set;for(;n.parent_run&&!(s.has(n.id)||(s.add(n.id),!n.parent_run));)n=n.parent_run;s.clear();const i=[n];for(;i.length>0;){const a=i.shift();!a||s.has(a.id)||(s.add(a.id),this.runTreeMap.set(a.id,a),a.child_runs&&i.push(...a.child_runs))}this.client=r.client??this.client,this.replicas=r.replicas??this.replicas,this.projectName=r.project_name??this.projectName,this.exampleId=r.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(r){const n=this.runTreeMap.get(r);if(n)return new Xt({...n,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return LC(!0)}catch{return}}};const Fw=Symbol.for("ls:tracing_async_local_storage"),Qi=Symbol.for("lc:context_variables"),DC=t=>{globalThis[Fw]=t},da=()=>globalThis[Fw];let Es;function MC(){const t="default"in An?An.default:An;return new t({autoStart:!0,concurrency:1})}function UC(){return typeof Es>"u"&&(Es=MC()),Es}async function ct(t,e){if(e===!0){const r=da();r!==void 0?await r.run(void 0,async()=>t()):await t()}else Es=UC(),Es.add(async()=>{const r=da();r!==void 0?await r.run(void 0,async()=>t()):await t()})}async function BC(){const t=Mw();await Promise.allSettled([typeof Es<"u"?Es.onIdle():Promise.resolve(),t.awaitPendingTraceBatches()])}var jw={};me(jw,{awaitAllCallbacks:()=>BC,consumeCallback:()=>ct});function Id(t,e=di){t=t.trim();const r=t.indexOf("```");if(r===-1)return e(t);let n=t.substring(r+3);n.startsWith(`json
`)?n=n.substring(5):n.startsWith("json")?n=n.substring(4):n.startsWith(`
`)&&(n=n.substring(1));const s=n.indexOf("```");let i=n;return s!==-1&&(i=n.substring(0,s)),e(i.trim())}function di(t){if(typeof t>"u")return null;try{return JSON.parse(t)}catch{}let e="";const r=[];let n=!1,s=!1;for(let i of t){if(n)i==='"'&&!s?n=!1:i===`
`&&!s?i="\\n":i==="\\"?s=!s:s=!1;else if(i==='"')n=!0,s=!1;else if(i==="{")r.push("}");else if(i==="[")r.push("]");else if(i==="}"||i==="]")if(r&&r[r.length-1]===i)r.pop();else return null;e+=i}n&&(e+='"');for(let i=r.length-1;i>=0;i-=1)e+=r[i];try{return JSON.parse(e)}catch{return null}}var zw={},Hc={};Hc.byteLength=zC;Hc.toByteArray=GC;Hc.fromByteArray=WC;var tn=[],Er=[],FC=typeof Uint8Array<"u"?Uint8Array:Array,Dl="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Vs=0,jC=Dl.length;Vs<jC;++Vs)tn[Vs]=Dl[Vs],Er[Dl.charCodeAt(Vs)]=Vs;Er[45]=62;Er[95]=63;function Vw(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=t.indexOf("=");r===-1&&(r=e);var n=r===e?0:4-r%4;return[r,n]}function zC(t){var e=Vw(t),r=e[0],n=e[1];return(r+n)*3/4-n}function VC(t,e,r){return(e+r)*3/4-r}function GC(t){var e,r=Vw(t),n=r[0],s=r[1],i=new FC(VC(t,n,s)),a=0,o=s>0?n-4:n,c;for(c=0;c<o;c+=4)e=Er[t.charCodeAt(c)]<<18|Er[t.charCodeAt(c+1)]<<12|Er[t.charCodeAt(c+2)]<<6|Er[t.charCodeAt(c+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return s===2&&(e=Er[t.charCodeAt(c)]<<2|Er[t.charCodeAt(c+1)]>>4,i[a++]=e&255),s===1&&(e=Er[t.charCodeAt(c)]<<10|Er[t.charCodeAt(c+1)]<<4|Er[t.charCodeAt(c+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function HC(t){return tn[t>>18&63]+tn[t>>12&63]+tn[t>>6&63]+tn[t&63]}function qC(t,e,r){for(var n,s=[],i=e;i<r;i+=3)n=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(HC(n));return s.join("")}function WC(t){for(var e,r=t.length,n=r%3,s=[],i=16383,a=0,o=r-n;a<o;a+=i)s.push(qC(t,a,a+i>o?o:a+i));return n===1?(e=t[r-1],s.push(tn[e>>2]+tn[e<<4&63]+"==")):n===2&&(e=(t[r-2]<<8)+t[r-1],s.push(tn[e>>10]+tn[e>>4&63]+tn[e<<2&63]+"=")),s.join("")}var nf={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */nf.read=function(t,e,r,n,s){var i,a,o=s*8-n-1,c=(1<<o)-1,u=c>>1,l=-7,d=r?s-1:0,h=r?-1:1,p=t[e+d];for(d+=h,i=p&(1<<-l)-1,p>>=-l,l+=o;l>0;i=i*256+t[e+d],d+=h,l-=8);for(a=i&(1<<-l)-1,i>>=-l,l+=n;l>0;a=a*256+t[e+d],d+=h,l-=8);if(i===0)i=1-u;else{if(i===c)return a?NaN:(p?-1:1)*(1/0);a=a+Math.pow(2,n),i=i-u}return(p?-1:1)*a*Math.pow(2,i-n)};nf.write=function(t,e,r,n,s,i){var a,o,c,u=i*8-s-1,l=(1<<u)-1,d=l>>1,h=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:i-1,m=n?1:-1,_=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(o=isNaN(e)?1:0,a=l):(a=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-a))<1&&(a--,c*=2),a+d>=1?e+=h/c:e+=h*Math.pow(2,1-d),e*c>=2&&(a++,c/=2),a+d>=l?(o=0,a=l):a+d>=1?(o=(e*c-1)*Math.pow(2,s),a=a+d):(o=e*Math.pow(2,d-1)*Math.pow(2,s),a=0));s>=8;t[r+p]=o&255,p+=m,o/=256,s-=8);for(a=a<<s|o,u+=s;u>0;t[r+p]=a&255,p+=m,a/=256,u-=8);t[r+p-m]|=_*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(t){const e=Hc,r=nf,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=l,t.SlowBuffer=k,t.INSPECT_MAX_BYTES=50;const s=2147483647;t.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:a,SharedArrayBuffer:o}=globalThis;l.TYPED_ARRAY_SUPPORT=c(),!l.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function c(){try{const x=new i(1),g={foo:function(){return 42}};return Object.setPrototypeOf(g,i.prototype),Object.setPrototypeOf(x,g),x.foo()===42}catch{return!1}}Object.defineProperty(l.prototype,"parent",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.buffer}}),Object.defineProperty(l.prototype,"offset",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.byteOffset}});function u(x){if(x>s)throw new RangeError('The value "'+x+'" is invalid for option "size"');const g=new i(x);return Object.setPrototypeOf(g,l.prototype),g}function l(x,g,w){if(typeof x=="number"){if(typeof g=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return m(x)}return d(x,g,w)}l.poolSize=8192;function d(x,g,w){if(typeof x=="string")return _(x,g);if(a.isView(x))return y(x);if(x==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof x);if(Z(x,a)||x&&Z(x.buffer,a)||typeof o<"u"&&(Z(x,o)||x&&Z(x.buffer,o)))return E(x,g,w);if(typeof x=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const C=x.valueOf&&x.valueOf();if(C!=null&&C!==x)return l.from(C,g,w);const O=b(x);if(O)return O;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof x[Symbol.toPrimitive]=="function")return l.from(x[Symbol.toPrimitive]("string"),g,w);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof x)}l.from=function(x,g,w){return d(x,g,w)},Object.setPrototypeOf(l.prototype,i.prototype),Object.setPrototypeOf(l,i);function h(x){if(typeof x!="number")throw new TypeError('"size" argument must be of type number');if(x<0)throw new RangeError('The value "'+x+'" is invalid for option "size"')}function p(x,g,w){return h(x),x<=0?u(x):g!==void 0?typeof w=="string"?u(x).fill(g,w):u(x).fill(g):u(x)}l.alloc=function(x,g,w){return p(x,g,w)};function m(x){return h(x),u(x<0?0:I(x)|0)}l.allocUnsafe=function(x){return m(x)},l.allocUnsafeSlow=function(x){return m(x)};function _(x,g){if((typeof g!="string"||g==="")&&(g="utf8"),!l.isEncoding(g))throw new TypeError("Unknown encoding: "+g);const w=R(x,g)|0;let C=u(w);const O=C.write(x,g);return O!==w&&(C=C.slice(0,O)),C}function v(x){const g=x.length<0?0:I(x.length)|0,w=u(g);for(let C=0;C<g;C+=1)w[C]=x[C]&255;return w}function y(x){if(Z(x,i)){const g=new i(x);return E(g.buffer,g.byteOffset,g.byteLength)}return v(x)}function E(x,g,w){if(g<0||x.byteLength<g)throw new RangeError('"offset" is outside of buffer bounds');if(x.byteLength<g+(w||0))throw new RangeError('"length" is outside of buffer bounds');let C;return g===void 0&&w===void 0?C=new i(x):w===void 0?C=new i(x,g):C=new i(x,g,w),Object.setPrototypeOf(C,l.prototype),C}function b(x){if(l.isBuffer(x)){const g=I(x.length)|0,w=u(g);return w.length===0||x.copy(w,0,0,g),w}if(x.length!==void 0)return typeof x.length!="number"||W(x.length)?u(0):v(x);if(x.type==="Buffer"&&Array.isArray(x.data))return v(x.data)}function I(x){if(x>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return x|0}function k(x){return+x!=x&&(x=0),l.alloc(+x)}l.isBuffer=function(g){return g!=null&&g._isBuffer===!0&&g!==l.prototype},l.compare=function(g,w){if(Z(g,i)&&(g=l.from(g,g.offset,g.byteLength)),Z(w,i)&&(w=l.from(w,w.offset,w.byteLength)),!l.isBuffer(g)||!l.isBuffer(w))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(g===w)return 0;let C=g.length,O=w.length;for(let $=0,D=Math.min(C,O);$<D;++$)if(g[$]!==w[$]){C=g[$],O=w[$];break}return C<O?-1:O<C?1:0},l.isEncoding=function(g){switch(String(g).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(g,w){if(!Array.isArray(g))throw new TypeError('"list" argument must be an Array of Buffers');if(g.length===0)return l.alloc(0);let C;if(w===void 0)for(w=0,C=0;C<g.length;++C)w+=g[C].length;const O=l.allocUnsafe(w);let $=0;for(C=0;C<g.length;++C){let D=g[C];if(Z(D,i))$+D.length>O.length?(l.isBuffer(D)||(D=l.from(D)),D.copy(O,$)):i.prototype.set.call(O,D,$);else if(l.isBuffer(D))D.copy(O,$);else throw new TypeError('"list" argument must be an Array of Buffers');$+=D.length}return O};function R(x,g){if(l.isBuffer(x))return x.length;if(a.isView(x)||Z(x,a))return x.byteLength;if(typeof x!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof x);const w=x.length,C=arguments.length>2&&arguments[2]===!0;if(!C&&w===0)return 0;let O=!1;for(;;)switch(g){case"ascii":case"latin1":case"binary":return w;case"utf8":case"utf-8":return J(x).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return w*2;case"hex":return w>>>1;case"base64":return de(x).length;default:if(O)return C?-1:J(x).length;g=(""+g).toLowerCase(),O=!0}}l.byteLength=R;function P(x,g,w){let C=!1;if((g===void 0||g<0)&&(g=0),g>this.length||((w===void 0||w>this.length)&&(w=this.length),w<=0)||(w>>>=0,g>>>=0,w<=g))return"";for(x||(x="utf8");;)switch(x){case"hex":return z(this,g,w);case"utf8":case"utf-8":return te(this,g,w);case"ascii":return le(this,g,w);case"latin1":case"binary":return ve(this,g,w);case"base64":return B(this,g,w);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return K(this,g,w);default:if(C)throw new TypeError("Unknown encoding: "+x);x=(x+"").toLowerCase(),C=!0}}l.prototype._isBuffer=!0;function T(x,g,w){const C=x[g];x[g]=x[w],x[w]=C}l.prototype.swap16=function(){const g=this.length;if(g%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let w=0;w<g;w+=2)T(this,w,w+1);return this},l.prototype.swap32=function(){const g=this.length;if(g%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let w=0;w<g;w+=4)T(this,w,w+3),T(this,w+1,w+2);return this},l.prototype.swap64=function(){const g=this.length;if(g%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let w=0;w<g;w+=8)T(this,w,w+7),T(this,w+1,w+6),T(this,w+2,w+5),T(this,w+3,w+4);return this},l.prototype.toString=function(){const g=this.length;return g===0?"":arguments.length===0?te(this,0,g):P.apply(this,arguments)},l.prototype.toLocaleString=l.prototype.toString,l.prototype.equals=function(g){if(!l.isBuffer(g))throw new TypeError("Argument must be a Buffer");return this===g?!0:l.compare(this,g)===0},l.prototype.inspect=function(){let g="";const w=t.INSPECT_MAX_BYTES;return g=this.toString("hex",0,w).replace(/(.{2})/g,"$1 ").trim(),this.length>w&&(g+=" ... "),"<Buffer "+g+">"},n&&(l.prototype[n]=l.prototype.inspect),l.prototype.compare=function(g,w,C,O,$){if(Z(g,i)&&(g=l.from(g,g.offset,g.byteLength)),!l.isBuffer(g))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof g);if(w===void 0&&(w=0),C===void 0&&(C=g?g.length:0),O===void 0&&(O=0),$===void 0&&($=this.length),w<0||C>g.length||O<0||$>this.length)throw new RangeError("out of range index");if(O>=$&&w>=C)return 0;if(O>=$)return-1;if(w>=C)return 1;if(w>>>=0,C>>>=0,O>>>=0,$>>>=0,this===g)return 0;let D=$-O,Oe=C-w;const Qe=Math.min(D,Oe),Ze=this.slice(O,$),et=g.slice(w,C);for(let qe=0;qe<Qe;++qe)if(Ze[qe]!==et[qe]){D=Ze[qe],Oe=et[qe];break}return D<Oe?-1:Oe<D?1:0};function H(x,g,w,C,O){if(x.length===0)return-1;if(typeof w=="string"?(C=w,w=0):w>2147483647?w=2147483647:w<-2147483648&&(w=-2147483648),w=+w,W(w)&&(w=O?0:x.length-1),w<0&&(w=x.length+w),w>=x.length){if(O)return-1;w=x.length-1}else if(w<0)if(O)w=0;else return-1;if(typeof g=="string"&&(g=l.from(g,C)),l.isBuffer(g))return g.length===0?-1:q(x,g,w,C,O);if(typeof g=="number")return g=g&255,typeof i.prototype.indexOf=="function"?O?i.prototype.indexOf.call(x,g,w):i.prototype.lastIndexOf.call(x,g,w):q(x,[g],w,C,O);throw new TypeError("val must be string, number or Buffer")}function q(x,g,w,C,O){let $=1,D=x.length,Oe=g.length;if(C!==void 0&&(C=String(C).toLowerCase(),C==="ucs2"||C==="ucs-2"||C==="utf16le"||C==="utf-16le")){if(x.length<2||g.length<2)return-1;$=2,D/=2,Oe/=2,w/=2}function Qe(et,qe){return $===1?et[qe]:et.readUInt16BE(qe*$)}let Ze;if(O){let et=-1;for(Ze=w;Ze<D;Ze++)if(Qe(x,Ze)===Qe(g,et===-1?0:Ze-et)){if(et===-1&&(et=Ze),Ze-et+1===Oe)return et*$}else et!==-1&&(Ze-=Ze-et),et=-1}else for(w+Oe>D&&(w=D-Oe),Ze=w;Ze>=0;Ze--){let et=!0;for(let qe=0;qe<Oe;qe++)if(Qe(x,Ze+qe)!==Qe(g,qe)){et=!1;break}if(et)return Ze}return-1}l.prototype.includes=function(g,w,C){return this.indexOf(g,w,C)!==-1},l.prototype.indexOf=function(g,w,C){return H(this,g,w,C,!0)},l.prototype.lastIndexOf=function(g,w,C){return H(this,g,w,C,!1)};function se(x,g,w,C){w=Number(w)||0;const O=x.length-w;C?(C=Number(C),C>O&&(C=O)):C=O;const $=g.length;C>$/2&&(C=$/2);let D;for(D=0;D<C;++D){const Oe=parseInt(g.substr(D*2,2),16);if(W(Oe))return D;x[w+D]=Oe}return D}function ee(x,g,w,C){return ge(J(g,x.length-w),x,w,C)}function Te(x,g,w,C){return ge(yn(g),x,w,C)}function M(x,g,w,C){return ge(de(g),x,w,C)}function U(x,g,w,C){return ge(ye(g,x.length-w),x,w,C)}l.prototype.write=function(g,w,C,O){if(w===void 0)O="utf8",C=this.length,w=0;else if(C===void 0&&typeof w=="string")O=w,C=this.length,w=0;else if(isFinite(w))w=w>>>0,isFinite(C)?(C=C>>>0,O===void 0&&(O="utf8")):(O=C,C=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const $=this.length-w;if((C===void 0||C>$)&&(C=$),g.length>0&&(C<0||w<0)||w>this.length)throw new RangeError("Attempt to write outside buffer bounds");O||(O="utf8");let D=!1;for(;;)switch(O){case"hex":return se(this,g,w,C);case"utf8":case"utf-8":return ee(this,g,w,C);case"ascii":case"latin1":case"binary":return Te(this,g,w,C);case"base64":return M(this,g,w,C);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return U(this,g,w,C);default:if(D)throw new TypeError("Unknown encoding: "+O);O=(""+O).toLowerCase(),D=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function B(x,g,w){return g===0&&w===x.length?e.fromByteArray(x):e.fromByteArray(x.slice(g,w))}function te(x,g,w){w=Math.min(x.length,w);const C=[];let O=g;for(;O<w;){const $=x[O];let D=null,Oe=$>239?4:$>223?3:$>191?2:1;if(O+Oe<=w){let Qe,Ze,et,qe;switch(Oe){case 1:$<128&&(D=$);break;case 2:Qe=x[O+1],(Qe&192)===128&&(qe=($&31)<<6|Qe&63,qe>127&&(D=qe));break;case 3:Qe=x[O+1],Ze=x[O+2],(Qe&192)===128&&(Ze&192)===128&&(qe=($&15)<<12|(Qe&63)<<6|Ze&63,qe>2047&&(qe<55296||qe>57343)&&(D=qe));break;case 4:Qe=x[O+1],Ze=x[O+2],et=x[O+3],(Qe&192)===128&&(Ze&192)===128&&(et&192)===128&&(qe=($&15)<<18|(Qe&63)<<12|(Ze&63)<<6|et&63,qe>65535&&qe<1114112&&(D=qe))}}D===null?(D=65533,Oe=1):D>65535&&(D-=65536,C.push(D>>>10&1023|55296),D=56320|D&1023),C.push(D),O+=Oe}return Q(C)}const ae=4096;function Q(x){const g=x.length;if(g<=ae)return String.fromCharCode.apply(String,x);let w="",C=0;for(;C<g;)w+=String.fromCharCode.apply(String,x.slice(C,C+=ae));return w}function le(x,g,w){let C="";w=Math.min(x.length,w);for(let O=g;O<w;++O)C+=String.fromCharCode(x[O]&127);return C}function ve(x,g,w){let C="";w=Math.min(x.length,w);for(let O=g;O<w;++O)C+=String.fromCharCode(x[O]);return C}function z(x,g,w){const C=x.length;(!g||g<0)&&(g=0),(!w||w<0||w>C)&&(w=C);let O="";for(let $=g;$<w;++$)O+=we[x[$]];return O}function K(x,g,w){const C=x.slice(g,w);let O="";for(let $=0;$<C.length-1;$+=2)O+=String.fromCharCode(C[$]+C[$+1]*256);return O}l.prototype.slice=function(g,w){const C=this.length;g=~~g,w=w===void 0?C:~~w,g<0?(g+=C,g<0&&(g=0)):g>C&&(g=C),w<0?(w+=C,w<0&&(w=0)):w>C&&(w=C),w<g&&(w=g);const O=this.subarray(g,w);return Object.setPrototypeOf(O,l.prototype),O};function ne(x,g,w){if(x%1!==0||x<0)throw new RangeError("offset is not uint");if(x+g>w)throw new RangeError("Trying to access beyond buffer length")}l.prototype.readUintLE=l.prototype.readUIntLE=function(g,w,C){g=g>>>0,w=w>>>0,C||ne(g,w,this.length);let O=this[g],$=1,D=0;for(;++D<w&&($*=256);)O+=this[g+D]*$;return O},l.prototype.readUintBE=l.prototype.readUIntBE=function(g,w,C){g=g>>>0,w=w>>>0,C||ne(g,w,this.length);let O=this[g+--w],$=1;for(;w>0&&($*=256);)O+=this[g+--w]*$;return O},l.prototype.readUint8=l.prototype.readUInt8=function(g,w){return g=g>>>0,w||ne(g,1,this.length),this[g]},l.prototype.readUint16LE=l.prototype.readUInt16LE=function(g,w){return g=g>>>0,w||ne(g,2,this.length),this[g]|this[g+1]<<8},l.prototype.readUint16BE=l.prototype.readUInt16BE=function(g,w){return g=g>>>0,w||ne(g,2,this.length),this[g]<<8|this[g+1]},l.prototype.readUint32LE=l.prototype.readUInt32LE=function(g,w){return g=g>>>0,w||ne(g,4,this.length),(this[g]|this[g+1]<<8|this[g+2]<<16)+this[g+3]*16777216},l.prototype.readUint32BE=l.prototype.readUInt32BE=function(g,w){return g=g>>>0,w||ne(g,4,this.length),this[g]*16777216+(this[g+1]<<16|this[g+2]<<8|this[g+3])},l.prototype.readBigUInt64LE=he(function(g){g=g>>>0,ze(g,"offset");const w=this[g],C=this[g+7];(w===void 0||C===void 0)&&_t(g,this.length-8);const O=w+this[++g]*2**8+this[++g]*2**16+this[++g]*2**24,$=this[++g]+this[++g]*2**8+this[++g]*2**16+C*2**24;return BigInt(O)+(BigInt($)<<BigInt(32))}),l.prototype.readBigUInt64BE=he(function(g){g=g>>>0,ze(g,"offset");const w=this[g],C=this[g+7];(w===void 0||C===void 0)&&_t(g,this.length-8);const O=w*2**24+this[++g]*2**16+this[++g]*2**8+this[++g],$=this[++g]*2**24+this[++g]*2**16+this[++g]*2**8+C;return(BigInt(O)<<BigInt(32))+BigInt($)}),l.prototype.readIntLE=function(g,w,C){g=g>>>0,w=w>>>0,C||ne(g,w,this.length);let O=this[g],$=1,D=0;for(;++D<w&&($*=256);)O+=this[g+D]*$;return $*=128,O>=$&&(O-=Math.pow(2,8*w)),O},l.prototype.readIntBE=function(g,w,C){g=g>>>0,w=w>>>0,C||ne(g,w,this.length);let O=w,$=1,D=this[g+--O];for(;O>0&&($*=256);)D+=this[g+--O]*$;return $*=128,D>=$&&(D-=Math.pow(2,8*w)),D},l.prototype.readInt8=function(g,w){return g=g>>>0,w||ne(g,1,this.length),this[g]&128?(255-this[g]+1)*-1:this[g]},l.prototype.readInt16LE=function(g,w){g=g>>>0,w||ne(g,2,this.length);const C=this[g]|this[g+1]<<8;return C&32768?C|4294901760:C},l.prototype.readInt16BE=function(g,w){g=g>>>0,w||ne(g,2,this.length);const C=this[g+1]|this[g]<<8;return C&32768?C|4294901760:C},l.prototype.readInt32LE=function(g,w){return g=g>>>0,w||ne(g,4,this.length),this[g]|this[g+1]<<8|this[g+2]<<16|this[g+3]<<24},l.prototype.readInt32BE=function(g,w){return g=g>>>0,w||ne(g,4,this.length),this[g]<<24|this[g+1]<<16|this[g+2]<<8|this[g+3]},l.prototype.readBigInt64LE=he(function(g){g=g>>>0,ze(g,"offset");const w=this[g],C=this[g+7];(w===void 0||C===void 0)&&_t(g,this.length-8);const O=this[g+4]+this[g+5]*2**8+this[g+6]*2**16+(C<<24);return(BigInt(O)<<BigInt(32))+BigInt(w+this[++g]*2**8+this[++g]*2**16+this[++g]*2**24)}),l.prototype.readBigInt64BE=he(function(g){g=g>>>0,ze(g,"offset");const w=this[g],C=this[g+7];(w===void 0||C===void 0)&&_t(g,this.length-8);const O=(w<<24)+this[++g]*2**16+this[++g]*2**8+this[++g];return(BigInt(O)<<BigInt(32))+BigInt(this[++g]*2**24+this[++g]*2**16+this[++g]*2**8+C)}),l.prototype.readFloatLE=function(g,w){return g=g>>>0,w||ne(g,4,this.length),r.read(this,g,!0,23,4)},l.prototype.readFloatBE=function(g,w){return g=g>>>0,w||ne(g,4,this.length),r.read(this,g,!1,23,4)},l.prototype.readDoubleLE=function(g,w){return g=g>>>0,w||ne(g,8,this.length),r.read(this,g,!0,52,8)},l.prototype.readDoubleBE=function(g,w){return g=g>>>0,w||ne(g,8,this.length),r.read(this,g,!1,52,8)};function G(x,g,w,C,O,$){if(!l.isBuffer(x))throw new TypeError('"buffer" argument must be a Buffer instance');if(g>O||g<$)throw new RangeError('"value" argument is out of bounds');if(w+C>x.length)throw new RangeError("Index out of range")}l.prototype.writeUintLE=l.prototype.writeUIntLE=function(g,w,C,O){if(g=+g,w=w>>>0,C=C>>>0,!O){const Oe=Math.pow(2,8*C)-1;G(this,g,w,C,Oe,0)}let $=1,D=0;for(this[w]=g&255;++D<C&&($*=256);)this[w+D]=g/$&255;return w+C},l.prototype.writeUintBE=l.prototype.writeUIntBE=function(g,w,C,O){if(g=+g,w=w>>>0,C=C>>>0,!O){const Oe=Math.pow(2,8*C)-1;G(this,g,w,C,Oe,0)}let $=C-1,D=1;for(this[w+$]=g&255;--$>=0&&(D*=256);)this[w+$]=g/D&255;return w+C},l.prototype.writeUint8=l.prototype.writeUInt8=function(g,w,C){return g=+g,w=w>>>0,C||G(this,g,w,1,255,0),this[w]=g&255,w+1},l.prototype.writeUint16LE=l.prototype.writeUInt16LE=function(g,w,C){return g=+g,w=w>>>0,C||G(this,g,w,2,65535,0),this[w]=g&255,this[w+1]=g>>>8,w+2},l.prototype.writeUint16BE=l.prototype.writeUInt16BE=function(g,w,C){return g=+g,w=w>>>0,C||G(this,g,w,2,65535,0),this[w]=g>>>8,this[w+1]=g&255,w+2},l.prototype.writeUint32LE=l.prototype.writeUInt32LE=function(g,w,C){return g=+g,w=w>>>0,C||G(this,g,w,4,4294967295,0),this[w+3]=g>>>24,this[w+2]=g>>>16,this[w+1]=g>>>8,this[w]=g&255,w+4},l.prototype.writeUint32BE=l.prototype.writeUInt32BE=function(g,w,C){return g=+g,w=w>>>0,C||G(this,g,w,4,4294967295,0),this[w]=g>>>24,this[w+1]=g>>>16,this[w+2]=g>>>8,this[w+3]=g&255,w+4};function A(x,g,w,C,O){Tt(g,C,O,x,w,7);let $=Number(g&BigInt(4294967295));x[w++]=$,$=$>>8,x[w++]=$,$=$>>8,x[w++]=$,$=$>>8,x[w++]=$;let D=Number(g>>BigInt(32)&BigInt(4294967295));return x[w++]=D,D=D>>8,x[w++]=D,D=D>>8,x[w++]=D,D=D>>8,x[w++]=D,w}function S(x,g,w,C,O){Tt(g,C,O,x,w,7);let $=Number(g&BigInt(4294967295));x[w+7]=$,$=$>>8,x[w+6]=$,$=$>>8,x[w+5]=$,$=$>>8,x[w+4]=$;let D=Number(g>>BigInt(32)&BigInt(4294967295));return x[w+3]=D,D=D>>8,x[w+2]=D,D=D>>8,x[w+1]=D,D=D>>8,x[w]=D,w+8}l.prototype.writeBigUInt64LE=he(function(g,w=0){return A(this,g,w,BigInt(0),BigInt("0xffffffffffffffff"))}),l.prototype.writeBigUInt64BE=he(function(g,w=0){return S(this,g,w,BigInt(0),BigInt("0xffffffffffffffff"))}),l.prototype.writeIntLE=function(g,w,C,O){if(g=+g,w=w>>>0,!O){const Qe=Math.pow(2,8*C-1);G(this,g,w,C,Qe-1,-Qe)}let $=0,D=1,Oe=0;for(this[w]=g&255;++$<C&&(D*=256);)g<0&&Oe===0&&this[w+$-1]!==0&&(Oe=1),this[w+$]=(g/D>>0)-Oe&255;return w+C},l.prototype.writeIntBE=function(g,w,C,O){if(g=+g,w=w>>>0,!O){const Qe=Math.pow(2,8*C-1);G(this,g,w,C,Qe-1,-Qe)}let $=C-1,D=1,Oe=0;for(this[w+$]=g&255;--$>=0&&(D*=256);)g<0&&Oe===0&&this[w+$+1]!==0&&(Oe=1),this[w+$]=(g/D>>0)-Oe&255;return w+C},l.prototype.writeInt8=function(g,w,C){return g=+g,w=w>>>0,C||G(this,g,w,1,127,-128),g<0&&(g=255+g+1),this[w]=g&255,w+1},l.prototype.writeInt16LE=function(g,w,C){return g=+g,w=w>>>0,C||G(this,g,w,2,32767,-32768),this[w]=g&255,this[w+1]=g>>>8,w+2},l.prototype.writeInt16BE=function(g,w,C){return g=+g,w=w>>>0,C||G(this,g,w,2,32767,-32768),this[w]=g>>>8,this[w+1]=g&255,w+2},l.prototype.writeInt32LE=function(g,w,C){return g=+g,w=w>>>0,C||G(this,g,w,4,2147483647,-2147483648),this[w]=g&255,this[w+1]=g>>>8,this[w+2]=g>>>16,this[w+3]=g>>>24,w+4},l.prototype.writeInt32BE=function(g,w,C){return g=+g,w=w>>>0,C||G(this,g,w,4,2147483647,-2147483648),g<0&&(g=4294967295+g+1),this[w]=g>>>24,this[w+1]=g>>>16,this[w+2]=g>>>8,this[w+3]=g&255,w+4},l.prototype.writeBigInt64LE=he(function(g,w=0){return A(this,g,w,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),l.prototype.writeBigInt64BE=he(function(g,w=0){return S(this,g,w,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function L(x,g,w,C,O,$){if(w+C>x.length)throw new RangeError("Index out of range");if(w<0)throw new RangeError("Index out of range")}function N(x,g,w,C,O){return g=+g,w=w>>>0,O||L(x,g,w,4),r.write(x,g,w,C,23,4),w+4}l.prototype.writeFloatLE=function(g,w,C){return N(this,g,w,!0,C)},l.prototype.writeFloatBE=function(g,w,C){return N(this,g,w,!1,C)};function be(x,g,w,C,O){return g=+g,w=w>>>0,O||L(x,g,w,8),r.write(x,g,w,C,52,8),w+8}l.prototype.writeDoubleLE=function(g,w,C){return be(this,g,w,!0,C)},l.prototype.writeDoubleBE=function(g,w,C){return be(this,g,w,!1,C)},l.prototype.copy=function(g,w,C,O){if(!l.isBuffer(g))throw new TypeError("argument should be a Buffer");if(C||(C=0),!O&&O!==0&&(O=this.length),w>=g.length&&(w=g.length),w||(w=0),O>0&&O<C&&(O=C),O===C||g.length===0||this.length===0)return 0;if(w<0)throw new RangeError("targetStart out of bounds");if(C<0||C>=this.length)throw new RangeError("Index out of range");if(O<0)throw new RangeError("sourceEnd out of bounds");O>this.length&&(O=this.length),g.length-w<O-C&&(O=g.length-w+C);const $=O-C;return this===g&&typeof i.prototype.copyWithin=="function"?this.copyWithin(w,C,O):i.prototype.set.call(g,this.subarray(C,O),w),$},l.prototype.fill=function(g,w,C,O){if(typeof g=="string"){if(typeof w=="string"?(O=w,w=0,C=this.length):typeof C=="string"&&(O=C,C=this.length),O!==void 0&&typeof O!="string")throw new TypeError("encoding must be a string");if(typeof O=="string"&&!l.isEncoding(O))throw new TypeError("Unknown encoding: "+O);if(g.length===1){const D=g.charCodeAt(0);(O==="utf8"&&D<128||O==="latin1")&&(g=D)}}else typeof g=="number"?g=g&255:typeof g=="boolean"&&(g=Number(g));if(w<0||this.length<w||this.length<C)throw new RangeError("Out of range index");if(C<=w)return this;w=w>>>0,C=C===void 0?this.length:C>>>0,g||(g=0);let $;if(typeof g=="number")for($=w;$<C;++$)this[$]=g;else{const D=l.isBuffer(g)?g:l.from(g,O),Oe=D.length;if(Oe===0)throw new TypeError('The value "'+g+'" is invalid for argument "value"');for($=0;$<C-w;++$)this[$+w]=D[$%Oe]}return this};const Ae={};function Be(x,g,w){Ae[x]=class extends w{constructor(){super(),Object.defineProperty(this,"message",{value:g.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${x}]`,this.stack,delete this.name}get code(){return x}set code(O){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:O,writable:!0})}toString(){return`${this.name} [${x}]: ${this.message}`}}}Be("ERR_BUFFER_OUT_OF_BOUNDS",function(x){return x?`${x} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),Be("ERR_INVALID_ARG_TYPE",function(x,g){return`The "${x}" argument must be of type number. Received type ${typeof g}`},TypeError),Be("ERR_OUT_OF_RANGE",function(x,g,w){let C=`The value of "${x}" is out of range.`,O=w;return Number.isInteger(w)&&Math.abs(w)>2**32?O=We(String(w)):typeof w=="bigint"&&(O=String(w),(w>BigInt(2)**BigInt(32)||w<-(BigInt(2)**BigInt(32)))&&(O=We(O)),O+="n"),C+=` It must be ${g}. Received ${O}`,C},RangeError);function We(x){let g="",w=x.length;const C=x[0]==="-"?1:0;for(;w>=C+4;w-=3)g=`_${x.slice(w-3,w)}${g}`;return`${x.slice(0,w)}${g}`}function Ye(x,g,w){ze(g,"offset"),(x[g]===void 0||x[g+w]===void 0)&&_t(g,x.length-(w+1))}function Tt(x,g,w,C,O,$){if(x>w||x<g){const D=typeof g=="bigint"?"n":"";let Oe;throw g===0||g===BigInt(0)?Oe=`>= 0${D} and < 2${D} ** ${($+1)*8}${D}`:Oe=`>= -(2${D} ** ${($+1)*8-1}${D}) and < 2 ** ${($+1)*8-1}${D}`,new Ae.ERR_OUT_OF_RANGE("value",Oe,x)}Ye(C,O,$)}function ze(x,g){if(typeof x!="number")throw new Ae.ERR_INVALID_ARG_TYPE(g,"number",x)}function _t(x,g,w){throw Math.floor(x)!==x?(ze(x,w),new Ae.ERR_OUT_OF_RANGE("offset","an integer",x)):g<0?new Ae.ERR_BUFFER_OUT_OF_BOUNDS:new Ae.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${g}`,x)}const Bn=/[^+/0-9A-Za-z-_]/g;function zs(x){if(x=x.split("=")[0],x=x.trim().replace(Bn,""),x.length<2)return"";for(;x.length%4!==0;)x=x+"=";return x}function J(x,g){g=g||1/0;let w;const C=x.length;let O=null;const $=[];for(let D=0;D<C;++D){if(w=x.charCodeAt(D),w>55295&&w<57344){if(!O){if(w>56319){(g-=3)>-1&&$.push(239,191,189);continue}else if(D+1===C){(g-=3)>-1&&$.push(239,191,189);continue}O=w;continue}if(w<56320){(g-=3)>-1&&$.push(239,191,189),O=w;continue}w=(O-55296<<10|w-56320)+65536}else O&&(g-=3)>-1&&$.push(239,191,189);if(O=null,w<128){if((g-=1)<0)break;$.push(w)}else if(w<2048){if((g-=2)<0)break;$.push(w>>6|192,w&63|128)}else if(w<65536){if((g-=3)<0)break;$.push(w>>12|224,w>>6&63|128,w&63|128)}else if(w<1114112){if((g-=4)<0)break;$.push(w>>18|240,w>>12&63|128,w>>6&63|128,w&63|128)}else throw new Error("Invalid code point")}return $}function yn(x){const g=[];for(let w=0;w<x.length;++w)g.push(x.charCodeAt(w)&255);return g}function ye(x,g){let w,C,O;const $=[];for(let D=0;D<x.length&&!((g-=2)<0);++D)w=x.charCodeAt(D),C=w>>8,O=w%256,$.push(O),$.push(C);return $}function de(x){return e.toByteArray(zs(x))}function ge(x,g,w,C){let O;for(O=0;O<C&&!(O+w>=g.length||O>=x.length);++O)g[O+w]=x[O];return O}function Z(x,g){return x instanceof g||x!=null&&x.constructor!=null&&x.constructor.name!=null&&x.constructor.name===g.name}function W(x){return x!==x}const we=(function(){const x="0123456789abcdef",g=new Array(256);for(let w=0;w<16;++w){const C=w*16;for(let O=0;O<16;++O)g[C+O]=x[w]+x[O]}return g})();function he(x){return typeof BigInt>"u"?Lt:x}function Lt(){throw new Error("BigInt not supported")}})(zw);const ln=zw.Buffer;function sf(t){switch(t){case"csv":return"text/csv";case"doc":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":return"image/jpeg";case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function JC(t){if(Ee(t.document)&&Ee(t.document.source)){const e=Ee(t.document)&&re(t.document.format)?t.document.format:"",r=sf(e);if(Ee(t.document.source)){if(Ee(t.document.source.s3Location)&&re(t.document.source.s3Location.uri))return{type:"file",mimeType:r,fileId:t.document.source.s3Location.uri};if(zh(t.document.source.bytes))return{type:"file",mimeType:r,data:t.document.source.bytes};if(re(t.document.source.text))return{type:"file",mimeType:r,data:ln.from(t.document.source.text).toString("base64")};if(un(t.document.source.content)){const n=t.document.source.content.reduce((s,i)=>Ee(i)&&re(i.text)?s+i.text:s,"");return{type:"file",mimeType:r,data:n}}}}return{type:"non_standard",value:t}}function ZC(t){if(pe(t,"image")&&Ee(t.image)){const e=Ee(t.image)&&re(t.image.format)?t.image.format:"",r=sf(e);if(Ee(t.image.source)){if(Ee(t.image.source.s3Location)&&re(t.image.source.s3Location.uri))return{type:"image",mimeType:r,fileId:t.image.source.s3Location.uri};if(zh(t.image.source.bytes))return{type:"image",mimeType:r,data:t.image.source.bytes}}}return{type:"non_standard",value:t}}function KC(t){if(pe(t,"video")&&Ee(t.video)){const e=Ee(t.video)&&re(t.video.format)?t.video.format:"",r=sf(e);if(Ee(t.video.source)){if(Ee(t.video.source.s3Location)&&re(t.video.source.s3Location.uri))return{type:"video",mimeType:r,fileId:t.video.source.s3Location.uri};if(zh(t.video.source.bytes))return{type:"video",mimeType:r,data:t.video.source.bytes}}}return{type:"non_standard",value:t}}function ig(t){function*e(){const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r){if(pe(n,"cache_point")){yield{type:"non_standard",value:n};continue}else if(pe(n,"citations_content")&&Ee(n.citationsContent)){const s=un(n.citationsContent.content)?n.citationsContent.content.reduce((a,o)=>Ee(o)&&re(o.text)?a+o.text:a,""):"",i=un(n.citationsContent.citations)?n.citationsContent.citations.reduce((a,o)=>{if(Ee(o)){const c=un(o.sourceContent)?o.sourceContent.reduce((l,d)=>Ee(d)&&re(d.text)?l+d.text:l,""):"",u=ua(()=>{if(Ee(o.location)){const l=o.location.documentChar||o.location.documentPage||o.location.documentChunk;if(Ee(l))return{source:Br(l.documentIndex)?l.documentIndex.toString():void 0,startIndex:Br(l.start)?l.start:void 0,endIndex:Br(l.end)?l.end:void 0}}return{}});a.push({type:"citation",citedText:c,...u})}return a},[]):[];yield{type:"text",text:s,annotations:i};continue}else if(pe(n,"document")&&Ee(n.document)){yield JC(n);continue}else if(pe(n,"guard_content")){yield{type:"non_standard",value:n};continue}else if(pe(n,"image")&&Ee(n.image)){yield ZC(n);continue}else if(pe(n,"reasoning_content")&&re(n.reasoningText)){yield{type:"reasoning",reasoning:n.reasoningText};continue}else if(pe(n,"text")&&re(n.text)){yield{type:"text",text:n.text};continue}else if(pe(n,"tool_result")){yield{type:"non_standard",value:n};continue}else{if(pe(n,"tool_call"))continue;if(pe(n,"video")&&Ee(n.video)){yield KC(n);continue}}yield{type:"non_standard",value:n}}}return Array.from(e())}const XC={translateContent:ig,translateContentChunk:ig};function ag(t){function*e(){const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r){if(pe(n,"text")&&re(n.text)){yield{type:"text",text:n.text};continue}else if(pe(n,"inlineData")&&Ee(n.inlineData)&&re(n.inlineData.mimeType)&&re(n.inlineData.data)){yield{type:"file",mimeType:n.inlineData.mimeType,data:n.inlineData.data};continue}else if(pe(n,"functionCall")&&Ee(n.functionCall)&&re(n.functionCall.name)&&Ee(n.functionCall.args)){yield{type:"tool_call",id:t.id,name:n.functionCall.name,args:n.functionCall.args};continue}else if(pe(n,"functionResponse")){yield{type:"non_standard",value:n};continue}else if(pe(n,"fileData")&&Ee(n.fileData)&&re(n.fileData.mimeType)&&re(n.fileData.fileUri)){yield{type:"file",mimeType:n.fileData.mimeType,fileId:n.fileData.fileUri};continue}else if(pe(n,"executableCode")){yield{type:"non_standard",value:n};continue}else if(pe(n,"codeExecutionResult")){yield{type:"non_standard",value:n};continue}yield{type:"non_standard",value:n}}}return Array.from(e())}const YC={translateContent:ag,translateContentChunk:ag};function og(t){function*e(){const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r){if(pe(n,"reasoning")&&re(n.reasoning)){const s=ua(()=>{var a;const i=r.indexOf(n);if(un((a=t.additional_kwargs)==null?void 0:a.signatures)&&i>=0)return t.additional_kwargs.signatures.at(i)});re(s)?yield{type:"reasoning",reasoning:n.reasoning,signature:s}:yield{type:"reasoning",reasoning:n.reasoning};continue}else if(pe(n,"text")&&re(n.text)){yield{type:"text",text:n.text};continue}else if(pe(n,"image_url")){if(re(n.image_url))if(n.image_url.startsWith("data:")){const s=/^data:([^;]+);base64,(.+)$/,i=n.image_url.match(s);i?yield{type:"image",data:i[2],mimeType:i[1]}:yield{type:"image",url:n.image_url}}else yield{type:"image",url:n.image_url};continue}else if(pe(n,"media")&&re(n.mimeType)&&re(n.data)){yield{type:"file",mimeType:n.mimeType,data:n.data};continue}yield{type:"non_standard",value:n}}}return Array.from(e())}const QC={translateContent:og,translateContentChunk:og};globalThis.lc_block_translators_registry??(globalThis.lc_block_translators_registry=new Map([["anthropic",jx],["bedrock-converse",XC],["google-genai",YC],["google-vertexai",QC],["openai",Xx]]));function Gw(t){return globalThis.lc_block_translators_registry.get(t)}function Hw(t,e){return Ut(t??{},e??{})}function qw(t,e){const r={};return((t==null?void 0:t.audio)!==void 0||(e==null?void 0:e.audio)!==void 0)&&(r.audio=((t==null?void 0:t.audio)??0)+((e==null?void 0:e.audio)??0)),((t==null?void 0:t.image)!==void 0||(e==null?void 0:e.image)!==void 0)&&(r.image=((t==null?void 0:t.image)??0)+((e==null?void 0:e.image)??0)),((t==null?void 0:t.video)!==void 0||(e==null?void 0:e.video)!==void 0)&&(r.video=((t==null?void 0:t.video)??0)+((e==null?void 0:e.video)??0)),((t==null?void 0:t.document)!==void 0||(e==null?void 0:e.document)!==void 0)&&(r.document=((t==null?void 0:t.document)??0)+((e==null?void 0:e.document)??0)),((t==null?void 0:t.text)!==void 0||(e==null?void 0:e.text)!==void 0)&&(r.text=((t==null?void 0:t.text)??0)+((e==null?void 0:e.text)??0)),r}function e1(t,e){const r={...qw(t,e)};return((t==null?void 0:t.cache_read)!==void 0||(e==null?void 0:e.cache_read)!==void 0)&&(r.cache_read=((t==null?void 0:t.cache_read)??0)+((e==null?void 0:e.cache_read)??0)),((t==null?void 0:t.cache_creation)!==void 0||(e==null?void 0:e.cache_creation)!==void 0)&&(r.cache_creation=((t==null?void 0:t.cache_creation)??0)+((e==null?void 0:e.cache_creation)??0)),r}function t1(t,e){const r={...qw(t,e)};return((t==null?void 0:t.reasoning)!==void 0||(e==null?void 0:e.reasoning)!==void 0)&&(r.reasoning=((t==null?void 0:t.reasoning)??0)+((e==null?void 0:e.reasoning)??0)),r}function Ww(t,e){return{input_tokens:((t==null?void 0:t.input_tokens)??0)+((e==null?void 0:e.input_tokens)??0),output_tokens:((t==null?void 0:t.output_tokens)??0)+((e==null?void 0:e.output_tokens)??0),total_tokens:((t==null?void 0:t.total_tokens)??0)+((e==null?void 0:e.total_tokens)??0),input_token_details:e1(t==null?void 0:t.input_token_details,e==null?void 0:e.input_token_details),output_token_details:t1(t==null?void 0:t.output_token_details,e==null?void 0:e.output_token_details)}}var yt=class extends Ir{constructor(e){var n;let r;if(typeof e=="string"||Array.isArray(e))r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:{}};else{r=e;const s=(n=r.additional_kwargs)==null?void 0:n.tool_calls,i=r.tool_calls;s!=null&&s.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `pnpm install @langchain/anthropic`,","pnpm install @langchain/openai`, etc."].join(" "));try{if(s!=null&&i===void 0){const[a,o]=Hh(s);r.tool_calls=a??[],r.invalid_tool_calls=o??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}if(r.response_metadata!==void 0&&"output_version"in r.response_metadata&&r.response_metadata.output_version==="v1"&&(r.contentBlocks=r.content,r.content=void 0),r.contentBlocks!==void 0){r.contentBlocks.push(...r.tool_calls.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})));const a=r.contentBlocks.filter(o=>o.type==="tool_call").filter(o=>{var c;return!((c=r.tool_calls)!=null&&c.some(u=>u.id===o.id&&u.name===o.name))});a.length>0&&(r.tool_calls=a.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})))}}super(r);f(this,"type","ai");f(this,"tool_calls",[]);f(this,"invalid_tool_calls",[]);f(this,"usage_metadata");typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}static lc_name(){return"AIMessage"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const r=Gw(this.response_metadata.model_provider);if(r)return r.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls){const r=this.tool_calls.filter(n=>!e.some(s=>s.id===n.id&&s.name===n.name));e.push(...r.map(n=>({...n,type:"tool_call",id:n.id,name:n.name,args:n.args})))}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}};function af(t){return t._getType()==="ai"}function Rd(t){return t._getType()==="ai"}var $t=class extends Us{constructor(e){var n,s;let r;if(typeof e=="string"||Array.isArray(e))r={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)r={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const i=e.tool_call_chunks.reduce((c,u)=>{const l=c.findIndex(([d])=>"id"in u&&u.id&&"index"in u&&u.index!==void 0?u.id===d.id&&u.index===d.index:"id"in u&&u.id?u.id===d.id:"index"in u&&u.index!==void 0?u.index===d.index:!1);return l!==-1?c[l].push(u):c.push([u]),c},[]),a=[],o=[];for(const c of i){let u=null;const l=((n=c[0])==null?void 0:n.name)??"",d=c.map(m=>m.args||"").join(""),h=d.length?d:"{}",p=(s=c[0])==null?void 0:s.id;try{if(u=di(h),!p||u===null||typeof u!="object"||Array.isArray(u))throw new Error("Malformed tool call chunk args.");a.push({name:l,args:u,id:p,type:"tool_call"})}catch{o.push({name:l,args:h,id:p,error:"Malformed args.",type:"invalid_tool_call"})}}r={...e,tool_calls:a,invalid_tool_calls:o,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(r);f(this,"type","ai");f(this,"tool_calls",[]);f(this,"invalid_tool_calls",[]);f(this,"tool_call_chunks",[]);f(this,"usage_metadata");this.tool_call_chunks=r.tool_call_chunks??this.tool_call_chunks,this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=r.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const r=Gw(this.response_metadata.model_provider);if(r)return r.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls&&typeof this.content!="string"){const r=this.content.filter(n=>n.type==="tool_call").map(n=>n.id);for(const n of this.tool_calls)n.id&&!r.includes(n.id)&&e.push({...n,type:"tool_call",id:n.id,name:n.name,args:n.args})}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const r={content:Ms(this.content,e.content),additional_kwargs:Ut(this.additional_kwargs,e.additional_kwargs),response_metadata:Hw(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const s=Ua(this.tool_call_chunks,e.tool_call_chunks);s!==void 0&&s.length>0&&(r.tool_call_chunks=s)}(this.usage_metadata!==void 0||e.usage_metadata!==void 0)&&(r.usage_metadata=Ww(this.usage_metadata,e.usage_metadata));const n=this.constructor;return new n(r)}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}},ls=class Jw extends Ir{constructor(r,n){(typeof r=="string"||Array.isArray(r))&&(r={content:r,role:n});super(r);f(this,"type","generic");f(this,"role");this.role=r.role}static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Jw}static isInstance(r){return super.isInstance(r)&&r.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},qc=class extends Us{constructor(e,r){(typeof e=="string"||Array.isArray(e))&&(e={content:e,role:r});super(e);f(this,"type","generic");f(this,"role");this.role=e.role}static lc_name(){return"ChatMessageChunk"}concat(e){const r=this.constructor;return new r({content:Ms(this.content,e.content),additional_kwargs:Ut(this.additional_kwargs,e.additional_kwargs),response_metadata:Ut(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}};function r1(t){return t._getType()==="generic"}function n1(t){return t._getType()==="generic"}var Wc=class extends Ir{constructor(e){super(e);f(this,"type","function");f(this,"name");this.name=e.name}static lc_name(){return"FunctionMessage"}},Jc=class extends Us{constructor(){super(...arguments);f(this,"type","function")}static lc_name(){return"FunctionMessageChunk"}concat(e){const r=this.constructor;return new r({content:Ms(this.content,e.content),additional_kwargs:Ut(this.additional_kwargs,e.additional_kwargs),response_metadata:Ut(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}};function s1(t){return t._getType()==="function"}function i1(t){return t._getType()==="function"}var pt=class extends Ir{constructor(e){super(e);f(this,"type","human")}static lc_name(){return"HumanMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="human"}},Zc=class extends Us{constructor(e){super(e);f(this,"type","human")}static lc_name(){return"HumanMessageChunk"}concat(e){const r=this.constructor;return new r({content:Ms(this.content,e.content),additional_kwargs:Ut(this.additional_kwargs,e.additional_kwargs),response_metadata:Ut(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="human"}};function a1(t){return t.getType()==="human"}function o1(t){return t.getType()==="human"}var lt=class extends Ir{constructor(e){super(e);f(this,"type","system")}static lc_name(){return"SystemMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="system"}},hi=class extends Us{constructor(e){super(e);f(this,"type","system")}static lc_name(){return"SystemMessageChunk"}concat(e){const r=this.constructor;return new r({content:Ms(this.content,e.content),additional_kwargs:Ut(this.additional_kwargs,e.additional_kwargs),response_metadata:Ut(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="system"}};function c1(t){return t._getType()==="system"}function u1(t){return t._getType()==="system"}function Kc(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function ea(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="tool_call")}function l1(t){return!!(t&&typeof t=="object"&&"toolCall"in t&&t.toolCall!=null&&typeof t.toolCall=="object"&&"id"in t.toolCall&&typeof t.toolCall.id=="string")}var rc=class extends Error{constructor(e,r){super(e);f(this,"output");this.output=r}},nc=class extends Ir{constructor(e){super({...e,content:[]});f(this,"type","remove");f(this,"id");this.id=e.id}get _printableFields(){return{...super._printableFields,id:this.id}}static isInstance(e){return super.isInstance(e)&&e.type==="remove"}};const d1=t=>t();function h1(t){return ea(t)?t:typeof t.id=="string"&&t.type==="function"&&typeof t.function=="object"&&t.function!==null&&"arguments"in t.function&&typeof t.function.arguments=="string"&&"name"in t.function&&typeof t.function.name=="string"?{id:t.id,args:JSON.parse(t.function.arguments),name:t.function.name,type:"tool_call"}:t}function f1(t){return typeof t=="object"&&t!=null&&t.lc===1&&Array.isArray(t.id)&&t.kwargs!=null&&typeof t.kwargs=="object"}function Ml(t){let e,r;if(f1(t)){const n=t.id.at(-1);n==="HumanMessage"||n==="HumanMessageChunk"?e="user":n==="AIMessage"||n==="AIMessageChunk"?e="assistant":n==="SystemMessage"||n==="SystemMessageChunk"?e="system":n==="FunctionMessage"||n==="FunctionMessageChunk"?e="function":n==="ToolMessage"||n==="ToolMessageChunk"?e="tool":e="unknown",r=t.kwargs}else{const{type:n,...s}=t;e=n,r=s}if(e==="human"||e==="user")return new pt(r);if(e==="ai"||e==="assistant"){const{tool_calls:n,...s}=r;if(!Array.isArray(n))return new yt(r);const i=n.map(h1);return new yt({...s,tool_calls:i})}else{if(e==="system")return new lt(r);if(e==="developer")return new lt({...r,additional_kwargs:{...r.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in r)return new On({...r,content:r.content,tool_call_id:r.tool_call_id,name:r.name});if(e==="remove"&&"id"in r&&typeof r.id=="string")return new nc({...r,id:r.id});throw Kc(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(t,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function dn(t){if(typeof t=="string")return new pt(t);if(vt(t))return t;if(Array.isArray(t)){const[e,r]=t;return Ml({type:e,content:r})}else if(lw(t)){const{role:e,...r}=t;return Ml({...r,type:e})}else return Ml(t)}function of(t,e="Human",r="AI"){const n=[];for(const s of t){let i;if(s._getType()==="human")i=e;else if(s._getType()==="ai")i=r;else if(s._getType()==="system")i="System";else if(s._getType()==="tool")i="Tool";else if(s._getType()==="generic")i=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const a=s.name?`${s.name}, `:"",o=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);n.push(`${i}: ${a}${o}`)}return n.join(`
`)}function p1(t){if(t.data!==void 0)return t;{const e=t;return{type:e.type,data:{content:e.text,role:e.role,name:void 0,tool_call_id:void 0}}}}function cf(t){const e=p1(t);switch(e.type){case"human":return new pt(e.data);case"ai":return new yt(e.data);case"system":return new lt(e.data);case"function":if(e.data.name===void 0)throw new Error("Name must be defined for function messages");return new Wc(e.data);case"tool":if(e.data.tool_call_id===void 0)throw new Error("Tool call ID must be defined for tool messages");return new On(e.data);case"generic":if(e.data.role===void 0)throw new Error("Role must be defined for chat messages");return new ls(e.data);default:throw new Error(`Got unexpected type: ${e.type}`)}}function m1(t){return t.map(cf)}function g1(t){return t.map(e=>e.toDict())}function sc(t){var r;const e=t._getType();if(e==="human")return new Zc({...t});if(e==="ai"){let n={...t};return"tool_calls"in n&&(n={...n,tool_call_chunks:(r=n.tool_calls)==null?void 0:r.map(s=>({...s,type:"tool_call_chunk",index:void 0,args:JSON.stringify(s.args)}))}),new $t({...n})}else{if(e==="system")return new hi({...t});if(e==="function")return new Jc({...t});if(ls.isInstance(t))return new qc({...t});throw new Error("Unknown message type.")}}const y1=t=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(r=>cn(r)==="true");function Zw(t){var n;const e=da();if(e===void 0)return;const r=e.getStore();return(n=r==null?void 0:r[Qi])==null?void 0:n[t]}const _1=Symbol("lc:configure_hooks"),w1=()=>Zw(_1)||[];var Kw={};me(Kw,{BaseCallbackManager:()=>Xw,BaseRunManager:()=>ja,CallbackManager:()=>Ht,CallbackManagerForChainRun:()=>Qw,CallbackManagerForLLMRun:()=>Od,CallbackManagerForRetrieverRun:()=>Yw,CallbackManagerForToolRun:()=>e0,ensureHandler:()=>ha,parseCallbackConfigArg:()=>Fa});function Fa(t){return t?Array.isArray(t)||"name"in t?{callbacks:t}:t:{}}var Xw=class{setHandler(t){return this.setHandlers([t])}},ja=class{constructor(t,e,r,n,s,i,a,o){this.runId=t,this.handlers=e,this.inheritableHandlers=r,this.tags=n,this.inheritableTags=s,this.metadata=i,this.inheritableMetadata=a,this._parentRunId=o}get parentRunId(){return this._parentRunId}async handleText(t){await Promise.all(this.handlers.map(e=>ct(async()=>{var r;try{await((r=e.handleText)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleText: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}async handleCustomEvent(t,e,r,n,s){await Promise.all(this.handlers.map(i=>ct(async()=>{var a;try{await((a=i.handleCustomEvent)==null?void 0:a.call(i,t,e,this.runId,this.tags,this.metadata))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}},Yw=class extends ja{getChild(t){const e=new Ht(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleRetrieverEnd(t){await Promise.all(this.handlers.map(e=>ct(async()=>{var r;if(!e.ignoreRetriever)try{await((r=e.handleRetrieverEnd)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetriever`),e.raiseError)throw n}},e.awaitHandlers)))}async handleRetrieverError(t){await Promise.all(this.handlers.map(e=>ct(async()=>{var r;if(!e.ignoreRetriever)try{await((r=e.handleRetrieverError)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetrieverError: ${n}`),e.raiseError)throw t}},e.awaitHandlers)))}},Od=class extends ja{async handleLLMNewToken(t,e,r,n,s,i){await Promise.all(this.handlers.map(a=>ct(async()=>{var o;if(!a.ignoreLLM)try{await((o=a.handleLLMNewToken)==null?void 0:o.call(a,t,e??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMNewToken: ${c}`),a.raiseError)throw c}},a.awaitHandlers)))}async handleLLMError(t,e,r,n,s){await Promise.all(this.handlers.map(i=>ct(async()=>{var a;if(!i.ignoreLLM)try{await((a=i.handleLLMError)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleLLMEnd(t,e,r,n,s){await Promise.all(this.handlers.map(i=>ct(async()=>{var a;if(!i.ignoreLLM)try{await((a=i.handleLLMEnd)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}},Qw=class extends ja{getChild(t){const e=new Ht(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleChainError(t,e,r,n,s){await Promise.all(this.handlers.map(i=>ct(async()=>{var a;if(!i.ignoreChain)try{await((a=i.handleChainError)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleChainEnd(t,e,r,n,s){await Promise.all(this.handlers.map(i=>ct(async()=>{var a;if(!i.ignoreChain)try{await((a=i.handleChainEnd)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleAgentAction(t){await Promise.all(this.handlers.map(e=>ct(async()=>{var r;if(!e.ignoreAgent)try{await((r=e.handleAgentAction)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentAction: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}async handleAgentEnd(t){await Promise.all(this.handlers.map(e=>ct(async()=>{var r;if(!e.ignoreAgent)try{await((r=e.handleAgentEnd)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentEnd: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}},e0=class extends ja{getChild(t){const e=new Ht(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleToolError(t){await Promise.all(this.handlers.map(e=>ct(async()=>{var r;if(!e.ignoreAgent)try{await((r=e.handleToolError)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolError: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}async handleToolEnd(t){await Promise.all(this.handlers.map(e=>ct(async()=>{var r;if(!e.ignoreAgent)try{await((r=e.handleToolEnd)==null?void 0:r.call(e,t,this.runId,this._parentRunId,this.tags))}catch(n){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolEnd: ${n}`),e.raiseError)throw n}},e.awaitHandlers)))}},Ht=class Gi extends Xw{constructor(r,n){super();f(this,"handlers",[]);f(this,"inheritableHandlers",[]);f(this,"tags",[]);f(this,"inheritableTags",[]);f(this,"metadata",{});f(this,"inheritableMetadata",{});f(this,"name","callback_manager");f(this,"_parentRunId");this.handlers=(n==null?void 0:n.handlers)??this.handlers,this.inheritableHandlers=(n==null?void 0:n.inheritableHandlers)??this.inheritableHandlers,this.tags=(n==null?void 0:n.tags)??this.tags,this.inheritableTags=(n==null?void 0:n.inheritableTags)??this.inheritableTags,this.metadata=(n==null?void 0:n.metadata)??this.metadata,this.inheritableMetadata=(n==null?void 0:n.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=r}getParentRunId(){return this._parentRunId}async handleLLMStart(r,n,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0,u=void 0){return Promise.all(n.map(async(l,d)=>{const h=d===0&&s?s:wn();return await Promise.all(this.handlers.map(p=>{if(!p.ignoreLLM)return Zs(p)&&p._createRunForLLMStart(r,[l],h,this._parentRunId,a,this.tags,this.metadata,u),ct(async()=>{var m;try{await((m=p.handleLLMStart)==null?void 0:m.call(p,r,[l],h,this._parentRunId,a,this.tags,this.metadata,u))}catch(_){if((p.raiseError?console.error:console.warn)(`Error in handler ${p.constructor.name}, handleLLMStart: ${_}`),p.raiseError)throw _}},p.awaitHandlers)})),new Od(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(r,n,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0,u=void 0){return Promise.all(n.map(async(l,d)=>{const h=d===0&&s?s:wn();return await Promise.all(this.handlers.map(p=>{if(!p.ignoreLLM)return Zs(p)&&p._createRunForChatModelStart(r,[l],h,this._parentRunId,a,this.tags,this.metadata,u),ct(async()=>{var m,_;try{if(p.handleChatModelStart)await((m=p.handleChatModelStart)==null?void 0:m.call(p,r,[l],h,this._parentRunId,a,this.tags,this.metadata,u));else if(p.handleLLMStart){const v=of(l);await((_=p.handleLLMStart)==null?void 0:_.call(p,r,[v],h,this._parentRunId,a,this.tags,this.metadata,u))}}catch(v){if((p.raiseError?console.error:console.warn)(`Error in handler ${p.constructor.name}, handleLLMStart: ${v}`),p.raiseError)throw v}},p.awaitHandlers)})),new Od(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(r,n,s=wn(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return Zs(u)&&u._createRunForChainStart(r,n,s,this._parentRunId,this.tags,this.metadata,i,c),ct(async()=>{var l;try{await((l=u.handleChainStart)==null?void 0:l.call(u,r,n,s,this._parentRunId,this.tags,this.metadata,i,c))}catch(d){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${d}`),u.raiseError)throw d}},u.awaitHandlers)})),new Qw(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(r,n,s=wn(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return Zs(u)&&u._createRunForToolStart(r,n,s,this._parentRunId,this.tags,this.metadata,c),ct(async()=>{var l;try{await((l=u.handleToolStart)==null?void 0:l.call(u,r,n,s,this._parentRunId,this.tags,this.metadata,c))}catch(d){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${d}`),u.raiseError)throw d}},u.awaitHandlers)})),new e0(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(r,n,s=wn(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return Zs(u)&&u._createRunForRetrieverStart(r,n,s,this._parentRunId,this.tags,this.metadata,c),ct(async()=>{var l;try{await((l=u.handleRetrieverStart)==null?void 0:l.call(u,r,n,s,this._parentRunId,this.tags,this.metadata,c))}catch(d){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${d}`),u.raiseError)throw d}},u.awaitHandlers)})),new Yw(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(r,n,s,i,a){await Promise.all(this.handlers.map(o=>ct(async()=>{var c;if(!o.ignoreCustomEvent)try{await((c=o.handleCustomEvent)==null?void 0:c.call(o,r,n,s,this.tags,this.metadata))}catch(u){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleCustomEvent: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}addHandler(r,n=!0){this.handlers.push(r),n&&this.inheritableHandlers.push(r)}removeHandler(r){this.handlers=this.handlers.filter(n=>n!==r),this.inheritableHandlers=this.inheritableHandlers.filter(n=>n!==r)}setHandlers(r,n=!0){this.handlers=[],this.inheritableHandlers=[];for(const s of r)this.addHandler(s,n)}addTags(r,n=!0){this.removeTags(r),this.tags.push(...r),n&&this.inheritableTags.push(...r)}removeTags(r){this.tags=this.tags.filter(n=>!r.includes(n)),this.inheritableTags=this.inheritableTags.filter(n=>!r.includes(n))}addMetadata(r,n=!0){this.metadata={...this.metadata,...r},n&&(this.inheritableMetadata={...this.inheritableMetadata,...r})}removeMetadata(r){for(const n of Object.keys(r))delete this.metadata[n],delete this.inheritableMetadata[n]}copy(r=[],n=!0){const s=new Gi(this._parentRunId);for(const i of this.handlers){const a=this.inheritableHandlers.includes(i);s.addHandler(i,a)}for(const i of this.tags){const a=this.inheritableTags.includes(i);s.addTags([i],a)}for(const i of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(i);s.addMetadata({[i]:this.metadata[i]},a)}for(const i of r)s.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===i.name)||s.addHandler(i,n);return s}static fromHandlers(r){class n extends Ii{constructor(){super();f(this,"name",wn());Object.assign(this,r)}}const s=new this;return s.addHandler(new n),s}static configure(r,n,s,i,a,o,c){return this._configureSync(r,n,s,i,a,o,c)}static _configureSync(r,n,s,i,a,o,c){var p;let u;(r||n)&&(Array.isArray(r)||!r?(u=new Gi,u.setHandlers((r==null?void 0:r.map(ha))??[],!0)):u=r,u=u.copy(Array.isArray(n)?n.map(ha):n==null?void 0:n.handlers,!1));const l=cn("LANGCHAIN_VERBOSE")==="true"||(c==null?void 0:c.verbose),d=((p=$o.getTraceableRunTree())==null?void 0:p.tracingEnabled)||y1(),h=d||(cn("LANGCHAIN_TRACING")??!1);if(l||h){if(u||(u=new Gi),l&&!u.handlers.some(m=>m.name===kd.prototype.name)){const m=new kd;u.addHandler(m,!0)}if(h&&!u.handlers.some(m=>m.name==="langchain_tracer")&&d){const m=new $o;u.addHandler(m,!0)}if(d){const m=$o.getTraceableRunTree();if(m&&u._parentRunId===void 0){u._parentRunId=m.id;const _=u.handlers.find(v=>v.name==="langchain_tracer");_==null||_.updateFromRunTree(m)}}}for(const{contextVar:m,inheritable:_=!0,handlerClass:v,envVar:y}of w1()){const E=y&&cn(y)==="true"&&v;let b;const I=m!==void 0?Zw(m):void 0;I&&mw(I)?b=I:E&&(b=new v({})),b!==void 0&&(u||(u=new Gi),u.handlers.some(k=>k.name===b.name)||u.addHandler(b,_))}return(s||i)&&u&&(u.addTags(s??[]),u.addTags(i??[],!1)),(a||o)&&u&&(u.addMetadata(a??{}),u.addMetadata(o??{},!1)),u}};function ha(t){return"name"in t?t:Ii.fromMethods(t)}var t0=class{getStore(){}run(t,e){return e()}enterWith(t){}};const v1=new t0,cg=Symbol.for("lc:child_config");var b1=class{getInstance(){return da()??v1}getRunnableConfig(){var e,r;return(r=(e=this.getInstance().getStore())==null?void 0:e.extra)==null?void 0:r[cg]}runWithConfig(t,e,r){var u;const n=Ht._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),s=this.getInstance(),i=s.getStore(),a=n==null?void 0:n.getParentRunId(),o=(u=n==null?void 0:n.handlers)==null?void 0:u.find(l=>(l==null?void 0:l.name)==="langchain_tracer");let c;return o&&a?c=o.getRunTreeWithTracingConfig(a):r||(c=new Xt({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[cg]:t}),i!==void 0&&i[Qi]!==void 0&&(c===void 0&&(c={}),c[Qi]=i[Qi]),s.run(c,e)}initializeGlobalInstance(t){da()===void 0&&DC(t)}};const Et=new b1;var r0={};me(r0,{AsyncLocalStorageProviderSingleton:()=>Et,MockAsyncLocalStorage:()=>t0,_CONTEXT_VARIABLES_KEY:()=>Qi});const Ul=25;async function nr(t){return Ht._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata)}function Cr(...t){const e={};for(const r of t.filter(n=>!!n))for(const n of Object.keys(r))if(n==="metadata")e[n]={...e[n],...r[n]};else if(n==="tags"){const s=e[n]??[];e[n]=[...new Set(s.concat(r[n]??[]))]}else if(n==="configurable")e[n]={...e[n],...r[n]};else if(n==="timeout")e.timeout===void 0?e.timeout=r.timeout:r.timeout!==void 0&&(e.timeout=Math.min(e.timeout,r.timeout));else if(n==="signal")e.signal===void 0?e.signal=r.signal:r.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,r.signal]):e.signal=r.signal);else if(n==="callbacks"){const s=e.callbacks,i=r.callbacks;if(Array.isArray(i))if(!s)e.callbacks=i;else if(Array.isArray(s))e.callbacks=s.concat(i);else{const a=s.copy();for(const o of i)a.addHandler(ha(o),!0);e.callbacks=a}else if(i)if(!s)e.callbacks=i;else if(Array.isArray(s)){const a=i.copy();for(const o of s)a.addHandler(ha(o),!0);e.callbacks=a}else e.callbacks=new Ht(i._parentRunId,{handlers:s.handlers.concat(i.handlers),inheritableHandlers:s.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(i.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(i.inheritableTags))),metadata:{...s.metadata,...i.metadata}})}else{const s=n;e[s]=r[s]??e[s]}return e}const E1=new Set(["string","number","boolean"]);function Le(t){var n;const e=Et.getRunnableConfig();let r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:s,runName:i,...a}=e;r=Object.entries(a).reduce((o,[c,u])=>(u!==void 0&&(o[c]=u),o),r)}if(t&&(r=Object.entries(t).reduce((s,[i,a])=>(a!==void 0&&(s[i]=a),s),r)),r!=null&&r.configurable)for(const s of Object.keys(r.configurable))E1.has(typeof r.configurable[s])&&!((n=r.metadata)!=null&&n[s])&&(r.metadata||(r.metadata={}),r.metadata[s]=r.configurable[s]);if(r.timeout!==void 0){if(r.timeout<=0)throw new Error("Timeout must be a positive number");const s=AbortSignal.timeout(r.timeout);r.signal!==void 0?"any"in AbortSignal&&(r.signal=AbortSignal.any([r.signal,s])):r.signal=s,delete r.timeout}return r}function Fe(t={},{callbacks:e,maxConcurrency:r,recursionLimit:n,runName:s,configurable:i,runId:a}={}){const o=Le(t);return e!==void 0&&(delete o.runName,o.callbacks=e),n!==void 0&&(o.recursionLimit=n),r!==void 0&&(o.maxConcurrency=r),s!==void 0&&(o.runName=s),i!==void 0&&(o.configurable={...o.configurable,...i}),a!==void 0&&delete o.runId,o}function Nn(t){return t?{configurable:t.configurable,recursionLimit:t.recursionLimit,callbacks:t.callbacks,tags:t.tags,metadata:t.metadata,maxConcurrency:t.maxConcurrency,timeout:t.timeout,signal:t.signal}:void 0}async function ns(t,e){if(e===void 0)return t;let r;return Promise.race([t.catch(n=>{if(!(e!=null&&e.aborted))throw n}),new Promise((n,s)=>{r=()=>{s(fa(e))},e.addEventListener("abort",r),e.aborted&&s(fa(e))})]).finally(()=>e.removeEventListener("abort",r))}function fa(t){return(t==null?void 0:t.reason)instanceof Error?t.reason:typeof(t==null?void 0:t.reason)=="string"?new Error(t.reason):new Error("Aborted")}var n0={};me(n0,{AsyncGeneratorWithSetup:()=>Bs,IterableReadableStream:()=>ir,atee:()=>uf,concat:()=>ss,pipeGeneratorWithSetup:()=>s0});var ir=class Nd extends ReadableStream{constructor(){super(...arguments);f(this,"reader")}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const r=await this.reader.read();return r.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:r.value}}catch(r){throw this.reader.releaseLock(),r}}async return(){if(this.ensureReader(),this.locked){const r=this.reader.cancel();this.reader.releaseLock(),await r}return{done:!0,value:void 0}}async throw(r){if(this.ensureReader(),this.locked){const n=this.reader.cancel();this.reader.releaseLock(),await n}throw r}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(r){const n=r.getReader();return new Nd({start(s){return i();function i(){return n.read().then(({done:a,value:o})=>{if(a){s.close();return}return s.enqueue(o),i()})}},cancel(){n.releaseLock()}})}static fromAsyncGenerator(r){return new Nd({async pull(n){const{value:s,done:i}=await r.next();i&&n.close(),n.enqueue(s)},async cancel(n){await r.return(n)}})}};function uf(t,e=2){const r=Array.from({length:e},()=>[]);return r.map(async function*(s){for(;;)if(s.length===0){const i=await t.next();for(const a of r)a.push(i)}else{if(s[0].done)return;yield s.shift().value}})}function ss(t,e){if(Array.isArray(t)&&Array.isArray(e))return t.concat(e);if(typeof t=="string"&&typeof e=="string")return t+e;if(typeof t=="number"&&typeof e=="number")return t+e;if("concat"in t&&typeof t.concat=="function")return t.concat(e);if(typeof t=="object"&&typeof e=="object"){const r={...t};for(const[n,s]of Object.entries(e))n in r&&!Array.isArray(r[n])?r[n]=ss(r[n],s):r[n]=s;return r}else throw new Error(`Cannot concat ${typeof t} and ${typeof e}`)}var Bs=class{constructor(t){f(this,"generator");f(this,"setup");f(this,"config");f(this,"signal");f(this,"firstResult");f(this,"firstResultUsed",!1);var e;this.generator=t.generator,this.config=t.config,this.signal=t.signal??((e=this.config)==null?void 0:e.signal),this.setup=new Promise((r,n)=>{Et.runWithConfig(Nn(t.config),async()=>{this.firstResult=t.generator.next(),t.startSetup?this.firstResult.then(t.startSetup).then(r,n):this.firstResult.then(s=>r(void 0),n)},!0)})}async next(...t){var e;return(e=this.signal)==null||e.throwIfAborted(),this.firstResultUsed?Et.runWithConfig(Nn(this.config),this.signal?async()=>ns(this.generator.next(...t),this.signal):async()=>this.generator.next(...t),!0):(this.firstResultUsed=!0,this.firstResult)}async return(t){return this.generator.return(t)}async throw(t){return this.generator.throw(t)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function s0(t,e,r,n,...s){const i=new Bs({generator:e,startSetup:r,signal:n}),a=await i.setup;return{output:t(i,a,...s),setup:a}}/*!
* https://github.com/Starcounter-Jack/JSON-Patch
* (c) 2017-2022 Joachim Wester
* MIT licensed
*/const S1=Object.prototype.hasOwnProperty;function $d(t,e){return S1.call(t,e)}function Pd(t){if(Array.isArray(t)){const r=new Array(t.length);for(let n=0;n<r.length;n++)r[n]=""+n;return r}if(Object.keys)return Object.keys(t);let e=[];for(let r in t)$d(t,r)&&e.push(r);return e}function Vr(t){switch(typeof t){case"object":return JSON.parse(JSON.stringify(t));case"undefined":return null;default:return t}}function Ld(t){let e=0;const r=t.length;let n;for(;e<r;){if(n=t.charCodeAt(e),n>=48&&n<=57){e++;continue}return!1}return!0}function Gs(t){return t.indexOf("/")===-1&&t.indexOf("~")===-1?t:t.replace(/~/g,"~0").replace(/\//g,"~1")}function x1(t){return t.replace(/~1/g,"/").replace(/~0/g,"~")}function Dd(t){if(t===void 0)return!0;if(t){if(Array.isArray(t)){for(let r=0,n=t.length;r<n;r++)if(Dd(t[r]))return!0}else if(typeof t=="object"){const r=Pd(t),n=r.length;for(var e=0;e<n;e++)if(Dd(t[r[e]]))return!0}}return!1}function ug(t,e){const r=[t];for(const n in e){const s=typeof e[n]=="object"?JSON.stringify(e[n],null,2):e[n];typeof s<"u"&&r.push(`${n}: ${s}`)}return r.join(`
`)}var T1=class extends Error{constructor(t,e,r,n,s){super(ug(t,{name:e,index:r,operation:n,tree:s})),this.name=e,this.index=r,this.operation=n,this.tree=s,Object.setPrototypeOf(this,new.target.prototype),this.message=ug(t,{name:e,index:r,operation:n,tree:s})}},i0={};me(i0,{JsonPatchError:()=>tt,_areEquals:()=>pa,applyOperation:()=>Ss,applyPatch:()=>fi,applyReducer:()=>k1,deepClone:()=>A1,getValueByPointer:()=>ic,validate:()=>a0,validator:()=>ac});const tt=T1,A1=Vr,ti={add:function(t,e,r){return t[e]=this.value,{newDocument:r}},remove:function(t,e,r){var n=t[e];return delete t[e],{newDocument:r,removed:n}},replace:function(t,e,r){var n=t[e];return t[e]=this.value,{newDocument:r,removed:n}},move:function(t,e,r){let n=ic(r,this.path);n&&(n=Vr(n));const s=Ss(r,{op:"remove",path:this.from}).removed;return Ss(r,{op:"add",path:this.path,value:s}),{newDocument:r,removed:n}},copy:function(t,e,r){const n=ic(r,this.from);return Ss(r,{op:"add",path:this.path,value:Vr(n)}),{newDocument:r}},test:function(t,e,r){return{newDocument:r,test:pa(t[e],this.value)}},_get:function(t,e,r){return this.value=t[e],{newDocument:r}}};var C1={add:function(t,e,r){return Ld(e)?t.splice(e,0,this.value):t[e]=this.value,{newDocument:r,index:e}},remove:function(t,e,r){var n=t.splice(e,1);return{newDocument:r,removed:n[0]}},replace:function(t,e,r){var n=t[e];return t[e]=this.value,{newDocument:r,removed:n}},move:ti.move,copy:ti.copy,test:ti.test,_get:ti._get};function ic(t,e){if(e=="")return t;var r={op:"_get",path:e};return Ss(t,r),r.value}function Ss(t,e,r=!1,n=!0,s=!0,i=0){if(r&&(typeof r=="function"?r(e,0,t,e.path):ac(e,0)),e.path===""){let a={newDocument:t};if(e.op==="add")return a.newDocument=e.value,a;if(e.op==="replace")return a.newDocument=e.value,a.removed=t,a;if(e.op==="move"||e.op==="copy")return a.newDocument=ic(t,e.from),e.op==="move"&&(a.removed=t),a;if(e.op==="test"){if(a.test=pa(t,e.value),a.test===!1)throw new tt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return a.newDocument=t,a}else{if(e.op==="remove")return a.removed=t,a.newDocument=null,a;if(e.op==="_get")return e.value=t,a;if(r)throw new tt("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,t);return a}}else{n||(t=Vr(t));const o=(e.path||"").split("/");let c=t,u=1,l=o.length,d,h,p;for(typeof r=="function"?p=r:p=ac;;){if(h=o[u],h&&h.indexOf("~")!=-1&&(h=x1(h)),s&&(h=="__proto__"||h=="prototype"&&u>0&&o[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&d===void 0&&(c[h]===void 0?d=o.slice(0,u).join("/"):u==l-1&&(d=e.path),d!==void 0&&p(e,0,t,d)),u++,Array.isArray(c)){if(h==="-")h=c.length;else{if(r&&!Ld(h))throw new tt("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,t);Ld(h)&&(h=~~h)}if(u>=l){if(r&&e.op==="add"&&h>c.length)throw new tt("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,t);const m=C1[e.op].call(e,c,h,t);if(m.test===!1)throw new tt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return m}}else if(u>=l){const m=ti[e.op].call(e,c,h,t);if(m.test===!1)throw new tt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return m}if(c=c[h],r&&u<l&&(!c||typeof c!="object"))throw new tt("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,t)}}}function fi(t,e,r,n=!0,s=!0){if(r&&!Array.isArray(e))throw new tt("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(t=Vr(t));const i=new Array(e.length);for(let a=0,o=e.length;a<o;a++)i[a]=Ss(t,e[a],r,!0,s,a),t=i[a].newDocument;return i.newDocument=t,i}function k1(t,e,r){const n=Ss(t,e);if(n.test===!1)throw new tt("Test operation failed","TEST_OPERATION_FAILED",r,e,t);return n.newDocument}function ac(t,e,r,n){if(typeof t!="object"||t===null||Array.isArray(t))throw new tt("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,t,r);if(ti[t.op]){if(typeof t.path!="string")throw new tt("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,t,r);if(t.path.indexOf("/")!==0&&t.path.length>0)throw new tt('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,t,r);if((t.op==="move"||t.op==="copy")&&typeof t.from!="string")throw new tt("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,t,r);if((t.op==="add"||t.op==="replace"||t.op==="test")&&t.value===void 0)throw new tt("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,t,r);if((t.op==="add"||t.op==="replace"||t.op==="test")&&Dd(t.value))throw new tt("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,t,r);if(r){if(t.op=="add"){var s=t.path.split("/").length,i=n.split("/").length;if(s!==i+1&&s!==i)throw new tt("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,t,r)}else if(t.op==="replace"||t.op==="remove"||t.op==="_get"){if(t.path!==n)throw new tt("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,t,r)}else if(t.op==="move"||t.op==="copy"){var a={op:"_get",path:t.from,value:void 0},o=a0([a],r);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new tt("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,t,r)}}}else throw new tt("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,t,r)}function a0(t,e,r){try{if(!Array.isArray(t))throw new tt("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)fi(Vr(e),Vr(t),r||!0);else{r=r||ac;for(var n=0;n<t.length;n++)r(t[n],n,e,void 0)}}catch(s){if(s instanceof tt)return s;throw s}}function pa(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){var r=Array.isArray(t),n=Array.isArray(e),s,i,a;if(r&&n){if(i=t.length,i!=e.length)return!1;for(s=i;s--!==0;)if(!pa(t[s],e[s]))return!1;return!0}if(r!=n)return!1;var o=Object.keys(t);if(i=o.length,i!==Object.keys(e).length)return!1;for(s=i;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=i;s--!==0;)if(a=o[s],!pa(t[a],e[a]))return!1;return!0}return t!==t&&e!==e}function o0(t,e,r,n,s){if(e!==t){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=Pd(e),a=Pd(t),o=!1,c=a.length-1;c>=0;c--){var u=a[c],l=t[u];if($d(e,u)&&!(e[u]===void 0&&l!==void 0&&Array.isArray(e)===!1)){var d=e[u];typeof l=="object"&&l!=null&&typeof d=="object"&&d!=null&&Array.isArray(l)===Array.isArray(d)?o0(l,d,r,n+"/"+Gs(u),s):l!==d&&(s&&r.push({op:"test",path:n+"/"+Gs(u),value:Vr(l)}),r.push({op:"replace",path:n+"/"+Gs(u),value:Vr(d)}))}else Array.isArray(t)===Array.isArray(e)?(s&&r.push({op:"test",path:n+"/"+Gs(u),value:Vr(l)}),r.push({op:"remove",path:n+"/"+Gs(u)}),o=!0):(s&&r.push({op:"test",path:n,value:t}),r.push({op:"replace",path:n,value:e}))}if(!(!o&&i.length==a.length))for(var c=0;c<i.length;c++){var u=i[c];!$d(t,u)&&e[u]!==void 0&&r.push({op:"add",path:n+"/"+Gs(u),value:Vr(e[u])})}}}function Xc(t,e,r=!1){var n=[];return o0(t,e,n,"",r),n}({...i0});var c0={};me(c0,{LogStreamCallbackHandler:()=>Ud,RunLog:()=>lf,RunLogPatch:()=>vn,isLogStreamHandler:()=>u0});var vn=class{constructor(t){f(this,"ops");this.ops=t.ops??[]}concat(t){const e=this.ops.concat(t.ops),r=fi({},e);return new lf({ops:e,state:r[r.length-1].newDocument})}},lf=class Md extends vn{constructor(r){super(r);f(this,"state");this.state=r.state}concat(r){const n=this.ops.concat(r.ops),s=fi(this.state,r.ops);return new Md({ops:n,state:s[s.length-1].newDocument})}static fromRunLogPatch(r){const n=fi({},r.ops);return new Md({ops:r.ops,state:n[n.length-1].newDocument})}};const u0=t=>t.name==="log_stream_tracer";async function lg(t,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=t;if(["retriever","llm","prompt"].includes(t.run_type))return r;if(!(Object.keys(r).length===1&&(r==null?void 0:r.input)===""))return r.input}async function dg(t,e){const{outputs:r}=t;return e==="original"||["retriever","llm","prompt"].includes(t.run_type)?r:r!==void 0&&Object.keys(r).length===1&&(r==null?void 0:r.output)!==void 0?r.output:r}function I1(t){return t!==void 0&&t.message!==void 0}var Ud=class extends Un{constructor(e){super({_awaitHandler:!0,...e});f(this,"autoClose",!0);f(this,"includeNames");f(this,"includeTypes");f(this,"includeTags");f(this,"excludeNames");f(this,"excludeTypes");f(this,"excludeTags");f(this,"_schemaFormat","original");f(this,"rootId");f(this,"keyMapByRunId",{});f(this,"counterMapByRunName",{});f(this,"transformStream");f(this,"writer");f(this,"receiveStream");f(this,"name","log_stream_tracer");f(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=ir.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const r=e.tags??[];let n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(n=n||r.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(n=n&&r.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),n}async*tapOutputIterable(e,r){for await(const n of r){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new vn({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new vn({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const r=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=r===1?e.name:`${e.name}:${r}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(n.inputs=await lg(e,this._schemaFormat)),await this.writer.write(new vn({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const r=this.keyMapByRunId[e.id];if(r===void 0)return;const n=[];this._schemaFormat==="streaming_events"&&n.push({op:"replace",path:`/logs/${r}/inputs`,value:await lg(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${r}/final_output`,value:await dg(e,this._schemaFormat)}),e.end_time!==void 0&&n.push({op:"add",path:`/logs/${r}/end_time`,value:new Date(e.end_time).toISOString()});const s=new vn({ops:n});await this.writer.write(s)}finally{if(e.id===this.rootId){const r=new vn({ops:[{op:"replace",path:"/final_output",value:await dg(e,this._schemaFormat)}]});await this.writer.write(r),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,r,n){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const i=e.inputs.messages!==void 0;let a;i?I1(n==null?void 0:n.chunk)?a=n==null?void 0:n.chunk:a=new $t({id:`run-${e.id}`,content:r}):a=r;const o=new vn({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:r},{op:"add",path:`/logs/${s}/streamed_output/-`,value:a}]});await this.writer.write(o)}},l0={};me(l0,{ChatGenerationChunk:()=>Rr,GenerationChunk:()=>pi,RUN_KEY:()=>ma});const ma="__run";var pi=class d0{constructor(e){f(this,"text");f(this,"generationInfo");this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new d0({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},Rr=class h0 extends pi{constructor(r){super(r);f(this,"message");this.message=r.message}concat(r){return new h0({text:this.text+r.text,generationInfo:{...this.generationInfo,...r.generationInfo},message:this.message.concat(r.message)})}},f0={};me(f0,{AsyncCaller:()=>za});const R1=[400,401,402,403,404,405,406,407,409],O1=t=>{var r,n;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||(t==null?void 0:t.code)==="ECONNABORTED")throw t;const e=((r=t==null?void 0:t.response)==null?void 0:r.status)??(t==null?void 0:t.status);if(e&&R1.includes(+e))throw t;if(((n=t==null?void 0:t.error)==null?void 0:n.code)==="insufficient_quota"){const s=new Error(t==null?void 0:t.message);throw s.name="InsufficientQuotaError",s}};var za=class{constructor(t){f(this,"maxConcurrency");f(this,"maxRetries");f(this,"onFailedAttempt");f(this,"queue");this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6,this.onFailedAttempt=t.onFailedAttempt??O1;const e="default"in An?An.default:An;this.queue=new e({concurrency:this.maxConcurrency})}call(t,...e){return this.queue.add(()=>Qo(()=>t(...e).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(t,e,...r){return t.signal?Promise.race([this.call(e,...r),new Promise((n,s)=>{var i;(i=t.signal)==null||i.addEventListener("abort",()=>{s(fa(t.signal))})})]):this.call(e,...r)}fetch(...t){return this.call(()=>fetch(...t).then(e=>e.ok?e:Promise.reject(e)))}};function Ie(t,e,r){function n(o,c){var u;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(u=o._zod).traits??(u.traits=new Set),o._zod.traits.add(t),e(o,c);for(const l in a.prototype)l in o||Object.defineProperty(o,l,{value:a.prototype[l].bind(o)});o._zod.constr=a,o._zod.def=c}const s=(r==null?void 0:r.Parent)??Object;class i extends s{}Object.defineProperty(i,"name",{value:t});function a(o){var c;const u=r!=null&&r.Parent?new i:this;n(u,o),(c=u._zod).deferred??(c.deferred=[]);for(const l of u._zod.deferred)l();return u}return Object.defineProperty(a,"init",{value:n}),Object.defineProperty(a,Symbol.hasInstance,{value:o=>{var c,u;return r!=null&&r.Parent&&o instanceof r.Parent?!0:(u=(c=o==null?void 0:o._zod)==null?void 0:c.traits)==null?void 0:u.has(t)}}),Object.defineProperty(a,"name",{value:t}),a}class ga extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const N1={};function Rs(t){return N1}function $1(t){const e=Object.values(t).filter(n=>typeof n=="number");return Object.entries(t).filter(([n,s])=>e.indexOf(+n)===-1).map(([n,s])=>s)}function P1(t,e){return typeof e=="bigint"?e.toString():e}function df(t){return t==null}function hf(t){const e=t.startsWith("^")?1:0,r=t.endsWith("$")?t.length-1:t.length;return t.slice(e,r)}function rt(t,e,r){Object.defineProperty(t,e,{get(){{const n=r();return t[e]=n,n}},set(n){Object.defineProperty(t,e,{value:n})},configurable:!0})}function L1(t,e,r){Object.defineProperty(t,e,{value:r,writable:!0,enumerable:!0,configurable:!0})}const p0=Error.captureStackTrace?Error.captureStackTrace:(...t)=>{};function hg(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function Bd(t){if(hg(t)===!1)return!1;const e=t.constructor;if(e===void 0)return!0;const r=e.prototype;return!(hg(r)===!1||Object.prototype.hasOwnProperty.call(r,"isPrototypeOf")===!1)}function pn(t,e,r){const n=new t._zod.constr(e??t._zod.def);return(!e||r!=null&&r.parent)&&(n._zod.parent=t),n}function ds(t){const e=t;if(!e)return{};if(typeof e=="string")return{error:()=>e};if((e==null?void 0:e.message)!==void 0){if((e==null?void 0:e.error)!==void 0)throw new Error("Cannot specify both `message` and `error` params");e.error=e.message}return delete e.message,typeof e.error=="string"?{...e,error:()=>e.error}:e}function D1(t,e){if(!Bd(e))throw new Error("Invalid input to extend: expected a plain object");const r={...t._zod.def,get shape(){const n={...t._zod.def.shape,...e};return L1(this,"shape",n),n},checks:[]};return pn(t,r)}function M1(t,e,r){const n=e._zod.def.shape,s={...n};for(const i in n)s[i]=t?new t({type:"optional",innerType:n[i]}):n[i];return pn(e,{...e._zod.def,shape:s,checks:[]})}function ta(t,e=0){var r;for(let n=e;n<t.issues.length;n++)if(((r=t.issues[n])==null?void 0:r.continue)!==!0)return!0;return!1}function U1(t,e){return e.map(r=>{var n;return(n=r).path??(n.path=[]),r.path.unshift(t),r})}function ho(t){return typeof t=="string"?t:t==null?void 0:t.message}function Os(t,e,r){var s,i,a,o,c,u;const n={...t,path:t.path??[]};if(!t.message){const l=ho((a=(i=(s=t.inst)==null?void 0:s._zod.def)==null?void 0:i.error)==null?void 0:a.call(i,t))??ho((o=e==null?void 0:e.error)==null?void 0:o.call(e,t))??ho((c=r.customError)==null?void 0:c.call(r,t))??ho((u=r.localeError)==null?void 0:u.call(r,t))??"Invalid input";n.message=l}return delete n.inst,delete n.continue,e!=null&&e.reportInput||delete n.input,n}function ff(t){return Array.isArray(t)?"array":typeof t=="string"?"string":"unknown"}function ya(...t){const[e,r,n]=t;return typeof e=="string"?{message:e,code:"custom",input:r,inst:n}:{...e}}const m0=(t,e)=>{t.name="$ZodError",Object.defineProperty(t,"_zod",{value:t._zod,enumerable:!1}),Object.defineProperty(t,"issues",{value:e,enumerable:!1}),Object.defineProperty(t,"message",{get(){return JSON.stringify(e,P1,2)},enumerable:!0}),Object.defineProperty(t,"toString",{value:()=>t.message,enumerable:!1})},g0=Ie("$ZodError",m0),Yc=Ie("$ZodError",m0,{Parent:Error});function B1(t,e=r=>r.message){const r={},n=[];for(const s of t.issues)s.path.length>0?(r[s.path[0]]=r[s.path[0]]||[],r[s.path[0]].push(e(s))):n.push(e(s));return{formErrors:n,fieldErrors:r}}function F1(t,e){const r=e||function(i){return i.message},n={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union"&&a.errors.length)a.errors.map(o=>s({issues:o}));else if(a.code==="invalid_key")s({issues:a.issues});else if(a.code==="invalid_element")s({issues:a.issues});else if(a.path.length===0)n._errors.push(r(a));else{let o=n,c=0;for(;c<a.path.length;){const u=a.path[c];c===a.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(r(a))):o[u]=o[u]||{_errors:[]},o=o[u],c++}}};return s(t),n}function j1(t){const e=[];for(const r of t)typeof r=="number"?e.push(`[${r}]`):typeof r=="symbol"?e.push(`[${JSON.stringify(String(r))}]`):/[^\w$]/.test(r)?e.push(`[${JSON.stringify(r)}]`):(e.length&&e.push("."),e.push(r));return e.join("")}function z1(t){var n;const e=[],r=[...t.issues].sort((s,i)=>s.path.length-i.path.length);for(const s of r)e.push(`✖ ${s.message}`),(n=s.path)!=null&&n.length&&e.push(`  → at ${j1(s.path)}`);return e.join(`
`)}const y0=t=>(e,r,n,s)=>{const i=n?Object.assign(n,{async:!1}):{async:!1},a=e._zod.run({value:r,issues:[]},i);if(a instanceof Promise)throw new ga;if(a.issues.length){const o=new((s==null?void 0:s.Err)??t)(a.issues.map(c=>Os(c,i,Rs())));throw p0(o,s==null?void 0:s.callee),o}return a.value},pf=y0(Yc),_0=t=>async(e,r,n,s)=>{const i=n?Object.assign(n,{async:!0}):{async:!0};let a=e._zod.run({value:r,issues:[]},i);if(a instanceof Promise&&(a=await a),a.issues.length){const o=new((s==null?void 0:s.Err)??t)(a.issues.map(c=>Os(c,i,Rs())));throw p0(o,s==null?void 0:s.callee),o}return a.value},w0=_0(Yc),v0=t=>(e,r,n)=>{const s=n?{...n,async:!1}:{async:!1},i=e._zod.run({value:r,issues:[]},s);if(i instanceof Promise)throw new ga;return i.issues.length?{success:!1,error:new(t??g0)(i.issues.map(a=>Os(a,s,Rs())))}:{success:!0,data:i.value}},V1=v0(Yc),b0=t=>async(e,r,n)=>{const s=n?Object.assign(n,{async:!0}):{async:!0};let i=e._zod.run({value:r,issues:[]},s);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new t(i.issues.map(a=>Os(a,s,Rs())))}:{success:!0,data:i.value}},G1=b0(Yc),Oi=Ie("$ZodCheck",(t,e)=>{var r;t._zod??(t._zod={}),t._zod.def=e,(r=t._zod).onattach??(r.onattach=[])}),H1=Ie("$ZodCheckMaxLength",(t,e)=>{var r;Oi.init(t,e),(r=t._zod.def).when??(r.when=n=>{const s=n.value;return!df(s)&&s.length!==void 0}),t._zod.onattach.push(n=>{const s=n._zod.bag.maximum??Number.POSITIVE_INFINITY;e.maximum<s&&(n._zod.bag.maximum=e.maximum)}),t._zod.check=n=>{const s=n.value;if(s.length<=e.maximum)return;const a=ff(s);n.issues.push({origin:a,code:"too_big",maximum:e.maximum,inclusive:!0,input:s,inst:t,continue:!e.abort})}}),q1=Ie("$ZodCheckMinLength",(t,e)=>{var r;Oi.init(t,e),(r=t._zod.def).when??(r.when=n=>{const s=n.value;return!df(s)&&s.length!==void 0}),t._zod.onattach.push(n=>{const s=n._zod.bag.minimum??Number.NEGATIVE_INFINITY;e.minimum>s&&(n._zod.bag.minimum=e.minimum)}),t._zod.check=n=>{const s=n.value;if(s.length>=e.minimum)return;const a=ff(s);n.issues.push({origin:a,code:"too_small",minimum:e.minimum,inclusive:!0,input:s,inst:t,continue:!e.abort})}}),W1=Ie("$ZodCheckLengthEquals",(t,e)=>{var r;Oi.init(t,e),(r=t._zod.def).when??(r.when=n=>{const s=n.value;return!df(s)&&s.length!==void 0}),t._zod.onattach.push(n=>{const s=n._zod.bag;s.minimum=e.length,s.maximum=e.length,s.length=e.length}),t._zod.check=n=>{const s=n.value,i=s.length;if(i===e.length)return;const a=ff(s),o=i>e.length;n.issues.push({origin:a,...o?{code:"too_big",maximum:e.length}:{code:"too_small",minimum:e.length},inclusive:!0,exact:!0,input:n.value,inst:t,continue:!e.abort})}}),J1=Ie("$ZodCheckOverwrite",(t,e)=>{Oi.init(t,e),t._zod.check=r=>{r.value=e.tx(r.value)}}),Z1={major:4,minor:0,patch:0},Pt=Ie("$ZodType",(t,e)=>{var s;var r;t??(t={}),t._zod.def=e,t._zod.bag=t._zod.bag||{},t._zod.version=Z1;const n=[...t._zod.def.checks??[]];t._zod.traits.has("$ZodCheck")&&n.unshift(t);for(const i of n)for(const a of i._zod.onattach)a(t);if(n.length===0)(r=t._zod).deferred??(r.deferred=[]),(s=t._zod.deferred)==null||s.push(()=>{t._zod.run=t._zod.parse});else{const i=(a,o,c)=>{let u=ta(a),l;for(const d of o){if(d._zod.def.when){if(!d._zod.def.when(a))continue}else if(u)continue;const h=a.issues.length,p=d._zod.check(a);if(p instanceof Promise&&(c==null?void 0:c.async)===!1)throw new ga;if(l||p instanceof Promise)l=(l??Promise.resolve()).then(async()=>{await p,a.issues.length!==h&&(u||(u=ta(a,h)))});else{if(a.issues.length===h)continue;u||(u=ta(a,h))}}return l?l.then(()=>a):a};t._zod.run=(a,o)=>{const c=t._zod.parse(a,o);if(c instanceof Promise){if(o.async===!1)throw new ga;return c.then(u=>i(u,n,o))}return i(c,n,o)}}t["~standard"]={validate:i=>{var a;try{const o=V1(t,i);return o.success?{value:o.data}:{issues:(a=o.error)==null?void 0:a.issues}}catch{return G1(t,i).then(c=>{var u;return c.success?{value:c.data}:{issues:(u=c.error)==null?void 0:u.issues}})}},vendor:"zod",version:1}}),K1=Ie("$ZodAny",(t,e)=>{Pt.init(t,e),t._zod.parse=r=>r}),X1=Ie("$ZodUnknown",(t,e)=>{Pt.init(t,e),t._zod.parse=r=>r}),Y1=Ie("$ZodNever",(t,e)=>{Pt.init(t,e),t._zod.parse=(r,n)=>(r.issues.push({expected:"never",code:"invalid_type",input:r.value,inst:t}),r)});function fg(t,e,r){t.issues.length&&e.issues.push(...U1(r,t.issues)),e.value[r]=t.value}const Q1=Ie("$ZodArray",(t,e)=>{Pt.init(t,e),t._zod.parse=(r,n)=>{const s=r.value;if(!Array.isArray(s))return r.issues.push({expected:"array",code:"invalid_type",input:s,inst:t}),r;r.value=Array(s.length);const i=[];for(let a=0;a<s.length;a++){const o=s[a],c=e.element._zod.run({value:o,issues:[]},n);c instanceof Promise?i.push(c.then(u=>fg(u,r,a))):fg(c,r,a)}return i.length?Promise.all(i).then(()=>r):r}});function pg(t,e,r,n){for(const s of t)if(s.issues.length===0)return e.value=s.value,e;return e.issues.push({code:"invalid_union",input:e.value,inst:r,errors:t.map(s=>s.issues.map(i=>Os(i,n,Rs())))}),e}const ek=Ie("$ZodUnion",(t,e)=>{Pt.init(t,e),rt(t._zod,"optin",()=>e.options.some(r=>r._zod.optin==="optional")?"optional":void 0),rt(t._zod,"optout",()=>e.options.some(r=>r._zod.optout==="optional")?"optional":void 0),rt(t._zod,"values",()=>{if(e.options.every(r=>r._zod.values))return new Set(e.options.flatMap(r=>Array.from(r._zod.values)))}),rt(t._zod,"pattern",()=>{if(e.options.every(r=>r._zod.pattern)){const r=e.options.map(n=>n._zod.pattern);return new RegExp(`^(${r.map(n=>hf(n.source)).join("|")})$`)}}),t._zod.parse=(r,n)=>{let s=!1;const i=[];for(const a of e.options){const o=a._zod.run({value:r.value,issues:[]},n);if(o instanceof Promise)i.push(o),s=!0;else{if(o.issues.length===0)return o;i.push(o)}}return s?Promise.all(i).then(a=>pg(a,r,t,n)):pg(i,r,t,n)}}),tk=Ie("$ZodIntersection",(t,e)=>{Pt.init(t,e),t._zod.parse=(r,n)=>{const s=r.value,i=e.left._zod.run({value:s,issues:[]},n),a=e.right._zod.run({value:s,issues:[]},n);return i instanceof Promise||a instanceof Promise?Promise.all([i,a]).then(([c,u])=>mg(r,c,u)):mg(r,i,a)}});function Fd(t,e){if(t===e)return{valid:!0,data:t};if(t instanceof Date&&e instanceof Date&&+t==+e)return{valid:!0,data:t};if(Bd(t)&&Bd(e)){const r=Object.keys(e),n=Object.keys(t).filter(i=>r.indexOf(i)!==-1),s={...t,...e};for(const i of n){const a=Fd(t[i],e[i]);if(!a.valid)return{valid:!1,mergeErrorPath:[i,...a.mergeErrorPath]};s[i]=a.data}return{valid:!0,data:s}}if(Array.isArray(t)&&Array.isArray(e)){if(t.length!==e.length)return{valid:!1,mergeErrorPath:[]};const r=[];for(let n=0;n<t.length;n++){const s=t[n],i=e[n],a=Fd(s,i);if(!a.valid)return{valid:!1,mergeErrorPath:[n,...a.mergeErrorPath]};r.push(a.data)}return{valid:!0,data:r}}return{valid:!1,mergeErrorPath:[]}}function mg(t,e,r){if(e.issues.length&&t.issues.push(...e.issues),r.issues.length&&t.issues.push(...r.issues),ta(t))return t;const n=Fd(e.value,r.value);if(!n.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(n.mergeErrorPath)}`);return t.value=n.data,t}const rk=Ie("$ZodTransform",(t,e)=>{Pt.init(t,e),t._zod.parse=(r,n)=>{const s=e.transform(r.value,r);if(n.async)return(s instanceof Promise?s:Promise.resolve(s)).then(a=>(r.value=a,r));if(s instanceof Promise)throw new ga;return r.value=s,r}}),mf=Ie("$ZodOptional",(t,e)=>{Pt.init(t,e),t._zod.optin="optional",t._zod.optout="optional",rt(t._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,void 0]):void 0),rt(t._zod,"pattern",()=>{const r=e.innerType._zod.pattern;return r?new RegExp(`^(${hf(r.source)})?$`):void 0}),t._zod.parse=(r,n)=>e.innerType._zod.optin==="optional"?e.innerType._zod.run(r,n):r.value===void 0?r:e.innerType._zod.run(r,n)}),nk=Ie("$ZodNullable",(t,e)=>{Pt.init(t,e),rt(t._zod,"optin",()=>e.innerType._zod.optin),rt(t._zod,"optout",()=>e.innerType._zod.optout),rt(t._zod,"pattern",()=>{const r=e.innerType._zod.pattern;return r?new RegExp(`^(${hf(r.source)}|null)$`):void 0}),rt(t._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,null]):void 0),t._zod.parse=(r,n)=>r.value===null?r:e.innerType._zod.run(r,n)}),sk=Ie("$ZodDefault",(t,e)=>{Pt.init(t,e),t._zod.optin="optional",rt(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(r,n)=>{if(r.value===void 0)return r.value=e.defaultValue,r;const s=e.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>gg(i,e)):gg(s,e)}});function gg(t,e){return t.value===void 0&&(t.value=e.defaultValue),t}const ik=Ie("$ZodPrefault",(t,e)=>{Pt.init(t,e),t._zod.optin="optional",rt(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(r,n)=>(r.value===void 0&&(r.value=e.defaultValue),e.innerType._zod.run(r,n))}),ak=Ie("$ZodNonOptional",(t,e)=>{Pt.init(t,e),rt(t._zod,"values",()=>{const r=e.innerType._zod.values;return r?new Set([...r].filter(n=>n!==void 0)):void 0}),t._zod.parse=(r,n)=>{const s=e.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>yg(i,t)):yg(s,t)}});function yg(t,e){return!t.issues.length&&t.value===void 0&&t.issues.push({code:"invalid_type",expected:"nonoptional",input:t.value,inst:e}),t}const ok=Ie("$ZodCatch",(t,e)=>{Pt.init(t,e),t._zod.optin="optional",rt(t._zod,"optout",()=>e.innerType._zod.optout),rt(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(r,n)=>{const s=e.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>(r.value=i.value,i.issues.length&&(r.value=e.catchValue({...r,error:{issues:i.issues.map(a=>Os(a,n,Rs()))},input:r.value}),r.issues=[]),r)):(r.value=s.value,s.issues.length&&(r.value=e.catchValue({...r,error:{issues:s.issues.map(i=>Os(i,n,Rs()))},input:r.value}),r.issues=[]),r)}}),ck=Ie("$ZodPipe",(t,e)=>{Pt.init(t,e),rt(t._zod,"values",()=>e.in._zod.values),rt(t._zod,"optin",()=>e.in._zod.optin),rt(t._zod,"optout",()=>e.out._zod.optout),t._zod.parse=(r,n)=>{const s=e.in._zod.run(r,n);return s instanceof Promise?s.then(i=>_g(i,e,n)):_g(s,e,n)}});function _g(t,e,r){return ta(t)?t:e.out._zod.run({value:t.value,issues:t.issues},r)}const uk=Ie("$ZodReadonly",(t,e)=>{Pt.init(t,e),rt(t._zod,"propValues",()=>e.innerType._zod.propValues),rt(t._zod,"values",()=>e.innerType._zod.values),rt(t._zod,"optin",()=>e.innerType._zod.optin),rt(t._zod,"optout",()=>e.innerType._zod.optout),t._zod.parse=(r,n)=>{const s=e.innerType._zod.run(r,n);return s instanceof Promise?s.then(wg):wg(s)}});function wg(t){return t.value=Object.freeze(t.value),t}const lk=Ie("$ZodCustom",(t,e)=>{Oi.init(t,e),Pt.init(t,e),t._zod.parse=(r,n)=>r,t._zod.check=r=>{const n=r.value,s=e.fn(n);if(s instanceof Promise)return s.then(i=>vg(i,r,n,t));vg(s,r,n,t)}});function vg(t,e,r,n){if(!t){const s={code:"custom",input:r,inst:n,path:[...n._zod.def.path??[]],continue:!n._zod.def.abort};n._zod.def.params&&(s.params=n._zod.def.params),e.issues.push(ya(s))}}class E0{constructor(){this._map=new Map,this._idmap=new Map}add(e,...r){const n=r[0];if(this._map.set(e,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const r=this._map.get(e);return r&&typeof r=="object"&&"id"in r&&this._idmap.delete(r.id),this._map.delete(e),this}get(e){const r=e._zod.parent;if(r){const n={...this.get(r)??{}};return delete n.id,{...n,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function dk(){return new E0}const bt=dk();function hk(t){return new t({type:"any"})}function fk(t){return new t({type:"unknown"})}function pk(t,e){return new t({type:"never",...ds(e)})}function mk(t,e){return new H1({check:"max_length",...ds(e),maximum:t})}function bg(t,e){return new q1({check:"min_length",...ds(e),minimum:t})}function gk(t,e){return new W1({check:"length_equals",...ds(e),length:t})}function yk(t){return new J1({check:"overwrite",tx:t})}function _k(t,e,r){return new t({type:"array",element:e,...ds(r)})}function wk(t,e,r){return new t({type:"custom",check:"custom",fn:e,...ds(r)})}class Eg{constructor(e){this.counter=0,this.metadataRegistry=(e==null?void 0:e.metadata)??bt,this.target=(e==null?void 0:e.target)??"draft-2020-12",this.unrepresentable=(e==null?void 0:e.unrepresentable)??"throw",this.override=(e==null?void 0:e.override)??(()=>{}),this.io=(e==null?void 0:e.io)??"output",this.seen=new Map}process(e,r={path:[],schemaPath:[]}){var d,h,p;var n;const s=e._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},a=this.seen.get(e);if(a)return a.count++,r.schemaPath.includes(e)&&(a.cycle=r.path),a.schema;const o={schema:{},count:1,cycle:void 0,path:r.path};this.seen.set(e,o);const c=(h=(d=e._zod).toJSONSchema)==null?void 0:h.call(d);if(c)o.schema=c;else{const m={...r,schemaPath:[...r.schemaPath,e],path:r.path},_=e._zod.parent;if(_)o.ref=_,this.process(_,m),this.seen.get(_).isParent=!0;else{const v=o.schema;switch(s.type){case"string":{const y=v;y.type="string";const{minimum:E,maximum:b,format:I,patterns:k,contentEncoding:R}=e._zod.bag;if(typeof E=="number"&&(y.minLength=E),typeof b=="number"&&(y.maxLength=b),I&&(y.format=i[I]??I,y.format===""&&delete y.format),R&&(y.contentEncoding=R),k&&k.size>0){const P=[...k];P.length===1?y.pattern=P[0].source:P.length>1&&(o.schema.allOf=[...P.map(T=>({...this.target==="draft-7"?{type:"string"}:{},pattern:T.source}))])}break}case"number":{const y=v,{minimum:E,maximum:b,format:I,multipleOf:k,exclusiveMaximum:R,exclusiveMinimum:P}=e._zod.bag;typeof I=="string"&&I.includes("int")?y.type="integer":y.type="number",typeof P=="number"&&(y.exclusiveMinimum=P),typeof E=="number"&&(y.minimum=E,typeof P=="number"&&(P>=E?delete y.minimum:delete y.exclusiveMinimum)),typeof R=="number"&&(y.exclusiveMaximum=R),typeof b=="number"&&(y.maximum=b,typeof R=="number"&&(R<=b?delete y.maximum:delete y.exclusiveMaximum)),typeof k=="number"&&(y.multipleOf=k);break}case"boolean":{const y=v;y.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{v.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{v.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const y=v,{minimum:E,maximum:b}=e._zod.bag;typeof E=="number"&&(y.minItems=E),typeof b=="number"&&(y.maxItems=b),y.type="array",y.items=this.process(s.element,{...m,path:[...m.path,"items"]});break}case"object":{const y=v;y.type="object",y.properties={};const E=s.shape;for(const k in E)y.properties[k]=this.process(E[k],{...m,path:[...m.path,"properties",k]});const b=new Set(Object.keys(E)),I=new Set([...b].filter(k=>{const R=s.shape[k]._zod;return this.io==="input"?R.optin===void 0:R.optout===void 0}));I.size>0&&(y.required=Array.from(I)),((p=s.catchall)==null?void 0:p._zod.def.type)==="never"?y.additionalProperties=!1:s.catchall?s.catchall&&(y.additionalProperties=this.process(s.catchall,{...m,path:[...m.path,"additionalProperties"]})):this.io==="output"&&(y.additionalProperties=!1);break}case"union":{const y=v;y.anyOf=s.options.map((E,b)=>this.process(E,{...m,path:[...m.path,"anyOf",b]}));break}case"intersection":{const y=v,E=this.process(s.left,{...m,path:[...m.path,"allOf",0]}),b=this.process(s.right,{...m,path:[...m.path,"allOf",1]}),I=R=>"allOf"in R&&Object.keys(R).length===1,k=[...I(E)?E.allOf:[E],...I(b)?b.allOf:[b]];y.allOf=k;break}case"tuple":{const y=v;y.type="array";const E=s.items.map((k,R)=>this.process(k,{...m,path:[...m.path,"prefixItems",R]}));if(this.target==="draft-2020-12"?y.prefixItems=E:y.items=E,s.rest){const k=this.process(s.rest,{...m,path:[...m.path,"items"]});this.target==="draft-2020-12"?y.items=k:y.additionalItems=k}s.rest&&(y.items=this.process(s.rest,{...m,path:[...m.path,"items"]}));const{minimum:b,maximum:I}=e._zod.bag;typeof b=="number"&&(y.minItems=b),typeof I=="number"&&(y.maxItems=I);break}case"record":{const y=v;y.type="object",y.propertyNames=this.process(s.keyType,{...m,path:[...m.path,"propertyNames"]}),y.additionalProperties=this.process(s.valueType,{...m,path:[...m.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const y=v,E=$1(s.entries);E.every(b=>typeof b=="number")&&(y.type="number"),E.every(b=>typeof b=="string")&&(y.type="string"),y.enum=E;break}case"literal":{const y=v,E=[];for(const b of s.values)if(b===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof b=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");E.push(Number(b))}else E.push(b);if(E.length!==0)if(E.length===1){const b=E[0];y.type=b===null?"null":typeof b,y.const=b}else E.every(b=>typeof b=="number")&&(y.type="number"),E.every(b=>typeof b=="string")&&(y.type="string"),E.every(b=>typeof b=="boolean")&&(y.type="string"),E.every(b=>b===null)&&(y.type="null"),y.enum=E;break}case"file":{const y=v,E={type:"string",format:"binary",contentEncoding:"binary"},{minimum:b,maximum:I,mime:k}=e._zod.bag;b!==void 0&&(E.minLength=b),I!==void 0&&(E.maxLength=I),k?k.length===1?(E.contentMediaType=k[0],Object.assign(y,E)):y.anyOf=k.map(R=>({...E,contentMediaType:R})):Object.assign(y,E);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const y=this.process(s.innerType,m);v.anyOf=[y,{type:"null"}];break}case"nonoptional":{this.process(s.innerType,m),o.ref=s.innerType;break}case"success":{const y=v;y.type="boolean";break}case"default":{this.process(s.innerType,m),o.ref=s.innerType,v.default=JSON.parse(JSON.stringify(s.defaultValue));break}case"prefault":{this.process(s.innerType,m),o.ref=s.innerType,this.io==="input"&&(v._prefault=JSON.parse(JSON.stringify(s.defaultValue)));break}case"catch":{this.process(s.innerType,m),o.ref=s.innerType;let y;try{y=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}v.default=y;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const y=v,E=e._zod.pattern;if(!E)throw new Error("Pattern not found in template literal");y.type="string",y.pattern=E.source;break}case"pipe":{const y=this.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;this.process(y,m),o.ref=y;break}case"readonly":{this.process(s.innerType,m),o.ref=s.innerType,v.readOnly=!0;break}case"promise":{this.process(s.innerType,m),o.ref=s.innerType;break}case"optional":{this.process(s.innerType,m),o.ref=s.innerType;break}case"lazy":{const y=e._zod.innerType;this.process(y,m),o.ref=y;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}}}}const u=this.metadataRegistry.get(e);return u&&Object.assign(o.schema,u),this.io==="input"&&ft(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((n=o.schema).default??(n.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,r){var l,d,h,p,m,_;const n={cycles:(r==null?void 0:r.cycles)??"ref",reused:(r==null?void 0:r.reused)??"inline",external:(r==null?void 0:r.external)??void 0},s=this.seen.get(e);if(!s)throw new Error("Unprocessed schema. This is a bug in Zod.");const i=v=>{var k;const y=this.target==="draft-2020-12"?"$defs":"definitions";if(n.external){const R=(k=n.external.registry.get(v[0]))==null?void 0:k.id,P=n.external.uri??(H=>H);if(R)return{ref:P(R)};const T=v[1].defId??v[1].schema.id??`schema${this.counter++}`;return v[1].defId=T,{defId:T,ref:`${P("__shared")}#/${y}/${T}`}}if(v[1]===s)return{ref:"#"};const b=`#/${y}/`,I=v[1].schema.id??`__schema${this.counter++}`;return{defId:I,ref:b+I}},a=v=>{if(v[1].schema.$ref)return;const y=v[1],{ref:E,defId:b}=i(v);y.def={...y.schema},b&&(y.defId=b);const I=y.schema;for(const k in I)delete I[k];I.$ref=E};if(n.cycles==="throw")for(const v of this.seen.entries()){const y=v[1];if(y.cycle)throw new Error(`Cycle detected: #/${(l=y.cycle)==null?void 0:l.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const v of this.seen.entries()){const y=v[1];if(e===v[0]){a(v);continue}if(n.external){const b=(d=n.external.registry.get(v[0]))==null?void 0:d.id;if(e!==v[0]&&b){a(v);continue}}if((h=this.metadataRegistry.get(v[0]))==null?void 0:h.id){a(v);continue}if(y.cycle){a(v);continue}if(y.count>1&&n.reused==="ref"){a(v);continue}}const o=(v,y)=>{const E=this.seen.get(v),b=E.def??E.schema,I={...b};if(E.ref===null)return;const k=E.ref;if(E.ref=null,k){o(k,y);const R=this.seen.get(k).schema;R.$ref&&y.target==="draft-7"?(b.allOf=b.allOf??[],b.allOf.push(R)):(Object.assign(b,R),Object.assign(b,I))}E.isParent||this.override({zodSchema:v,jsonSchema:b,path:E.path??[]})};for(const v of[...this.seen.entries()].reverse())o(v[0],{target:this.target});const c={};if(this.target==="draft-2020-12"?c.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?c.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),(p=n.external)!=null&&p.uri){const v=(m=n.external.registry.get(e))==null?void 0:m.id;if(!v)throw new Error("Schema is missing an `id` property");c.$id=n.external.uri(v)}Object.assign(c,s.def);const u=((_=n.external)==null?void 0:_.defs)??{};for(const v of this.seen.entries()){const y=v[1];y.def&&y.defId&&(u[y.defId]=y.def)}n.external||Object.keys(u).length>0&&(this.target==="draft-2020-12"?c.$defs=u:c.definitions=u);try{return JSON.parse(JSON.stringify(c))}catch{throw new Error("Error converting schema to JSON.")}}}function Sg(t,e){if(t instanceof E0){const n=new Eg(e),s={};for(const o of t._idmap.entries()){const[c,u]=o;n.process(u)}const i={},a={registry:t,uri:e==null?void 0:e.uri,defs:s};for(const o of t._idmap.entries()){const[c,u]=o;i[c]=n.emit(u,{...e,external:a})}if(Object.keys(s).length>0){const o=n.target==="draft-2020-12"?"$defs":"definitions";i.__shared={[o]:s}}return{schemas:i}}const r=new Eg(e);return r.process(t),r.emit(t,e)}function ft(t,e){const r=e??{seen:new Set};if(r.seen.has(t))return!1;r.seen.add(t);const s=t._zod.def;switch(s.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return ft(s.element,r);case"object":{for(const i in s.shape)if(ft(s.shape[i],r))return!0;return!1}case"union":{for(const i of s.options)if(ft(i,r))return!0;return!1}case"intersection":return ft(s.left,r)||ft(s.right,r);case"tuple":{for(const i of s.items)if(ft(i,r))return!0;return!!(s.rest&&ft(s.rest,r))}case"record":return ft(s.keyType,r)||ft(s.valueType,r);case"map":return ft(s.keyType,r)||ft(s.valueType,r);case"set":return ft(s.valueType,r);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return ft(s.innerType,r);case"lazy":return ft(s.getter(),r);case"default":return ft(s.innerType,r);case"prefault":return ft(s.innerType,r);case"custom":return!1;case"transform":return!0;case"pipe":return ft(s.in,r)||ft(s.out,r);case"success":return!1;case"catch":return!1}throw new Error(`Unknown schema type: ${s.type}`)}function it(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_zod"in e))return!1;const r=e._zod;return typeof r=="object"&&r!==null&&"def"in r}function dt(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_def"in e)||"_zod"in e)return!1;const r=e._def;return typeof r=="object"&&r!=null&&"typeName"in r}function vk(t){return it(t)&&console.warn("[WARNING] Attempting to use Zod 4 schema in a context where Zod 3 schema is expected. This may cause unexpected behavior."),dt(t)}function hs(t){return!t||typeof t!="object"||Array.isArray(t)?!1:!!(it(t)||dt(t))}function S0(t){return typeof t=="object"&&t!==null&&"_def"in t&&typeof t._def=="object"&&t._def!==null&&"typeName"in t._def&&t._def.typeName==="ZodLiteral"}function x0(t){return it(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="literal":!1}function bk(t){return!!(S0(t)||x0(t))}async function T0(t,e){if(it(t))try{return{success:!0,data:await w0(t,e)}}catch(r){return{success:!1,error:r}}if(dt(t))return await t.safeParseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function Qc(t,e){if(it(t))return await w0(t,e);if(dt(t))return await t.parseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Ek(t,e){if(it(t))try{return{success:!0,data:pf(t,e)}}catch(r){return{success:!1,error:r}}if(dt(t))return t.safeParse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Po(t,e){if(it(t))return pf(t,e);if(dt(t))return t.parse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function mi(t){var e;if(it(t))return(e=bt.get(t))==null?void 0:e.description;if(dt(t)||"description"in t&&typeof t.description=="string")return t.description}function Sk(t){if(!hs(t))return!1;if(dt(t)){const e=t._def;if(e.typeName==="ZodObject"){const r=t;return!r.shape||Object.keys(r.shape).length===0}if(e.typeName==="ZodRecord")return!0}if(it(t)){const e=t._zod.def;if(e.type==="object"){const r=t;return!r.shape||Object.keys(r.shape).length===0}if(e.type==="record")return!0}return typeof t=="object"&&t!==null&&!("shape"in t)}function gf(t){return hs(t)?dt(t)?t._def.typeName==="ZodString":it(t)?t._zod.def.type==="string":!1:!1}function yf(t){return typeof t=="object"&&t!==null&&"_def"in t&&typeof t._def=="object"&&t._def!==null&&"typeName"in t._def&&t._def.typeName==="ZodObject"}function hn(t){return it(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="object":!1}function eu(t){return it(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="array":!1}function jr(t){return!!(yf(t)||hn(t))}function _a(t){if(dt(t))return t.shape;if(it(t))return t._zod.def.shape;throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function A0(t,e){if(dt(t))return t.extend(e);if(it(t))return D1(t,e);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function _f(t){if(dt(t))return t.partial();if(it(t))return M1(mf,t);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function oc(t,e=!1){if(dt(t))return t.strict();if(hn(t)){const r=t._zod.def.shape;if(e)for(const[i,a]of Object.entries(t._zod.def.shape)){if(hn(a)){const c=oc(a,e);r[i]=c}else if(eu(a)){let c=a._zod.def.element;hn(c)&&(c=oc(c,e)),r[i]=pn(a,{...a._zod.def,element:c})}else r[i]=a;const o=bt.get(a);o&&bt.add(r[i],o)}const n=pn(t,{...t._zod.def,shape:r,catchall:pk(Y1)}),s=bt.get(t);return s&&bt.add(n,s),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function jd(t,e=!1){if(yf(t))return t.passthrough();if(hn(t)){const r=t._zod.def.shape;if(e)for(const[i,a]of Object.entries(t._zod.def.shape)){if(hn(a)){const c=jd(a,e);r[i]=c}else if(eu(a)){let c=a._zod.def.element;hn(c)&&(c=jd(c,e)),r[i]=pn(a,{...a._zod.def,element:c})}else r[i]=a;const o=bt.get(a);o&&bt.add(r[i],o)}const n=pn(t,{...t._zod.def,shape:r,catchall:fk(X1)}),s=bt.get(t);return s&&bt.add(n,s),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function C0(t){if(dt(t))try{const e=t.parse(void 0);return()=>e}catch{return}if(it(t))try{const e=pf(t,void 0);return()=>e}catch{return}}function xk(t){return dt(t)&&"typeName"in t._def&&t._def.typeName==="ZodEffects"}function Tk(t){return it(t)&&t._zod.def.type==="pipe"}function ri(t,e=!1){if(dt(t))return xk(t)?ri(t._def.schema,e):t;if(it(t)){let r=t;if(Tk(t)&&(r=ri(t._zod.def.in,e)),e){if(hn(r)){const s=r._zod.def.shape;for(const[i,a]of Object.entries(r._zod.def.shape))s[i]=ri(a,e);r=pn(r,{...r._zod.def,shape:s})}else if(eu(r)){const s=ri(r._zod.def.element,e);r=pn(r,{...r._zod.def,element:s})}}const n=bt.get(t);return n&&bt.add(r,n),r}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Ak(t,e){if(dt(t)){const r=_a(t),n={};for(const[s,i]of Object.entries(r))e(s,i)?n[s]=i.optional():n[s]=i;return t.extend(n)}if(it(t)){const r=_a(t),n={...t._zod.def.shape};for(const[a,o]of Object.entries(r))e(a,o)&&(n[a]=new mf({type:"optional",innerType:o}));const s=pn(t,{...t._zod.def,shape:n}),i=bt.get(t);return i&&bt.add(s,i),s}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}const Ck=Symbol("Let zodToJsonSchema decide on which parser to use"),kk={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},Ik=t=>({...kk,...t}),Rk=t=>{const e=Ik(t),r=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,flags:{hasReferencedOpenAiAnyType:!1},currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([n,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}},k0=(t,e)=>{let r=0;for(;r<t.length&&r<e.length&&t[r]===e[r];r++);return[(t.length-r).toString(),...e.slice(r)].join("/")};function mr(t){if(t.target!=="openAi")return{};const e=[...t.basePath,t.definitionPath,t.openAiAnyTypeName];return t.flags.hasReferencedOpenAiAnyType=!0,{$ref:t.$refStrategy==="relative"?k0(e,t.currentPath):e.join("/")}}function I0(t,e,r,n){n!=null&&n.errorMessages&&r&&(t.errorMessage={...t.errorMessage,[e]:r})}function Ve(t,e,r,n,s){t[e]=r,I0(t,e,n,s)}var Ue;(function(t){t.assertEqual=s=>{};function e(s){}t.assertIs=e;function r(s){throw new Error}t.assertNever=r,t.arrayToEnum=s=>{const i={};for(const a of s)i[a]=a;return i},t.getValidEnumValues=s=>{const i=t.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),a={};for(const o of i)a[o]=s[o];return t.objectValues(a)},t.objectValues=s=>t.objectKeys(s).map(function(i){return s[i]}),t.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const i=[];for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&i.push(a);return i},t.find=(s,i)=>{for(const a of s)if(i(a))return a},t.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function n(s,i=" | "){return s.map(a=>typeof a=="string"?`'${a}'`:a).join(i)}t.joinValues=n,t.jsonStringifyReplacer=(s,i)=>typeof i=="bigint"?i.toString():i})(Ue||(Ue={}));var xg;(function(t){t.mergeShapes=(e,r)=>({...e,...r})})(xg||(xg={}));const oe=Ue.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Hn=t=>{switch(typeof t){case"undefined":return oe.undefined;case"string":return oe.string;case"number":return Number.isNaN(t)?oe.nan:oe.number;case"boolean":return oe.boolean;case"function":return oe.function;case"bigint":return oe.bigint;case"symbol":return oe.symbol;case"object":return Array.isArray(t)?oe.array:t===null?oe.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?oe.promise:typeof Map<"u"&&t instanceof Map?oe.map:typeof Set<"u"&&t instanceof Set?oe.set:typeof Date<"u"&&t instanceof Date?oe.date:oe.object;default:return oe.unknown}},j=Ue.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class $n extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const r=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,r):this.__proto__=r,this.name="ZodError",this.issues=e}format(e){const r=e||function(i){return i.message},n={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union")a.unionErrors.map(s);else if(a.code==="invalid_return_type")s(a.returnTypeError);else if(a.code==="invalid_arguments")s(a.argumentsError);else if(a.path.length===0)n._errors.push(r(a));else{let o=n,c=0;for(;c<a.path.length;){const u=a.path[c];c===a.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(r(a))):o[u]=o[u]||{_errors:[]},o=o[u],c++}}};return s(this),n}static assert(e){if(!(e instanceof $n))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Ue.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=r=>r.message){const r={},n=[];for(const s of this.issues)if(s.path.length>0){const i=s.path[0];r[i]=r[i]||[],r[i].push(e(s))}else n.push(e(s));return{formErrors:n,fieldErrors:r}}get formErrors(){return this.flatten()}}$n.create=t=>new $n(t);const zd=(t,e)=>{let r;switch(t.code){case j.invalid_type:t.received===oe.undefined?r="Required":r=`Expected ${t.expected}, received ${t.received}`;break;case j.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(t.expected,Ue.jsonStringifyReplacer)}`;break;case j.unrecognized_keys:r=`Unrecognized key(s) in object: ${Ue.joinValues(t.keys,", ")}`;break;case j.invalid_union:r="Invalid input";break;case j.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${Ue.joinValues(t.options)}`;break;case j.invalid_enum_value:r=`Invalid enum value. Expected ${Ue.joinValues(t.options)}, received '${t.received}'`;break;case j.invalid_arguments:r="Invalid function arguments";break;case j.invalid_return_type:r="Invalid function return type";break;case j.invalid_date:r="Invalid date";break;case j.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(r=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(r=`${r} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?r=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?r=`Invalid input: must end with "${t.validation.endsWith}"`:Ue.assertNever(t.validation):t.validation!=="regex"?r=`Invalid ${t.validation}`:r="Invalid";break;case j.too_small:t.type==="array"?r=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?r=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?r=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="bigint"?r=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?r=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:r="Invalid input";break;case j.too_big:t.type==="array"?r=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?r=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?r=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?r=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?r=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:r="Invalid input";break;case j.custom:r="Invalid input";break;case j.invalid_intersection_types:r="Intersection results could not be merged";break;case j.not_multiple_of:r=`Number must be a multiple of ${t.multipleOf}`;break;case j.not_finite:r="Number must be finite";break;default:r=e.defaultError,Ue.assertNever(t)}return{message:r}};let Ok=zd;function Nk(){return Ok}const $k=t=>{const{data:e,path:r,errorMaps:n,issueData:s}=t,i=[...r,...s.path||[]],a={...s,path:i};if(s.message!==void 0)return{...s,path:i,message:s.message};let o="";const c=n.filter(u=>!!u).slice().reverse();for(const u of c)o=u(a,{data:e,defaultError:o}).message;return{...s,path:i,message:o}};function X(t,e){const r=Nk(),n=$k({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,r,r===zd?void 0:zd].filter(s=>!!s)});t.common.issues.push(n)}class gr{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,r){const n=[];for(const s of r){if(s.status==="aborted")return Se;s.status==="dirty"&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,r){const n=[];for(const s of r){const i=await s.key,a=await s.value;n.push({key:i,value:a})}return gr.mergeObjectSync(e,n)}static mergeObjectSync(e,r){const n={};for(const s of r){const{key:i,value:a}=s;if(i.status==="aborted"||a.status==="aborted")return Se;i.status==="dirty"&&e.dirty(),a.status==="dirty"&&e.dirty(),i.value!=="__proto__"&&(typeof a.value<"u"||s.alwaysSet)&&(n[i.value]=a.value)}return{status:e.value,value:n}}}const Se=Object.freeze({status:"aborted"}),Hi=t=>({status:"dirty",value:t}),Pr=t=>({status:"valid",value:t}),Tg=t=>t.status==="aborted",Ag=t=>t.status==="dirty",gi=t=>t.status==="valid",cc=t=>typeof Promise<"u"&&t instanceof Promise;var ue;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(ue||(ue={}));class is{constructor(e,r,n,s){this._cachedPath=[],this.parent=e,this.data=r,this._path=n,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Cg=(t,e)=>{if(gi(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const r=new $n(t.common.issues);return this._error=r,this._error}}};function Re(t){if(!t)return{};const{errorMap:e,invalid_type_error:r,required_error:n,description:s}=t;if(e&&(r||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(a,o)=>{const{message:c}=t;return a.code==="invalid_enum_value"?{message:c??o.defaultError}:typeof o.data>"u"?{message:c??n??o.defaultError}:a.code!=="invalid_type"?{message:o.defaultError}:{message:c??r??o.defaultError}},description:s}}let De=class{get description(){return this._def.description}_getType(e){return Hn(e.data)}_getOrReturnCtx(e,r){return r||{common:e.parent.common,data:e.data,parsedType:Hn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new gr,ctx:{common:e.parent.common,data:e.data,parsedType:Hn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const r=this._parse(e);if(cc(r))throw new Error("Synchronous parse encountered promise.");return r}_parseAsync(e){const r=this._parse(e);return Promise.resolve(r)}parse(e,r){const n=this.safeParse(e,r);if(n.success)return n.data;throw n.error}safeParse(e,r){const n={common:{issues:[],async:(r==null?void 0:r.async)??!1,contextualErrorMap:r==null?void 0:r.errorMap},path:(r==null?void 0:r.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Hn(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Cg(n,s)}"~validate"(e){var n,s;const r={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Hn(e)};if(!this["~standard"].async)try{const i=this._parseSync({data:e,path:[],parent:r});return gi(i)?{value:i.value}:{issues:r.common.issues}}catch(i){(s=(n=i==null?void 0:i.message)==null?void 0:n.toLowerCase())!=null&&s.includes("encountered")&&(this["~standard"].async=!0),r.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:r}).then(i=>gi(i)?{value:i.value}:{issues:r.common.issues})}async parseAsync(e,r){const n=await this.safeParseAsync(e,r);if(n.success)return n.data;throw n.error}async safeParseAsync(e,r){const n={common:{issues:[],contextualErrorMap:r==null?void 0:r.errorMap,async:!0},path:(r==null?void 0:r.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Hn(e)},s=this._parse({data:e,path:n.path,parent:n}),i=await(cc(s)?s:Promise.resolve(s));return Cg(n,i)}refine(e,r){const n=s=>typeof r=="string"||typeof r>"u"?{message:r}:typeof r=="function"?r(s):r;return this._refinement((s,i)=>{const a=e(s),o=()=>i.addIssue({code:j.custom,...n(s)});return typeof Promise<"u"&&a instanceof Promise?a.then(c=>c?!0:(o(),!1)):a?!0:(o(),!1)})}refinement(e,r){return this._refinement((n,s)=>e(n)?!0:(s.addIssue(typeof r=="function"?r(n,s):r),!1))}_refinement(e){return new wi({schema:this,typeName:V.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:r=>this["~validate"](r)}}optional(){return Yn.create(this,this._def)}nullable(){return vi.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return yi.create(this)}promise(){return fc.create(this,this._def)}or(e){return dc.create([this,e],this._def)}and(e){return hc.create(this,e,this._def)}transform(e){return new wi({...Re(this._def),schema:this,typeName:V.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const r=typeof e=="function"?e:()=>e;return new Hd({...Re(this._def),innerType:this,defaultValue:r,typeName:V.ZodDefault})}brand(){return new rI({typeName:V.ZodBranded,type:this,...Re(this._def)})}catch(e){const r=typeof e=="function"?e:()=>e;return new qd({...Re(this._def),innerType:this,catchValue:r,typeName:V.ZodCatch})}describe(e){const r=this.constructor;return new r({...this._def,description:e})}pipe(e){return wf.create(this,e)}readonly(){return Wd.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}};const Pk=/^c[^\s-]{8,}$/i,Lk=/^[0-9a-z]+$/,Dk=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Mk=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Uk=/^[a-z0-9_-]{21}$/i,Bk=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Fk=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,jk=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,zk="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Bl;const Vk=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Gk=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Hk=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,qk=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Wk=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Jk=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,R0="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Zk=new RegExp(`^${R0}$`);function O0(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);const r=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${r}`}function Kk(t){return new RegExp(`^${O0(t)}$`)}function Xk(t){let e=`${R0}T${O0(t)}`;const r=[];return r.push(t.local?"Z?":"Z"),t.offset&&r.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${r.join("|")})`,new RegExp(`^${e}$`)}function Yk(t,e){return!!((e==="v4"||!e)&&Vk.test(t)||(e==="v6"||!e)&&Hk.test(t))}function Qk(t,e){if(!Bk.test(t))return!1;try{const[r]=t.split(".");if(!r)return!1;const n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),s=JSON.parse(atob(n));return!(typeof s!="object"||s===null||"typ"in s&&(s==null?void 0:s.typ)!=="JWT"||!s.alg||e&&s.alg!==e)}catch{return!1}}function eI(t,e){return!!((e==="v4"||!e)&&Gk.test(t)||(e==="v6"||!e)&&qk.test(t))}class Zn extends De{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==oe.string){const i=this._getOrReturnCtx(e);return X(i,{code:j.invalid_type,expected:oe.string,received:i.parsedType}),Se}const n=new gr;let s;for(const i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(s=this._getOrReturnCtx(e,s),X(s,{code:j.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="max")e.data.length>i.value&&(s=this._getOrReturnCtx(e,s),X(s,{code:j.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="length"){const a=e.data.length>i.value,o=e.data.length<i.value;(a||o)&&(s=this._getOrReturnCtx(e,s),a?X(s,{code:j.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&X(s,{code:j.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),n.dirty())}else if(i.kind==="email")jk.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"email",code:j.invalid_string,message:i.message}),n.dirty());else if(i.kind==="emoji")Bl||(Bl=new RegExp(zk,"u")),Bl.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"emoji",code:j.invalid_string,message:i.message}),n.dirty());else if(i.kind==="uuid")Mk.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"uuid",code:j.invalid_string,message:i.message}),n.dirty());else if(i.kind==="nanoid")Uk.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"nanoid",code:j.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid")Pk.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"cuid",code:j.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid2")Lk.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"cuid2",code:j.invalid_string,message:i.message}),n.dirty());else if(i.kind==="ulid")Dk.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"ulid",code:j.invalid_string,message:i.message}),n.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),X(s,{validation:"url",code:j.invalid_string,message:i.message}),n.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"regex",code:j.invalid_string,message:i.message}),n.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(s=this._getOrReturnCtx(e,s),X(s,{code:j.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),n.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(s=this._getOrReturnCtx(e,s),X(s,{code:j.invalid_string,validation:{startsWith:i.value},message:i.message}),n.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(s=this._getOrReturnCtx(e,s),X(s,{code:j.invalid_string,validation:{endsWith:i.value},message:i.message}),n.dirty()):i.kind==="datetime"?Xk(i).test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{code:j.invalid_string,validation:"datetime",message:i.message}),n.dirty()):i.kind==="date"?Zk.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{code:j.invalid_string,validation:"date",message:i.message}),n.dirty()):i.kind==="time"?Kk(i).test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{code:j.invalid_string,validation:"time",message:i.message}),n.dirty()):i.kind==="duration"?Fk.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"duration",code:j.invalid_string,message:i.message}),n.dirty()):i.kind==="ip"?Yk(e.data,i.version)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"ip",code:j.invalid_string,message:i.message}),n.dirty()):i.kind==="jwt"?Qk(e.data,i.alg)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"jwt",code:j.invalid_string,message:i.message}),n.dirty()):i.kind==="cidr"?eI(e.data,i.version)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"cidr",code:j.invalid_string,message:i.message}),n.dirty()):i.kind==="base64"?Wk.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"base64",code:j.invalid_string,message:i.message}),n.dirty()):i.kind==="base64url"?Jk.test(e.data)||(s=this._getOrReturnCtx(e,s),X(s,{validation:"base64url",code:j.invalid_string,message:i.message}),n.dirty()):Ue.assertNever(i);return{status:n.value,value:e.data}}_regex(e,r,n){return this.refinement(s=>e.test(s),{validation:r,code:j.invalid_string,...ue.errToObj(n)})}_addCheck(e){return new Zn({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...ue.errToObj(e)})}url(e){return this._addCheck({kind:"url",...ue.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...ue.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...ue.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...ue.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...ue.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...ue.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...ue.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...ue.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...ue.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...ue.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...ue.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...ue.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...ue.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...ue.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...ue.errToObj(e)})}regex(e,r){return this._addCheck({kind:"regex",regex:e,...ue.errToObj(r)})}includes(e,r){return this._addCheck({kind:"includes",value:e,position:r==null?void 0:r.position,...ue.errToObj(r==null?void 0:r.message)})}startsWith(e,r){return this._addCheck({kind:"startsWith",value:e,...ue.errToObj(r)})}endsWith(e,r){return this._addCheck({kind:"endsWith",value:e,...ue.errToObj(r)})}min(e,r){return this._addCheck({kind:"min",value:e,...ue.errToObj(r)})}max(e,r){return this._addCheck({kind:"max",value:e,...ue.errToObj(r)})}length(e,r){return this._addCheck({kind:"length",value:e,...ue.errToObj(r)})}nonempty(e){return this.min(1,ue.errToObj(e))}trim(){return new Zn({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Zn({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Zn({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxLength(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}}Zn.create=t=>new Zn({checks:[],typeName:V.ZodString,coerce:(t==null?void 0:t.coerce)??!1,...Re(t)});function tI(t,e){const r=(t.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,s=r>n?r:n,i=Number.parseInt(t.toFixed(s).replace(".","")),a=Number.parseInt(e.toFixed(s).replace(".",""));return i%a/10**s}class wa extends De{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==oe.number){const i=this._getOrReturnCtx(e);return X(i,{code:j.invalid_type,expected:oe.number,received:i.parsedType}),Se}let n;const s=new gr;for(const i of this._def.checks)i.kind==="int"?Ue.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),X(n,{code:j.invalid_type,expected:"integer",received:"float",message:i.message}),s.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),X(n,{code:j.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),X(n,{code:j.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="multipleOf"?tI(e.data,i.value)!==0&&(n=this._getOrReturnCtx(e,n),X(n,{code:j.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),X(n,{code:j.not_finite,message:i.message}),s.dirty()):Ue.assertNever(i);return{status:s.value,value:e.data}}gte(e,r){return this.setLimit("min",e,!0,ue.toString(r))}gt(e,r){return this.setLimit("min",e,!1,ue.toString(r))}lte(e,r){return this.setLimit("max",e,!0,ue.toString(r))}lt(e,r){return this.setLimit("max",e,!1,ue.toString(r))}setLimit(e,r,n,s){return new wa({...this._def,checks:[...this._def.checks,{kind:e,value:r,inclusive:n,message:ue.toString(s)}]})}_addCheck(e){return new wa({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:ue.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:ue.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:ue.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:ue.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:ue.toString(e)})}multipleOf(e,r){return this._addCheck({kind:"multipleOf",value:e,message:ue.toString(r)})}finite(e){return this._addCheck({kind:"finite",message:ue.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:ue.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:ue.toString(e)})}get minValue(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxValue(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&Ue.isInteger(e.value))}get isFinite(){let e=null,r=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(r===null||n.value>r)&&(r=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(r)&&Number.isFinite(e)}}wa.create=t=>new wa({checks:[],typeName:V.ZodNumber,coerce:(t==null?void 0:t.coerce)||!1,...Re(t)});class va extends De{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==oe.bigint)return this._getInvalidInput(e);let n;const s=new gr;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),X(n,{code:j.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),X(n,{code:j.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),X(n,{code:j.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):Ue.assertNever(i);return{status:s.value,value:e.data}}_getInvalidInput(e){const r=this._getOrReturnCtx(e);return X(r,{code:j.invalid_type,expected:oe.bigint,received:r.parsedType}),Se}gte(e,r){return this.setLimit("min",e,!0,ue.toString(r))}gt(e,r){return this.setLimit("min",e,!1,ue.toString(r))}lte(e,r){return this.setLimit("max",e,!0,ue.toString(r))}lt(e,r){return this.setLimit("max",e,!1,ue.toString(r))}setLimit(e,r,n,s){return new va({...this._def,checks:[...this._def.checks,{kind:e,value:r,inclusive:n,message:ue.toString(s)}]})}_addCheck(e){return new va({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:ue.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:ue.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:ue.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:ue.toString(e)})}multipleOf(e,r){return this._addCheck({kind:"multipleOf",value:e,message:ue.toString(r)})}get minValue(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxValue(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}}va.create=t=>new va({checks:[],typeName:V.ZodBigInt,coerce:(t==null?void 0:t.coerce)??!1,...Re(t)});class Vd extends De{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==oe.boolean){const n=this._getOrReturnCtx(e);return X(n,{code:j.invalid_type,expected:oe.boolean,received:n.parsedType}),Se}return Pr(e.data)}}Vd.create=t=>new Vd({typeName:V.ZodBoolean,coerce:(t==null?void 0:t.coerce)||!1,...Re(t)});class uc extends De{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==oe.date){const i=this._getOrReturnCtx(e);return X(i,{code:j.invalid_type,expected:oe.date,received:i.parsedType}),Se}if(Number.isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return X(i,{code:j.invalid_date}),Se}const n=new gr;let s;for(const i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(s=this._getOrReturnCtx(e,s),X(s,{code:j.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),n.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(s=this._getOrReturnCtx(e,s),X(s,{code:j.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),n.dirty()):Ue.assertNever(i);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new uc({...this._def,checks:[...this._def.checks,e]})}min(e,r){return this._addCheck({kind:"min",value:e.getTime(),message:ue.toString(r)})}max(e,r){return this._addCheck({kind:"max",value:e.getTime(),message:ue.toString(r)})}get minDate(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e!=null?new Date(e):null}}uc.create=t=>new uc({checks:[],coerce:(t==null?void 0:t.coerce)||!1,typeName:V.ZodDate,...Re(t)});class kg extends De{_parse(e){if(this._getType(e)!==oe.symbol){const n=this._getOrReturnCtx(e);return X(n,{code:j.invalid_type,expected:oe.symbol,received:n.parsedType}),Se}return Pr(e.data)}}kg.create=t=>new kg({typeName:V.ZodSymbol,...Re(t)});class Ig extends De{_parse(e){if(this._getType(e)!==oe.undefined){const n=this._getOrReturnCtx(e);return X(n,{code:j.invalid_type,expected:oe.undefined,received:n.parsedType}),Se}return Pr(e.data)}}Ig.create=t=>new Ig({typeName:V.ZodUndefined,...Re(t)});class Rg extends De{_parse(e){if(this._getType(e)!==oe.null){const n=this._getOrReturnCtx(e);return X(n,{code:j.invalid_type,expected:oe.null,received:n.parsedType}),Se}return Pr(e.data)}}Rg.create=t=>new Rg({typeName:V.ZodNull,...Re(t)});let lc=class extends De{constructor(){super(...arguments),this._any=!0}_parse(e){return Pr(e.data)}};lc.create=t=>new lc({typeName:V.ZodAny,...Re(t)});class Og extends De{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Pr(e.data)}}Og.create=t=>new Og({typeName:V.ZodUnknown,...Re(t)});class as extends De{_parse(e){const r=this._getOrReturnCtx(e);return X(r,{code:j.invalid_type,expected:oe.never,received:r.parsedType}),Se}}as.create=t=>new as({typeName:V.ZodNever,...Re(t)});class Ng extends De{_parse(e){if(this._getType(e)!==oe.undefined){const n=this._getOrReturnCtx(e);return X(n,{code:j.invalid_type,expected:oe.void,received:n.parsedType}),Se}return Pr(e.data)}}Ng.create=t=>new Ng({typeName:V.ZodVoid,...Re(t)});let yi=class Lo extends De{_parse(e){const{ctx:r,status:n}=this._processInputParams(e),s=this._def;if(r.parsedType!==oe.array)return X(r,{code:j.invalid_type,expected:oe.array,received:r.parsedType}),Se;if(s.exactLength!==null){const a=r.data.length>s.exactLength.value,o=r.data.length<s.exactLength.value;(a||o)&&(X(r,{code:a?j.too_big:j.too_small,minimum:o?s.exactLength.value:void 0,maximum:a?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(s.minLength!==null&&r.data.length<s.minLength.value&&(X(r,{code:j.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),s.maxLength!==null&&r.data.length>s.maxLength.value&&(X(r,{code:j.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),r.common.async)return Promise.all([...r.data].map((a,o)=>s.type._parseAsync(new is(r,a,r.path,o)))).then(a=>gr.mergeArray(n,a));const i=[...r.data].map((a,o)=>s.type._parseSync(new is(r,a,r.path,o)));return gr.mergeArray(n,i)}get element(){return this._def.type}min(e,r){return new Lo({...this._def,minLength:{value:e,message:ue.toString(r)}})}max(e,r){return new Lo({...this._def,maxLength:{value:e,message:ue.toString(r)}})}length(e,r){return new Lo({...this._def,exactLength:{value:e,message:ue.toString(r)}})}nonempty(e){return this.min(1,e)}};yi.create=(t,e)=>new yi({type:t,minLength:null,maxLength:null,exactLength:null,typeName:V.ZodArray,...Re(e)});function Ks(t){if(t instanceof ot){const e={};for(const r in t.shape){const n=t.shape[r];e[r]=Yn.create(Ks(n))}return new ot({...t._def,shape:()=>e})}else return t instanceof yi?new yi({...t._def,type:Ks(t.element)}):t instanceof Yn?Yn.create(Ks(t.unwrap())):t instanceof vi?vi.create(Ks(t.unwrap())):t instanceof Ns?Ns.create(t.items.map(e=>Ks(e))):t}class ot extends De{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),r=Ue.objectKeys(e);return this._cached={shape:e,keys:r},this._cached}_parse(e){if(this._getType(e)!==oe.object){const u=this._getOrReturnCtx(e);return X(u,{code:j.invalid_type,expected:oe.object,received:u.parsedType}),Se}const{status:n,ctx:s}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof as&&this._def.unknownKeys==="strip"))for(const u in s.data)a.includes(u)||o.push(u);const c=[];for(const u of a){const l=i[u],d=s.data[u];c.push({key:{status:"valid",value:u},value:l._parse(new is(s,d,s.path,u)),alwaysSet:u in s.data})}if(this._def.catchall instanceof as){const u=this._def.unknownKeys;if(u==="passthrough")for(const l of o)c.push({key:{status:"valid",value:l},value:{status:"valid",value:s.data[l]}});else if(u==="strict")o.length>0&&(X(s,{code:j.unrecognized_keys,keys:o}),n.dirty());else if(u!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const u=this._def.catchall;for(const l of o){const d=s.data[l];c.push({key:{status:"valid",value:l},value:u._parse(new is(s,d,s.path,l)),alwaysSet:l in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const u=[];for(const l of c){const d=await l.key,h=await l.value;u.push({key:d,value:h,alwaysSet:l.alwaysSet})}return u}).then(u=>gr.mergeObjectSync(n,u)):gr.mergeObjectSync(n,c)}get shape(){return this._def.shape()}strict(e){return ue.errToObj,new ot({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(r,n)=>{var i,a;const s=((a=(i=this._def).errorMap)==null?void 0:a.call(i,r,n).message)??n.defaultError;return r.code==="unrecognized_keys"?{message:ue.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new ot({...this._def,unknownKeys:"strip"})}passthrough(){return new ot({...this._def,unknownKeys:"passthrough"})}extend(e){return new ot({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new ot({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:V.ZodObject})}setKey(e,r){return this.augment({[e]:r})}catchall(e){return new ot({...this._def,catchall:e})}pick(e){const r={};for(const n of Ue.objectKeys(e))e[n]&&this.shape[n]&&(r[n]=this.shape[n]);return new ot({...this._def,shape:()=>r})}omit(e){const r={};for(const n of Ue.objectKeys(this.shape))e[n]||(r[n]=this.shape[n]);return new ot({...this._def,shape:()=>r})}deepPartial(){return Ks(this)}partial(e){const r={};for(const n of Ue.objectKeys(this.shape)){const s=this.shape[n];e&&!e[n]?r[n]=s:r[n]=s.optional()}return new ot({...this._def,shape:()=>r})}required(e){const r={};for(const n of Ue.objectKeys(this.shape))if(e&&!e[n])r[n]=this.shape[n];else{let i=this.shape[n];for(;i instanceof Yn;)i=i._def.innerType;r[n]=i}return new ot({...this._def,shape:()=>r})}keyof(){return N0(Ue.objectKeys(this.shape))}}ot.create=(t,e)=>new ot({shape:()=>t,unknownKeys:"strip",catchall:as.create(),typeName:V.ZodObject,...Re(e)});ot.strictCreate=(t,e)=>new ot({shape:()=>t,unknownKeys:"strict",catchall:as.create(),typeName:V.ZodObject,...Re(e)});ot.lazycreate=(t,e)=>new ot({shape:t,unknownKeys:"strip",catchall:as.create(),typeName:V.ZodObject,...Re(e)});let dc=class extends De{_parse(e){const{ctx:r}=this._processInputParams(e),n=this._def.options;function s(i){for(const o of i)if(o.result.status==="valid")return o.result;for(const o of i)if(o.result.status==="dirty")return r.common.issues.push(...o.ctx.common.issues),o.result;const a=i.map(o=>new $n(o.ctx.common.issues));return X(r,{code:j.invalid_union,unionErrors:a}),Se}if(r.common.async)return Promise.all(n.map(async i=>{const a={...r,common:{...r.common,issues:[]},parent:null};return{result:await i._parseAsync({data:r.data,path:r.path,parent:a}),ctx:a}})).then(s);{let i;const a=[];for(const c of n){const u={...r,common:{...r.common,issues:[]},parent:null},l=c._parseSync({data:r.data,path:r.path,parent:u});if(l.status==="valid")return l;l.status==="dirty"&&!i&&(i={result:l,ctx:u}),u.common.issues.length&&a.push(u.common.issues)}if(i)return r.common.issues.push(...i.ctx.common.issues),i.result;const o=a.map(c=>new $n(c));return X(r,{code:j.invalid_union,unionErrors:o}),Se}}get options(){return this._def.options}};dc.create=(t,e)=>new dc({options:t,typeName:V.ZodUnion,...Re(e)});function Gd(t,e){const r=Hn(t),n=Hn(e);if(t===e)return{valid:!0,data:t};if(r===oe.object&&n===oe.object){const s=Ue.objectKeys(e),i=Ue.objectKeys(t).filter(o=>s.indexOf(o)!==-1),a={...t,...e};for(const o of i){const c=Gd(t[o],e[o]);if(!c.valid)return{valid:!1};a[o]=c.data}return{valid:!0,data:a}}else if(r===oe.array&&n===oe.array){if(t.length!==e.length)return{valid:!1};const s=[];for(let i=0;i<t.length;i++){const a=t[i],o=e[i],c=Gd(a,o);if(!c.valid)return{valid:!1};s.push(c.data)}return{valid:!0,data:s}}else return r===oe.date&&n===oe.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}let hc=class extends De{_parse(e){const{status:r,ctx:n}=this._processInputParams(e),s=(i,a)=>{if(Tg(i)||Tg(a))return Se;const o=Gd(i.value,a.value);return o.valid?((Ag(i)||Ag(a))&&r.dirty(),{status:r.value,value:o.data}):(X(n,{code:j.invalid_intersection_types}),Se)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([i,a])=>s(i,a)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}};hc.create=(t,e,r)=>new hc({left:t,right:e,typeName:V.ZodIntersection,...Re(r)});class Ns extends De{_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==oe.array)return X(n,{code:j.invalid_type,expected:oe.array,received:n.parsedType}),Se;if(n.data.length<this._def.items.length)return X(n,{code:j.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Se;!this._def.rest&&n.data.length>this._def.items.length&&(X(n,{code:j.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),r.dirty());const i=[...n.data].map((a,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new is(n,a,n.path,o)):null}).filter(a=>!!a);return n.common.async?Promise.all(i).then(a=>gr.mergeArray(r,a)):gr.mergeArray(r,i)}get items(){return this._def.items}rest(e){return new Ns({...this._def,rest:e})}}Ns.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Ns({items:t,typeName:V.ZodTuple,rest:null,...Re(e)})};class $g extends De{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==oe.map)return X(n,{code:j.invalid_type,expected:oe.map,received:n.parsedType}),Se;const s=this._def.keyType,i=this._def.valueType,a=[...n.data.entries()].map(([o,c],u)=>({key:s._parse(new is(n,o,n.path,[u,"key"])),value:i._parse(new is(n,c,n.path,[u,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of a){const u=await c.key,l=await c.value;if(u.status==="aborted"||l.status==="aborted")return Se;(u.status==="dirty"||l.status==="dirty")&&r.dirty(),o.set(u.value,l.value)}return{status:r.value,value:o}})}else{const o=new Map;for(const c of a){const u=c.key,l=c.value;if(u.status==="aborted"||l.status==="aborted")return Se;(u.status==="dirty"||l.status==="dirty")&&r.dirty(),o.set(u.value,l.value)}return{status:r.value,value:o}}}}$g.create=(t,e,r)=>new $g({valueType:e,keyType:t,typeName:V.ZodMap,...Re(r)});class ba extends De{_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==oe.set)return X(n,{code:j.invalid_type,expected:oe.set,received:n.parsedType}),Se;const s=this._def;s.minSize!==null&&n.data.size<s.minSize.value&&(X(n,{code:j.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),r.dirty()),s.maxSize!==null&&n.data.size>s.maxSize.value&&(X(n,{code:j.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),r.dirty());const i=this._def.valueType;function a(c){const u=new Set;for(const l of c){if(l.status==="aborted")return Se;l.status==="dirty"&&r.dirty(),u.add(l.value)}return{status:r.value,value:u}}const o=[...n.data.values()].map((c,u)=>i._parse(new is(n,c,n.path,u)));return n.common.async?Promise.all(o).then(c=>a(c)):a(o)}min(e,r){return new ba({...this._def,minSize:{value:e,message:ue.toString(r)}})}max(e,r){return new ba({...this._def,maxSize:{value:e,message:ue.toString(r)}})}size(e,r){return this.min(e,r).max(e,r)}nonempty(e){return this.min(1,e)}}ba.create=(t,e)=>new ba({valueType:t,minSize:null,maxSize:null,typeName:V.ZodSet,...Re(e)});class Pg extends De{get schema(){return this._def.getter()}_parse(e){const{ctx:r}=this._processInputParams(e);return this._def.getter()._parse({data:r.data,path:r.path,parent:r})}}Pg.create=(t,e)=>new Pg({getter:t,typeName:V.ZodLazy,...Re(e)});class Lg extends De{_parse(e){if(e.data!==this._def.value){const r=this._getOrReturnCtx(e);return X(r,{received:r.data,code:j.invalid_literal,expected:this._def.value}),Se}return{status:"valid",value:e.data}}get value(){return this._def.value}}Lg.create=(t,e)=>new Lg({value:t,typeName:V.ZodLiteral,...Re(e)});function N0(t,e){return new _i({values:t,typeName:V.ZodEnum,...Re(e)})}class _i extends De{_parse(e){if(typeof e.data!="string"){const r=this._getOrReturnCtx(e),n=this._def.values;return X(r,{expected:Ue.joinValues(n),received:r.parsedType,code:j.invalid_type}),Se}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const r=this._getOrReturnCtx(e),n=this._def.values;return X(r,{received:r.data,code:j.invalid_enum_value,options:n}),Se}return Pr(e.data)}get options(){return this._def.values}get enum(){const e={};for(const r of this._def.values)e[r]=r;return e}get Values(){const e={};for(const r of this._def.values)e[r]=r;return e}get Enum(){const e={};for(const r of this._def.values)e[r]=r;return e}extract(e,r=this._def){return _i.create(e,{...this._def,...r})}exclude(e,r=this._def){return _i.create(this.options.filter(n=>!e.includes(n)),{...this._def,...r})}}_i.create=N0;class Dg extends De{_parse(e){const r=Ue.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==oe.string&&n.parsedType!==oe.number){const s=Ue.objectValues(r);return X(n,{expected:Ue.joinValues(s),received:n.parsedType,code:j.invalid_type}),Se}if(this._cache||(this._cache=new Set(Ue.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const s=Ue.objectValues(r);return X(n,{received:n.data,code:j.invalid_enum_value,options:s}),Se}return Pr(e.data)}get enum(){return this._def.values}}Dg.create=(t,e)=>new Dg({values:t,typeName:V.ZodNativeEnum,...Re(e)});class fc extends De{unwrap(){return this._def.type}_parse(e){const{ctx:r}=this._processInputParams(e);if(r.parsedType!==oe.promise&&r.common.async===!1)return X(r,{code:j.invalid_type,expected:oe.promise,received:r.parsedType}),Se;const n=r.parsedType===oe.promise?r.data:Promise.resolve(r.data);return Pr(n.then(s=>this._def.type.parseAsync(s,{path:r.path,errorMap:r.common.contextualErrorMap})))}}fc.create=(t,e)=>new fc({type:t,typeName:V.ZodPromise,...Re(e)});class wi extends De{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===V.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:r,ctx:n}=this._processInputParams(e),s=this._def.effect||null,i={addIssue:a=>{X(n,a),a.fatal?r.abort():r.dirty()},get path(){return n.path}};if(i.addIssue=i.addIssue.bind(i),s.type==="preprocess"){const a=s.transform(n.data,i);if(n.common.async)return Promise.resolve(a).then(async o=>{if(r.value==="aborted")return Se;const c=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return c.status==="aborted"?Se:c.status==="dirty"||r.value==="dirty"?Hi(c.value):c});{if(r.value==="aborted")return Se;const o=this._def.schema._parseSync({data:a,path:n.path,parent:n});return o.status==="aborted"?Se:o.status==="dirty"||r.value==="dirty"?Hi(o.value):o}}if(s.type==="refinement"){const a=o=>{const c=s.refinement(o,i);if(n.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?Se:(o.status==="dirty"&&r.dirty(),a(o.value),{status:r.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?Se:(o.status==="dirty"&&r.dirty(),a(o.value).then(()=>({status:r.value,value:o.value}))))}if(s.type==="transform")if(n.common.async===!1){const a=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!gi(a))return Se;const o=s.transform(a.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:r.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(a=>gi(a)?Promise.resolve(s.transform(a.value,i)).then(o=>({status:r.value,value:o})):Se);Ue.assertNever(s)}}wi.create=(t,e,r)=>new wi({schema:t,typeName:V.ZodEffects,effect:e,...Re(r)});wi.createWithPreprocess=(t,e,r)=>new wi({schema:e,effect:{type:"preprocess",transform:t},typeName:V.ZodEffects,...Re(r)});let Yn=class extends De{_parse(e){return this._getType(e)===oe.undefined?Pr(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Yn.create=(t,e)=>new Yn({innerType:t,typeName:V.ZodOptional,...Re(e)});let vi=class extends De{_parse(e){return this._getType(e)===oe.null?Pr(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};vi.create=(t,e)=>new vi({innerType:t,typeName:V.ZodNullable,...Re(e)});let Hd=class extends De{_parse(e){const{ctx:r}=this._processInputParams(e);let n=r.data;return r.parsedType===oe.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:r.path,parent:r})}removeDefault(){return this._def.innerType}};Hd.create=(t,e)=>new Hd({innerType:t,typeName:V.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...Re(e)});let qd=class extends De{_parse(e){const{ctx:r}=this._processInputParams(e),n={...r,common:{...r.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return cc(s)?s.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new $n(n.common.issues)},input:n.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new $n(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}};qd.create=(t,e)=>new qd({innerType:t,typeName:V.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...Re(e)});class Mg extends De{_parse(e){if(this._getType(e)!==oe.nan){const n=this._getOrReturnCtx(e);return X(n,{code:j.invalid_type,expected:oe.nan,received:n.parsedType}),Se}return{status:"valid",value:e.data}}}Mg.create=t=>new Mg({typeName:V.ZodNaN,...Re(t)});class rI extends De{_parse(e){const{ctx:r}=this._processInputParams(e),n=r.data;return this._def.type._parse({data:n,path:r.path,parent:r})}unwrap(){return this._def.type}}class wf extends De{_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?Se:i.status==="dirty"?(r.dirty(),Hi(i.value)):this._def.out._parseAsync({data:i.value,path:n.path,parent:n})})();{const s=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return s.status==="aborted"?Se:s.status==="dirty"?(r.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:n.path,parent:n})}}static create(e,r){return new wf({in:e,out:r,typeName:V.ZodPipeline})}}let Wd=class extends De{_parse(e){const r=this._def.innerType._parse(e),n=s=>(gi(s)&&(s.value=Object.freeze(s.value)),s);return cc(r)?r.then(s=>n(s)):n(r)}unwrap(){return this._def.innerType}};Wd.create=(t,e)=>new Wd({innerType:t,typeName:V.ZodReadonly,...Re(e)});function nI(t,e={},r){return lc.create()}var V;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(V||(V={}));const Je=Zn.create,$0=Vd.create,Ug=lc.create;as.create;const xs=yi.create,Wt=ot.create;dc.create;hc.create;Ns.create;const Jd=_i.create;fc.create;Yn.create;vi.create;function sI(t,e){var n,s,i;const r={type:"array"};return(n=t.type)!=null&&n._def&&((i=(s=t.type)==null?void 0:s._def)==null?void 0:i.typeName)!==V.ZodAny&&(r.items=je(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&Ve(r,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&Ve(r,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(Ve(r,"minItems",t.exactLength.value,t.exactLength.message,e),Ve(r,"maxItems",t.exactLength.value,t.exactLength.message,e)),r}function iI(t,e){const r={type:"integer",format:"int64"};if(!t.checks)return r;for(const n of t.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?Ve(r,"minimum",n.value,n.message,e):Ve(r,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(r.exclusiveMinimum=!0),Ve(r,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?Ve(r,"maximum",n.value,n.message,e):Ve(r,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(r.exclusiveMaximum=!0),Ve(r,"maximum",n.value,n.message,e));break;case"multipleOf":Ve(r,"multipleOf",n.value,n.message,e);break}return r}function aI(){return{type:"boolean"}}function P0(t,e){return je(t.type._def,e)}const oI=(t,e)=>je(t.innerType._def,e);function L0(t,e,r){const n=r??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map(s=>L0(t,e,s))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return cI(t,e)}}const cI=(t,e)=>{const r={type:"integer",format:"unix-time"};if(e.target==="openApi3")return r;for(const n of t.checks)switch(n.kind){case"min":Ve(r,"minimum",n.value,n.message,e);break;case"max":Ve(r,"maximum",n.value,n.message,e);break}return r};function uI(t,e){return{...je(t.innerType._def,e),default:t.defaultValue()}}function lI(t,e){return e.effectStrategy==="input"?je(t.schema._def,e):mr(e)}function dI(t){return{type:"string",enum:Array.from(t.values)}}const hI=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function fI(t,e){const r=[je(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),je(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return r.forEach(i=>{if(hI(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(n=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;a=c}else n=void 0;s.push(a)}}),s.length?{allOf:s,...n}:void 0}function pI(t,e){const r=typeof t.value;return r!=="bigint"&&r!=="number"&&r!=="boolean"&&r!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:r==="bigint"?"integer":r,enum:[t.value]}:{type:r==="bigint"?"integer":r,const:t.value}}let Fl;const Lr={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Fl===void 0&&(Fl=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Fl),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function D0(t,e){const r={type:"string"};if(t.checks)for(const n of t.checks)switch(n.kind){case"min":Ve(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,e);break;case"max":Ve(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Dr(r,"email",n.message,e);break;case"format:idn-email":Dr(r,"idn-email",n.message,e);break;case"pattern:zod":Ft(r,Lr.email,n.message,e);break}break;case"url":Dr(r,"uri",n.message,e);break;case"uuid":Dr(r,"uuid",n.message,e);break;case"regex":Ft(r,n.regex,n.message,e);break;case"cuid":Ft(r,Lr.cuid,n.message,e);break;case"cuid2":Ft(r,Lr.cuid2,n.message,e);break;case"startsWith":Ft(r,RegExp(`^${jl(n.value,e)}`),n.message,e);break;case"endsWith":Ft(r,RegExp(`${jl(n.value,e)}$`),n.message,e);break;case"datetime":Dr(r,"date-time",n.message,e);break;case"date":Dr(r,"date",n.message,e);break;case"time":Dr(r,"time",n.message,e);break;case"duration":Dr(r,"duration",n.message,e);break;case"length":Ve(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,e),Ve(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,e);break;case"includes":Ft(r,RegExp(jl(n.value,e)),n.message,e);break;case"ip":n.version!=="v6"&&Dr(r,"ipv4",n.message,e),n.version!=="v4"&&Dr(r,"ipv6",n.message,e);break;case"base64url":Ft(r,Lr.base64url,n.message,e);break;case"jwt":Ft(r,Lr.jwt,n.message,e);break;case"cidr":n.version!=="v6"&&Ft(r,Lr.ipv4Cidr,n.message,e),n.version!=="v4"&&Ft(r,Lr.ipv6Cidr,n.message,e);break;case"emoji":Ft(r,Lr.emoji(),n.message,e);break;case"ulid":Ft(r,Lr.ulid,n.message,e);break;case"base64":switch(e.base64Strategy){case"format:binary":Dr(r,"binary",n.message,e);break;case"contentEncoding:base64":Ve(r,"contentEncoding","base64",n.message,e);break;case"pattern:zod":Ft(r,Lr.base64,n.message,e);break}break;case"nanoid":Ft(r,Lr.nanoid,n.message,e);break}return r}function jl(t,e){return e.patternStrategy==="escape"?gI(t):t}const mI=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function gI(t){let e="";for(let r=0;r<t.length;r++)mI.has(t[r])||(e+="\\"),e+=t[r];return e}function Dr(t,e,r,n){var s;t.format||(s=t.anyOf)!=null&&s.some(i=>i.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&n.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...r&&n.errorMessages&&{errorMessage:{format:r}}})):Ve(t,"format",e,r,n)}function Ft(t,e,r,n){var s;t.pattern||(s=t.allOf)!=null&&s.some(i=>i.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&n.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:Bg(e,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):Ve(t,"pattern",Bg(e,n),r,n)}function Bg(t,e){var c;if(!e.applyRegexFlags||!t.flags)return t.source;const r={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},n=r.i?t.source.toLowerCase():t.source;let s="",i=!1,a=!1,o=!1;for(let u=0;u<n.length;u++){if(i){s+=n[u],i=!1;continue}if(r.i){if(a){if(n[u].match(/[a-z]/)){o?(s+=n[u],s+=`${n[u-2]}-${n[u]}`.toUpperCase(),o=!1):n[u+1]==="-"&&((c=n[u+2])!=null&&c.match(/[a-z]/))?(s+=n[u],o=!0):s+=`${n[u]}${n[u].toUpperCase()}`;continue}}else if(n[u].match(/[a-z]/)){s+=`[${n[u]}${n[u].toUpperCase()}]`;continue}}if(r.m){if(n[u]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(n[u]==="$"){s+=`($|(?=[\r
]))`;continue}}if(r.s&&n[u]==="."){s+=a?`${n[u]}\r
`:`[${n[u]}\r
]`;continue}s+=n[u],n[u]==="\\"?i=!0:a&&n[u]==="]"?a=!1:!a&&n[u]==="["&&(a=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s}function M0(t,e){var n,s,i,a,o,c;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((n=t.keyType)==null?void 0:n._def.typeName)===V.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((u,l)=>({...u,[l]:je(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",l]})??mr(e)}),{}),additionalProperties:e.rejectedAdditionalProperties};const r={type:"object",additionalProperties:je(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return r;if(((s=t.keyType)==null?void 0:s._def.typeName)===V.ZodString&&((i=t.keyType._def.checks)!=null&&i.length)){const{type:u,...l}=D0(t.keyType._def,e);return{...r,propertyNames:l}}else{if(((a=t.keyType)==null?void 0:a._def.typeName)===V.ZodEnum)return{...r,propertyNames:{enum:t.keyType._def.values}};if(((o=t.keyType)==null?void 0:o._def.typeName)===V.ZodBranded&&t.keyType._def.type._def.typeName===V.ZodString&&((c=t.keyType._def.type._def.checks)!=null&&c.length)){const{type:u,...l}=P0(t.keyType._def,e);return{...r,propertyNames:l}}}return r}function yI(t,e){if(e.mapStrategy==="record")return M0(t,e);const r=je(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||mr(e),n=je(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||mr(e);return{type:"array",maxItems:125,items:{type:"array",items:[r,n],minItems:2,maxItems:2}}}function _I(t){const e=t.values,n=Object.keys(t.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(n.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:n}}function wI(t){return t.target==="openAi"?void 0:{not:mr({...t,currentPath:[...t.currentPath,"not"]})}}function vI(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const pc={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function bI(t,e){if(e.target==="openApi3")return Fg(t,e);const r=t.options instanceof Map?Array.from(t.options.values()):t.options;if(r.every(n=>n._def.typeName in pc&&(!n._def.checks||!n._def.checks.length))){const n=r.reduce((s,i)=>{const a=pc[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:n.length>1?n:n[0]}}else if(r.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=r.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":return i._def.value===null?[...s,"null"]:s;case"symbol":case"undefined":case"function":default:return s}},[]);if(n.length===r.length){const s=n.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:r.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(r.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:r.reduce((n,s)=>[...n,...s._def.values.filter(i=>!n.includes(i))],[])};return Fg(t,e)}const Fg=(t,e)=>{const r=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((n,s)=>je(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return r.length?{anyOf:r}:void 0};function EI(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"?{type:pc[t.innerType._def.typeName],nullable:!0}:{type:[pc[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=je(t.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const r=je(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}function SI(t,e){const r={type:"number"};if(!t.checks)return r;for(const n of t.checks)switch(n.kind){case"int":r.type="integer",I0(r,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?Ve(r,"minimum",n.value,n.message,e):Ve(r,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(r.exclusiveMinimum=!0),Ve(r,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?Ve(r,"maximum",n.value,n.message,e):Ve(r,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(r.exclusiveMaximum=!0),Ve(r,"maximum",n.value,n.message,e));break;case"multipleOf":Ve(r,"multipleOf",n.value,n.message,e);break}return r}function xI(t,e){const r=e.target==="openAi",n={type:"object",properties:{}},s=[],i=t.shape();for(const o in i){let c=i[o];if(c===void 0||c._def===void 0)continue;let u=AI(c);u&&r&&(c._def.typeName==="ZodOptional"&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),u=!1);const l=je(c._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});l!==void 0&&(n.properties[o]=l,u||s.push(o))}s.length&&(n.required=s);const a=TI(t,e);return a!==void 0&&(n.additionalProperties=a),n}function TI(t,e){if(t.catchall._def.typeName!=="ZodNever")return je(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(t.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function AI(t){try{return t.isOptional()}catch{return!0}}const CI=(t,e)=>{var n;if(e.currentPath.toString()===((n=e.propertyPath)==null?void 0:n.toString()))return je(t.innerType._def,e);const r=je(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return r?{anyOf:[{not:mr(e)},r]}:mr(e)},kI=(t,e)=>{if(e.pipeStrategy==="input")return je(t.in._def,e);if(e.pipeStrategy==="output")return je(t.out._def,e);const r=je(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=je(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",r?"1":"0"]});return{allOf:[r,n].filter(s=>s!==void 0)}};function II(t,e){return je(t.type._def,e)}function RI(t,e){const n={type:"array",uniqueItems:!0,items:je(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&Ve(n,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&Ve(n,"maxItems",t.maxSize.value,t.maxSize.message,e),n}function OI(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((r,n)=>je(r._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[]),additionalItems:je(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((r,n)=>je(r._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[])}}function NI(t){return{not:mr(t)}}function $I(t){return mr(t)}const PI=(t,e)=>je(t.innerType._def,e),LI=(t,e,r)=>{switch(e){case V.ZodString:return D0(t,r);case V.ZodNumber:return SI(t,r);case V.ZodObject:return xI(t,r);case V.ZodBigInt:return iI(t,r);case V.ZodBoolean:return aI();case V.ZodDate:return L0(t,r);case V.ZodUndefined:return NI(r);case V.ZodNull:return vI(r);case V.ZodArray:return sI(t,r);case V.ZodUnion:case V.ZodDiscriminatedUnion:return bI(t,r);case V.ZodIntersection:return fI(t,r);case V.ZodTuple:return OI(t,r);case V.ZodRecord:return M0(t,r);case V.ZodLiteral:return pI(t,r);case V.ZodEnum:return dI(t);case V.ZodNativeEnum:return _I(t);case V.ZodNullable:return EI(t,r);case V.ZodOptional:return CI(t,r);case V.ZodMap:return yI(t,r);case V.ZodSet:return RI(t,r);case V.ZodLazy:return()=>t.getter()._def;case V.ZodPromise:return II(t,r);case V.ZodNaN:case V.ZodNever:return wI(r);case V.ZodEffects:return lI(t,r);case V.ZodAny:return mr(r);case V.ZodUnknown:return $I(r);case V.ZodDefault:return uI(t,r);case V.ZodBranded:return P0(t,r);case V.ZodReadonly:return PI(t,r);case V.ZodCatch:return oI(t,r);case V.ZodPipeline:return kI(t,r);case V.ZodFunction:case V.ZodVoid:case V.ZodSymbol:return;default:return(n=>{})()}};function je(t,e,r=!1){var o;const n=e.seen.get(t);if(e.override){const c=(o=e.override)==null?void 0:o.call(e,t,e,n,r);if(c!==Ck)return c}if(n&&!r){const c=DI(n,e);if(c!==void 0)return c}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const i=LI(t,t.typeName,e),a=typeof i=="function"?je(i(),e):i;if(a&&MI(t,e,a),e.postProcess){const c=e.postProcess(a,t,e);return s.jsonSchema=a,c}return s.jsonSchema=a,a}const DI=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"relative":return{$ref:k0(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((r,n)=>e.currentPath[n]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),mr(e)):e.$refStrategy==="seen"?mr(e):void 0}},MI=(t,e,r)=>(t.description&&(r.description=t.description,e.markdownDescription&&(r.markdownDescription=t.description)),r),UI=(t,e)=>{const r=Rk(e);let n;const s=je(t._def,r,!1)??mr(r);r.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[r.openAiAnyTypeName]||(n[r.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:r.$refStrategy==="relative"?"1":[...r.basePath,r.definitionPath,r.openAiAnyTypeName].join("/")}}));const i=n?{...s,[r.definitionPath]:n}:s;return r.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(r.target==="jsonSchema2019-09"||r.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),r.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function Ts(t,e){const r=typeof t;if(r!==typeof e)return!1;if(Array.isArray(t)){if(!Array.isArray(e))return!1;const n=t.length;if(n!==e.length)return!1;for(let s=0;s<n;s++)if(!Ts(t[s],e[s]))return!1;return!0}if(r==="object"){if(!t||!e)return t===e;const n=Object.keys(t),s=Object.keys(e);if(n.length!==s.length)return!1;for(const a of n)if(!Ts(t[a],e[a]))return!1;return!0}return t===e}function Ur(t){return encodeURI(BI(t))}function BI(t){return t.replace(/~/g,"~0").replace(/\//g,"~1")}const FI={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},jI={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},zI={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let VI=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function Kn(t,e=Object.create(null),r=VI,n=""){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t.$id||t.id;if(i){const a=new URL(i,r.href);a.hash.length>1?e[a.href]=t:(a.hash="",n===""?r=a:Kn(t,e,r))}}else if(t!==!0&&t!==!1)return e;const s=r.href+(n?"#"+n:"");if(e[s]!==void 0)throw new Error(`Duplicate schema URI "${s}".`);if(e[s]=t,t===!0||t===!1)return e;if(t.__absolute_uri__===void 0&&Object.defineProperty(t,"__absolute_uri__",{enumerable:!1,value:s}),t.$ref&&t.__absolute_ref__===void 0){const i=new URL(t.$ref,r.href);i.hash=i.hash,Object.defineProperty(t,"__absolute_ref__",{enumerable:!1,value:i.href})}if(t.$recursiveRef&&t.__absolute_recursive_ref__===void 0){const i=new URL(t.$recursiveRef,r.href);i.hash=i.hash,Object.defineProperty(t,"__absolute_recursive_ref__",{enumerable:!1,value:i.href})}if(t.$anchor){const i=new URL("#"+t.$anchor,r.href);e[i.href]=t}for(let i in t){if(zI[i])continue;const a=`${n}/${Ur(i)}`,o=t[i];if(Array.isArray(o)){if(FI[i]){const c=o.length;for(let u=0;u<c;u++)Kn(o[u],e,r,`${a}/${u}`)}}else if(jI[i])for(let c in o)Kn(o[c],e,r,`${a}/${Ur(c)}`);else Kn(o,e,r,a)}return e}const GI=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,HI=[0,31,28,31,30,31,30,31,31,30,31,30,31],qI=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,WI=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,JI=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,ZI=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,KI=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,XI=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,YI=/^(?:\/(?:[^~/]|~0|~1)*)*$/,QI=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,eR=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,tR=t=>{if(t[0]==='"')return!1;const[e,r,...n]=t.split("@");return!e||!r||n.length!==0||e.length>64||r.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(r)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:r.split(".").every(s=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(s))},rR=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,nR=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,sR=t=>t.length>1&&t.length<80&&(/^P\d+([.,]\d+)?W$/.test(t)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(t)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(t));function Zr(t){return t.test.bind(t)}const jg={date:U0,time:B0.bind(void 0,!1),"date-time":oR,duration:sR,uri:lR,"uri-reference":Zr(JI),"uri-template":Zr(ZI),url:Zr(KI),email:tR,hostname:Zr(WI),ipv4:Zr(rR),ipv6:Zr(nR),regex:hR,uuid:Zr(XI),"json-pointer":Zr(YI),"json-pointer-uri-fragment":Zr(QI),"relative-json-pointer":Zr(eR)};function iR(t){return t%4===0&&(t%100!==0||t%400===0)}function U0(t){const e=t.match(GI);if(!e)return!1;const r=+e[1],n=+e[2],s=+e[3];return n>=1&&n<=12&&s>=1&&s<=(n==2&&iR(r)?29:HI[n])}function B0(t,e){const r=e.match(qI);if(!r)return!1;const n=+r[1],s=+r[2],i=+r[3],a=!!r[5];return(n<=23&&s<=59&&i<=59||n==23&&s==59&&i==60)&&(!t||a)}const aR=/t|\s/i;function oR(t){const e=t.split(aR);return e.length==2&&U0(e[0])&&B0(!0,e[1])}const cR=/\/|:/,uR=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function lR(t){return cR.test(t)&&uR.test(t)}const dR=/[^\\]\\Z/;function hR(t){if(dR.test(t))return!1;try{return new RegExp(t,"u"),!0}catch{return!1}}function fR(t){let e=0,r=t.length,n=0,s;for(;n<r;)e++,s=t.charCodeAt(n++),s>=55296&&s<=56319&&n<r&&(s=t.charCodeAt(n),(s&64512)==56320&&n++);return e}function Ke(t,e,r="2019-09",n=Kn(e),s=!0,i=null,a="#",o="#",c=Object.create(null)){if(e===!0)return{valid:!0,errors:[]};if(e===!1)return{valid:!1,errors:[{instanceLocation:a,keyword:"false",keywordLocation:a,error:"False boolean schema."}]};const u=typeof t;let l;switch(u){case"boolean":case"number":case"string":l=u;break;case"object":t===null?l="null":Array.isArray(t)?l="array":l="object";break;default:throw new Error(`Instances of "${u}" type are not supported.`)}const{$ref:d,$recursiveRef:h,$recursiveAnchor:p,type:m,const:_,enum:v,required:y,not:E,anyOf:b,allOf:I,oneOf:k,if:R,then:P,else:T,format:H,properties:q,patternProperties:se,additionalProperties:ee,unevaluatedProperties:Te,minProperties:M,maxProperties:U,propertyNames:B,dependentRequired:te,dependentSchemas:ae,dependencies:Q,prefixItems:le,items:ve,additionalItems:z,unevaluatedItems:K,contains:ne,minContains:G,maxContains:A,minItems:S,maxItems:L,uniqueItems:N,minimum:be,maximum:Ae,exclusiveMinimum:Be,exclusiveMaximum:We,multipleOf:Ye,minLength:Tt,maxLength:ze,pattern:_t,__absolute_ref__:Bn,__absolute_recursive_ref__:zs}=e,J=[];if(p===!0&&i===null&&(i=e),h==="#"){const ye=i===null?n[zs]:i,de=`${o}/$recursiveRef`,ge=Ke(t,i===null?e:i,r,n,s,ye,a,de,c);ge.valid||J.push({instanceLocation:a,keyword:"$recursiveRef",keywordLocation:de,error:"A subschema had errors."},...ge.errors)}if(d!==void 0){const de=n[Bn||d];if(de===void 0){let W=`Unresolved $ref "${d}".`;throw Bn&&Bn!==d&&(W+=`  Absolute URI "${Bn}".`),W+=`
Known schemas:
- ${Object.keys(n).join(`
- `)}`,new Error(W)}const ge=`${o}/$ref`,Z=Ke(t,de,r,n,s,i,a,ge,c);if(Z.valid||J.push({instanceLocation:a,keyword:"$ref",keywordLocation:ge,error:"A subschema had errors."},...Z.errors),r==="4"||r==="7")return{valid:J.length===0,errors:J}}if(Array.isArray(m)){let ye=m.length,de=!1;for(let ge=0;ge<ye;ge++)if(l===m[ge]||m[ge]==="integer"&&l==="number"&&t%1===0&&t===t){de=!0;break}de||J.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${m.join('", "')}".`})}else m==="integer"?(l!=="number"||t%1||t!==t)&&J.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${m}".`}):m!==void 0&&l!==m&&J.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${m}".`});if(_!==void 0&&(l==="object"||l==="array"?Ts(t,_)||J.push({instanceLocation:a,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(_)}.`}):t!==_&&J.push({instanceLocation:a,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(_)}.`})),v!==void 0&&(l==="object"||l==="array"?v.some(ye=>Ts(t,ye))||J.push({instanceLocation:a,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(v)}.`}):v.some(ye=>t===ye)||J.push({instanceLocation:a,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(v)}.`})),E!==void 0){const ye=`${o}/not`;Ke(t,E,r,n,s,i,a,ye).valid&&J.push({instanceLocation:a,keyword:"not",keywordLocation:ye,error:'Instance matched "not" schema.'})}let yn=[];if(b!==void 0){const ye=`${o}/anyOf`,de=J.length;let ge=!1;for(let Z=0;Z<b.length;Z++){const W=b[Z],we=Object.create(c),he=Ke(t,W,r,n,s,p===!0?i:null,a,`${ye}/${Z}`,we);J.push(...he.errors),ge=ge||he.valid,he.valid&&yn.push(we)}ge?J.length=de:J.splice(de,0,{instanceLocation:a,keyword:"anyOf",keywordLocation:ye,error:"Instance does not match any subschemas."})}if(I!==void 0){const ye=`${o}/allOf`,de=J.length;let ge=!0;for(let Z=0;Z<I.length;Z++){const W=I[Z],we=Object.create(c),he=Ke(t,W,r,n,s,p===!0?i:null,a,`${ye}/${Z}`,we);J.push(...he.errors),ge=ge&&he.valid,he.valid&&yn.push(we)}ge?J.length=de:J.splice(de,0,{instanceLocation:a,keyword:"allOf",keywordLocation:ye,error:"Instance does not match every subschema."})}if(k!==void 0){const ye=`${o}/oneOf`,de=J.length,ge=k.filter((Z,W)=>{const we=Object.create(c),he=Ke(t,Z,r,n,s,p===!0?i:null,a,`${ye}/${W}`,we);return J.push(...he.errors),he.valid&&yn.push(we),he.valid}).length;ge===1?J.length=de:J.splice(de,0,{instanceLocation:a,keyword:"oneOf",keywordLocation:ye,error:`Instance does not match exactly one subschema (${ge} matches).`})}if((l==="object"||l==="array")&&Object.assign(c,...yn),R!==void 0){const ye=`${o}/if`;if(Ke(t,R,r,n,s,i,a,ye,c).valid){if(P!==void 0){const ge=Ke(t,P,r,n,s,i,a,`${o}/then`,c);ge.valid||J.push({instanceLocation:a,keyword:"if",keywordLocation:ye,error:'Instance does not match "then" schema.'},...ge.errors)}}else if(T!==void 0){const ge=Ke(t,T,r,n,s,i,a,`${o}/else`,c);ge.valid||J.push({instanceLocation:a,keyword:"if",keywordLocation:ye,error:'Instance does not match "else" schema.'},...ge.errors)}}if(l==="object"){if(y!==void 0)for(const Z of y)Z in t||J.push({instanceLocation:a,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${Z}".`});const ye=Object.keys(t);if(M!==void 0&&ye.length<M&&J.push({instanceLocation:a,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${M} properties.`}),U!==void 0&&ye.length>U&&J.push({instanceLocation:a,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${U} properties.`}),B!==void 0){const Z=`${o}/propertyNames`;for(const W in t){const we=`${a}/${Ur(W)}`,he=Ke(W,B,r,n,s,i,we,Z);he.valid||J.push({instanceLocation:a,keyword:"propertyNames",keywordLocation:Z,error:`Property name "${W}" does not match schema.`},...he.errors)}}if(te!==void 0){const Z=`${o}/dependantRequired`;for(const W in te)if(W in t){const we=te[W];for(const he of we)he in t||J.push({instanceLocation:a,keyword:"dependentRequired",keywordLocation:Z,error:`Instance has "${W}" but does not have "${he}".`})}}if(ae!==void 0)for(const Z in ae){const W=`${o}/dependentSchemas`;if(Z in t){const we=Ke(t,ae[Z],r,n,s,i,a,`${W}/${Ur(Z)}`,c);we.valid||J.push({instanceLocation:a,keyword:"dependentSchemas",keywordLocation:W,error:`Instance has "${Z}" but does not match dependant schema.`},...we.errors)}}if(Q!==void 0){const Z=`${o}/dependencies`;for(const W in Q)if(W in t){const we=Q[W];if(Array.isArray(we))for(const he of we)he in t||J.push({instanceLocation:a,keyword:"dependencies",keywordLocation:Z,error:`Instance has "${W}" but does not have "${he}".`});else{const he=Ke(t,we,r,n,s,i,a,`${Z}/${Ur(W)}`);he.valid||J.push({instanceLocation:a,keyword:"dependencies",keywordLocation:Z,error:`Instance has "${W}" but does not match dependant schema.`},...he.errors)}}}const de=Object.create(null);let ge=!1;if(q!==void 0){const Z=`${o}/properties`;for(const W in q){if(!(W in t))continue;const we=`${a}/${Ur(W)}`,he=Ke(t[W],q[W],r,n,s,i,we,`${Z}/${Ur(W)}`);if(he.valid)c[W]=de[W]=!0;else if(ge=s,J.push({instanceLocation:a,keyword:"properties",keywordLocation:Z,error:`Property "${W}" does not match schema.`},...he.errors),ge)break}}if(!ge&&se!==void 0){const Z=`${o}/patternProperties`;for(const W in se){const we=new RegExp(W,"u"),he=se[W];for(const Lt in t){if(!we.test(Lt))continue;const x=`${a}/${Ur(Lt)}`,g=Ke(t[Lt],he,r,n,s,i,x,`${Z}/${Ur(W)}`);g.valid?c[Lt]=de[Lt]=!0:(ge=s,J.push({instanceLocation:a,keyword:"patternProperties",keywordLocation:Z,error:`Property "${Lt}" matches pattern "${W}" but does not match associated schema.`},...g.errors))}}}if(!ge&&ee!==void 0){const Z=`${o}/additionalProperties`;for(const W in t){if(de[W])continue;const we=`${a}/${Ur(W)}`,he=Ke(t[W],ee,r,n,s,i,we,Z);he.valid?c[W]=!0:(ge=s,J.push({instanceLocation:a,keyword:"additionalProperties",keywordLocation:Z,error:`Property "${W}" does not match additional properties schema.`},...he.errors))}}else if(!ge&&Te!==void 0){const Z=`${o}/unevaluatedProperties`;for(const W in t)if(!c[W]){const we=`${a}/${Ur(W)}`,he=Ke(t[W],Te,r,n,s,i,we,Z);he.valid?c[W]=!0:J.push({instanceLocation:a,keyword:"unevaluatedProperties",keywordLocation:Z,error:`Property "${W}" does not match unevaluated properties schema.`},...he.errors)}}}else if(l==="array"){L!==void 0&&t.length>L&&J.push({instanceLocation:a,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${t.length} > ${L}).`}),S!==void 0&&t.length<S&&J.push({instanceLocation:a,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${t.length} < ${S}).`});const ye=t.length;let de=0,ge=!1;if(le!==void 0){const Z=`${o}/prefixItems`,W=Math.min(le.length,ye);for(;de<W;de++){const we=Ke(t[de],le[de],r,n,s,i,`${a}/${de}`,`${Z}/${de}`);if(c[de]=!0,!we.valid&&(ge=s,J.push({instanceLocation:a,keyword:"prefixItems",keywordLocation:Z,error:"Items did not match schema."},...we.errors),ge))break}}if(ve!==void 0){const Z=`${o}/items`;if(Array.isArray(ve)){const W=Math.min(ve.length,ye);for(;de<W;de++){const we=Ke(t[de],ve[de],r,n,s,i,`${a}/${de}`,`${Z}/${de}`);if(c[de]=!0,!we.valid&&(ge=s,J.push({instanceLocation:a,keyword:"items",keywordLocation:Z,error:"Items did not match schema."},...we.errors),ge))break}}else for(;de<ye;de++){const W=Ke(t[de],ve,r,n,s,i,`${a}/${de}`,Z);if(c[de]=!0,!W.valid&&(ge=s,J.push({instanceLocation:a,keyword:"items",keywordLocation:Z,error:"Items did not match schema."},...W.errors),ge))break}if(!ge&&z!==void 0){const W=`${o}/additionalItems`;for(;de<ye;de++){const we=Ke(t[de],z,r,n,s,i,`${a}/${de}`,W);c[de]=!0,we.valid||(ge=s,J.push({instanceLocation:a,keyword:"additionalItems",keywordLocation:W,error:"Items did not match additional items schema."},...we.errors))}}}if(ne!==void 0)if(ye===0&&G===void 0)J.push({instanceLocation:a,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(G!==void 0&&ye<G)J.push({instanceLocation:a,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${ye}) than minContains (${G}).`});else{const Z=`${o}/contains`,W=J.length;let we=0;for(let he=0;he<ye;he++){const Lt=Ke(t[he],ne,r,n,s,i,`${a}/${he}`,Z);Lt.valid?(c[he]=!0,we++):J.push(...Lt.errors)}we>=(G||0)&&(J.length=W),G===void 0&&A===void 0&&we===0?J.splice(W,0,{instanceLocation:a,keyword:"contains",keywordLocation:Z,error:"Array does not contain item matching schema."}):G!==void 0&&we<G?J.push({instanceLocation:a,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${G} items matching schema. Only ${we} items were found.`}):A!==void 0&&we>A&&J.push({instanceLocation:a,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${A} items matching schema. ${we} items were found.`})}if(!ge&&K!==void 0){const Z=`${o}/unevaluatedItems`;for(de;de<ye;de++){if(c[de])continue;const W=Ke(t[de],K,r,n,s,i,`${a}/${de}`,Z);c[de]=!0,W.valid||J.push({instanceLocation:a,keyword:"unevaluatedItems",keywordLocation:Z,error:"Items did not match unevaluated items schema."},...W.errors)}}if(N)for(let Z=0;Z<ye;Z++){const W=t[Z],we=typeof W=="object"&&W!==null;for(let he=0;he<ye;he++){if(Z===he)continue;const Lt=t[he];(W===Lt||we&&(typeof Lt=="object"&&Lt!==null)&&Ts(W,Lt))&&(J.push({instanceLocation:a,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${Z} and ${he}.`}),Z=Number.MAX_SAFE_INTEGER,he=Number.MAX_SAFE_INTEGER)}}}else if(l==="number"){if(r==="4"?(be!==void 0&&(Be===!0&&t<=be||t<be)&&J.push({instanceLocation:a,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${t} is less than ${Be?"or equal to ":""} ${be}.`}),Ae!==void 0&&(We===!0&&t>=Ae||t>Ae)&&J.push({instanceLocation:a,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${t} is greater than ${We?"or equal to ":""} ${Ae}.`})):(be!==void 0&&t<be&&J.push({instanceLocation:a,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${t} is less than ${be}.`}),Ae!==void 0&&t>Ae&&J.push({instanceLocation:a,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${t} is greater than ${Ae}.`}),Be!==void 0&&t<=Be&&J.push({instanceLocation:a,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${t} is less than ${Be}.`}),We!==void 0&&t>=We&&J.push({instanceLocation:a,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${t} is greater than or equal to ${We}.`})),Ye!==void 0){const ye=t%Ye;Math.abs(0-ye)>=11920929e-14&&Math.abs(Ye-ye)>=11920929e-14&&J.push({instanceLocation:a,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${t} is not a multiple of ${Ye}.`})}}else if(l==="string"){const ye=Tt===void 0&&ze===void 0?0:fR(t);Tt!==void 0&&ye<Tt&&J.push({instanceLocation:a,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${ye} < ${Tt}).`}),ze!==void 0&&ye>ze&&J.push({instanceLocation:a,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${ye} > ${ze}).`}),_t!==void 0&&!new RegExp(_t,"u").test(t)&&J.push({instanceLocation:a,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),H!==void 0&&jg[H]&&!jg[H](t)&&J.push({instanceLocation:a,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${H}".`})}return{valid:J.length===0,errors:J}}class pR{constructor(e,r="2019-09",n=!0){f(this,"schema");f(this,"draft");f(this,"shortCircuit");f(this,"lookup");this.schema=e,this.draft=r,this.shortCircuit=n,this.lookup=Kn(e)}validate(e){return Ke(e,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(e,r){r&&(e={...e,$id:r}),Kn(e,this.lookup)}}var F0={};me(F0,{Validator:()=>pR,deepCompareStrict:()=>Ts,toJsonSchema:()=>kr,validatesOnlyStrings:()=>ra});function kr(t){if(it(t)){const e=ri(t,!0);if(hn(e)){const r=oc(e,!0);return Sg(r)}else return Sg(t)}return dt(t)?UI(t):t}function ra(t){if(!t||typeof t!="object"||Object.keys(t).length===0||Array.isArray(t))return!1;if("type"in t)return typeof t.type=="string"?t.type==="string":Array.isArray(t.type)?t.type.every(e=>e==="string"):!1;if("enum"in t)return Array.isArray(t.enum)&&t.enum.length>0&&t.enum.every(e=>typeof e=="string");if("const"in t)return typeof t.const=="string";if("allOf"in t&&Array.isArray(t.allOf))return t.allOf.some(e=>ra(e));if("anyOf"in t&&Array.isArray(t.anyOf)||"oneOf"in t&&Array.isArray(t.oneOf)){const e="anyOf"in t?t.anyOf:t.oneOf;return e.length>0&&e.every(r=>ra(r))}if("not"in t)return!1;if("$ref"in t&&typeof t.$ref=="string"){const e=t.$ref,r=Kn(t);return r[e]?ra(r[e]):!1}return!1}function vf(t){return t?t.lc_runnable:!1}var mR=class{constructor(t){f(this,"includeNames");f(this,"includeTypes");f(this,"includeTags");f(this,"excludeNames");f(this,"excludeTypes");f(this,"excludeTags");this.includeNames=t.includeNames,this.includeTypes=t.includeTypes,this.includeTags=t.includeTags,this.excludeNames=t.excludeNames,this.excludeTypes=t.excludeTypes,this.excludeTags=t.excludeTags}includeEvent(t,e){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const n=t.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(t.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e)),this.includeTags!==void 0&&(r=r||n.some(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(t.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}};function zl(t){return t.replace(/[^a-zA-Z-_0-9]/g,"_")}const gR=["*","_","`"];function yR(t){let e="";for(const[r,n]of Object.entries(t))e+=`	classDef ${r} ${n};
`;return e}function _R(t,e,r){const{firstNode:n,lastNode:s,nodeColors:i,withStyles:a=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=r??{};let u=a?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(a){const p="default",m={[p]:"{0}({1})"};n!==void 0&&(m[n]="{0}([{1}]):::first"),s!==void 0&&(m[s]="{0}([{1}]):::last");for(const[_,v]of Object.entries(t)){const y=v.name.split(":").pop()??"";let b=gR.some(k=>y.startsWith(k)&&y.endsWith(k))?`<p>${y}</p>`:y;Object.keys(v.metadata??{}).length&&(b+=`<hr/><small><em>${Object.entries(v.metadata??{}).map(([k,R])=>`${k} = ${R}`).join(`
`)}</em></small>`);const I=(m[_]??m[p]).replace("{0}",zl(_)).replace("{1}",b);u+=`	${I}
`}}const l={};for(const p of e){const m=p.source.split(":"),_=p.target.split(":"),v=m.filter((y,E)=>y===_[E]).join(":");l[v]||(l[v]=[]),l[v].push(p)}const d=new Set;function h(p,m){const _=p.length===1&&p[0].source===p[0].target;if(m&&!_){const v=m.split(":").pop();if(d.has(v))throw new Error(`Found duplicate subgraph '${v}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(v),u+=`	subgraph ${v}
`}for(const v of p){const{source:y,target:E,data:b,conditional:I}=v;let k="";if(b!==void 0){let R=b;const P=R.split(" ");P.length>c&&(R=Array.from({length:Math.ceil(P.length/c)},(T,H)=>P.slice(H*c,(H+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),k=I?` -. &nbsp;${R}&nbsp; .-> `:` -- &nbsp;${R}&nbsp; --> `}else k=I?" -.-> ":" --> ";u+=`	${zl(y)}${k}${zl(E)};
`}for(const v in l)v.startsWith(`${m}:`)&&v!==m&&h(l[v],v);m&&!_&&(u+=`	end
`)}h(l[""]??[],"");for(const p in l)!p.includes(":")&&p!==""&&h(l[p],p);return a&&(u+=yR(i??{})),u}async function wR(t,e){let r=(e==null?void 0:e.backgroundColor)??"white";const n=(e==null?void 0:e.imageType)??"png",s=btoa(t);r!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));const i=`https://mermaid.ink/img/${s}?bgColor=${r}&type=${n}`,a=await fetch(i);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join(`
`));return await a.blob()}var j0={};me(j0,{Graph:()=>Ea});function vR(t,e){if(t!==void 0&&!Xi(t))return t;if(vf(e))try{let r=e.getName();return r=r.startsWith("Runnable")?r.slice(8):r,r}catch{return e.getName()}else return e.name??"UnknownSchema"}function bR(t){return vf(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...kr(t.data.schema),title:t.data.name}}}var Ea=class z0{constructor(e){f(this,"nodes",{});f(this,"edges",[]);this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((r,n)=>{e[r.id]=Xi(r.id)?n:r.id}),{nodes:Object.values(this.nodes).map(r=>({id:e[r.id],...bR(r)})),edges:this.edges.map(r=>{const n={source:e[r.source],target:e[r.target]};return typeof r.data<"u"&&(n.data=r.data),typeof r.conditional<"u"&&(n.conditional=r.conditional),n})}}addNode(e,r,n){if(r!==void 0&&this.nodes[r]!==void 0)throw new Error(`Node with id ${r} already exists`);const s=r??wn(),i={id:s,data:e,name:vR(r,e),metadata:n};return this.nodes[s]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(r=>r.source!==e.id&&r.target!==e.id)}addEdge(e,r,n,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[r.id]===void 0)throw new Error(`Target node ${r.id} not in graph`);const i={source:e.id,target:r.id,data:n,conditional:s};return this.edges.push(i),i}firstNode(){return zg(this)}lastNode(){return Vg(this)}extend(e,r=""){let n=r;Object.values(e.nodes).map(u=>u.id).every(Xi)&&(n="");const i=u=>n?`${n}:${u}`:u;Object.entries(e.nodes).forEach(([u,l])=>{this.nodes[i(u)]={...l,id:i(u)}});const a=e.edges.map(u=>({...u,source:i(u.source),target:i(u.target)}));this.edges=[...this.edges,...a];const o=e.firstNode(),c=e.lastNode();return[o?{id:i(o.id),data:o.data}:void 0,c?{id:i(c.id),data:c.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&zg(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&Vg(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),r=new Map;Object.values(e).forEach(s=>{r.set(s,(r.get(s)||0)+1)});const n=s=>{const i=e[s];return Xi(s)&&r.get(i)===1?i:s};return new z0({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,i])=>[n(s),{...i,id:n(s)}])),edges:this.edges.map(s=>({...s,source:n(s.source),target:n(s.target)}))})}drawMermaid(e){const{withStyles:r,curveStyle:n,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=e??{},a=this.reid(),o=a.firstNode(),c=a.lastNode();return _R(a.nodes,a.edges,{firstNode:o==null?void 0:o.id,lastNode:c==null?void 0:c.id,withStyles:r,curveStyle:n,nodeColors:s,wrapLabelNWords:i})}async drawMermaidPng(e){const r=this.drawMermaid(e);return wR(r,{backgroundColor:e==null?void 0:e.backgroundColor})}};function zg(t,e=[]){const r=new Set(t.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),n=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!r.has(s.id)&&n.push(s);return n.length===1?n[0]:void 0}function Vg(t,e=[]){const r=new Set(t.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),n=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!r.has(s.id)&&n.push(s);return n.length===1?n[0]:void 0}function fo({name:t,serialized:e}){return t!==void 0?t:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const ER=t=>t.name==="event_stream_tracer";var SR=class extends Un{constructor(e){super({_awaitHandler:!0,...e});f(this,"autoClose",!0);f(this,"includeNames");f(this,"includeTypes");f(this,"includeTags");f(this,"excludeNames");f(this,"excludeTypes");f(this,"excludeTags");f(this,"runInfoMap",new Map);f(this,"tappedPromises",new Map);f(this,"transformStream");f(this,"writer");f(this,"receiveStream");f(this,"name","event_stream_tracer");f(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=ir.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const r=e.tags??[];let n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(n=n||r.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(n=n&&r.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),n}async*tapOutputIterable(e,r){const n=await r.next();if(n.done)return;const s=this.runInfoMap.get(e);if(s===void 0){yield n.value;return}function i(o,c){return o==="llm"&&typeof c=="string"?new pi({text:c}):c}let a=this.tappedPromises.get(e);if(a===void 0){let o;a=new Promise(c=>{o=c}),this.tappedPromises.set(e,a);try{const c={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...c,data:{chunk:i(s.runType,n.value)}},s),yield n.value;for await(const u of r)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...c,data:{chunk:i(s.runType,u)}},s),yield u}finally{o==null||o()}}else{yield n.value;for await(const o of r)yield o}}async send(e,r){this._includeRun(r)&&await this.writer.write(e)}async sendEndEvent(e,r){const n=this.tappedPromises.get(e.run_id);n!==void 0?n.then(()=>{this.send(e,r)}):await this.send(e,r)}async onLLMStart(e){var a,o;const r=fo(e),n=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:r,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,s);const i=`on_${n}_start`;await this.send({event:i,data:{input:e.inputs},name:r,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onLLMNewToken(e,r,n){const s=this.runInfoMap.get(e.id);let i,a;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")a="on_chat_model_stream",(n==null?void 0:n.chunk)===void 0?i=new $t({content:r,id:`run-${e.id}`}):i=n.chunk.message;else if(s.runType==="llm")a="on_llm_stream",(n==null?void 0:n.chunk)===void 0?i=new pi({text:r}):i=n.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:a,data:{chunk:i},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){var a,o,c;const r=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let n;if(r===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const s=(a=e.outputs)==null?void 0:a.generations;let i;if(r.runType==="chat_model"){for(const u of s??[]){if(i!==void 0)break;i=(o=u[0])==null?void 0:o.message}n="on_chat_model_end"}else if(r.runType==="llm")i={generations:s==null?void 0:s.map(u=>u.map(l=>({text:l.text,generationInfo:l.generationInfo}))),llmOutput:((c=e.outputs)==null?void 0:c.llmOutput)??{}},n="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${r.runType}`);await this.sendEndEvent({event:n,data:{output:i,input:r.inputs},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}async onChainStart(e){var a,o;const r=fo(e),n=e.run_type??"chain",s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:r,runType:e.run_type};let i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},s.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,s.inputs=e.inputs.input):(i.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${n}_start`,data:i,name:r,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onChainEnd(e){var o;const r=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),r===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const n=`on_${e.run_type}_end`,s=e.inputs??r.inputs??{},a={output:((o=e.outputs)==null?void 0:o.output)??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(a.input=s.input,r.inputs=s.input),await this.sendEndEvent({event:n,data:a,run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata??{}},r)}async onToolStart(e){var s,i;const r=fo(e),n={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:r,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:r,run_id:e.id,tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{}},n)}async onToolEnd(e){var s;const r=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),r===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(r.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const n=((s=e.outputs)==null?void 0:s.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:r.inputs},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}async onRetrieverStart(e){var i,a;const r=fo(e),s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:r,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:r,tags:e.tags??[],run_id:e.id,metadata:((a=e.extra)==null?void 0:a.metadata)??{}},s)}async onRetrieverEnd(e){var n;const r=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),r===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((n=e.outputs)==null?void 0:n.documents)??e.outputs,input:r.inputs},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}async handleCustomEvent(e,r,n){const s=this.runInfoMap.get(n);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:s.tags,metadata:s.metadata,data:r},s)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}},V0=class extends Un{constructor({config:e,onStart:r,onEnd:n,onError:s}){super({_awaitHandler:!0});f(this,"name","RootListenersTracer");f(this,"rootId");f(this,"config");f(this,"argOnStart");f(this,"argOnEnd");f(this,"argOnError");this.config=e,this.argOnStart=r,this.argOnEnd=n,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function xR(t){const e=new TextEncoder,r=new ReadableStream({async start(n){for await(const s of t)n.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));n.enqueue(e.encode(`event: end

`)),n.close()}});return ir.fromReadableStream(r)}function Gg(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.iterator]=="function"&&typeof t.next=="function"}const TR=t=>t!=null&&typeof t=="object"&&"next"in t&&typeof t.next=="function";function Zd(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.asyncIterator]=="function"}function*Hg(t,e){for(;;){const{value:r,done:n}=Et.runWithConfig(Nn(t),e.next.bind(e),!0);if(n)break;yield r}}async function*Kd(t,e){const r=e[Symbol.asyncIterator]();for(;;){const{value:n,done:s}=await Et.runWithConfig(Nn(t),r.next.bind(e),!0);if(s)break;yield n}}function mt(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}var $e=class extends Or{constructor(){super(...arguments);f(this,"lc_runnable",!0);f(this,"name")}getName(e){const r=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${r}${e}`:r}withRetry(e){return new bf({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new os({bound:this,config:e,kwargs:{}})}withFallbacks(e){const r=Array.isArray(e)?e:e.fallbacks;return new Z0({runnable:this,fallbacks:r})}_getOptionsList(e,r=0){if(Array.isArray(e)&&e.length!==r)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${r} inputs`);if(Array.isArray(e))return e.map(Le);if(r>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:r},(s,i)=>Le(i===0?e:n))}return Array.from({length:r},()=>Le(e))}async batch(e,r,n){var c;const s=this._getOptionsList(r??{},e.length),i=((c=s[0])==null?void 0:c.maxConcurrency)??(n==null?void 0:n.maxConcurrency),a=new za({maxConcurrency:i,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>a.call(async()=>{try{return await this.invoke(u,s[l])}catch(d){if(n!=null&&n.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,r){yield this.invoke(e,r)}async stream(e,r){const n=Le(r),s=new Bs({generator:this._streamIterator(e,n),config:n});return await s.setup,ir.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let r;e===void 0?r=Le(e):r=Le({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,delete n.timeout,delete n.signal,[r,n]}async _callWithConfig(e,r,n){const s=Le(n),i=await nr(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),mt(r,"input"),s.runId,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));delete s.runId;let o;try{const c=e.call(this,r,s,a);o=await ns(c,n==null?void 0:n.signal)}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(mt(o,"output"))),o}async _batchWithConfig(e,r,n,s){var u;const i=this._getOptionsList(n??{},r.length),a=await Promise.all(i.map(nr)),o=await Promise.all(a.map(async(l,d)=>{const h=await(l==null?void 0:l.handleChainStart(this.toJSON(),mt(r[d],"input"),i[d].runId,i[d].runType,void 0,void 0,i[d].runName??this.getName()));return delete i[d].runId,h}));let c;try{const l=e.call(this,r,i,o,s);c=await ns(l,(u=i==null?void 0:i[0])==null?void 0:u.signal)}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(mt(c,"output")))),c}_concatOutputChunks(e,r){return ss(e,r)}async*_transformStreamWithConfig(e,r,n){let s,i=!0,a,o=!0;const c=Le(n),u=await nr(c),l=this;async function*d(){for await(const p of e){if(i)if(s===void 0)s=p;else try{s=l._concatOutputChunks(s,p)}catch{s=void 0,i=!1}yield p}}let h;try{const p=await s0(r.bind(this),d(),async()=>u==null?void 0:u.handleChainStart(this.toJSON(),{input:""},c.runId,c.runType,void 0,void 0,c.runName??this.getName()),n==null?void 0:n.signal,c);delete c.runId,h=p.setup;const m=h==null?void 0:h.handlers.find(ER);let _=p.output;m!==void 0&&h!==void 0&&(_=m.tapOutputIterable(h.runId,_));const v=h==null?void 0:h.handlers.find(u0);v!==void 0&&h!==void 0&&(_=v.tapOutputIterable(h.runId,_));for await(const y of _)if(yield y,o)if(a===void 0)a=y;else try{a=this._concatOutputChunks(a,y)}catch{a=void 0,o=!1}}catch(p){throw await(h==null?void 0:h.handleChainError(p,void 0,void 0,void 0,{inputs:mt(s,"input")})),p}await(h==null?void 0:h.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:mt(s,"input")}))}getGraph(e){const r=new Ea,n=r.addNode({name:`${this.getName()}Input`,schema:Ug()}),s=r.addNode(this),i=r.addNode({name:`${this.getName()}Output`,schema:Ug()});return r.addEdge(n,s),r.addEdge(s,i),r}pipe(e){return new Pn({first:this,last:Ot(e)})}pick(e){return this.pipe(new K0(e))}assign(e){return this.pipe(new Ef(new Ni({steps:e})))}async*transform(e,r){let n;for await(const s of e)n===void 0?n=s:n=this._concatOutputChunks(n,s);yield*this._streamIterator(n,Le(r))}async*streamLog(e,r,n){const s=new Ud({...n,autoClose:!1,_schemaFormat:"original"}),i=Le(r);yield*this._streamLog(e,s,i)}async*_streamLog(e,r,n){const{callbacks:s}=n;if(s===void 0)n.callbacks=[r];else if(Array.isArray(s))n.callbacks=s.concat([r]);else{const c=s.copy();c.addHandler(r,!0),n.callbacks=c}const i=this.stream(e,n);async function a(){try{const c=await i;for await(const u of c){const l=new vn({ops:[{op:"add",path:"/streamed_output/-",value:u}]});await r.writer.write(l)}}finally{await r.writer.close()}}const o=a();try{for await(const c of r)yield c}finally{await o}}streamEvents(e,r,n){let s;if(r.version==="v1")s=this._streamEventsV1(e,r,n);else if(r.version==="v2")s=this._streamEventsV2(e,r,n);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return r.encoding==="text/event-stream"?xR(s):ir.fromAsyncGenerator(s)}async*_streamEventsV2(e,r,n){var m;const s=new SR({...n,autoClose:!1}),i=Le(r),a=i.runId??wn();i.runId=a;const o=i.callbacks;if(o===void 0)i.callbacks=[s];else if(Array.isArray(o))i.callbacks=o.concat(s);else{const _=o.copy();_.addHandler(s,!0),i.callbacks=_}const c=new AbortController,u=this;async function l(){let _,v=null;try{r!=null&&r.signal?"any"in AbortSignal?_=AbortSignal.any([c.signal,r.signal]):(_=r.signal,v=()=>{c.abort()},r.signal.addEventListener("abort",v,{once:!0})):_=c.signal;const y=await u.stream(e,{...i,signal:_}),E=s.tapOutputIterable(a,y);for await(const b of E)if(c.signal.aborted)break}finally{await s.finish(),_&&v&&_.removeEventListener("abort",v)}}const d=l();let h=!1,p;try{for await(const _ of s){if(!h){_.data.input=e,h=!0,p=_.run_id,yield _;continue}_.run_id===p&&_.event.endsWith("_end")&&(m=_.data)!=null&&m.input&&delete _.data.input,yield _}}finally{c.abort(),await d}}async*_streamEventsV1(e,r,n){let s,i=!1;const a=Le(r),o=a.tags??[],c=a.metadata??{},u=a.runName??this.getName(),l=new Ud({...n,autoClose:!1,_schemaFormat:"streaming_events"}),d=new mR({...n}),h=this._streamLog(e,l,a);for await(const m of h){if(s?s=s.concat(m):s=lf.fromRunLogPatch(m),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const E={...s.state},b={run_id:E.id,event:`on_${E.type}_start`,name:u,tags:o,metadata:c,data:{input:e}};d.includeEvent(b,E.type)&&(yield b)}const _=m.ops.filter(E=>E.path.startsWith("/logs/")).map(E=>E.path.split("/")[2]),v=[...new Set(_)];for(const E of v){let b,I={};const k=s.state.logs[E];if(k.end_time===void 0?k.streamed_output.length>0?b="stream":b="start":b="end",b==="start")k.inputs!==void 0&&(I.input=k.inputs);else if(b==="end")k.inputs!==void 0&&(I.input=k.inputs),I.output=k.final_output;else if(b==="stream"){const R=k.streamed_output.length;if(R!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${R} instead. Encountered in: "${k.name}"`);I={chunk:k.streamed_output[0]},k.streamed_output=[]}yield{event:`on_${k.type}_${b}`,name:k.name,run_id:k.id,tags:k.tags,metadata:k.metadata,data:I}}const{state:y}=s;if(y.streamed_output.length>0){const E=y.streamed_output.length;if(E!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${E} instead. Encountered in: "${y.name}"`);const b={chunk:y.streamed_output[0]};y.streamed_output=[];const I={event:`on_${y.type}_stream`,run_id:y.id,tags:o,metadata:c,name:u,data:b};d.includeEvent(I,y.type)&&(yield I)}}const p=s==null?void 0:s.state;if(p!==void 0){const m={event:`on_${p.type}_end`,name:u,run_id:p.id,tags:o,metadata:c,data:{output:p.final_output}};d.includeEvent(m,p.type)&&(yield m)}}static isRunnable(e){return vf(e)}withListeners({onStart:e,onEnd:r,onError:n}){return new os({bound:this,config:{},configFactories:[s=>({callbacks:[new V0({config:s,onStart:e,onEnd:r,onError:n})]})]})}asTool(e){return RR(this,e)}},os=class G0 extends $e{constructor(r){super(r);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"lc_serializable",!0);f(this,"bound");f(this,"config");f(this,"kwargs");f(this,"configFactories");this.bound=r.bound,this.kwargs=r.kwargs,this.config=r.config,this.configFactories=r.configFactories}static lc_name(){return"RunnableBinding"}getName(r){return this.bound.getName(r)}async _mergeConfig(...r){const n=Cr(this.config,...r);return Cr(n,...this.configFactories?await Promise.all(this.configFactories.map(async s=>await s(n))):[])}withConfig(r){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...r}})}withRetry(r){return new bf({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:r==null?void 0:r.stopAfterAttempt,...r})}async invoke(r,n){return this.bound.invoke(r,await this._mergeConfig(n,this.kwargs))}async batch(r,n,s){const i=Array.isArray(n)?await Promise.all(n.map(async a=>this._mergeConfig(Le(a),this.kwargs))):await this._mergeConfig(Le(n),this.kwargs);return this.bound.batch(r,i,s)}_concatOutputChunks(r,n){return this.bound._concatOutputChunks(r,n)}async*_streamIterator(r,n){yield*this.bound._streamIterator(r,await this._mergeConfig(Le(n),this.kwargs))}async stream(r,n){return this.bound.stream(r,await this._mergeConfig(Le(n),this.kwargs))}async*transform(r,n){yield*this.bound.transform(r,await this._mergeConfig(Le(n),this.kwargs))}streamEvents(r,n,s){const i=this,a=async function*(){yield*i.bound.streamEvents(r,{...await i._mergeConfig(Le(n),i.kwargs),version:n.version},s)};return ir.fromAsyncGenerator(a())}static isRunnableBinding(r){return r.bound&&$e.isRunnable(r.bound)}withListeners({onStart:r,onEnd:n,onError:s}){return new G0({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[i=>({callbacks:[new V0({config:i,onStart:r,onEnd:n,onError:s})]})]})}},AR=class H0 extends $e{constructor(r){super(r);f(this,"lc_serializable",!0);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"bound");this.bound=r.bound}static lc_name(){return"RunnableEach"}async invoke(r,n){return this._callWithConfig(this._invoke.bind(this),r,n)}async _invoke(r,n,s){return this.bound.batch(r,Fe(n,{callbacks:s==null?void 0:s.getChild()}))}withListeners({onStart:r,onEnd:n,onError:s}){return new H0({bound:this.bound.withListeners({onStart:r,onEnd:n,onError:s})})}},bf=class extends os{constructor(e){super(e);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"maxAttemptNumber",3);f(this,"onFailedAttempt",()=>{});this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}static lc_name(){return"RunnableRetry"}_patchConfigForRetry(e,r,n){const s=e>1?`retry:attempt:${e}`:void 0;return Fe(r,{callbacks:n==null?void 0:n.getChild(s)})}async _invoke(e,r,n){return Qo(s=>super.invoke(e,this._patchConfigForRetry(s,r,n)),{onFailedAttempt:s=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,r){return this._callWithConfig(this._invoke.bind(this),e,r)}async _batch(e,r,n,s){const i={};try{await Qo(async a=>{const o=e.map((h,p)=>p).filter(h=>i[h.toString()]===void 0||i[h.toString()]instanceof Error),c=o.map(h=>e[h]),u=o.map(h=>this._patchConfigForRetry(a,r==null?void 0:r[h],n==null?void 0:n[h])),l=await super.batch(c,u,{...s,returnExceptions:!0});let d;for(let h=0;h<l.length;h+=1){const p=l[h],m=o[h];p instanceof Error&&d===void 0&&(d=p,d.input=c[h]),i[m.toString()]=p}if(d)throw d;return l},{onFailedAttempt:a=>this.onFailedAttempt(a,a.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if((s==null?void 0:s.returnExceptions)!==!0)throw a}return Object.keys(i).sort((a,o)=>parseInt(a,10)-parseInt(o,10)).map(a=>i[parseInt(a,10)])}async batch(e,r,n){return this._batchWithConfig(this._batch.bind(this),e,r,n)}},Pn=class qi extends $e{constructor(r){super(r);f(this,"first");f(this,"middle",[]);f(this,"last");f(this,"omitSequenceTags",!1);f(this,"lc_serializable",!0);f(this,"lc_namespace",["langchain_core","runnables"]);this.first=r.first,this.middle=r.middle??this.middle,this.last=r.last,this.name=r.name,this.omitSequenceTags=r.omitSequenceTags??this.omitSequenceTags}static lc_name(){return"RunnableSequence"}get steps(){return[this.first,...this.middle,this.last]}async invoke(r,n){var u;const s=Le(n),i=await nr(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),mt(r,"input"),s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;let o=r,c;try{const l=[this.first,...this.middle];for(let d=0;d<l.length;d+=1){const p=l[d].invoke(o,Fe(s,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${d+1}`)}));o=await ns(p,n==null?void 0:n.signal)}if((u=n==null?void 0:n.signal)!=null&&u.aborted)throw fa(n.signal);c=await this.last.invoke(o,Fe(s,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(l){throw await(a==null?void 0:a.handleChainError(l)),l}return await(a==null?void 0:a.handleChainEnd(mt(c,"output"))),c}async batch(r,n,s){var u;const i=this._getOptionsList(n??{},r.length),a=await Promise.all(i.map(nr)),o=await Promise.all(a.map(async(l,d)=>{const h=await(l==null?void 0:l.handleChainStart(this.toJSON(),mt(r[d],"input"),i[d].runId,void 0,void 0,void 0,i[d].runName));return delete i[d].runId,h}));let c=r;try{for(let l=0;l<this.steps.length;l+=1){const h=this.steps[l].batch(c,o.map((p,m)=>{const _=p==null?void 0:p.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`);return Fe(i[m],{callbacks:_})}),s);c=await ns(h,(u=i[0])==null?void 0:u.signal)}}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(mt(c,"output")))),c}_concatOutputChunks(r,n){return this.last._concatOutputChunks(r,n)}async*_streamIterator(r,n){var h;const s=await nr(n),{runId:i,...a}=n??{},o=await(s==null?void 0:s.handleChainStart(this.toJSON(),mt(r,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName)),c=[this.first,...this.middle,this.last];let u=!0,l;async function*d(){yield r}try{let p=c[0].transform(d(),Fe(a,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let m=1;m<c.length;m+=1)p=await c[m].transform(p,Fe(a,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:`seq:step:${m+1}`)}));for await(const m of p)if((h=n==null?void 0:n.signal)==null||h.throwIfAborted(),yield m,u)if(l===void 0)l=m;else try{l=this._concatOutputChunks(l,m)}catch{l=void 0,u=!1}}catch(p){throw await(o==null?void 0:o.handleChainError(p)),p}await(o==null?void 0:o.handleChainEnd(mt(l,"output")))}getGraph(r){const n=new Ea;let s=null;return this.steps.forEach((i,a)=>{const o=i.getGraph(r);a!==0&&o.trimFirstNode(),a!==this.steps.length-1&&o.trimLastNode(),n.extend(o);const c=o.firstNode();if(!c)throw new Error(`Runnable ${i} has no first node`);s&&n.addEdge(s,c),s=o.lastNode()}),n}pipe(r){return qi.isRunnableSequence(r)?new qi({first:this.first,middle:this.middle.concat([this.last,r.first,...r.middle]),last:r.last,name:this.name??r.name}):new qi({first:this.first,middle:[...this.middle,this.last],last:Ot(r),name:this.name})}static isRunnableSequence(r){return Array.isArray(r.middle)&&$e.isRunnable(r)}static from([r,...n],s){let i={};return typeof s=="string"?i.name=s:s!==void 0&&(i=s),new qi({...i,first:Ot(r),middle:n.slice(0,-1).map(Ot),last:Ot(n[n.length-1])})}},Ni=class q0 extends $e{constructor(r){super(r);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"lc_serializable",!0);f(this,"steps");this.steps={};for(const[n,s]of Object.entries(r.steps))this.steps[n]=Ot(s)}static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}static from(r){return new q0({steps:r})}async invoke(r,n){const s=Le(n),i=await nr(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),{input:r},s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;const o={};try{const c=Object.entries(this.steps).map(async([u,l])=>{o[u]=await l.invoke(r,Fe(s,{callbacks:a==null?void 0:a.getChild(`map:key:${u}`)}))});await ns(Promise.all(c),n==null?void 0:n.signal)}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(o)),o}async*_transform(r,n,s){const i={...this.steps},a=uf(r,Object.keys(i).length),o=new Map(Object.entries(i).map(([c,u],l)=>{const d=u.transform(a[l],Fe(s,{callbacks:n==null?void 0:n.getChild(`map:key:${c}`)}));return[c,d.next().then(h=>({key:c,gen:d,result:h}))]}));for(;o.size;){const c=Promise.race(o.values()),{key:u,result:l,gen:d}=await ns(c,s==null?void 0:s.signal);o.delete(u),l.done||(yield{[u]:l.value},o.set(u,d.next().then(h=>({key:u,gen:d,result:h}))))}}transform(r,n){return this._transformStreamWithConfig(r,this._transform.bind(this),n)}async stream(r,n){async function*s(){yield r}const i=Le(n),a=new Bs({generator:this.transform(s(),i),config:i});return await a.setup,ir.fromAsyncGenerator(a)}},CR=class W0 extends $e{constructor(r){super(r);f(this,"lc_serializable",!1);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"func");if(!rf(r.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=r.func}async invoke(r,n){const[s]=this._getOptionsList(n??{},1),i=await nr(s),a=this.func(Fe(s,{callbacks:i}),r);return ns(a,s==null?void 0:s.signal)}async*_streamIterator(r,n){var a,o;const[s]=this._getOptionsList(n??{},1),i=await this.invoke(r,n);if(Zd(i)){for await(const c of i)(a=s==null?void 0:s.signal)==null||a.throwIfAborted(),yield c;return}if(TR(i)){for(;;){(o=s==null?void 0:s.signal)==null||o.throwIfAborted();const c=i.next();if(c.done)break;yield c.value}return}yield i}static from(r){return new W0({func:r})}};function kR(t){if(rf(t))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var mn=class J0 extends $e{constructor(r){if(rf(r.func))return CR.from(r.func);super(r);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"func");kR(r.func),this.func=r.func}static lc_name(){return"RunnableLambda"}static from(r){return new J0({func:r})}async _invoke(r,n,s){return new Promise((i,a)=>{const o=Fe(n,{callbacks:s==null?void 0:s.getChild(),recursionLimit:((n==null?void 0:n.recursionLimit)??Ul)-1});Et.runWithConfig(Nn(o),async()=>{var c,u;try{let l=await this.func(r,{...o});if(l&&$e.isRunnable(l)){if((n==null?void 0:n.recursionLimit)===0)throw new Error("Recursion limit reached.");l=await l.invoke(r,{...o,recursionLimit:(o.recursionLimit??Ul)-1})}else if(Zd(l)){let d;for await(const h of Kd(o,l))if((c=n==null?void 0:n.signal)==null||c.throwIfAborted(),d===void 0)d=h;else try{d=this._concatOutputChunks(d,h)}catch{d=h}l=d}else if(Gg(l)){let d;for(const h of Hg(o,l))if((u=n==null?void 0:n.signal)==null||u.throwIfAborted(),d===void 0)d=h;else try{d=this._concatOutputChunks(d,h)}catch{d=h}l=d}i(l)}catch(l){a(l)}})})}async invoke(r,n){return this._callWithConfig(this._invoke.bind(this),r,n)}async*_transform(r,n,s){var c,u;let i;for await(const l of r)if(i===void 0)i=l;else try{i=this._concatOutputChunks(i,l)}catch{i=l}const a=Fe(s,{callbacks:n==null?void 0:n.getChild(),recursionLimit:((s==null?void 0:s.recursionLimit)??Ul)-1}),o=await new Promise((l,d)=>{Et.runWithConfig(Nn(a),async()=>{try{const h=await this.func(i,{...a,config:a});l(h)}catch(h){d(h)}})});if(o&&$e.isRunnable(o)){if((s==null?void 0:s.recursionLimit)===0)throw new Error("Recursion limit reached.");const l=await o.stream(i,a);for await(const d of l)yield d}else if(Zd(o))for await(const l of Kd(a,o))(c=s==null?void 0:s.signal)==null||c.throwIfAborted(),yield l;else if(Gg(o))for(const l of Hg(a,o))(u=s==null?void 0:s.signal)==null||u.throwIfAborted(),yield l;else yield o}transform(r,n){return this._transformStreamWithConfig(r,this._transform.bind(this),n)}async stream(r,n){async function*s(){yield r}const i=Le(n),a=new Bs({generator:this.transform(s(),i),config:i});return await a.setup,ir.fromAsyncGenerator(a)}},IR=class extends Ni{},Z0=class extends $e{constructor(e){super(e);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"lc_serializable",!0);f(this,"runnable");f(this,"fallbacks");this.runnable=e.runnable,this.fallbacks=e.fallbacks}static lc_name(){return"RunnableWithFallbacks"}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,r){const n=Le(r),s=await nr(n),{runId:i,...a}=n,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),mt(e,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName)),c=Fe(a,{callbacks:o==null?void 0:o.getChild()});return await Et.runWithConfig(c,async()=>{var d;let l;for(const h of this.runnables()){(d=n==null?void 0:n.signal)==null||d.throwIfAborted();try{const p=await h.invoke(e,c);return await(o==null?void 0:o.handleChainEnd(mt(p,"output"))),p}catch(p){l===void 0&&(l=p)}}throw l===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(l)),l)})}async*_streamIterator(e,r){var d;const n=Le(r),s=await nr(n),{runId:i,...a}=n,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),mt(e,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName));let c,u;for(const h of this.runnables()){(d=n==null?void 0:n.signal)==null||d.throwIfAborted();const p=Fe(a,{callbacks:o==null?void 0:o.getChild()});try{const m=await h.stream(e,p);u=Kd(p,m);break}catch(m){c===void 0&&(c=m)}}if(u===void 0){const h=c??new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(h)),h}let l;try{for await(const h of u){yield h;try{l=l===void 0?l:this._concatOutputChunks(l,h)}catch{l=void 0}}}catch(h){throw await(o==null?void 0:o.handleChainError(h)),h}await(o==null?void 0:o.handleChainEnd(mt(l,"output")))}async batch(e,r,n){var c;if(n!=null&&n.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(r??{},e.length),i=await Promise.all(s.map(u=>nr(u))),a=await Promise.all(i.map(async(u,l)=>{const d=await(u==null?void 0:u.handleChainStart(this.toJSON(),mt(e[l],"input"),s[l].runId,void 0,void 0,void 0,s[l].runName));return delete s[l].runId,d}));let o;for(const u of this.runnables()){(c=s[0].signal)==null||c.throwIfAborted();try{const l=await u.batch(e,a.map((d,h)=>Fe(s[h],{callbacks:d==null?void 0:d.getChild()})),n);return await Promise.all(a.map((d,h)=>d==null?void 0:d.handleChainEnd(mt(l[h],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(a.map(u=>u==null?void 0:u.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function Ot(t){if(typeof t=="function")return new mn({func:t});if($e.isRunnable(t))return t;if(!Array.isArray(t)&&typeof t=="object"){const e={};for(const[r,n]of Object.entries(t))e[r]=Ot(n);return new Ni({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var Ef=class extends $e{constructor(e){e instanceof Ni&&(e={mapper:e});super(e);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"lc_serializable",!0);f(this,"mapper");this.mapper=e.mapper}static lc_name(){return"RunnableAssign"}async invoke(e,r){const n=await this.mapper.invoke(e,r);return{...e,...n}}async*_transform(e,r,n){const s=this.mapper.getStepsKeys(),[i,a]=uf(e),o=this.mapper.transform(a,Fe(n,{callbacks:r==null?void 0:r.getChild()})),c=o.next();for await(const u of i){if(typeof u!="object"||Array.isArray(u))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof u}`);const l=Object.fromEntries(Object.entries(u).filter(([d])=>!s.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await c).value;for await(const u of o)yield u}transform(e,r){return this._transformStreamWithConfig(e,this._transform.bind(this),r)}async stream(e,r){async function*n(){yield e}const s=Le(r),i=new Bs({generator:this.transform(n(),s),config:s});return await i.setup,ir.fromAsyncGenerator(i)}},K0=class extends $e{constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e});super(e);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"lc_serializable",!0);f(this,"keys");this.keys=e.keys}static lc_name(){return"RunnablePick"}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const r=this.keys.map(n=>[n,e[n]]).filter(n=>n[1]!==void 0);return r.length===0?void 0:Object.fromEntries(r)}}async invoke(e,r){return this._callWithConfig(this._pick.bind(this),e,r)}async*_transform(e){for await(const r of e){const n=await this._pick(r);n!==void 0&&(yield n)}}transform(e,r){return this._transformStreamWithConfig(e,this._transform.bind(this),r)}async stream(e,r){async function*n(){yield e}const s=Le(r),i=new Bs({generator:this.transform(n(),s),config:s});return await i.setup,ir.fromAsyncGenerator(i)}},Xd=class extends os{constructor(e){const r=Pn.from([mn.from(async n=>{let s;if(ea(n))try{s=await Qc(this.schema,n.args)}catch{throw new rc("Received tool input did not match expected schema",JSON.stringify(n.args))}else s=n;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:r,config:e.config??{}});f(this,"name");f(this,"description");f(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function RR(t,e){const r=e.name??t.getName(),n=e.description??mi(e.schema);return gf(e.schema)?new Xd({name:r,description:n,schema:Wt({input:Je()}).transform(s=>s.input),bound:t}):new Xd({name:r,description:n,schema:e.schema,bound:t})}const mc=(t,e)=>{const r=[...new Set(e==null?void 0:e.map(s=>{if(typeof s=="string")return s;const i=new s({});if(!("getType"in i)||typeof i.getType!="function")throw new Error("Invalid type provided.");return i.getType()}))],n=t.getType();return r.some(s=>s===n)};function OR(t,e){return Array.isArray(t)?qg(t,e):mn.from(r=>qg(r,t))}function qg(t,e={}){const{includeNames:r,excludeNames:n,includeTypes:s,excludeTypes:i,includeIds:a,excludeIds:o}=e,c=[];for(const u of t)if(!(n&&u.name&&n.includes(u.name))){{if(i&&mc(u,i))continue;if(o&&u.id&&o.includes(u.id))continue}s||a||r?(r&&u.name&&r.some(l=>l===u.name)||s&&mc(u,s)||a&&u.id&&a.some(l=>l===u.id))&&c.push(u):c.push(u)}return c}function NR(t){return Array.isArray(t)?Wg(t):mn.from(Wg)}function Wg(t){if(!t.length)return[];const e=[];for(const r of t){const n=r,s=e.pop();if(!s)e.push(n);else if(n.getType()==="tool"||n.getType()!==s.getType())e.push(s,n);else{const i=sc(s),a=sc(n),o=i.concat(a);typeof i.content=="string"&&typeof a.content=="string"&&(o.content=`${i.content}
${a.content}`),e.push(LR(o))}}return e}function $R(t,e){if(Array.isArray(t)){const r=t;if(!e)throw new Error("Options parameter is required when providing messages.");return Jg(r,e)}else{const r=t;return mn.from(n=>Jg(n,r)).withConfig({runName:"trim_messages"})}}async function Jg(t,e){const{maxTokens:r,tokenCounter:n,strategy:s="last",allowPartial:i=!1,endOn:a,startOn:o,includeSystem:c=!1,textSplitter:u}=e;if(o&&s==="first")throw new Error("`startOn` should only be specified if `strategy` is 'last'.");if(c&&s==="first")throw new Error("`includeSystem` should only be specified if `strategy` is 'last'.");let l;"getNumTokens"in n?l=async h=>(await Promise.all(h.map(m=>n.getNumTokens(m.content)))).reduce((m,_)=>m+_,0):l=async h=>n(h);let d=Y0;if(u&&("splitText"in u?d=u.splitText:d=async h=>u(h)),s==="first")return X0(t,{maxTokens:r,tokenCounter:l,textSplitter:d,partialStrategy:i?"first":void 0,endOn:a});if(s==="last")return PR(t,{maxTokens:r,tokenCounter:l,textSplitter:d,allowPartial:i,includeSystem:c,startOn:o,endOn:a});throw new Error(`Unrecognized strategy: '${s}'. Must be one of 'first' or 'last'.`)}async function X0(t,e){const{maxTokens:r,tokenCounter:n,textSplitter:s,partialStrategy:i,endOn:a}=e;let o=[...t],c=0;for(let u=0;u<o.length;u+=1){const l=u>0?o.slice(0,-u):o;if(await n(l)<=r){c=o.length-u;break}}if(c<o.length&&i){let u=!1;if(Array.isArray(o[c].content)){const l=o[c];if(typeof l.content=="string")throw new Error("Expected content to be an array.");const d=l.content.length,h=i==="last"?[...l.content].reverse():l.content;for(let p=1;p<=d;p+=1){const m=i==="first"?h.slice(0,p):h.slice(-p),_=Object.fromEntries(Object.entries(l).filter(([E])=>E!=="type"&&!E.startsWith("lc_"))),v=Sf(l.getType(),{..._,content:m}),y=[...o.slice(0,c),v];if(await n(y)<=r)o=y,c+=1,u=!0;else break}u&&i==="last"&&(l.content=[...h].reverse())}if(!u){const l=o[c];let d;if(Array.isArray(l.content)&&l.content.some(h=>typeof h=="string"||h.type==="text")){const h=l.content.find(p=>p.type==="text"&&p.text);d=h==null?void 0:h.text}else typeof l.content=="string"&&(d=l.content);if(d){const h=await s(d),p=h.length;i==="last"&&h.reverse();for(let m=0;m<p-1;m+=1)if(h.pop(),l.content=h.join(""),await n([...o.slice(0,c),l])<=r){i==="last"&&(l.content=[...h].reverse().join("")),o=[...o.slice(0,c),l],c+=1;break}}}}if(a){const u=Array.isArray(a)?a:[a];for(;c>0&&!mc(o[c-1],u);)c-=1}return o.slice(0,c)}async function PR(t,e){var l;const{allowPartial:r=!1,includeSystem:n=!1,endOn:s,startOn:i,...a}=e;let o=t.map(d=>{const h=Object.fromEntries(Object.entries(d).filter(([p])=>p!=="type"&&!p.startsWith("lc_")));return Sf(d.getType(),h,la(d))});if(s){const d=Array.isArray(s)?s:[s];for(;o.length>0&&!mc(o[o.length-1],d);)o=o.slice(0,-1)}const c=n&&((l=o[0])==null?void 0:l.getType())==="system";let u=c?o.slice(0,1).concat(o.slice(1).reverse()):o.reverse();return u=await X0(u,{...a,partialStrategy:r?"last":void 0,endOn:i}),c?[u[0],...u.slice(1).reverse()]:u.reverse()}const Zg={human:{message:pt,messageChunk:Zc},ai:{message:yt,messageChunk:$t},system:{message:lt,messageChunk:hi},developer:{message:lt,messageChunk:hi},tool:{message:On,messageChunk:Bc},function:{message:Wc,messageChunk:Jc},generic:{message:ls,messageChunk:qc},remove:{message:nc,messageChunk:nc}};function Sf(t,e,r){var i;let n,s;switch(t){case"human":r?n=new Zc(e):s=new pt(e);break;case"ai":if(r){let a={...e};"tool_calls"in a&&(a={...a,tool_call_chunks:(i=a.tool_calls)==null?void 0:i.map(o=>({...o,type:"tool_call_chunk",index:void 0,args:JSON.stringify(o.args)}))}),n=new $t(a)}else s=new yt(e);break;case"system":r?n=new hi(e):s=new lt(e);break;case"developer":r?n=new hi({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}}):s=new lt({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}});break;case"tool":if("tool_call_id"in e)r?n=new Bc(e):s=new On(e);else throw new Error("Can not convert ToolMessage to ToolMessageChunk if 'tool_call_id' field is not defined.");break;case"function":if(r)n=new Jc(e);else{if(!e.name)throw new Error("FunctionMessage must have a 'name' field");s=new Wc(e)}break;case"generic":if("role"in e)r?n=new qc(e):s=new ls(e);else throw new Error("Can not convert ChatMessage to ChatMessageChunk if 'role' field is not defined.");break;default:throw new Error(`Unrecognized message type ${t}`)}if(r&&n)return n;if(s)return s;throw new Error(`Unrecognized message type ${t}`)}function LR(t){const e=t.getType();let r;const n=Object.fromEntries(Object.entries(t).filter(([s])=>!["type","tool_call_chunks"].includes(s)&&!s.startsWith("lc_")));if(e in Zg&&(r=Sf(e,n)),!r)throw new Error(`Unrecognized message chunk class ${e}. Supported classes are ${Object.keys(Zg)}`);return r}function Y0(t){const e=t.split(`
`);return Promise.resolve([...e.slice(0,-1).map(r=>`${r}
`),e[e.length-1]])}const DR=["tool_call","tool_call_chunk","invalid_tool_call","server_tool_call","server_tool_call_chunk","server_tool_call_result"],MR=["image","video","audio","text-plain","file"],UR=["text","reasoning",...DR,...MR];var Q0={};me(Q0,{AIMessage:()=>yt,AIMessageChunk:()=>$t,BaseMessage:()=>Ir,BaseMessageChunk:()=>Us,ChatMessage:()=>ls,ChatMessageChunk:()=>qc,FunctionMessage:()=>Wc,FunctionMessageChunk:()=>Jc,HumanMessage:()=>pt,HumanMessageChunk:()=>Zc,KNOWN_BLOCK_TYPES:()=>UR,RemoveMessage:()=>nc,SystemMessage:()=>lt,SystemMessageChunk:()=>hi,ToolMessage:()=>On,ToolMessageChunk:()=>Bc,_isMessageFieldWithRole:()=>lw,_mergeDicts:()=>Ut,_mergeLists:()=>Ua,_mergeObj:()=>uw,_mergeStatus:()=>cw,coerceMessageLikeToMessage:()=>dn,convertToChunk:()=>sc,convertToOpenAIImageBlock:()=>nw,convertToProviderContentBlock:()=>sw,defaultTextSplitter:()=>Y0,defaultToolCallParser:()=>Hh,filterMessages:()=>OR,getBufferString:()=>of,iife:()=>d1,isAIMessage:()=>af,isAIMessageChunk:()=>Rd,isBase64ContentBlock:()=>jh,isBaseMessage:()=>vt,isBaseMessageChunk:()=>la,isChatMessage:()=>r1,isChatMessageChunk:()=>n1,isDataContentBlock:()=>Rn,isDirectToolOutput:()=>Gh,isFunctionMessage:()=>s1,isFunctionMessageChunk:()=>i1,isHumanMessage:()=>a1,isHumanMessageChunk:()=>o1,isIDContentBlock:()=>rw,isMessage:()=>ow,isOpenAIToolCallArray:()=>Qx,isPlainTextContentBlock:()=>Ux,isSystemMessage:()=>c1,isSystemMessageChunk:()=>u1,isToolMessage:()=>qh,isToolMessageChunk:()=>hw,isURLContentBlock:()=>Fh,mapChatMessagesToStoredMessages:()=>g1,mapStoredMessageToChatMessage:()=>cf,mapStoredMessagesToChatMessages:()=>m1,mergeContent:()=>Ms,mergeMessageRuns:()=>NR,mergeResponseMetadata:()=>Hw,mergeUsageMetadata:()=>Ww,parseBase64DataUrl:()=>ca,parseMimeType:()=>Vi,trimMessages:()=>$R});var ev={};me(ev,{BaseChatMessageHistory:()=>tv,BaseListChatMessageHistory:()=>xf,InMemoryChatMessageHistory:()=>BR});var tv=class extends Or{async addMessages(t){for(const e of t)await this.addMessage(e)}},xf=class extends Or{addUserMessage(t){return this.addMessage(new pt(t))}addAIMessage(t){return this.addMessage(new yt(t))}async addMessages(t){for(const e of t)await this.addMessage(e)}clear(){throw new Error("Not implemented.")}},BR=class extends xf{constructor(e){super(...arguments);f(this,"lc_namespace",["langchain","stores","message","in_memory"]);f(this,"messages",[]);this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}},rv={};me(rv,{Embeddings:()=>Tf});var Tf=class{constructor(t){f(this,"caller");this.caller=new za(t??{})}},FR={},nv={};me(nv,{BaseMemory:()=>jR,getInputValue:()=>zR,getOutputValue:()=>VR,getPromptInputKey:()=>GR});var jR=class{};const sv=(t,e)=>{if(e!==void 0)return t[e];const r=Object.keys(t);if(r.length===1)return t[r[0]]},zR=(t,e)=>{const r=sv(t,e);if(!r){const n=Object.keys(t);throw new Error(`input values have ${n.length} keys, you must specify an input key or pass only 1 key as input`)}return r},VR=(t,e)=>{const r=sv(t,e);if(!r&&r!==""){const n=Object.keys(t);throw new Error(`output values have ${n.length} keys, you must specify an output key or pass only 1 key as output`)}return r};function GR(t,e){const r=Object.keys(t).filter(n=>!e.includes(n)&&n!=="stop");if(r.length!==1)throw new Error(`One input key expected, but got ${r.length}`);return r[0]}var iv={};me(iv,{BasePromptValue:()=>tu,ChatPromptValue:()=>Cf,ImagePromptValue:()=>av,StringPromptValue:()=>Af});var tu=class extends Or{},Af=class extends tu{constructor(e){super({value:e});f(this,"lc_namespace",["langchain_core","prompt_values"]);f(this,"lc_serializable",!0);f(this,"value");this.value=e}static lc_name(){return"StringPromptValue"}toString(){return this.value}toChatMessages(){return[new pt(this.value)]}},Cf=class extends tu{constructor(e){Array.isArray(e)&&(e={messages:e});super(e);f(this,"lc_namespace",["langchain_core","prompt_values"]);f(this,"lc_serializable",!0);f(this,"messages");this.messages=e.messages}static lc_name(){return"ChatPromptValue"}toString(){return of(this.messages)}toChatMessages(){return this.messages}},av=class extends tu{constructor(e){"imageUrl"in e||(e={imageUrl:e});super(e);f(this,"lc_namespace",["langchain_core","prompt_values"]);f(this,"lc_serializable",!0);f(this,"imageUrl");f(this,"value");this.imageUrl=e.imageUrl}static lc_name(){return"ImagePromptValue"}toString(){return this.imageUrl.url}toChatMessages(){return[new pt({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}},ov={};me(ov,{BaseStore:()=>cv,InMemoryStore:()=>HR});var cv=class extends Or{},HR=class extends cv{constructor(){super(...arguments);f(this,"lc_namespace",["langchain","storage"]);f(this,"store",{})}async mget(e){return e.map(r=>this.store[r])}async mset(e){for(const[r,n]of e)this.store[r]=n}async mdelete(e){for(const r of e)delete this.store[r]}async*yieldKeys(e){const r=Object.keys(this.store);for(const n of r)(e===void 0||n.startsWith(e))&&(yield n)}},uv={};me(uv,{BaseRetriever:()=>kf});var kf=class extends $e{constructor(e){super(e);f(this,"callbacks");f(this,"tags");f(this,"metadata");f(this,"verbose");this.callbacks=e==null?void 0:e.callbacks,this.tags=(e==null?void 0:e.tags)??[],this.metadata=(e==null?void 0:e.metadata)??{},this.verbose=(e==null?void 0:e.verbose)??!1}_getRelevantDocuments(e,r){throw new Error("Not implemented!")}async invoke(e,r){const n=Le(Fa(r)),s=await Ht.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),i=await(s==null?void 0:s.handleRetrieverStart(this.toJSON(),e,n.runId,void 0,void 0,void 0,n.runName));try{const a=await this._getRelevantDocuments(e,i);return await(i==null?void 0:i.handleRetrieverEnd(a)),a}catch(a){throw await(i==null?void 0:i.handleRetrieverError(a)),a}}},lv={};me(lv,{SaveableVectorStore:()=>qR,VectorStore:()=>If,VectorStoreRetriever:()=>Do});var Do=class extends kf{constructor(e){super(e);f(this,"vectorStore");f(this,"k",4);f(this,"searchType","similarity");f(this,"searchKwargs");f(this,"filter");this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,e.searchType==="mmr"&&(this.searchKwargs=e.searchKwargs)}static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}async _getRelevantDocuments(e,r){if(this.searchType==="mmr"){if(typeof this.vectorStore.maxMarginalRelevanceSearch!="function")throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},r==null?void 0:r.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,r==null?void 0:r.getChild("vectorstore"))}async addDocuments(e,r){return this.vectorStore.addDocuments(e,r)}},If=class extends Or{constructor(e,r){super(r);f(this,"lc_namespace",["langchain","vectorstores",this._vectorstoreType()]);f(this,"embeddings");this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,r=4,n=void 0,s=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),r,n)).map(a=>a[0])}async similaritySearchWithScore(e,r=4,n=void 0,s=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),r,n)}static fromTexts(e,r,n,s){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,r,n){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,r,n,s,i,a){if(typeof e=="number")return new Do({vectorStore:this,k:e,filter:r,tags:[...s??[],this._vectorstoreType()],metadata:i,verbose:a,callbacks:n});{const o={vectorStore:this,k:e==null?void 0:e.k,filter:e==null?void 0:e.filter,tags:[...(e==null?void 0:e.tags)??[],this._vectorstoreType()],metadata:e==null?void 0:e.metadata,verbose:e==null?void 0:e.verbose,callbacks:e==null?void 0:e.callbacks,searchType:e==null?void 0:e.searchType};return(e==null?void 0:e.searchType)==="mmr"?new Do({...o,searchKwargs:e.searchKwargs}):new Do({...o})}}},qR=class extends If{static load(t,e){throw new Error("Not implemented")}},ie="0123456789abcdef".split(""),WR=[-2147483648,8388608,32768,128],Mr=[24,16,8,0],po=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],wt=[];function Hr(t,e){e?(wt[0]=wt[16]=wt[1]=wt[2]=wt[3]=wt[4]=wt[5]=wt[6]=wt[7]=wt[8]=wt[9]=wt[10]=wt[11]=wt[12]=wt[13]=wt[14]=wt[15]=0,this.blocks=wt):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=t}Hr.prototype.update=function(t){if(!this.finalized){var e,r=typeof t;if(r!=="string"){if(r==="object"){if(t===null)throw new Error(ERROR);if(ARRAY_BUFFER&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!Array.isArray(t)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(t)))throw new Error(ERROR)}else throw new Error(ERROR);e=!0}for(var n,s=0,i,a=t.length,o=this.blocks;s<a;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),e)for(i=this.start;s<a&&i<64;++s)o[i>>>2]|=t[s]<<Mr[i++&3];else for(i=this.start;s<a&&i<64;++s)n=t.charCodeAt(s),n<128?o[i>>>2]|=n<<Mr[i++&3]:n<2048?(o[i>>>2]|=(192|n>>>6)<<Mr[i++&3],o[i>>>2]|=(128|n&63)<<Mr[i++&3]):n<55296||n>=57344?(o[i>>>2]|=(224|n>>>12)<<Mr[i++&3],o[i>>>2]|=(128|n>>>6&63)<<Mr[i++&3],o[i>>>2]|=(128|n&63)<<Mr[i++&3]):(n=65536+((n&1023)<<10|t.charCodeAt(++s)&1023),o[i>>>2]|=(240|n>>>18)<<Mr[i++&3],o[i>>>2]|=(128|n>>>12&63)<<Mr[i++&3],o[i>>>2]|=(128|n>>>6&63)<<Mr[i++&3],o[i>>>2]|=(128|n&63)<<Mr[i++&3]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=o[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Hr.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>>2]|=WR[e&3],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}};Hr.prototype.hash=function(){var t=this.h0,e=this.h1,r=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=this.blocks,u,l,d,h,p,m,_,v,y,E,b;for(u=16;u<64;++u)p=c[u-15],l=(p>>>7|p<<25)^(p>>>18|p<<14)^p>>>3,p=c[u-2],d=(p>>>17|p<<15)^(p>>>19|p<<13)^p>>>10,c[u]=c[u-16]+l+c[u-7]+d<<0;for(b=e&r,u=0;u<64;u+=4)this.first?(this.is224?(v=300032,p=c[0]-1413257819,o=p-150054599<<0,n=p+24177077<<0):(v=704751109,p=c[0]-210244248,o=p-1521486534<<0,n=p+143694565<<0),this.first=!1):(l=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),d=(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7),v=t&e,h=v^t&r^b,_=s&i^~s&a,p=o+d+_+po[u]+c[u],m=l+h,o=n+p<<0,n=p+m<<0),l=(n>>>2|n<<30)^(n>>>13|n<<19)^(n>>>22|n<<10),d=(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7),y=n&t,h=y^n&e^v,_=a&o^~a&s,p=i+d+_+po[u+1]+c[u+1],m=l+h,a=r+p<<0,r=p+m<<0,l=(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10),d=(a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7),E=r&n,h=E^r&t^y,_=i&a^~i&o,p=s+d+_+po[u+2]+c[u+2],m=l+h,i=e+p<<0,e=p+m<<0,l=(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10),d=(i>>>6|i<<26)^(i>>>11|i<<21)^(i>>>25|i<<7),b=e&r,h=b^e&n^E,_=i&a^~i&o,p=s+d+_+po[u+3]+c[u+3],m=l+h,s=t+p<<0,t=p+m<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+t<<0,this.h1=this.h1+e<<0,this.h2=this.h2+r<<0,this.h3=this.h3+n<<0,this.h4=this.h4+s<<0,this.h5=this.h5+i<<0,this.h6=this.h6+a<<0,this.h7=this.h7+o<<0};Hr.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,r=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=ie[t>>>28&15]+ie[t>>>24&15]+ie[t>>>20&15]+ie[t>>>16&15]+ie[t>>>12&15]+ie[t>>>8&15]+ie[t>>>4&15]+ie[t&15]+ie[e>>>28&15]+ie[e>>>24&15]+ie[e>>>20&15]+ie[e>>>16&15]+ie[e>>>12&15]+ie[e>>>8&15]+ie[e>>>4&15]+ie[e&15]+ie[r>>>28&15]+ie[r>>>24&15]+ie[r>>>20&15]+ie[r>>>16&15]+ie[r>>>12&15]+ie[r>>>8&15]+ie[r>>>4&15]+ie[r&15]+ie[n>>>28&15]+ie[n>>>24&15]+ie[n>>>20&15]+ie[n>>>16&15]+ie[n>>>12&15]+ie[n>>>8&15]+ie[n>>>4&15]+ie[n&15]+ie[s>>>28&15]+ie[s>>>24&15]+ie[s>>>20&15]+ie[s>>>16&15]+ie[s>>>12&15]+ie[s>>>8&15]+ie[s>>>4&15]+ie[s&15]+ie[i>>>28&15]+ie[i>>>24&15]+ie[i>>>20&15]+ie[i>>>16&15]+ie[i>>>12&15]+ie[i>>>8&15]+ie[i>>>4&15]+ie[i&15]+ie[a>>>28&15]+ie[a>>>24&15]+ie[a>>>20&15]+ie[a>>>16&15]+ie[a>>>12&15]+ie[a>>>8&15]+ie[a>>>4&15]+ie[a&15];return this.is224||(c+=ie[o>>>28&15]+ie[o>>>24&15]+ie[o>>>20&15]+ie[o>>>16&15]+ie[o>>>12&15]+ie[o>>>8&15]+ie[o>>>4&15]+ie[o&15]),c};Hr.prototype.toString=Hr.prototype.hex;Hr.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,r=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=[t>>>24&255,t>>>16&255,t>>>8&255,t&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255,i>>>24&255,i>>>16&255,i>>>8&255,i&255,a>>>24&255,a>>>16&255,a>>>8&255,a&255];return this.is224||c.push(o>>>24&255,o>>>16&255,o>>>8&255,o&255),c};Hr.prototype.array=Hr.prototype.digest;Hr.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(this.is224?28:32),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),e.setUint32(20,this.h5),e.setUint32(24,this.h6),this.is224||e.setUint32(28,this.h7),t};const Rf=(...t)=>new Hr(!1,!0).update(t.join("")).hex();var dv={};me(dv,{sha256:()=>Rf});var hv={};me(hv,{BaseCache:()=>pv,InMemoryCache:()=>mv,defaultHashKeyEncoder:()=>fv,deserializeStoredGeneration:()=>JR,serializeGeneration:()=>ZR});const fv=(...t)=>Rf(t.join("_"));function JR(t){return t.message!==void 0?{text:t.text,message:cf(t.message)}:{text:t.text}}function ZR(t){const e={text:t.text};return t.message!==void 0&&(e.message=t.message.toDict()),e}var pv=class{constructor(){f(this,"keyEncoder",fv)}makeDefaultKeyEncoder(e){this.keyEncoder=e}};const KR=new Map;var mv=class gv extends pv{constructor(r){super();f(this,"cache");this.cache=r??new Map}lookup(r,n){return Promise.resolve(this.cache.get(this.keyEncoder(r,n))??null)}async update(r,n,s){this.cache.set(this.keyEncoder(r,n),s)}static global(){return new gv(KR)}},yv={};me(yv,{BaseDocumentLoader:()=>_v});var _v=class{},wv={};me(wv,{LangSmithLoader:()=>XR});var XR=class extends _v{constructor(e){super();f(this,"datasetId");f(this,"datasetName");f(this,"exampleIds");f(this,"asOf");f(this,"splits");f(this,"inlineS3Urls");f(this,"offset");f(this,"limit");f(this,"metadata");f(this,"filter");f(this,"contentKey");f(this,"formatContent");f(this,"client");if(e.client&&e.clientConfig)throw new Error("client and clientConfig cannot both be provided.");this.client=e.client??new tf(e==null?void 0:e.clientConfig),this.contentKey=e.contentKey?e.contentKey.split("."):[],this.formatContent=e.formatContent??YR,this.datasetId=e.datasetId,this.datasetName=e.datasetName,this.exampleIds=e.exampleIds,this.asOf=e.asOf,this.splits=e.splits,this.inlineS3Urls=e.inlineS3Urls,this.offset=e.offset,this.limit=e.limit,this.metadata=e.metadata,this.filter=e.filter}async load(){const e=[];for await(const r of this.client.listExamples({datasetId:this.datasetId,datasetName:this.datasetName,exampleIds:this.exampleIds,asOf:this.asOf,splits:this.splits,inlineS3Urls:this.inlineS3Urls,offset:this.offset,limit:this.limit,metadata:this.metadata,filter:this.filter})){let n=r.inputs;for(const a of this.contentKey)n=n[a];const s=this.formatContent(n),i=r;["created_at","modified_at"].forEach(a=>{a in i&&typeof i[a]=="object"&&(i[a]=i[a].toString())}),e.push({pageContent:s,metadata:i})}return e}};function YR(t){if(typeof t=="string")return t;try{return JSON.stringify(t,null,2)}catch{return String(t)}}var Qn=class{constructor(t){f(this,"pageContent");f(this,"metadata");f(this,"id");this.pageContent=t.pageContent!==void 0?t.pageContent.toString():"",this.metadata=t.metadata??{},this.id=t.id}},vv=class extends $e{constructor(){super(...arguments);f(this,"lc_namespace",["langchain_core","documents","transformers"])}invoke(e,r){return this.transformDocuments(e)}},QR=class extends vv{async transformDocuments(t){const e=[];for(const r of t){const n=await this._transformDocument(r);e.push(n)}return e}},bv={};me(bv,{BaseDocumentTransformer:()=>vv,Document:()=>Qn,MappingDocumentTransformer:()=>QR});var Of=class extends Or{constructor(){super(...arguments);f(this,"lc_namespace",["langchain_core","example_selectors","base"])}},Ev=class{async getPromptAsync(t,e){return this.getPrompt(t).partial((e==null?void 0:e.partialVariables)??{})}},eO=class extends Ev{constructor(e,r=[]){super();f(this,"defaultPrompt");f(this,"conditionals");this.defaultPrompt=e,this.conditionals=r}getPrompt(e){for(const[r,n]of this.conditionals)if(r(e))return n;return this.defaultPrompt}};function tO(t){return t._modelType()==="base_llm"}function rO(t){return t._modelType()==="base_chat_model"}function Kg(t){return t.split(/\n| /).length}var nO=class Sv extends Of{constructor(r){super(r);f(this,"examples",[]);f(this,"examplePrompt");f(this,"getTextLength",Kg);f(this,"maxLength",2048);f(this,"exampleTextLengths",[]);this.examplePrompt=r.examplePrompt,this.maxLength=r.maxLength??2048,this.getTextLength=r.getTextLength??Kg}async addExample(r){this.examples.push(r);const n=await this.examplePrompt.format(r);this.exampleTextLengths.push(this.getTextLength(n))}async calculateExampleTextLengths(r,n){if(r.length>0)return r;const{examples:s,examplePrompt:i}=n;return(await Promise.all(s.map(o=>i.format(o)))).map(o=>this.getTextLength(o))}async selectExamples(r){const n=Object.values(r).join(" ");let s=this.maxLength-this.getTextLength(n),i=0;const a=[];for(;s>0&&i<this.examples.length;){const o=s-this.exampleTextLengths[i];if(o<0)break;a.push(this.examples[i]),s=o,i+=1}return a}static async fromExamples(r,n){const s=new Sv(n);return await Promise.all(r.map(i=>s.addExample(i))),s}};function Vl(t){return Object.keys(t).sort().map(e=>t[e])}var sO=class xv extends Of{constructor(r){super(r);f(this,"vectorStoreRetriever");f(this,"exampleKeys");f(this,"inputKeys");if(this.exampleKeys=r.exampleKeys,this.inputKeys=r.inputKeys,r.vectorStore!==void 0)this.vectorStoreRetriever=r.vectorStore.asRetriever({k:r.k??4,filter:r.filter});else if(r.vectorStoreRetriever)this.vectorStoreRetriever=r.vectorStoreRetriever;else throw new Error('You must specify one of "vectorStore" and "vectorStoreRetriever".')}async addExample(r){const n=this.inputKeys??Object.keys(r),s=Vl(n.reduce((i,a)=>({...i,[a]:r[a]}),{})).join(" ");await this.vectorStoreRetriever.addDocuments([new Qn({pageContent:s,metadata:r})])}async selectExamples(r){const n=this.inputKeys??Object.keys(r),s=Vl(n.reduce((o,c)=>({...o,[c]:r[c]}),{})).join(" "),a=(await this.vectorStoreRetriever.invoke(s)).map(o=>o.metadata);return this.exampleKeys?a.map(o=>this.exampleKeys.reduce((c,u)=>({...c,[u]:o[u]}),{})):a}static async fromExamples(r,n,s,i={}){const a=i.inputKeys??null,o=r.map(u=>Vl(a?a.reduce((l,d)=>({...l,[d]:u[d]}),{}):u).join(" ")),c=await s.fromTexts(o,r,n,i);return new xv({vectorStore:c,k:i.k??4,exampleKeys:i.exampleKeys,inputKeys:i.inputKeys})}},Tv={};me(Tv,{BaseExampleSelector:()=>Of,BasePromptSelector:()=>Ev,ConditionalPromptSelector:()=>eO,LengthBasedExampleSelector:()=>nO,SemanticSimilarityExampleSelector:()=>sO,isChatModel:()=>rO,isLLM:()=>tO});const Yd="10f90ea3-90a4-4962-bf75-83a0f3c1c62a";var iO=class extends Or{constructor(){super(...arguments);f(this,"lc_namespace",["langchain","recordmanagers"])}},Av=class{constructor(t){f(this,"uid");f(this,"hash_");f(this,"contentHash");f(this,"metadataHash");f(this,"pageContent");f(this,"metadata");f(this,"keyEncoder",Rf);this.uid=t.uid,this.pageContent=t.pageContent,this.metadata=t.metadata}makeDefaultKeyEncoder(t){this.keyEncoder=t}calculateHashes(){const t=["hash_","content_hash","metadata_hash"];for(const r of t)if(r in this.metadata)throw new Error(`Metadata cannot contain key ${r} as it is reserved for internal use. Restricted keys: [${t.join(", ")}]`);const e=this._hashStringToUUID(this.pageContent);try{const r=this._hashNestedDictToUUID(this.metadata);this.contentHash=e,this.metadataHash=r}catch(r){throw new Error(`Failed to hash metadata: ${r}. Please use a dict that can be serialized using json.`)}this.hash_=this._hashStringToUUID(this.contentHash+this.metadataHash),this.uid||(this.uid=this.hash_)}toDocument(){return new Qn({pageContent:this.pageContent,metadata:this.metadata})}static fromDocument(t,e){const r=new this({pageContent:t.pageContent,metadata:t.metadata,uid:e||t.uid});return r.calculateHashes(),r}_hashStringToUUID(t){const e=this.keyEncoder(t);return Mp(e,Yd)}_hashNestedDictToUUID(t){const e=JSON.stringify(t,Object.keys(t).sort()),r=this.keyEncoder(e);return Mp(r,Yd)}};function Cv(t,e){const r=[];let n=[];return e.forEach(s=>{n.push(s),n.length>=t&&(r.push(n),n=[])}),n.length>0&&r.push(n),r}function kv(t){const e=new Set,r=[];for(const n of t){if(!n.hash_)throw new Error("Hashed document does not have a hash");e.has(n.hash_)||(e.add(n.hash_),r.push(n))}return r}function Iv(t){if(t===null)return e=>null;if(typeof t=="string")return e=>e.metadata[t];if(typeof t=="function")return t;throw new Error(`sourceIdKey should be null, a string or a function, got ${typeof t}`)}const Rv=t=>"load"in t&&typeof t.load=="function"&&"loadAndSplit"in t&&typeof t.loadAndSplit=="function";async function aO(t){const{docsSource:e,recordManager:r,vectorStore:n,options:s}=t,{batchSize:i=100,cleanup:a,sourceIdKey:o,cleanupBatchSize:c=1e3,forceUpdate:u=!1}=s??{};if(a==="incremental"&&!o)throw new Error("sourceIdKey is required when cleanup mode is incremental. Please provide through 'options.sourceIdKey'.");const l=Rv(e)?await e.load():e,d=Iv(o??null),h=await r.getTime();let p=0,m=0,_=0,v=0;const y=Cv(i??100,l);for(const E of y){const b=kv(E.map(q=>Av.fromDocument(q))),I=b.map(q=>d(q));a==="incremental"&&b.forEach((q,se)=>{if(I[se]===null)throw new Error("sourceIdKey must be provided when cleanup is incremental")});const k=await r.exists(b.map(q=>q.uid)),R=[],P=[],T=[],H=new Set;if(b.forEach((q,se)=>{if(k[se])if(u)H.add(q.uid);else{T.push(q.uid);return}R.push(q.uid),P.push(q.toDocument())}),T.length>0&&(await r.update(T,{timeAtLeast:h}),v+=T.length),P.length>0&&(await n.addDocuments(P,{ids:R}),p+=P.length-H.size,_+=H.size),await r.update(b.map(q=>q.uid),{timeAtLeast:h,groupIds:I}),a==="incremental"){I.forEach(se=>{if(!se)throw new Error("Source id cannot be null")});const q=await r.listKeys({before:h,groupIds:I});q.length>0&&(await n.delete({ids:q}),await r.deleteKeys(q),m+=q.length)}}if(a==="full"){let E=await r.listKeys({before:h,limit:c});for(;E.length>0;)await n.delete({ids:E}),await r.deleteKeys(E),m+=E.length,E=await r.listKeys({before:h,limit:c})}return{numAdded:p,numDeleted:m,numUpdated:_,numSkipped:v}}var Ov={};me(Ov,{RecordManager:()=>iO,UUIDV5_NAMESPACE:()=>Yd,_HashedDocument:()=>Av,_batch:()=>Cv,_deduplicateInOrder:()=>kv,_getSourceIdAssigner:()=>Iv,_isBaseDocumentLoader:()=>Rv,index:()=>aO});var Bi={},Xg;function oO(){if(Xg)return Bi;Xg=1,Bi.byteLength=o,Bi.toByteArray=u,Bi.fromByteArray=h;for(var t=[],e=[],r=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,i=n.length;s<i;++s)t[s]=n[s],e[n.charCodeAt(s)]=s;e[45]=62,e[95]=63;function a(p){var m=p.length;if(m%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var _=p.indexOf("=");_===-1&&(_=m);var v=_===m?0:4-_%4;return[_,v]}function o(p){var m=a(p),_=m[0],v=m[1];return(_+v)*3/4-v}function c(p,m,_){return(m+_)*3/4-_}function u(p){var m,_=a(p),v=_[0],y=_[1],E=new r(c(p,v,y)),b=0,I=y>0?v-4:v,k;for(k=0;k<I;k+=4)m=e[p.charCodeAt(k)]<<18|e[p.charCodeAt(k+1)]<<12|e[p.charCodeAt(k+2)]<<6|e[p.charCodeAt(k+3)],E[b++]=m>>16&255,E[b++]=m>>8&255,E[b++]=m&255;return y===2&&(m=e[p.charCodeAt(k)]<<2|e[p.charCodeAt(k+1)]>>4,E[b++]=m&255),y===1&&(m=e[p.charCodeAt(k)]<<10|e[p.charCodeAt(k+1)]<<4|e[p.charCodeAt(k+2)]>>2,E[b++]=m>>8&255,E[b++]=m&255),E}function l(p){return t[p>>18&63]+t[p>>12&63]+t[p>>6&63]+t[p&63]}function d(p,m,_){for(var v,y=[],E=m;E<_;E+=3)v=(p[E]<<16&16711680)+(p[E+1]<<8&65280)+(p[E+2]&255),y.push(l(v));return y.join("")}function h(p){for(var m,_=p.length,v=_%3,y=[],E=16383,b=0,I=_-v;b<I;b+=E)y.push(d(p,b,b+E>I?I:b+E));return v===1?(m=p[_-1],y.push(t[m>>2]+t[m<<4&63]+"==")):v===2&&(m=(p[_-2]<<8)+p[_-1],y.push(t[m>>10]+t[m>>4&63]+t[m<<2&63]+"=")),y.join("")}return Bi}var cO=oO();const uO=ki(cO);var lO=Object.defineProperty,dO=(t,e,r)=>e in t?lO(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,hO=(t,e,r)=>(dO(t,e+"",r),r);function fO(t,e){let r=Array.from({length:t.length},(n,s)=>({start:s,end:s+1}));for(;r.length>1;){let n=null;for(let s=0;s<r.length-1;s++){const i=t.slice(r[s].start,r[s+1].end),a=e.get(i.join(","));a!=null&&(n==null||a<n[0])&&(n=[a,s])}if(n!=null){const s=n[1];r[s]={start:r[s].start,end:r[s+1].end},r.splice(s+1,1)}else break}return r}function pO(t,e){return t.length===1?[e.get(t.join(","))]:fO(t,e).map(r=>e.get(t.slice(r.start,r.end).join(","))).filter(r=>r!=null)}function mO(t){return t.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Qd=class{constructor(t,e){f(this,"specialTokens");f(this,"inverseSpecialTokens");f(this,"patStr");f(this,"textEncoder",new TextEncoder);f(this,"textDecoder",new TextDecoder("utf-8"));f(this,"rankMap",new Map);f(this,"textMap",new Map);this.patStr=t.pat_str;const r=t.bpe_ranks.split(`
`).filter(Boolean).reduce((n,s)=>{const[i,a,...o]=s.split(" "),c=Number.parseInt(a,10);return o.forEach((u,l)=>n[u]=c+l),n},{});for(const[n,s]of Object.entries(r)){const i=uO.toByteArray(n);this.rankMap.set(i.join(","),s),this.textMap.set(s,i)}this.specialTokens={...t.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[s,i])=>(n[i]=this.textEncoder.encode(s),n),{})}encode(t,e=[],r="all"){const n=new RegExp(this.patStr,"ug"),s=Qd.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(r==="all"?Object.keys(this.specialTokens).filter(u=>!a.has(u)):r);if(o.size>0){const u=Qd.specialTokenRegex([...o]),l=t.match(u);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let c=0;for(;;){let u=null,l=c;for(;s.lastIndex=l,u=s.exec(t),!(u==null||a.has(u[0]));)l=u.index+1;const d=(u==null?void 0:u.index)??t.length;for(const p of t.substring(c,d).matchAll(n)){const m=this.textEncoder.encode(p[0]),_=this.rankMap.get(m.join(","));if(_!=null){i.push(_);continue}i.push(...pO(m,this.rankMap))}if(u==null)break;let h=this.specialTokens[u[0]];i.push(h),c=u.index+u[0].length}return i}decode(t){const e=[];let r=0;for(let i=0;i<t.length;++i){const a=t[i],o=this.textMap.get(a)??this.inverseSpecialTokens[a];o!=null&&(e.push(o),r+=o.length)}const n=new Uint8Array(r);let s=0;for(const i of e)n.set(i,s),s+=i.length;return this.textDecoder.decode(n)}},Nv=Qd;hO(Nv,"specialTokenRegex",t=>new RegExp(t.map(e=>mO(e)).join("|"),"g"));function gO(t){switch(t){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}var $v={};me($v,{encodingForModel:()=>Nf,getEncoding:()=>Pv});const mo={},yO=new za({});async function Pv(t){return t in mo||(mo[t]=yO.fetch(`https://tiktoken.pages.dev/js/${t}.json`).then(e=>e.json()).then(e=>new Nv(e)).catch(e=>{throw delete mo[t],e})),await mo[t]}async function Nf(t){return Pv(gO(t))}var Lv={};me(Lv,{BaseLangChain:()=>$f,BaseLanguageModel:()=>Pf,calculateMaxTokens:()=>wO,getEmbeddingContextSize:()=>_O,getModelContextSize:()=>Dv,getModelNameForTiktoken:()=>ru,isOpenAITool:()=>Mv});const ru=t=>t.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":t.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":t.startsWith("gpt-4-32k")?"gpt-4-32k":t.startsWith("gpt-4-")?"gpt-4":t.startsWith("gpt-4o")?"gpt-4o":t,_O=t=>{switch(t){case"text-embedding-ada-002":return 8191;default:return 2046}},Dv=t=>{switch(ru(t)){case"gpt-3.5-turbo-16k":return 16384;case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":return 4097;case"text-curie-001":return 2048;case"text-babbage-001":return 2048;case"text-ada-001":return 2048;case"code-davinci-002":return 8e3;case"code-cushman-001":return 2048;default:return 4097}};function Mv(t){return typeof t!="object"||!t?!1:!!("type"in t&&t.type==="function"&&"function"in t&&typeof t.function=="object"&&t.function&&"name"in t.function&&"parameters"in t.function)}const wO=async({prompt:t,modelName:e})=>{let r;try{r=(await Nf(ru(e))).encode(t).length}catch{console.warn("Failed to calculate number of tokens, falling back to approximate count"),r=Math.ceil(t.length/4)}return Dv(e)-r},vO=()=>!1;var $f=class extends $e{constructor(e){super(e);f(this,"verbose");f(this,"callbacks");f(this,"tags");f(this,"metadata");this.verbose=e.verbose??vO(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}get lc_attributes(){return{callbacks:void 0,verbose:void 0}}},Pf=class extends $f{constructor({callbacks:e,callbackManager:r,...n}){const{cache:s,...i}=n;super({callbacks:e??r,...i});f(this,"caller");f(this,"cache");f(this,"_encoding");typeof s=="object"?this.cache=s:s?this.cache=mv.global():this.cache=void 0,this.caller=new za(n??{})}get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}async getNumTokens(e){let r;typeof e=="string"?r=e:r=e.map(s=>typeof s=="string"?s:s.type==="text"&&"text"in s?s.text:"").join("");let n=Math.ceil(r.length/4);if(!this._encoding)try{this._encoding=await Nf("modelName"in this?ru(this.modelName):"gpt2")}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}if(this._encoding)try{n=this._encoding.encode(r).length}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}return n}static _convertInputToPromptValue(e){return typeof e=="string"?new Af(e):Array.isArray(e)?new Cf(e.map(dn)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...r}){const n={...this._identifyingParams(),...r,_type:this._llmType(),_model:this._modelType()};return Object.entries(n).filter(([a,o])=>o!==void 0).map(([a,o])=>`${a}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}},$s=class extends $e{constructor(e){super(e);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"lc_serializable",!0);f(this,"func");e&&(this.func=e.func)}static lc_name(){return"RunnablePassthrough"}async invoke(e,r){const n=Le(r);return this.func&&await this.func(e,n),this._callWithConfig(s=>Promise.resolve(s),e,n)}async*transform(e,r){const n=Le(r);let s,i=!0;for await(const a of this._transformStreamWithConfig(e,o=>o,n))if(yield a,i)if(s===void 0)s=a;else try{s=ss(s,a)}catch{s=void 0,i=!1}this.func&&s!==void 0&&await this.func(s,n)}static assign(e){return new Ef(new Ni({steps:e}))}};const bO=t=>t();function Gl(t){const e=t.constructor;return new e({...t,content:t.contentBlocks,response_metadata:{...t.response_metadata,output_version:"v1"}})}var Uv={};me(Uv,{BaseChatModel:()=>$i,SimpleChatModel:()=>EO});function Hl(t){const e=[];for(const r of t){let n=r;if(Array.isArray(r.content))for(let s=0;s<r.content.length;s++){const i=r.content[s];(Fh(i)||jh(i))&&n===r&&(n=new r.constructor({...n,content:[...r.content.slice(0,s),nw(i),...r.content.slice(s+1)]}))}e.push(n)}return e}var $i=class gs extends Pf{constructor(r){super(r);f(this,"lc_namespace",["langchain","chat_models",this._llmType()]);f(this,"disableStreaming",!1);f(this,"outputVersion");this.outputVersion=bO(()=>{const n=r.outputVersion??cn("LC_OUTPUT_VERSION");return n&&["v0","v1"].includes(n)?n:"v0"})}get callKeys(){return[...super.callKeys,"outputVersion"]}_separateRunnableConfigFromCallOptionsCompat(r){const[n,s]=super._separateRunnableConfigFromCallOptions(r);return s.signal=n.signal,[n,s]}async invoke(r,n){const s=gs._convertInputToPromptValue(r);return(await this.generatePrompt([s],n,n==null?void 0:n.callbacks)).generations[0][0].message}async*_streamResponseChunks(r,n,s){throw new Error("Not implemented.")}async*_streamIterator(r,n){var s;if(this._streamResponseChunks===gs.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(r,n);else{const a=gs._convertInputToPromptValue(r).toChatMessages(),[o,c]=this._separateRunnableConfigFromCallOptionsCompat(n),u={...o.metadata,...this.getLsParams(c)},l=await Ht.configure(o.callbacks,this.callbacks,o.tags,this.tags,u,this.metadata,{verbose:this.verbose}),d={options:c,invocation_params:this==null?void 0:this.invocationParams(c),batch_size:1},h=c.outputVersion??this.outputVersion,p=await(l==null?void 0:l.handleChatModelStart(this.toJSON(),[Hl(a)],o.runId,void 0,d,void 0,void 0,o.runName));let m,_;try{for await(const v of this._streamResponseChunks(a,c,p==null?void 0:p[0])){if(v.message.id==null){const y=(s=p==null?void 0:p.at(0))==null?void 0:s.runId;y!=null&&v.message._updateId(`run-${y}`)}v.message.response_metadata={...v.generationInfo,...v.message.response_metadata},h==="v1"?yield Gl(v.message):yield v.message,m?m=m.concat(v):m=v,Rd(v.message)&&v.message.usage_metadata!==void 0&&(_={tokenUsage:{promptTokens:v.message.usage_metadata.input_tokens,completionTokens:v.message.usage_metadata.output_tokens,totalTokens:v.message.usage_metadata.total_tokens}})}}catch(v){throw await Promise.all((p??[]).map(y=>y==null?void 0:y.handleLLMError(v))),v}await Promise.all((p??[]).map(v=>v==null?void 0:v.handleLLMEnd({generations:[[m]],llmOutput:_})))}}getLsParams(r){const n=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:r.stop,ls_provider:n}}async _generateUncached(r,n,s,i){var p,m;const a=r.map(_=>_.map(dn));let o;if(i!==void 0&&i.length===a.length)o=i;else{const _={...s.metadata,...this.getLsParams(n)},v=await Ht.configure(s.callbacks,this.callbacks,s.tags,this.tags,_,this.metadata,{verbose:this.verbose}),y={options:n,invocation_params:this==null?void 0:this.invocationParams(n),batch_size:1};o=await(v==null?void 0:v.handleChatModelStart(this.toJSON(),a.map(Hl),s.runId,void 0,y,void 0,void 0,s.runName))}const c=n.outputVersion??this.outputVersion,u=[],l=[];if(!!(o!=null&&o[0].handlers.find(Wh))&&!this.disableStreaming&&a.length===1&&this._streamResponseChunks!==gs.prototype._streamResponseChunks)try{const _=await this._streamResponseChunks(a[0],n,o==null?void 0:o[0]);let v,y;for await(const E of _){if(E.message.id==null){const b=(p=o==null?void 0:o.at(0))==null?void 0:p.runId;b!=null&&E.message._updateId(`run-${b}`)}v===void 0?v=E:v=ss(v,E),Rd(E.message)&&E.message.usage_metadata!==void 0&&(y={tokenUsage:{promptTokens:E.message.usage_metadata.input_tokens,completionTokens:E.message.usage_metadata.output_tokens,totalTokens:E.message.usage_metadata.total_tokens}})}if(v===void 0)throw new Error("Received empty response from chat model call.");u.push([v]),await(o==null?void 0:o[0].handleLLMEnd({generations:u,llmOutput:y}))}catch(_){throw await(o==null?void 0:o[0].handleLLMError(_)),_}else{const _=await Promise.allSettled(a.map(async(v,y)=>{const E=await this._generate(v,{...n,promptIndex:y},o==null?void 0:o[y]);if(c==="v1")for(const b of E.generations)b.message=Gl(b.message);return E}));await Promise.all(_.map(async(v,y)=>{var E,b,I;if(v.status==="fulfilled"){const k=v.value;for(const R of k.generations){if(R.message.id==null){const P=(E=o==null?void 0:o.at(0))==null?void 0:E.runId;P!=null&&R.message._updateId(`run-${P}`)}R.message.response_metadata={...R.generationInfo,...R.message.response_metadata}}return k.generations.length===1&&(k.generations[0].message.response_metadata={...k.llmOutput,...k.generations[0].message.response_metadata}),u[y]=k.generations,l[y]=k.llmOutput,(b=o==null?void 0:o[y])==null?void 0:b.handleLLMEnd({generations:[k.generations],llmOutput:k.llmOutput})}else return await((I=o==null?void 0:o[y])==null?void 0:I.handleLLMError(v.reason)),Promise.reject(v.reason)}))}const h={generations:u,llmOutput:l.length?(m=this._combineLLMOutput)==null?void 0:m.call(this,...l):void 0};return Object.defineProperty(h,ma,{value:o?{runIds:o==null?void 0:o.map(_=>_.runId)}:void 0,configurable:!0}),h}async _generateCached({messages:r,cache:n,llmStringKey:s,parsedOptions:i,handledOptions:a}){const o=r.map(E=>E.map(dn)),c={...a.metadata,...this.getLsParams(i)},u=await Ht.configure(a.callbacks,this.callbacks,a.tags,this.tags,c,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},d=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),o.map(Hl),a.runId,void 0,l,void 0,void 0,a.runName)),h=[],m=(await Promise.allSettled(o.map(async(E,b)=>{const I=gs._convertInputToPromptValue(E).toString(),k=await n.lookup(I,s);return k==null&&h.push(b),k}))).map((E,b)=>({result:E,runManager:d==null?void 0:d[b]})).filter(({result:E})=>E.status==="fulfilled"&&E.value!=null||E.status==="rejected"),_=i.outputVersion??this.outputVersion,v=[];await Promise.all(m.map(async({result:E,runManager:b},I)=>{if(E.status==="fulfilled"){const k=E.value;return v[I]=k.map(R=>("message"in R&&vt(R.message)&&af(R.message)&&(R.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0},_==="v1"&&(R.message=Gl(R.message))),R.generationInfo={...R.generationInfo,tokenUsage:{}},R)),k.length&&await(b==null?void 0:b.handleLLMNewToken(k[0].text)),b==null?void 0:b.handleLLMEnd({generations:[k]},void 0,void 0,void 0,{cached:!0})}else return await(b==null?void 0:b.handleLLMError(E.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(E.reason)}));const y={generations:v,missingPromptIndices:h,startedRunManagers:d};return Object.defineProperty(y,ma,{value:d?{runIds:d==null?void 0:d.map(E=>E.runId)}:void 0,configurable:!0}),y}async generate(r,n,s){let i;Array.isArray(n)?i={stop:n}:i=n;const a=r.map(_=>_.map(dn)),[o,c]=this._separateRunnableConfigFromCallOptionsCompat(i);if(o.callbacks=o.callbacks??s,!this.cache)return this._generateUncached(a,c,o);const{cache:u}=this,l=this._getSerializedCacheKeyParametersForCall(c),{generations:d,missingPromptIndices:h,startedRunManagers:p}=await this._generateCached({messages:a,cache:u,llmStringKey:l,parsedOptions:c,handledOptions:o});let m={};if(h.length>0){const _=await this._generateUncached(h.map(v=>a[v]),c,o,p!==void 0?h.map(v=>p==null?void 0:p[v]):void 0);await Promise.all(_.generations.map(async(v,y)=>{const E=h[y];d[E]=v;const b=gs._convertInputToPromptValue(a[E]).toString();return u.update(b,l,v)})),m=_.llmOutput??{}}return{generations:d,llmOutput:m}}invocationParams(r){return{}}_modelType(){return"base_chat_model"}async generatePrompt(r,n,s){const i=r.map(a=>a.toChatMessages());return this.generate(i,n,s)}withStructuredOutput(r,n){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(n!=null&&n.strict)throw new Error('"strict" mode is not supported for this model by default.');const s=r,i=n==null?void 0:n.name,a=mi(s)??"A function available to call.",o=n==null?void 0:n.method,c=n==null?void 0:n.includeRaw;if(o==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=i??"extract",l;hs(s)?l=[{type:"function",function:{name:u,description:a,parameters:kr(s)}}]:("name"in s&&(u=s.name),l=[{type:"function",function:{name:u,description:a,parameters:s}}]);const d=this.bindTools(l),h=mn.from(v=>{if(!$t.isInstance(v))throw new Error("Input is not an AIMessageChunk.");if(!v.tool_calls||v.tool_calls.length===0)throw new Error("No tool calls found in the response.");const y=v.tool_calls.find(E=>E.name===u);if(!y)throw new Error(`No tool call found with name ${u}.`);return y.args});if(!c)return d.pipe(h).withConfig({runName:"StructuredOutput"});const p=$s.assign({parsed:(v,y)=>h.invoke(v.raw,y)}),m=$s.assign({parsed:()=>null}),_=p.withFallbacks({fallbacks:[m]});return Pn.from([{raw:d},_]).withConfig({runName:"StructuredOutputRunnable"})}},EO=class extends $i{async _generate(t,e,r){const n=await this._call(t,e,r),s=new yt(n);if(typeof s.content!="string")throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:s.content,message:s}]}}},Bv={};me(Bv,{BaseLLM:()=>Fv,LLM:()=>Lf});var Fv=class Wi extends Pf{constructor(){super(...arguments);f(this,"lc_namespace",["langchain","llms",this._llmType()])}async invoke(r,n){const s=Wi._convertInputToPromptValue(r);return(await this.generatePrompt([s],n,n==null?void 0:n.callbacks)).generations[0][0].text}async*_streamResponseChunks(r,n,s){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptionsCompat(r){const[n,s]=super._separateRunnableConfigFromCallOptions(r);return s.signal=n.signal,[n,s]}async*_streamIterator(r,n){if(this._streamResponseChunks===Wi.prototype._streamResponseChunks)yield this.invoke(r,n);else{const s=Wi._convertInputToPromptValue(r),[i,a]=this._separateRunnableConfigFromCallOptionsCompat(n),o=await Ht.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},u=await(o==null?void 0:o.handleLLMStart(this.toJSON(),[s.toString()],i.runId,void 0,c,void 0,void 0,i.runName));let l=new pi({text:""});try{for await(const d of this._streamResponseChunks(s.toString(),a,u==null?void 0:u[0]))l?l=l.concat(d):l=d,typeof d.text=="string"&&(yield d.text)}catch(d){throw await Promise.all((u??[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}await Promise.all((u??[]).map(d=>d==null?void 0:d.handleLLMEnd({generations:[[l]]})))}}async generatePrompt(r,n,s){const i=r.map(a=>a.toString());return this.generate(i,n,s)}invocationParams(r){return{}}_flattenLLMResult(r){const n=[];for(let s=0;s<r.generations.length;s+=1){const i=r.generations[s];if(s===0)n.push({generations:[i],llmOutput:r.llmOutput});else{const a=r.llmOutput?{...r.llmOutput,tokenUsage:{}}:void 0;n.push({generations:[i],llmOutput:a})}}return n}async _generateUncached(r,n,s,i){let a;if(i!==void 0&&i.length===r.length)a=i;else{const l=await Ht.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),d={options:n,invocation_params:this==null?void 0:this.invocationParams(n),batch_size:r.length};a=await(l==null?void 0:l.handleLLMStart(this.toJSON(),r,s.runId,void 0,d,void 0,void 0,s==null?void 0:s.runName))}const o=!!(a!=null&&a[0].handlers.find(Wh));let c;if(o&&r.length===1&&this._streamResponseChunks!==Wi.prototype._streamResponseChunks)try{const l=await this._streamResponseChunks(r[0],n,a==null?void 0:a[0]);let d;for await(const h of l)d===void 0?d=h:d=ss(d,h);if(d===void 0)throw new Error("Received empty response from chat model call.");c={generations:[[d]],llmOutput:{}},await(a==null?void 0:a[0].handleLLMEnd(c))}catch(l){throw await(a==null?void 0:a[0].handleLLMError(l)),l}else{try{c=await this._generate(r,n,a==null?void 0:a[0])}catch(d){throw await Promise.all((a??[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}const l=this._flattenLLMResult(c);await Promise.all((a??[]).map((d,h)=>d==null?void 0:d.handleLLMEnd(l[h])))}const u=(a==null?void 0:a.map(l=>l.runId))||void 0;return Object.defineProperty(c,ma,{value:u?{runIds:u}:void 0,configurable:!0}),c}async _generateCached({prompts:r,cache:n,llmStringKey:s,parsedOptions:i,handledOptions:a,runId:o}){const c=await Ht.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),u={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:r.length},l=await(c==null?void 0:c.handleLLMStart(this.toJSON(),r,o,void 0,u,void 0,void 0,a==null?void 0:a.runName)),d=[],p=(await Promise.allSettled(r.map(async(v,y)=>{const E=await n.lookup(v,s);return E==null&&d.push(y),E}))).map((v,y)=>({result:v,runManager:l==null?void 0:l[y]})).filter(({result:v})=>v.status==="fulfilled"&&v.value!=null||v.status==="rejected"),m=[];await Promise.all(p.map(async({result:v,runManager:y},E)=>{if(v.status==="fulfilled"){const b=v.value;return m[E]=b.map(I=>(I.generationInfo={...I.generationInfo,tokenUsage:{}},I)),b.length&&await(y==null?void 0:y.handleLLMNewToken(b[0].text)),y==null?void 0:y.handleLLMEnd({generations:[b]},void 0,void 0,void 0,{cached:!0})}else return await(y==null?void 0:y.handleLLMError(v.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(v.reason)}));const _={generations:m,missingPromptIndices:d,startedRunManagers:l};return Object.defineProperty(_,ma,{value:l?{runIds:l==null?void 0:l.map(v=>v.runId)}:void 0,configurable:!0}),_}async generate(r,n,s){if(!Array.isArray(r))throw new Error("Argument 'prompts' is expected to be a string[]");let i;Array.isArray(n)?i={stop:n}:i=n;const[a,o]=this._separateRunnableConfigFromCallOptionsCompat(i);if(a.callbacks=a.callbacks??s,!this.cache)return this._generateUncached(r,o,a);const{cache:c}=this,u=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d,startedRunManagers:h}=await this._generateCached({prompts:r,cache:c,llmStringKey:u,parsedOptions:o,handledOptions:a,runId:a.runId});let p={};if(d.length>0){const m=await this._generateUncached(d.map(_=>r[_]),o,a,h!==void 0?d.map(_=>h==null?void 0:h[_]):void 0);await Promise.all(m.generations.map(async(_,v)=>{const y=d[v];return l[y]=_,c.update(r[y],u,_)})),p=m.llmOutput??{}}return{generations:l,llmOutput:p}}_identifyingParams(){return{}}_modelType(){return"base_llm"}},Lf=class extends Fv{async _generate(t,e,r){return{generations:await Promise.all(t.map((s,i)=>this._call(s,{...e,promptIndex:i},r).then(a=>[{text:a}])))}}},SO=class extends $e{constructor(e){super(e);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"lc_serializable",!0);f(this,"runnables");this.runnables=e.runnables}static lc_name(){return"RouterRunnable"}async invoke(e,r){const{key:n,input:s}=e,i=this.runnables[n];if(i===void 0)throw new Error(`No runnable associated with key "${n}".`);return i.invoke(s,Le(r))}async batch(e,r,n){var h;const s=e.map(p=>p.key),i=e.map(p=>p.input);if(s.find(p=>this.runnables[p]===void 0)!==void 0)throw new Error("One or more keys do not have a corresponding runnable.");const o=s.map(p=>this.runnables[p]),c=this._getOptionsList(r??{},e.length),u=((h=c[0])==null?void 0:h.maxConcurrency)??(n==null?void 0:n.maxConcurrency),l=u&&u>0?u:e.length,d=[];for(let p=0;p<i.length;p+=l){const m=i.slice(p,p+l).map((v,y)=>o[y].invoke(v,c[y])),_=await Promise.all(m);d.push(_)}return d.flat()}async stream(e,r){const{key:n,input:s}=e,i=this.runnables[n];if(i===void 0)throw new Error(`No runnable associated with key "${n}".`);return i.stream(s,r)}},xO=class extends $e{constructor(e){super(e);f(this,"lc_namespace",["langchain_core","runnables"]);f(this,"lc_serializable",!0);f(this,"default");f(this,"branches");this.branches=e.branches,this.default=e.default}static lc_name(){return"RunnableBranch"}static from(e){if(e.length<1)throw new Error("RunnableBranch requires at least one branch");const n=e.slice(0,-1).map(([i,a])=>[Ot(i),Ot(a)]),s=Ot(e[e.length-1]);return new this({branches:n,default:s})}async _invoke(e,r,n){let s;for(let i=0;i<this.branches.length;i+=1){const[a,o]=this.branches[i];if(await a.invoke(e,Fe(r,{callbacks:n==null?void 0:n.getChild(`condition:${i+1}`)}))){s=await o.invoke(e,Fe(r,{callbacks:n==null?void 0:n.getChild(`branch:${i+1}`)}));break}}return s||(s=await this.default.invoke(e,Fe(r,{callbacks:n==null?void 0:n.getChild("branch:default")}))),s}async invoke(e,r={}){return this._callWithConfig(this._invoke,e,r)}async*_streamIterator(e,r){const n=await nr(r),s=await(n==null?void 0:n.handleChainStart(this.toJSON(),mt(e,"input"),r==null?void 0:r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));let i,a=!0,o;try{for(let c=0;c<this.branches.length;c+=1){const[u,l]=this.branches[c];if(await u.invoke(e,Fe(r,{callbacks:s==null?void 0:s.getChild(`condition:${c+1}`)}))){o=await l.stream(e,Fe(r,{callbacks:s==null?void 0:s.getChild(`branch:${c+1}`)}));for await(const h of o)if(yield h,a)if(i===void 0)i=h;else try{i=ss(i,h)}catch{i=void 0,a=!1}break}}if(o===void 0){o=await this.default.stream(e,Fe(r,{callbacks:s==null?void 0:s.getChild("branch:default")}));for await(const c of o)if(yield c,a)if(i===void 0)i=c;else try{i=ss(i,c)}catch{i=void 0,a=!1}}}catch(c){throw await(s==null?void 0:s.handleChainError(c)),c}await(s==null?void 0:s.handleChainEnd(i??{}))}},TO=class extends os{constructor(e){let r=mn.from((a,o)=>this._enterHistory(a,o??{})).withConfig({runName:"loadHistory"});const n=e.historyMessagesKey??e.inputMessagesKey;n&&(r=$s.assign({[n]:r}).withConfig({runName:"insertHistory"}));const s=r.pipe(e.runnable.withListeners({onEnd:(a,o)=>this._exitHistory(a,o??{})})).withConfig({runName:"RunnableWithMessageHistory"}),i=e.config??{};super({...e,config:i,bound:s});f(this,"runnable");f(this,"inputMessagesKey");f(this,"outputMessagesKey");f(this,"historyMessagesKey");f(this,"getMessageHistory");this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let r;if(typeof e=="object"&&!Array.isArray(e)&&!vt(e)){let n;this.inputMessagesKey?n=this.inputMessagesKey:Object.keys(e).length===1?n=Object.keys(e)[0]:n="input",Array.isArray(e[n])&&Array.isArray(e[n][0])?r=e[n][0]:r=e[n]}else r=e;if(typeof r=="string")return[new pt(r)];if(Array.isArray(r))return r;if(vt(r))return[r];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(r,null,2)}`)}_getOutputMessages(e){let r;if(!Array.isArray(e)&&!vt(e)&&typeof e!="string"){let n;this.outputMessagesKey!==void 0?n=this.outputMessagesKey:Object.keys(e).length===1?n=Object.keys(e)[0]:n="output",e.generations!==void 0?r=e.generations[0][0].message:r=e[n]}else r=e;if(typeof r=="string")return[new yt(r)];if(Array.isArray(r))return r;if(vt(r))return[r];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(r,null,2)}`)}async _enterHistory(e,r){var i;const s=await((i=r==null?void 0:r.configurable)==null?void 0:i.messageHistory).getMessages();return this.historyMessagesKey===void 0?s.concat(this._getInputMessages(e)):s}async _exitHistory(e,r){var c;const n=(c=r.configurable)==null?void 0:c.messageHistory;let s;Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?s=e.inputs[0]:s=e.inputs;let i=this._getInputMessages(s);if(this.historyMessagesKey===void 0){const u=await n.getMessages();i=i.slice(u.length)}const a=e.outputs;if(!a)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);const o=this._getOutputMessages(a);await n.addMessages([...i,...o])}async _mergeConfig(...e){const r=await super._mergeConfig(...e);if(!r.configurable||!r.configurable.sessionId){const s={[this.inputMessagesKey??"input"]:"foo"},i={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(s)}, ${JSON.stringify(i)})`)}const{sessionId:n}=r.configurable;return r.configurable.messageHistory=await this.getMessageHistory(n),r}},jv={};me(jv,{RouterRunnable:()=>SO,Runnable:()=>$e,RunnableAssign:()=>Ef,RunnableBinding:()=>os,RunnableBranch:()=>xO,RunnableEach:()=>AR,RunnableLambda:()=>mn,RunnableMap:()=>Ni,RunnableParallel:()=>IR,RunnablePassthrough:()=>$s,RunnablePick:()=>K0,RunnableRetry:()=>bf,RunnableSequence:()=>Pn,RunnableToolLike:()=>Xd,RunnableWithFallbacks:()=>Z0,RunnableWithMessageHistory:()=>TO,_coerceToRunnable:()=>Ot,ensureConfig:()=>Le,getCallbackManagerForConfig:()=>nr,mergeConfigs:()=>Cr,patchConfig:()=>Fe,pickRunnableConfigKeys:()=>Nn});var zv={};me(zv,{applyPatch:()=>fi,compare:()=>Xc});var nu=class extends $e{parseResultWithPrompt(t,e,r){return this.parseResult(t,r)}_baseMessageToString(t){return typeof t.content=="string"?t.content:this._baseMessageContentToString(t.content)}_baseMessageContentToString(t){return JSON.stringify(t)}async invoke(t,e){return typeof t=="string"?this._callWithConfig(async(r,n)=>this.parseResult([{text:r}],n==null?void 0:n.callbacks),t,{...e,runType:"parser"}):this._callWithConfig(async(r,n)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],n==null?void 0:n.callbacks),t,{...e,runType:"parser"})}},Va=class extends nu{parseResult(t,e){return this.parse(t[0].text,e)}async parseWithPrompt(t,e,r){return this.parse(t,r)}_type(){throw new Error("_type not implemented")}},Cn=class extends Error{constructor(e,r,n,s=!1){super(e);f(this,"llmOutput");f(this,"observation");f(this,"sendToLLM");if(this.llmOutput=r,this.observation=n,this.sendToLLM=s,s&&(n===void 0||r===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Kc(this,"OUTPUT_PARSING_FAILURE")}},Ga=class extends Va{async*_transform(t){for await(const e of t)typeof e=="string"?yield this.parseResult([{text:e}]):yield this.parseResult([{message:e,text:this._baseMessageToString(e)}])}async*transform(t,e){yield*this._transformStreamWithConfig(t,this._transform.bind(this),{...e,runType:"parser"})}},Ha=class extends Ga{constructor(e){super(e);f(this,"diff",!1);this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let r,n;for await(const s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let i;if(la(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new Rr({message:s,text:s.content})}else if(vt(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new Rr({message:sc(s),text:s.content})}else i=new pi({text:s});n===void 0?n=i:n=n.concat(i);const a=await this.parsePartialResult([n]);a!=null&&!Ts(a,r)&&(this.diff?yield this._diff(r,a):yield a,r=a)}}getFormatInstructions(){return""}},AO=class extends Ga{constructor(){super(...arguments);f(this,"lc_namespace",["langchain_core","output_parsers","bytes"]);f(this,"lc_serializable",!0);f(this,"textEncoder",new TextEncoder)}static lc_name(){return"BytesOutputParser"}parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}},qa=class extends Ga{constructor(){super(...arguments);f(this,"re")}async*_transform(e){let r="";for await(const n of e)if(typeof n=="string"?r+=n:r+=n.content,this.re){const s=[...r.matchAll(this.re)];if(s.length>1){let i=0;for(const a of s.slice(0,-1))yield[a[1]],i+=(a.index??0)+a[0].length;r=r.slice(i)}}else{const s=await this.parse(r);if(s.length>1){for(const i of s.slice(0,-1))yield[i];r=s[s.length-1]}}for(const n of await this.parse(r))yield[n]}},CO=class extends qa{constructor(){super(...arguments);f(this,"lc_namespace",["langchain_core","output_parsers","list"]);f(this,"lc_serializable",!0)}static lc_name(){return"CommaSeparatedListOutputParser"}async parse(e){try{return e.trim().split(",").map(r=>r.trim())}catch{throw new Cn(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},kO=class extends qa{constructor({length:e,separator:r}){super(...arguments);f(this,"lc_namespace",["langchain_core","output_parsers","list"]);f(this,"length");f(this,"separator");this.length=e,this.separator=r||","}async parse(e){try{const r=e.trim().split(this.separator).map(n=>n.trim());if(this.length!==void 0&&r.length!==this.length)throw new Cn(`Incorrect number of items. Expected ${this.length}, got ${r.length}.`);return r}catch(r){throw Object.getPrototypeOf(r)===Cn.prototype?r:new Cn(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${this.length===void 0?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}},IO=class extends qa{constructor(){super(...arguments);f(this,"lc_namespace",["langchain_core","output_parsers","list"]);f(this,"lc_serializable",!0);f(this,"re",/\d+\.\s([^\n]+)/g)}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(r=>r[1])}},RO=class extends qa{constructor(){super(...arguments);f(this,"lc_namespace",["langchain_core","output_parsers","list"]);f(this,"lc_serializable",!0);f(this,"re",/^\s*[-*]\s([^\n]+)$/gm)}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(r=>r[1])}},OO=class extends Ga{constructor(){super(...arguments);f(this,"lc_namespace",["langchain_core","output_parsers","string"]);f(this,"lc_serializable",!0)}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((r,n)=>r+this._messageContentToString(n),"")}},Vv=class extends Va{constructor(e){super(e);f(this,"lc_namespace",["langchain","output_parsers","structured"]);this.schema=e}static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const r=Wt(Object.fromEntries(Object.entries(e).map(([n,s])=>[n,Je().describe(s)])));return new this(r)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(kr(this.schema))}
\`\`\`
`}async parse(e){var r,n;try{const s=e.trim(),a=(((r=s.match(/^```(?:json)?\s*([\s\S]*?)```/))==null?void 0:r[1])||((n=s.match(/```json\s*([\s\S]*?)```/))==null?void 0:n[1])||s).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(o,c)=>`"${c.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await Qc(this.schema,JSON.parse(a))}catch(s){throw new Cn(`Failed to parse. Text: "${e}". Error: ${s}`,e)}}},Gv=class extends Vv{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(t){const e=(t==null?void 0:t.interpolationDepth)??1;if(e<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction(kr(this.schema)).replaceAll("{","{".repeat(e)).replaceAll("}","}".repeat(e))}
\`\`\``}_schemaToInstruction(t,e=2){const r=t;if("type"in r){let n=!1,s;if(Array.isArray(r.type)){const o=r.type.findIndex(c=>c==="null");o!==-1&&(n=!0,r.type.splice(o,1)),s=r.type.join(" | ")}else s=r.type;if(r.type==="object"&&r.properties){const o=r.description?` // ${r.description}`:"";return`{
${Object.entries(r.properties).map(([u,l])=>{var h;const d=(h=r.required)!=null&&h.includes(u)?"":" (optional)";return`${" ".repeat(e)}"${u}": ${this._schemaToInstruction(l,e+2)}${d}`}).join(`
`)}
${" ".repeat(e-2)}}${o}`}if(r.type==="array"&&r.items){const o=r.description?` // ${r.description}`:"";return`array[
${" ".repeat(e)}${this._schemaToInstruction(r.items,e+2)}
${" ".repeat(e-2)}] ${o}`}const i=n?" (nullable)":"",a=r.description?` // ${r.description}`:"";return`${s}${a}${i}`}if("anyOf"in r)return r.anyOf.map(n=>this._schemaToInstruction(n,e)).join(`
${" ".repeat(e-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(t){return new this(t)}static fromNamesAndDescriptions(t){const e=Wt(Object.fromEntries(Object.entries(t).map(([r,n])=>[r,Je().describe(n)])));return new this(e)}},NO=class extends Va{constructor({inputSchema:e}){super(...arguments);f(this,"structuredInputParser");this.structuredInputParser=new Gv(e)}async parse(e){let r;try{r=await this.structuredInputParser.parse(e)}catch(n){throw new Cn(`Failed to parse. Text: "${e}". Error: ${n}`,e)}return this.outputProcessor(r)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}},$O=class extends Ha{constructor(){super(...arguments);f(this,"lc_namespace",["langchain_core","output_parsers"]);f(this,"lc_serializable",!0)}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,r){return this.diff?super._concatOutputChunks(e,r):r}_diff(e,r){if(r)return e?Xc(e,r):[{op:"replace",path:"",value:r}]}async parsePartialResult(e){return Id(e[0].text)}async parse(e){return Id(e,JSON.parse)}getFormatInstructions(){return""}};const PO=function(){const t={};t.parser=function(A,S){return new r(A,S)},t.SAXParser=r,t.SAXStream=u,t.createStream=c,t.MAX_BUFFER_LENGTH=64*1024;const e=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];t.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"];function r(A,S){if(!(this instanceof r))return new r(A,S);var L=this;s(L),L.q=L.c="",L.bufferCheckPosition=t.MAX_BUFFER_LENGTH,L.opt=S||{},L.opt.lowercase=L.opt.lowercase||L.opt.lowercasetags,L.looseCase=L.opt.lowercase?"toLowerCase":"toUpperCase",L.tags=[],L.closed=L.closedRoot=L.sawRoot=!1,L.tag=L.error=null,L.strict=!!A,L.noscript=!!(A||L.opt.noscript),L.state=T.BEGIN,L.strictEntities=L.opt.strictEntities,L.ENTITIES=L.strictEntities?Object.create(t.XML_ENTITIES):Object.create(t.ENTITIES),L.attribList=[],L.opt.xmlns&&(L.ns=Object.create(m)),L.trackPosition=L.opt.position!==!1,L.trackPosition&&(L.position=L.line=L.column=0),q(L,"onready")}Object.create||(Object.create=function(A){function S(){}S.prototype=A;var L=new S;return L}),Object.keys||(Object.keys=function(A){var S=[];for(var L in A)A.hasOwnProperty(L)&&S.push(L);return S});function n(A){for(var S=Math.max(t.MAX_BUFFER_LENGTH,10),L=0,N=0,be=e.length;N<be;N++){var Ae=A[e[N]].length;if(Ae>S)switch(e[N]){case"textNode":ee(A);break;case"cdata":se(A,"oncdata",A.cdata),A.cdata="";break;case"script":se(A,"onscript",A.script),A.script="";break;default:M(A,"Max buffer length exceeded: "+e[N])}L=Math.max(L,Ae)}var Be=t.MAX_BUFFER_LENGTH-L;A.bufferCheckPosition=Be+A.position}function s(A){for(var S=0,L=e.length;S<L;S++)A[e[S]]=""}function i(A){ee(A),A.cdata!==""&&(se(A,"oncdata",A.cdata),A.cdata=""),A.script!==""&&(se(A,"onscript",A.script),A.script="")}r.prototype={end:function(){U(this)},write:G,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){i(this)}};var a=ReadableStream;a||(a=function(){});var o=t.EVENTS.filter(function(A){return A!=="error"&&A!=="end"});function c(A,S){return new u(A,S)}function u(A,S){if(!(this instanceof u))return new u(A,S);a.apply(this),this._parser=new r(A,S),this.writable=!0,this.readable=!0;var L=this;this._parser.onend=function(){L.emit("end")},this._parser.onerror=function(N){L.emit("error",N),L._parser.error=null},this._decoder=null,o.forEach(function(N){Object.defineProperty(L,"on"+N,{get:function(){return L._parser["on"+N]},set:function(be){if(!be)return L.removeAllListeners(N),L._parser["on"+N]=be,be;L.on(N,be)},enumerable:!0,configurable:!1})})}u.prototype=Object.create(a.prototype,{constructor:{value:u}}),u.prototype.write=function(A){return this._parser.write(A.toString()),this.emit("data",A),!0},u.prototype.end=function(A){return A&&A.length&&this.write(A),this._parser.end(),!0},u.prototype.on=function(A,S){var L=this;return!L._parser["on"+A]&&o.indexOf(A)!==-1&&(L._parser["on"+A]=function(){var N=arguments.length===1?[arguments[0]]:Array.apply(null,arguments);N.splice(0,0,A),L.emit.apply(L,N)}),a.prototype.on.call(L,A,S)};var l="[CDATA[",d="DOCTYPE",h="http://www.w3.org/XML/1998/namespace",p="http://www.w3.org/2000/xmlns/",m={xml:h,xmlns:p},_=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,v=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,y=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,E=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function b(A){return A===" "||A===`
`||A==="\r"||A==="	"}function I(A){return A==='"'||A==="'"}function k(A){return A===">"||b(A)}function R(A,S){return A.test(S)}function P(A,S){return!R(A,S)}var T=0;t.STATE={BEGIN:T++,BEGIN_WHITESPACE:T++,TEXT:T++,TEXT_ENTITY:T++,OPEN_WAKA:T++,SGML_DECL:T++,SGML_DECL_QUOTED:T++,DOCTYPE:T++,DOCTYPE_QUOTED:T++,DOCTYPE_DTD:T++,DOCTYPE_DTD_QUOTED:T++,COMMENT_STARTING:T++,COMMENT:T++,COMMENT_ENDING:T++,COMMENT_ENDED:T++,CDATA:T++,CDATA_ENDING:T++,CDATA_ENDING_2:T++,PROC_INST:T++,PROC_INST_BODY:T++,PROC_INST_ENDING:T++,OPEN_TAG:T++,OPEN_TAG_SLASH:T++,ATTRIB:T++,ATTRIB_NAME:T++,ATTRIB_NAME_SAW_WHITE:T++,ATTRIB_VALUE:T++,ATTRIB_VALUE_QUOTED:T++,ATTRIB_VALUE_CLOSED:T++,ATTRIB_VALUE_UNQUOTED:T++,ATTRIB_VALUE_ENTITY_Q:T++,ATTRIB_VALUE_ENTITY_U:T++,CLOSE_TAG:T++,CLOSE_TAG_SAW_WHITE:T++,SCRIPT:T++,SCRIPT_ENDING:T++},t.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},t.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(t.ENTITIES).forEach(function(A){var S=t.ENTITIES[A],L=typeof S=="number"?String.fromCharCode(S):S;t.ENTITIES[A]=L});for(var H in t.STATE)t.STATE[t.STATE[H]]=H;T=t.STATE;function q(A,S,L){A[S]&&A[S](L)}function se(A,S,L){A.textNode&&ee(A),q(A,S,L)}function ee(A){A.textNode=Te(A.opt,A.textNode),A.textNode&&q(A,"ontext",A.textNode),A.textNode=""}function Te(A,S){return A.trim&&(S=S.trim()),A.normalize&&(S=S.replace(/\s+/g," ")),S}function M(A,S){return ee(A),A.trackPosition&&(S+=`
Line: `+A.line+`
Column: `+A.column+`
Char: `+A.c),S=new Error(S),A.error=S,q(A,"onerror",S),A}function U(A){return A.sawRoot&&!A.closedRoot&&B(A,"Unclosed root tag"),A.state!==T.BEGIN&&A.state!==T.BEGIN_WHITESPACE&&A.state!==T.TEXT&&M(A,"Unexpected end"),ee(A),A.c="",A.closed=!0,q(A,"onend"),r.call(A,A.strict,A.opt),A}function B(A,S){if(typeof A!="object"||!(A instanceof r))throw new Error("bad call to strictFail");A.strict&&M(A,S)}function te(A){A.strict||(A.tagName=A.tagName[A.looseCase]());var S=A.tags[A.tags.length-1]||A,L=A.tag={name:A.tagName,attributes:{}};A.opt.xmlns&&(L.ns=S.ns),A.attribList.length=0,se(A,"onopentagstart",L)}function ae(A,S){var L=A.indexOf(":"),N=L<0?["",A]:A.split(":"),be=N[0],Ae=N[1];return S&&A==="xmlns"&&(be="xmlns",Ae=""),{prefix:be,local:Ae}}function Q(A){if(A.strict||(A.attribName=A.attribName[A.looseCase]()),A.attribList.indexOf(A.attribName)!==-1||A.tag.attributes.hasOwnProperty(A.attribName)){A.attribName=A.attribValue="";return}if(A.opt.xmlns){var S=ae(A.attribName,!0),L=S.prefix,N=S.local;if(L==="xmlns")if(N==="xml"&&A.attribValue!==h)B(A,"xml: prefix must be bound to "+h+`
Actual: `+A.attribValue);else if(N==="xmlns"&&A.attribValue!==p)B(A,"xmlns: prefix must be bound to "+p+`
Actual: `+A.attribValue);else{var be=A.tag,Ae=A.tags[A.tags.length-1]||A;be.ns===Ae.ns&&(be.ns=Object.create(Ae.ns)),be.ns[N]=A.attribValue}A.attribList.push([A.attribName,A.attribValue])}else A.tag.attributes[A.attribName]=A.attribValue,se(A,"onattribute",{name:A.attribName,value:A.attribValue});A.attribName=A.attribValue=""}function le(A,S){if(A.opt.xmlns){var L=A.tag,N=ae(A.tagName);L.prefix=N.prefix,L.local=N.local,L.uri=L.ns[N.prefix]||"",L.prefix&&!L.uri&&(B(A,"Unbound namespace prefix: "+JSON.stringify(A.tagName)),L.uri=N.prefix);var be=A.tags[A.tags.length-1]||A;L.ns&&be.ns!==L.ns&&Object.keys(L.ns).forEach(function(yn){se(A,"onopennamespace",{prefix:yn,uri:L.ns[yn]})});for(var Ae=0,Be=A.attribList.length;Ae<Be;Ae++){var We=A.attribList[Ae],Ye=We[0],Tt=We[1],ze=ae(Ye,!0),_t=ze.prefix,Bn=ze.local,zs=_t===""?"":L.ns[_t]||"",J={name:Ye,value:Tt,prefix:_t,local:Bn,uri:zs};_t&&_t!=="xmlns"&&!zs&&(B(A,"Unbound namespace prefix: "+JSON.stringify(_t)),J.uri=_t),A.tag.attributes[Ye]=J,se(A,"onattribute",J)}A.attribList.length=0}A.tag.isSelfClosing=!!S,A.sawRoot=!0,A.tags.push(A.tag),se(A,"onopentag",A.tag),S||(!A.noscript&&A.tagName.toLowerCase()==="script"?A.state=T.SCRIPT:A.state=T.TEXT,A.tag=null,A.tagName=""),A.attribName=A.attribValue="",A.attribList.length=0}function ve(A){if(!A.tagName){B(A,"Weird empty close tag."),A.textNode+="</>",A.state=T.TEXT;return}if(A.script){if(A.tagName!=="script"){A.script+="</"+A.tagName+">",A.tagName="",A.state=T.SCRIPT;return}se(A,"onscript",A.script),A.script=""}var S=A.tags.length,L=A.tagName;A.strict||(L=L[A.looseCase]());for(var N=L;S--;){var be=A.tags[S];if(be.name!==N)B(A,"Unexpected close tag");else break}if(S<0){B(A,"Unmatched closing tag: "+A.tagName),A.textNode+="</"+A.tagName+">",A.state=T.TEXT;return}A.tagName=L;for(var Ae=A.tags.length;Ae-- >S;){var Be=A.tag=A.tags.pop();A.tagName=A.tag.name,se(A,"onclosetag",A.tagName);var We={};for(var Ye in Be.ns)We[Ye]=Be.ns[Ye];var Tt=A.tags[A.tags.length-1]||A;A.opt.xmlns&&Be.ns!==Tt.ns&&Object.keys(Be.ns).forEach(function(ze){var _t=Be.ns[ze];se(A,"onclosenamespace",{prefix:ze,uri:_t})})}S===0&&(A.closedRoot=!0),A.tagName=A.attribValue=A.attribName="",A.attribList.length=0,A.state=T.TEXT}function z(A){var S=A.entity,L=S.toLowerCase(),N,be="";return A.ENTITIES[S]?A.ENTITIES[S]:A.ENTITIES[L]?A.ENTITIES[L]:(S=L,S.charAt(0)==="#"&&(S.charAt(1)==="x"?(S=S.slice(2),N=parseInt(S,16),be=N.toString(16)):(S=S.slice(1),N=parseInt(S,10),be=N.toString(10))),S=S.replace(/^0+/,""),isNaN(N)||be.toLowerCase()!==S?(B(A,"Invalid character entity"),"&"+A.entity+";"):String.fromCodePoint(N))}function K(A,S){S==="<"?(A.state=T.OPEN_WAKA,A.startTagPosition=A.position):b(S)||(B(A,"Non-whitespace before first tag."),A.textNode=S,A.state=T.TEXT)}function ne(A,S){var L="";return S<A.length&&(L=A.charAt(S)),L}function G(A){var S=this;if(this.error)throw this.error;if(S.closed)return M(S,"Cannot write after close. Assign an onready handler.");if(A===null)return U(S);typeof A=="object"&&(A=A.toString());for(var L=0,N="";N=ne(A,L++),S.c=N,!!N;)switch(S.trackPosition&&(S.position++,N===`
`?(S.line++,S.column=0):S.column++),S.state){case T.BEGIN:if(S.state=T.BEGIN_WHITESPACE,N==="\uFEFF")continue;K(S,N);continue;case T.BEGIN_WHITESPACE:K(S,N);continue;case T.TEXT:if(S.sawRoot&&!S.closedRoot){for(var be=L-1;N&&N!=="<"&&N!=="&";)N=ne(A,L++),N&&S.trackPosition&&(S.position++,N===`
`?(S.line++,S.column=0):S.column++);S.textNode+=A.substring(be,L-1)}N==="<"&&!(S.sawRoot&&S.closedRoot&&!S.strict)?(S.state=T.OPEN_WAKA,S.startTagPosition=S.position):(!b(N)&&(!S.sawRoot||S.closedRoot)&&B(S,"Text data outside of root node."),N==="&"?S.state=T.TEXT_ENTITY:S.textNode+=N);continue;case T.SCRIPT:N==="<"?S.state=T.SCRIPT_ENDING:S.script+=N;continue;case T.SCRIPT_ENDING:N==="/"?S.state=T.CLOSE_TAG:(S.script+="<"+N,S.state=T.SCRIPT);continue;case T.OPEN_WAKA:if(N==="!")S.state=T.SGML_DECL,S.sgmlDecl="";else if(!b(N))if(R(_,N))S.state=T.OPEN_TAG,S.tagName=N;else if(N==="/")S.state=T.CLOSE_TAG,S.tagName="";else if(N==="?")S.state=T.PROC_INST,S.procInstName=S.procInstBody="";else{if(B(S,"Unencoded <"),S.startTagPosition+1<S.position){var Ae=S.position-S.startTagPosition;N=new Array(Ae).join(" ")+N}S.textNode+="<"+N,S.state=T.TEXT}continue;case T.SGML_DECL:(S.sgmlDecl+N).toUpperCase()===l?(se(S,"onopencdata"),S.state=T.CDATA,S.sgmlDecl="",S.cdata=""):S.sgmlDecl+N==="--"?(S.state=T.COMMENT,S.comment="",S.sgmlDecl=""):(S.sgmlDecl+N).toUpperCase()===d?(S.state=T.DOCTYPE,(S.doctype||S.sawRoot)&&B(S,"Inappropriately located doctype declaration"),S.doctype="",S.sgmlDecl=""):N===">"?(se(S,"onsgmldeclaration",S.sgmlDecl),S.sgmlDecl="",S.state=T.TEXT):(I(N)&&(S.state=T.SGML_DECL_QUOTED),S.sgmlDecl+=N);continue;case T.SGML_DECL_QUOTED:N===S.q&&(S.state=T.SGML_DECL,S.q=""),S.sgmlDecl+=N;continue;case T.DOCTYPE:N===">"?(S.state=T.TEXT,se(S,"ondoctype",S.doctype),S.doctype=!0):(S.doctype+=N,N==="["?S.state=T.DOCTYPE_DTD:I(N)&&(S.state=T.DOCTYPE_QUOTED,S.q=N));continue;case T.DOCTYPE_QUOTED:S.doctype+=N,N===S.q&&(S.q="",S.state=T.DOCTYPE);continue;case T.DOCTYPE_DTD:S.doctype+=N,N==="]"?S.state=T.DOCTYPE:I(N)&&(S.state=T.DOCTYPE_DTD_QUOTED,S.q=N);continue;case T.DOCTYPE_DTD_QUOTED:S.doctype+=N,N===S.q&&(S.state=T.DOCTYPE_DTD,S.q="");continue;case T.COMMENT:N==="-"?S.state=T.COMMENT_ENDING:S.comment+=N;continue;case T.COMMENT_ENDING:N==="-"?(S.state=T.COMMENT_ENDED,S.comment=Te(S.opt,S.comment),S.comment&&se(S,"oncomment",S.comment),S.comment=""):(S.comment+="-"+N,S.state=T.COMMENT);continue;case T.COMMENT_ENDED:N!==">"?(B(S,"Malformed comment"),S.comment+="--"+N,S.state=T.COMMENT):S.state=T.TEXT;continue;case T.CDATA:N==="]"?S.state=T.CDATA_ENDING:S.cdata+=N;continue;case T.CDATA_ENDING:N==="]"?S.state=T.CDATA_ENDING_2:(S.cdata+="]"+N,S.state=T.CDATA);continue;case T.CDATA_ENDING_2:N===">"?(S.cdata&&se(S,"oncdata",S.cdata),se(S,"onclosecdata"),S.cdata="",S.state=T.TEXT):N==="]"?S.cdata+="]":(S.cdata+="]]"+N,S.state=T.CDATA);continue;case T.PROC_INST:N==="?"?S.state=T.PROC_INST_ENDING:b(N)?S.state=T.PROC_INST_BODY:S.procInstName+=N;continue;case T.PROC_INST_BODY:if(!S.procInstBody&&b(N))continue;N==="?"?S.state=T.PROC_INST_ENDING:S.procInstBody+=N;continue;case T.PROC_INST_ENDING:N===">"?(se(S,"onprocessinginstruction",{name:S.procInstName,body:S.procInstBody}),S.procInstName=S.procInstBody="",S.state=T.TEXT):(S.procInstBody+="?"+N,S.state=T.PROC_INST_BODY);continue;case T.OPEN_TAG:R(v,N)?S.tagName+=N:(te(S),N===">"?le(S):N==="/"?S.state=T.OPEN_TAG_SLASH:(b(N)||B(S,"Invalid character in tag name"),S.state=T.ATTRIB));continue;case T.OPEN_TAG_SLASH:N===">"?(le(S,!0),ve(S)):(B(S,"Forward-slash in opening tag not followed by >"),S.state=T.ATTRIB);continue;case T.ATTRIB:if(b(N))continue;N===">"?le(S):N==="/"?S.state=T.OPEN_TAG_SLASH:R(_,N)?(S.attribName=N,S.attribValue="",S.state=T.ATTRIB_NAME):B(S,"Invalid attribute name");continue;case T.ATTRIB_NAME:N==="="?S.state=T.ATTRIB_VALUE:N===">"?(B(S,"Attribute without value"),S.attribValue=S.attribName,Q(S),le(S)):b(N)?S.state=T.ATTRIB_NAME_SAW_WHITE:R(v,N)?S.attribName+=N:B(S,"Invalid attribute name");continue;case T.ATTRIB_NAME_SAW_WHITE:if(N==="=")S.state=T.ATTRIB_VALUE;else{if(b(N))continue;B(S,"Attribute without value"),S.tag.attributes[S.attribName]="",S.attribValue="",se(S,"onattribute",{name:S.attribName,value:""}),S.attribName="",N===">"?le(S):R(_,N)?(S.attribName=N,S.state=T.ATTRIB_NAME):(B(S,"Invalid attribute name"),S.state=T.ATTRIB)}continue;case T.ATTRIB_VALUE:if(b(N))continue;I(N)?(S.q=N,S.state=T.ATTRIB_VALUE_QUOTED):(B(S,"Unquoted attribute value"),S.state=T.ATTRIB_VALUE_UNQUOTED,S.attribValue=N);continue;case T.ATTRIB_VALUE_QUOTED:if(N!==S.q){N==="&"?S.state=T.ATTRIB_VALUE_ENTITY_Q:S.attribValue+=N;continue}Q(S),S.q="",S.state=T.ATTRIB_VALUE_CLOSED;continue;case T.ATTRIB_VALUE_CLOSED:b(N)?S.state=T.ATTRIB:N===">"?le(S):N==="/"?S.state=T.OPEN_TAG_SLASH:R(_,N)?(B(S,"No whitespace between attributes"),S.attribName=N,S.attribValue="",S.state=T.ATTRIB_NAME):B(S,"Invalid attribute name");continue;case T.ATTRIB_VALUE_UNQUOTED:if(!k(N)){N==="&"?S.state=T.ATTRIB_VALUE_ENTITY_U:S.attribValue+=N;continue}Q(S),N===">"?le(S):S.state=T.ATTRIB;continue;case T.CLOSE_TAG:if(S.tagName)N===">"?ve(S):R(v,N)?S.tagName+=N:S.script?(S.script+="</"+S.tagName,S.tagName="",S.state=T.SCRIPT):(b(N)||B(S,"Invalid tagname in closing tag"),S.state=T.CLOSE_TAG_SAW_WHITE);else{if(b(N))continue;P(_,N)?S.script?(S.script+="</"+N,S.state=T.SCRIPT):B(S,"Invalid tagname in closing tag."):S.tagName=N}continue;case T.CLOSE_TAG_SAW_WHITE:if(b(N))continue;N===">"?ve(S):B(S,"Invalid characters in closing tag");continue;case T.TEXT_ENTITY:case T.ATTRIB_VALUE_ENTITY_Q:case T.ATTRIB_VALUE_ENTITY_U:var Be,We;switch(S.state){case T.TEXT_ENTITY:Be=T.TEXT,We="textNode";break;case T.ATTRIB_VALUE_ENTITY_Q:Be=T.ATTRIB_VALUE_QUOTED,We="attribValue";break;case T.ATTRIB_VALUE_ENTITY_U:Be=T.ATTRIB_VALUE_UNQUOTED,We="attribValue";break}if(N===";")if(S.opt.unparsedEntities){var Ye=z(S);S.entity="",S.state=Be,S.write(Ye)}else S[We]+=z(S),S.entity="",S.state=Be;else R(S.entity.length?E:y,N)?S.entity+=N:(B(S,"Invalid character in entity name"),S[We]+="&"+S.entity+N,S.entity="",S.state=Be);continue;default:throw new Error(S,"Unknown state: "+S.state)}return S.position>=S.bufferCheckPosition&&n(S),S}/*! http://mths.be/fromcodepoint v0.1.0 by @mathias */return String.fromCodePoint||(function(){var A=String.fromCharCode,S=Math.floor,L=function(){var N=16384,be=[],Ae,Be,We=-1,Ye=arguments.length;if(!Ye)return"";for(var Tt="";++We<Ye;){var ze=Number(arguments[We]);if(!isFinite(ze)||ze<0||ze>1114111||S(ze)!==ze)throw RangeError("Invalid code point: "+ze);ze<=65535?be.push(ze):(ze-=65536,Ae=(ze>>10)+55296,Be=ze%1024+56320,be.push(Ae,Be)),(We+1===Ye||be.length>N)&&(Tt+=A.apply(null,be),be.length=0)}return Tt};Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:L,configurable:!0,writable:!0}):String.fromCodePoint=L})(),t},LO=PO(),eh=`The output should be formatted as a XML file.
1. Output should conform to the tags below. 
2. If tags are not given, make them on your own.
3. Remember to always open and close all the tags.

As an example, for the tags ["foo", "bar", "baz"]:
1. String "<foo>
   <bar>
      <baz></baz>
   </bar>
</foo>" is a well-formatted instance of the schema. 
2. String "<foo>
   <bar>
   </foo>" is a badly-formatted instance.
3. String "<foo>
   <tag>
   </tag>
</foo>" is a badly-formatted instance.

Here are the output tags:
\`\`\`
{tags}
\`\`\``;var DO=class extends Ha{constructor(e){super(e);f(this,"tags");f(this,"lc_namespace",["langchain_core","output_parsers"]);f(this,"lc_serializable",!0);this.tags=e==null?void 0:e.tags}static lc_name(){return"XMLOutputParser"}_diff(e,r){if(r)return e?Xc(e,r):[{op:"replace",path:"",value:r}]}async parsePartialResult(e){return th(e[0].text)}async parse(e){return th(e)}getFormatInstructions(){var r;return!!(this.tags&&this.tags.length>0)?eh.replace("{tags}",((r=this.tags)==null?void 0:r.join(", "))??""):eh}};const MO=t=>t.split(`
`).map(e=>e.replace(/^\s+/,"")).join(`
`).trim(),Hv=t=>{if(Object.keys(t).length===0)return{};const e={};return t.children.length>0?(e[t.name]=t.children.map(Hv),e):(e[t.name]=t.text??void 0,e)};function th(t){const e=MO(t),r=LO.parser(!0);let n={};const s=[];r.onopentag=o=>{const c={name:o.name,attributes:o.attributes,children:[],text:"",isSelfClosing:o.isSelfClosing};s.length>0?s[s.length-1].children.push(c):n=c,o.isSelfClosing||s.push(c)},r.onclosetag=()=>{if(s.length>0){const o=s.pop();s.length===0&&o&&(n=o)}},r.ontext=o=>{if(s.length>0){const c=s[s.length-1];c.text+=o}},r.onattribute=o=>{if(s.length>0){const c=s[s.length-1];c.attributes[o.name]=o.value}};const i=/```(xml)?(.*)```/s.exec(e),a=i?i[2]:e;return r.write(a).close(),n&&n.name==="?xml"&&(n=n.children[0]),Hv(n)}var qv={};me(qv,{AsymmetricStructuredOutputParser:()=>NO,BaseCumulativeTransformOutputParser:()=>Ha,BaseLLMOutputParser:()=>nu,BaseOutputParser:()=>Va,BaseTransformOutputParser:()=>Ga,BytesOutputParser:()=>AO,CommaSeparatedListOutputParser:()=>CO,CustomListOutputParser:()=>kO,JsonMarkdownStructuredOutputParser:()=>Gv,JsonOutputParser:()=>$O,ListOutputParser:()=>qa,MarkdownListOutputParser:()=>RO,NumberedListOutputParser:()=>IO,OutputParserException:()=>Cn,StringOutputParser:()=>OO,StructuredOutputParser:()=>Vv,XMLOutputParser:()=>DO,XML_FORMAT_INSTRUCTIONS:()=>eh,parseJsonMarkdown:()=>Id,parsePartialJson:()=>di,parseXMLMarkdown:()=>th});function Wv(t,e){if(t.function===void 0)return;let r;if(e!=null&&e.partial)try{r=di(t.function.arguments??"{}")}catch{return}else try{r=JSON.parse(t.function.arguments)}catch(s){throw new Cn([`Function "${t.function.name}" arguments:`,"",t.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}const n={name:t.function.name,args:r,type:"tool_call"};return e!=null&&e.returnId&&(n.id=t.id),n}function UO(t){if(t.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.args)}}}function BO(t,e){var r,n;return{name:(r=t.function)==null?void 0:r.name,args:(n=t.function)==null?void 0:n.arguments,id:t.id,error:e,type:"invalid_tool_call"}}var Jv=class extends Ha{constructor(e){super(e);f(this,"returnId",!1);f(this,"lc_namespace",["langchain","output_parsers","openai_tools"]);f(this,"lc_serializable",!0);this.returnId=(e==null?void 0:e.returnId)??this.returnId}static lc_name(){return"JsonOutputToolsParser"}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,r=!0){var a;const n=e[0].message;let s;if(af(n)&&((a=n.tool_calls)!=null&&a.length)?s=n.tool_calls.map(o=>{const{id:c,...u}=o;return this.returnId?{id:c,...u}:u}):n.additional_kwargs.tool_calls!==void 0&&(s=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(c=>Wv(c,{returnId:this.returnId,partial:r}))),!s)return[];const i=[];for(const o of s)if(o!==void 0){const c={type:o.name,args:o.args,id:o.id};i.push(c)}return i}},FO=class extends Jv{constructor(e){super(e);f(this,"lc_namespace",["langchain","output_parsers","openai_tools"]);f(this,"lc_serializable",!0);f(this,"returnId",!1);f(this,"keyName");f(this,"returnSingle",!1);f(this,"zodSchema");this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}static lc_name(){return"JsonOutputKeyToolsParser"}async _validateResult(e){var n;if(this.zodSchema===void 0)return e;const r=await T0(this.zodSchema,e);if(r.success)return r.data;throw new Cn(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify((n=r.error)==null?void 0:n.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const n=(await super.parsePartialResult(e)).filter(i=>i.type===this.keyName);let s=n;if(n.length)return this.returnId||(s=n.map(i=>i.args)),this.returnSingle?s[0]:s}async parseResult(e){const n=(await super.parsePartialResult(e,!1)).filter(a=>a.type===this.keyName);let s=n;return n.length?(this.returnId||(s=n.map(a=>a.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(a=>this._validateResult(a)))):void 0}},Zv={};me(Zv,{JsonOutputKeyToolsParser:()=>FO,JsonOutputToolsParser:()=>Jv,convertLangChainToolCallToOpenAI:()=>UO,makeInvalidToolCall:()=>BO,parseToolCall:()=>Wv});var Kv=class extends nu{constructor(e){super();f(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);f(this,"lc_serializable",!0);f(this,"argsOnly",!0);this.argsOnly=(e==null?void 0:e.argsOnly)??this.argsOnly}static lc_name(){return"OutputFunctionsParser"}async parseResult(e){if("message"in e[0]){const n=e[0].message.additional_kwargs.function_call;if(!n)throw new Error(`No function_call in message ${JSON.stringify(e)}`);if(!n.arguments)throw new Error(`No arguments in function_call ${JSON.stringify(e)}`);return this.argsOnly?n.arguments:JSON.stringify(n)}else throw new Error(`No message in generations ${JSON.stringify(e)}`)}},Xv=class extends Ha{constructor(e){super(e);f(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);f(this,"lc_serializable",!0);f(this,"outputParser");f(this,"argsOnly",!0);this.argsOnly=(e==null?void 0:e.argsOnly)??this.argsOnly,this.outputParser=new Kv(e)}static lc_name(){return"JsonOutputFunctionsParser"}_diff(e,r){return r?Xc(e??{},r):void 0}async parsePartialResult(e){const r=e[0];if(!r.message)return;const{message:n}=r,s=n.additional_kwargs.function_call;if(s)return this.argsOnly?di(s.arguments):{...s,arguments:di(s.arguments)}}async parseResult(e){const r=await this.outputParser.parseResult(e);if(!r)throw new Error(`No result from "OutputFunctionsParser" ${JSON.stringify(e)}`);return this.parse(r)}async parse(e){const r=JSON.parse(e);return this.argsOnly||(r.arguments=JSON.parse(r.arguments)),r}getFormatInstructions(){return""}},jO=class extends nu{constructor(e){super(e);f(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);f(this,"lc_serializable",!0);f(this,"outputParser",new Xv);f(this,"attrName");this.attrName=e.attrName}static lc_name(){return"JsonKeyOutputFunctionsParser"}get lc_aliases(){return{attrName:"key_name"}}async parseResult(e){return(await this.outputParser.parseResult(e))[this.attrName]}},Yv={};me(Yv,{JsonKeyOutputFunctionsParser:()=>jO,JsonOutputFunctionsParser:()=>Xv,OutputFunctionsParser:()=>Kv});var Wa=class extends $e{constructor(e){super(e);f(this,"lc_serializable",!0);f(this,"lc_namespace",["langchain_core","prompts",this._getPromptType()]);f(this,"inputVariables");f(this,"outputParser");f(this,"partialVariables");f(this,"metadata");f(this,"tags");const{inputVariables:r}=e;if(r.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}get lc_attributes(){return{partialVariables:void 0}}async mergePartialAndUserVariables(e){const r=this.partialVariables??{},n={};for(const[i,a]of Object.entries(r))typeof a=="string"?n[i]=a:n[i]=await a();return{...n,...e}}async invoke(e,r){const n={...this.metadata,...r==null?void 0:r.metadata},s=[...this.tags??[],...(r==null?void 0:r.tags)??[]];return this._callWithConfig(i=>this.formatPromptValue(i),e,{...r,tags:s,metadata:n,runType:"prompt"})}},Sa=class extends Wa{async formatPromptValue(t){const e=await this.format(t);return new Af(e)}};/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var zO=Object.prototype.toString,Pi=Array.isArray||function(e){return zO.call(e)==="[object Array]"};function Df(t){return typeof t=="function"}function VO(t){return Pi(t)?"array":typeof t}function ql(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Yg(t,e){return t!=null&&typeof t=="object"&&e in t}function GO(t,e){return t!=null&&typeof t!="object"&&t.hasOwnProperty&&t.hasOwnProperty(e)}var HO=RegExp.prototype.test;function qO(t,e){return HO.call(t,e)}var WO=/\S/;function JO(t){return!qO(WO,t)}var ZO={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function KO(t){return String(t).replace(/[&<>"'`=\/]/g,function(r){return ZO[r]})}var XO=/\s*/,YO=/\s+/,Qg=/\s*=/,QO=/\s*\}/,eN=/#|\^|\/|>|\{|&|=|!/;function tN(t,e){if(!t)return[];var r=!1,n=[],s=[],i=[],a=!1,o=!1,c="",u=0;function l(){if(a&&!o)for(;i.length;)delete s[i.pop()];else i=[];a=!1,o=!1}var d,h,p;function m(T){if(typeof T=="string"&&(T=T.split(YO,2)),!Pi(T)||T.length!==2)throw new Error("Invalid tags: "+T);d=new RegExp(ql(T[0])+"\\s*"),h=new RegExp("\\s*"+ql(T[1])),p=new RegExp("\\s*"+ql("}"+T[1]))}m(e||ar.tags);for(var _=new Ja(t),v,y,E,b,I,k;!_.eos();){if(v=_.pos,E=_.scanUntil(d),E)for(var R=0,P=E.length;R<P;++R)b=E.charAt(R),JO(b)?(i.push(s.length),c+=b):(o=!0,r=!0,c+=" "),s.push(["text",b,v,v+1]),v+=1,b===`
`&&(l(),c="",u=0,r=!1);if(!_.scan(d))break;if(a=!0,y=_.scan(eN)||"name",_.scan(XO),y==="="?(E=_.scanUntil(Qg),_.scan(Qg),_.scanUntil(h)):y==="{"?(E=_.scanUntil(p),_.scan(QO),_.scanUntil(h),y="&"):E=_.scanUntil(h),!_.scan(h))throw new Error("Unclosed tag at "+_.pos);if(y==">"?I=[y,E,v,_.pos,c,u,r]:I=[y,E,v,_.pos],u++,s.push(I),y==="#"||y==="^")n.push(I);else if(y==="/"){if(k=n.pop(),!k)throw new Error('Unopened section "'+E+'" at '+v);if(k[1]!==E)throw new Error('Unclosed section "'+k[1]+'" at '+v)}else y==="name"||y==="{"||y==="&"?o=!0:y==="="&&m(E)}if(l(),k=n.pop(),k)throw new Error('Unclosed section "'+k[1]+'" at '+_.pos);return nN(rN(s))}function rN(t){for(var e=[],r,n,s=0,i=t.length;s<i;++s)r=t[s],r&&(r[0]==="text"&&n&&n[0]==="text"?(n[1]+=r[1],n[3]=r[3]):(e.push(r),n=r));return e}function nN(t){for(var e=[],r=e,n=[],s,i,a=0,o=t.length;a<o;++a)switch(s=t[a],s[0]){case"#":case"^":r.push(s),n.push(s),r=s[4]=[];break;case"/":i=n.pop(),i[5]=s[2],r=n.length>0?n[n.length-1][4]:e;break;default:r.push(s)}return e}function Ja(t){this.string=t,this.tail=t,this.pos=0}Ja.prototype.eos=function(){return this.tail===""};Ja.prototype.scan=function(e){var r=this.tail.match(e);if(!r||r.index!==0)return"";var n=r[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n};Ja.prototype.scanUntil=function(e){var r=this.tail.search(e),n;switch(r){case-1:n=this.tail,this.tail="";break;case 0:n="";break;default:n=this.tail.substring(0,r),this.tail=this.tail.substring(r)}return this.pos+=n.length,n};function bi(t,e){this.view=t,this.cache={".":this.view},this.parent=e}bi.prototype.push=function(e){return new bi(e,this)};bi.prototype.lookup=function(e){var r=this.cache,n;if(r.hasOwnProperty(e))n=r[e];else{for(var s=this,i,a,o,c=!1;s;){if(e.indexOf(".")>0)for(i=s.view,a=e.split("."),o=0;i!=null&&o<a.length;)o===a.length-1&&(c=Yg(i,a[o])||GO(i,a[o])),i=i[a[o++]];else i=s.view[e],c=Yg(s.view,e);if(c){n=i;break}s=s.parent}r[e]=n}return Df(n)&&(n=n.call(this.view)),n};function Jt(){this.templateCache={_cache:{},set:function(e,r){this._cache[e]=r},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}Jt.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};Jt.prototype.parse=function(e,r){var n=this.templateCache,s=e+":"+(r||ar.tags).join(":"),i=typeof n<"u",a=i?n.get(s):void 0;return a==null&&(a=tN(e,r),i&&n.set(s,a)),a};Jt.prototype.render=function(e,r,n,s){var i=this.getConfigTags(s),a=this.parse(e,i),o=r instanceof bi?r:new bi(r,void 0);return this.renderTokens(a,o,n,e,s)};Jt.prototype.renderTokens=function(e,r,n,s,i){for(var a="",o,c,u,l=0,d=e.length;l<d;++l)u=void 0,o=e[l],c=o[0],c==="#"?u=this.renderSection(o,r,n,s,i):c==="^"?u=this.renderInverted(o,r,n,s,i):c===">"?u=this.renderPartial(o,r,n,i):c==="&"?u=this.unescapedValue(o,r):c==="name"?u=this.escapedValue(o,r,i):c==="text"&&(u=this.rawValue(o)),u!==void 0&&(a+=u);return a};Jt.prototype.renderSection=function(e,r,n,s,i){var a=this,o="",c=r.lookup(e[1]);function u(h){return a.render(h,r,n,i)}if(c){if(Pi(c))for(var l=0,d=c.length;l<d;++l)o+=this.renderTokens(e[4],r.push(c[l]),n,s,i);else if(typeof c=="object"||typeof c=="string"||typeof c=="number")o+=this.renderTokens(e[4],r.push(c),n,s,i);else if(Df(c)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");c=c.call(r.view,s.slice(e[3],e[5]),u),c!=null&&(o+=c)}else o+=this.renderTokens(e[4],r,n,s,i);return o}};Jt.prototype.renderInverted=function(e,r,n,s,i){var a=r.lookup(e[1]);if(!a||Pi(a)&&a.length===0)return this.renderTokens(e[4],r,n,s,i)};Jt.prototype.indentPartial=function(e,r,n){for(var s=r.replace(/[^ \t]/g,""),i=e.split(`
`),a=0;a<i.length;a++)i[a].length&&(a>0||!n)&&(i[a]=s+i[a]);return i.join(`
`)};Jt.prototype.renderPartial=function(e,r,n,s){if(n){var i=this.getConfigTags(s),a=Df(n)?n(e[1]):n[e[1]];if(a!=null){var o=e[6],c=e[5],u=e[4],l=a;c==0&&u&&(l=this.indentPartial(a,u,o));var d=this.parse(l,i);return this.renderTokens(d,r,n,l,s)}}};Jt.prototype.unescapedValue=function(e,r){var n=r.lookup(e[1]);if(n!=null)return n};Jt.prototype.escapedValue=function(e,r,n){var s=this.getConfigEscape(n)||ar.escape,i=r.lookup(e[1]);if(i!=null)return typeof i=="number"&&s===ar.escape?String(i):s(i)};Jt.prototype.rawValue=function(e){return e[1]};Jt.prototype.getConfigTags=function(e){return Pi(e)?e:e&&typeof e=="object"?e.tags:void 0};Jt.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!Pi(e))return e.escape};var ar={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(t){xa.templateCache=t},get templateCache(){return xa.templateCache}},xa=new Jt;ar.clearCache=function(){return xa.clearCache()};ar.parse=function(e,r){return xa.parse(e,r)};ar.render=function(e,r,n,s){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+VO(e)+'" was given as the first argument for mustache#render(template, view, partials)');return xa.render(e,r,n,s)};ar.escape=KO;ar.Scanner=Ja;ar.Context=bi;ar.Writer=Jt;function Qv(){ar.escape=t=>t}const Ta=t=>{const e=t.split(""),r=[],n=(i,a)=>{for(let o=a;o<e.length;o+=1)if(i.includes(e[o]))return o;return-1};let s=0;for(;s<e.length;)if(e[s]==="{"&&s+1<e.length&&e[s+1]==="{")r.push({type:"literal",text:"{"}),s+=2;else if(e[s]==="}"&&s+1<e.length&&e[s+1]==="}")r.push({type:"literal",text:"}"}),s+=2;else if(e[s]==="{"){const i=n("}",s);if(i<0)throw new Error("Unclosed '{' in template.");r.push({type:"variable",name:e.slice(s+1,i).join("")}),s=i+1}else{if(e[s]==="}")throw new Error("Single '}' in template.");{const i=n("{}",s),a=(i<0?e.slice(s):e.slice(s,i)).join("");r.push({type:"literal",text:a}),s=i<0?e.length:i}}return r},eb=(t,e=[])=>{const r=[];for(const n of t)if(n[0]==="name"){const s=n[1].includes(".")?n[1].split(".")[0]:n[1];r.push({type:"variable",name:s})}else if(["#","&","^",">"].includes(n[0])){if(r.push({type:"variable",name:n[1]}),n[0]==="#"&&n.length>4&&Array.isArray(n[4])){const s=[...e,n[1]],i=eb(n[4],s);r.push(...i)}}else r.push({type:"literal",text:n[1]});return r},gc=t=>{Qv();const e=ar.parse(t);return eb(e)},tb=(t,e)=>Ta(t).reduce((r,n)=>{if(n.type==="variable"){if(n.name in e){const s=typeof e[n.name]=="string"?e[n.name]:JSON.stringify(e[n.name]);return r+s}throw new Error(`(f-string) Missing value for input ${n.name}`)}return r+n.text},""),rb=(t,e)=>(Qv(),ar.render(t,e)),yc={"f-string":tb,mustache:rb},nb={"f-string":Ta,mustache:gc},Gr=(t,e,r)=>{try{return yc[e](t,r)}catch(n){throw Kc(n,"INVALID_PROMPT_INPUT")}},_c=(t,e)=>nb[e](t),Za=(t,e,r)=>{if(!(e in yc)){const n=Object.keys(yc);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${n}`)}try{const n=r.reduce((s,i)=>(s[i]="foo",s),{});Array.isArray(t)?t.forEach(s=>{if(s.type==="text"&&"text"in s&&typeof s.text=="string")Gr(s.text,e,n);else if(s.type==="image_url"){if(typeof s.image_url=="string")Gr(s.image_url,e,n);else if(typeof s.image_url=="object"&&s.image_url!==null&&"url"in s.image_url&&typeof s.image_url.url=="string"){const i=s.image_url.url;Gr(i,e,n)}}else throw new Error(`Invalid message template received. ${JSON.stringify(s,null,2)}`)}):Gr(t,e,n)}catch(n){throw new Error(`Invalid prompt schema: ${n.message}`)}};var es=class Ji extends Sa{constructor(r){super(r);f(this,"template");f(this,"templateFormat","f-string");f(this,"validateTemplate",!0);f(this,"additionalContentFields");if(r.templateFormat==="mustache"&&r.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,r),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let n=this.inputVariables;this.partialVariables&&(n=n.concat(Object.keys(this.partialVariables))),Za(this.template,this.templateFormat,n)}}static lc_name(){return"PromptTemplate"}_getPromptType(){return"prompt"}async format(r){const n=await this.mergePartialAndUserVariables(r);return Gr(this.template,this.templateFormat,n)}static fromExamples(r,n,s,i=`

`,a=""){const o=[a,...r,n].join(i);return new Ji({inputVariables:s,template:o})}static fromTemplate(r,n){const{templateFormat:s="f-string",...i}=n??{},a=new Set;return _c(r,s).forEach(o=>{o.type==="variable"&&a.add(o.name)}),new Ji({inputVariables:[...a],templateFormat:s,template:r,...i})}async partial(r){const n=this.inputVariables.filter(a=>!(a in r)),s={...this.partialVariables??{},...r},i={...this,inputVariables:n,partialVariables:s};return new Ji(i)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(r){if(!r.template)throw new Error("Prompt template must have a template");return new Ji({inputVariables:r.input_variables,template:r.template,templateFormat:r.template_format})}},Mo=class sb extends Wa{constructor(r){super(r);f(this,"lc_namespace",["langchain_core","prompts","image"]);f(this,"template");f(this,"templateFormat","f-string");f(this,"validateTemplate",!0);f(this,"additionalContentFields");if(this.template=r.template,this.templateFormat=r.templateFormat??this.templateFormat,this.validateTemplate=r.validateTemplate??this.validateTemplate,this.additionalContentFields=r.additionalContentFields,this.validateTemplate){let n=this.inputVariables;this.partialVariables&&(n=n.concat(Object.keys(this.partialVariables))),Za([{type:"image_url",image_url:this.template}],this.templateFormat,n)}}static lc_name(){return"ImagePromptTemplate"}_getPromptType(){return"prompt"}async partial(r){const n=this.inputVariables.filter(a=>!(a in r)),s={...this.partialVariables??{},...r},i={...this,inputVariables:n,partialVariables:s};return new sb(i)}async format(r){const n={};for(const[o,c]of Object.entries(this.template))typeof c=="string"?n[o]=Gr(c,this.templateFormat,r):n[o]=c;const s=r.url||n.url,i=r.detail||n.detail;if(!s)throw new Error("Must provide either an image URL.");if(typeof s!="string")throw new Error("url must be a string.");const a={url:s};return i&&(a.detail=i),a}async formatPromptValue(r){const n=await this.format(r);return new av(n)}},rh=class extends $e{constructor(e){const r=e.templateFormat??"f-string",n=nh(e.template,r);super({inputVariables:n,...e});f(this,"lc_namespace",["langchain_core","prompts","dict"]);f(this,"lc_serializable",!0);f(this,"template");f(this,"templateFormat");f(this,"inputVariables");this.template=e.template,this.templateFormat=r,this.inputVariables=n}static lc_name(){return"DictPromptTemplate"}async format(e){return sh(this.template,e,this.templateFormat)}async invoke(e){return await this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})}};function nh(t,e){const r=[];for(const n of Object.values(t))if(typeof n=="string")_c(n,e).forEach(s=>{s.type==="variable"&&r.push(s.name)});else if(Array.isArray(n))for(const s of n)typeof s=="string"?_c(s,e).forEach(i=>{i.type==="variable"&&r.push(i.name)}):typeof s=="object"&&r.push(...nh(s,e));else typeof n=="object"&&n!==null&&r.push(...nh(n,e));return Array.from(new Set(r))}function sh(t,e,r){const n={};for(const[s,i]of Object.entries(t))if(typeof i=="string")n[s]=Gr(i,r,e);else if(Array.isArray(i)){const a=[];for(const o of i)typeof o=="string"?a.push(Gr(o,r,e)):typeof o=="object"&&a.push(sh(o,e,r));n[s]=a}else typeof i=="object"&&i!==null?n[s]=sh(i,e,r):n[s]=i;return n}var su=class extends $e{constructor(){super(...arguments);f(this,"lc_namespace",["langchain_core","prompts","chat"]);f(this,"lc_serializable",!0)}async invoke(e,r){return this._callWithConfig(n=>this.formatMessages(n),e,{...r,runType:"prompt"})}},ih=class extends su{constructor(e){typeof e=="string"&&(e={variableName:e});super(e);f(this,"variableName");f(this,"optional");this.variableName=e.variableName,this.optional=e.optional??!1}static lc_name(){return"MessagesPlaceholder"}get inputVariables(){return[this.variableName]}async formatMessages(e){const r=e[this.variableName];if(this.optional&&!r)return[];if(!r){const s=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw s.name="InputFormatError",s}let n;try{Array.isArray(r)?n=r.map(dn):n=[dn(r)]}catch(s){const i=typeof r=="string"?r:JSON.stringify(r,null,2),a=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${i}`,`Additional message: ${s.message}`].join(`

`));throw a.name="InputFormatError",a.lc_error_code=s.lc_error_code,a}return n}},ib=class extends su{constructor(e){"prompt"in e||(e={prompt:e});super(e);f(this,"prompt");this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},Mf=class extends Wa{constructor(t){super(t)}async format(t){return(await this.formatPromptValue(t)).toString()}async formatPromptValue(t){const e=await this.formatMessages(t);return new Cf(e)}},ab=class extends ib{constructor(e,r){"prompt"in e||(e={prompt:e,role:r});super(e);f(this,"role");this.role=e.role}static lc_name(){return"ChatMessagePromptTemplate"}async format(e){return new ls(await this.prompt.format(e),this.role)}static fromTemplate(e,r,n){return new this(es.fromTemplate(e,{templateFormat:n==null?void 0:n.templateFormat}),r)}};function sN(t){return t===null||typeof t!="object"||Array.isArray(t)?!1:Object.keys(t).length===1&&"text"in t&&typeof t.text=="string"}function iN(t){return t===null||typeof t!="object"||Array.isArray(t)?!1:"image_url"in t&&(typeof t.image_url=="string"||typeof t.image_url=="object"&&t.image_url!==null&&"url"in t.image_url&&typeof t.image_url.url=="string")}var Uf=class extends su{constructor(e,r){"prompt"in e||(e={prompt:e});super(e);f(this,"lc_namespace",["langchain_core","prompts","chat"]);f(this,"lc_serializable",!0);f(this,"inputVariables",[]);f(this,"additionalOptions",{});f(this,"prompt");f(this,"messageClass");f(this,"chatMessageClass");if(this.prompt=e.prompt,Array.isArray(this.prompt)){let n=[];this.prompt.forEach(s=>{"inputVariables"in s&&(n=n.concat(s.inputVariables))}),this.inputVariables=n}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=r??this.additionalOptions}static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}createMessage(e){const r=this.constructor;if(r._messageClass()){const n=r._messageClass();return new n({content:e})}else if(r.chatMessageClass){const n=r.chatMessageClass();return new n({content:e,role:this.getRoleFromMessageClass(n.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,r){if(typeof e=="string")return new this(es.fromTemplate(e,r));const n=[];for(const s of e)if(typeof s=="string")n.push(es.fromTemplate(s,r));else if(s!==null)if(sN(s)){let i="";typeof s.text=="string"&&(i=s.text??"");const a={...r,additionalContentFields:s};n.push(es.fromTemplate(i,a))}else if(iN(s)){let i=s.image_url??"",a,o=[];if(typeof i=="string"){let c;(r==null?void 0:r.templateFormat)==="mustache"?c=gc(i):c=Ta(i);const u=c.flatMap(l=>l.type==="variable"?[l.name]:[]);if(((u==null?void 0:u.length)??0)>0){if(u.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${u}
From: ${i}`);o=[u[0]]}else o=[];i={url:i},a=new Mo({template:i,inputVariables:o,templateFormat:r==null?void 0:r.templateFormat,additionalContentFields:s})}else if(typeof i=="object"){if("url"in i){let c;(r==null?void 0:r.templateFormat)==="mustache"?c=gc(i.url):c=Ta(i.url),o=c.flatMap(u=>u.type==="variable"?[u.name]:[])}else o=[];a=new Mo({template:i,inputVariables:o,templateFormat:r==null?void 0:r.templateFormat,additionalContentFields:s})}else throw new Error("Invalid image template");n.push(a)}else typeof s=="object"&&n.push(new rh({template:s,templateFormat:r==null?void 0:r.templateFormat}));return new this({prompt:n,additionalOptions:r})}async format(e){if(this.prompt instanceof Sa){const r=await this.prompt.format(e);return this.createMessage(r)}else{const r=[];for(const n of this.prompt){let s={};if(!("inputVariables"in n))throw new Error(`Prompt ${n} does not have inputVariables defined.`);for(const i of n.inputVariables)s||(s={[i]:e[i]}),s={...s,[i]:e[i]};if(n instanceof Sa){const i=await n.format(s);let a;"additionalContentFields"in n&&(a=n.additionalContentFields),i!==""&&r.push({...a,type:"text",text:i})}else if(n instanceof Mo){const i=await n.format(s);let a;"additionalContentFields"in n&&(a=n.additionalContentFields),r.push({...a,type:"image_url",image_url:i})}else if(n instanceof rh){const i=await n.format(s);let a;"additionalContentFields"in n&&(a=n.additionalContentFields),r.push({...a,...i})}}return this.createMessage(r)}}async formatMessages(e){return[await this.format(e)]}},Bf=class extends Uf{static _messageClass(){return pt}static lc_name(){return"HumanMessagePromptTemplate"}},ob=class extends Uf{static _messageClass(){return yt}static lc_name(){return"AIMessagePromptTemplate"}},cb=class extends Uf{static _messageClass(){return lt}static lc_name(){return"SystemMessagePromptTemplate"}};function aN(t){return typeof t.formatMessages=="function"}function oN(t,e){if(aN(t)||vt(t))return t;if(Array.isArray(t)&&t[0]==="placeholder"){const s=t[1];if((e==null?void 0:e.templateFormat)==="mustache"&&typeof s=="string"&&s.slice(0,2)==="{{"&&s.slice(-2)==="}}"){const i=s.slice(2,-2);return new ih({variableName:i,optional:!0})}else if(typeof s=="string"&&s[0]==="{"&&s[s.length-1]==="}"){const i=s.slice(1,-1);return new ih({variableName:i,optional:!0})}throw new Error(`Invalid placeholder template for format ${(e==null?void 0:e.templateFormat)??'"f-string"'}: "${t[1]}". Expected a variable name surrounded by ${(e==null?void 0:e.templateFormat)==="mustache"?"double":"single"} curly braces.`)}const r=dn(t);let n;if(typeof r.content=="string"?n=r.content:n=r.content.map(s=>"text"in s?{...s,text:s.text}:"image_url"in s?{...s,image_url:s.image_url}:s),r._getType()==="human")return Bf.fromTemplate(n,e);if(r._getType()==="ai")return ob.fromTemplate(n,e);if(r._getType()==="system")return cb.fromTemplate(n,e);if(ls.isInstance(r))return ab.fromTemplate(r.content,r.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${r._getType()}".`)}function cN(t){return t.constructor.lc_name()==="MessagesPlaceholder"}var Ff=class Uo extends Mf{constructor(r){super(r);f(this,"promptMessages");f(this,"validateTemplate",!0);f(this,"templateFormat","f-string");if(r.templateFormat==="mustache"&&r.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,r),this.validateTemplate){const n=new Set;for(const c of this.promptMessages)if(!(c instanceof Ir))for(const u of c.inputVariables)n.add(u);const s=this.inputVariables,i=new Set(this.partialVariables?s.concat(Object.keys(this.partialVariables)):s),a=new Set([...i].filter(c=>!n.has(c)));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are not used in any of the prompt messages.`);const o=new Set([...n].filter(c=>!i.has(c)));if(o.size>0)throw new Error(`Input variables \`${[...o]}\` are used in prompt messages but not in the prompt template.`)}}static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}_getPromptType(){return"chat"}async _parseImagePrompts(r,n){if(typeof r.content=="string")return r;const s=await Promise.all(r.content.map(async i=>{if(i.type!=="image_url")return i;let a="";typeof i.image_url=="string"?a=i.image_url:typeof i.image_url=="object"&&i.image_url!==null&&"url"in i.image_url&&typeof i.image_url.url=="string"&&(a=i.image_url.url);const c=await es.fromTemplate(a,{templateFormat:this.templateFormat}).format(n);return typeof i.image_url=="object"&&i.image_url!==null&&"url"in i.image_url?i.image_url.url=c:i.image_url=c,i}));return r.content=s,r}async formatMessages(r){const n=await this.mergePartialAndUserVariables(r);let s=[];for(const i of this.promptMessages)if(i instanceof Ir)s.push(await this._parseImagePrompts(i,n));else{let a;this.templateFormat==="mustache"?a={...n}:a=i.inputVariables.reduce((c,u)=>{if(!(u in n)&&!(cN(i)&&i.optional))throw Kc(new Error(`Missing value for input variable \`${u.toString()}\``),"INVALID_PROMPT_INPUT");return c[u]=n[u],c},{});const o=await i.formatMessages(a);s=s.concat(o)}return s}async partial(r){const n=this.inputVariables.filter(a=>!(a in r)),s={...this.partialVariables??{},...r},i={...this,inputVariables:n,partialVariables:s};return new Uo(i)}static fromTemplate(r,n){const s=es.fromTemplate(r,n),i=new Bf({prompt:s});return this.fromMessages([i])}static fromMessages(r,n){const s=r.reduce((o,c)=>o.concat(c instanceof Uo?c.promptMessages:[oN(c,n)]),[]),i=r.reduce((o,c)=>c instanceof Uo?Object.assign(o,c.partialVariables):o,Object.create(null)),a=new Set;for(const o of s)if(!(o instanceof Ir))for(const c of o.inputVariables)c in i||a.add(c);return new this({...n,inputVariables:[...a],promptMessages:s,partialVariables:i,templateFormat:n==null?void 0:n.templateFormat})}},uN=class ah extends Sa{constructor(r){super(r);f(this,"lc_serializable",!1);f(this,"examples");f(this,"exampleSelector");f(this,"examplePrompt");f(this,"suffix","");f(this,"exampleSeparator",`

`);f(this,"prefix","");f(this,"templateFormat","f-string");f(this,"validateTemplate",!0);if(Object.assign(this,r),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let n=this.inputVariables;this.partialVariables&&(n=n.concat(Object.keys(this.partialVariables))),Za(this.prefix+this.suffix,this.templateFormat,n)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(r){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(r);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(r){const n=this.inputVariables.filter(a=>!(a in r)),s={...this.partialVariables??{},...r},i={...this,inputVariables:n,partialVariables:s};return new ah(i)}async format(r){const n=await this.mergePartialAndUserVariables(r),s=await this.getExamples(n),i=await Promise.all(s.map(o=>this.examplePrompt.format(o))),a=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return Gr(a,this.templateFormat,n)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(r){const{example_prompt:n}=r;if(!n)throw new Error("Missing example prompt");const s=await es.deserialize(n);let i;if(Array.isArray(r.examples))i=r.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new ah({inputVariables:r.input_variables,examplePrompt:s,examples:i,exampleSeparator:r.example_separator,prefix:r.prefix,suffix:r.suffix,templateFormat:r.template_format})}},lN=class ub extends Mf{constructor(r){super(r);f(this,"lc_serializable",!0);f(this,"examples");f(this,"exampleSelector");f(this,"examplePrompt");f(this,"suffix","");f(this,"exampleSeparator",`

`);f(this,"prefix","");f(this,"templateFormat","f-string");f(this,"validateTemplate",!0);if(this.examples=r.examples,this.examplePrompt=r.examplePrompt,this.exampleSeparator=r.exampleSeparator??`

`,this.exampleSelector=r.exampleSelector,this.prefix=r.prefix??"",this.suffix=r.suffix??"",this.templateFormat=r.templateFormat??"f-string",this.validateTemplate=r.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let n=this.inputVariables;this.partialVariables&&(n=n.concat(Object.keys(this.partialVariables))),Za(this.prefix+this.suffix,this.templateFormat,n)}}_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}async getExamples(r){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(r);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(r){const n=await this.mergePartialAndUserVariables(r);let s=await this.getExamples(n);s=s.map(a=>{const o={};return this.examplePrompt.inputVariables.forEach(c=>{o[c]=a[c]}),o});const i=[];for(const a of s){const o=await this.examplePrompt.formatMessages(a);i.push(...o)}return i}async format(r){const n=await this.mergePartialAndUserVariables(r),s=await this.getExamples(n),a=(await Promise.all(s.map(c=>this.examplePrompt.formatMessages(c)))).flat().map(c=>c.content),o=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return Gr(o,this.templateFormat,n)}async partial(r){const n=this.inputVariables.filter(a=>!(a in r)),s={...this.partialVariables??{},...r},i={...this,inputVariables:n,partialVariables:s};return new ub(i)}},dN=class Bo extends Wa{constructor(r){super({...r,inputVariables:[]});f(this,"pipelinePrompts");f(this,"finalPrompt");this.pipelinePrompts=r.pipelinePrompts,this.finalPrompt=r.finalPrompt,this.inputVariables=this.computeInputValues()}static lc_name(){return"PipelinePromptTemplate"}computeInputValues(){const r=this.pipelinePrompts.map(s=>s.name),n=this.pipelinePrompts.map(s=>s.prompt.inputVariables.filter(i=>!r.includes(i))).flat();return[...new Set(n)]}static extractRequiredInputValues(r,n){return n.reduce((s,i)=>(s[i]=r[i],s),{})}async formatPipelinePrompts(r){const n=await this.mergePartialAndUserVariables(r);for(const{name:s,prompt:i}of this.pipelinePrompts){const a=Bo.extractRequiredInputValues(n,i.inputVariables);i instanceof Ff?n[s]=await i.formatMessages(a):n[s]=await i.format(a)}return Bo.extractRequiredInputValues(n,this.finalPrompt.inputVariables)}async formatPromptValue(r){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(r))}async format(r){return this.finalPrompt.format(await this.formatPipelinePrompts(r))}async partial(r){const n={...this};return n.inputVariables=this.inputVariables.filter(s=>!(s in r)),n.partialVariables={...this.partialVariables??{},...r},new Bo(n)}serialize(){throw new Error("Not implemented.")}_getPromptType(){return"pipeline"}};function ey(t){return typeof t=="object"&&t!=null&&"withStructuredOutput"in t&&typeof t.withStructuredOutput=="function"}function hN(t){return typeof t=="object"&&t!=null&&"lc_id"in t&&Array.isArray(t.lc_id)&&t.lc_id.join("/")==="langchain_core/runnables/RunnableBinding"}var fN=class lb extends Ff{constructor(r){super(r);f(this,"schema");f(this,"method");f(this,"lc_namespace",["langchain_core","prompts","structured"]);this.schema=r.schema,this.method=r.method}get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}pipe(r){if(ey(r))return super.pipe(r.withStructuredOutput(this.schema));if(hN(r)&&ey(r.bound))return super.pipe(new os({bound:r.bound.withStructuredOutput(this.schema,...this.method?[{method:this.method}]:[]),kwargs:r.kwargs??{},config:r.config,configFactories:r.configFactories}));throw new Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(r,n,s){return lb.fromMessages(r,{schema:n,method:s})}},db={};me(db,{AIMessagePromptTemplate:()=>ob,BaseChatPromptTemplate:()=>Mf,BaseMessagePromptTemplate:()=>su,BaseMessageStringPromptTemplate:()=>ib,BasePromptTemplate:()=>Wa,BaseStringPromptTemplate:()=>Sa,ChatMessagePromptTemplate:()=>ab,ChatPromptTemplate:()=>Ff,DEFAULT_FORMATTER_MAPPING:()=>yc,DEFAULT_PARSER_MAPPING:()=>nb,DictPromptTemplate:()=>rh,FewShotChatMessagePromptTemplate:()=>lN,FewShotPromptTemplate:()=>uN,HumanMessagePromptTemplate:()=>Bf,ImagePromptTemplate:()=>Mo,MessagesPlaceholder:()=>ih,PipelinePromptTemplate:()=>dN,PromptTemplate:()=>es,StructuredPrompt:()=>fN,SystemMessagePromptTemplate:()=>cb,checkValidTemplate:()=>Za,interpolateFString:()=>tb,interpolateMustache:()=>rb,parseFString:()=>Ta,parseMustache:()=>gc,parseTemplate:()=>_c,renderTemplate:()=>Gr});var hb={};me(hb,{BaseDocumentCompressor:()=>pN});var pN=class{static isBaseDocumentCompressor(t){return(t==null?void 0:t.compressDocuments)!==void 0}};const Xn={and:"and",or:"or",not:"not"},Ne={eq:"eq",ne:"ne",lt:"lt",gt:"gt",lte:"lte",gte:"gte"};var fb=class{},jf=class{accept(t){if(this.exprName==="Operation")return t.visitOperation(this);if(this.exprName==="Comparison")return t.visitComparison(this);if(this.exprName==="StructuredQuery")return t.visitStructuredQuery(this);throw new Error("Unknown Expression type")}},zf=class extends jf{},mN=class extends zf{constructor(e,r,n){super();f(this,"exprName","Comparison");this.comparator=e,this.attribute=r,this.value=n}},gN=class extends zf{constructor(e,r){super();f(this,"exprName","Operation");this.operator=e,this.args=r}},yN=class extends jf{constructor(e,r){super();f(this,"exprName","StructuredQuery");this.query=e,this.filter=r}};function pb(t){return t&&typeof t=="object"&&!Array.isArray(t)}function zr(t){return t?typeof t=="string"&&t.length>0||typeof t=="function"?!1:pb(t)&&Object.keys(t).length===0:!0}function mb(t){if(typeof t=="number")return t%1===0;if(typeof t=="string"){const e=parseInt(t,10);return!Number.isNaN(e)&&e%1===0&&e.toString()===t}return!1}function gb(t){if(typeof t=="number")return t%1!==0;if(typeof t=="string"){const e=parseFloat(t);return!Number.isNaN(e)&&e%1!==0&&e.toString()===t}return!1}function yb(t){return typeof t=="string"&&(Number.isNaN(parseFloat(t))||parseFloat(t).toString()!==t)}function _b(t){return typeof t=="boolean"}function Vf(t){let e;if(yb(t))e=t;else if(mb(t))e=parseInt(t,10);else if(gb(t))e=parseFloat(t);else if(_b(t))e=!!t;else throw new Error("Unsupported value type");return e}var Gf=class extends fb{},_N=class extends Gf{constructor(e){super();f(this,"allowedOperators");f(this,"allowedComparators");this.allowedOperators=(e==null?void 0:e.allowedOperators)??[Xn.and,Xn.or],this.allowedComparators=(e==null?void 0:e.allowedComparators)??[Ne.eq,Ne.ne,Ne.gt,Ne.gte,Ne.lt,Ne.lte]}formatFunction(e){if(e in Ne){if(this.allowedComparators.length>0&&this.allowedComparators.indexOf(e)===-1)throw new Error(`Comparator ${e} not allowed. Allowed comparators: ${this.allowedComparators.join(", ")}`)}else if(e in Xn){if(this.allowedOperators.length>0&&this.allowedOperators.indexOf(e)===-1)throw new Error(`Operator ${e} not allowed. Allowed operators: ${this.allowedOperators.join(", ")}`)}else throw new Error("Unknown comparator or operator");return`$${e}`}visitOperation(e){var n;const r=(n=e.args)==null?void 0:n.map(s=>s.accept(this));return{[this.formatFunction(e.operator)]:r}}visitComparison(e){return{[e.attribute]:{[this.formatFunction(e.comparator)]:Vf(e.value)}}}visitStructuredQuery(e){let r={};return e.filter&&(r={filter:e.filter.accept(this)}),r}mergeFilters(e,r,n="and",s=!1){if(!(zr(e)&&zr(r))){if(zr(e)||n==="replace")return zr(r)?void 0:r;if(zr(r))return s?e:n==="and"?void 0:e;if(n==="and")return{$and:[e,r]};if(n==="or")return{$or:[e,r]};throw new Error("Unknown merge type")}}},wN=class extends Gf{constructor(){super(...arguments);f(this,"allowedOperators",[Xn.and,Xn.or]);f(this,"allowedComparators",[Ne.eq,Ne.ne,Ne.gt,Ne.gte,Ne.lt,Ne.lte])}formatFunction(){throw new Error("Not implemented")}getAllowedComparatorsForType(e){switch(e){case"string":return[Ne.eq,Ne.ne,Ne.gt,Ne.gte,Ne.lt,Ne.lte];case"number":return[Ne.eq,Ne.ne,Ne.gt,Ne.gte,Ne.lt,Ne.lte];case"boolean":return[Ne.eq,Ne.ne];default:throw new Error(`Unsupported data type: ${e}`)}}getComparatorFunction(e){switch(e){case Ne.eq:return(r,n)=>r===n;case Ne.ne:return(r,n)=>r!==n;case Ne.gt:return(r,n)=>r>n;case Ne.gte:return(r,n)=>r>=n;case Ne.lt:return(r,n)=>r<n;case Ne.lte:return(r,n)=>r<=n;default:throw new Error("Unknown comparator")}}getOperatorFunction(e){switch(e){case Xn.and:return(r,n)=>r&&n;case Xn.or:return(r,n)=>r||n;default:throw new Error("Unknown operator")}}visitOperation(e){const{operator:r,args:n}=e;if(this.allowedOperators.includes(r)){const s=this.getOperatorFunction(r);return i=>n?n.reduce((a,o)=>{const c=o.accept(this);if(typeof c=="function")return s(a,c(i));throw new Error("Filter is not a function")},!0):!0}else throw new Error("Operator not allowed")}visitComparison(e){const{comparator:r,attribute:n,value:s}=e,i=[Ne.ne];if(this.allowedComparators.includes(r)){if(!this.getAllowedComparatorsForType(typeof s).includes(r))throw new Error(`'${r}' comparator not allowed to be used with ${typeof s}`);const a=this.getComparatorFunction(r);return o=>{const c=o.metadata[n];return c===void 0?!!i.includes(r):a(c,Vf(s))}}else throw new Error("Comparator not allowed")}visitStructuredQuery(e){var n;if(!e.filter)return{};const r=(n=e.filter)==null?void 0:n.accept(this);if(typeof r!="function")throw new Error("Structured query filter is not a function");return{filter:r}}mergeFilters(e,r,n="and"){if(!(zr(e)&&zr(r))){if(zr(e)||n==="replace")return zr(r)?void 0:r;if(zr(r))return n==="and"?void 0:e;if(n==="and")return s=>e(s)&&r(s);if(n==="or")return s=>e(s)||r(s);throw new Error("Unknown merge type")}}},wb={};me(wb,{BaseTranslator:()=>Gf,BasicTranslator:()=>_N,Comparators:()=>Ne,Comparison:()=>mN,Expression:()=>jf,FilterDirective:()=>zf,FunctionalTranslator:()=>wN,Operation:()=>gN,Operators:()=>Xn,StructuredQuery:()=>yN,Visitor:()=>fb,castValue:()=>Vf,isBoolean:()=>_b,isFilterEmpty:()=>zr,isFloat:()=>gb,isInt:()=>mb,isObject:()=>pb,isString:()=>yb});function Hf(t){return t!==void 0&&Array.isArray(t.lc_namespace)}function qf(t){return t!==void 0&&$e.isRunnable(t)&&"lc_name"in t.constructor&&typeof t.constructor.lc_name=="function"&&t.constructor.lc_name()==="RunnableToolLike"}function Wf(t){return!!t&&typeof t=="object"&&"name"in t&&"schema"in t&&(hs(t.schema)||t.schema!=null&&typeof t.schema=="object"&&"type"in t.schema&&typeof t.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(t.schema.type))}function iu(t){return Wf(t)||qf(t)||Hf(t)}const vN=(t,e)=>{g0.init(t,e),t.name="ZodError",Object.defineProperties(t,{format:{value:r=>F1(t,r)},flatten:{value:r=>B1(t,r)},addIssue:{value:r=>t.issues.push(r)},addIssues:{value:r=>t.issues.push(...r)},isEmpty:{get(){return t.issues.length===0}}})},au=Ie("ZodError",vN,{Parent:Error}),bN=y0(au),EN=_0(au),SN=v0(au),xN=b0(au),cr=Ie("ZodType",(t,e)=>(Pt.init(t,e),t.def=e,Object.defineProperty(t,"_def",{value:e}),t.check=(...r)=>t.clone({...e,checks:[...e.checks??[],...r.map(n=>typeof n=="function"?{_zod:{check:n,def:{check:"custom"},onattach:[]}}:n)]}),t.clone=(r,n)=>pn(t,r,n),t.brand=()=>t,t.register=((r,n)=>(r.add(t,n),t)),t.parse=(r,n)=>bN(t,r,n,{callee:t.parse}),t.safeParse=(r,n)=>SN(t,r,n),t.parseAsync=async(r,n)=>EN(t,r,n,{callee:t.parseAsync}),t.safeParseAsync=async(r,n)=>xN(t,r,n),t.spa=t.safeParseAsync,t.refine=(r,n)=>t.check(ZN(r,n)),t.superRefine=r=>t.check(KN(r)),t.overwrite=r=>t.check(yk(r)),t.optional=()=>ty(t),t.nullable=()=>ry(t),t.nullish=()=>ty(ry(t)),t.nonoptional=r=>jN(t,r),t.array=()=>CN(t),t.or=r=>IN([t,r]),t.and=r=>ON(t,r),t.transform=r=>ny(t,$N(r)),t.default=r=>MN(t,r),t.prefault=r=>BN(t,r),t.catch=r=>VN(t,r),t.pipe=r=>ny(t,r),t.readonly=()=>qN(t),t.describe=r=>{const n=t.clone();return bt.add(n,{description:r}),n},Object.defineProperty(t,"description",{get(){var r;return(r=bt.get(t))==null?void 0:r.description},configurable:!0}),t.meta=(...r)=>{if(r.length===0)return bt.get(t);const n=t.clone();return bt.add(n,r[0]),n},t.isOptional=()=>t.safeParse(void 0).success,t.isNullable=()=>t.safeParse(null).success,t)),TN=Ie("ZodAny",(t,e)=>{K1.init(t,e),cr.init(t,e)});function go(){return hk(TN)}const AN=Ie("ZodArray",(t,e)=>{Q1.init(t,e),cr.init(t,e),t.element=e.element,t.min=(r,n)=>t.check(bg(r,n)),t.nonempty=r=>t.check(bg(1,r)),t.max=(r,n)=>t.check(mk(r,n)),t.length=(r,n)=>t.check(gk(r,n)),t.unwrap=()=>t.element});function CN(t,e){return _k(AN,t,e)}const kN=Ie("ZodUnion",(t,e)=>{ek.init(t,e),cr.init(t,e),t.options=e.options});function IN(t,e){return new kN({type:"union",options:t,...ds(e)})}const RN=Ie("ZodIntersection",(t,e)=>{tk.init(t,e),cr.init(t,e)});function ON(t,e){return new RN({type:"intersection",left:t,right:e})}const NN=Ie("ZodTransform",(t,e)=>{rk.init(t,e),cr.init(t,e),t._zod.parse=(r,n)=>{r.addIssue=i=>{if(typeof i=="string")r.issues.push(ya(i,r.value,e));else{const a=i;a.fatal&&(a.continue=!1),a.code??(a.code="custom"),a.input??(a.input=r.value),a.inst??(a.inst=t),a.continue??(a.continue=!0),r.issues.push(ya(a))}};const s=e.transform(r.value,r);return s instanceof Promise?s.then(i=>(r.value=i,r)):(r.value=s,r)}});function $N(t){return new NN({type:"transform",transform:t})}const PN=Ie("ZodOptional",(t,e)=>{mf.init(t,e),cr.init(t,e),t.unwrap=()=>t._zod.def.innerType});function ty(t){return new PN({type:"optional",innerType:t})}const LN=Ie("ZodNullable",(t,e)=>{nk.init(t,e),cr.init(t,e),t.unwrap=()=>t._zod.def.innerType});function ry(t){return new LN({type:"nullable",innerType:t})}const DN=Ie("ZodDefault",(t,e)=>{sk.init(t,e),cr.init(t,e),t.unwrap=()=>t._zod.def.innerType,t.removeDefault=t.unwrap});function MN(t,e){return new DN({type:"default",innerType:t,get defaultValue(){return typeof e=="function"?e():e}})}const UN=Ie("ZodPrefault",(t,e)=>{ik.init(t,e),cr.init(t,e),t.unwrap=()=>t._zod.def.innerType});function BN(t,e){return new UN({type:"prefault",innerType:t,get defaultValue(){return typeof e=="function"?e():e}})}const FN=Ie("ZodNonOptional",(t,e)=>{ak.init(t,e),cr.init(t,e),t.unwrap=()=>t._zod.def.innerType});function jN(t,e){return new FN({type:"nonoptional",innerType:t,...ds(e)})}const zN=Ie("ZodCatch",(t,e)=>{ok.init(t,e),cr.init(t,e),t.unwrap=()=>t._zod.def.innerType,t.removeCatch=t.unwrap});function VN(t,e){return new zN({type:"catch",innerType:t,catchValue:typeof e=="function"?e:()=>e})}const GN=Ie("ZodPipe",(t,e)=>{ck.init(t,e),cr.init(t,e),t.in=e.in,t.out=e.out});function ny(t,e){return new GN({type:"pipe",in:t,out:e})}const HN=Ie("ZodReadonly",(t,e)=>{uk.init(t,e),cr.init(t,e)});function qN(t){return new HN({type:"readonly",innerType:t})}const WN=Ie("ZodCustom",(t,e)=>{lk.init(t,e),cr.init(t,e)});function JN(t){const e=new Oi({check:"custom"});return e._zod.check=t,e}function ZN(t,e={}){return wk(WN,t,e)}function KN(t){const e=JN(r=>(r.addIssue=n=>{if(typeof n=="string")r.issues.push(ya(n,r.value,e._zod.def));else{const s=n;s.fatal&&(s.continue=!1),s.code??(s.code="custom"),s.input??(s.input=r.value),s.inst??(s.inst=e),s.continue??(s.continue=!e._zod.def.abort),r.issues.push(ya(s))}},t(r.value,r)));return e}var vb={};me(vb,{BaseToolkit:()=>XN,DynamicStructuredTool:()=>Sb,DynamicTool:()=>Eb,StructuredTool:()=>ou,Tool:()=>bb,ToolInputParsingException:()=>rc,isLangChainTool:()=>iu,isRunnableToolLike:()=>qf,isStructuredTool:()=>Hf,isStructuredToolParams:()=>Wf,tool:()=>Li});var ou=class extends $f{constructor(e){super(e??{});f(this,"returnDirect",!1);f(this,"verboseParsingErrors",!1);f(this,"responseFormat","content");f(this,"defaultConfig");this.verboseParsingErrors=(e==null?void 0:e.verboseParsingErrors)??this.verboseParsingErrors,this.responseFormat=(e==null?void 0:e.responseFormat)??this.responseFormat,this.defaultConfig=(e==null?void 0:e.defaultConfig)??this.defaultConfig,this.metadata=(e==null?void 0:e.metadata)??this.metadata}get lc_namespace(){return["langchain","tools"]}async invoke(e,r){let n,s=Le(Cr(this.defaultConfig,r));return ea(e)?(n=e.args,s={...s,toolCall:e}):n=e,this.call(n,s)}async call(e,r,n){const s=ea(e)?e.args:e;let i;if(hs(this.schema))try{i=await Qc(this.schema,s)}catch(m){let _="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(_=`${_}
Details: ${m.message}`),m instanceof Error&&m.constructor.name==="ZodError"&&(_=`${_}

${z1(m)}`),new rc(_,JSON.stringify(e))}else{const m=Ke(s,this.schema);if(!m.valid){let _="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(_=`${_}
Details: ${m.errors.map(v=>`${v.keywordLocation}: ${v.error}`).join(`
`)}`),new rc(_,JSON.stringify(e))}i=s}const a=Fa(r),o=Ht.configure(a.callbacks,this.callbacks,a.tags||n,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),c=await(o==null?void 0:o.handleToolStart(this.toJSON(),typeof e=="string"?e:JSON.stringify(e),a.runId,void 0,void 0,void 0,a.runName));delete a.runId;let u;try{u=await this._call(i,c,a)}catch(m){throw await(c==null?void 0:c.handleToolError(m)),m}let l,d;if(this.responseFormat==="content_and_artifact")if(Array.isArray(u)&&u.length===2)[l,d]=u;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(u)}`);else l=u;let h;ea(e)&&(h=e.id),!h&&l1(a)&&(h=a.toolCall.id);const p=YN({content:l,artifact:d,toolCallId:h,name:this.name,metadata:this.metadata});return await(c==null?void 0:c.handleToolEnd(p)),p}},bb=class extends ou{constructor(r){super(r);f(this,"schema",Wt({input:Je().optional()}).transform(r=>r.input))}call(r,n){const s=typeof r=="string"||r==null?{input:r}:r;return super.call(s,n)}},Eb=class extends bb{constructor(e){super(e);f(this,"name");f(this,"description");f(this,"func");this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect}static lc_name(){return"DynamicTool"}async call(e,r){const n=Fa(r);return n.runName===void 0&&(n.runName=this.name),super.call(e,n)}async _call(e,r,n){return this.func(e,r,n)}},Sb=class extends ou{constructor(e){super(e);f(this,"name");f(this,"description");f(this,"func");f(this,"schema");this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=e.schema}static lc_name(){return"DynamicStructuredTool"}async call(e,r,n){const s=Fa(r);return s.runName===void 0&&(s.runName=this.name),super.call(e,s,n)}_call(e,r,n){return this.func(e,r,n)}},XN=class{getTools(){return this.tools}};function Li(t,e){var a;const r=gf(e.schema),n=ra(e.schema);if(!e.schema||r||n)return new Eb({...e,description:e.description??((a=e.schema)==null?void 0:a.description)??`${e.name} tool`,func:async(o,c,u)=>new Promise((l,d)=>{const h=Fe(u,{callbacks:c==null?void 0:c.getChild()});Et.runWithConfig(Nn(h),async()=>{try{l(t(o,h))}catch(p){d(p)}})})});const s=e.schema,i=e.description??e.schema.description??`${e.name} tool`;return new Sb({...e,description:i,schema:s,func:async(o,c,u)=>new Promise((l,d)=>{u!=null&&u.signal&&u.signal.addEventListener("abort",()=>d(fa(u.signal)));const h=Fe(u,{callbacks:c==null?void 0:c.getChild()});Et.runWithConfig(Nn(h),async()=>{var p;try{const m=await t(o,h);if((p=u==null?void 0:u.signal)!=null&&p.aborted)return;l(m)}catch(m){d(m)}})})})}function YN(t){const{content:e,artifact:r,toolCallId:n,metadata:s}=t;return n&&!Gh(e)?typeof e=="string"||Array.isArray(e)&&e.every(i=>typeof i=="object")?new On({status:"success",content:e,artifact:r,tool_call_id:n,name:t.name,metadata:s}):new On({status:"success",content:QN(e),artifact:r,tool_call_id:n,name:t.name,metadata:s}):e}function QN(t){try{return JSON.stringify(t,null,2)??""}catch{return`${t}`}}var xb={};me(xb,{RunCollectorCallbackHandler:()=>e$});var e$=class extends Un{constructor({exampleId:e}={}){super({_awaitHandler:!0});f(this,"name","run_collector");f(this,"exampleId");f(this,"tracedRuns");this.exampleId=e,this.tracedRuns=[]}async persistRun(e){const r={...e};r.reference_example_id=this.exampleId,this.tracedRuns.push(r)}},t$={},Tb={};me(Tb,{chunkArray:()=>r$});const r$=(t,e)=>t.reduce((r,n,s)=>{const i=Math.floor(s/e),a=r[i]||[];return r[i]=a.concat([n]),r},[]);var Ab={};me(Ab,{EventStreamContentType:()=>n$,convertEventStreamToIterableReadableDataStream:()=>i$,getBytes:()=>Cb,getLines:()=>kb,getMessages:()=>Ib});const n$="text/event-stream";async function Cb(t,e){if(t instanceof ReadableStream){const r=t.getReader();for(;;){const n=await r.read();if(n.done){e(new Uint8Array,!0);break}e(n.value)}}else try{for await(const r of t)e(new Uint8Array(r));e(new Uint8Array,!0)}catch(r){throw new Error(["Parsing event source stream failed.","Ensure your implementation of fetch returns a web or Node readable stream.",`Error: ${r.message}`].join(`
`))}}var ni=(function(t){return t[t.NewLine=10]="NewLine",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.Colon=58]="Colon",t})(ni||{});function kb(t){let e,r,n,s=!1;return function(a,o){if(o){t(a,0,!0);return}e===void 0?(e=a,r=0,n=-1):e=s$(e,a);const c=e.length;let u=0;for(;r<c;){s&&(e[r]===ni.NewLine&&(u=++r),s=!1);let l=-1;for(;r<c&&l===-1;++r)switch(e[r]){case ni.Colon:n===-1&&(n=r-u);break;case ni.CarriageReturn:s=!0;case ni.NewLine:l=r;break}if(l===-1)break;t(e.subarray(u,l),n),u=r,n=-1}u===c?e=void 0:u!==0&&(e=e.subarray(u),r-=u)}}function Ib(t,e,r){let n=Wl();const s=new TextDecoder;return function(a,o,c){if(c){a$(n)||(t==null||t(n),n=Wl());return}if(a.length===0)t==null||t(n),n=Wl();else if(o>0){const u=s.decode(a.subarray(0,o)),l=o+(a[o+1]===ni.Space?2:1),d=s.decode(a.subarray(l));switch(u){case"data":n.data=n.data?n.data+`
`+d:d;break;case"event":n.event=d;break;case"id":e==null||e(n.id=d);break;case"retry":{const h=parseInt(d,10);Number.isNaN(h)||r==null||r(n.retry=h);break}}}}}function s$(t,e){const r=new Uint8Array(t.length+e.length);return r.set(t),r.set(e,t.length),r}function Wl(){return{data:"",event:"",id:"",retry:void 0}}function i$(t,e){const r=new ReadableStream({async start(n){const s=Ib(a=>{if(a.event==="error")throw new Error(a.data??"Unspecified event streaming error.");a.event==="metadata"?e==null||e(a):a.data&&n.enqueue(a.data)});await Cb(t,kb((a,o,c)=>{s(a,o,c),c&&n.close()}))}});return ir.fromReadableStream(r)}function a$(t){return t.data===""&&t.event===""&&t.id===""&&t.retry===void 0}var Rb={};me(Rb,{convertToOpenAIFunction:()=>Ob,convertToOpenAITool:()=>o$,isLangChainTool:()=>iu,isRunnableToolLike:()=>qf,isStructuredTool:()=>Hf,isStructuredToolParams:()=>Wf});function Ob(t,e){const r=typeof e=="number"?void 0:e;return{name:t.name,description:t.description,parameters:kr(t.schema),...(r==null?void 0:r.strict)!==void 0?{strict:r.strict}:{}}}function o$(t,e){const r=typeof e=="number"?void 0:e;let n;return iu(t)?n={type:"function",function:Ob(t)}:n=t,(r==null?void 0:r.strict)!==void 0&&(n.function.strict=r.strict),n}function Nb(t,e){let r=0,n=0,s=0;for(let i=0;i<t.length;i++)r+=t[i]*e[i],n+=t[i]*t[i],s+=e[i]*e[i];return r/(Math.sqrt(n)*Math.sqrt(s))}function c$(t,e){let r=0;for(let n=0;n<t.length;n++)r+=t[n]*e[n];return r}function u$(t,e){let r=0;for(let n=0;n<t.length;n++)r+=(t[n]-e[n])*(t[n]-e[n]);return r}function l$(t,e){return Math.sqrt(u$(t,e))}var $b={};me($b,{cosineSimilarity:()=>oh,euclideanDistance:()=>f$,innerProduct:()=>h$,matrixFunc:()=>cu,maximalMarginalRelevance:()=>p$,normalize:()=>d$});function cu(t,e,r){if(t.length===0||t[0].length===0||e.length===0||e[0].length===0)return[[]];if(t[0].length!==e[0].length)throw new Error(`Number of columns in X and Y must be the same. X has shape ${[t.length,t[0].length]} and Y has shape ${[e.length,e[0].length]}.`);return t.map(n=>e.map(s=>r(n,s)).map(s=>Number.isNaN(s)?0:s))}function d$(t,e=!1){const r=m$(t);return t.map(n=>n.map(s=>e?1-s/r:s/r))}function oh(t,e){return cu(t,e,Nb)}function h$(t,e){return cu(t,e,c$)}function f$(t,e){return cu(t,e,l$)}function p$(t,e,r=.5,n=4){if(Math.min(n,e.length)<=0)return[];const s=Array.isArray(t[0])?t:[t],i=oh(s,e)[0],a=Pb(i).maxIndex,o=[e[a]],c=[a];for(;c.length<Math.min(n,e.length);){let u=-1/0,l=-1;const d=oh(e,o);i.forEach((h,p)=>{if(c.includes(p))return;const m=Math.max(...d[p]),_=r*h-(1-r)*m;_>u&&(u=_,l=p)}),o.push(e[l]),c.push(l)}return c}function Pb(t){if(t.length===0)return{maxIndex:-1,maxValue:NaN};let e=t[0],r=0;for(let n=1;n<t.length;n+=1)t[n]>e&&(r=n,e=t[n]);return{maxIndex:r,maxValue:e}}function m$(t){return t.reduce((e,r)=>Math.max(e,Pb(r).maxValue),0)}var g$=class extends $i{_combineLLMOutput(){return[]}_llmType(){return"fake"}async _generate(t,e,r){var s;if((s=e==null?void 0:e.stop)!=null&&s.length)return{generations:[{message:new yt(e.stop[0]),text:e.stop[0]}]};const n=t.map(i=>typeof i.content=="string"?i.content:JSON.stringify(i.content,null,2)).join(`
`);return await(r==null?void 0:r.handleLLMNewToken(n)),{generations:[{message:new yt(n),text:n}],llmOutput:{}}}},y$=class Lb extends $i{constructor({sleep:r=50,responses:n=[],chunks:s=[],toolStyle:i="openai",thrownErrorString:a,...o}){super(o);f(this,"sleep",50);f(this,"responses",[]);f(this,"chunks",[]);f(this,"toolStyle","openai");f(this,"thrownErrorString");f(this,"tools",[]);this.sleep=r,this.responses=n,this.chunks=s,this.toolStyle=i,this.thrownErrorString=a}_llmType(){return"fake"}bindTools(r){const n=[...this.tools,...r],s=n.map(o=>{switch(this.toolStyle){case"openai":return{type:"function",function:{name:o.name,description:o.description,parameters:kr(o.schema)}};case"anthropic":return{name:o.name,description:o.description,input_schema:kr(o.schema)};case"bedrock":return{toolSpec:{name:o.name,description:o.description,inputSchema:kr(o.schema)}};case"google":return{name:o.name,description:o.description,parameters:kr(o.schema)};default:throw new Error(`Unsupported tool style: ${this.toolStyle}`)}}),i=this.toolStyle==="google"?[{functionDeclarations:s}]:s,a=new Lb({sleep:this.sleep,responses:this.responses,chunks:this.chunks,toolStyle:this.toolStyle,thrownErrorString:this.thrownErrorString});return a.tools=n,a.withConfig({tools:i})}async _generate(r,n,s){var o,c,u,l;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const i=((c=(o=this.responses)==null?void 0:o[0])==null?void 0:c.content)??r[0].content??"";return{generations:[{text:"",message:new yt({content:i,tool_calls:(l=(u=this.chunks)==null?void 0:u[0])==null?void 0:l.tool_calls})}]}}async*_streamResponseChunks(r,n,s){var o,c,u;if(this.thrownErrorString)throw new Error(this.thrownErrorString);if((o=this.chunks)!=null&&o.length){for(const l of this.chunks){const d=new Rr({message:new $t({content:l.content,tool_calls:l.tool_calls,additional_kwargs:l.additional_kwargs??{}}),text:((c=l.content)==null?void 0:c.toString())??""});yield d,await(s==null?void 0:s.handleLLMNewToken(l.content,void 0,void 0,void 0,void 0,{chunk:d}))}return}const i=((u=this.responses)==null?void 0:u[0])??new yt(typeof r[0].content=="string"?r[0].content:""),a=typeof i.content=="string"?i.content:"";for(const l of a){await new Promise(h=>setTimeout(h,this.sleep));const d=new Rr({message:new $t({content:l}),text:l});yield d,await(s==null?void 0:s.handleLLMNewToken(l,void 0,void 0,void 0,void 0,{chunk:d}))}}},_$=class extends $i{constructor(e){super(e);f(this,"lc_serializable",!0);f(this,"responses");f(this,"i",0);f(this,"sleep");f(this,"emitCustomEvent",!1);const{responses:r,sleep:n,emitCustomEvent:s}=e;this.responses=r,this.sleep=n,this.emitCustomEvent=s??this.emitCustomEvent}static lc_name(){return"FakeListChatModel"}_combineLLMOutput(){return[]}_llmType(){return"fake-list"}async _generate(e,r,n){var s;if(await this._sleepIfRequested(),r!=null&&r.thrownErrorString)throw new Error(r.thrownErrorString);if(this.emitCustomEvent&&await(n==null?void 0:n.handleCustomEvent("some_test_event",{someval:!0})),(s=r==null?void 0:r.stop)!=null&&s.length)return{generations:[this._formatGeneration(r.stop[0])]};{const i=this._currentResponse();return this._incrementResponse(),{generations:[this._formatGeneration(i)],llmOutput:{}}}}_formatGeneration(e){return{message:new yt(e),text:e}}async*_streamResponseChunks(e,r,n){const s=this._currentResponse();this._incrementResponse(),this.emitCustomEvent&&await(n==null?void 0:n.handleCustomEvent("some_test_event",{someval:!0}));for await(const i of s){if(await this._sleepIfRequested(),r!=null&&r.thrownErrorString)throw new Error(r.thrownErrorString);yield this._createResponseChunk(i),n==null||n.handleLLMNewToken(i)}}async _sleepIfRequested(){this.sleep!==void 0&&await this._sleep()}async _sleep(){return new Promise(e=>{setTimeout(()=>e(),this.sleep)})}_createResponseChunk(e){return new Rr({message:new $t({content:e}),text:e})}_currentResponse(){return this.responses[this.i]}_incrementResponse(){this.i<this.responses.length-1?this.i+=1:this.i=0}withStructuredOutput(e,r){return mn.from(async n=>{var i,a;const s=await this.invoke(n);if((a=(i=s.tool_calls)==null?void 0:i[0])!=null&&a.args)return s.tool_calls[0].args;if(typeof s.content=="string")return JSON.parse(s.content);throw new Error("No structured output found")})}},w$=class extends Tf{constructor(e){super(e??{});f(this,"vectorSize");this.vectorSize=(e==null?void 0:e.vectorSize)??4}async embedDocuments(e){return Promise.all(e.map(r=>this.embedQuery(r)))}async embedQuery(e){let r=e;r=r.toLowerCase().replaceAll(/[^a-z ]/g,"");const n=r.length%this.vectorSize,s=n===0?0:this.vectorSize-n,i=r.length+s;r=r.padEnd(i," ");const a=r.length/this.vectorSize,o=[];for(let u=0;u<r.length;u+=a)o.push(r.slice(u,u+a));return o.map(u=>{let l=0;for(let h=0;h<u.length;h+=1)l+=u===" "?0:u.charCodeAt(h);return l%26/26})}},v$=class extends Tf{constructor(t){super(t??{})}embedDocuments(t){return Promise.resolve(t.map(()=>[.1,.2,.3,.4]))}embedQuery(t){return Promise.resolve([.1,.2,.3,.4])}},b$=class extends Lf{constructor(e){super(e);f(this,"response");f(this,"thrownErrorString");this.response=e.response,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e,r,n){if(this.thrownErrorString)throw new Error(this.thrownErrorString);const s=this.response??e;return await(n==null?void 0:n.handleLLMNewToken(s)),s}},E$=class extends Lf{constructor(e){super(e);f(this,"sleep",50);f(this,"responses");f(this,"thrownErrorString");this.sleep=e.sleep??this.sleep,this.responses=e.responses,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e){var n,s;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const r=(n=this.responses)==null?void 0:n[0];return this.responses=(s=this.responses)==null?void 0:s.slice(1),r??e}async*_streamResponseChunks(e,r,n){var i,a;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const s=(i=this.responses)==null?void 0:i[0];this.responses=(a=this.responses)==null?void 0:a.slice(1);for(const o of s??e)await new Promise(c=>setTimeout(c,this.sleep)),yield{text:o,generationInfo:{}},await(n==null?void 0:n.handleLLMNewToken(o))}},S$=class extends tv{constructor(){super();f(this,"lc_namespace",["langchain_core","message","fake"]);f(this,"messages",[])}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async addUserMessage(e){this.messages.push(new pt(e))}async addAIMessage(e){this.messages.push(new yt(e))}async clear(){this.messages=[]}},x$=class extends xf{constructor(){super();f(this,"lc_namespace",["langchain_core","message","fake"]);f(this,"messages",[])}async addMessage(e){this.messages.push(e)}async getMessages(){return this.messages}},T$=class extends Un{constructor(){super();f(this,"name","fake_tracer");f(this,"runs",[])}persistRun(e){return this.runs.push(e),Promise.resolve()}},A$=class extends Va{constructor(){super(...arguments);f(this,"lc_namespace",["tests","fake"])}getFormatInstructions(){return""}async parse(e){return e.split(",").map(r=>r.trim())}},C$=class extends kf{constructor(e){super();f(this,"lc_namespace",["test","fake"]);f(this,"output",[new Qn({pageContent:"foo"}),new Qn({pageContent:"bar"})]);this.output=(e==null?void 0:e.output)??this.output}async _getRelevantDocuments(e){return this.output}},k$=class extends $e{constructor(e){super(e);f(this,"lc_namespace",["tests","fake"]);f(this,"returnOptions");this.returnOptions=e.returnOptions}async invoke(e,r){return this.returnOptions?r??{}:{input:e}}},I$=class extends ou{constructor(e){super(e);f(this,"name");f(this,"description");f(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}async _call(e,r){return JSON.stringify(e)}},R$=class extends Un{constructor(){super();f(this,"runPromiseResolver");f(this,"runPromise");f(this,"name","single_run_extractor");this.runPromise=new Promise(e=>{this.runPromiseResolver=e})}async persistRun(e){this.runPromiseResolver(e)}async extract(){return this.runPromise}},O$=class Db extends If{constructor(r,{similarity:n,...s}={}){super(r,s);f(this,"memoryVectors",[]);f(this,"similarity");this.similarity=n??Nb}_vectorstoreType(){return"memory"}async addDocuments(r){const n=r.map(({pageContent:s})=>s);return this.addVectors(await this.embeddings.embedDocuments(n),r)}async addVectors(r,n){const s=r.map((i,a)=>({content:n[a].pageContent,embedding:i,metadata:n[a].metadata}));this.memoryVectors=this.memoryVectors.concat(s)}async similaritySearchVectorWithScore(r,n,s){const i=u=>{if(!s)return!0;const l=new Qn({metadata:u.metadata,pageContent:u.content});return s(l)},a=this.memoryVectors.filter(i);return a.map((u,l)=>({similarity:this.similarity(r,u.embedding),index:l})).sort((u,l)=>u.similarity>l.similarity?-1:0).slice(0,n).map(u=>[new Qn({metadata:a[u.index].metadata,pageContent:a[u.index].content}),u.similarity])}static async fromTexts(r,n,s,i){const a=[];for(let o=0;o<r.length;o+=1){const c=Array.isArray(n)?n[o]:n,u=new Qn({pageContent:r[o],metadata:c});a.push(u)}return Db.fromDocuments(a,s,i)}static async fromDocuments(r,n,s){const i=new this(n,s);return await i.addDocuments(r),i}static async fromExistingIndex(r,n){return new this(r,n)}},Mb={};me(Mb,{FakeChatMessageHistory:()=>S$,FakeChatModel:()=>g$,FakeEmbeddings:()=>v$,FakeLLM:()=>b$,FakeListChatMessageHistory:()=>x$,FakeListChatModel:()=>_$,FakeRetriever:()=>C$,FakeRunnable:()=>k$,FakeSplitIntoListParser:()=>A$,FakeStreamingChatModel:()=>y$,FakeStreamingLLM:()=>E$,FakeTool:()=>I$,FakeTracer:()=>T$,FakeVectorStore:()=>O$,SingleRunExtractor:()=>R$,SyntheticEmbeddings:()=>w$});var Ub={};me(Ub,{extendInteropZodObject:()=>A0,getInteropZodDefaultGetter:()=>C0,getInteropZodObjectShape:()=>_a,getSchemaDescription:()=>mi,interopParse:()=>Po,interopParseAsync:()=>Qc,interopSafeParse:()=>Ek,interopSafeParseAsync:()=>T0,interopZodObjectMakeFieldsOptional:()=>Ak,interopZodObjectPartial:()=>_f,interopZodObjectPassthrough:()=>jd,interopZodObjectStrict:()=>oc,interopZodTransformInputSchema:()=>ri,isInteropZodLiteral:()=>bk,isInteropZodObject:()=>jr,isInteropZodSchema:()=>hs,isShapelessZodSchema:()=>Sk,isSimpleStringZodSchema:()=>gf,isZodArrayV4:()=>eu,isZodLiteralV3:()=>S0,isZodLiteralV4:()=>x0,isZodObjectV3:()=>yf,isZodObjectV4:()=>hn,isZodSchema:()=>vk,isZodSchemaV3:()=>dt,isZodSchemaV4:()=>it});var Bb={};me(Bb,{agents:()=>Mx,caches:()=>hv,callbacks__base:()=>pw,callbacks__manager:()=>Kw,callbacks__promises:()=>jw,chat_history:()=>ev,document_loaders__base:()=>yv,document_loaders__langsmith:()=>wv,documents:()=>bv,embeddings:()=>rv,example_selectors:()=>Tv,index:()=>FR,indexing:()=>Ov,language_models__base:()=>Lv,language_models__chat_models:()=>Uv,language_models__llms:()=>Bv,load__serializable:()=>V_,memory:()=>nv,messages:()=>Q0,messages__tool:()=>dw,output_parsers:()=>qv,output_parsers__openai_functions:()=>Yv,output_parsers__openai_tools:()=>Zv,outputs:()=>l0,prompt_values:()=>iv,prompts:()=>db,retrievers:()=>uv,retrievers__document_compressors:()=>hb,runnables:()=>jv,runnables__graph:()=>j0,singletons:()=>r0,stores:()=>ov,structured_query:()=>wb,tools:()=>vb,tracers__base:()=>Pw,tracers__console:()=>Dw,tracers__log_stream:()=>c0,tracers__run_collector:()=>xb,tracers__tracer_langchain:()=>Uw,types__stream:()=>t$,utils__async_caller:()=>f0,utils__chunk_array:()=>Tb,utils__env:()=>Z_,utils__event_source_parse:()=>Ab,utils__function_calling:()=>Rb,utils__hash:()=>dv,utils__json_patch:()=>zv,utils__json_schema:()=>F0,utils__math:()=>$b,utils__stream:()=>n0,utils__testing:()=>Mb,utils__tiktoken:()=>$v,utils__types:()=>Ub,vectorstores:()=>lv});function N$(t){const e={};for(let r=t;r&&r.prototype;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r.prototype,"lc_aliases"));return Object.entries(e).reduce((r,[n,s])=>(r[s]=n,r),{})}async function Fo(t){const{optionalImportsMap:e={},optionalImportEntrypoints:r=[],importMap:n={},secretsMap:s={},path:i=["$"]}=this,a=i.join(".");if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&t.lc===1&&t.type==="secret"){const o=t,[c]=o.id;if(c in s)return s[c];{const u=cn(c);if(u)return u;throw new Error(`Missing key "${c}" for ${a} in load(secretsMap={})`)}}else if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&t.lc===1&&t.type==="not_implemented"){const c=JSON.stringify(t);throw new Error(`Trying to load an object that doesn't implement serialization: ${a} -> ${c}`)}else if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&"kwargs"in t&&t.lc===1){const o=t,c=JSON.stringify(o),[u,...l]=o.id.slice().reverse(),d=l.reverse(),h={langchain_core:Bb,langchain:n};let p=null;const m=[d.join("/")];d[0]==="langchain_community"&&m.push(["langchain",...d.slice(1)].join("/"));const _=m.find(E=>E in e);if(Dx.concat(r).includes(d.join("/"))||_)if(_!==void 0)p=await e[_];else throw new Error(`Missing key "${d.join("/")}" for ${a} in load(optionalImportsMap={})`);else{let E;if(d[0]==="langchain"||d[0]==="langchain_core")E=h[d[0]],d.shift();else throw new Error(`Invalid namespace: ${a} -> ${c}`);if(d.length===0)throw new Error(`Invalid namespace: ${a} -> ${c}`);let b;do{if(b=d.join("__"),b in E)break;d.pop()}while(d.length>0);b in E&&(p=E[b])}if(typeof p!="object"||p===null)throw new Error(`Invalid namespace: ${a} -> ${c}`);const v=p[u]??Object.values(p).find(E=>typeof E=="function"&&Mc(E)===u);if(typeof v!="function")throw new Error(`Invalid identifer: ${a} -> ${c}`);const y=await Fo.call({...this,path:[...i,"kwargs"]},o.kwargs);if(o.type==="constructor"){const E=new v(z_(y,Ix,N$(v)));return Object.defineProperty(E.constructor,"name",{value:u}),E}else throw new Error(`Invalid type: ${a} -> ${c}`)}else if(typeof t=="object"&&t!==null)return Array.isArray(t)?Promise.all(t.map((o,c)=>Fo.call({...this,path:[...i,`${c}`]},o))):Object.fromEntries(await Promise.all(Object.entries(t).map(async([o,c])=>[o,await Fo.call({...this,path:[...i,o]},c)])));return t}async function $$(t,e){const r=JSON.parse(t);return Fo.call({...e},r)}function P$(t){return t!==null&&t.lc===1&&t.type==="constructor"&&Array.isArray(t.id)}async function ch(t){if(t&&typeof t=="object"){if(Array.isArray(t))return await Promise.all(t.map(r=>ch(r)));{const e={};for(const[r,n]of Object.entries(t))e[r]=await ch(n);if(e.lc===2&&e.type==="undefined")return;if(e.lc===2&&e.type==="constructor"&&Array.isArray(e.id))try{const r=e.id[e.id.length-1];let n;switch(r){case"Set":n=Set;break;case"Map":n=Map;break;case"RegExp":n=RegExp;break;case"Error":n=Error;break;default:return e}return e.method?n[e.method](...e.args||[]):new n(...e.args||[])}catch{return e}else if(P$(e))return $$(JSON.stringify(e));return e}}return t}function Jl(t,e,r,n){return{lc:2,type:"constructor",id:[t.name],method:e??null,args:r??[],kwargs:n??{}}}function L$(t){return t===void 0?{lc:2,type:"undefined"}:t instanceof Set||t instanceof Map?Jl(t.constructor,void 0,[Array.from(t)]):t instanceof RegExp?Jl(RegExp,void 0,[t.source,t.flags]):t instanceof Error?Jl(t.constructor,void 0,[t.message]):(t==null?void 0:t.lg_name)==="Send"?{node:t.node,args:t.args}:t}var D$=class{_dumps(t){return new TextEncoder().encode(vx(t,(r,n)=>L$(n)))}async dumpsTyped(t){return t instanceof Uint8Array?["bytes",t]:["json",this._dumps(t)]}async _loads(t){const e=JSON.parse(t);return ch(e)}async loadsTyped(t,e){if(t==="bytes")return typeof e=="string"?new TextEncoder().encode(e):e;if(t==="json")return this._loads(typeof e=="string"?e:new TextDecoder().decode(e));throw new Error(`Unknown serialization type: ${t}`)}};function Fb(t){if(typeof t!="object"||t===null)return t;const e=Array.isArray(t)?[]:{};for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=Fb(t[r]));return e}function jb(){return{v:4,id:j_(-2),ts:new Date().toISOString(),channel_values:{},channel_versions:{},versions_seen:{}}}function wc(t){return{v:t.v,id:t.id,ts:t.ts,channel_values:{...t.channel_values},channel_versions:{...t.channel_versions},versions_seen:Fb(t.versions_seen)}}function zb(t,e){return typeof t=="number"&&typeof e=="number"?Math.sign(t-e):String(t).localeCompare(String(e))}function M$(...t){return t.reduce((e,r,n)=>n===0?r:zb(e,r)>=0?e:r)}const U$={[mx]:-1,[Ro]:-2,[gx]:-3,[yx]:-4};var Fi=class extends Error{constructor(t){super(t),this.name="InvalidNamespaceError"}};function B$(t){if(t.length===0)throw new Fi("Namespace cannot be empty.");for(const e of t){if(typeof e!="string")throw new Fi(`Invalid namespace label '${e}' found in ${t}. Namespace labels must be strings, but got ${typeof e}.`);if(e.includes("."))throw new Fi(`Invalid namespace label '${e}' found in ${t}. Namespace labels cannot contain periods ('.').`);if(e==="")throw new Fi(`Namespace labels cannot be empty strings. Got ${e} in ${t}`)}if(t[0]==="langgraph")throw new Fi(`Root label for namespace cannot be "langgraph". Got: ${t}`)}var F$=class{async get(t,e){return(await this.batch([{namespace:t,key:e}]))[0]}async search(t,e={}){const{filter:r,limit:n=10,offset:s=0,query:i}=e;return(await this.batch([{namespacePrefix:t,filter:r,limit:n,offset:s,query:i}]))[0]}async put(t,e,r,n){B$(t),await this.batch([{namespace:t,key:e,value:r,index:n}])}async delete(t,e){await this.batch([{namespace:t,key:e,value:null}])}async listNamespaces(t={}){const{prefix:e,suffix:r,maxDepth:n,limit:s=100,offset:i=0}=t,a=[];return e&&a.push({matchType:"prefix",path:e}),r&&a.push({matchType:"suffix",path:r}),(await this.batch([{matchConditions:a.length?a:void 0,maxDepth:n,limit:s,offset:i}]))[0]}start(){}stop(){}};const j$=t=>"lg_name"in t&&t.lg_name==="AsyncBatchedStore"?t.store:t;var z$=class extends F${constructor(e){super();f(this,"lg_name","AsyncBatchedStore");f(this,"store");f(this,"queue",new Map);f(this,"nextKey",0);f(this,"running",!1);f(this,"processingTask",null);this.store=j$(e)}get isRunning(){return this.running}async batch(e){throw new Error("The `batch` method is not implemented on `AsyncBatchedStore`.\n Instead, it calls the `batch` method on the wrapped store.\n If you are seeing this error, something is wrong.")}async get(e,r){return this.enqueueOperation({namespace:e,key:r})}async search(e,r){const{filter:n,limit:s=10,offset:i=0,query:a}=r||{};return this.enqueueOperation({namespacePrefix:e,filter:n,limit:s,offset:i,query:a})}async put(e,r,n){return this.enqueueOperation({namespace:e,key:r,value:n})}async delete(e,r){return this.enqueueOperation({namespace:e,key:r,value:null})}start(){this.running||(this.running=!0,this.processingTask=this.processBatchQueue())}async stop(){this.running=!1,this.processingTask&&await this.processingTask}enqueueOperation(e){return new Promise((r,n)=>{const s=this.nextKey;this.nextKey+=1,this.queue.set(s,{operation:e,resolve:r,reject:n})})}async processBatchQueue(){for(;this.running;){if(await new Promise(r=>{setTimeout(r,0)}),this.queue.size===0)continue;const e=new Map(this.queue);this.queue.clear();try{const r=Array.from(e.values()).map(({operation:s})=>s),n=await this.store.batch(r);e.forEach(({resolve:s},i)=>{const a=Array.from(e.keys()).indexOf(i);s(n[a])})}catch(r){e.forEach(({reject:n})=>{n(r)})}}}toJSON(){return{queue:this.queue,nextKey:this.nextKey,running:this.running,store:"[LangGraphStore]"}}},V$=class{constructor(t){f(this,"serde",new D$);this.serde=t||this.serde}};function Vb(t){return t!=null&&t.lg_is_channel===!0}var Fs=class{constructor(){f(this,"ValueType");f(this,"UpdateType");f(this,"lg_is_channel",!0)}consume(){return!1}finish(){return!1}isAvailable(){try{return this.get(),!0}catch(t){if(t.name===Nt.unminifiable_name)return!1;throw t}}};const uh=Symbol.for("LG_IS_ONLY_BASE_CHANNEL");function Jf(t){if(t[uh]===!0)return t;const e={};for(const r in t){if(!Object.prototype.hasOwnProperty.call(t,r))continue;const n=t[r];Vb(n)&&(e[r]=n)}return Object.assign(e,{[uh]:!0}),e}function vc(t,e){const r=Jf(t),n={};for(const s in r){if(!Object.prototype.hasOwnProperty.call(r,s))continue;const i=e.channel_values[s];n[s]=r[s].fromCheckpoint(i)}return Object.assign(n,{[uh]:!0}),n}function ws(t,e,r,n){let s;if(e===void 0)s=t.channel_values;else{s={};for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i))try{s[i]=e[i].checkpoint()}catch(a){if(a.name!==Nt.unminifiable_name)throw a}}return{v:4,id:(n==null?void 0:n.id)??j_(r),ts:new Date().toISOString(),channel_values:s,channel_versions:t.channel_versions,versions_seen:t.versions_seen}}var lh=class Gb extends Fs{constructor(r,n){super();f(this,"lc_graph_name","BinaryOperatorAggregate");f(this,"value");f(this,"operator");f(this,"initialValueFactory");this.operator=r,this.initialValueFactory=n,this.value=n==null?void 0:n()}fromCheckpoint(r){const n=new Gb(this.operator,this.initialValueFactory);return typeof r<"u"&&(n.value=r),n}update(r){let n=r;if(!n.length)return!1;this.value===void 0&&([this.value]=n,n=n.slice(1));for(const s of n)this.value!==void 0&&(this.value=this.operator(this.value,s));return!0}get(){if(this.value===void 0)throw new Nt;return this.value}checkpoint(){if(this.value===void 0)throw new Nt;return this.value}isAvailable(){return this.value!==void 0}},Zf=class Hb extends Fs{constructor(){super(...arguments);f(this,"lc_graph_name","LastValue");f(this,"value",[])}fromCheckpoint(r){const n=new Hb;return typeof r<"u"&&(n.value=[r]),n}update(r){if(r.length===0)return!1;if(r.length!==1)throw new Xe("LastValue can only receive one value per step.",{lc_error_code:"INVALID_CONCURRENT_GRAPH_UPDATE"});return this.value=[r[r.length-1]],!0}get(){if(this.value.length===0)throw new Nt;return this.value[0]}checkpoint(){if(this.value.length===0)throw new Nt;return this.value[0]}isAvailable(){return this.value.length!==0}},G$=class qb extends Fs{constructor(){super(...arguments);f(this,"lc_graph_name","LastValueAfterFinish");f(this,"value",[]);f(this,"finished",!1)}fromCheckpoint(r){const n=new qb;if(typeof r<"u"){const[s,i]=r;n.value=[s],n.finished=i}return n}update(r){return r.length===0?!1:(this.finished=!1,this.value=[r[r.length-1]],!0)}get(){if(this.value.length===0||!this.finished)throw new Nt;return this.value[0]}checkpoint(){if(this.value.length!==0)return[this.value[0],this.finished]}consume(){return this.finished?(this.finished=!1,this.value=[],!0):!1}finish(){return!this.finished&&this.value.length>0?(this.finished=!0,!0):!1}isAvailable(){return this.value.length!==0&&this.finished}},H$=class{constructor(t){f(this,"lc_graph_name","AnnotationRoot");f(this,"spec");this.spec=t}};const nt=function(t){return t?dh(t):new Zf};nt.Root=t=>new H$(t);function dh(t){return typeof t=="object"&&t&&"reducer"in t&&t.reducer?new lh(t.reducer,t.default):typeof t=="object"&&t&&"value"in t&&t.value?new lh(t.value,t.default):new Zf}const Ge="__start__",Pe="__end__",bn="__input__",q$="__copy__",tr="__error__",Zl="__pregel_ns_writes",ts="__pregel_send",Kf="__pregel_call",As="__pregel_read",at="__pregel_checkpointer",qn="__pregel_resuming",na="__pregel_task_id",bc="__pregel_stream",W$="__pregel_resume_value",jo="__pregel_resume_map",rs="__pregel_scratchpad",zo="__pregel_previous",Wb="__pregel_durability",hh="checkpoint_id",rn="checkpoint_ns",J$="__pregel_node_finished",xr="checkpoint_map",sy="__pregel_abort_signals",Me="__interrupt__",sr="__resume__",Xf="__no_writes__",Ei="__return__",Kl="__previous__",ut="langsmith:hidden",Z$="langsmith:nostream",iy="__self__",Tr="__pregel_tasks",fr="__pregel_push",Vo="__pregel_pull",Ar="00000000-0000-0000-0000-000000000000",K$=[ut,bn,Me,sr,tr,Xf,ts,As,at,Wb,bc,qn,na,Kf,W$,rs,zo,xr,rn,hh],gt="|",kn=":",ay=Symbol.for("langgraph.command");var P_,X$=(P_=ay,class{constructor(t){f(this,P_);this[ay]=t}});function fh(t){const e=t;return e!=null&&typeof e.node=="string"&&e.args!==void 0}var Ec=class{constructor(t,e){f(this,"lg_name","Send");f(this,"node");f(this,"args");this.node=t,this.args=Aa(e)}toJSON(){return{lg_name:this.lg_name,node:this.node,args:this.args}}};function yr(t){return t instanceof Ec}function Jb(t){return!t||typeof t!="object"||!(Me in t)?!1:Array.isArray(t[Me])}var vd,Gt=(vd=class extends X${constructor(r){super(r);f(this,"lg_name","Command");f(this,"lc_direct_tool_output",!0);f(this,"graph");f(this,"update");f(this,"resume");f(this,"goto",[]);this.resume=r.resume,this.graph=r.graph,this.update=r.update,r.goto&&(this.goto=Array.isArray(r.goto)?Aa(r.goto):[Aa(r.goto)])}_updateAsTuples(){return this.update&&typeof this.update=="object"&&!Array.isArray(this.update)?Object.entries(this.update):Array.isArray(this.update)&&this.update.every(r=>Array.isArray(r)&&r.length===2&&typeof r[0]=="string")?this.update:[["__root__",this.update]]}toJSON(){var n;let r;return typeof this.goto=="string"?r=this.goto:yr(this.goto)?r=this.goto.toJSON():r=(n=this.goto)==null?void 0:n.map(s=>typeof s=="string"?s:s.toJSON()),{lg_name:this.lg_name,update:this.update,resume:this.resume,goto:r}}},f(vd,"PARENT","__parent__"),vd);function Yt(t){return typeof t!="object"||t==null?!1:"lg_name"in t&&t.lg_name==="Command"}function Aa(t,e=new Map){if(t!=null&&typeof t=="object"){if(e.has(t))return e.get(t);let r;if(Array.isArray(t))r=[],e.set(t,r),t.forEach((n,s)=>{r[s]=Aa(n,e)});else if(Yt(t)&&!(t instanceof Gt))r=new Gt(t),e.set(t,r);else if(fh(t)&&!(t instanceof Ec))r=new Ec(t.node,t.args),e.set(t,r);else if(Yt(t)||yr(t))r=t,e.set(t,r);else if("lc_serializable"in t&&t.lc_serializable)r=t,e.set(t,r);else{r={},e.set(t,r);for(const[n,s]of Object.entries(t))r[n]=Aa(s,e)}return r}return t}const Y$=["tags","metadata","callbacks","configurable"],Q$=["tags","metadata","callbacks","runName","maxConcurrency","recursionLimit","configurable","runId","outputKeys","streamMode","store","writer","interrupt","context","interruptBefore","interruptAfter","checkpointDuring","durability","signal"],eP=25;function Zb(...t){const e={tags:[],metadata:{},callbacks:void 0,recursionLimit:eP,configurable:{}},r=Et.getRunnableConfig();if(r!==void 0){for(const[n,s]of Object.entries(r))if(s!==void 0)if(Y$.includes(n)){let i;Array.isArray(s)?i=[...s]:typeof s=="object"?n==="callbacks"&&"copy"in s&&typeof s.copy=="function"?i=s.copy():i={...s}:i=s,e[n]=i}else e[n]=s}for(const n of t)if(n!==void 0)for(const[s,i]of Object.entries(n))i!==void 0&&Q$.includes(s)&&(e[s]=i);for(const[n,s]of Object.entries(e.configurable))e.metadata=e.metadata??{},!n.startsWith("__")&&(typeof s=="string"||typeof s=="number"||typeof s=="boolean")&&!(n in e.metadata)&&(e.metadata[n]=s);return e}function tP(){return Et.getRunnableConfig()}function Xl(t){return t.split(gt).filter(e=>!e.match(/^\d+$/)).map(e=>e.split(kn)[0]).join(gt)}function rP(t){const e=t.split(gt);for(;e.length>1&&e[e.length-1].match(/^\d+$/);)e.pop();return e.slice(0,-1).join(gt)}var js=class extends $e{constructor(e){super();f(this,"lc_namespace",["langgraph"]);f(this,"func");f(this,"tags");f(this,"config");f(this,"trace",!0);f(this,"recurse",!0);this.name=e.name??e.func.name,this.func=e.func,this.config=e.tags?{tags:e.tags}:void 0,this.trace=e.trace??this.trace,this.recurse=e.recurse??this.recurse}async _tracedInvoke(e,r,n){return new Promise((s,i)=>{const a=Fe(r,{callbacks:n==null?void 0:n.getChild()});Et.runWithConfig(a,async()=>{try{const o=await this.func(e,a);s(o)}catch(o){i(o)}})})}async invoke(e,r){let n;const s=Zb(r),i=Cr(this.config,s);return this.trace?n=await this._callWithConfig(this._tracedInvoke,e,i):n=await Et.runWithConfig(i,async()=>this.func(e,i)),$e.isRunnable(n)&&this.recurse?await Et.runWithConfig(i,async()=>n.invoke(e,i)):n}};function*zn(t,e){if(e===void 0)yield*t;else for(const r of t)yield[e,r]}async function Jn(t){const e=[];for await(const r of await t)e.push(r);return e}function Zi(t){const e=[];for(const r of t)e.push(r);return e}function Hs(t,e){return t?"configurable"in t?{...t,configurable:{...t.configurable,...e}}:{...t,configurable:e}:{configurable:e}}function nP(t){return typeof t=="object"&&(t==null?void 0:t[Symbol.for("LG_SKIP_WRITE")])!==void 0}const Cs={[Symbol.for("LG_PASSTHROUGH")]:!0};function yo(t){return typeof t=="object"&&(t==null?void 0:t[Symbol.for("LG_PASSTHROUGH")])!==void 0}const Yl=Symbol("IS_WRITER");var Vt=class ph extends js{constructor(r,n){const s=`ChannelWrite<${r.map(i=>yr(i)?i.node:"channel"in i?i.channel:"...").join(",")}>`;super({writes:r,name:s,tags:n,func:async(i,a)=>this._write(i,a??{})});f(this,"writes");this.writes=r}async _write(r,n){const s=this.writes.map(i=>Ql(i)&&yo(i.value)?{mapper:i.mapper,value:r}:Go(i)&&yo(i.value)?{channel:i.channel,value:r,skipNone:i.skipNone,mapper:i.mapper}:i);return await ph.doWrite(n,s),r}static async doWrite(r,n){var a;for(const o of n){if(Go(o)){if(o.channel===Tr)throw new Xe("Cannot write to the reserved channel TASKS");if(yo(o.value))throw new Xe("PASSTHROUGH value must be replaced")}if(Ql(o)&&yo(o.value))throw new Xe("PASSTHROUGH value must be replaced")}const s=[];for(const o of n)if(yr(o))s.push([Tr,o]);else if(Ql(o)){const c=await o.mapper.invoke(o.value,r);c!=null&&c.length>0&&s.push(...c)}else if(Go(o)){const c=o.mapper!==void 0?await o.mapper.invoke(o.value,r):o.value;if(nP(c)||o.skipNone&&c===void 0)continue;s.push([o.channel,c])}else throw new Error(`Invalid write entry: ${JSON.stringify(o)}`);((a=r.configurable)==null?void 0:a[ts])(s)}static isWriter(r){return r instanceof ph||Yl in r&&!!r[Yl]}static registerWriter(r){return Object.defineProperty(r,Yl,{value:!0})}};function Go(t){return t!==void 0&&typeof t.channel=="string"}function Ql(t){return t!==void 0&&!Go(t)&&$e.isRunnable(t.mapper)}var sP=class Kb extends js{constructor(r,n,s=!1){super({func:(i,a)=>Kb.doRead(a,this.channel,this.fresh,this.mapper)});f(this,"lc_graph_name","ChannelRead");f(this,"channel");f(this,"fresh",!1);f(this,"mapper");this.fresh=s,this.mapper=n,this.channel=r,this.name=Array.isArray(r)?`ChannelRead<${r.join(",")}>`:`ChannelRead<${r}>`}static doRead(r,n,s,i){var o;const a=(o=r.configurable)==null?void 0:o[As];if(!a)throw new Error("Runnable is not configured with a read function. Make sure to call in the context of a Pregel process");return i?i(a(n,s)):a(n,s)}};const qs=new $s;var Ca=class Ki extends os{constructor(r){var v;const{channels:n,triggers:s,mapper:i,writers:a,bound:o,kwargs:c,metadata:u,retryPolicy:l,cachePolicy:d,tags:h,subgraphs:p,ends:m}=r,_=[...(v=r.config)!=null&&v.tags?r.config.tags:[],...h??[]];super({...r,bound:r.bound??qs,config:{...r.config?r.config:{},tags:_}});f(this,"lc_graph_name","PregelNode");f(this,"channels");f(this,"triggers",[]);f(this,"mapper");f(this,"writers",[]);f(this,"bound",qs);f(this,"kwargs",{});f(this,"metadata",{});f(this,"tags",[]);f(this,"retryPolicy");f(this,"cachePolicy");f(this,"subgraphs");f(this,"ends");this.channels=n,this.triggers=s,this.mapper=i,this.writers=a??this.writers,this.bound=o??this.bound,this.kwargs=c??this.kwargs,this.metadata=u??this.metadata,this.tags=_,this.retryPolicy=l,this.cachePolicy=d,this.subgraphs=p,this.ends=m}getWriters(){var n;const r=[...this.writers];for(;r.length>1&&r[r.length-1]instanceof Vt&&r[r.length-2]instanceof Vt;){const s=r.slice(-2),i=s[0].writes.concat(s[1].writes);r[r.length-2]=new Vt(i,(n=s[0].config)==null?void 0:n.tags),r.pop()}return r}getNode(){const r=this.getWriters();if(!(this.bound===qs&&r.length===0))return this.bound===qs&&r.length===1?r[0]:this.bound===qs?new Pn({first:r[0],middle:r.slice(1,r.length-1),last:r[r.length-1],omitSequenceTags:!0}):r.length>0?new Pn({first:this.bound,middle:r.slice(0,r.length-1),last:r[r.length-1],omitSequenceTags:!0}):this.bound}join(r){if(!Array.isArray(r))throw new Error("channels must be a list");if(typeof this.channels!="object")throw new Error("all channels must be named when using .join()");return new Ki({channels:{...this.channels,...Object.fromEntries(r.map(n=>[n,n]))},triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound,kwargs:this.kwargs,config:this.config,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy})}pipe(r){return Vt.isWriter(r)?new Ki({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:[...this.writers,r],bound:this.bound,config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy}):this.bound===qs?new Ki({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:Ot(r),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy}):new Ki({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound.pipe(r),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy})}};function iP(t){return"steps"in t&&Array.isArray(t.steps)}function Yf(t){return"lg_is_pregel"in t&&t.lg_is_pregel===!0}function Xb(t){const e=[t];for(const r of e){if(Yf(r))return r;iP(r)&&e.push(...r.steps)}}const F=t=>BigInt(t),He=(t,e=0)=>new DataView(t.buffer,t.byteOffset+e,t.byteLength-e),Yb=F("0x9E3779B1"),Qb=F("0x85EBCA77"),aP=F("0xC2B2AE3D"),cs=F("0x9E3779B185EBCA87"),Ps=F("0xC2B2AE3D27D4EB4F"),eE=F("0x165667B19E3779F9"),Qf=F("0x85EBCA77C2B2AE63"),oP=F("0x27D4EB2F165667C5"),cP=F("0x165667919E3779F9"),uP=F("0x9FB21C651E98DF25"),lP=t=>{const e=t.length;if(e%2!==0)throw new Error("String should have an even number of characters");const r=e/2,n=new Uint8Array(r);let s=0,i=0;for(;i<r;){const a=t.slice(s,s+=2);n[i]=Number.parseInt(a,16),i+=1}return He(n)},en=lP("b8fe6c3923a44bbe7c01812cf721ad1cded46de9839097db7240a4a4b7b3671fcb79e64eccc0e578825ad07dccff7221b8084674f743248ee03590e6813a264c3c2852bb91c300cb88d0658b1b532ea371644897a20df94e3819ef46a9deacd8a8fa763fe39c343ff9dcbbc7c70b4f1d8a51e04bcdb45931c89f7ec9d9787364eac5ac8334d3ebc3c581a0fffa1363eb170ddd51b7f0da49d316552629d4689e2b16be587d47a1fc8ff8b8d17ad031ce45cb3a8f95160428afd7fbcabb4b407e"),ci=(F(1)<<F(128))-F(1),ke=(F(1)<<F(64))-F(1),Sc=(F(1)<<F(32))-F(1),En=64,tE=En/8,dP=8,_o=4;function Si(t){if(!t)throw new Error("Assert failed")}function hP(t){const e=new DataView(new ArrayBuffer(8));return e.setBigUint64(0,t,!0),e.getBigUint64(0,!1)}function fP(t){let e=t;return e=(e&F(65535))<<F(16)|(e&F(4294901760))>>F(16),e=(e&F(16711935))<<F(8)|(e&F(4278255360))>>F(8),e}function pP(t,e){return(t&Sc)*(e&Sc)&ke}function mP(t,e){return(t<<e|t>>F(32)-e)&Sc}function rE(t,e,r){for(let n=0;n<tE;n+=1){const s=e.getBigUint64(n*8,!0),i=s^r.getBigUint64(n*8,!0);t[n^1]+=s,t[n]+=pP(i,i>>F(32))}return t}function oy(t,e,r,n){for(let s=0;s<n;s+=1)rE(t,He(e,s*En),He(r,s*8));return t}function gP(t,e){for(let r=0;r<tE;r+=1){const n=e.getBigUint64(r*8,!0);let s=t[r];s=mh(s,F(47)),s^=n,s*=Yb,t[r]=s&ke}return t}function wo(t,e){return nE(t[0]^e.getBigUint64(0,!0),t[1]^e.getBigUint64(dP,!0))}function cy(t,e,r){let n=r;return n+=wo(t.slice(0),He(e,0*_o)),n+=wo(t.slice(2),He(e,4*_o)),n+=wo(t.slice(4),He(e,8*_o)),n+=wo(t.slice(6),He(e,12*_o)),an(n&ke)}function yP(t,e,r,n,s){let i=t;const a=Math.floor((r.byteLength-En)/8),o=En*a,c=Math.floor((e.byteLength-1)/o);for(let u=0;u<c;u+=1)i=oy(i,He(e,u*o),r,a),i=s(i,He(r,r.byteLength-En));{const u=Math.floor((e.byteLength-1-o*c)/En);i=oy(i,He(e,c*o),r,u),i=n(i,He(e,e.byteLength-En),He(r,r.byteLength-En-7))}return i}function _P(t,e){let r=new BigUint64Array([aP,cs,Ps,eE,Qf,Qb,oP,Yb]);Si(t.byteLength>128),r=yP(r,t,e,rE,gP),Si(r.length*8===64);{const n=cy(r,He(e,11),F(t.byteLength)*cs&ke);return cy(r,He(e,e.byteLength-En-11),~(F(t.byteLength)*Ps)&ke)<<F(64)|n}}function nE(t,e){const r=t*e&ci;return r&ke^r>>F(64)}function uy(t,e,r){return nE((t.getBigUint64(0,!0)^e.getBigUint64(0,!0)+r)&ke,(t.getBigUint64(8,!0)^e.getBigUint64(8,!0)-r)&ke)}function Ho(t,e,r,n,s){let i=t&ke,a=t>>F(64)&ke;return i+=uy(e,n,s),i^=r.getBigUint64(0,!0)+r.getBigUint64(8,!0),i&=ke,a+=uy(r,He(n,16),s),a^=e.getBigUint64(0,!0)+e.getBigUint64(8,!0),a&=ke,a<<F(64)|i}function an(t){let e=t;return e^=e>>F(37),e*=cP,e&=ke,e^=e>>F(32),e}function xc(t){let e=t;return e^=e>>F(33),e*=Ps,e&=ke,e^=e>>F(29),e*=eE,e&=ke,e^=e>>F(32),e}function wP(t,e,r){const n=t.byteLength;Si(n>0&&n<=3);const s=F(t.getUint8(n-1))|F(n<<8)|F(t.getUint8(0)<<16)|F(t.getUint8(n>>1)<<24),i=(F(e.getUint32(0,!0))^F(e.getUint32(4,!0)))+r,a=(s^i)&ke,o=(F(e.getUint32(8,!0))^F(e.getUint32(12,!0)))-r,c=(mP(fP(s),F(13))^o)&ke;return(xc(c)&ke)<<F(64)|xc(a)}function mh(t,e){return t^t>>e}function vP(t,e,r){const n=t.byteLength;Si(n>=4&&n<=8);{const s=t.getUint32(0,!0),i=t.getUint32(n-4,!0),a=F(s)|F(i)<<F(32),o=(e.getBigUint64(16,!0)^e.getBigUint64(24,!0))+r&ke;let u=(a^o)*(cs+(F(n)<<F(2)))&ci;return u+=(u&ke)<<F(65),u&=ci,u^=u>>F(67),mh(mh(u&ke,F(35))*uP&ke,F(28))|an(u>>F(64))<<F(64)}}function bP(t,e,r){const n=t.byteLength;Si(n>=9&&n<=16);{const s=(e.getBigUint64(32,!0)^e.getBigUint64(40,!0))+r&ke,i=(e.getBigUint64(48,!0)^e.getBigUint64(56,!0))-r&ke,a=t.getBigUint64(0,!0);let o=t.getBigUint64(n-8,!0),c=(a^o^s)*cs;const u=(c&ke)+(F(n-1)<<F(54));c=c&(ci^ke)|u,o^=i,c+=o+(o&Sc)*(Qb-F(1))<<F(64),c&=ci,c^=hP(c>>F(64));let l=(c&ke)*Ps;return l+=(c>>F(64))*Ps<<F(64),l&=ci,an(l&ke)|an(l>>F(64))<<F(64)}}function EP(t,e){const r=t.byteLength;return Si(r<=16),r>8?bP(t,en,e):r>=4?vP(t,en,e):r>0?wP(t,en,e):xc(e^en.getBigUint64(64,!0)^en.getBigUint64(72,!0))|xc(e^en.getBigUint64(80,!0)^en.getBigUint64(88,!0))<<F(64)}function gh(t){return~t+F(1)&ke}function SP(t,e,r){let n=F(t.byteLength)*cs&ke,s=F(t.byteLength-1)/F(32);for(;s>=0;){const o=Number(s);n=Ho(n,He(t,16*o),He(t,t.byteLength-16*(o+1)),He(e,32*o),r),s-=F(1)}let i=n+(n>>F(64))&ke;i=an(i);let a=(n&ke)*cs+(n>>F(64))*Qf+(F(t.byteLength)-r&ke)*Ps;return a&=ke,a=gh(an(a)),i|a<<F(64)}function xP(t,e,r){let n=F(t.byteLength)*cs&ke;for(let a=32;a<160;a+=32)n=Ho(n,He(t,a-32),He(t,a-16),He(e,a-32),r);n=an(n&ke)|an(n>>F(64))<<F(64);for(let a=160;a<=t.byteLength;a+=32)n=Ho(n,He(t,a-32),He(t,a-16),He(e,3+a-160),r);n=Ho(n,He(t,t.byteLength-16),He(t,t.byteLength-32),He(e,103),gh(r));let s=n+(n>>F(64))&ke;s=an(s);let i=(n&ke)*cs+(n>>F(64))*Qf+(F(t.byteLength)-r&ke)*Ps;return i&=ke,i=gh(an(i)),s|i<<F(64)}function ys(t,e=F(0)){const r=new TextEncoder,n=He(typeof t=="string"?r.encode(t):t),s=n.byteLength,i=a=>a.toString(16).padStart(32,"0");return s<=16?i(EP(n,e)):s<=128?i(SP(n,en,e)):s<=240?i(xP(n,en,e)):i(_P(n,en))}function sE(t){return/^[0-9a-f]{32}$/.test(t)}function ui(t,e,r=!0,n=!1){try{return t[e].get()}catch(s){if(s.name===Nt.unminifiable_name){if(n)return s;if(r)return null}throw s}}function Ls(t,e,r=!0){if(Array.isArray(e)){const n={};for(const s of e)try{n[s]=ui(t,s,!r)}catch(i){if(i.name===Nt.unminifiable_name)continue}return n}else return ui(t,e)}function*TP(t,e){if(t.graph===Gt.PARENT)throw new Xe("There is no parent graph.");if(t.goto){let r;Array.isArray(t.goto)?r=t.goto:r=[t.goto];for(const n of r)if(yr(n))yield[Ar,Tr,n];else if(typeof n=="string")yield[Ar,`branch:to:${n}`,"__start__"];else throw new Error(`In Command.send, expected Send or string, got ${typeof n}`)}if(t.resume)if(typeof t.resume=="object"&&Object.keys(t.resume).length&&Object.keys(t.resume).every(sE))for(const[r,n]of Object.entries(t.resume)){const s=e.filter(i=>i[0]===r&&i[1]===sr).map(i=>i[2]).slice(0,1)??[];s.push(n),yield[r,sr,s]}else yield[Ar,sr,t.resume];if(t.update){if(typeof t.update!="object"||!t.update)throw new Error("Expected cmd.update to be a dict mapping channel names to update values");if(Array.isArray(t.update))for(const[r,n]of t.update)yield[Ar,r,n];else for(const[r,n]of Object.entries(t.update))yield[Ar,r,n]}}function*iE(t,e){if(e!=null)if(Array.isArray(t)&&typeof e=="object"&&!Array.isArray(e))for(const r in e)t.includes(r)&&(yield[r,e[r]]);else{if(Array.isArray(t))throw new Error('Input chunk must be an object when "inputChannels" is an array');yield[t,e]}}function*ed(t,e,r){Array.isArray(t)?(e===!0||e.find(([n,s])=>t.includes(n)))&&(yield Ls(r,t)):(e===!0||e.some(([n,s])=>n===t))&&(yield ui(r,t))}function*AP(t,e,r){const n=e.filter(([o,c])=>{var u;return(o.config===void 0||!((u=o.config.tags)!=null&&u.includes(ut)))&&c[0][0]!==tr&&c[0][0]!==Me});if(!n.length)return;let s;n.some(([o])=>o.writes.some(([c,u])=>c===Ei))?s=n.flatMap(([o])=>o.writes.filter(([c,u])=>c===Ei).map(([c,u])=>[o.name,u])):Array.isArray(t)?s=n.flatMap(([o])=>{const{writes:c}=o,u={};for(const[l]of c)t.includes(l)&&(u[l]=(u[l]||0)+1);return Object.values(u).some(l=>l>1)?c.filter(([l])=>t.includes(l)).map(([l,d])=>[o.name,{[l]:d}]):[[o.name,Object.fromEntries(c.filter(([l])=>t.includes(l)))]]}):s=n.flatMap(([o])=>o.writes.filter(([c,u])=>c===t).map(([c,u])=>[o.name,u]));const i={};for(const[o,c]of s)o in i||(i[o]=[]),i[o].push(c);const a={};for(const o in i)if(i[o].length===1){const[c]=i[o];a[o]=c}else a[o]=i[o];r&&(a.__metadata__={cached:r}),yield a}function ep(t){const e=typeof t[Ge];if(e==="number")return 0;if(e==="string")return"";for(const r in t){if(!Object.prototype.hasOwnProperty.call(t,r))continue;const n=typeof t[r];if(n==="number")return 0;if(n==="string")return"";break}}function qo(t,e){if(Object.keys(t).length>0){const r=ep(e);return Object.fromEntries(Object.entries(e).filter(([n,s])=>s>(t[n]??r)))}else return e}function CP(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}function Fr(t,e){return t===null?{configurable:e}:(t==null?void 0:t.configurable)===void 0?{...t,configurable:e}:{...t,configurable:{...t.configurable,...e}}}function fs(t,e){var n,s;const r=(e==null?void 0:e.parents)??{};return Object.keys(r).length>0?Fr(t,{[xr]:{...r,[((n=t.configurable)==null?void 0:n.checkpoint_ns)??""]:(s=t.configurable)==null?void 0:s.checkpoint_id}}):t}function Tc(...t){const e=[...new Set(t.filter(Boolean))];if(e.length===0)return{signal:void 0,dispose:void 0};if(e.length===1)return{signal:e[0],dispose:void 0};const r=new AbortController,n=()=>{var a;const i=(a=e.find(o=>o.aborted))==null?void 0:a.reason;r.abort(i),e.forEach(o=>o.removeEventListener("abort",n))};e.forEach(i=>i.addEventListener("abort",n,{once:!0}));const s=e.find(i=>i.aborted);return s&&r.abort(s.reason),{signal:r.signal,dispose:()=>{e.forEach(i=>i.removeEventListener("abort",n))}}}const kP=(t,e)=>{if(!(!t&&!e))return t?e?Array.isArray(t)&&Array.isArray(e)?[...t,...e]:Array.isArray(t)?[...t,e]:Array.isArray(e)?[t,...e]:[t,e]:t:e};var IP=class{constructor({func:t,name:e,input:r,retry:n,cache:s,callbacks:i}){f(this,"func");f(this,"name");f(this,"input");f(this,"retry");f(this,"cache");f(this,"callbacks");f(this,"__lg_type","call");this.func=t,this.name=e,this.input=r,this.retry=n,this.cache=s,this.callbacks=i}};function RP(t){return typeof t=="object"&&t!==null&&"__lg_type"in t&&t.__lg_type==="call"}function OP(t,e){const r=new js({func:n=>e(...n),name:t,trace:!1,recurse:!1});return new Pn({name:t,first:r,last:new Vt([{channel:Ei,value:Cs}],[ut])})}const NP=t=>t!==void 0?t+1:1;function $P(t,e){if(e==null)return!1;for(const r of t)if(e[r])return!0;return!1}function PP(t){let e;for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e==null?e=t[r]:e=M$(e,t[r]));return e}function vo(t,e,r){const n=ep(t.channel_versions),s=t.versions_seen[Me]??{};let i=!1;if((t.channel_versions[Ge]??n)>(s[Ge]??n))i=!0;else for(const o in t.channel_versions)if(Object.prototype.hasOwnProperty.call(t.channel_versions,o)&&t.channel_versions[o]>(s[o]??n)){i=!0;break}const a=r.some(o=>{var c,u;return e==="*"?!((u=(c=o.config)==null?void 0:c.tags)!=null&&u.includes(ut)):e.includes(o.name)});return i&&a}function Wo(t,e,r,n,s=!1){let i=new Set;if(Array.isArray(n))i=new Set(n.filter(o=>r.writes.some(([c,u])=>c===o)));else{for(const[o]of r.writes)if(o===n){i=new Set([o]);break}i=i||new Set}let a;if(s&&i.size>0){const o=Object.fromEntries(Object.entries(e).filter(([l,d])=>i.has(l))),c=ws(t,o,-1),u=vc(o,c);hr(wc(c),u,[r],void 0,void 0),a=Ls({...e,...u},n)}else a=Ls(e,n);return a}function td(t,e,r){for(const[n,s]of r)if([fr,Tr].includes(n)&&s!=null){if(!yr(s))throw new Xe(`Invalid packet type, expected SendProtocol, got ${JSON.stringify(s)}`);if(!(s.node in e))throw new Xe(`Invalid node name "${s.node}" in Send packet`)}t(r)}const LP=new Set([Xf,fr,sr,Me,Ei,tr]);function hr(t,e,r,n,s){var h,p;r.sort((m,_)=>{var E,b;const v=((E=m.path)==null?void 0:E.slice(0,3))||[],y=((b=_.path)==null?void 0:b.slice(0,3))||[];for(let I=0;I<Math.min(v.length,y.length);I+=1){if(v[I]<y[I])return-1;if(v[I]>y[I])return 1}return v.length-y.length});const i=r.some(m=>m.triggers.length>0),a=Jf(e);for(const m of r){(h=t.versions_seen)[p=m.name]??(h[p]={});for(const _ of m.triggers)_ in t.channel_versions&&(t.versions_seen[m.name][_]=t.channel_versions[_])}let o=PP(t.channel_versions);const c=new Set(r.flatMap(m=>m.triggers).filter(m=>!K$.includes(m)));let u=!1;for(const m of c)m in a&&a[m].consume()&&n!==void 0&&(t.channel_versions[m]=n(o),u=!0);const l={};for(const m of r)for(const[_,v]of m.writes)LP.has(_)||_ in a&&(l[_]??(l[_]=[]),l[_].push(v));o!=null&&n!=null&&(o=u?n(o):o);const d=new Set;for(const[m,_]of Object.entries(l))if(m in a){const v=a[m];let y;try{y=v.update(_)}catch(E){if(E.name===Xe.unminifiable_name){const b=new Xe(`Invalid update for channel "${m}" with values ${JSON.stringify(_)}: ${E.message}`);throw b.lc_error_code=E.lc_error_code,b}else throw E}y&&n!==void 0&&(t.channel_versions[m]=n(o),v.isAvailable()&&d.add(m))}if(i)for(const m in a){if(!Object.prototype.hasOwnProperty.call(a,m))continue;const _=a[m];_.isAvailable()&&!d.has(m)&&_.update([])&&n!==void 0&&(t.channel_versions[m]=n(o),_.isAvailable()&&d.add(m))}if(i&&!$P(d,s))for(const m in a){if(!Object.prototype.hasOwnProperty.call(a,m))continue;const _=a[m];_.finish()&&n!==void 0&&(t.channel_versions[m]=n(o),_.isAvailable()&&d.add(m))}return d}function*DP(t,e,r){if(r.updatedChannels!=null&&r.triggerToNodes!=null){const s=new Set;for(const i of r.updatedChannels){const a=r.triggerToNodes[i];for(const o of a??[])s.add(o)}yield*[...s].sort();return}if(!(()=>{for(const s in t.channel_versions)if(t.channel_versions[s]!==null)return!1;return!0})())for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&(yield s)}function si(t,e,r,n,s,i,a){const o={},c=n[Tr];if(c!=null&&c.isAvailable()){const u=c.get().length;for(let l=0;l<u;l+=1){const d=yh([fr,l],t,e,r,n,s,i,a);d!==void 0&&(o[d.id]=d)}}for(const u of DP(t,r,a)){const l=yh([Vo,u],t,e,r,n,s,i,a);l!==void 0&&(o[l.id]=l)}return o}function yh(t,e,r,n,s,i,a,o){var p,m,_,v;const{step:c,checkpointer:u,manager:l}=o,d=i.configurable??{},h=d.checkpoint_ns??"";if(t[0]===fr&&RP(t[t.length-1])){const y=t[t.length-1],E=OP(y.name,y.func),b=[fr],I=h===""?y.name:`${h}${gt}${y.name}`,k=Ys(JSON.stringify([I,c.toString(),y.name,fr,t[1],t[2]]),e.id),R=`${I}${kn}${k}`,P=[...t.slice(0,3),!0],T={langgraph_step:c,langgraph_node:y.name,langgraph_triggers:b,langgraph_path:P,langgraph_checkpoint_ns:R};if(a){const H=[];return{name:y.name,input:y.input,proc:E,writes:H,config:Fe(Cr(i,{metadata:T,store:o.store??i.store}),{runName:y.name,callbacks:l==null?void 0:l.getChild(`graph:step:${c}`),configurable:{[na]:k,[ts]:se=>td(ee=>H.push(...ee),n,se),[As]:(se,ee=!1)=>Wo(e,s,{name:y.name,writes:H,triggers:b,path:P},se,ee),[at]:u??d[at],[xr]:{...d[xr],[h]:e.id},[rs]:rd({pendingWrites:r??[],taskId:k,currentTaskInput:y.input,resumeMap:(p=i.configurable)==null?void 0:p[jo],namespaceHash:ys(R)}),[zo]:e.channel_values[Kl],checkpoint_id:void 0,checkpoint_ns:R}}),triggers:b,retry_policy:y.retry,cache_key:y.cache?{key:ys((y.cache.keyFunc??JSON.stringify)([y.input])),ns:[Zl,y.name??"__dynamic__"],ttl:y.cache.ttl}:void 0,id:k,path:P,writers:[]}}else return{id:k,name:y.name,interrupts:[],path:P}}else if(t[0]===fr){const y=typeof t[1]=="number"?t[1]:parseInt(t[1],10);if(!((m=s[Tr])!=null&&m.isAvailable()))return;const E=s[Tr].get();if(y<0||y>=E.length)return;const b=fh(E[y])&&!yr(E[y])?new Ec(E[y].node,E[y].args):E[y];if(!fh(b)){console.warn(`Ignoring invalid packet ${JSON.stringify(b)} in pending sends.`);return}if(!(b.node in n)){console.warn(`Ignoring unknown node name ${b.node} in pending sends.`);return}const I=[fr],k=h===""?b.node:`${h}${gt}${b.node}`,R=Ys(JSON.stringify([k,c.toString(),b.node,fr,y.toString()]),e.id),P=`${k}${kn}${R}`;let T={langgraph_step:c,langgraph_node:b.node,langgraph_triggers:I,langgraph_path:t.slice(0,3),langgraph_checkpoint_ns:P};if(a){const H=n[b.node],q=H.getNode();if(q!==void 0){H.metadata!==void 0&&(T={...T,...H.metadata});const se=[];return{name:b.node,input:b.args,proc:q,subgraphs:H.subgraphs,writes:se,config:Fe(Cr(i,{metadata:T,tags:H.tags,store:o.store??i.store}),{runName:b.node,callbacks:l==null?void 0:l.getChild(`graph:step:${c}`),configurable:{[na]:R,[ts]:ee=>td(Te=>se.push(...Te),n,ee),[As]:(ee,Te=!1)=>Wo(e,s,{name:b.node,writes:se,triggers:I,path:t},ee,Te),[at]:u??d[at],[xr]:{...d[xr],[h]:e.id},[rs]:rd({pendingWrites:r??[],taskId:R,currentTaskInput:b.args,resumeMap:(_=i.configurable)==null?void 0:_[jo],namespaceHash:ys(P)}),[zo]:e.channel_values[Kl],checkpoint_id:void 0,checkpoint_ns:P}}),triggers:I,retry_policy:H.retryPolicy,cache_key:H.cachePolicy?{key:ys((H.cachePolicy.keyFunc??JSON.stringify)([b.args])),ns:[Zl,H.name??"__dynamic__",b.node],ttl:H.cachePolicy.ttl}:void 0,id:R,path:t,writers:H.getWriters()}}}else return{id:R,name:b.node,interrupts:[],path:t}}else if(t[0]===Vo){const y=t[1].toString(),E=n[y];if(E===void 0)return;if(r!=null&&r.length){const R=h===""?y:`${h}${gt}${y}`,P=Ys(JSON.stringify([R,c.toString(),y,Vo,y]),e.id);if(r.some(H=>H[0]===P&&H[1]!==tr))return}const b=ep(e.channel_versions);if(b===void 0)return;const I=e.versions_seen[y]??{},k=E.triggers.find(R=>s[R].isAvailable()?(e.channel_versions[R]??b)>(I[R]??b):!1);if(k!==void 0){const R=MP(E,s,a);if(R===void 0)return;const P=h===""?y:`${h}${gt}${y}`,T=Ys(JSON.stringify([P,c.toString(),y,Vo,[k]]),e.id),H=`${P}${kn}${T}`;let q={langgraph_step:c,langgraph_node:y,langgraph_triggers:[k],langgraph_path:t,langgraph_checkpoint_ns:H};if(a){const se=E.getNode();if(se!==void 0){E.metadata!==void 0&&(q={...q,...E.metadata});const ee=[];return{name:y,input:R,proc:se,subgraphs:E.subgraphs,writes:ee,config:Fe(Cr(i,{metadata:q,tags:E.tags,store:o.store??i.store}),{runName:y,callbacks:l==null?void 0:l.getChild(`graph:step:${c}`),configurable:{[na]:T,[ts]:Te=>td(M=>{ee.push(...M)},n,Te),[As]:(Te,M=!1)=>Wo(e,s,{name:y,writes:ee,triggers:[k],path:t},Te,M),[at]:u??d[at],[xr]:{...d[xr],[h]:e.id},[rs]:rd({pendingWrites:r??[],taskId:T,currentTaskInput:R,resumeMap:(v=i.configurable)==null?void 0:v[jo],namespaceHash:ys(H)}),[zo]:e.channel_values[Kl],checkpoint_id:void 0,checkpoint_ns:H}}),triggers:[k],retry_policy:E.retryPolicy,cache_key:E.cachePolicy?{key:ys((E.cachePolicy.keyFunc??JSON.stringify)([R])),ns:[Zl,E.name??"__dynamic__",y],ttl:E.cachePolicy.ttl}:void 0,id:T,path:t,writers:E.getWriters()}}}else return{id:T,name:y,interrupts:[],path:t}}}}function MP(t,e,r){let n;if(typeof t.channels=="object"&&!Array.isArray(t.channels)){n={};for(const[s,i]of Object.entries(t.channels))if(t.triggers.includes(i))try{n[s]=ui(e,i,!1)}catch(a){if(a.name===Nt.unminifiable_name)return;throw a}else if(i in e)try{n[s]=ui(e,i,!1)}catch(a){if(a.name===Nt.unminifiable_name)continue;throw a}}else if(Array.isArray(t.channels)){let s=!1;for(const i of t.channels)try{n=ui(e,i,!1),s=!0;break}catch(a){if(a.name===Nt.unminifiable_name)continue;throw a}if(!s)return}else throw new Error(`Invalid channels type, expected list or dict, got ${t.channels}`);return r&&t.mapper!==void 0&&(n=t.mapper(n)),n}function rd({pendingWrites:t,taskId:e,currentTaskInput:r,resumeMap:n,namespaceHash:s}){var c;const i=(c=t.find(([u,l])=>u===Ar&&l===sr))==null?void 0:c[2],o={callCounter:0,interruptCounter:-1,resume:(()=>{const u=t.filter(([l,d])=>l===e&&d===sr).flatMap(([l,d,h])=>h);if(n!=null&&s in n){const l=n[s];u.push(l)}return u})(),nullResume:i,subgraphCounter:0,currentTaskInput:r,consumeNullResume:()=>{if(o.nullResume)return delete o.nullResume,t.splice(t.findIndex(([u,l])=>u===Ar&&l===sr),1),i}};return o}const ka={blue:{start:"\x1B[34m",end:"\x1B[0m"},green:{start:"\x1B[32m",end:"\x1B[0m"},yellow:{start:"\x1B[33;1m",end:"\x1B[0m"}},Ia=(t,e)=>`${t.start}${e}${t.end}`;function*ly(t){var e;for(const{id:r,name:n,input:s,config:i,triggers:a,writes:o}of t){if((e=i==null?void 0:i.tags)!=null&&e.includes(ut))continue;const c=o.filter(([u,l])=>u===r&&l===Me).map(([,u])=>u);yield{id:r,name:n,input:s,triggers:a,interrupts:c}}}function UP(t){return typeof t!="object"||t===null?!1:"$writes"in t&&Array.isArray(t.$writes)}function aE(t){const e={};for(const[r,n]of t){const s=String(r);if(s in e){const i=UP(e[s])?e[s].$writes:[e[s]];i.push(n),e[s]={$writes:i}}else e[s]=n}return e}function*BP(t,e){var r;for(const[{id:n,name:s,config:i},a]of t)(r=i==null?void 0:i.tags)!=null&&r.includes(ut)||(yield{id:n,name:s,result:aE(a.filter(([o])=>Array.isArray(e)?e.includes(o):o===e)),interrupts:a.filter(o=>o[0]===Me).map(o=>o[1])})}function*FP(t,e,r,n,s,i,a,o){var d,h,p;function c(m){const _={};return m.callbacks!=null&&(_.callbacks=m.callbacks),m.configurable!=null&&(_.configurable=m.configurable),m.maxConcurrency!=null&&(_.max_concurrency=m.maxConcurrency),m.metadata!=null&&(_.metadata=m.metadata),m.recursionLimit!=null&&(_.recursion_limit=m.recursionLimit),m.runId!=null&&(_.run_id=m.runId),m.runName!=null&&(_.run_name=m.runName),m.tags!=null&&(_.tags=m.tags),_}const u=(d=t.configurable)==null?void 0:d.checkpoint_ns,l={};for(const m of s){if(!((h=m.subgraphs)!=null&&h.length?m.subgraphs:[m.proc]).find(Xb))continue;let v=`${m.name}:${m.id}`;u&&(v=`${u}|${v}`),l[m.id]={configurable:{thread_id:(p=t.configurable)==null?void 0:p.thread_id,checkpoint_ns:v}}}yield{config:c(t),values:Ls(e,r),metadata:n,next:s.map(m=>m.name),tasks:oE(s,i,l,o),parentConfig:a?c(a):void 0}}function oE(t,e,r,n){return t.map(s=>{var u;const i=(u=e.find(([l,d])=>l===s.id&&d===tr))==null?void 0:u[2],a=e.filter(([l,d])=>l===s.id&&d===Me).map(([,,l])=>l),o=(()=>{var d;if(i||a.length||!e.length)return;const l=e.findIndex(([h,p])=>h===s.id&&p===Ei);if(l>=0)return e[l][2];if(typeof n=="string")return(d=e.find(([h,p])=>h===s.id&&p===n))==null?void 0:d[2];if(Array.isArray(n)){const h=e.filter(([p,m])=>p===s.id&&n.includes(m)).map(([,p,m])=>[p,m]);return h.length?aE(h):void 0}})();if(i)return{id:s.id,name:s.name,path:s.path,error:i,interrupts:a,result:o};const c=r==null?void 0:r[s.id];return{id:s.id,name:s.name,path:s.path,interrupts:a,...c!==void 0?{state:c}:{},result:o}})}function jP(t,e,r){console.log([`${Ia(ka.blue,`[${t}:checkpoint]`)}`,`\x1B[1m State at the end of step ${t}:\x1B[0m
`,JSON.stringify(Ls(e,r),null,2)].join(""))}function cE(t,e){const r=e.length;console.log([`${Ia(ka.blue,`[${t}:tasks]`)}`,`\x1B[1m Starting step ${t} with ${r} task${r===1?"":"s"}:\x1B[0m
`,e.map(n=>`- ${Ia(ka.green,String(n.name))} -> ${JSON.stringify(n.input,null,2)}`).join(`
`)].join(""))}function zP(t,e,r){const n={};for(const[s,i]of e)r.includes(s)&&(n[s]||(n[s]=[]),n[s].push(i));console.log([`${Ia(ka.blue,`[${t}:writes]`)}`,`\x1B[1m Finished step ${t} with writes to ${Object.keys(n).length} channel${Object.keys(n).length!==1?"s":""}:\x1B[0m
`,Object.entries(n).map(([s,i])=>`- ${Ia(ka.yellow,s)} -> ${i.map(a=>JSON.stringify(a)).join(", ")}`).join(`
`)].join(""))}var dy=class extends ir{constructor(e,r){const n=e.getReader(),s=r??new AbortController;super({start(i){return a();function a(){return n.read().then(({done:o,value:c})=>{if(o){i.close();return}return i.enqueue(c),a()})}}});f(this,"_abortController");f(this,"_innerReader");this._abortController=s,this._innerReader=n}async cancel(e){this._abortController.abort(e),this._innerReader.releaseLock()}get signal(){return this._abortController.signal}},uE=class extends ir{constructor(e){let r;const n=new Promise(s=>{r=s});super({start:s=>{r(s)}});f(this,"modes");f(this,"controller");f(this,"passthroughFn");f(this,"_closed",!1);n.then(s=>{this.controller=s}),this.passthroughFn=e.passthroughFn,this.modes=e.modes}get closed(){return this._closed}push(e){var r;(r=this.passthroughFn)==null||r.call(this,e),this.controller.enqueue(e)}close(){try{this.controller.close()}catch{}finally{this._closed=!0}}error(e){this.controller.error(e)}};function VP(t){return JSON.stringify(t,function(e,r){const n=this[e];if(n!=null&&typeof n=="object"&&"toDict"in n&&typeof n.toDict=="function"){const{type:s,data:i}=n.toDict();return{...i,type:s}}return r})}function GP(t){return t instanceof Error?{error:t.name,message:t.message}:{error:"Error",message:JSON.stringify(t)}}function tp(t){return typeof t!="object"||t==null?!1:"configurable"in t&&typeof t.configurable=="object"&&t.configurable!=null}function nd(t){return!tp(t)||!t.configurable.thread_id?null:{thread_id:t.configurable.thread_id,checkpoint_ns:t.configurable.checkpoint_ns||"",checkpoint_id:t.configurable.checkpoint_id||null,checkpoint_map:t.configurable.checkpoint_map||null}}function hy(t){if(tp(t)){const e=Object.fromEntries(Object.entries(t.configurable).filter(([n])=>!n.startsWith("__"))),r={...t,configurable:e};return delete r.callbacks,r}return t}function fy(t){const e={...t,checkpoint:nd(t.config),parent_checkpoint:nd(t.parentConfig),config:hy(t.config),parent_config:hy(t.parentConfig),tasks:t.tasks.map(r=>{if(tp(r.state)){const n=nd(r.state);if(n!=null){const s={...r,checkpoint:n};return delete s.state,s}}return r})};return delete e.parentConfig,e}function HP(t){const e=new TextEncoder;return new ReadableStream({async start(r){const n=s=>{r.enqueue(e.encode(`event: ${s.event}
data: ${VP(s.data)}

`))};try{for await(const s of t){const[i,a,o]=s;let c=o;if(a==="debug"){const l=o;l.type==="checkpoint"&&(c={...l,payload:fy(l.payload)})}a==="checkpoints"&&(c=fy(o));const u=i!=null&&i.length?`${a}|${i.join("|")}`:a;n({event:u,data:c})}}catch(s){n({event:"error",data:GP(s)})}r.close()}})}const bo=Symbol.for("INPUT_DONE"),sd=Symbol.for("INPUT_RESUMING"),qP=25;function WP(...t){return new uE({passthroughFn:e=>{for(const r of t)r.modes.has(e[1])&&r.push(e)},modes:new Set(t.flatMap(e=>Array.from(e.modes)))})}var JP=class extends V${constructor(e){super();f(this,"cache");f(this,"queue",Promise.resolve());this.cache=e}async get(e){return this.enqueueOperation("get",e)}async set(e){return this.enqueueOperation("set",e)}async clear(e){return this.enqueueOperation("clear",e)}async stop(){await this.queue}enqueueOperation(e,...r){const n=this.queue.then(()=>this.cache[e](...r));return this.queue=n.then(()=>{},()=>{}),n}},ZP=class lE{constructor(e){f(this,"input");f(this,"output");f(this,"config");f(this,"checkpointer");f(this,"checkpointerGetNextVersion");f(this,"channels");f(this,"checkpoint");f(this,"checkpointIdSaved");f(this,"checkpointConfig");f(this,"checkpointMetadata");f(this,"checkpointNamespace");f(this,"checkpointPendingWrites",[]);f(this,"checkpointPreviousVersions");f(this,"step");f(this,"stop");f(this,"durability");f(this,"outputKeys");f(this,"streamKeys");f(this,"nodes");f(this,"skipDoneTasks");f(this,"prevCheckpointConfig");f(this,"updatedChannels");f(this,"status","pending");f(this,"tasks",{});f(this,"stream");f(this,"checkpointerPromises",[]);f(this,"isNested");f(this,"_checkpointerChainedPromise",Promise.resolve());f(this,"store");f(this,"cache");f(this,"manager");f(this,"interruptAfter");f(this,"interruptBefore");f(this,"toInterrupt",[]);f(this,"debug",!1);f(this,"triggerToNodes");this.input=e.input,this.checkpointer=e.checkpointer,this.checkpointer!==void 0?this.checkpointerGetNextVersion=this.checkpointer.getNextVersion.bind(this.checkpointer):this.checkpointerGetNextVersion=NP,this.checkpoint=e.checkpoint,this.checkpointMetadata=e.checkpointMetadata,this.checkpointPreviousVersions=e.checkpointPreviousVersions,this.channels=e.channels,this.checkpointPendingWrites=e.checkpointPendingWrites,this.step=e.step,this.stop=e.stop,this.config=e.config,this.checkpointConfig=e.checkpointConfig,this.isNested=e.isNested,this.manager=e.manager,this.outputKeys=e.outputKeys,this.streamKeys=e.streamKeys,this.nodes=e.nodes,this.skipDoneTasks=e.skipDoneTasks,this.store=e.store,this.cache=e.cache?new JP(e.cache):void 0,this.stream=e.stream,this.checkpointNamespace=e.checkpointNamespace,this.prevCheckpointConfig=e.prevCheckpointConfig,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.durability=e.durability,this.debug=e.debug,this.triggerToNodes=e.triggerToNodes}get isResuming(){var c,u,l,d,h;let e=!1;if(Ge in this.checkpoint.channel_versions)e=!0;else for(const p in this.checkpoint.channel_versions)if(Object.prototype.hasOwnProperty.call(this.checkpoint.channel_versions,p)){e=!0;break}const n=((c=this.config.configurable)==null?void 0:c[qn])!==void 0&&((u=this.config.configurable)==null?void 0:u[qn]),s=this.input===null||this.input===void 0,i=Yt(this.input)&&this.input.resume!=null,a=this.input===sd,o=!this.isNested&&((l=this.config.metadata)==null?void 0:l.run_id)!==void 0&&((d=this.checkpointMetadata)==null?void 0:d.run_id)!==void 0&&this.config.metadata.run_id===((h=this.checkpointMetadata)==null?void 0:h.run_id);return e&&(n||s||i||a||o)}static async initialize(e){var b,I,k,R,P,T,H,q,se,ee,Te,M;let{config:r,stream:n}=e;n!==void 0&&((b=r.configurable)==null?void 0:b[bc])!==void 0&&(n=WP(n,r.configurable[bc]));const s=r.configurable?!("checkpoint_id"in r.configurable):!0,i=(I=r.configurable)==null?void 0:I[rs];r.configurable&&i&&(i.subgraphCounter>0&&(r=Fr(r,{[rn]:[r.configurable[rn],i.subgraphCounter.toString()].join(gt)})),i.subgraphCounter+=1);const a=As in(r.configurable??{});!a&&((k=r.configurable)==null?void 0:k.checkpoint_ns)!==void 0&&((R=r.configurable)==null?void 0:R.checkpoint_ns)!==""&&(r=Fr(r,{checkpoint_ns:"",checkpoint_id:void 0}));let o=r;((P=r.configurable)==null?void 0:P[xr])!==void 0&&((q=(T=r.configurable)==null?void 0:T[xr])!=null&&q[(H=r.configurable)==null?void 0:H.checkpoint_ns])&&(o=Fr(r,{checkpoint_id:r.configurable[xr][(se=r.configurable)==null?void 0:se.checkpoint_ns]}));const c=((Te=(ee=r.configurable)==null?void 0:ee.checkpoint_ns)==null?void 0:Te.split(gt))??[],u=await((M=e.checkpointer)==null?void 0:M.getTuple(o))??{config:r,checkpoint:jb(),metadata:{source:"input",step:-2,parents:{}},pendingWrites:[]};o={...r,...u.config,configurable:{checkpoint_ns:"",...r.configurable,...u.config.configurable}};const l=u.parentConfig,d=wc(u.checkpoint),h={...u.metadata},p=u.pendingWrites??[],m=vc(e.channelSpecs,d),_=(h.step??0)+1,v=_+(r.recursionLimit??qP)+1,y={...d.channel_versions},E=e.store?new z$(e.store):void 0;return E&&await E.start(),new lE({input:e.input,config:r,checkpointer:e.checkpointer,checkpoint:d,checkpointMetadata:h,checkpointConfig:o,prevCheckpointConfig:l,checkpointNamespace:c,channels:m,isNested:a,manager:e.manager,skipDoneTasks:s,step:_,stop:v,checkpointPreviousVersions:y,checkpointPendingWrites:p,outputKeys:e.outputKeys??[],streamKeys:e.streamKeys??[],nodes:e.nodes,stream:n,store:E,cache:e.cache,interruptAfter:e.interruptAfter,interruptBefore:e.interruptBefore,durability:e.durability,debug:e.debug,triggerToNodes:e.triggerToNodes})}_checkpointerPutAfterPrevious(e){this._checkpointerChainedPromise=this._checkpointerChainedPromise.then(()=>{var r;return(r=this.checkpointer)==null?void 0:r.put(e.config,e.checkpoint,e.metadata,e.newVersions)}),this.checkpointerPromises.push(this._checkpointerChainedPromise)}putWrites(e,r){var a;let n=r;if(n.length===0)return;n.every(([o])=>o in U$)&&(n=Array.from(new Map(n.map(o=>[o[0],o])).values())),this.checkpointPendingWrites=this.checkpointPendingWrites.filter(o=>o[0]!==e);for(const[o,c]of n)this.checkpointPendingWrites.push([e,o,c]);const s=Fr(this.checkpointConfig,{[rn]:((a=this.config.configurable)==null?void 0:a.checkpoint_ns)??"",[hh]:this.checkpoint.id});if(this.durability!=="exit"&&this.checkpointer!=null&&this.checkpointerPromises.push(this.checkpointer.putWrites(s,n,e)),this.tasks&&this._outputWrites(e,n),!r.length||!this.cache||!this.tasks)return;const i=this.tasks[e];i==null||i.cache_key==null||r[0][0]===tr||r[0][0]===Me||this.cache.set([{key:[i.cache_key.ns,i.cache_key.key],value:i.writes,ttl:i.cache_key.ttl}])}_outputWrites(e,r,n=!1){var i,a;const s=this.tasks[e];if(s!==void 0){if(s.config!==void 0&&(s.config.tags??[]).includes(ut))return;if(r.length>0)if(r[0][0]===Me){if(((i=s.path)==null?void 0:i[0])===fr&&((a=s.path)==null?void 0:a.at(-1))===!0)return;const o=r.filter(c=>c[0]===Me).flatMap(c=>c[1]);this._emit([["updates",{[Me]:o}],["values",{[Me]:o}]])}else r[0][0]!==tr&&this._emit(Zi(zn(AP(this.outputKeys,[[s,r]],n),"updates")));n||this._emit(Zi(zn(BP([[s,r]],this.streamKeys),"tasks")))}}async _matchCachedWrites(){if(!this.cache)return[];const e=[],r=([a,o])=>`ns:${a.join(",")}|key:${o}`,n=[],s={};for(const a of Object.values(this.tasks))a.cache_key!=null&&!a.writes.length&&(n.push([a.cache_key.ns,a.cache_key.key]),s[r([a.cache_key.ns,a.cache_key.key])]=a);if(n.length===0)return[];const i=await this.cache.get(n);for(const{key:a,value:o}of i){const c=s[r(a)];c!=null&&(c.writes.push(...o),e.push({task:c,result:o}))}return e}async tick(e){var i,a,o;this.store&&!this.store.isRunning&&await((i=this.store)==null?void 0:i.start());const{inputKeys:r=[]}=e;if(this.status!=="pending")throw new Error(`Cannot tick when status is no longer "pending". Current status: "${this.status}"`);if(![bo,sd].includes(this.input))await this._first(r);else{if(this.toInterrupt.length>0)throw this.status="interrupt_before",new ai;if(Object.values(this.tasks).every(c=>c.writes.length>0)){const c=Object.values(this.tasks).flatMap(l=>l.writes);this.updatedChannels=hr(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion,this.triggerToNodes);const u=await Jn(zn(ed(this.outputKeys,c,this.channels),"values"));if(this._emit(u),this.checkpointPendingWrites=[],await this._putCheckpoint({source:"loop"}),vo(this.checkpoint,this.interruptAfter,Object.values(this.tasks)))throw this.status="interrupt_after",new ai;((a=this.config.configurable)==null?void 0:a[qn])!==void 0&&((o=this.config.configurable)==null||delete o[qn])}else return!1}if(this.step>this.stop)return this.status="out_of_steps",!1;const n=si(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.config,!0,{step:this.step,checkpointer:this.checkpointer,isResuming:this.isResuming,manager:this.manager,store:this.store,stream:this.stream,triggerToNodes:this.triggerToNodes,updatedChannels:this.updatedChannels});if(this.tasks=n,this.checkpointer&&this._emit(await Jn(zn(FP(this.checkpointConfig,this.channels,this.streamKeys,this.checkpointMetadata,Object.values(this.tasks),this.checkpointPendingWrites,this.prevCheckpointConfig,this.outputKeys),"checkpoints"))),Object.values(this.tasks).length===0)return this.status="done",!1;if(this.skipDoneTasks&&this.checkpointPendingWrites.length>0){for(const[c,u,l]of this.checkpointPendingWrites){if(u===tr||u===Me||u===sr)continue;const d=Object.values(this.tasks).find(h=>h.id===c);d&&d.writes.push([u,l])}for(const c of Object.values(this.tasks))c.writes.length>0&&this._outputWrites(c.id,c.writes,!0)}if(Object.values(this.tasks).every(c=>c.writes.length>0))return this.tick({inputKeys:r});if(vo(this.checkpoint,this.interruptBefore,Object.values(this.tasks)))throw this.status="interrupt_before",new ai;const s=await Jn(zn(ly(Object.values(this.tasks)),"tasks"));return this._emit(s),!0}async finishAndHandleError(e){this.durability==="exit"&&(!this.isNested||typeof e<"u"||this.checkpointNamespace.every(n=>!n.includes(kn)))&&(this._putCheckpoint(this.checkpointMetadata),this._flushPendingWrites());const r=this._suppressInterrupt(e);return(r||e===void 0)&&(this.output=Ls(this.channels,this.outputKeys)),r&&(this.tasks!==void 0&&this.checkpointPendingWrites.length>0&&Object.values(this.tasks).some(n=>n.writes.length>0)&&(this.updatedChannels=hr(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion,this.triggerToNodes),this._emit(Zi(zn(ed(this.outputKeys,Object.values(this.tasks).flatMap(n=>n.writes),this.channels),"values")))),Xs(e)&&!e.interrupts.length&&this._emit([["updates",{[Me]:[]}],["values",{[Me]:[]}]])),r}async acceptPush(e,r,n){var a,o;if(((a=this.interruptAfter)==null?void 0:a.length)>0&&vo(this.checkpoint,this.interruptAfter,[e])){this.toInterrupt.push(e);return}const s=yh([fr,e.path??[],r,e.id,n],this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,e.config??{},!0,{step:this.step,checkpointer:this.checkpointer,manager:this.manager,store:this.store,stream:this.stream});if(!s)return;if(((o=this.interruptBefore)==null?void 0:o.length)>0&&vo(this.checkpoint,this.interruptBefore,[s])){this.toInterrupt.push(s);return}this._emit(Zi(zn(ly([s]),"tasks"))),this.debug&&cE(this.step,[s]),this.tasks[s.id]=s,this.skipDoneTasks&&this._matchWrites({[s.id]:s});const i=await this._matchCachedWrites();for(const{task:c}of i)this._outputWrites(c.id,c.writes,!0);return s}_suppressInterrupt(e){return Xs(e)&&!this.isNested}async _first(e){var a;const{configurable:r}=this.config,n=r==null?void 0:r[rs];if(n&&n.nullResume!==void 0&&this.putWrites(Ar,[[sr,n.nullResume]]),Yt(this.input)){const o=this.input.resume!=null;if(this.input.resume!=null&&typeof this.input.resume=="object"&&Object.keys(this.input.resume).every(sE)&&((a=this.config).configurable??(a.configurable={}),this.config.configurable[jo]=this.input.resume),o&&this.checkpointer==null)throw new Error("Cannot use Command(resume=...) without checkpointer");const c={};for(const[u,l,d]of TP(this.input,this.checkpointPendingWrites))c[u]??(c[u]=[]),c[u].push([l,d]);if(Object.keys(c).length===0)throw new Cp("Received empty Command input");for(const[u,l]of Object.entries(c))this.putWrites(u,l)}const s=(this.checkpointPendingWrites??[]).filter(o=>o[0]===Ar).map(o=>o.slice(1));s.length>0&&hr(this.checkpoint,this.channels,[{name:bn,writes:s,triggers:[]}],this.checkpointerGetNextVersion,this.triggerToNodes);const i=Yt(this.input)&&s.length>0;if(this.isResuming||i){for(const c in this.channels)if(Object.prototype.hasOwnProperty.call(this.channels,c)&&this.checkpoint.channel_versions[c]!==void 0){const u=this.checkpoint.channel_versions[c];this.checkpoint.versions_seen[Me]={...this.checkpoint.versions_seen[Me],[c]:u}}const o=await Jn(zn(ed(this.outputKeys,!0,this.channels),"values"));this._emit(o)}if(this.isResuming)this.input=sd;else if(i)await this._putCheckpoint({source:"input"}),this.input=bo;else{const o=await Jn(iE(e,this.input));if(o.length>0){const c=si(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.config,!0,{step:this.step});this.updatedChannels=hr(this.checkpoint,this.channels,Object.values(c).concat([{name:bn,writes:o,triggers:[]}]),this.checkpointerGetNextVersion,this.triggerToNodes),await this._putCheckpoint({source:"input"}),this.input=bo}else if(qn in(this.config.configurable??{}))this.input=bo;else throw new Cp(`Received no input writes for ${JSON.stringify(e,null,2)}`)}this.isNested||(this.config=Fr(this.config,{[qn]:this.isResuming}))}_emit(e){for(const[r,n]of e)if(this.stream.modes.has(r)&&this.stream.push([this.checkpointNamespace,r,n]),(r==="checkpoints"||r==="tasks")&&this.stream.modes.has("debug")){const s=r==="checkpoints"?this.step-1:this.step,i=new Date().toISOString(),a=r==="checkpoints"?"checkpoint":typeof n=="object"&&n!=null&&"result"in n?"task_result":"task";this.stream.push([this.checkpointNamespace,"debug",{step:s,type:a,timestamp:i,payload:n}])}}_putCheckpoint(e){var i;const r=this.checkpointMetadata===e,n=this.checkpointer!=null&&(this.durability!=="exit"||r),s=a=>{var u,l,d;this.prevCheckpointConfig=(l=(u=this.checkpointConfig)==null?void 0:u.configurable)!=null&&l.checkpoint_id?this.checkpointConfig:void 0,this.checkpointConfig=Fr(this.checkpointConfig,{[rn]:((d=this.config.configurable)==null?void 0:d.checkpoint_ns)??""});const o={...this.checkpoint.channel_versions},c=qo(this.checkpointPreviousVersions,o);this.checkpointPreviousVersions=o,this._checkpointerPutAfterPrevious({config:{...this.checkpointConfig},checkpoint:wc(a),metadata:{...this.checkpointMetadata},newVersions:c}),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_id:this.checkpoint.id}}};r||(this.checkpointMetadata={...e,step:this.step,parents:((i=this.config.configurable)==null?void 0:i[xr])??{}}),this.checkpoint=ws(this.checkpoint,n?this.channels:void 0,this.step,r?{id:this.checkpoint.id}:void 0),n&&s(this.checkpoint),r||(this.step+=1)}_flushPendingWrites(){var n;if(this.checkpointer==null||this.checkpointPendingWrites.length===0)return;const e=Fr(this.checkpointConfig,{[rn]:((n=this.config.configurable)==null?void 0:n.checkpoint_ns)??"",[hh]:this.checkpoint.id}),r={};for(const[s,i,a]of this.checkpointPendingWrites)r[s]??(r[s]=[]),r[s].push([i,a]);for(const[s,i]of Object.entries(r))this.checkpointerPromises.push(this.checkpointer.putWrites(e,i,s))}_matchWrites(e){for(const[r,n,s]of this.checkpointPendingWrites){if(n===tr||n===Me||n===sr)continue;const i=Object.values(e).find(a=>a.id===r);i&&i.writes.push([n,s])}for(const r of Object.values(e))r.writes.length>0&&this._outputWrites(r.id,r.writes,!0)}};function KP(t){return vt(t==null?void 0:t.message)}var XP=class extends Ii{constructor(e){super();f(this,"name","StreamMessagesHandler");f(this,"streamFn");f(this,"metadatas",{});f(this,"seen",{});f(this,"emittedChatModelRunIds",{});f(this,"stableMessageIdMap",{});f(this,"lc_prefer_streaming",!0);this.streamFn=e}_emit(e,r,n,s=!1){var a;if(s&&r.id!==void 0&&this.seen[r.id]!==void 0)return;let i=r.id;n!=null&&(qh(r)?i??(i=`run-${n}-tool-${r.tool_call_id}`):((i==null||i===`run-${n}`)&&(i=this.stableMessageIdMap[n]??i??`run-${n}`),(a=this.stableMessageIdMap)[n]??(a[n]=i))),i!==r.id&&(r.id=i,r.lc_kwargs.id=i),r.id!=null&&(this.seen[r.id]=r),this.streamFn([e[0],"messages",[r,e[1]]])}handleChatModelStart(e,r,n,s,i,a,o,c){o&&(!a||!a.includes(Z$)&&!a.includes("nostream"))&&(this.metadatas[n]=[o.langgraph_checkpoint_ns.split("|"),{tags:a,name:c,...o}])}handleLLMNewToken(e,r,n,s,i,a){const o=a==null?void 0:a.chunk;this.emittedChatModelRunIds[n]=!0,this.metadatas[n]!==void 0&&(KP(o)?this._emit(this.metadatas[n],o.message,n):this._emit(this.metadatas[n],new $t({content:e}),n))}handleLLMEnd(e,r){var n,s;if(this.metadatas[r]!==void 0){if(!this.emittedChatModelRunIds[r]){const i=(s=(n=e.generations)==null?void 0:n[0])==null?void 0:s[0];vt(i==null?void 0:i.message)&&this._emit(this.metadatas[r],i==null?void 0:i.message,r,!0),delete this.emittedChatModelRunIds[r]}delete this.metadatas[r],delete this.stableMessageIdMap[r]}}handleLLMError(e,r){delete this.metadatas[r]}handleChainStart(e,r,n,s,i,a,o,c){if(a!==void 0&&c===a.langgraph_node&&(i===void 0||!i.includes(ut))&&(this.metadatas[n]=[a.langgraph_checkpoint_ns.split("|"),{tags:i,name:c,...a}],typeof r=="object")){for(const u of Object.values(r))if((vt(u)||la(u))&&u.id!==void 0)this.seen[u.id]=u;else if(Array.isArray(u))for(const l of u)(vt(l)||la(l))&&l.id!==void 0&&(this.seen[l.id]=l)}}handleChainEnd(e,r){const n=this.metadatas[r];if(delete this.metadatas[r],n!==void 0){if(vt(e))this._emit(n,e,r,!0);else if(Array.isArray(e))for(const s of e)vt(s)&&this._emit(n,s,r,!0);else if(e!=null&&typeof e=="object"){for(const s of Object.values(e))if(vt(s))this._emit(n,s,r,!0);else if(Array.isArray(s))for(const i of s)vt(i)&&this._emit(n,i,r,!0)}}}handleChainError(e,r){delete this.metadatas[r]}};const YP=500,QP=2,e2=128e3,t2=3,r2=[400,401,402,403,404,405,406,407,409],n2=t=>{var r,n;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||t.name==="GraphValueError"||(t==null?void 0:t.code)==="ECONNABORTED")return!1;const e=((r=t==null?void 0:t.response)==null?void 0:r.status)??(t==null?void 0:t.status);return!(e&&r2.includes(+e)||((n=t==null?void 0:t.error)==null?void 0:n.code)==="insufficient_quota")};async function dE(t,e,r,n){var l;const s=t.retry_policy??e;let i=s!==void 0?s.initialInterval??YP:0,a=0,o,c,{config:u}=t;for(r&&(u=Fr(u,r)),u={...u,signal:n};!(n!=null&&n.aborted);){t.writes.splice(0,t.writes.length),o=void 0;try{c=await t.proc.invoke(t.input,u);break}catch(d){if(o=d,o.pregelTaskId=t.id,ZS(o)){const _=(l=u==null?void 0:u.configurable)==null?void 0:l.checkpoint_ns,v=o.command;if(v.graph===_){for(const y of t.writers)await y.invoke(v,u);o=void 0;break}else if(v.graph===Gt.PARENT){const y=rP(_);o.command=new Gt({...o.command,graph:y})}}if(Io(o)||s===void 0||(a+=1,a>=(s.maxAttempts??t2))||!(s.retryOn??n2)(o))break;i=Math.min(s.maxInterval??e2,i*(s.backoffFactor??QP));const p=s.jitter?Math.floor(i+Math.random()*1e3):i;await new Promise(_=>setTimeout(_,p));const m=o.name??o.constructor.unminifiable_name??o.constructor.name;((s==null?void 0:s.logWarning)??!0)&&console.log(`Retrying task "${String(t.name)}" after ${i.toFixed(2)}ms (attempt ${a}) after ${m}: ${o}`),u=Fr(u,{[qn]:!0})}}return{task:t,result:c,error:o,signalAborted:n==null?void 0:n.aborted}}const _h=Symbol.for("promiseAdded");function s2(){const t={next:()=>{},wait:Promise.resolve(_h)};function e(r){t.next=()=>{t.wait=new Promise(e),r(_h)}}return t.wait=new Promise(e),t}var i2=class{constructor({loop:t,nodeFinished:e}){f(this,"nodeFinished");f(this,"loop");this.loop=t,this.nodeFinished=e}async tick(t={}){const{timeout:e,retryPolicy:r,onStepWrite:n,maxConcurrency:s}=t,i=new Set;let a;const o=new AbortController,c=o.signal,u=e?AbortSignal.timeout(e):void 0,l=Object.values(this.loop.tasks).filter(m=>m.writes.length===0),{signals:d,disposeCombinedSignal:h}=this._initializeAbortSignals({exceptionSignal:c,stepTimeoutSignal:u,signal:t.signal}),p=this._executeTasksWithRetry(l,{signals:d,retryPolicy:r,maxConcurrency:s});for await(const{task:m,error:_,signalAborted:v}of p)this._commit(m,_),Xs(_)||Io(_)&&!Xs(a)?a=_:_&&(i.size===0||!v)&&(o.abort(),i.add(_));if(h==null||h(),n==null||n(this.loop.step,Object.values(this.loop.tasks).map(m=>m.writes).flat()),i.size===1)throw Array.from(i)[0];if(i.size>1)throw new AggregateError(Array.from(i),`Multiple errors occurred during superstep ${this.loop.step}. See the "errors" field of this exception for more details.`);if(Xs(a)||Io(a)&&this.loop.isNested)throw a}_initializeAbortSignals({exceptionSignal:t,stepTimeoutSignal:e,signal:r}){var u;const n=((u=this.loop.config.configurable)==null?void 0:u[sy])??{},s=n.externalAbortSignal??r,i=e??n.timeoutAbortSignal,{signal:a,dispose:o}=Tc(s,i,t),c={externalAbortSignal:s,timeoutAbortSignal:i,composedAbortSignal:a};return this.loop.config=Fr(this.loop.config,{[sy]:c}),{signals:c,disposeCombinedSignal:o}}async*_executeTasksWithRetry(t,e){var h,p,m;const{retryPolicy:r,maxConcurrency:n,signals:s}=e??{},i=s2(),a={},o={executingTasksMap:a,barrier:i,retryPolicy:r,scheduleTask:async(_,v,y)=>this.loop.acceptPush(_,v,y)};if((h=s==null?void 0:s.composedAbortSignal)!=null&&h.aborted)throw new Error("Abort");let c=0,u;const l=Tc(s==null?void 0:s.externalAbortSignal,s==null?void 0:s.timeoutAbortSignal),d=l.signal?new Promise((_,v)=>{var y;u=()=>v(new Error("Abort")),(y=l.signal)==null||y.addEventListener("abort",u,{once:!0})}):void 0;for(;(c===0||Object.keys(a).length>0)&&t.length;){for(;Object.values(a).length<(n??t.length)&&c<t.length;c+=1){const v=t[c];a[v.id]=dE(v,r,{[Kf]:Jo==null?void 0:Jo.bind(o,this,v)},s==null?void 0:s.composedAbortSignal).catch(y=>{var E;return{task:v,error:y,signalAborted:(E=s==null?void 0:s.composedAbortSignal)==null?void 0:E.aborted}})}const _=await Promise.race([...Object.values(a),...d?[d]:[],i.wait]);_!==_h&&(yield _,u!=null&&((p=l.signal)==null||p.removeEventListener("abort",u),(m=l.dispose)==null||m.call(l)),delete a[_.task.id])}}_commit(t,e){var r;if(e!==void 0)if(Xs(e)){if(e.interrupts.length){const n=e.interrupts.map(i=>[Me,i]),s=t.writes.filter(i=>i[0]===sr);s.length&&n.push(...s),this.loop.putWrites(t.id,n)}}else Io(e)&&t.writes.length?this.loop.putWrites(t.id,t.writes):this.loop.putWrites(t.id,[[tr,{message:e.message,name:e.name}]]);else this.nodeFinished&&(((r=t.config)==null?void 0:r.tags)==null||!t.config.tags.includes(ut))&&this.nodeFinished(String(t.name)),t.writes.length===0&&t.writes.push([Xf,null]),this.loop.putWrites(t.id,t.writes)}};async function Jo(t,e,r,n,s,i={}){var d,h;const a=(h=(d=e.config)==null?void 0:d.configurable)==null?void 0:h[rs];if(!a)throw new Error(`BUG: No scratchpad found on task ${e.name}__${e.id}`);const o=a.callCounter;a.callCounter+=1;const c=new IP({func:r,name:n,input:s,cache:i.cache,retry:i.retry,callbacks:i.callbacks}),u=await this.scheduleTask(e,o,c);if(!u)return;const l=this.executingTasksMap[u.id];if(l!==void 0)return l;if(u.writes.length>0){const p=u.writes.filter(([_])=>_===Ei),m=u.writes.filter(([_])=>_===tr);if(p.length>0){if(p.length===1)return Promise.resolve(p[0][1]);throw new Error(`BUG: multiple returns found for task ${u.name}__${u.id}`)}if(m.length>0){if(m.length===1){const _=m[0][1],v=_ instanceof Error?_:new Error(String(_));return Promise.reject(v)}throw new Error(`BUG: multiple errors found for task ${u.name}__${u.id}`)}return}else{const p=dE(u,i.retry,{[Kf]:Jo.bind(this,t,u)});return this.executingTasksMap[u.id]=p,this.barrier.next(),p.then(({result:m,error:_})=>_?Promise.reject(_):m)}}var _n=class extends Error{constructor(t){super(t),this.name="GraphValidationError"}};function a2({nodes:t,channels:e,inputChannels:r,outputChannels:n,streamChannels:s,interruptAfterNodes:i,interruptBeforeNodes:a}){if(!e)throw new _n("Channels not provided");const o=new Set,c=new Set;for(const[u,l]of Object.entries(t)){if(u===Me)throw new _n(`"Node name ${Me} is reserved"`);if(l.constructor===Ca)l.triggers.forEach(d=>o.add(d));else throw new _n(`Invalid node type ${typeof l}, expected PregelNode`)}for(const u of o)if(!(u in e))throw new _n(`Subscribed channel '${String(u)}' not in channels`);if(Array.isArray(r)){if(r.every(u=>!o.has(u)))throw new _n(`None of the input channels ${r} are subscribed to by any node`)}else if(!o.has(r))throw new _n(`Input channel ${String(r)} is not subscribed to by any node`);Array.isArray(n)?n.forEach(u=>c.add(u)):c.add(n),s&&!Array.isArray(s)?c.add(s):Array.isArray(s)&&s.forEach(u=>c.add(u));for(const u of c)if(!(u in e))throw new _n(`Output channel '${String(u)}' not in channels`);if(i&&i!=="*"){for(const u of i)if(!(u in t))throw new _n(`Node ${String(u)} not in nodes`)}if(a&&a!=="*"){for(const u of a)if(!(u in t))throw new _n(`Node ${String(u)} not in nodes`)}}function py(t,e){if(Array.isArray(t)){for(const r of t)if(!(r in e))throw new Error(`Key ${String(r)} not found in channels`)}else if(!(t in e))throw new Error(`Key ${String(t)} not found in channels`)}var o2=class hE extends Fs{constructor(r){super();f(this,"lc_graph_name","Topic");f(this,"unique",!1);f(this,"accumulate",!1);f(this,"seen");f(this,"values");this.unique=(r==null?void 0:r.unique)??this.unique,this.accumulate=(r==null?void 0:r.accumulate)??this.accumulate,this.seen=new Set,this.values=[]}fromCheckpoint(r){const n=new hE({unique:this.unique,accumulate:this.accumulate});return typeof r<"u"&&(n.seen=new Set(r[0]),n.values=r[1]),n}update(r){let n=!1;this.accumulate||(n=this.values.length>0,this.values=[]);const s=r.flat();if(s.length>0)if(this.unique)for(const i of s)this.seen.has(i)||(n=!0,this.seen.add(i),this.values.push(i));else n=!0,this.values.push(...s);return n}get(){if(this.values.length===0)throw new Nt;return this.values}checkpoint(){return[[...this.seen],this.values]}isAvailable(){return this.values.length!==0}};function c2(t){var c,u,l;const e=Et.getRunnableConfig();if(!e)throw new Error("Called interrupt() outside the context of a graph.");const r=e.configurable;if(!r)throw new Error("No configurable found in config");if(!r[at])throw new ko("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=r[rs];s.interruptCounter+=1;const i=s.interruptCounter;if(s.resume.length>0&&i<s.resume.length)return(c=r[ts])==null||c.call(r,[[sr,s.resume]]),s.resume[i];if(s.nullResume!==void 0){if(s.resume.length!==i)throw new Error(`Resume length mismatch: ${s.resume.length} !== ${i}`);const d=s.consumeNullResume();return s.resume.push(d),(u=r[ts])==null||u.call(r,[[sr,s.resume]]),d}const a=(l=r[rn])==null?void 0:l.split(gt),o=a?ys(a.join(gt)):void 0;throw new ai([{id:o,value:t}])}var u2=class{static subscribeTo(t,e){const{key:r,tags:n}={key:void 0,tags:void 0,...e??{}};if(Array.isArray(t)&&r!==void 0)throw new Error("Can't specify a key when subscribing to multiple channels");let s;typeof t=="string"?r?s={[r]:t}:s=[t]:s=Object.fromEntries(t.map(a=>[a,a]));const i=Array.isArray(t)?t:[t];return new Ca({channels:s,triggers:i,tags:n})}static writeTo(t,e){const r=[];for(const n of t)r.push({channel:n,value:Cs,skipNone:!1});for(const[n,s]of Object.entries(e??{}))$e.isRunnable(s)||typeof s=="function"?r.push({channel:n,value:Cs,skipNone:!0,mapper:Ot(s)}):r.push({channel:n,value:s,skipNone:!1});return new Vt(r)}},l2=class extends $e{constructor(){super(...arguments);f(this,"lc_namespace",["langgraph","pregel"])}invoke(e,r){throw new Error("Not implemented")}withConfig(e){return super.withConfig(e)}stream(e,r){return super.stream(e,r)}},d2=class extends l2{constructor(e){super(e);f(this,"lc_namespace",["langgraph","pregel"]);f(this,"lg_is_pregel",!0);f(this,"nodes");f(this,"channels");f(this,"inputChannels");f(this,"outputChannels");f(this,"autoValidate",!0);f(this,"streamMode",["values"]);f(this,"streamChannels");f(this,"interruptAfter");f(this,"interruptBefore");f(this,"stepTimeout");f(this,"debug",!1);f(this,"checkpointer");f(this,"retryPolicy");f(this,"config");f(this,"store");f(this,"cache");f(this,"userInterrupt");f(this,"triggerToNodes",{});let{streamMode:r}=e;if(r!=null&&!Array.isArray(r)&&(r=[r]),this.nodes=e.nodes,this.channels=e.channels,Tr in this.channels&&"lc_graph_name"in this.channels[Tr]&&this.channels[Tr].lc_graph_name!=="Topic")throw new Error(`Channel '${Tr}' is reserved and cannot be used in the graph.`);this.channels[Tr]=new o2({accumulate:!1}),this.autoValidate=e.autoValidate??this.autoValidate,this.streamMode=r??this.streamMode,this.inputChannels=e.inputChannels,this.outputChannels=e.outputChannels,this.streamChannels=e.streamChannels??this.streamChannels,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.stepTimeout=e.stepTimeout??this.stepTimeout,this.debug=e.debug??this.debug,this.checkpointer=e.checkpointer,this.retryPolicy=e.retryPolicy,this.config=e.config,this.store=e.store,this.cache=e.cache,this.name=e.name,this.triggerToNodes=e.triggerToNodes??this.triggerToNodes,this.userInterrupt=e.userInterrupt,this.autoValidate&&this.validate()}static lc_name(){return"LangGraph"}withConfig(e){const r=Cr(this.config,e);return new this.constructor({...this,config:r})}validate(){var e;a2({nodes:this.nodes,channels:this.channels,outputChannels:this.outputChannels,inputChannels:this.inputChannels,streamChannels:this.streamChannels,interruptAfterNodes:this.interruptAfter,interruptBeforeNodes:this.interruptBefore});for(const[r,n]of Object.entries(this.nodes))for(const s of n.triggers)(e=this.triggerToNodes)[s]??(e[s]=[]),this.triggerToNodes[s].push(r);return this}get streamChannelsList(){return Array.isArray(this.streamChannels)?this.streamChannels:this.streamChannels?[this.streamChannels]:Object.keys(this.channels)}get streamChannelsAsIs(){return this.streamChannels?this.streamChannels:Object.keys(this.channels)}async getGraphAsync(e){return this.getGraph(e)}*getSubgraphs(e,r){var n;for(const[s,i]of Object.entries(this.nodes)){if(e!==void 0&&!e.startsWith(s))continue;const a=(n=i.subgraphs)!=null&&n.length?i.subgraphs:[i.bound];for(const o of a){const c=Xb(o);if(c!==void 0){if(s===e){yield[s,c];return}if(e===void 0&&(yield[s,c]),r){let u=e;e!==void 0&&(u=e.slice(s.length+1));for(const[l,d]of c.getSubgraphs(u,r))yield[`${s}${gt}${l}`,d]}}}}}async*getSubgraphsAsync(e,r){yield*this.getSubgraphs(e,r)}async _prepareStateSnapshot({config:e,saved:r,subgraphCheckpointer:n,applyPendingWrites:s=!1}){var h,p,m,_,v,y,E,b;if(r===void 0)return{values:{},next:[],config:e,tasks:[]};const i=vc(this.channels,r.checkpoint);if((h=r.pendingWrites)!=null&&h.length){const I=r.pendingWrites.filter(([k,R])=>k===Ar).map(([k,R,P])=>[String(R),P]);I.length>0&&hr(r.checkpoint,i,[{name:bn,writes:I,triggers:[]}],void 0,this.triggerToNodes)}const a=Object.values(si(r.checkpoint,r.pendingWrites,this.nodes,i,r.config,!0,{step:(((p=r.metadata)==null?void 0:p.step)??-1)+1,store:this.store})),o=await Jn(this.getSubgraphsAsync()),c=((m=r.config.configurable)==null?void 0:m.checkpoint_ns)??"",u={};for(const I of a){const k=o.find(([P])=>P===I.name);if(!k)continue;let R=`${String(I.name)}${kn}${I.id}`;if(c&&(R=`${c}${gt}${R}`),n===void 0){const P={configurable:{thread_id:(_=r.config.configurable)==null?void 0:_.thread_id,checkpoint_ns:R}};u[I.id]=P}else{const P={configurable:{[at]:n,thread_id:(v=r.config.configurable)==null?void 0:v.thread_id,checkpoint_ns:R}},T=k[1];u[I.id]=await T.getState(P,{subgraphs:!0})}}if(s&&((y=r.pendingWrites)!=null&&y.length)){const I=Object.fromEntries(a.map(R=>[R.id,R]));for(const[R,P,T]of r.pendingWrites)[tr,Me,Ro].includes(P)||R in I&&I[R].writes.push([String(P),T]);const k=a.filter(R=>R.writes.length>0);k.length>0&&hr(r.checkpoint,i,k,void 0,this.triggerToNodes)}let l=r==null?void 0:r.metadata;l&&((b=(E=r==null?void 0:r.config)==null?void 0:E.configurable)!=null&&b.thread_id)&&(l={...l,thread_id:r.config.configurable.thread_id});const d=a.filter(I=>I.writes.length===0).map(I=>I.name);return{values:Ls(i,this.streamChannelsAsIs),next:d,tasks:oE(a,(r==null?void 0:r.pendingWrites)??[],u,this.streamChannelsAsIs),metadata:l,config:fs(r.config,r.metadata),createdAt:r.checkpoint.ts,parentConfig:r.parentConfig}}async getState(e,r){var c,u,l,d;const n=((c=e.configurable)==null?void 0:c[at])??this.checkpointer;if(!n)throw new ko("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=((u=e.configurable)==null?void 0:u.checkpoint_ns)??"";if(s!==""&&((l=e.configurable)==null?void 0:l[at])===void 0){const h=Xl(s);for await(const[p,m]of this.getSubgraphsAsync(h,!0))if(p===h)return await m.getState(Hs(e,{[at]:n}),{subgraphs:r==null?void 0:r.subgraphs});throw new Error(`Subgraph with namespace "${h}" not found.`)}const i=Cr(this.config,e),a=await n.getTuple(e);return await this._prepareStateSnapshot({config:i,saved:a,subgraphCheckpointer:r!=null&&r.subgraphs?n:void 0,applyPendingWrites:!((d=e.configurable)!=null&&d.checkpoint_id)})}async*getStateHistory(e,r){var a,o,c;const n=((a=e.configurable)==null?void 0:a[at])??this.checkpointer;if(!n)throw new ko("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=((o=e.configurable)==null?void 0:o.checkpoint_ns)??"";if(s!==""&&((c=e.configurable)==null?void 0:c[at])===void 0){const u=Xl(s);for await(const[l,d]of this.getSubgraphsAsync(u,!0))if(l===u){yield*d.getStateHistory(Hs(e,{[at]:n}),r);return}throw new Error(`Subgraph with namespace "${u}" not found.`)}const i=Cr(this.config,e,{configurable:{checkpoint_ns:s}});for await(const u of n.list(i,r))yield this._prepareStateSnapshot({config:u.config,saved:u})}async bulkUpdateState(e,r){var o,c,u;const n=((o=e.configurable)==null?void 0:o[at])??this.checkpointer;if(!n)throw new ko("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});if(r.length===0)throw new Error("No supersteps provided");if(r.some(l=>l.updates.length===0))throw new Error("No updates provided");const s=((c=e.configurable)==null?void 0:c.checkpoint_ns)??"";if(s!==""&&((u=e.configurable)==null?void 0:u[at])===void 0){const l=Xl(s);for await(const[,d]of this.getSubgraphsAsync(l,!0))return await d.bulkUpdateState(Hs(e,{[at]:n}),r);throw new Error(`Subgraph "${l}" not found`)}const i=async(l,d)=>{var se,ee,Te,M,U,B,te,ae,Q,le,ve;const h=this.config?Cr(this.config,l):l,p=await n.getTuple(h),m=p!==void 0?wc(p.checkpoint):jb(),_={...p==null?void 0:p.checkpoint.channel_versions},v=((se=p==null?void 0:p.metadata)==null?void 0:se.step)??-1;let y=Hs(h,{checkpoint_ns:((ee=h.configurable)==null?void 0:ee.checkpoint_ns)??""}),E=h.metadata??{};p!=null&&p.config.configurable&&(y=Hs(h,p.config.configurable),E={...p.metadata,...E});const{values:b,asNode:I}=d[0];if(b==null&&I===void 0){if(d.length>1)throw new Xe("Cannot create empty checkpoint with multiple updates");const z=await n.put(y,ws(m,void 0,v),{source:"update",step:v+1,parents:((Te=p==null?void 0:p.metadata)==null?void 0:Te.parents)??{}},{});return fs(z,p?p.metadata:void 0)}const k=vc(this.channels,m);if(b===null&&I===Pe){if(d.length>1)throw new Xe("Cannot apply multiple updates when clearing state");if(p){const K=si(m,p.pendingWrites||[],this.nodes,k,p.config,!0,{step:(((M=p.metadata)==null?void 0:M.step)??-1)+1,checkpointer:n,store:this.store}),ne=(p.pendingWrites||[]).filter(G=>G[0]===Ar).map(G=>G.slice(1));ne.length>0&&hr(m,k,[{name:bn,writes:ne,triggers:[]}],n.getNextVersion.bind(n),this.triggerToNodes);for(const[G,A,S]of p.pendingWrites||[])[tr,Me,Ro].includes(A)||G in K&&K[G].writes.push([A,S]);hr(m,k,Object.values(K),n.getNextVersion.bind(n),this.triggerToNodes)}const z=await n.put(y,ws(m,k,v),{...E,source:"update",step:v+1,parents:((U=p==null?void 0:p.metadata)==null?void 0:U.parents)??{}},qo(_,m.channel_versions));return fs(z,p?p.metadata:void 0)}if(I===q$){if(d.length>1)throw new Xe("Cannot copy checkpoint with multiple updates");if(p==null)throw new Xe("Cannot copy a non-existent checkpoint");const z=G=>!Array.isArray(G)||G.length===0?!1:G.every(A=>Array.isArray(A)&&A.length===2),K=ws(m,void 0,v),ne=await n.put(p.parentConfig??Hs(p.config,{checkpoint_id:void 0}),K,{source:"fork",step:v+1,parents:((B=p.metadata)==null?void 0:B.parents)??{}},{});if(z(b)){const G=si(K,p.pendingWrites,this.nodes,k,ne,!1,{step:v+2}),A=Object.values(G).reduce((L,{name:N,id:be})=>(L[N]??(L[N]=[]),L[N].push({id:be}),L),{}),S=b.reduce((L,N)=>{var Ye,Tt;const[be,Ae]=N;L[Ae]??(L[Ae]=[]);const Be=L[Ae].length,We=(Tt=(Ye=A[Ae])==null?void 0:Ye[Be])==null?void 0:Tt.id;return L[Ae].push({values:be,asNode:Ae,taskId:We}),L},{});return i(fs(ne,p.metadata),Object.values(S).flat())}return fs(ne,p.metadata)}if(I===bn){if(d.length>1)throw new Xe("Cannot apply multiple updates when updating as input");const z=await Jn(iE(this.inputChannels,b));if(z.length===0)throw new Xe(`Received no input writes for ${JSON.stringify(this.inputChannels,null,2)}`);hr(m,k,[{name:bn,writes:z,triggers:[]}],n.getNextVersion.bind(this.checkpointer),this.triggerToNodes);const K=((te=p==null?void 0:p.metadata)==null?void 0:te.step)!=null?p.metadata.step+1:-1,ne=await n.put(y,ws(m,k,K),{source:"input",step:K,parents:((ae=p==null?void 0:p.metadata)==null?void 0:ae.parents)??{}},qo(_,m.channel_versions));return await n.putWrites(ne,z,Ys(bn,m.id)),fs(ne,p?p.metadata:void 0)}if(((Q=h.configurable)==null?void 0:Q.checkpoint_id)===void 0&&(p==null?void 0:p.pendingWrites)!==void 0&&p.pendingWrites.length>0){const z=si(m,p.pendingWrites,this.nodes,k,p.config,!0,{store:this.store,checkpointer:this.checkpointer,step:(((le=p.metadata)==null?void 0:le.step)??-1)+1}),K=(p.pendingWrites??[]).filter(G=>G[0]===Ar).map(G=>G.slice(1));K.length>0&&hr(p.checkpoint,k,[{name:bn,writes:K,triggers:[]}],void 0,this.triggerToNodes);for(const[G,A,S]of p.pendingWrites)[tr,Me,Ro].includes(A)||z[G]===void 0||z[G].writes.push([A,S]);const ne=Object.values(z).filter(G=>G.writes.length>0);ne.length>0&&hr(m,k,ne,void 0,this.triggerToNodes)}const R=Object.values(m.versions_seen).map(z=>Object.values(z)).flat().find(z=>!!z),P=[];if(d.length===1){let{values:z,asNode:K,taskId:ne}=d[0];if(K===void 0&&Object.keys(this.nodes).length===1)[K]=Object.keys(this.nodes);else if(K===void 0&&R===void 0)typeof this.inputChannels=="string"&&this.nodes[this.inputChannels]!==void 0&&(K=this.inputChannels);else if(K===void 0){const G=Object.entries(m.versions_seen).map(([A,S])=>Object.values(S).map(L=>[L,A])).flat().filter(([A,S])=>S!==Me).sort(([A],[S])=>zb(A,S));G&&(G.length===1?K=G[0][1]:G[G.length-1][0]!==G[G.length-2][0]&&(K=G[G.length-1][1]))}if(K===void 0)throw new Xe('Ambiguous update, specify "asNode"');P.push({values:z,asNode:K,taskId:ne})}else for(const{asNode:z,values:K,taskId:ne}of d){if(z==null)throw new Xe('"asNode" is required when applying multiple updates');P.push({values:K,asNode:z,taskId:ne})}const T=[];for(const{asNode:z,values:K,taskId:ne}of P){if(this.nodes[z]===void 0)throw new Xe(`Node "${z.toString()}" does not exist`);const G=this.nodes[z].getWriters();if(!G.length)throw new Xe(`No writers found for node "${z.toString()}"`);T.push({name:z,input:K,proc:G.length>1?Pn.from(G,{omitSequenceTags:!0}):G[0],writes:[],triggers:[Me],id:ne??Ys(Me,m.id),writers:[]})}for(const z of T)await z.proc.invoke(z.input,Fe({...h,store:(h==null?void 0:h.store)??this.store},{runName:h.runName??`${this.getName()}UpdateState`,configurable:{[ts]:K=>z.writes.push(...K),[As]:(K,ne=!1)=>Wo(m,k,z,K,ne)}}));for(const z of T){const K=z.writes.filter(ne=>ne[0]!==fr);p!==void 0&&K.length>0&&await n.putWrites(y,K,z.id)}hr(m,k,T,n.getNextVersion.bind(this.checkpointer),this.triggerToNodes);const H=qo(_,m.channel_versions),q=await n.put(y,ws(m,k,v+1),{source:"update",step:v+1,parents:((ve=p==null?void 0:p.metadata)==null?void 0:ve.parents)??{}},H);for(const z of T){const K=z.writes.filter(ne=>ne[0]===fr);K.length>0&&await n.putWrites(q,K,z.id)}return fs(q,p?p.metadata:void 0)};let a=e;for(const{updates:l}of r)a=await i(a,l);return a}async updateState(e,r,n){return this.bulkUpdateState(e,[{updates:[{values:r,asNode:n}]}])}_defaults(e){var k,R,P;const{debug:r,streamMode:n,inputKeys:s,outputKeys:i,interruptAfter:a,interruptBefore:o,...c}=e;let u=!0;const l=r!==void 0?r:this.debug;let d=i;d===void 0?d=this.streamChannelsAsIs:py(d,this.channels);let h=s;h===void 0?h=this.inputChannels:py(h,this.channels);const p=o??this.interruptBefore??[],m=a??this.interruptAfter??[];let _;n!==void 0?(_=Array.isArray(n)?n:[n],u=typeof n=="string"):(((k=e.configurable)==null?void 0:k[na])!==void 0?_=["values"]:_=this.streamMode,u=!0);let v;if(this.checkpointer===!1)v=void 0;else if(e!==void 0&&((R=e.configurable)==null?void 0:R[at])!==void 0)v=e.configurable[at];else{if(this.checkpointer===!0)throw new Error("checkpointer: true cannot be used for root graphs.");v=this.checkpointer}const y=e.store??this.store,E=e.cache??this.cache;if(e.durability!=null&&e.checkpointDuring!=null)throw new Error("Cannot use both `durability` and `checkpointDuring` at the same time.");const b=(()=>{if(e.checkpointDuring!=null)return e.checkpointDuring===!1?"exit":"async"})(),I=e.durability??b??((P=e==null?void 0:e.configurable)==null?void 0:P[Wb])??"async";return[l,_,h,d,c,p,m,v,y,u,E,I]}async stream(e,r){var a;const n=new AbortController,s={recursionLimit:(a=this.config)==null?void 0:a.recursionLimit,...r,signal:Tc(r==null?void 0:r.signal,n.signal).signal},i=await super.stream(e,s);return new dy((r==null?void 0:r.encoding)==="text/event-stream"?HP(i):i,n)}streamEvents(e,r,n){var a,o;const s=new AbortController,i={recursionLimit:(a=this.config)==null?void 0:a.recursionLimit,...r,callbacks:kP((o=this.config)==null?void 0:o.callbacks,r==null?void 0:r.callbacks),signal:Tc(r==null?void 0:r.signal,s.signal).signal};return new dy(super.streamEvents(e,i,n),s)}async _validateInput(e){return e}async _validateContext(e){return e}async*_streamIterator(e,r){const n="version"in(r??{})?void 0:(r==null?void 0:r.encoding)??void 0,s=r==null?void 0:r.subgraphs,i=Zb(this.config,r);if(i.recursionLimit===void 0||i.recursionLimit<1)throw new Error('Passed "recursionLimit" must be at least 1.');if(this.checkpointer!==void 0&&this.checkpointer!==!1&&i.configurable===void 0)throw new Error('Checkpointer requires one or more of the following "configurable" keys: "thread_id", "checkpoint_ns", "checkpoint_id"');const a=await this._validateInput(e),{runId:o,...c}=i,[u,l,,d,h,p,m,_,v,y,E,b]=this._defaults(c);typeof h.context<"u"?h.context=await this._validateContext(h.context):h.configurable=await this._validateContext(h.configurable);const I=new uE({modes:new Set(l)});if(this.checkpointer===!0){h.configurable??(h.configurable={});const ee=h.configurable[rn]??"";h.configurable[rn]=ee.split(gt).map(Te=>Te.split(kn)[0]).join(gt)}if(l.includes("messages")){const ee=new XP(M=>I.push(M)),{callbacks:Te}=h;if(Te===void 0)h.callbacks=[ee];else if(Array.isArray(Te))h.callbacks=Te.concat(ee);else{const M=Te.copy();M.addHandler(ee,!0),h.callbacks=M}}h.writer??(h.writer=ee=>{var M,U,B;if(!l.includes("custom"))return;const Te=(B=(U=(M=tP())==null?void 0:M.configurable)==null?void 0:U[rn])==null?void 0:B.split(gt).slice(0,-1);I.push([Te??[],"custom",ee])}),h.interrupt??(h.interrupt=this.userInterrupt??c2);const k=await nr(h),R=await(k==null?void 0:k.handleChainStart(this.toJSON(),CP(e,"input"),o,void 0,void 0,void 0,(h==null?void 0:h.runName)??this.getName())),P=Jf(this.channels);let T,H;const se=(async()=>{var ee,Te,M;try{T=await ZP.initialize({input:a,config:h,checkpointer:_,nodes:this.nodes,channelSpecs:P,outputKeys:d,streamKeys:this.streamChannelsAsIs,store:v,cache:E,stream:I,interruptAfter:m,interruptBefore:p,manager:R,debug:this.debug,triggerToNodes:this.triggerToNodes,durability:b});const U=new i2({loop:T,nodeFinished:(ee=h.configurable)==null?void 0:ee[J$]});r!=null&&r.subgraphs&&(T.config.configurable={...T.config.configurable,[bc]:T.stream}),await this._runLoop({loop:T,runner:U,debug:u,config:h}),b==="sync"&&await Promise.all((T==null?void 0:T.checkpointerPromises)??[])}catch(U){H=U}finally{try{T&&(await((Te=T.store)==null?void 0:Te.stop()),await((M=T.cache)==null?void 0:M.stop())),await Promise.all((T==null?void 0:T.checkpointerPromises)??[])}catch(U){H=H??U}H?I.error(H):I.close()}})();try{for await(const ee of I){if(ee===void 0)throw new Error("Data structure error.");const[Te,M,U]=ee;if(l.includes(M)){if(n==="text/event-stream"){s?yield[Te,M,U]:yield[null,M,U];continue}s&&!y?yield[Te,M,U]:y?s?yield[Te,U]:yield U:yield[M,U]}}}catch(ee){throw await(R==null?void 0:R.handleChainError(H)),ee}finally{await se}await(R==null?void 0:R.handleChainEnd((T==null?void 0:T.output)??{},o,void 0,void 0,void 0))}async invoke(e,r){const n=(r==null?void 0:r.streamMode)??"values",s={...r,outputKeys:(r==null?void 0:r.outputKeys)??this.outputChannels,streamMode:n,encoding:void 0},i=[],a=await this.stream(e,s),o=[];let c;for await(const u of a)n==="values"?Jb(u)?o.push(u[Me]):c=u:i.push(u);if(n==="values"){if(o.length>0){const u=o.flat(1);if(c==null)return{[Me]:u};if(typeof c=="object")return{...c,[Me]:u}}return c}return i}async _runLoop(e){const{loop:r,runner:n,debug:s,config:i}=e;let a;try{for(;await r.tick({inputKeys:this.inputChannels});){for(const{task:o}of await r._matchCachedWrites())r._outputWrites(o.id,o.writes,!0);s&&jP(r.checkpointMetadata.step,r.channels,this.streamChannelsList),s&&cE(r.step,Object.values(r.tasks)),await n.tick({timeout:this.stepTimeout,retryPolicy:this.retryPolicy,onStepWrite:(o,c)=>{s&&zP(o,c,this.streamChannelsList)},maxConcurrency:i.maxConcurrency,signal:i.signal})}if(r.status==="out_of_steps")throw new JS([`Recursion limit of ${i.recursionLimit} reached`,"without hitting a stop condition. You can increase the",'limit by setting the "recursionLimit" config key.'].join(" "),{lc_error_code:"GRAPH_RECURSION_LIMIT"})}catch(o){if(a=o,!await r.finishAndHandleError(a))throw o}finally{a===void 0&&await r.finishAndHandleError()}}async clearCache(){var e;await((e=this.cache)==null?void 0:e.clear([]))}},xi=class fE extends Fs{constructor(r=!0){super();f(this,"lc_graph_name","EphemeralValue");f(this,"guard");f(this,"value",[]);this.guard=r}fromCheckpoint(r){const n=new fE(this.guard);return typeof r<"u"&&(n.value=[r]),n}update(r){if(r.length===0){const n=this.value.length>0;return this.value=[],n}if(r.length!==1&&this.guard)throw new Xe("EphemeralValue can only receive one value per step.");return this.value=[r[r.length-1]],!0}get(){if(this.value.length===0)throw new Nt;return this.value[0]}checkpoint(){if(this.value.length===0)throw new Nt;return this.value[0]}isAvailable(){return this.value.length!==0}};const h2=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function my(t){return typeof t=="string"&&h2.test(t)}var Rt=[];for(var id=0;id<256;++id)Rt.push((id+256).toString(16).slice(1));function f2(t,e=0){return(Rt[t[e+0]]+Rt[t[e+1]]+Rt[t[e+2]]+Rt[t[e+3]]+"-"+Rt[t[e+4]]+Rt[t[e+5]]+"-"+Rt[t[e+6]]+Rt[t[e+7]]+"-"+Rt[t[e+8]]+Rt[t[e+9]]+"-"+Rt[t[e+10]]+Rt[t[e+11]]+Rt[t[e+12]]+Rt[t[e+13]]+Rt[t[e+14]]+Rt[t[e+15]]).toLowerCase()}var Eo,p2=new Uint8Array(16);function m2(){if(!Eo&&(Eo=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Eo))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Eo(p2)}var g2=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const gy={randomUUID:g2};function yy(t,e,r){if(gy.randomUUID&&!t)return gy.randomUUID();t=t||{};var n=t.random||(t.rng||m2)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,f2(n)}var pE=class{constructor(t){f(this,"path");f(this,"ends");$e.isRunnable(t.path)?this.path=t.path:this.path=Ot(t.path).withConfig({runName:"Branch"}),this.ends=Array.isArray(t.pathMap)?t.pathMap.reduce((e,r)=>(e[r]=r,e),{}):t.pathMap}run(t,e){return Vt.registerWriter(new js({name:"<branch_run>",trace:!1,func:async(r,n)=>{try{return await this._route(r,n,t,e)}catch(s){throw s.name===U_.unminifiable_name&&console.warn(`[WARN]: 'NodeInterrupt' thrown in conditional edge. This is likely a bug in your graph implementation.
NodeInterrupt should only be thrown inside a node, not in edge conditions.`),s}}}))}async _route(t,e,r,n){let s=await this.path.invoke(n?n(e):t,e);Array.isArray(s)||(s=[s]);let i;if(this.ends?i=s.map(o=>yr(o)?o:this.ends[o]):i=s,i.some(o=>!o))throw new Error("Branch condition returned unknown or null destination");if(i.filter(yr).some(o=>o.node===Pe))throw new Xe("Cannot send a packet to the END node");return await r(i,e)??t}},y2=class{constructor(){f(this,"nodes");f(this,"edges");f(this,"branches");f(this,"entryPoint");f(this,"compiled",!1);this.nodes={},this.edges=new Set,this.branches={}}warnIfCompiled(t){this.compiled&&console.warn(t)}get allEdges(){return this.edges}addNode(...t){function e(n){return n.length>=1&&typeof n[0]!="string"}const r=e(t)?Array.isArray(t[0])?t[0]:Object.entries(t[0]):[[t[0],t[1],t[2]]];if(r.length===0)throw new Error("No nodes provided in `addNode`");for(const[n,s,i]of r){for(const o of[gt,kn])if(n.includes(o))throw new Error(`"${o}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),n in this.nodes)throw new Error(`Node \`${n}\` already present.`);if(n===Pe)throw new Error(`Node \`${n}\` is reserved.`);const a=Ot(s);this.nodes[n]={runnable:a,metadata:i==null?void 0:i.metadata,subgraphs:Yf(a)?[a]:i==null?void 0:i.subgraphs,ends:i==null?void 0:i.ends}}return this}addEdge(t,e){if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),t===Pe)throw new Error("END cannot be a start node");if(e===Ge)throw new Error("START cannot be an end node");if(Array.from(this.edges).some(([r])=>r===t)&&!("channels"in this))throw new Error(`Already found path for ${t}. For multiple edges, use StateGraph.`);return this.edges.add([t,e]),this}addConditionalEdges(t,e,r){var i,a;const n=typeof t=="object"?t:{source:t,path:e,pathMap:r};if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),!$e.isRunnable(n.path)){const o=Array.isArray(n.pathMap)?n.pathMap.join(","):Object.keys(n.pathMap??{}).join(",");n.path=Ot(n.path).withConfig({runName:`Branch<${n.source}${o!==""?`,${o}`:""}>`.slice(0,63)})}const s=n.path.getName()==="RunnableLambda"?"condition":n.path.getName();if(this.branches[n.source]&&this.branches[n.source][s])throw new Error(`Condition \`${s}\` already present for node \`${t}\``);return(i=this.branches)[a=n.source]??(i[a]={}),this.branches[n.source][s]=new pE(n),this}setEntryPoint(t){return this.warnIfCompiled("Setting the entry point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(Ge,t)}setFinishPoint(t){return this.warnIfCompiled("Setting a finish point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(t,Pe)}compile({checkpointer:t,interruptBefore:e,interruptAfter:r,name:n}={}){this.validate([...Array.isArray(e)?e:[],...Array.isArray(r)?r:[]]);const s=new mE({builder:this,checkpointer:t,interruptAfter:r,interruptBefore:e,autoValidate:!1,nodes:{},channels:{[Ge]:new xi,[Pe]:new xi},inputChannels:Ge,outputChannels:Pe,streamChannels:[],streamMode:"values",name:n});for(const[i,a]of Object.entries(this.nodes))s.attachNode(i,a);for(const[i,a]of this.edges)s.attachEdge(i,a);for(const[i,a]of Object.entries(this.branches))for(const[o,c]of Object.entries(a))s.attachBranch(i,o,c);return s.validate()}validate(t){const e=new Set([...this.allEdges].map(([n,s])=>n));for(const[n]of Object.entries(this.branches))e.add(n);for(const n of e)if(n!==Ge&&!(n in this.nodes))throw new Error(`Found edge starting at unknown node \`${n}\``);const r=new Set([...this.allEdges].map(([n,s])=>s));for(const[n,s]of Object.entries(this.branches))for(const i of Object.values(s))if(i.ends!=null)for(const a of Object.values(i.ends))r.add(a);else{r.add(Pe);for(const a of Object.keys(this.nodes))a!==n&&r.add(a)}for(const n of Object.values(this.nodes))for(const s of n.ends??[])r.add(s);for(const n of Object.keys(this.nodes))if(!r.has(n))throw new KS([`Node \`${n}\` is not reachable.`,"","If you are returning Command objects from your node,",'make sure you are passing names of potential destination nodes as an "ends" array','into ".addNode(..., { ends: ["node1", "node2"] })".'].join(`
`),{lc_error_code:"UNREACHABLE_NODE"});for(const n of r)if(n!==Pe&&!(n in this.nodes))throw new Error(`Found edge ending at unknown node \`${n}\``);if(t){for(const n of t)if(!(n in this.nodes))throw new Error(`Interrupt node \`${n}\` is not present`)}this.compiled=!0}},mE=class extends d2{constructor({builder:e,...r}){super(r);f(this,"builder");this.builder=e}attachNode(e,r){this.channels[e]=new xi,this.nodes[e]=new Ca({channels:[],triggers:[],metadata:r.metadata,subgraphs:r.subgraphs,ends:r.ends}).pipe(r.runnable).pipe(new Vt([{channel:e,value:Cs}],[ut])),this.streamChannels.push(e)}attachEdge(e,r){if(r===Pe){if(e===Ge)throw new Error("Cannot have an edge from START to END");this.nodes[e].writers.push(new Vt([{channel:Pe,value:Cs}],[ut]))}else this.nodes[r].triggers.push(e),this.nodes[r].channels.push(e)}attachBranch(e,r,n){e===Ge&&!this.nodes[Ge]&&(this.nodes[Ge]=u2.subscribeTo(Ge,{tags:[ut]})),this.nodes[e].pipe(n.run(i=>{const a=i.map(o=>yr(o)?o:{channel:o===Pe?Pe:`branch:${e}:${r}:${o}`,value:Cs});return new Vt(a,[ut])}));const s=n.ends?Object.values(n.ends):Object.keys(this.nodes);for(const i of s)if(i!==Pe){const a=`branch:${e}:${r}:${i}`;this.channels[a]=new xi,this.nodes[i].triggers.push(a),this.nodes[i].channels.push(a)}}async getGraphAsync(e){var u,l,d,h;const r=e==null?void 0:e.xray,n=new Ea,s={[Ge]:n.addNode({schema:go()},Ge)},i={};let a={};r&&(a=Object.fromEntries((await Jn(this.getSubgraphsAsync())).filter(p=>_y(p[1]))));function o(p,m,_,v=!1){if(m===Pe&&i[Pe]===void 0&&(i[Pe]=n.addNode({schema:go()},Pe)),s[p]!==void 0){if(i[m]===void 0)throw new Error(`End node ${m} not found!`);return n.addEdge(s[p],i[m],_!==m?_:void 0,v)}}for(const[p,m]of Object.entries(this.builder.nodes)){const _=Dt(p),v=m.runnable,y=m.metadata??{};if((u=this.interruptBefore)!=null&&u.includes(p)&&((l=this.interruptAfter)!=null&&l.includes(p))?y.__interrupt="before,after":(d=this.interruptBefore)!=null&&d.includes(p)?y.__interrupt="before":(h=this.interruptAfter)!=null&&h.includes(p)&&(y.__interrupt="after"),r){const E=typeof r=="number"?r-1:r,b=a[p]!==void 0?await a[p].getGraphAsync({...e,xray:E}):v.getGraph(e);if(b.trimFirstNode(),b.trimLastNode(),Object.keys(b.nodes).length>1){let R=function(T){return T?T.lc_runnable:!1},P=function(T,H){if(T!==void 0&&!my(T))return T;if(R(H))try{let q=H.getName();return q=q.startsWith("Runnable")?q.slice(8):q,q}catch{return H.getName()}else return H.name??"UnknownSchema"};const[I,k]=n.extend(b,_);if(I===void 0)throw new Error(`Could not extend subgraph "${p}" due to missing entrypoint.`);k!==void 0&&(s[_]={name:P(k.id,k.data),...k}),i[_]={name:P(I.id,I.data),...I}}else{const I=n.addNode(v,_,y);s[_]=I,i[_]=I}}else{const E=n.addNode(v,_,y);s[_]=E,i[_]=E}}const c=[...this.builder.allEdges].sort(([p],[m])=>p<m?-1:m>p?1:0);for(const[p,m]of c)o(Dt(p),Dt(m));for(const[p,m]of Object.entries(this.builder.branches)){const _={...Object.fromEntries(Object.keys(this.builder.nodes).filter(v=>v!==p).map(v=>[Dt(v),Dt(v)])),[Pe]:Pe};for(const v of Object.values(m)){let y;v.ends!==void 0?y=v.ends:y=_;for(const[E,b]of Object.entries(y))o(Dt(p),Dt(b),E,!0)}}for(const[p,m]of Object.entries(this.builder.nodes))if(m.ends!==void 0)for(const _ of m.ends)o(Dt(p),Dt(_),void 0,!0);return n}getGraph(e){var u,l,d,h;const r=e==null?void 0:e.xray,n=new Ea,s={[Ge]:n.addNode({schema:go()},Ge)},i={};let a={};r&&(a=Object.fromEntries(Zi(this.getSubgraphs()).filter(p=>_y(p[1]))));function o(p,m,_,v=!1){return m===Pe&&i[Pe]===void 0&&(i[Pe]=n.addNode({schema:go()},Pe)),n.addEdge(s[p],i[m],_!==m?_:void 0,v)}for(const[p,m]of Object.entries(this.builder.nodes)){const _=Dt(p),v=m.runnable,y=m.metadata??{};if((u=this.interruptBefore)!=null&&u.includes(p)&&((l=this.interruptAfter)!=null&&l.includes(p))?y.__interrupt="before,after":(d=this.interruptBefore)!=null&&d.includes(p)?y.__interrupt="before":(h=this.interruptAfter)!=null&&h.includes(p)&&(y.__interrupt="after"),r){const E=typeof r=="number"?r-1:r,b=a[p]!==void 0?a[p].getGraph({...e,xray:E}):v.getGraph(e);if(b.trimFirstNode(),b.trimLastNode(),Object.keys(b.nodes).length>1){let R=function(T){return T?T.lc_runnable:!1},P=function(T,H){if(T!==void 0&&!my(T))return T;if(R(H))try{let q=H.getName();return q=q.startsWith("Runnable")?q.slice(8):q,q}catch{return H.getName()}else return H.name??"UnknownSchema"};const[I,k]=n.extend(b,_);if(I===void 0)throw new Error(`Could not extend subgraph "${p}" due to missing entrypoint.`);k!==void 0&&(s[_]={name:P(k.id,k.data),...k}),i[_]={name:P(I.id,I.data),...I}}else{const I=n.addNode(v,_,y);s[_]=I,i[_]=I}}else{const E=n.addNode(v,_,y);s[_]=E,i[_]=E}}const c=[...this.builder.allEdges].sort(([p],[m])=>p<m?-1:m>p?1:0);for(const[p,m]of c)o(Dt(p),Dt(m));for(const[p,m]of Object.entries(this.builder.branches)){const _={...Object.fromEntries(Object.keys(this.builder.nodes).filter(v=>v!==p).map(v=>[Dt(v),Dt(v)])),[Pe]:Pe};for(const v of Object.values(m)){let y;v.ends!==void 0?y=v.ends:y=_;for(const[E,b]of Object.entries(y))o(Dt(p),Dt(b),E,!0)}}return n}};function _y(t){return typeof t.attachNode=="function"&&typeof t.attachEdge=="function"}function Dt(t){return t==="subgraph"?`"${t}"`:t}const bs=(t,e)=>t.size===e.size&&[...t].every(r=>e.has(r));var _2=class gE extends Fs{constructor(r){super();f(this,"lc_graph_name","NamedBarrierValue");f(this,"names");f(this,"seen");this.names=r,this.seen=new Set}fromCheckpoint(r){const n=new gE(this.names);return typeof r<"u"&&(n.seen=new Set(r)),n}update(r){let n=!1;for(const s of r)if(this.names.has(s))this.seen.has(s)||(this.seen.add(s),n=!0);else throw new Xe(`Value ${JSON.stringify(s)} not in names ${JSON.stringify(this.names)}`);return n}get(){if(!bs(this.names,this.seen))throw new Nt}checkpoint(){return[...this.seen]}consume(){return this.seen&&this.names&&bs(this.seen,this.names)?(this.seen=new Set,!0):!1}isAvailable(){return!!this.names&&bs(this.names,this.seen)}},w2=class yE extends Fs{constructor(r){super();f(this,"lc_graph_name","NamedBarrierValueAfterFinish");f(this,"names");f(this,"seen");f(this,"finished");this.names=r,this.seen=new Set,this.finished=!1}fromCheckpoint(r){const n=new yE(this.names);if(typeof r<"u"){const[s,i]=r;n.seen=new Set(s),n.finished=i}return n}update(r){let n=!1;for(const s of r)if(this.names.has(s)&&!this.seen.has(s))this.seen.add(s),n=!0;else if(!this.names.has(s))throw new Xe(`Value ${JSON.stringify(s)} not in names ${JSON.stringify(this.names)}`);return n}get(){if(!this.finished||!bs(this.names,this.seen))throw new Nt}checkpoint(){return[[...this.seen],this.finished]}consume(){return this.finished&&this.seen&&this.names&&bs(this.seen,this.names)?(this.seen=new Set,this.finished=!1,!0):!1}finish(){return!this.finished&&this.names&&bs(this.names,this.seen)?(this.finished=!0,!0):!1}isAvailable(){return this.finished&&!!this.names&&bs(this.names,this.seen)}};const v2="lg:";var b2=class{constructor(){f(this,"_map",new WeakMap);f(this,"_extensionCache",new Map)}get(t){return this._map.get(t)}extend(t,e){const r=this.get(t);this._map.set(t,e(r))}remove(t){return this._map.delete(t),this}has(t){return this._map.has(t)}getChannelsForSchema(t){const e={},r=_a(t);for(const[n,s]of Object.entries(r)){const i=this.get(s);i!=null&&i.reducer?e[n]=new lh(i.reducer.fn,i.default):e[n]=new Zf}return e}getExtendedChannelSchemas(t,e){if(Object.keys(e).length===0)return t;const r=Object.entries(e).filter(([,i])=>i===!0).sort(([i],[a])=>i.localeCompare(a)).map(([i,a])=>`${i}:${a}`).join("|"),n=this._extensionCache.get(r)??new WeakMap;if(n.has(t))return n.get(t);let s=t;if(e.withReducerSchema||e.withJsonSchemaExtrasAsDescription){const i=Object.entries(_a(t)).map(([a,o])=>{var l;const c=this.get(o);let u=e.withReducerSchema?((l=c==null?void 0:c.reducer)==null?void 0:l.schema)??o:o;if(e.withJsonSchemaExtrasAsDescription&&(c!=null&&c.jsonSchemaExtra)){const d=mi(u)??mi(o),h=JSON.stringify({...c.jsonSchemaExtra,description:d});u=u.describe(`${v2}${h}`)}return[a,u]});s=A0(t,Object.fromEntries(i)),dt(s)&&(s._def.unknownKeys="strip")}return e.asPartial&&(s=_f(s)),n.set(t,s),this._extensionCache.set(r,n),s}};const Ac=new b2;function E2(t,e){var r;if(e.reducer&&!e.default){const n=C0(t);n!=null&&(e.default=n)}if(e.reducer){const n=Object.assign(t,{lg_reducer_schema:((r=e.reducer)==null?void 0:r.schema)??t});return Ac.extend(n,()=>e),n}else return Ac.extend(t,()=>e),t}const Tn="__root__",wh=Symbol.for("langgraph.state.partial");var S2=class extends y2{constructor(e,r){var s,i;super();f(this,"channels",{});f(this,"waitingEdges",new Set);f(this,"_schemaDefinition");f(this,"_schemaRuntimeDefinition");f(this,"_inputDefinition");f(this,"_inputRuntimeDefinition");f(this,"_outputDefinition");f(this,"_outputRuntimeDefinition");f(this,"_schemaDefinitions",new Map);f(this,"_metaRegistry",Ac);f(this,"_configSchema");f(this,"_configRuntimeSchema");f(this,"_interrupt");f(this,"_writer");if(R2(e)){const a=this._metaRegistry.getChannelsForSchema(e.state),o=e.input!=null?this._metaRegistry.getChannelsForSchema(e.input):a,c=e.output!=null?this._metaRegistry.getChannelsForSchema(e.output):a;this._schemaDefinition=a,this._schemaRuntimeDefinition=e.state,this._inputDefinition=o,this._inputRuntimeDefinition=e.input??wh,this._outputDefinition=c,this._outputRuntimeDefinition=e.output??e.state}else if(jr(e)){const a=this._metaRegistry.getChannelsForSchema(e);this._schemaDefinition=a,this._schemaRuntimeDefinition=e,this._inputDefinition=a,this._inputRuntimeDefinition=wh,this._outputDefinition=a,this._outputRuntimeDefinition=e}else if(I2(e))this._schemaDefinition=e.input.spec,this._inputDefinition=e.input.spec,this._outputDefinition=e.output.spec;else if(k2(e))this._schemaDefinition=e.stateSchema.spec,this._inputDefinition=((s=e.input)==null?void 0:s.spec)??this._schemaDefinition,this._outputDefinition=((i=e.output)==null?void 0:i.spec)??this._schemaDefinition;else if(A2(e)||wy(e)){const a=wy(e)?e.spec:e;this._schemaDefinition=a}else if(C2(e)){const a=x2(e.channels);this._schemaDefinition=a}else throw new Error("Invalid StateGraph input. Make sure to pass a valid Annotation.Root or Zod schema.");this._inputDefinition??(this._inputDefinition=this._schemaDefinition),this._outputDefinition??(this._outputDefinition=this._schemaDefinition),this._addSchema(this._schemaDefinition),this._addSchema(this._inputDefinition),this._addSchema(this._outputDefinition);function n(a){return typeof a=="object"&&a!=null&&!("spec"in a)&&!jr(a)}n(r)?(jr(r.context)&&(this._configRuntimeSchema=r.context),this._interrupt=r.interrupt,this._writer=r.writer):jr(r)&&(this._configRuntimeSchema=r)}get allEdges(){return new Set([...this.edges,...Array.from(this.waitingEdges).flatMap(([e,r])=>e.map(n=>[n,r]))])}_addSchema(e){if(!this._schemaDefinitions.has(e)){this._schemaDefinitions.set(e,e);for(const[r,n]of Object.entries(e)){let s;if(typeof n=="function"?s=n():s=n,this.channels[r]!==void 0){if(this.channels[r]!==s&&s.lc_graph_name!=="LastValue")throw new Error(`Channel "${r}" already exists with a different type.`)}else this.channels[r]=s}}}addNode(...e){function r(s){return s.length>=1&&typeof s[0]!="string"}const n=r(e)?Array.isArray(e[0])?e[0]:Object.entries(e[0]).map(([s,i])=>[s,i]):[[e[0],e[1],e[2]]];if(n.length===0)throw new Error("No nodes provided in `addNode`");for(const[s,i,a]of n){if(s in this.channels)throw new Error(`${s} is already being used as a state attribute (a.k.a. a channel), cannot also be used as a node name.`);for(const d of[gt,kn])if(s.includes(d))throw new Error(`"${d}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),s in this.nodes)throw new Error(`Node \`${s}\` already present.`);if(s===Pe||s===Ge)throw new Error(`Node \`${s}\` is reserved.`);let o=this._schemaDefinition;(a==null?void 0:a.input)!==void 0&&(jr(a.input)?o=this._metaRegistry.getChannelsForSchema(a.input):a.input.spec!==void 0&&(o=a.input.spec)),o!==void 0&&this._addSchema(o);let c;$e.isRunnable(i)?c=i:typeof i=="function"?c=new js({func:i,name:s,trace:!1}):c=Ot(i);let u=a==null?void 0:a.cachePolicy;typeof u=="boolean"&&(u=u?{}:void 0);const l={runnable:c,retryPolicy:a==null?void 0:a.retryPolicy,cachePolicy:u,metadata:a==null?void 0:a.metadata,input:o??this._schemaDefinition,subgraphs:Yf(c)?[c]:a==null?void 0:a.subgraphs,ends:a==null?void 0:a.ends,defer:a==null?void 0:a.defer};this.nodes[s]=l}return this}addEdge(e,r){if(typeof e=="string")return super.addEdge(e,r);this.compiled&&console.warn("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph.");for(const n of e){if(n===Pe)throw new Error("END cannot be a start node");if(!Object.keys(this.nodes).some(s=>s===n))throw new Error(`Need to add a node named "${n}" first`)}if(r===Pe)throw new Error("END cannot be an end node");if(!Object.keys(this.nodes).some(n=>n===r))throw new Error(`Need to add a node named "${r}" first`);return this.waitingEdges.add([e,r]),this}addSequence(e){const r=Array.isArray(e)?e:Object.entries(e);if(r.length===0)throw new Error("Sequence requires at least one node.");let n;for(const[s,i,a]of r){if(s in this.nodes)throw new Error(`Node names must be unique: node with the name "${s}" already exists.`);const o=s;this.addNode(o,i,a),n!=null&&this.addEdge(n,o),n=o}return this}compile({checkpointer:e,store:r,cache:n,interruptBefore:s,interruptAfter:i,name:a,description:o}={}){this.validate([...Array.isArray(s)?s:[],...Array.isArray(i)?i:[]]);const c=Object.keys(this._schemaDefinitions.get(this._outputDefinition)),u=c.length===1&&c[0]===Tn?Tn:c,l=Object.keys(this.channels),d=l.length===1&&l[0]===Tn?Tn:l,h=this._interrupt,p=new T2({builder:this,checkpointer:e,interruptAfter:i,interruptBefore:s,autoValidate:!1,nodes:{},channels:{...this.channels,[Ge]:new xi},inputChannels:Ge,outputChannels:u,streamChannels:d,streamMode:"updates",store:r,cache:n,name:a,description:o,userInterrupt:h});p.attachNode(Ge);for(const[m,_]of Object.entries(this.nodes))p.attachNode(m,_);p.attachBranch(Ge,iy,vy(),{withReader:!1});for(const[m]of Object.entries(this.nodes))p.attachBranch(m,iy,vy(),{withReader:!1});for(const[m,_]of this.edges)p.attachEdge(m,_);for(const[m,_]of this.waitingEdges)p.attachEdge(m,_);for(const[m,_]of Object.entries(this.branches))for(const[v,y]of Object.entries(_))p.attachBranch(m,v,y);return p.validate()}};function x2(t){const e={};for(const[r,n]of Object.entries(t))e[r]=dh(n);return e}var T2=class extends mE{constructor({description:e,...r}){super(r);f(this,"description");f(this,"_metaRegistry",Ac);this.description=e}attachNode(e,r){let n;e===Ge?n=Object.entries(this.builder._schemaDefinitions.get(this.builder._inputDefinition)).map(([c])=>c):n=Object.keys(this.builder.channels);function s(c){if(Yt(c))return c.graph===Gt.PARENT?null:c._updateAsTuples();if(Array.isArray(c)&&c.length>0&&c.some(u=>Yt(u))){const u=[];for(const l of c)if(Yt(l)){if(l.graph===Gt.PARENT)continue;u.push(...l._updateAsTuples())}else u.push([Tn,l]);return u}else if(c!=null)return[[Tn,c]];return null}const i=e;function a(c){if(c){if(Yt(c))return c.graph===Gt.PARENT?null:c._updateAsTuples().filter(([u])=>n.includes(u));if(Array.isArray(c)&&c.length>0&&c.some(Yt)){const u=[];for(const l of c)if(Yt(l)){if(l.graph===Gt.PARENT)continue;u.push(...l._updateAsTuples().filter(([d])=>n.includes(d)))}else{const d=a(l);d&&u.push(...d??[])}return u}else{if(typeof c=="object"&&!Array.isArray(c))return Object.entries(c).filter(([u])=>n.includes(u));{const u=Array.isArray(c)?"array":typeof c;throw new Xe(`Expected node "${i.toString()}" to return an object or an array containing at least one Command object, received ${u}`,{lc_error_code:"INVALID_GRAPH_NODE_RETURN_VALUE"})}}}else return null}const o=[{value:Cs,mapper:new js({func:n.length&&n[0]===Tn?s:a,trace:!1,recurse:!1})}];if(e===Ge)this.nodes[e]=new Ca({tags:[ut],triggers:[Ge],channels:[Ge],writers:[new Vt(o,[ut])]});else{const c=(r==null?void 0:r.input)??this.builder._schemaDefinition,u=Object.fromEntries(Object.keys(this.builder._schemaDefinitions.get(c)).map(h=>[h,h])),l=Object.keys(u).length===1&&Tn in u,d=`branch:to:${e}`;this.channels[d]=r!=null&&r.defer?new G$:new xi(!1),this.nodes[e]=new Ca({triggers:[d],channels:l?Object.keys(u):u,writers:[new Vt(o,[ut])],mapper:l?void 0:h=>Object.fromEntries(Object.entries(h).filter(([p])=>p in u)),bound:r==null?void 0:r.runnable,metadata:r==null?void 0:r.metadata,retryPolicy:r==null?void 0:r.retryPolicy,cachePolicy:r==null?void 0:r.cachePolicy,subgraphs:r==null?void 0:r.subgraphs,ends:r==null?void 0:r.ends})}}attachEdge(e,r){if(r!==Pe){if(typeof e=="string")this.nodes[e].writers.push(new Vt([{channel:`branch:to:${r}`,value:null}],[ut]));else if(Array.isArray(e)){const n=`join:${e.join("+")}:${r}`;this.channels[n]=this.builder.nodes[r].defer?new w2(new Set(e)):new _2(new Set(e)),this.nodes[r].triggers.push(n);for(const s of e)this.nodes[s].writers.push(new Vt([{channel:n,value:s}],[ut]))}}}attachBranch(e,r,n,s={withReader:!0}){const i=async(a,o)=>{const c=a.filter(l=>l!==Pe);if(!c.length)return;const u=c.map(l=>yr(l)?l:{channel:l===Pe?l:`branch:to:${l}`,value:e});await Vt.doWrite({...o,tags:(o.tags??[]).concat([ut])},u)};this.nodes[e].writers.push(n.run(i,s.withReader?a=>sP.doRead(a,this.streamChannels??this.outputChannels,!0):void 0))}async _validateInput(e){if(e==null)return e;const r=(()=>{const n=this.builder._inputRuntimeDefinition,s=this.builder._schemaRuntimeDefinition,i=a=>{if(a!=null)return this._metaRegistry.getExtendedChannelSchemas(a,{withReducerSchema:!0})};if(jr(n))return i(n);if(n===wh)return _f(i(s))})();if(Yt(e)){const n=e;return e.update&&r!=null&&(n.update=Po(r,e.update)),n}return r!=null?Po(r,e):e}isInterrupted(e){return Jb(e)}async _validateContext(e){const r=this.builder._configRuntimeSchema;return jr(r)&&Po(r,e),e}};function A2(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)&&Object.keys(t).length>0&&Object.values(t).every(e=>typeof e=="function"||Vb(e))}function wy(t){return typeof t=="object"&&t!==null&&"lc_graph_name"in t&&t.lc_graph_name==="AnnotationRoot"}function C2(t){return typeof t=="object"&&t!==null&&t.channels!==void 0}function k2(t){return typeof t=="object"&&t!==null&&t.stateSchema!==void 0}function I2(t){return typeof t=="object"&&t!==null&&t.stateSchema===void 0&&t.input!==void 0&&t.output!==void 0}function R2(t){return!(typeof t!="object"||t==null||!("state"in t)||!jr(t.state)||"input"in t&&!jr(t.input)||"output"in t&&!jr(t.output))}function O2(t){if(yr(t))return[t];const e=[];Yt(t)?e.push(t):Array.isArray(t)&&e.push(...t.filter(Yt));const r=[];for(const n of e){if(n.graph===Gt.PARENT)throw new B_(n);yr(n.goto)||typeof n.goto=="string"?r.push(n.goto):Array.isArray(n.goto)&&r.push(...n.goto)}return r}function vy(){const t=new js({func:O2,tags:[ut],trace:!1,recurse:!1,name:"<control_branch>"});return new pE({path:t})}const N2="__remove_all__";function _E(t,e){const r=Array.isArray(t)?t:[t],n=Array.isArray(e)?e:[e],s=r.map(dn),i=n.map(dn);for(const l of s)(l.id===null||l.id===void 0)&&(l.id=yy(),l.lc_kwargs.id=l.id);let a;for(let l=0;l<i.length;l+=1){const d=i[l];(d.id===null||d.id===void 0)&&(d.id=yy(),d.lc_kwargs.id=d.id),d.getType()==="remove"&&d.id===N2&&(a=l)}if(a!=null)return i.slice(a+1);const o=[...s],c=new Map(o.map((l,d)=>[l.id,d])),u=new Set;for(const l of i){const d=c.get(l.id);if(d!==void 0)l.getType()==="remove"?u.add(l.id):(u.delete(l.id),o[d]=l);else{if(l.getType()==="remove")throw new Error(`Attempting to delete a message with an ID that doesn't exist ('${l.id}')`);c.set(l.id,o.length),o.push(l)}}return o.filter(l=>!u.has(l.id))}nt.Root({messages:nt({reducer:_E,default:()=>[]})});const $2={reducer:{fn:_E},jsonSchemaExtra:{langgraph_type:"messages"},default:()=>[]};Wt({messages:E2(nI(),$2)});const P2=40,L2=35,D2=50,M2=2,U2=5,So={ASSET:"Asset",ENTITY:"Entity"},ps={SPOOFING:"Spoofing",TAMPERING:"Tampering",REPUDIATION:"Repudiation",INFORMATION_DISCLOSURE:"Information Disclosure",DENIAL_OF_SERVICE:"Denial of Service",ELEVATION_OF_PRIVILEGE:"Elevation of Privilege"},ad={LOW:"Low",MEDIUM:"Medium",HIGH:"High"},B2=Wt({summary:Je().describe(`A short headline summary of max ${P2} words`)}),F2=Wt({type:Jd([So.ASSET,So.ENTITY]).describe(`Type, one of ${So.ASSET} or ${So.ENTITY}`),name:Je().describe("The name of the asset"),description:Je().describe("The description of the asset or entity")}),j2=Wt({assets:xs(F2).describe("The list of assets")}),z2=Wt({flow_description:Je().describe("The description of the data flow"),source_entity:Je().describe("The source entity/asset of the data flow"),target_entity:Je().describe("The target entity/asset of the data flow")}),V2=Wt({purpose:Je().describe("The purpose of the trust boundary"),source_entity:Je().describe("The source entity/asset of the trust boundary"),target_entity:Je().describe("The target entity/asset of the trust boundary")}),G2=Wt({category:Je().describe("Actor Category"),description:Je().describe("One sentence describing their relevance to this architecture"),example:Je().describe("Brief list of 1-2 specific actor types")}),H2=Wt({data_flows:xs(z2).describe("The list of data flows"),trust_boundaries:xs(V2).describe("The list of trust boundaries"),threat_sources:xs(G2).describe("The list of threat actors")}),q2=Wt({name:Je().describe("A concise, descriptive name for the threat that clearly identifies the security concern"),stride_category:Jd([ps.SPOOFING,ps.TAMPERING,ps.REPUDIATION,ps.INFORMATION_DISCLOSURE,ps.DENIAL_OF_SERVICE,ps.ELEVATION_OF_PRIVILEGE]).describe(`The STRIDE category classification: One of ${Object.values(ps).join(", ")}`),description:Je().describe(`A comprehensive description of the threat scenario, including how it could be executed and its potential consequences. Must be between ${L2} and ${D2} words. Follow threat grammar: [Threat Actor] + [Action] + [Asset/Target] + [Negative Outcome]`),target:Je().describe("The specific asset, component, system, or data element that could be compromised by this threat"),impact:Je().describe("The potential business, technical, or operational consequences if this threat is successfully exploited. Consider confidentiality, integrity, and availability impacts"),likelihood:Jd([ad.LOW,ad.MEDIUM,ad.HIGH]).describe("The probability of threat occurrence based on factors like attacker motivation, capability, opportunity, and existing controls"),mitigations:xs(Je()).min(M2).max(U2).describe("Specific security controls, countermeasures, or design changes that can prevent, detect, or reduce the impact of this threat"),source:Je().describe("The threat actor or agent who could execute this threat"),prerequisites:xs(Je()).default([]).describe("Required conditions, access levels, knowledge, or system states that must exist for this threat to be viable"),vector:Je().describe("The attack vector or pathway through which the threat could be delivered or executed"),starred:$0().default(!1).optional().describe("User-defined flag for prioritization or tracking. Ignored by automated threat modeling agents")}),W2=Wt({threats:xs(q2).describe("The list of threats")}),J2=Wt({stop:$0().describe("Should continue evaluation further threats or the catalog is comprehensive and complete."),gap:Je().optional().default("").describe("An in depth gap analysis on how to improve the threat catalog. Required only when 'stop' is False")});function Z2(t,e){if(!t)return e;if(!e)return t;const r=new Set(t.threats.map(s=>s.name)),n=e.threats.filter(s=>!r.has(s.name));return{threats:[...t.threats,...n]}}function K2(t,e){return t?e?[...t,...e]:t:e||[]}function jt(t,e){return e??t}const X2=nt.Root({job_id:nt({reducer:jt}),summary:nt({reducer:jt}),assets:nt({reducer:jt}),image_data:nt({reducer:jt}),system_architecture:nt({reducer:jt}),description:nt({reducer:jt}),assumptions:nt({reducer:jt}),threat_list:nt({reducer:Z2}),iteration:nt({reducer:jt}),retry:nt({reducer:jt}),s3_location:nt({reducer:jt}),title:nt({reducer:jt}),owner:nt({reducer:jt}),stop:nt({reducer:jt}),gap:nt({reducer:K2}),replay:nt({reducer:jt}),instructions:nt({reducer:jt})});class Y2{constructor(){this.store=new Map}run(e,r,...n){const s=this.store;this.store=new Map(s),this.store.set("current",e);try{return r(...n)}finally{this.store=s}}getStore(){return this.store.get("current")}enterWith(e){this.store.set("current",e)}disable(){this.store.delete("current")}exit(e,...r){const n=this.store;this.store=new Map;try{return e(...r)}finally{this.store=n}}}function Q2(){Et.initializeGlobalInstance(new Y2)}Q2();class Ka{constructor(e,r,n){this.image_data=e,this.description=r,this.assumptions=n}base_msg(e=!1){const r={cachePoint:{type:"default"}},n=[{type:"text",text:"<architecture_diagram>"},{type:"image_url",image_url:{url:`data:image/jpeg;base64,${this.image_data}`}},{type:"text",text:"</architecture_diagram>"},{type:"text",text:`<description>${this.description}</description>`},{type:"text",text:`<assumptions>${this.assumptions}</assumptions>`}];return e&&n.push(r),n}createSummaryMessage(e=40){const r=[{type:"text",text:`Generate a short headline summary of max ${e} words this architecture using the diagram and description if available`}],n=this.base_msg();return n.push(...r),new pt({content:n})}createAssetMessage(){const e=[{type:"text",text:"Identify Assets"}],r=this.base_msg();return r.push(...e),new pt({content:r})}createSystemFlowsMessage(e){const n=[{type:"text",text:`<identified_assets_and_entities>${typeof e=="string"?e:JSON.stringify(e)}</identified_assets_and_entities>`},{type:"text",text:"Identify system flows"}],s=this.base_msg();return s.push(...n),new pt({content:s})}createThreatMessage(e,r){const n=typeof e=="string"?e:JSON.stringify(e),s=typeof r=="string"?r:JSON.stringify(r),i=[{type:"text",text:`<identified_assets_and_entities>${n}</identified_assets_and_entities>`},{type:"text",text:`<data_flow>${s}</data_flow>`},{type:"text",text:"Define threats and mitigations for the solution"}],a=this.base_msg();return a.push(...i),new pt({content:a})}createThreatImproveMessage(e,r,n,s){const i=typeof e=="string"?e:JSON.stringify(e),a=typeof r=="string"?r:JSON.stringify(r),o=typeof n=="string"?n:JSON.stringify(n),c=[{type:"text",text:`<identified_assets_and_entities>${i}</identified_assets_and_entities>`},{type:"text",text:`<data_flow>${a}</data_flow>`},{cachePoint:{type:"default"}},{type:"text",text:`<threats>${o}</threats>`},{type:"text",text:`<gap>${s}</gap>`},{type:"text",text:"Identify missing threats and respective mitigations for the solution"}],u=this.base_msg(!0);return u.push(...c),new pt({content:u})}createGapAnalysisMessage(e,r,n,s){const i=typeof e=="string"?e:JSON.stringify(e),a=typeof r=="string"?r:JSON.stringify(r),o=typeof n=="string"?n:JSON.stringify(n),c=[{type:"text",text:`<identified_assets_and_entities>${i}</identified_assets_and_entities>`},{type:"text",text:`<data_flow>${a}</data_flow>`},{cachePoint:{type:"default"}},{type:"text",text:`<threats>${o}</threats>`},{type:"text",text:`<previous_gap>${s}</previous_gap>
`},{type:"text",text:"Identify missing threats and respective mitigations for the solution"}],u=this.base_msg(!0);return u.push(...c),new pt({content:u})}}function Xa(t){return!t||t.length===0?" ":t.join(`
`)}const eL=40;function tL(){return[{type:"text",text:`<instruction>
   Use the information provided by the user to generate a short headline summary of max ${eL} words.
   </instruction> 

      `}]}function rL(){return[{type:"text",text:`<instruction>
   You are an expert in all security domains and threat modeling. Your role is to carefully review a given architecture and identify key assets and entities that require protection. Follow these steps:

   1. Review the provided inputs carefully:

         * <architecture_diagram>: Architecture Diagram of the solution in scope for threat modeling.
         * <description>: [Description of the solution provided by the user]
         * <assumptions>: [Assumptions provided by the user]

   2. Identify the most critical assets within the system, such as sensitive data, databases, communication channels, or APIs. These are components that need protection.

   3. Identify the key entities involved, such as users, services, or systems interacting with the system.

   4. For each identified asset or entity, provide the following information in the specified format:

   Type: [Asset or Entity]
   Name: [Asset/Entity Name]
   Description: [Brief description of the asset/entity]
   </instruction> 

      `}]}function nL(){return[{type:"text",text:`
<task>
You are an expert in all security domains and threat modeling. Your goal is to systematically analyze the given system architecture and identify critical security elements: data flows, trust boundaries, and relevant threat actors. Your analysis must be comprehensive, architecturally-grounded, and focused on elements that impact the security posture of the system.
</task>

<instructions>

1. Review the provided inputs carefully:

   * <architecture_diagram>: Architecture Diagram of the solution in scope for threat modeling.
   * <description>: [Description of the solution provided by the user]
   * <assumptions>: [Assumptions provided by the user]
   * <identified_assets_and_entities>: Inventory of key assets and entities in the architecture.

2. Data Flow Analysis:

   **Definition**: Data flows represent the movement of information between system components, including the path, direction, and security context of the data movement.

   **Identification approach**:
   - Map all significant data movements between identified assets and entities
   - Consider both internal flows (within trust boundaries) and external flows (crossing trust boundaries)
   - Focus on flows involving sensitive data, authentication credentials, or business-critical information
   - Include bidirectional flows where relevant
   - Consider both primary operational flows and secondary flows (logs, backups, monitoring)

   **Use the following format for each data flow**:
   <data_flow_definition>
   flow_description: [Clear description of what data moves and how]
   source_entity: [Source entity name from assets inventory]
   target_entity: [Target entity name from assets inventory]
   assets: [List of specific assets/data types involved in this flow]
   flow_type: [Internal/External/Cross-boundary]
   criticality: [High/Medium/Low - based on data sensitivity and business impact]
   </data_flow_definition>

3. Trust Boundary Analysis:

   **Definition**: Trust boundaries are logical or physical barriers where the level of trust changes, typically representing transitions between different security domains, ownership, or control levels.

   **Identification criteria**:
   - Network boundaries (internal to external networks, DMZ transitions)
   - Process boundaries (different applications, services, or execution contexts)
   - Physical boundaries (on-premises to cloud, different data centers)
   - Organizational boundaries (internal systems to third-party services)
   - Administrative boundaries (different management domains or privilege levels)

   **Use the following format for each trust boundary**:
   <trust_boundary>
   purpose: [Security purpose and what trust level change occurs]
   source_entity: [Entity on the higher trust side]
   target_entity: [Entity on the lower trust side]
   boundary_type: [Network/Process/Physical/Organizational/Administrative]
   security_controls: [Existing controls at this boundary, if known]
   </trust_boundary>

4. Threat Actor Analysis:

   **Definition**: Threat actors are individuals, groups, or entities with the potential to compromise the system's security objectives.

   **Output format**: Present threat actors in a concise table format:

   | Category | Description | Examples |
   |----------|-------------|----------|
   | [Actor Category] | [One sentence describing their relevance to this architecture] | [Brief list of 1-2 specific actor types] |

   **Standard threat actor categories to consider**:
   - Legitimate Users (unintentional threats)
   - Malicious Internal Actors (intentional insider threats)
   - External Threat Actors (external attackers)
   - Untrusted Data Suppliers (third-party integrations)
   - Unauthorized External Users (no legitimate access)
   - Compromised System Components (if applicable)

   **Selection criteria**:
   - Only include categories with clear relevance to the architecture
   - Maximum 5-7 threat actor categories
   - Focus on actor types, not attack methods
   - Keep descriptions to ONE concise sentence
   - Examples should be 2-5 words each

   **Output constraints**:
   - No attack scenarios or narratives
   - No detailed technical descriptions
   - No step-by-step attack explanations
   - Focus on WHO might attack, not HOW

5. Analysis guidelines:

   **Completeness requirements**:
   - Address all identified assets and entities from the provided inventory
   - Consider the full system lifecycle (deployment, operation, maintenance, decommissioning)
   - Include both automated and manual processes
   - Account for emergency or disaster recovery scenarios if mentioned

   **Contextual alignment**:
   - Respect the stated assumptions and constraints
   - Focus on elements relevant to the described solution and deployment model
   - Consider the organization's threat landscape based on provided context
   - Align with the technical architecture and technology stack described

   **Prioritization approach**:
   - Prioritize high-criticality flows involving sensitive data
   - Focus on trust boundaries with significant security implications
   - Emphasize threat actors with realistic access to the described architecture

6. Quality control checklist:

   **Data Flows**:
   * [ ] Are all significant data movements between assets identified?
   * [ ] Are both internal and cross-boundary flows covered?
   * [ ] Is the criticality assessment based on data sensitivity and business impact?
   * [ ] Are flow descriptions specific and technically accurate?

   **Trust Boundaries**:
   * [ ] Are all significant trust level transitions identified?
   * [ ] Is the security purpose of each boundary clearly articulated?
   * [ ] Are different types of boundaries (network, process, physical, etc.) considered?
   * [ ] Do boundaries align with the described architecture?

   **Threat Actors**:
   * [ ] Is the output in table format with Category, Description, Examples columns?
   * [ ] Are descriptions limited to ONE sentence?
   * [ ] Are examples brief (2-5 words each)?
   * [ ] Is the total count reasonable (typically 5-7 categories)?
   * [ ] Does the analysis avoid attack scenarios and technical details?

   **Overall Analysis**:
   * [ ] Does the analysis cover all provided assets and entities?
   * [ ] Is the analysis consistent with stated assumptions?
   * [ ] Are security-critical elements prioritized appropriately?
   * [ ] Would this analysis support effective threat modeling?
</instructions>
`}]}function by(t=null){const e=`
You are an expert threat modeling specialist performing gap analysis on a threat catalog. You will identify ONLY realistic, actionable gaps that respect all provided constraints and remain within customer control boundaries.

<critical_validation_requirements>
BEFORE identifying any gap, you MUST verify:
1. If <assumptions> are provided: The gap does NOT contradict any assumption
2. The gap represents a REALISTIC and EXPLOITABLE vulnerability, not purely theoretical
3. The threat actor who could exploit this gap EXISTS in <data_flow> threat_sources
4. The customer CAN actually address this gap (within their control)
5. The gap represents a real architectural vulnerability with practical attack vectors

If a potential gap fails ANY of these checks, DO NOT include it in your analysis.
</critical_validation_requirements>

<assumption_enforcement>
**WHEN ASSUMPTIONS ARE PROVIDED:**
Assumptions are ABSOLUTE constraints that override all other considerations:
- If assumption states "X is trusted" → DO NOT identify gaps about X being compromised
- If assumption states "Y security is implemented" → DO NOT flag Y as missing
- If assumption states "Z is out of scope" → DO NOT analyze Z for gaps
- Previous security decisions reflected in assumptions are FINAL

**WHEN NO ASSUMPTIONS ARE PROVIDED:**
Use reasonable security baselines for the given context:
- Assume standard security controls are NOT necessarily in place
- Identify gaps based on common threat patterns and vulnerabilities
- Focus on practical, customer-addressable security gaps
- Consider industry-standard expectations for the system type

WHY THIS MATTERS: When provided, assumptions reflect security decisions already made by the system owner. Identifying gaps that violate assumptions creates noise, wastes resources, and undermines the credibility of your analysis.
</assumption_enforcement>

<gap_realism_guidance>
Every identified gap must represent a REALISTIC and EXPLOITABLE vulnerability.

**Identify gaps that:**
- Have documented real-world attack patterns
- Can be exploited with reasonable attacker capabilities
- Represent common architectural oversights or misconfigurations
- Have clear, practical attack paths
- Are relevant to the specific system context
- Would be reasonably targeted by threat actors

**Avoid gaps based on:**
- Purely theoretical vulnerabilities without known exploits
- Attacks requiring unrealistic resources (e.g., breaking modern encryption)
- Multiple highly unlikely conditions occurring simultaneously
- Vulnerabilities that assume attackers have impossible capabilities
- Academic research without practical weaponization
- Scenarios that ignore attack economics (cost vs. benefit)

**Realism Check Questions:**
- Has this type of gap been exploited in similar real-world systems?
- Would a rational attacker invest in exploiting this gap?
- Is there a clear, practical attack path?
- Do the required preconditions make sense for this system?
- Would addressing this gap materially improve security posture?
</gap_realism_guidance>

<gap_analysis_process>
Execute this EXACT sequence for gap identification:

## Step 1: Map Coverage Matrix
Create a mental matrix of:
- Rows: Each asset/entity from architecture
- Columns: STRIDE categories (S,T,R,I,D,E)
- Cells: Mark which have existing threats

## Step 2: For Each Empty Cell
Ask these questions IN ORDER:

**2.1 Assumption Check (Conditional)**
- IF assumptions exist:
  - Does any assumption make this gap irrelevant?
  - Would identifying this gap contradict an assumption?
  - If YES to either → SKIP this gap entirely
- IF no assumptions provided → Continue to 2.2

**2.2 Realism Validation**
- Does this gap represent a realistic, exploitable vulnerability?
- Review against <gap_realism_guidance>
- Is there a practical attack path for this gap?
- If NO to any → SKIP this gap entirely
- If YES → Continue to 2.3

**2.3 Architectural Relevance**
- Does this STRIDE category apply to this component type?
- Is this gap architecturally possible given the system design?
- Does the system design actually have this exposure point?
- If NO to any → SKIP this gap

**2.4 Threat Source Validation**
- Which actor from <data_flow> could exploit this?
- Is that actor explicitly listed in threat_sources?
- Could this actor realistically access/exploit this gap?
- If NO actor found or unrealistic access → SKIP this gap

**2.5 Control Boundary Check**
- Can the customer implement controls for this gap?
- Is this within their shared responsibility boundary?
- Are mitigations technically and practically feasible?
- If NO to any → SKIP this gap

**2.6 Materiality Assessment**
- Would exploiting this gap enable significant impact?
- Is the risk meaningful enough to warrant attention?
- Does addressing this gap provide substantial security value?
- If NO to any → CONSIDER skipping

## Step 3: Document Valid Gaps
Only gaps passing ALL checks should be documented.
</gap_analysis_process>

<shared_responsibility_boundaries>
NEVER identify gaps for provider-controlled elements:

**IaaS Boundaries**:
- ✅ Customer gap: "No OS hardening threats identified"
- ✅ Customer gap: "Missing threats for insecure container configurations"
- ❌ Invalid gap: "No hypervisor escape threats identified"
- ❌ Invalid gap: "Missing threats for datacenter physical security"

**PaaS Boundaries**:
- ✅ Customer gap: "No application configuration threats identified"
- ✅ Customer gap: "Missing threats for insecure API authentication"
- ❌ Invalid gap: "No platform runtime vulnerability threats identified"
- ❌ Invalid gap: "Missing threats for managed service code flaws"

**SaaS Boundaries**:
- ✅ Customer gap: "No data classification threats identified"
- ✅ Customer gap: "Missing threats for user permission misconfigurations"
- ❌ Invalid gap: "No SaaS application code threats identified"
- ❌ Invalid gap: "Missing threats for SaaS provider infrastructure"
</shared_responsibility_boundaries>

<examples_of_proper_gap_identification>
## Example 1: With Network Security Assumption
**Assumption**: "Internal network is considered trusted"
**Wrong Gap**: "No threats for internal network compromise"
**Correct Approach**: Skip this entirely - assumption makes it out of scope

## Example 2: Without Network Assumption
**No Assumption Provided**
**Valid Gap**: "No threats identified for lateral movement via compromised internal endpoints"
**Why Valid**: Common real-world attack pattern, customer-controllable, realistic threat

## Example 3: With Authentication Implementation
**Assumption**: "MFA is implemented for all user access"
**Wrong Gap**: "Missing threats for single-factor authentication bypass"
**Correct Gap**: "No threats identified for MFA fatigue attacks or push notification bombing"
**Why Valid**: MFA exists per assumption, but fatigue attacks are a realistic bypass method

**Realistic Gap**: "No threats for API rate limiting bypass enabling account enumeration"
**Why Valid**: Common vulnerability, practical attack, customer can implement rate limiting
</examples_of_proper_gap_identification>

<coverage_quality_criteria>
When assessing existing threat coverage, verify:

1. **Source Accuracy**: Does each threat use an actor from <data_flow>?
2. **Assumption Compliance** (if provided): Do threats respect all assumptions?
3. **Realism**: Do threats represent practical, exploitable vulnerabilities?
4. **Architectural Alignment**: Do threats map to real components?
5. **STRIDE Appropriateness**: Are categories applied sensibly?
6. **Mitigation Feasibility**: Can customers implement the controls?

Poor quality in existing threats is itself a gap to report, including:
- Threats that violate assumptions
- Unrealistic or theoretical threats
- Threats outside customer control
- Threats that don't match architecture
</coverage_quality_criteria>

<decision_logic>
## Determine stop flag:

**Set stop = TRUE when ALL of these are true:**
- Every threat source in <data_flow> has adequate coverage
- All critical assets have appropriate STRIDE coverage (respecting assumptions when provided)
- No realistic, exploitable attack chain gaps exist within customer control
- Existing threats respect all assumptions (when provided) and boundaries
- Existing threats focus on realistic, practical vulnerabilities
- Coverage quality meets minimum standards

**Set stop = FALSE when ANY of these are true:**
- Threat sources from <data_flow> lack coverage
- Critical assets miss relevant STRIDE categories (not excluded by assumptions)
- Realistic, customer-addressable attack chains have exploitable gaps
- Existing threats violate assumptions (when provided) - quality gap
- Existing threats include unrealistic or theoretical scenarios
- Customer-controllable vulnerabilities lack coverage

If stop = TRUE, state: "Threat catalog is comprehensive within defined boundaries [and assumptions, if provided]. No actionable gaps identified. Coverage includes realistic threats within customer control."

If stop = FALSE, provide detailed gap analysis with focus on realistic, exploitable gaps.
</decision_logic>

<output_requirements>
**Gap Analysis Summary:**
[Explicitly state whether gaps respect assumptions (if provided) and remain within customer control. Emphasize that all gaps represent realistic, exploitable vulnerabilities. Mention the total number of valid gaps identified after rigorous filtering.]

**For EACH identified gap:**

**Gap [#]: [Specific, realistic, assumption-compliant gap description]**
- **Pre-validation** (if assumptions provided): "This gap respects assumption [X] because [explanation]"
- **STRIDE Category**: [Relevant category that makes sense architecturally]
- **Affected Assets/Flows**: [Specific components from architecture]
- **Threat Source**: [EXACT actor name from data_flow threat_sources]
- **Practical Attack Path**: [How this gap could be realistically exploited, 20-50words]
- **Why This Matters**: [Real-world exploit scenario with business impact, 20-50words]

**Quality over Quantity:**
Report significant, validated, realistic gaps rather than many questionable or theoretical ones. Each gap must be:
- Practically exploitable
- Actionable by the customer
- Respect all constraints (assumptions, boundaries, realism)
- Based on documented attack patterns where possible

**Improvement Tracking:**
If <previous_gap> provided, explicitly note:
- Which previous gaps have been addressed and how
- Which persist and why they remain important
- Any new gaps that emerged
- Whether new gaps are based on realistic threats
</output_requirements>

<final_checklist>
Before submitting your analysis, verify:
□ Every gap represents a REALISTIC, exploitable vulnerability
□ Every gap has been checked against ALL assumptions (if provided)
□ Every gap traces to a threat source in <data_flow>
□ Every gap is within customer control boundary
□ Every gap has a clear, practical attack path
□ No gaps duplicate or contradict each other
□ All recommendations are implementable by the customer
□ Gaps prioritize real-world attack patterns over theoretical concerns

If any check fails, remove that gap from your analysis.
</final_checklist>

<realistic_gap_examples>
## High-Quality Realistic Gaps:

**Example 1:**
"Gap: No threats identified for session token theft through XSS in user-generated content"
- Realistic: OWASP Top 10, common vulnerability
- Practical attack: Documented exploits, attacker tools available
- Customer control: Input validation, CSP headers, output encoding

**Example 2:**
"Gap: Missing threats for privilege escalation via overly permissive IAM roles"
- Realistic: Common cloud misconfiguration
- Practical attack: Standard cloud penetration testing technique
- Customer control: IAM policy review, least privilege implementation

## Low-Quality Unrealistic Gaps:

**Example 1 (Avoid):**
"Gap: No threats for side-channel attacks extracting encryption keys from CPU cache timing"
- Unrealistic for most systems: Requires sophisticated attacker, specific access
- Not practical: High complexity, limited applicability
- Poor fit: Usually outside customer's practical control

**Example 2 (Avoid):**
"Gap: Missing threats for AI-powered automated vulnerability discovery and exploitation"
- Too theoretical: Emerging threat without widespread real-world use
- Unclear attack path: Vague methodology
- Not actionable: No clear mitigation strategy
</realistic_gap_examples>
      `,r=`
<important_instructions>
         ${t}
         </important_instructions>
      `;return t?[{type:"text",text:r+e}]:[{type:"text",text:e}]}function Zo(t=null){const e=`
You are an expert threat modeling specialist tasked with enriching an existing threat catalog using STRIDE methodology. You will identify new, actionable, and realistic threats that respect all provided constraints.

<critical_instructions>
BEFORE generating any threat, you MUST:
1. If <assumptions> are provided: Verify it doesn't violate any assumption
2. Verify the threat actor exists in <data_flow> threat_sources
3. Confirm it's not a duplicate of existing threats
4. Ensure it's within customer control boundary
5. Validate the threat is realistic and plausible

If a potential threat fails ANY of these checks, DO NOT include it.
</critical_instructions>

<assumption_enforcement>
**WHEN ASSUMPTIONS ARE PROVIDED:**
Assumptions define what is already secure or out of scope. These are non-negotiable constraints:
- If an assumption states "X is trusted", DO NOT generate threats about X being compromised
- If an assumption states "Y is already implemented", DO NOT suggest Y as a mitigation
- If an assumption defines a security boundary, RESPECT it completely
- Assumptions override all other considerations

**WHEN NO ASSUMPTIONS ARE PROVIDED:**
Use reasonable security baselines for the given context:
- Assume standard security best practices are NOT necessarily in place
- Consider common misconfigurations and oversights
- Focus on threats the customer can realistically address

WHY THIS MATTERS: When provided, assumptions reflect security decisions already made by the system owner. Violating them wastes time and undermines credibility.
</assumption_enforcement>

<threat_realism_guidance>
Every threat must be REALISTIC and PLAUSIBLE. Apply these filters:

**Generate threats that:**
- Have documented real-world precedent or clear attack paths
- Can be executed with reasonable attacker resources/skill
- Target common vulnerabilities or misconfigurations
- Have logical cause-and-effect relationships
- Are relevant to the specific system architecture

**Avoid threats that:**
- Require nation-state resources for low-value targets
- Depend on multiple highly unlikely events occurring simultaneously
- Assume attackers have unrealistic capabilities (e.g., "break AES-256 encryption")
- Are purely theoretical without practical attack vectors
- Ignore basic economics of attacks (effort vs. reward)

**Reality Check Questions:**
- Has this type of attack happened before in similar systems?
- Would a rational attacker invest resources in this approach?
- Is the attack technically feasible with current knowledge/tools?
- Does the attack path make practical sense?
</threat_realism_guidance>

<threat_generation_process>
For EACH potential threat, follow this exact sequence:

**1. Assumption Check (Conditional)**
   - IF assumptions exist: Ask "Does this threat contradict any assumption?"
     - If YES → Skip this threat entirely
     - If NO → Continue to step 2
   - IF no assumptions provided: Continue to step 2

**2. Realism Validation**
   - Ask: "Is this threat plausible and realistic?"
   - Review against <threat_realism_guidance>
   - If NO → Skip this threat entirely
   - If YES → Continue to step 3

**3. Source Validation**
   - Find the exact threat source in <data_flow> threat_sources
   - Ask: "Is this actor explicitly listed?"
   - If NO → Skip this threat entirely
   - If YES → Continue to step 4

**4. Duplication Check**
   - Compare against ALL existing threats
   - Ask: "Is this meaningfully different?"
   - If NO → Skip this threat entirely
   - If YES → Continue to step 5

**5. Control Boundary Check**
   - Identify who can mitigate this threat
   - Ask: "Can the customer control this?"
   - If NO → Skip this threat entirely
   - If YES → Continue to step 6

**6. Gap Relevance Check**
   - Review the <gap> analysis (if provided)
   - Ask: "Does this address an identified gap?"
   - If NO → Consider if it's still valuable
   - If YES → Proceed to format the threat

Only after passing ALL checks should you include the threat.
</threat_generation_process>

<shared_responsibility_boundaries>
You MUST respect these service model boundaries:

- **IaaS**: Customer controls from OS up; exclude hypervisor/hardware threats
- **PaaS**: Customer controls application and data; exclude platform runtime threats
- **SaaS**: Customer controls configuration and data; exclude application code threats

Never suggest the customer can mitigate provider-level vulnerabilities. Focus on:
- Misconfigurations the customer can fix
- Weak customer-controlled security settings
- Missing customer-implementable controls
- Insecure customer usage patterns
</shared_responsibility_boundaries>

<threat_format_template>
Structure each threat EXACTLY as:
"[Actor from data_flow] can [specific action] by [concrete method], causing [measurable impact] to [identified asset]"

Include:
- **Realism Justification**: "This threat is realistic because [real-world examples/feasible attack path]"
- **Assumption Compliance** (if assumptions provided): "This threat respects assumption X because..."
- **Gap Addressed** (if gap analysis provided): "This fills the gap in [specific area]"
- **Not a Duplicate Because**: "Unlike existing threat Y, this focuses on..."
- **Customer Control**: "The customer can mitigate this by..."
</threat_format_template>

<quality_validation>
Before finalizing your threat list:
1. **Realism check** - Are all threats practically feasible?
2. **Assumption compliance** (if provided) - Does any threat violate them?
3. **Source accuracy** - Do all match <data_flow> exactly?
4. **Duplication check** - Are threats genuinely distinct?
5. **Customer control** - Can they actually implement the mitigations?
6. **Gap coverage** (if provided) - Are you addressing identified weaknesses?

If you find any issues during validation, REMOVE those threats rather than trying to justify them.
</quality_validation>

<examples_of_realistic_threats>
**Example 1: Realistic**
✓ "Attacker can exploit default admin credentials on publicly exposed admin panel, causing unauthorized access to customer data"
- Real-world precedent: Common in breach reports
- Feasible: Requires basic scanning and credential stuffing
- Practical: Attackers routinely scan for default credentials

**Example 2: Unrealistic**
✗ "Attacker can break TLS 1.3 encryption through cryptographic breakthrough, exposing all transmitted data"
- No real-world precedent for TLS 1.3 breaks
- Requires theoretical breakthrough in mathematics
- Impractical: Nation-state level resources for minimal gain

**Example 3: Realistic with Context**
✓ "Insider with legitimate access can exfiltrate database backups through approved cloud storage sync tool, bypassing DLP controls"
- Real-world precedent: Common insider threat vector
- Feasible: Uses legitimate tools and access
- Practical: Clear attack path with available tools
</examples_of_realistic_threats>

<examples_of_assumption_respect>
**Example 1: If assumption states "Internal network is trusted"**
- WRONG: "Internal attacker can intercept traffic"
- RIGHT: "External attacker can exploit misconfigured firewall rules"

**Example 2: If assumption states "MFA is implemented for all users"**
- WRONG: "Attacker can bypass authentication without MFA"
- RIGHT: "Attacker can exploit MFA fatigue through repeated push notifications"

**Example 3: If assumption states "Cloud provider security is out of scope"**
- WRONG: "AWS S3 service could be compromised"
- RIGHT: "Misconfigured S3 bucket permissions could expose data"

**Example 4: If NO assumptions are provided**
- ACCEPTABLE: "Attacker can gain access through weak password policy, causing account compromise"
- ACCEPTABLE: "Internal user can access data without MFA, allowing unauthorized access after credential theft"
</examples_of_assumption_respect>

<output_requirements>
Generate high-quality threats that:
- Pass ALL validation checks (including realism)
- Address identified gaps (if gap analysis provided)
- Respect ALL assumptions without exception (if assumptions provided)
- Use only threat actors from data_flow
- Are realistic and practically feasible
- Provide actionable, customer-implementable mitigations
- Add genuine value beyond existing threats
- Set Starred to False

**Quality over quantity**: It's better to provide 3 excellent, realistic, compliant threats than 10 that violate boundaries or strain credibility.
</output_requirements>
   `,r=`
<important_instructions>
         ${t}
         </important_instructions>
      `;return t?[{type:"text",text:r+e}]:[{type:"text",text:e}]}function sL(t=null){return Zo(t)}const rr={START:"START",ASSETS:"ASSETS",FLOW:"FLOW",THREAT:"THREAT",THREAT_RETRY:"THREAT_RETRY",FINALIZE:"FINALIZE",COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"},Cc=0,wE=1,iL=15;function Nr(t,e){var r;if((r=t==null?void 0:t.signal)!=null&&r.aborted){console.log(`Workflow aborted, skipping ${e}`);const n=new Error("AbortError");throw n.name="AbortError",n}}function St(t){const e=ce.getJobStatus(t);return(e==null?void 0:e.state)===rr.CANCELLED}function uu(t){if(t.content&&Array.isArray(t.content)&&t.content.length>0){const e=t.content[0];if(e&&typeof e=="object"){const r=e.reasoning_content;if(r&&r.text)return r.text}}return null}async function aL(t,e){var n;if(console.log("Node: generateSummary"),Nr(e,"generateSummary"),t.summary)return console.log("Summary already exists, skipping generation"),{image_data:t.image_data};const r=t.job_id||"unknown";try{if(St(r)){console.log(`Job ${r} was cancelled, aborting generateSummary`);const p=new Error("AbortError");throw p.name="AbortError",p}const i=new Ka(t.image_data,t.description||"",Xa(t.assumptions||[])).createSummaryMessage(40),o=[new lt({content:tL()}),i],c=(n=e.configurable)==null?void 0:n.model_summary;if(!c){const p=new Error("Summary model not found in config");throw console.error("Configuration error:",p.message),p}const u=Li(async p=>p,{name:"summary_state",description:"Generate a summary of the architecture",schema:B2}),l=c.bindTools([u]);console.log(`Invoking summary model for job ${r}`);const d=await l.invoke(o);if(Nr(e,"generateSummary (after model invocation)"),St(r)){console.log(`Job ${r} was cancelled during model invocation`);const p=new Error("AbortError");throw p.name="AbortError",p}const h=d.tool_calls[0].args;return console.log(`Summary generated successfully for job ${r}`),{image_data:t.image_data,summary:h.summary}}catch(s){if(s.name==="AbortError"||s.message==="AbortError")console.log(`generateSummary aborted for job ${r}`);else if(console.error(`Error in generateSummary for job ${r}:`,s),console.error("Error details:",{name:s.name,message:s.message}),!St(r))try{ce.setJobStatus(r,rr.FAILED,t.retry||0)}catch(a){console.error(`Failed to update job status for ${r}:`,a)}throw s}}async function oL(t,e){var n,s;console.log("Node: defineAssets"),Nr(e,"defineAssets");const r=t.job_id||"unknown";try{if(St(r)){console.log(`Job ${r} was cancelled, aborting defineAssets`);const y=new Error("AbortError");throw y.name="AbortError",y}ce.setJobStatus(r,rr.ASSETS,t.retry||0);const a=new Ka(t.image_data,t.description||"",Xa(t.assumptions||[])).createAssetMessage(),c=[new lt({content:rL()}),a],u=(n=e.configurable)==null?void 0:n.model_assets;if(!u){const y=new Error("Assets model not found in config");throw console.error("Configuration error:",y.message),y}const l=((s=e.configurable)==null?void 0:s.reasoning)||0,d=Li(async y=>y,{name:"assets_list",description:"Define the list of system assets",schema:j2}),m=(u.model||"").includes("sonnet")?u.bindTools([d],{tool_choice:l>0?void 0:"any"}):u.bindTools([d]);console.log(`Invoking assets model for job ${r}`);const _=await m.invoke(c);if(Nr(e,"defineAssets (after model invocation)"),St(r)){console.log(`Job ${r} was cancelled during model invocation`);const y=new Error("AbortError");throw y.name="AbortError",y}const v=_.tool_calls[0].args;if(l>0){const y=uu(_);y&&ce.updateJobTrail(r,{assets:y})}return console.log(`Assets defined successfully for job ${r}`),{assets:v}}catch(i){if(i.name==="AbortError"||i.message==="AbortError")console.log(`defineAssets aborted for job ${r}`);else if(console.error(`Error in defineAssets for job ${r}:`,i),console.error("Error details:",{name:i.name,message:i.message}),!St(r))try{ce.setJobStatus(r,rr.FAILED,t.retry||0)}catch(o){console.error(`Failed to update job status for ${r}:`,o)}throw i}}async function cL(t,e){var n,s;console.log("Node: defineFlows"),Nr(e,"defineFlows");const r=t.job_id||"unknown";try{if(St(r)){console.log(`Job ${r} was cancelled, aborting defineFlows`);const y=new Error("AbortError");throw y.name="AbortError",y}ce.setJobStatus(r,rr.FLOW,t.retry||0);const a=new Ka(t.image_data,t.description||"",Xa(t.assumptions||[])).createSystemFlowsMessage(t.assets),c=[new lt({content:nL()}),a],u=(n=e.configurable)==null?void 0:n.model_flows;if(!u){const y=new Error("Flows model not found in config");throw console.error("Configuration error:",y.message),y}const l=((s=e.configurable)==null?void 0:s.reasoning)||0,d=Li(async y=>y,{name:"flows_list",description:"Define data flows, trust boundaries, and threat sources",schema:H2}),m=(u.model||"").includes("sonnet")?u.bindTools([d],{tool_choice:l>0?void 0:"any"}):u.bindTools([d]);console.log(`Invoking flows model for job ${r}`);const _=await m.invoke(c);if(Nr(e,"defineFlows (after model invocation)"),St(r)){console.log(`Job ${r} was cancelled during model invocation`);const y=new Error("AbortError");throw y.name="AbortError",y}const v=_.tool_calls[0].args;if(l>0){const y=uu(_);y&&ce.updateJobTrail(r,{flows:y})}return console.log(`Flows defined successfully for job ${r}`),{system_architecture:v}}catch(i){if(i.name==="AbortError"||i.message==="AbortError")console.log(`defineFlows aborted for job ${r}`);else if(console.error(`Error in defineFlows for job ${r}:`,i),console.error("Error details:",{name:i.name,message:i.message}),!St(r))try{ce.setJobStatus(r,rr.FAILED,t.retry||0)}catch(o){console.error(`Failed to update job status for ${r}:`,o)}throw i}}async function uL(t,e){var a,o,c;console.log("Node: defineThreats"),Nr(e,"defineThreats");const r=t.job_id||"unknown",n=parseInt(t.retry||0),s=parseInt(t.iteration||0),i=((a=e.configurable)==null?void 0:a.max_retry)||iL;try{if(St(r)){console.log(`Job ${r} was cancelled, aborting defineThreats`);const ee=new Error("AbortError");throw ee.name="AbortError",ee}const u=n>=i,l=n>=s&&s!==0;if(u||l)return console.log(`Iteration limit reached for job ${r} (retry: ${n}, iteration: ${s}, max: ${i})`),ce.setJobStatus(r,rr.FINALIZE,n),new Gt({goto:"finalize"});const d=n+1;n>0?ce.setJobStatus(r,rr.THREAT_RETRY,d):ce.setJobStatus(r,rr.THREAT,d);const h=t.gap||[],p=t.threat_list,m=(p==null?void 0:p.threats)||[],_=new Ka(t.image_data,t.description||"",Xa(t.assumptions||[]));let v,y;n>0||m.length>0?(v=_.createThreatImproveMessage(t.assets,t.system_architecture,t.threat_list,h),t.replay&&t.instructions?y=new lt({content:Zo(t.instructions)}):y=new lt({content:Zo()})):(v=_.createThreatMessage(t.assets,t.system_architecture),t.replay&&t.instructions?y=new lt({content:sL(t.instructions)}):y=new lt({content:Zo()}));const E=[y,v],b=(o=e.configurable)==null?void 0:o.model_threats;if(!b)throw new Error("Threats model not found in config");const I=((c=e.configurable)==null?void 0:c.reasoning)||0,k=Li(async ee=>ee,{name:"threats_list",description:"Define the list of security threats",schema:W2}),T=(b.model||"").includes("sonnet")?b.bindTools([k],{tool_choice:I>0?void 0:"any"}):b.bindTools([k]);console.log(`Invoking threats model for job ${r} (iteration ${n+1})`);const H=await T.invoke(E);if(Nr(e,"defineThreats (after model invocation)"),St(r)){console.log(`Job ${r} was cancelled during model invocation`);const ee=new Error("AbortError");throw ee.name="AbortError",ee}const q=H.tool_calls[0].args;if(I>0){const ee=uu(H);ee&&((n===0?Cc:wE)===Cc?ce.updateJobTrail(r,{threats:[ee]}):ce.updateJobTrail(r,{threats:ee}))}const se=n+1;return s===0?(console.log(`Job ${r}: Auto mode (iteration 0), routing to gap analysis`),new Gt({goto:"gap_analysis",update:{threat_list:q,retry:se}})):(console.log(`Job ${r}: Fixed iteration mode, looping back to threats`),new Gt({goto:"define_threats",update:{threat_list:q,retry:se}}))}catch(u){if(u.name==="AbortError"||u.message==="AbortError")console.log(`defineThreats aborted for job ${r}`);else if(console.error(`Error in defineThreats for job ${r}:`,u),console.error("Error details:",{name:u.name,message:u.message}),!St(r))try{ce.setJobStatus(r,rr.FAILED,t.retry||0)}catch(d){console.error(`Failed to update job status for ${r}:`,d)}throw u}}async function lL(t,e){var n,s;console.log("Node: gapAnalysis"),Nr(e,"gapAnalysis");const r=t.job_id||"unknown";try{if(St(r)){console.log(`Job ${r} was cancelled, aborting gapAnalysis`);const y=new Error("AbortError");throw y.name="AbortError",y}const a=new Ka(t.image_data,t.description||"",Xa(t.assumptions||[])).createGapAnalysisMessage(t.assets,t.system_architecture,t.threat_list||"",t.gap||[]);let o;t.replay&&t.instructions?o=new lt({content:by(t.instructions)}):o=new lt({content:by()});const c=[o,a],u=(n=e.configurable)==null?void 0:n.model_gaps;if(!u){const y=new Error("Gaps model not found in config");throw console.error("Configuration error:",y.message),y}const l=((s=e.configurable)==null?void 0:s.reasoning)||0,d=Li(async y=>y,{name:"continue_threat_modeling",description:"Analyze gaps and decide whether to continue threat modeling",schema:J2}),m=(u.model||"").includes("sonnet")?u.bindTools([d],{tool_choice:l>0?void 0:"any"}):u.bindTools([d]);console.log(`Invoking gap analysis model for job ${r}`);const _=await m.invoke(c);if(Nr(e,"gapAnalysis (after model invocation)"),St(r)){console.log(`Job ${r} was cancelled during model invocation`);const y=new Error("AbortError");throw y.name="AbortError",y}const v=_.tool_calls[0].args;if(l>0){const y=uu(_);y&&((parseInt(t.retry||0)===0?Cc:wE)===Cc?ce.updateJobTrail(r,{gaps:[y]}):ce.updateJobTrail(r,{gaps:y}))}return v.stop?(console.log(`Job ${r}: Gap analysis determined to stop, routing to finalize`),new Gt({goto:"finalize"})):(console.log(`Job ${r}: Gap analysis determined to continue, routing to define_threats`),new Gt({goto:"define_threats",update:{gap:[v.gap]}}))}catch(i){if(i.name==="AbortError"||i.message==="AbortError")console.log(`gapAnalysis aborted for job ${r}`);else if(console.error(`Error in gapAnalysis for job ${r}:`,i),console.error("Error details:",{name:i.name,message:i.message}),!St(r))try{ce.setJobStatus(r,rr.FAILED,t.retry||0)}catch(o){console.error(`Failed to update job status for ${r}:`,o)}throw i}}async function dL(t,e){console.log("Node: finalize"),Nr(e,"finalize");const r=t.job_id||"unknown";try{if(St(r)){console.log(`Job ${r} was cancelled before finalization, aborting`);const i=new Error("AbortError");throw i.name="AbortError",i}const n=parseInt(t.retry||0);console.log(`Finalizing job ${r} with ${n} completed iterations`),ce.setJobStatus(r,rr.FINALIZE,n);const s={job_id:r,s3_location:t.s3_location||"",owner:t.owner||"LIGHTNING_USER",title:t.title||"",summary:t.summary||"",description:t.description||"",assumptions:t.assumptions||[],assets:t.assets||null,system_architecture:t.system_architecture||null,threat_list:t.threat_list||null,retry:n,backup:null,completed_at:new Date().toISOString()};if(ce.setJobResults(r,s),await new Promise(i=>setTimeout(i,1e3)),Nr(e,"finalize (before completion)"),St(r)){console.log(`Job ${r} was cancelled during finalization delay`);const i=new Error("AbortError");throw i.name="AbortError",i}return ce.setJobStatus(r,rr.COMPLETE,n),console.log(`Job ${r} completed successfully`),{}}catch(n){if(n.name==="AbortError"||n.message==="AbortError")console.log(`finalize aborted for job ${r} - job was cancelled`);else if(console.error(`Error in finalize for job ${r}:`,n),console.error("Error details:",{name:n.name,message:n.message}),!St(r))try{ce.setJobStatus(r,rr.FAILED,t.retry||0);const i=ce.getJobResults(r)||{};ce.setJobResults(r,{...i,error:n.message||"Finalization failed",error_type:n.name||"Error",failed_at:new Date().toISOString()})}catch(i){console.error(`Failed to update job status for ${r}:`,i)}throw n}}function hL(t){if(console.log("Routing: routeReplay"),!t.replay)return"full";const e=t.job_id||"unknown";try{ce.updateJobTrail(e,{threats:[],gaps:[]});const r=ce.getJobResults(e);if(r&&r.backup){const n={...r,assets:r.backup.assets,system_architecture:r.backup.system_architecture,threat_list:r.backup.threat_list};ce.setJobResults(e,n)}return"replay"}catch(r){return console.error("Error in routeReplay:",r),"full"}}function fL(){console.log("Creating threat modeling workflow...");const t=new S2(X2);return t.addNode("generate_summary",aL),t.addNode("define_assets",oL),t.addNode("define_flows",cL),t.addNode("finalize",dL),t.addNode("define_threats",uL,{ends:["gap_analysis","define_threats","finalize"]}),t.addNode("gap_analysis",lL,{ends:["define_threats","finalize"]}),t.addEdge(Ge,"generate_summary"),t.addConditionalEdges("generate_summary",hL,{replay:"define_threats",full:"define_assets"}),t.addEdge("define_assets","define_flows"),t.addEdge("define_flows","define_threats"),t.addEdge("finalize",Pe),console.log("Workflow compiled successfully"),t.compile()}function pL(t){return!!(typeof t=="object"&&t&&"toolSpec"in t)}function Ey(t){if(t.every(Mv))return t.map(e=>({toolSpec:{name:e.function.name,description:e.function.description,inputSchema:{json:e.function.parameters}}}));if(t.every(iu))return t.map(e=>({toolSpec:{name:e.name,description:e.description,inputSchema:{json:hs(e.schema)?kr(e.schema):e.schema}}}));if(t.every(pL))return t;throw new Error("Invalid tools passed. Must be an array of StructuredToolInterface, ToolDefinition, or BedrockTool.")}function mL(t,e,r){const n=r.supportsToolChoiceValues??[];let s;if(typeof t=="string")switch(t){case"any":s={any:{}};break;case"auto":s={auto:{}};break;default:{if(!e.find(o=>{var c;return((c=o.toolSpec)==null?void 0:c.name)===t}))throw new Error(`Tool with name ${t} not found in tools list.`);s={tool:{name:t}}}}else s=t;const i=Object.keys(s)[0];if(!n.includes(i)){let a="";throw n.length?a=`Model ${r.model} does not currently support 'tool_choice' of type ${i}. The following 'tool_choice' types are supported: ${n.join(", ")}.`:a=`Model ${r.model} does not currently support 'tool_choice'.`,new Error(`${a} Please seehttps://docs.aws.amazon.com/bedrock/latest/APIReference/API_runtime_ToolChoice.htmlfor the latest documentation on models that support tool choice.`)}return s}function gL(t){if(t.includes("claude-3")||t.includes("claude-4")||t.includes("claude-opus-4")||t.includes("claude-sonnet-4"))return["auto","any","tool"];if(t.includes("mistral-large"))return["auto","any"]}const od={document(t){switch(t){case"text/csv":return"csv";case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":return"docx";case"text/html":return"html";case"text/markdown":return"md";case"application/pdf":return"pdf";case"text/plain":return"txt";case"application/vnd.ms-excel":return"xls";case"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":return"xlsx";default:return t}},image(t){switch(t){case"image/gif":return"gif";case"image/jpeg":return"jpeg";case"image/png":return"png";case"image/webp":return"webp";default:return t}},video(t){switch(t){case"video/flv":return"flv";case"video/mkv":return"mkv";case"video/mov":return"mov";case"video/mp4":return"mp4";case"video/mpeg":return"mpeg";case"video/mpg":return"mpg";case"video/three_gp":return"three_gp";case"video/webm":return"webm";case"video/wmv":return"wmv";default:return t}}};function yL(t){return{sourceContent:[{text:typeof t.citedText=="string"?t.citedText:""}],location:{documentChunk:{documentIndex:typeof t.source=="string"?Number(t.source):void 0,start:typeof t.startIndex=="number"?t.startIndex:void 0,end:typeof t.endIndex=="number"?t.endIndex:void 0}}}}function _L(t){var n;const e=(n=t.response_metadata)==null?void 0:n.model_provider;function*r(){var s;for(const i of t.contentBlocks)if(i.type==="text")(s=i.annotations)!=null&&s.length?yield{citationsContent:{content:[{text:i.text}],citations:i.annotations.map(yL)}}:yield{text:i.text};else{if(i.type==="audio")continue;if(i.type==="code_interpreter_call")continue;if(i.type==="code_interpreter_result")continue;if(i.type==="file"){const a=od.document(i.mimeType??"");if(i.data){const o=typeof i.data=="string"?Uint8Array.from(ln.from(i.data,"base64")):i.data;yield{document:{name:i.id,format:a,source:{bytes:o}}}}else i.fileId&&i.fileId.startsWith("s3://")&&(yield{document:{name:i.id,format:a,source:{s3Location:{uri:i.fileId}}}})}else if(i.type==="image"){const a=od.image(i.mimeType??"");if(i.data){const o=typeof i.data=="string"?Uint8Array.from(ln.from(i.data,"base64")):i.data;yield{image:{format:a,source:{bytes:o}}}}else i.fileId&&i.fileId.startsWith("s3://")&&(yield{image:{format:a,source:{s3Location:{uri:i.fileId}}}})}else{if(i.type==="invalid_tool_call")continue;if(i.type==="reasoning")yield{reasoningContent:{reasoningText:{text:i.reasoning}}};else{if(i.type==="server_tool_call")continue;if(i.type==="server_tool_call_chunk")continue;if(i.type==="server_tool_call_result")continue;if(i.type==="text-plain")continue;if(i.type==="tool_call")yield{toolUse:{toolUseId:i.id,name:i.name,input:i.args}};else{if(i.type==="tool_call_chunk")continue;if(i.type==="video"){const a=od.video(i.mimeType??"");if(i.data){const o=typeof i.data=="string"?Uint8Array.from(ln.from(i.data,"base64")):i.data;yield{video:{format:a,source:{bytes:o}}}}else i.fileId&&i.fileId.startsWith("s3://")&&(yield{video:{format:a,source:{s3Location:{uri:i.fileId}}}})}else{if(i.type==="web_search_call")continue;if(i.type==="web_search_result")continue;i.type==="non_standard"&&e==="bedrock-converse"&&(yield i)}}}}}}return Array.from(r())}function rp(t){return!!(typeof t=="object"&&t!==null&&"cachePoint"in t&&t.cachePoint&&typeof t.cachePoint=="object"&&t.cachePoint!==null&&"type"in t.cachePoint&&t.cachePoint.type==="default")}function wL(t){const e=t.match(/^data:image\/(\w+);base64,/);let r;if(e){const a=e[1].toLowerCase();["gif","jpeg","png","webp"].includes(a)&&(r=a)}const n=t.replace(/^data:image\/\w+;base64,/,""),s=atob(n),i=new Uint8Array(s.length);for(let a=0;a<s.length;a+=1)i[a]=s.charCodeAt(a);return{image:{format:r,source:{bytes:i}}}}const vL={providerName:"ChatBedrockConverse",fromStandardTextBlock(t){return{text:t.text}},fromStandardImageBlock(t){let e;if(t.source_type==="url"){const r=ca({dataUrl:t.url,asTypedArray:!0});if(r)return e=Vi(r.mime_type).type,{image:{format:e,source:{bytes:r.data}}};throw new Error("Only base64 data URLs are supported for image blocks with source type 'url' with ChatBedrockConverse.")}else if(t.source_type==="base64"){if(t.mime_type&&(e=Vi(t.mime_type).subtype),e&&!["gif","jpeg","png","webp"].includes(e))throw new Error(`Unsupported image mime type: "${t.mime_type}" ChatBedrockConverse only supports "image/gif", "image/jpeg", "image/png", and "image/webp" formats.`);return{image:{format:e,source:{bytes:Uint8Array.from(atob(t.data),r=>r.charCodeAt(0))}}}}else throw t.source_type==="id"?new Error("Image source type 'id' not supported with ChatBedrockConverse."):new Error(`Unsupported image source type: "${t.source_type}" with ChatBedrockConverse.`)},fromStandardFileBlock(t){var n,s,i;const e={"text/csv":"csv","application/msword":"doc","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","text/html":"html","text/markdown":"md","application/pdf":"pdf","text/plain":"txt","application/vnd.ms-excel":"xls","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx"},r=((n=t.metadata)==null?void 0:n.name)??((s=t.metadata)==null?void 0:s.filename)??((i=t.metadata)==null?void 0:i.title);if(t.source_type==="text")return{document:{name:r,format:"txt",source:{bytes:new TextEncoder().encode(t.text)}}};if(t.source_type==="url"){const a=ca({dataUrl:t.url,asTypedArray:!0});if(a){const o=Vi(a.mime_type??t.mime_type),c=`${o.type}/${o.subtype}`,u=e[c];return{document:{name:r,format:u,source:{bytes:a.data}}}}throw new Error("Only base64 data URLs are supported for file blocks with source type 'url' with ChatBedrockConverse.")}if(t.source_type==="base64"){let a;if(t.mime_type){const o=Vi(t.mime_type),c=`${o.type}/${o.subtype}`;if(a=e[c],a===void 0)throw new Error(`Unsupported file mime type: "${t.mime_type}" ChatBedrockConverse only supports ${Object.keys(e).join(", ")} formats.`)}return{document:{name:r,format:a,source:{bytes:Uint8Array.from(atob(t.data),o=>o.charCodeAt(0))}}}}throw t.source_type==="id"?new Error("File source type 'id' not supported with ChatBedrockConverse."):new Error(`Unsupported file source type: "${t.source_type}" with ChatBedrockConverse.`)}};function vE({block:t,onUnknown:e="throw"}){if(typeof t=="string")return{text:t};if(Rn(t))return sw(t,vL);if(t.type==="text")return{text:t.text};if(t.type==="image_url")return wL(typeof t.image_url=="string"?t.image_url:t.image_url.url);if(t.type==="document"&&t.document!==void 0)return{document:t.document};if(t.type==="image"&&t.image!==void 0)return{image:t.image};if(rp(t))return{cachePoint:{type:"default"}};if(e==="throw")throw new Error(`Unsupported content block type: ${t.type}`);return t}function bL(t){if(typeof t.content=="string")return[{text:t.content}];if(Array.isArray(t.content)&&t.content.length>0){const e=[];for(const r of t.content)if(r.type==="text"&&typeof r.text=="string")e.push({text:r.text});else if(rp(r))e.push({cachePoint:{type:"default"}});else break;if(t.content.length===e.length)return e}throw new Error("System message content must be either a string, or an array of text blocks, optionally including a cache point.")}function EL(t){var r;if(t.response_metadata.response_format==="v1")return{role:"assistant",content:_L(t)};const e={role:"assistant",content:[]};if(typeof t.content=="string"&&t.content!=="")(r=e.content)==null||r.push({text:t.content});else if(Array.isArray(t.content)){const n=AL(t.content),s=[];n.forEach(i=>{var a;if(i.type==="text"&&i.text!=="")if(((a=i.text)==null?void 0:a.replace(/\n/g,"").trim())===""){if(s.length>0){const c=`${s[s.length-1].text}${i.text}`;s[s.length-1].text=c}}else s.push({text:i.text});else if(i.type==="reasoning_content")s.push({reasoningContent:TL(i)});else if(rp(i))s.push({cachePoint:{type:"default"}});else{const o=Object.fromEntries(Object.entries(i).filter(([c])=>c!=="type"));throw new Error(`Unsupported content block type: ${i.type} with content of ${JSON.stringify(o,null,2)}`)}}),e.content=[...e.content?e.content:[],...s]}return t.tool_calls&&t.tool_calls.length&&(e.content=[...e.content?e.content:[],...t.tool_calls.map(n=>({toolUse:{toolUseId:n.id,name:n.name,input:n.args}}))]),e}function SL(t){if(t.content==="")throw new Error(`Invalid message content: empty string. '${t.type}' must contain non-empty content.`);return{role:"user",content:(Array.isArray(t.content)?t.content:[t.content]).map(n=>vE({block:n,onUnknown:"throw"}))}}function xL(t){const e=t;return typeof e.content=="string"?{role:"user",content:[{toolResult:{toolUseId:e.tool_call_id,content:[{text:e.content}]}}]}:{role:"user",content:[{toolResult:{toolUseId:e.tool_call_id,content:t.content.map(r=>{const n=vE({block:r,onUnknown:"returnUnmodified"});return n!==r?n:{json:r}})}}]}}function Sy(t){const e=t.reduce((s,i)=>(lt.isInstance(i)&&s.push(...bL(i)),s),[]);return{converseMessages:t.filter(s=>!lt.isInstance(s)).map(s=>{if(yt.isInstance(s))return EL(s);if(pt.isInstance(s)||ls.isInstance(s))return SL(s);if(On.isInstance(s))return xL(s);throw new Error(`Unsupported message type: ${s.type}`)}).reduce((s,i)=>{var o,c;const a=s[s.length-1];return a&&a.role==="user"&&((o=a.content)!=null&&o.some(u=>"toolResult"in u))&&i.role==="user"&&((c=i.content)!=null&&c.some(u=>"toolResult"in u))?a.content=a.content.concat(i.content):s.push(i),s},[]),converseSystem:e}}function TL(t){if(t.type!=="reasoning_content")throw new Error("Invalid reasoning content");if("reasoningText"in t)return{reasoningText:t.reasoningText};if("redactedContent"in t)return{redactedContent:ln.from(t.redactedContent,"base64")};throw new Error("Invalid reasoning content")}function AL(t){const e=[];let r={};for(const n of t){if(n.type!=="reasoning_content"){Object.keys(r).length>0&&(e.push(r),r={}),e.push(n);continue}if("reasoningText"in n&&typeof n.reasoningText=="object"){"redactedContent"in r&&(e.push(r),r={});const{text:s,signature:i}=n.reasoningText,{text:a,signature:o}="reasoningText"in r?r.reasoningText:{};r={type:"reasoning_content",reasoningText:{...r.reasoningText??{},...a!==void 0||s!==void 0?{text:(a??"")+(s??"")}:{},...o!==void 0||i!==void 0?{signature:(o??"")+(i??"")}:{}}},"signature"in n.reasoningText&&(e.push(r),r={})}if("redactedContent"in n){"reasoningText"in r&&(e.push(r),r={});const{redactedContent:s}=n;r={type:"reasoning_content",redactedContent:("redactedContent"in r?r.redactedContent:"")+s}}}return Object.keys(r).length>0&&e.push(r),e}function CL(t,e){var s;if(!t.content)throw new Error("No message content found in response.");if(t.role!=="assistant")throw new Error(`Unsupported message role received in ChatBedrockConverse response: ${t.role}`);let r;"$metadata"in e&&e.$metadata&&typeof e.$metadata=="object"&&"requestId"in e.$metadata&&(r=e.$metadata.requestId);let n;if(e.usage){const i=e.usage.inputTokens??0,a=e.usage.outputTokens??0;n={input_tokens:i,output_tokens:a,total_tokens:e.usage.totalTokens??i+a}}if(((s=t.content)==null?void 0:s.length)===1&&"text"in t.content[0]&&typeof t.content[0].text=="string")return new yt({content:t.content[0].text,response_metadata:{...e,model_provider:"bedrock-converse"},usage_metadata:n,id:r});{const i=[],a=[];return t.content.forEach(o=>{"cachePoint"in o?a.push({type:"cache_point",cachePoint:o.cachePoint}):"citationsContent"in o?a.push({type:"citations_content",citationsContent:o.citationsContent}):"document"in o?a.push({type:"document",document:o.document}):"guardContent"in o?a.push({type:"guard_content",guardContent:o.guardContent}):"image"in o?a.push({type:"image",image:o.image}):"reasoningContent"in o?a.push(NL(o.reasoningContent)):"text"in o&&typeof o.text=="string"?a.push({type:"text",text:o.text}):"toolResult"in o?a.push({type:"tool_result",toolResult:o.toolResult}):"toolUse"in o&&o.toolUse&&o.toolUse.name&&o.toolUse.input&&typeof o.toolUse.input=="object"?i.push({id:o.toolUse.toolUseId,name:o.toolUse.name,args:o.toolUse.input,type:"tool_call"}):"video"in o&&a.push({type:"video",video:o.video})}),new yt({content:a.length?a:"",tool_calls:i.length?i:void 0,response_metadata:{...e,model_provider:"bedrock-converse"},usage_metadata:n,id:r})}}function kL(t){if(!t.delta)throw new Error("No delta found in content block.");if(typeof t.delta.text=="string")return new Rr({text:t.delta.text,message:new $t({content:t.delta.text})});if(t.delta.toolUse){const e=t.contentBlockIndex;return new Rr({text:"",message:new $t({content:"",tool_call_chunks:[{args:t.delta.toolUse.input,index:e,type:"tool_call_chunk"}]})})}else{if(t.delta.reasoningContent)return new Rr({text:"",message:new $t({content:[OL(t.delta.reasoningContent)]})});throw new Error(`Unsupported content block type(s): ${JSON.stringify(t.delta,null,2)}`)}}function IL(t){var r;const e=t.contentBlockIndex;if((r=t.start)!=null&&r.toolUse)return new Rr({text:"",message:new $t({content:"",tool_call_chunks:[{name:t.start.toolUse.name,id:t.start.toolUse.toolUseId,index:e,type:"tool_call_chunk"}]})});throw new Error("Unsupported content block start event.")}function RL(t,e){var i,a,o;const r=((i=t.usage)==null?void 0:i.inputTokens)??0,n=((a=t.usage)==null?void 0:a.outputTokens)??0,s={input_tokens:r,output_tokens:n,total_tokens:((o=t.usage)==null?void 0:o.totalTokens)??r+n};return new Rr({text:"",message:new $t({content:"",usage_metadata:e.streamUsage?s:void 0,response_metadata:{metadata:t,model_provider:"bedrock-converse"}})})}function OL(t){const{text:e,redactedContent:r,signature:n}=t;if(typeof e=="string")return{type:"reasoning_content",reasoningText:{text:e}};if(n)return{type:"reasoning_content",reasoningText:{signature:n}};if(r)return{type:"reasoning_content",redactedContent:ln.from(r).toString("base64")};throw new Error("Invalid reasoning content")}function NL(t){const{reasoningText:e,redactedContent:r}=t;if(e)return{type:"reasoning_content",reasoningText:e};if(r)return{type:"reasoning_content",redactedContent:ln.from(r).toString("base64")};throw new Error("Invalid reasoning content")}function $L(t){const e=t.signer,r=t.signer,n=Object.assign(t,{eventSigner:e,messageSigner:r}),s=n.eventStreamPayloadHandlerProvider(n);return Object.assign(n,{eventStreamPayloadHandler:s})}const PL=t=>({setHttpHandler(e){t.httpHandler=e},httpHandler(){return t.httpHandler},updateHttpClientConfig(e,r){var n;(n=t.httpHandler)==null||n.updateHttpClientConfig(e,r)},httpHandlerConfigs(){return t.httpHandler.httpHandlerConfigs()}}),LL=t=>({httpHandler:t.httpHandler()});var Ra;(function(t){t.HTTP="http",t.HTTPS="https"})(Ra||(Ra={}));var kc;(function(t){t.MD5="md5",t.CRC32="crc32",t.CRC32C="crc32c",t.SHA1="sha1",t.SHA256="sha256"})(kc||(kc={}));const vh="__smithy_context";class or{constructor(e){f(this,"method");f(this,"protocol");f(this,"hostname");f(this,"port");f(this,"path");f(this,"query");f(this,"headers");f(this,"username");f(this,"password");f(this,"fragment");f(this,"body");this.method=e.method||"GET",this.hostname=e.hostname||"localhost",this.port=e.port,this.query=e.query||{},this.headers=e.headers||{},this.body=e.body,this.protocol=e.protocol?e.protocol.slice(-1)!==":"?`${e.protocol}:`:e.protocol:"https:",this.path=e.path?e.path.charAt(0)!=="/"?`/${e.path}`:e.path:"/",this.username=e.username,this.password=e.password,this.fragment=e.fragment}static clone(e){const r=new or({...e,headers:{...e.headers}});return r.query&&(r.query=DL(r.query)),r}static isInstance(e){if(!e)return!1;const r=e;return"method"in r&&"protocol"in r&&"hostname"in r&&"path"in r&&typeof r.query=="object"&&typeof r.headers=="object"}clone(){return or.clone(this)}}function DL(t){return Object.keys(t).reduce((e,r)=>{const n=t[r];return{...e,[r]:Array.isArray(n)?[...n]:n}},{})}class Ti{constructor(e){f(this,"statusCode");f(this,"reason");f(this,"headers");f(this,"body");this.statusCode=e.statusCode,this.reason=e.reason,this.headers=e.headers||{},this.body=e.body}static isInstance(e){if(!e)return!1;const r=e;return typeof r.statusCode=="number"&&typeof r.headers=="object"}}const ML=t=>e=>async r=>{if(!or.isInstance(r.request))return e(r);const{request:n}=r,{handlerProtocol:s=""}=t.requestHandler.metadata||{};if(s.indexOf("h2")>=0&&!n.headers[":authority"])delete n.headers.host,n.headers[":authority"]=n.hostname+(n.port?":"+n.port:"");else if(!n.headers.host){let i=n.hostname;n.port!=null&&(i+=`:${n.port}`),n.headers.host=i}return e(r)},UL={name:"hostHeaderMiddleware",step:"build",priority:"low",tags:["HOST"],override:!0},BL=t=>({applyToStack:e=>{e.add(ML(t),UL)}}),FL=()=>(t,e)=>async r=>{var n,s;try{const i=await t(r),{clientName:a,commandName:o,logger:c,dynamoDbDocumentClientOptions:u={}}=e,{overrideInputFilterSensitiveLog:l,overrideOutputFilterSensitiveLog:d}=u,h=l??e.inputFilterSensitiveLog,p=d??e.outputFilterSensitiveLog,{$metadata:m,..._}=i.output;return(n=c==null?void 0:c.info)==null||n.call(c,{clientName:a,commandName:o,input:h(r.input),output:p(_),metadata:m}),i}catch(i){const{clientName:a,commandName:o,logger:c,dynamoDbDocumentClientOptions:u={}}=e,{overrideInputFilterSensitiveLog:l}=u,d=l??e.inputFilterSensitiveLog;throw(s=c==null?void 0:c.error)==null||s.call(c,{clientName:a,commandName:o,input:d(r.input),error:i,metadata:i.$metadata}),i}},jL={name:"loggerMiddleware",tags:["LOGGER"],step:"initialize",override:!0},zL=t=>({applyToStack:e=>{e.add(FL(),jL)}}),VL={step:"build",tags:["RECURSION_DETECTION"],name:"recursionDetectionMiddleware",override:!0,priority:"low"},GL=()=>t=>async e=>t(e),HL=t=>({applyToStack:e=>{e.add(GL(),VL)}}),lu=t=>t[vh]||(t[vh]={}),In=t=>{if(typeof t=="function")return t;const e=Promise.resolve(t);return()=>e},qL=(t,e)=>{if(!e||e.length===0)return t;const r=[];for(const n of e)for(const s of t)s.schemeId.split("#")[1]===n&&r.push(s);for(const n of t)r.find(({schemeId:s})=>s===n.schemeId)||r.push(n);return r};function WL(t){const e=new Map;for(const r of t)e.set(r.schemeId,r);return e}const JL=(t,e)=>(r,n)=>async s=>{var d;const i=t.httpAuthSchemeProvider(await e.httpAuthSchemeParametersProvider(t,n,s.input)),a=t.authSchemePreference?await t.authSchemePreference():[],o=qL(i,a),c=WL(t.httpAuthSchemes),u=lu(n),l=[];for(const h of o){const p=c.get(h.schemeId);if(!p){l.push(`HttpAuthScheme \`${h.schemeId}\` was not enabled for this service.`);continue}const m=p.identityProvider(await e.identityProviderConfigProvider(t));if(!m){l.push(`HttpAuthScheme \`${h.schemeId}\` did not have an IdentityProvider configured.`);continue}const{identityProperties:_={},signingProperties:v={}}=((d=h.propertiesExtractor)==null?void 0:d.call(h,t,n))||{};h.identityProperties=Object.assign(h.identityProperties||{},_),h.signingProperties=Object.assign(h.signingProperties||{},v),u.selectedHttpAuthScheme={httpAuthOption:h,identity:await m(h.identityProperties),signer:p.signer};break}if(!u.selectedHttpAuthScheme)throw new Error(l.join(`
`));return r(s)},ZL={step:"serialize",tags:["HTTP_AUTH_SCHEME"],name:"httpAuthSchemeMiddleware",override:!0,relation:"before",toMiddleware:"endpointV2Middleware"},KL=(t,{httpAuthSchemeParametersProvider:e,identityProviderConfigProvider:r})=>({applyToStack:n=>{n.addRelativeTo(JL(t,{httpAuthSchemeParametersProvider:e,identityProviderConfigProvider:r}),ZL)}}),XL=(t,e)=>(r,n)=>async s=>{var a,o,c,u;const{response:i}=await r(s);try{const l=await e(i,t);return{response:i,output:l}}catch(l){if(Object.defineProperty(l,"$response",{value:i}),!("$metadata"in l)){const d="Deserialization error: to see the raw response, inspect the hidden field {error}.$response on this object.";try{l.message+=`
  `+d}catch{!n.logger||((o=(a=n.logger)==null?void 0:a.constructor)==null?void 0:o.name)==="NoOpLogger"?console.warn(d):(u=(c=n.logger)==null?void 0:c.warn)==null||u.call(c,d)}typeof l.$responseBodyText<"u"&&l.$response&&(l.$response.body=l.$responseBodyText);try{if(Ti.isInstance(i)){const{headers:h={}}=i,p=Object.entries(h);l.$metadata={httpStatusCode:i.statusCode,requestId:cd(/^x-[\w-]+-request-?id$/,p),extendedRequestId:cd(/^x-[\w-]+-id-2$/,p),cfId:cd(/^x-[\w-]+-cf-id$/,p)}}}catch{}}throw l}},cd=(t,e)=>(e.find(([r])=>r.match(t))||[void 0,void 0])[1],YL=(t,e)=>(r,n)=>async s=>{var c;const i=t,a=(c=n.endpointV2)!=null&&c.url&&i.urlParser?async()=>i.urlParser(n.endpointV2.url):i.endpoint;if(!a)throw new Error("No valid endpoint provider available.");const o=await e(s.input,{...t,endpoint:a});return r({...s,request:o})},QL={name:"deserializerMiddleware",step:"deserialize",tags:["DESERIALIZER"],override:!0},bE={name:"serializerMiddleware",step:"serialize",tags:["SERIALIZER"],override:!0};function EE(t,e,r){return{applyToStack:n=>{n.add(XL(t,r),QL),n.add(YL(t,e),bE)}}}const eD=t=>e=>{throw e},tD=(t,e)=>{},rD=t=>(e,r)=>async n=>{if(!or.isInstance(n.request))return e(n);const i=lu(r).selectedHttpAuthScheme;if(!i)throw new Error("No HttpAuthScheme was selected: unable to sign request");const{httpAuthOption:{signingProperties:a={}},identity:o,signer:c}=i,u=await e({...n,request:await c.sign(n.request,o,a)}).catch((c.errorHandler||eD)(a));return(c.successHandler||tD)(u.response,a),u},nD={step:"finalizeRequest",tags:["HTTP_SIGNING"],name:"httpSigningMiddleware",aliases:["apiKeyMiddleware","tokenMiddleware","awsAuthMiddleware"],override:!0,relation:"after",toMiddleware:"retryMiddleware"},sD=t=>({applyToStack:e=>{e.addRelativeTo(rD(),nD)}}),sa=t=>{if(typeof t=="function")return t;const e=Promise.resolve(t);return()=>e},SE="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",xy=Object.entries(SE).reduce((t,[e,r])=>(t[r]=Number(e),t),{}),iD=SE.split(""),li=6,ia=8,aD=63,np=t=>{let e=t.length/4*3;t.slice(-2)==="=="?e-=2:t.slice(-1)==="="&&e--;const r=new ArrayBuffer(e),n=new DataView(r);for(let s=0;s<t.length;s+=4){let i=0,a=0;for(let u=s,l=s+3;u<=l;u++)if(t[u]!=="="){if(!(t[u]in xy))throw new TypeError(`Invalid character ${t[u]} in base64 string.`);i|=xy[t[u]]<<(l-u)*li,a+=li}else i>>=li;const o=s/4*3;i>>=a%ia;const c=Math.floor(a/ia);for(let u=0;u<c;u++){const l=(c-u-1)*ia;n.setUint8(o+u,(i&255<<l)>>l)}}return new Uint8Array(r)},Ai=t=>new TextEncoder().encode(t),Oa=t=>typeof t=="string"?Ai(t):ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength/Uint8Array.BYTES_PER_ELEMENT):new Uint8Array(t),sp=t=>{if(typeof t=="string")return t;if(typeof t!="object"||typeof t.byteOffset!="number"||typeof t.byteLength!="number")throw new Error("@smithy/util-utf8: toUtf8 encoder function only accepts string | Uint8Array.");return new TextDecoder("utf-8").decode(t)};function xE(t){let e;typeof t=="string"?e=Ai(t):e=t;const r=typeof e=="object"&&typeof e.length=="number",n=typeof e=="object"&&typeof e.byteOffset=="number"&&typeof e.byteLength=="number";if(!r&&!n)throw new Error("@smithy/util-base64: toBase64 encoder function only accepts string | Uint8Array.");let s="";for(let i=0;i<e.length;i+=3){let a=0,o=0;for(let u=i,l=Math.min(i+3,e.length);u<l;u++)a|=e[u]<<(l-u-1)*ia,o+=ia;const c=Math.ceil(o/li);a<<=c*li-o;for(let u=1;u<=c;u++){const l=(c-u)*li;s+=iD[(a&aD<<l)>>l]}s+="==".slice(0,4-c)}return s}class ks extends Uint8Array{static fromString(e,r="utf-8"){if(typeof e=="string")return r==="base64"?ks.mutate(np(e)):ks.mutate(Ai(e));throw new Error(`Unsupported conversion from ${typeof e} to Uint8ArrayBlobAdapter.`)}static mutate(e){return Object.setPrototypeOf(e,ks.prototype),e}transformToString(e="utf-8"){return e==="base64"?xE(this):sp(this)}}const Is=t=>encodeURIComponent(t).replace(/[!'()*]/g,oD),oD=t=>`%${t.charCodeAt(0).toString(16).toUpperCase()}`;function TE(t){const e=[];for(let r of Object.keys(t).sort()){const n=t[r];if(r=Is(r),Array.isArray(n))for(let s=0,i=n.length;s<i;s++)e.push(`${r}=${Is(n[s])}`);else{let s=r;(n||typeof n=="string")&&(s+=`=${Is(n)}`),e.push(s)}}return e.join("&")}function Ty(t,e){return new Request(t,e)}function cD(t=0){return new Promise((e,r)=>{t&&setTimeout(()=>{const n=new Error(`Request did not complete within ${t} ms`);n.name="TimeoutError",r(n)},t)})}const ud={supported:void 0};class Na{constructor(e){f(this,"config");f(this,"configProvider");typeof e=="function"?this.configProvider=e().then(r=>r||{}):(this.config=e??{},this.configProvider=Promise.resolve(this.config)),ud.supported===void 0&&(ud.supported=typeof Request<"u"&&"keepalive"in Ty("https://[::1]"))}static create(e){return typeof(e==null?void 0:e.handle)=="function"?e:new Na(e)}destroy(){}async handle(e,{abortSignal:r,requestTimeout:n}={}){var E;this.config||(this.config=await this.configProvider);const s=n??this.config.requestTimeout,i=this.config.keepAlive===!0,a=this.config.credentials;if(r!=null&&r.aborted){const b=new Error("Request aborted");return b.name="AbortError",Promise.reject(b)}let o=e.path;const c=TE(e.query||{});c&&(o+=`?${c}`),e.fragment&&(o+=`#${e.fragment}`);let u="";if(e.username!=null||e.password!=null){const b=e.username??"",I=e.password??"";u=`${b}:${I}@`}const{port:l,method:d}=e,h=`${e.protocol}//${u}${e.hostname}${l?`:${l}`:""}${o}`,p=d==="GET"||d==="HEAD"?void 0:e.body,m={body:p,headers:new Headers(e.headers),method:d,credentials:a};(E=this.config)!=null&&E.cache&&(m.cache=this.config.cache),p&&(m.duplex="half"),typeof AbortController<"u"&&(m.signal=r),ud.supported&&(m.keepalive=i),typeof this.config.requestInit=="function"&&Object.assign(m,this.config.requestInit(e));let _=()=>{};const v=Ty(h,m),y=[fetch(v).then(b=>{const I=b.headers,k={};for(const P of I.entries())k[P[0]]=P[1];return b.body!=null?{response:new Ti({headers:k,reason:b.statusText,statusCode:b.status,body:b.body})}:b.blob().then(P=>({response:new Ti({headers:k,reason:b.statusText,statusCode:b.status,body:P})}))}),cD(s)];return r&&y.push(new Promise((b,I)=>{const k=()=>{const R=new Error("Request aborted");R.name="AbortError",I(R)};if(typeof r.addEventListener=="function"){const R=r;R.addEventListener("abort",k,{once:!0}),_=()=>R.removeEventListener("abort",k)}else r.onabort=k})),Promise.race(y).finally(_)}updateHttpClientConfig(e,r){this.config=void 0,this.configProvider=this.configProvider.then(n=>(n[e]=r,n))}httpHandlerConfigs(){return this.config??{}}}const uD=async t=>{var e;return typeof Blob=="function"&&t instanceof Blob||((e=t.constructor)==null?void 0:e.name)==="Blob"?Blob.prototype.arrayBuffer!==void 0?new Uint8Array(await t.arrayBuffer()):lD(t):dD(t)};async function lD(t){const e=await hD(t),r=np(e);return new Uint8Array(r)}async function dD(t){const e=[],r=t.getReader();let n=!1,s=0;for(;!n;){const{done:o,value:c}=await r.read();c&&(e.push(c),s+=c.length),n=o}const i=new Uint8Array(s);let a=0;for(const o of e)i.set(o,a),a+=o.length;return i}function hD(t){return new Promise((e,r)=>{const n=new FileReader;n.onloadend=()=>{if(n.readyState!==2)return r(new Error("Reader aborted too early"));const s=n.result??"",i=s.indexOf(","),a=i>-1?i+1:s.length;e(s.substring(a))},n.onabort=()=>r(new Error("Read aborted")),n.onerror=()=>r(n.error),n.readAsDataURL(t)})}const AE={},bh={};for(let t=0;t<256;t++){let e=t.toString(16).toLowerCase();e.length===1&&(e=`0${e}`),AE[t]=e,bh[e]=t}function ip(t){if(t.length%2!==0)throw new Error("Hex encoded strings must have an even number length");const e=new Uint8Array(t.length/2);for(let r=0;r<t.length;r+=2){const n=t.slice(r,r+2).toLowerCase();if(n in bh)e[r/2]=bh[n];else throw new Error(`Cannot decode unrecognized sequence ${n} as hexadecimal`)}return e}function pr(t){let e="";for(let r=0;r<t.byteLength;r++)e+=AE[t[r]];return e}const fD=async(t=new Uint8Array,e)=>{if(t instanceof Uint8Array)return ks.mutate(t);if(!t)return ks.mutate(new Uint8Array);const r=e.streamCollector(t);return ks.mutate(await r)};function Ay(t){return encodeURIComponent(t).replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}const ld=t=>typeof t=="function"?t():t;function xo(t){if(typeof t=="object")return t;t=t|0;const e={};let r=0;for(const n of["httpLabel","idempotent","idempotencyToken","sensitive","httpPayload","httpResponseCode","httpQueryParams"])(t>>r++&1)===1&&(e[n]=1);return e}const Wn=class Wn{constructor(e,r){f(this,"ref");f(this,"memberName");f(this,"symbol",Wn.symbol);f(this,"name");f(this,"schema");f(this,"_isMemberSchema");f(this,"traits");f(this,"memberTraits");f(this,"normalizedTraits");this.ref=e,this.memberName=r;const n=[];let s=e,i=e;for(this._isMemberSchema=!1;dd(s);)n.push(s[1]),s=s[0],i=ld(s),this._isMemberSchema=!0;if(n.length>0){this.memberTraits={};for(let a=n.length-1;a>=0;--a){const o=n[a];Object.assign(this.memberTraits,xo(o))}}else this.memberTraits=0;if(i instanceof Wn){const a=this.memberTraits;Object.assign(this,i),this.memberTraits=Object.assign({},a,i.getMemberTraits(),this.getMemberTraits()),this.normalizedTraits=void 0,this.memberName=r??i.memberName;return}if(this.schema=ld(i),pD(this.schema)?(this.name=`${this.schema[1]}#${this.schema[2]}`,this.traits=this.schema[3]):(this.name=this.memberName??String(i),this.traits=0),this._isMemberSchema&&!r)throw new Error(`@smithy/core/schema - NormalizedSchema member init ${this.getName(!0)} missing member name.`)}static[Symbol.hasInstance](e){const r=this.prototype.isPrototypeOf(e);return!r&&typeof e=="object"&&e!==null?e.symbol===this.symbol:r}static of(e){const r=ld(e);if(r instanceof Wn)return r;if(dd(r)){const[n,s]=r;if(n instanceof Wn)return Object.assign(n.getMergedTraits(),xo(s)),n;throw new Error(`@smithy/core/schema - may not init unwrapped member schema=${JSON.stringify(e,null,2)}.`)}return new Wn(r)}getSchema(){const e=this.schema;return e[0]===0?e[4]:e}getName(e=!1){const{name:r}=this;return!e&&r&&r.includes("#")?r.split("#")[1]:r||void 0}getMemberName(){return this.memberName}isMemberSchema(){return this._isMemberSchema}isListSchema(){const e=this.getSchema();return typeof e=="number"?e>=64&&e<128:e[0]===1}isMapSchema(){const e=this.getSchema();return typeof e=="number"?e>=128&&e<=255:e[0]===2}isStructSchema(){const e=this.getSchema();return e[0]===3||e[0]===-3}isBlobSchema(){const e=this.getSchema();return e===21||e===42}isTimestampSchema(){const e=this.getSchema();return typeof e=="number"&&e>=4&&e<=7}isUnitSchema(){return this.getSchema()==="unit"}isDocumentSchema(){return this.getSchema()===15}isStringSchema(){return this.getSchema()===0}isBooleanSchema(){return this.getSchema()===2}isNumericSchema(){return this.getSchema()===1}isBigIntegerSchema(){return this.getSchema()===17}isBigDecimalSchema(){return this.getSchema()===19}isStreaming(){const{streaming:e}=this.getMergedTraits();return!!e||this.getSchema()===42}isIdempotencyToken(){const e=i=>(i&4)===4||!!(i!=null&&i.idempotencyToken),{normalizedTraits:r,traits:n,memberTraits:s}=this;return e(r)||e(n)||e(s)}getMergedTraits(){return this.normalizedTraits??(this.normalizedTraits={...this.getOwnTraits(),...this.getMemberTraits()})}getMemberTraits(){return xo(this.memberTraits)}getOwnTraits(){return xo(this.traits)}getKeySchema(){const[e,r]=[this.isDocumentSchema(),this.isMapSchema()];if(!e&&!r)throw new Error(`@smithy/core/schema - cannot get key for non-map: ${this.getName(!0)}`);const n=this.getSchema(),s=e?15:n[4]??0;return ji([s,0],"key")}getValueSchema(){const e=this.getSchema(),[r,n,s]=[this.isDocumentSchema(),this.isMapSchema(),this.isListSchema()],i=typeof e=="number"?63&e:e&&typeof e=="object"&&(n||s)?e[3+e[0]]:r?15:void 0;if(i!=null)return ji([i,0],n?"value":"member");throw new Error(`@smithy/core/schema - ${this.getName(!0)} has no value member.`)}getMemberSchema(e){const r=this.getSchema();if(this.isStructSchema()&&r[4].includes(e)){const n=r[4].indexOf(e),s=r[5][n];return ji(dd(s)?s:[s,0],e)}if(this.isDocumentSchema())return ji([15,0],e);throw new Error(`@smithy/core/schema - ${this.getName(!0)} has no no member=${e}.`)}getMemberSchemas(){const e={};try{for(const[r,n]of this.structIterator())e[r]=n}catch{}return e}getEventStreamMember(){if(this.isStructSchema()){for(const[e,r]of this.structIterator())if(r.isStreaming()&&r.isStructSchema())return e}return""}*structIterator(){if(this.isUnitSchema())return;if(!this.isStructSchema())throw new Error("@smithy/core/schema - cannot iterate non-struct schema.");const e=this.getSchema();for(let r=0;r<e[4].length;++r)yield[e[4][r],ji([e[5][r],0],e[4][r])]}};f(Wn,"symbol",Symbol.for("@smithy/nor"));let $a=Wn;function ji(t,e){if(t instanceof $a)return Object.assign(t,{memberName:e,_isMemberSchema:!0});const r=$a;return new r(t,e)}const dd=t=>Array.isArray(t)&&t.length===2,pD=t=>Array.isArray(t)&&t.length>=5,mD=t=>{if(t!=null){if(typeof t=="number"){if((t===0||t===1)&&Rc.warn(Ic(`Expected boolean, got ${typeof t}: ${t}`)),t===0)return!1;if(t===1)return!0}if(typeof t=="string"){const e=t.toLowerCase();if((e==="false"||e==="true")&&Rc.warn(Ic(`Expected boolean, got ${typeof t}: ${t}`)),e==="false")return!1;if(e==="true")return!0}if(typeof t=="boolean")return t;throw new TypeError(`Expected boolean, got ${typeof t}: ${t}`)}},gD=t=>{if(t!=null){if(typeof t=="string"){const e=parseFloat(t);if(!Number.isNaN(e))return String(e)!==String(t)&&Rc.warn(Ic(`Expected number but observed string: ${t}`)),e}if(typeof t=="number")return t;throw new TypeError(`Expected number, got ${typeof t}: ${t}`)}},yD=t=>{if(t!=null){if(Number.isInteger(t)&&!Number.isNaN(t))return t;throw new TypeError(`Expected integer, got ${typeof t}: ${t}`)}},ap=t=>_D(t,32),_D=(t,e)=>{const r=yD(t);if(r!==void 0&&wD(r,e)!==r)throw new TypeError(`Expected ${e}-bit integer, got ${t}`);return r},wD=(t,e)=>{switch(e){case 32:return Int32Array.of(t)[0];case 16:return Int16Array.of(t)[0];case 8:return Int8Array.of(t)[0]}},vD=(t,e)=>{if(t==null)throw new TypeError(`Expected a non-null value for ${e}`);return t},CE=t=>{if(t==null)return;if(typeof t=="object"&&!Array.isArray(t))return t;const e=Array.isArray(t)?"array":typeof t;throw new TypeError(`Expected object, got ${e}: ${t}`)},Ce=t=>{if(t!=null){if(typeof t=="string")return t;if(["boolean","number","bigint"].includes(typeof t))return Rc.warn(Ic(`Expected string, got ${typeof t}: ${t}`)),String(t);throw new TypeError(`Expected string, got ${typeof t}: ${t}`)}},bD=t=>{if(t==null)return;const e=CE(t),r=Object.entries(e).filter(([,n])=>n!=null).map(([n])=>n);if(r.length===0)throw new TypeError("Unions must have exactly one non-null member. None were found.");if(r.length>1)throw new TypeError(`Unions must have exactly one non-null member. Keys ${r} were not null.`);return e},Eh=t=>typeof t=="string"?ED(t):gD(t),ED=t=>{switch(t){case"NaN":return NaN;case"Infinity":return 1/0;case"-Infinity":return-1/0;default:throw new Error(`Unable to parse float value: ${t}`)}},Ic=t=>String(new TypeError(t).stack||t).split(`
`).slice(0,5).filter(e=>!e.includes("stackTraceWarning")).join(`
`),Rc={warn:console.warn},Cy=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Mt=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0")),SD=()=>{if(Cy)return Cy();const t=new Uint8Array(16);return crypto.getRandomValues(t),t[6]=t[6]&15|64,t[8]=t[8]&63|128,Mt[t[0]]+Mt[t[1]]+Mt[t[2]]+Mt[t[3]]+"-"+Mt[t[4]]+Mt[t[5]]+"-"+Mt[t[6]]+Mt[t[7]]+"-"+Mt[t[8]]+Mt[t[9]]+"-"+Mt[t[10]]+Mt[t[11]]+Mt[t[12]]+Mt[t[13]]+Mt[t[14]]+Mt[t[15]]},xD=(t,e,r,n,s,i)=>{if(e!=null&&e[r]!==void 0){const a=n();if(a.length<=0)throw new Error("Empty value provided for input HTTP label: "+r+".");t=t.replace(s,i?a.split("/").map(o=>Ay(o)).join("/"):Ay(a))}else throw new Error("No value provided for input HTTP label: "+r+".");return t};function kE(t,e){return new TD(t,e)}class TD{constructor(e,r){f(this,"input");f(this,"context");f(this,"query",{});f(this,"method","");f(this,"headers",{});f(this,"path","");f(this,"body",null);f(this,"hostname","");f(this,"resolvePathStack",[]);this.input=e,this.context=r}async build(){const{hostname:e,protocol:r="https",port:n,path:s}=await this.context.endpoint();this.path=s;for(const i of this.resolvePathStack)i(this.path);return new or({protocol:r,hostname:this.hostname||e,port:n,method:this.method,path:this.path,query:this.query,body:this.body,headers:this.headers})}hn(e){return this.hostname=e,this}bp(e){return this.resolvePathStack.push(r=>{this.path=`${r!=null&&r.endsWith("/")?r.slice(0,-1):r||""}`+e}),this}p(e,r,n,s){return this.resolvePathStack.push(i=>{this.path=xD(i,this.input,e,r,n,s)}),this}h(e){return this.headers=e,this}q(e){return this.query=e,this}b(e){return this.body=e,this}m(e){return this.method=e,this}}function AD(t,e,r){t.__smithy_context?t.__smithy_context.features||(t.__smithy_context.features={}):t.__smithy_context={features:{}},t.__smithy_context.features[e]=r}class CD{constructor(e){f(this,"authSchemes",new Map);for(const[r,n]of Object.entries(e))n!==void 0&&this.authSchemes.set(r,n)}getIdentityProvider(e){return this.authSchemes.get(e)}}class kD{async sign(e,r,n){const s=or.clone(e);if(!r.token)throw new Error("request could not be signed with `token` since the `token` is not defined");return s.headers.Authorization=`Bearer ${r.token}`,s}}const ID=t=>function(r){return op(r)&&r.expiration.getTime()-Date.now()<t},RD=3e5,IE=ID(RD),op=t=>t.expiration!==void 0,RE=(t,e,r)=>{if(t===void 0)return;const n=typeof t!="function"?async()=>Promise.resolve(t):t;let s,i,a,o=!1;const c=async u=>{i||(i=n(u));try{s=await i,a=!0,o=!1}finally{i=void 0}return s};return e===void 0?async u=>((!a||u!=null&&u.forceRefresh)&&(s=await c(u)),s):async u=>((!a||u!=null&&u.forceRefresh)&&(s=await c(u)),o?s:r(s)?(e(s)&&await c(u),s):(o=!0,s))},OD=void 0;function ND(t){return t===void 0?!0:typeof t=="string"&&t.length<=50}function $D(t){const e=sa(t.userAgentAppId??OD),{customUserAgent:r}=t;return Object.assign(t,{customUserAgent:typeof r=="string"?[[r]]:r,userAgentAppId:async()=>{var s,i;const n=await e();if(!ND(n)){const a=((i=(s=t.logger)==null?void 0:s.constructor)==null?void 0:i.name)==="NoOpLogger"||!t.logger?console:t.logger;typeof n!="string"?a==null||a.warn("userAgentAppId must be a string or undefined."):n.length>50&&(a==null||a.warn("The provided userAgentAppId exceeds the maximum length of 50 characters."))}return n}})}class PD{constructor({size:e,params:r}){f(this,"capacity");f(this,"data",new Map);f(this,"parameters",[]);this.capacity=e??50,r&&(this.parameters=r)}get(e,r){const n=this.hash(e);if(n===!1)return r();if(!this.data.has(n)){if(this.data.size>this.capacity+10){const s=this.data.keys();let i=0;for(;;){const{value:a,done:o}=s.next();if(this.data.delete(a),o||++i>10)break}}this.data.set(n,r())}return this.data.get(n)}size(){return this.data.size}hash(e){let r="";const{parameters:n}=this;if(n.length===0)return!1;for(const s of n){const i=String(e[s]??"");if(i.includes("|;"))return!1;r+=i+"|;"}return r}}const LD=new RegExp("^(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}$"),OE=t=>LD.test(t)||t.startsWith("[")&&t.endsWith("]"),DD=new RegExp("^(?!.*-$)(?!-)[a-zA-Z0-9-]{1,63}$"),du=(t,e=!1)=>{if(!e)return DD.test(t);const r=t.split(".");for(const n of r)if(!du(n))return!1;return!0},Oc={},Pa="endpoints";function us(t){return typeof t!="object"||t==null?t:"ref"in t?`$${us(t.ref)}`:"fn"in t?`${t.fn}(${(t.argv||[]).map(us).join(", ")})`:JSON.stringify(t,null,2)}class _r extends Error{constructor(e){super(e),this.name="EndpointError"}}const MD=(t,e)=>t===e,UD=t=>{const e=t.split("."),r=[];for(const n of e){const s=n.indexOf("[");if(s!==-1){if(n.indexOf("]")!==n.length-1)throw new _r(`Path: '${t}' does not end with ']'`);const i=n.slice(s+1,-1);if(Number.isNaN(parseInt(i)))throw new _r(`Invalid array index: '${i}' in path: '${t}'`);s!==0&&r.push(n.slice(0,s)),r.push(i)}else r.push(n)}return r},NE=(t,e)=>UD(e).reduce((r,n)=>{if(typeof r!="object")throw new _r(`Index '${n}' in '${e}' not found in '${JSON.stringify(t)}'`);return Array.isArray(r)?r[parseInt(n)]:r[n]},t),BD=t=>t!=null,FD=t=>!t,hd={[Ra.HTTP]:80,[Ra.HTTPS]:443},jD=t=>{const e=(()=>{try{if(t instanceof URL)return t;if(typeof t=="object"&&"hostname"in t){const{hostname:h,port:p,protocol:m="",path:_="",query:v={}}=t,y=new URL(`${m}//${h}${p?`:${p}`:""}${_}`);return y.search=Object.entries(v).map(([E,b])=>`${E}=${b}`).join("&"),y}return new URL(t)}catch{return null}})();if(!e)return console.error(`Unable to parse ${JSON.stringify(t)} as a whatwg URL.`),null;const r=e.href,{host:n,hostname:s,pathname:i,protocol:a,search:o}=e;if(o)return null;const c=a.slice(0,-1);if(!Object.values(Ra).includes(c))return null;const u=OE(s),l=r.includes(`${n}:${hd[c]}`)||typeof t=="string"&&t.includes(`${n}:${hd[c]}`),d=`${n}${l?`:${hd[c]}`:""}`;return{scheme:c,authority:d,path:i,normalizedPath:i.endsWith("/")?i:`${i}/`,isIp:u}},zD=(t,e)=>t===e,VD=(t,e,r,n)=>e>=r||t.length<r?null:n?t.substring(t.length-r,t.length-e):t.substring(e,r),GD=t=>encodeURIComponent(t).replace(/[!*'()]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`),HD={booleanEquals:MD,getAttr:NE,isSet:BD,isValidHostLabel:du,not:FD,parseURL:jD,stringEquals:zD,substring:VD,uriEncode:GD},$E=(t,e)=>{const r=[],n={...e.endpointParams,...e.referenceRecord};let s=0;for(;s<t.length;){const i=t.indexOf("{",s);if(i===-1){r.push(t.slice(s));break}r.push(t.slice(s,i));const a=t.indexOf("}",i);if(a===-1){r.push(t.slice(i));break}t[i+1]==="{"&&t[a+1]==="}"&&(r.push(t.slice(i+1,a)),s=a+2);const o=t.substring(i+1,a);if(o.includes("#")){const[c,u]=o.split("#");r.push(NE(n[c],u))}else r.push(n[o]);s=a+1}return r.join("")},qD=({ref:t},e)=>({...e.endpointParams,...e.referenceRecord})[t],hu=(t,e,r)=>{if(typeof t=="string")return $E(t,r);if(t.fn)return LE.callFunction(t,r);if(t.ref)return qD(t,r);throw new _r(`'${e}': ${String(t)} is not a string, function or reference.`)},PE=({fn:t,argv:e},r)=>{const n=e.map(i=>["boolean","number"].includes(typeof i)?i:LE.evaluateExpression(i,"arg",r)),s=t.split(".");return s[0]in Oc&&s[1]!=null?Oc[s[0]][s[1]](...n):HD[t](...n)},LE={evaluateExpression:hu,callFunction:PE},WD=({assign:t,...e},r)=>{var s,i;if(t&&t in r.referenceRecord)throw new _r(`'${t}' is already defined in Reference Record.`);const n=PE(e,r);return(i=(s=r.logger)==null?void 0:s.debug)==null||i.call(s,`${Pa} evaluateCondition: ${us(e)} = ${us(n)}`),{result:n===""?!0:!!n,...t!=null&&{toAssign:{name:t,value:n}}}},cp=(t=[],e)=>{var n,s;const r={};for(const i of t){const{result:a,toAssign:o}=WD(i,{...e,referenceRecord:{...e.referenceRecord,...r}});if(!a)return{result:a};o&&(r[o.name]=o.value,(s=(n=e.logger)==null?void 0:n.debug)==null||s.call(n,`${Pa} assign: ${o.name} := ${us(o.value)}`))}return{result:!0,referenceRecord:r}},JD=(t,e)=>Object.entries(t).reduce((r,[n,s])=>({...r,[n]:s.map(i=>{const a=hu(i,"Header value entry",e);if(typeof a!="string")throw new _r(`Header '${n}' value '${a}' is not a string`);return a})}),{}),DE=(t,e)=>Object.entries(t).reduce((r,[n,s])=>({...r,[n]:UE.getEndpointProperty(s,e)}),{}),ME=(t,e)=>{if(Array.isArray(t))return t.map(r=>ME(r,e));switch(typeof t){case"string":return $E(t,e);case"object":if(t===null)throw new _r(`Unexpected endpoint property: ${t}`);return UE.getEndpointProperties(t,e);case"boolean":return t;default:throw new _r(`Unexpected endpoint property type: ${typeof t}`)}},UE={getEndpointProperty:ME,getEndpointProperties:DE},ZD=(t,e)=>{const r=hu(t,"Endpoint URL",e);if(typeof r=="string")try{return new URL(r)}catch(n){throw console.error(`Failed to construct URL with ${r}`,n),n}throw new _r(`Endpoint URL must be a string, got ${typeof r}`)},KD=(t,e)=>{var l,d;const{conditions:r,endpoint:n}=t,{result:s,referenceRecord:i}=cp(r,e);if(!s)return;const a={...e,referenceRecord:{...e.referenceRecord,...i}},{url:o,properties:c,headers:u}=n;return(d=(l=e.logger)==null?void 0:l.debug)==null||d.call(l,`${Pa} Resolving endpoint from template: ${us(n)}`),{...u!=null&&{headers:JD(u,a)},...c!=null&&{properties:DE(c,a)},url:ZD(o,a)}},XD=(t,e)=>{const{conditions:r,error:n}=t,{result:s,referenceRecord:i}=cp(r,e);if(s)throw new _r(hu(n,"Error",{...e,referenceRecord:{...e.referenceRecord,...i}}))},BE=(t,e)=>{for(const r of t)if(r.type==="endpoint"){const n=KD(r,e);if(n)return n}else if(r.type==="error")XD(r,e);else if(r.type==="tree"){const n=FE.evaluateTreeRule(r,e);if(n)return n}else throw new _r(`Unknown endpoint rule: ${r}`);throw new _r("Rules evaluation failed")},YD=(t,e)=>{const{conditions:r,rules:n}=t,{result:s,referenceRecord:i}=cp(r,e);if(s)return FE.evaluateRules(n,{...e,referenceRecord:{...e.referenceRecord,...i}})},FE={evaluateRules:BE,evaluateTreeRule:YD},QD=(t,e)=>{var u,l,d,h;const{endpointParams:r,logger:n}=e,{parameters:s,rules:i}=t;(l=(u=e.logger)==null?void 0:u.debug)==null||l.call(u,`${Pa} Initial EndpointParams: ${us(r)}`);const a=Object.entries(s).filter(([,p])=>p.default!=null).map(([p,m])=>[p,m.default]);if(a.length>0)for(const[p,m]of a)r[p]=r[p]??m;const o=Object.entries(s).filter(([,p])=>p.required).map(([p])=>p);for(const p of o)if(r[p]==null)throw new _r(`Missing required parameter: '${p}'`);const c=BE(i,{endpointParams:r,logger:n,referenceRecord:{}});return(h=(d=e.logger)==null?void 0:d.debug)==null||h.call(d,`${Pa} Resolved endpoint: ${us(c)}`),c},jE=(t,e=!1)=>{if(e){for(const r of t.split("."))if(!jE(r))return!1;return!0}return!(!du(t)||t.length<3||t.length>63||t!==t.toLowerCase()||OE(t))},ky=":",e4="/",t4=t=>{const e=t.split(ky);if(e.length<6)return null;const[r,n,s,i,a,...o]=e;if(r!=="arn"||n===""||s===""||o.join(ky)==="")return null;const c=o.map(u=>u.split(e4)).flat();return{partition:n,service:s,region:i,accountId:a,resourceId:c}},r4=[{id:"aws",outputs:{dnsSuffix:"amazonaws.com",dualStackDnsSuffix:"api.aws",implicitGlobalRegion:"us-east-1",name:"aws",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^(us|eu|ap|sa|ca|me|af|il|mx)\\-\\w+\\-\\d+$",regions:{"af-south-1":{description:"Africa (Cape Town)"},"ap-east-1":{description:"Asia Pacific (Hong Kong)"},"ap-east-2":{description:"Asia Pacific (Taipei)"},"ap-northeast-1":{description:"Asia Pacific (Tokyo)"},"ap-northeast-2":{description:"Asia Pacific (Seoul)"},"ap-northeast-3":{description:"Asia Pacific (Osaka)"},"ap-south-1":{description:"Asia Pacific (Mumbai)"},"ap-south-2":{description:"Asia Pacific (Hyderabad)"},"ap-southeast-1":{description:"Asia Pacific (Singapore)"},"ap-southeast-2":{description:"Asia Pacific (Sydney)"},"ap-southeast-3":{description:"Asia Pacific (Jakarta)"},"ap-southeast-4":{description:"Asia Pacific (Melbourne)"},"ap-southeast-5":{description:"Asia Pacific (Malaysia)"},"ap-southeast-6":{description:"Asia Pacific (New Zealand)"},"ap-southeast-7":{description:"Asia Pacific (Thailand)"},"aws-global":{description:"aws global region"},"ca-central-1":{description:"Canada (Central)"},"ca-west-1":{description:"Canada West (Calgary)"},"eu-central-1":{description:"Europe (Frankfurt)"},"eu-central-2":{description:"Europe (Zurich)"},"eu-north-1":{description:"Europe (Stockholm)"},"eu-south-1":{description:"Europe (Milan)"},"eu-south-2":{description:"Europe (Spain)"},"eu-west-1":{description:"Europe (Ireland)"},"eu-west-2":{description:"Europe (London)"},"eu-west-3":{description:"Europe (Paris)"},"il-central-1":{description:"Israel (Tel Aviv)"},"me-central-1":{description:"Middle East (UAE)"},"me-south-1":{description:"Middle East (Bahrain)"},"mx-central-1":{description:"Mexico (Central)"},"sa-east-1":{description:"South America (Sao Paulo)"},"us-east-1":{description:"US East (N. Virginia)"},"us-east-2":{description:"US East (Ohio)"},"us-west-1":{description:"US West (N. California)"},"us-west-2":{description:"US West (Oregon)"}}},{id:"aws-cn",outputs:{dnsSuffix:"amazonaws.com.cn",dualStackDnsSuffix:"api.amazonwebservices.com.cn",implicitGlobalRegion:"cn-northwest-1",name:"aws-cn",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^cn\\-\\w+\\-\\d+$",regions:{"aws-cn-global":{description:"aws-cn global region"},"cn-north-1":{description:"China (Beijing)"},"cn-northwest-1":{description:"China (Ningxia)"}}},{id:"aws-eusc",outputs:{dnsSuffix:"amazonaws.eu",dualStackDnsSuffix:"api.amazonwebservices.eu",implicitGlobalRegion:"eusc-de-east-1",name:"aws-eusc",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^eusc\\-(de)\\-\\w+\\-\\d+$",regions:{"eusc-de-east-1":{description:"EU (Germany)"}}},{id:"aws-iso",outputs:{dnsSuffix:"c2s.ic.gov",dualStackDnsSuffix:"api.aws.ic.gov",implicitGlobalRegion:"us-iso-east-1",name:"aws-iso",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-iso\\-\\w+\\-\\d+$",regions:{"aws-iso-global":{description:"aws-iso global region"},"us-iso-east-1":{description:"US ISO East"},"us-iso-west-1":{description:"US ISO WEST"}}},{id:"aws-iso-b",outputs:{dnsSuffix:"sc2s.sgov.gov",dualStackDnsSuffix:"api.aws.scloud",implicitGlobalRegion:"us-isob-east-1",name:"aws-iso-b",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-isob\\-\\w+\\-\\d+$",regions:{"aws-iso-b-global":{description:"aws-iso-b global region"},"us-isob-east-1":{description:"US ISOB East (Ohio)"},"us-isob-west-1":{description:"US ISOB West"}}},{id:"aws-iso-e",outputs:{dnsSuffix:"cloud.adc-e.uk",dualStackDnsSuffix:"api.cloud-aws.adc-e.uk",implicitGlobalRegion:"eu-isoe-west-1",name:"aws-iso-e",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^eu\\-isoe\\-\\w+\\-\\d+$",regions:{"aws-iso-e-global":{description:"aws-iso-e global region"},"eu-isoe-west-1":{description:"EU ISOE West"}}},{id:"aws-iso-f",outputs:{dnsSuffix:"csp.hci.ic.gov",dualStackDnsSuffix:"api.aws.hci.ic.gov",implicitGlobalRegion:"us-isof-south-1",name:"aws-iso-f",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-isof\\-\\w+\\-\\d+$",regions:{"aws-iso-f-global":{description:"aws-iso-f global region"},"us-isof-east-1":{description:"US ISOF EAST"},"us-isof-south-1":{description:"US ISOF SOUTH"}}},{id:"aws-us-gov",outputs:{dnsSuffix:"amazonaws.com",dualStackDnsSuffix:"api.aws",implicitGlobalRegion:"us-gov-west-1",name:"aws-us-gov",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-gov\\-\\w+\\-\\d+$",regions:{"aws-us-gov-global":{description:"aws-us-gov global region"},"us-gov-east-1":{description:"AWS GovCloud (US-East)"},"us-gov-west-1":{description:"AWS GovCloud (US-West)"}}}],n4={partitions:r4};let s4=n4;const i4=t=>{const{partitions:e}=s4;for(const n of e){const{regions:s,outputs:i}=n;for(const[a,o]of Object.entries(s))if(a===t)return{...i,...o}}for(const n of e){const{regionRegex:s,outputs:i}=n;if(new RegExp(s).test(t))return{...i}}const r=e.find(n=>n.id==="aws");if(!r)throw new Error("Provided region was not found in the partition array or regex, and default partition with id 'aws' doesn't exist.");return{...r.outputs}},zE={isVirtualHostableS3Bucket:jE,parseArn:t4,partition:i4};Oc.aws=zE;function a4(t){const e={};if(t=t.replace(/^\?/,""),t)for(const r of t.split("&")){let[n,s=null]=r.split("=");n=decodeURIComponent(n),s&&(s=decodeURIComponent(s)),n in e?Array.isArray(e[n])?e[n].push(s):e[n]=[e[n],s]:e[n]=s}return e}const Nc=t=>{if(typeof t=="string")return Nc(new URL(t));const{hostname:e,pathname:r,port:n,protocol:s,search:i}=t;let a;return i&&(a=a4(i)),{hostname:e,port:n?parseInt(n):void 0,protocol:s,path:r,query:a}};function o4(t,e,r){return t.$source||(t.$source={}),t.$source[e]=r,t}function Kr(t,e,r){t.__aws_sdk_context?t.__aws_sdk_context.features||(t.__aws_sdk_context.features={}):t.__aws_sdk_context={features:{}},t.__aws_sdk_context.features[e]=r}const Iy=t=>{var e,r;return Ti.isInstance(t)?((e=t.headers)==null?void 0:e.date)??((r=t.headers)==null?void 0:r.Date):void 0},VE=t=>new Date(Date.now()+t),c4=(t,e)=>Math.abs(VE(e).getTime()-t)>=3e5,Ry=(t,e)=>{const r=Date.parse(t);return c4(r,e)?r-Date.now():e},aa=(t,e)=>{if(!e)throw new Error(`Property \`${t}\` is not resolved for AWS SDK SigV4Auth`);return e},u4=async t=>{var u,l,d;const e=aa("context",t.context),r=aa("config",t.config),n=(d=(l=(u=e.endpointV2)==null?void 0:u.properties)==null?void 0:l.authSchemes)==null?void 0:d[0],i=await aa("signer",r.signer)(n),a=t==null?void 0:t.signingRegion,o=t==null?void 0:t.signingRegionSet,c=t==null?void 0:t.signingName;return{config:r,signer:i,signingRegion:a,signingRegionSet:o,signingName:c}};class l4{async sign(e,r,n){var d;if(!or.isInstance(e))throw new Error("The request is not an instance of `HttpRequest` and cannot be signed");const s=await u4(n),{config:i,signer:a}=s;let{signingRegion:o,signingName:c}=s;const u=n.context;if(((d=u==null?void 0:u.authSchemes)==null?void 0:d.length)??!1){const[h,p]=u.authSchemes;(h==null?void 0:h.name)==="sigv4a"&&(p==null?void 0:p.name)==="sigv4"&&(o=(p==null?void 0:p.signingRegion)??o,c=(p==null?void 0:p.signingName)??c)}return await a.sign(e,{signingDate:VE(i.systemClockOffset),signingRegion:o,signingService:c})}errorHandler(e){return r=>{const n=r.ServerTime??Iy(r.$response);if(n){const s=aa("config",e.config),i=s.systemClockOffset;s.systemClockOffset=Ry(n,s.systemClockOffset),s.systemClockOffset!==i&&r.$metadata&&(r.$metadata.clockSkewCorrected=!0)}throw r}}successHandler(e,r){const n=Iy(e);if(n){const s=aa("config",r.config);s.systemClockOffset=Ry(n,s.systemClockOffset)}}}const d4=(t,e,r)=>{let n,s,i,a=!1;const o=async()=>{s||(s=t());try{n=await s,i=!0,a=!1}finally{s=void 0}return n};return async c=>((!i||c!=null&&c.forceRefresh)&&(n=await o()),n)},h4="X-Amz-Algorithm",f4="X-Amz-Credential",GE="X-Amz-Date",p4="X-Amz-SignedHeaders",m4="X-Amz-Expires",HE="X-Amz-Signature",qE="X-Amz-Security-Token",WE="authorization",JE=GE.toLowerCase(),g4="date",y4=[WE,JE,g4],_4=HE.toLowerCase(),Sh="x-amz-content-sha256",w4=qE.toLowerCase(),v4={authorization:!0,"cache-control":!0,connection:!0,expect:!0,from:!0,"keep-alive":!0,"max-forwards":!0,pragma:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,"x-amzn-trace-id":!0},b4=/^proxy-/,E4=/^sec-/,fd="AWS4-HMAC-SHA256",S4="AWS4-HMAC-SHA256-PAYLOAD",x4="UNSIGNED-PAYLOAD",T4=50,ZE="aws4_request",A4=3600*24*7,To={},pd=[],md=(t,e,r)=>`${t}/${e}/${r}/${ZE}`,C4=async(t,e,r,n,s)=>{const i=await Oy(t,e.secretAccessKey,e.accessKeyId),a=`${r}:${n}:${s}:${pr(i)}:${e.sessionToken}`;if(a in To)return To[a];for(pd.push(a);pd.length>T4;)delete To[pd.shift()];let o=`AWS4${e.secretAccessKey}`;for(const c of[r,n,s,ZE])o=await Oy(t,o,c);return To[a]=o},Oy=(t,e,r)=>{const n=new t(e);return n.update(Oa(r)),n.digest()},Ny=({headers:t},e,r)=>{const n={};for(const s of Object.keys(t).sort()){if(t[s]==null)continue;const i=s.toLowerCase();(i in v4||e!=null&&e.has(i)||b4.test(i)||E4.test(i))&&(!r||r&&!r.has(i))||(n[i]=t[s].trim().replace(/\s+/g," "))}return n},k4=t=>typeof ArrayBuffer=="function"&&t instanceof ArrayBuffer||Object.prototype.toString.call(t)==="[object ArrayBuffer]",gd=async({headers:t,body:e},r)=>{for(const n of Object.keys(t))if(n.toLowerCase()===Sh)return t[n];if(e==null)return"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855";if(typeof e=="string"||ArrayBuffer.isView(e)||k4(e)){const n=new r;return n.update(Oa(e)),pr(await n.digest())}return x4};class I4{format(e){const r=[];for(const i of Object.keys(e)){const a=Ai(i);r.push(Uint8Array.from([a.byteLength]),a,this.formatHeaderValue(e[i]))}const n=new Uint8Array(r.reduce((i,a)=>i+a.byteLength,0));let s=0;for(const i of r)n.set(i,s),s+=i.byteLength;return n}formatHeaderValue(e){switch(e.type){case"boolean":return Uint8Array.from([e.value?0:1]);case"byte":return Uint8Array.from([2,e.value]);case"short":const r=new DataView(new ArrayBuffer(3));return r.setUint8(0,3),r.setInt16(1,e.value,!1),new Uint8Array(r.buffer);case"integer":const n=new DataView(new ArrayBuffer(5));return n.setUint8(0,4),n.setInt32(1,e.value,!1),new Uint8Array(n.buffer);case"long":const s=new Uint8Array(9);return s[0]=5,s.set(e.value.bytes,1),s;case"binary":const i=new DataView(new ArrayBuffer(3+e.value.byteLength));i.setUint8(0,6),i.setUint16(1,e.value.byteLength,!1);const a=new Uint8Array(i.buffer);return a.set(e.value,3),a;case"string":const o=Ai(e.value),c=new DataView(new ArrayBuffer(3+o.byteLength));c.setUint8(0,7),c.setUint16(1,o.byteLength,!1);const u=new Uint8Array(c.buffer);return u.set(o,3),u;case"timestamp":const l=new Uint8Array(9);return l[0]=8,l.set(O4.fromNumber(e.value.valueOf()).bytes,1),l;case"uuid":if(!R4.test(e.value))throw new Error(`Invalid UUID received: ${e.value}`);const d=new Uint8Array(17);return d[0]=9,d.set(ip(e.value.replace(/\-/g,"")),1),d}}}var $y;(function(t){t[t.boolTrue=0]="boolTrue",t[t.boolFalse=1]="boolFalse",t[t.byte=2]="byte",t[t.short=3]="short",t[t.integer=4]="integer",t[t.long=5]="long",t[t.byteArray=6]="byteArray",t[t.string=7]="string",t[t.timestamp=8]="timestamp",t[t.uuid=9]="uuid"})($y||($y={}));const R4=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/;let O4=class KE{constructor(e){f(this,"bytes");if(this.bytes=e,e.byteLength!==8)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(e){if(e>9223372036854776e3||e<-9223372036854776e3)throw new Error(`${e} is too large (or, if negative, too small) to represent as an Int64`);const r=new Uint8Array(8);for(let n=7,s=Math.abs(Math.round(e));n>-1&&s>0;n--,s/=256)r[n]=s;return e<0&&Py(r),new KE(r)}valueOf(){const e=this.bytes.slice(0),r=e[0]&128;return r&&Py(e),parseInt(pr(e),16)*(r?-1:1)}toString(){return String(this.valueOf())}};function Py(t){for(let e=0;e<8;e++)t[e]^=255;for(let e=7;e>-1&&(t[e]++,t[e]===0);e--);}const N4=(t,e)=>{t=t.toLowerCase();for(const r of Object.keys(e))if(t===r.toLowerCase())return!0;return!1},$4=(t,e={})=>{var s,i;const{headers:r,query:n={}}=or.clone(t);for(const a of Object.keys(r)){const o=a.toLowerCase();(o.slice(0,6)==="x-amz-"&&!((s=e.unhoistableHeaders)!=null&&s.has(o))||(i=e.hoistableHeaders)!=null&&i.has(o))&&(n[a]=r[a],delete r[a])}return{...t,headers:r,query:n}},Ly=t=>{t=or.clone(t);for(const e of Object.keys(t.headers))y4.indexOf(e.toLowerCase())>-1&&delete t.headers[e];return t},P4=({query:t={}})=>{const e=[],r={};for(const n of Object.keys(t)){if(n.toLowerCase()===_4)continue;const s=Is(n);e.push(s);const i=t[n];typeof i=="string"?r[s]=`${s}=${Is(i)}`:Array.isArray(i)&&(r[s]=i.slice(0).reduce((a,o)=>a.concat([`${s}=${Is(o)}`]),[]).sort().join("&"))}return e.sort().map(n=>r[n]).filter(n=>n).join("&")},L4=t=>D4(t).toISOString().replace(/\.\d{3}Z$/,"Z"),D4=t=>typeof t=="number"?new Date(t*1e3):typeof t=="string"?Number(t)?new Date(Number(t)*1e3):new Date(t):t;class M4{constructor({applyChecksum:e,credentials:r,region:n,service:s,sha256:i,uriEscapePath:a=!0}){f(this,"service");f(this,"regionProvider");f(this,"credentialProvider");f(this,"sha256");f(this,"uriEscapePath");f(this,"applyChecksum");this.service=s,this.sha256=i,this.uriEscapePath=a,this.applyChecksum=typeof e=="boolean"?e:!0,this.regionProvider=In(n),this.credentialProvider=In(r)}createCanonicalRequest(e,r,n){const s=Object.keys(r).sort();return`${e.method}
${this.getCanonicalPath(e)}
${P4(e)}
${s.map(i=>`${i}:${r[i]}`).join(`
`)}

${s.join(";")}
${n}`}async createStringToSign(e,r,n,s){const i=new this.sha256;i.update(Oa(n));const a=await i.digest();return`${s}
${e}
${r}
${pr(a)}`}getCanonicalPath({path:e}){if(this.uriEscapePath){const r=[];for(const i of e.split("/"))(i==null?void 0:i.length)!==0&&i!=="."&&(i===".."?r.pop():r.push(i));const n=`${e!=null&&e.startsWith("/")?"/":""}${r.join("/")}${r.length>0&&(e!=null&&e.endsWith("/"))?"/":""}`;return Is(n).replace(/%2F/g,"/")}return e}validateResolvedCredentials(e){if(typeof e!="object"||typeof e.accessKeyId!="string"||typeof e.secretAccessKey!="string")throw new Error("Resolved credential object is not valid")}formatDate(e){const r=L4(e).replace(/[\-:]/g,"");return{longDate:r,shortDate:r.slice(0,8)}}getCanonicalHeaderList(e){return Object.keys(e).sort().join(";")}}class Dy extends M4{constructor({applyChecksum:r,credentials:n,region:s,service:i,sha256:a,uriEscapePath:o=!0}){super({applyChecksum:r,credentials:n,region:s,service:i,sha256:a,uriEscapePath:o});f(this,"headerFormatter",new I4)}async presign(r,n={}){const{signingDate:s=new Date,expiresIn:i=3600,unsignableHeaders:a,unhoistableHeaders:o,signableHeaders:c,hoistableHeaders:u,signingRegion:l,signingService:d}=n,h=await this.credentialProvider();this.validateResolvedCredentials(h);const p=l??await this.regionProvider(),{longDate:m,shortDate:_}=this.formatDate(s);if(i>A4)return Promise.reject("Signature version 4 presigned URLs must have an expiration date less than one week in the future");const v=md(_,p,d??this.service),y=$4(Ly(r),{unhoistableHeaders:o,hoistableHeaders:u});h.sessionToken&&(y.query[qE]=h.sessionToken),y.query[h4]=fd,y.query[f4]=`${h.accessKeyId}/${v}`,y.query[GE]=m,y.query[m4]=i.toString(10);const E=Ny(y,a,c);return y.query[p4]=this.getCanonicalHeaderList(E),y.query[HE]=await this.getSignature(m,v,this.getSigningKey(h,p,_,d),this.createCanonicalRequest(y,E,await gd(r,this.sha256))),y}async sign(r,n){return typeof r=="string"?this.signString(r,n):r.headers&&r.payload?this.signEvent(r,n):r.message?this.signMessage(r,n):this.signRequest(r,n)}async signEvent({headers:r,payload:n},{signingDate:s=new Date,priorSignature:i,signingRegion:a,signingService:o}){const c=a??await this.regionProvider(),{shortDate:u,longDate:l}=this.formatDate(s),d=md(u,c,o??this.service),h=await gd({headers:{},body:n},this.sha256),p=new this.sha256;p.update(r);const m=pr(await p.digest()),_=[S4,l,d,i,m,h].join(`
`);return this.signString(_,{signingDate:s,signingRegion:c,signingService:o})}async signMessage(r,{signingDate:n=new Date,signingRegion:s,signingService:i}){return this.signEvent({headers:this.headerFormatter.format(r.message.headers),payload:r.message.body},{signingDate:n,signingRegion:s,signingService:i,priorSignature:r.priorSignature}).then(o=>({message:r.message,signature:o}))}async signString(r,{signingDate:n=new Date,signingRegion:s,signingService:i}={}){const a=await this.credentialProvider();this.validateResolvedCredentials(a);const o=s??await this.regionProvider(),{shortDate:c}=this.formatDate(n),u=new this.sha256(await this.getSigningKey(a,o,c,i));return u.update(Oa(r)),pr(await u.digest())}async signRequest(r,{signingDate:n=new Date,signableHeaders:s,unsignableHeaders:i,signingRegion:a,signingService:o}={}){const c=await this.credentialProvider();this.validateResolvedCredentials(c);const u=a??await this.regionProvider(),l=Ly(r),{longDate:d,shortDate:h}=this.formatDate(n),p=md(h,u,o??this.service);l.headers[JE]=d,c.sessionToken&&(l.headers[w4]=c.sessionToken);const m=await gd(l,this.sha256);!N4(Sh,l.headers)&&this.applyChecksum&&(l.headers[Sh]=m);const _=Ny(l,i,s),v=await this.getSignature(d,p,this.getSigningKey(c,u,h,o),this.createCanonicalRequest(l,_,m));return l.headers[WE]=`${fd} Credential=${c.accessKeyId}/${p}, SignedHeaders=${this.getCanonicalHeaderList(_)}, Signature=${v}`,l}async getSignature(r,n,s,i){const a=await this.createStringToSign(r,n,i,fd),o=new this.sha256(await s);return o.update(Oa(a)),pr(await o.digest())}getSigningKey(r,n,s,i){return C4(this.sha256,r,s,n,i||this.service)}}const U4=t=>{let e=t.credentials,r=!!t.credentials,n;Object.defineProperty(t,"credentials",{set(u){u&&u!==e&&u!==n&&(r=!0),e=u;const l=B4(t,{credentials:e,credentialDefaultProvider:t.credentialDefaultProvider}),d=F4(t,l);r&&!d.attributed?(n=async h=>d(h).then(p=>o4(p,"CREDENTIALS_CODE","e")),n.memoized=d.memoized,n.configBound=d.configBound,n.attributed=!0):n=d},get(){return n},enumerable:!0,configurable:!0}),t.credentials=e;const{signingEscapePath:s=!0,systemClockOffset:i=t.systemClockOffset||0,sha256:a}=t;let o;return t.signer?o=sa(t.signer):t.regionInfoProvider?o=()=>sa(t.region)().then(async u=>[await t.regionInfoProvider(u,{useFipsEndpoint:await t.useFipsEndpoint(),useDualstackEndpoint:await t.useDualstackEndpoint()})||{},u]).then(([u,l])=>{const{signingRegion:d,signingService:h}=u;t.signingRegion=t.signingRegion||d||l,t.signingName=t.signingName||h||t.serviceId;const p={...t,credentials:t.credentials,region:t.signingRegion,service:t.signingName,sha256:a,uriEscapePath:s},m=t.signerConstructor||Dy;return new m(p)}):o=async u=>{u=Object.assign({},{name:"sigv4",signingName:t.signingName||t.defaultSigningName,signingRegion:await sa(t.region)(),properties:{}},u);const l=u.signingRegion,d=u.signingName;t.signingRegion=t.signingRegion||l,t.signingName=t.signingName||d||t.serviceId;const h={...t,credentials:t.credentials,region:t.signingRegion,service:t.signingName,sha256:a,uriEscapePath:s},p=t.signerConstructor||Dy;return new p(h)},Object.assign(t,{systemClockOffset:i,signingEscapePath:s,signer:o})};function B4(t,{credentials:e,credentialDefaultProvider:r}){let n;return e?e!=null&&e.memoized?n=e:n=RE(e,IE,op):r?n=sa(r(Object.assign({},t,{parentClientConfig:t}))):n=async()=>{throw new Error("@aws-sdk/core::resolveAwsSdkSigV4Config - `credentials` not provided and no credentialDefaultProvider was configured.")},n.memoized=!0,n}function F4(t,e){if(e.configBound)return e;const r=async n=>e({...n,callerClientConfig:t});return r.memoized=e.memoized,r.configBound=!0,r}const My=typeof TextEncoder=="function"?new TextEncoder:null,j4=t=>{if(typeof t=="string"){if(My)return My.encode(t).byteLength;let e=t.length;for(let r=e-1;r>=0;r--){const n=t.charCodeAt(r);n>127&&n<=2047?e++:n>2047&&n<=65535&&(e+=2),n>=56320&&n<=57343&&r--}return e}else{if(typeof t.byteLength=="number")return t.byteLength;if(typeof t.size=="number")return t.size}throw new Error(`Body Length computation failed for ${t}`)},ms=(t,e)=>{const r=[];if(t&&r.push(t),e)for(const n of e)r.push(n);return r},Vn=(t,e)=>`${t||"anonymous"}${e&&e.length>0?` (a.k.a. ${e.join(",")})`:""}`,$c=()=>{let t=[],e=[],r=!1;const n=new Set,s=d=>d.sort((h,p)=>Uy[p.step]-Uy[h.step]||By[p.priority||"normal"]-By[h.priority||"normal"]),i=d=>{let h=!1;const p=m=>{const _=ms(m.name,m.aliases);if(_.includes(d)){h=!0;for(const v of _)n.delete(v);return!1}return!0};return t=t.filter(p),e=e.filter(p),h},a=d=>{let h=!1;const p=m=>{if(m.middleware===d){h=!0;for(const _ of ms(m.name,m.aliases))n.delete(_);return!1}return!0};return t=t.filter(p),e=e.filter(p),h},o=d=>{var h;return t.forEach(p=>{d.add(p.middleware,{...p})}),e.forEach(p=>{d.addRelativeTo(p.middleware,{...p})}),(h=d.identifyOnResolve)==null||h.call(d,l.identifyOnResolve()),d},c=d=>{const h=[];return d.before.forEach(p=>{p.before.length===0&&p.after.length===0?h.push(p):h.push(...c(p))}),h.push(d),d.after.reverse().forEach(p=>{p.before.length===0&&p.after.length===0?h.push(p):h.push(...c(p))}),h},u=(d=!1)=>{const h=[],p=[],m={};return t.forEach(v=>{const y={...v,before:[],after:[]};for(const E of ms(y.name,y.aliases))m[E]=y;h.push(y)}),e.forEach(v=>{const y={...v,before:[],after:[]};for(const E of ms(y.name,y.aliases))m[E]=y;p.push(y)}),p.forEach(v=>{if(v.toMiddleware){const y=m[v.toMiddleware];if(y===void 0){if(d)return;throw new Error(`${v.toMiddleware} is not found when adding ${Vn(v.name,v.aliases)} middleware ${v.relation} ${v.toMiddleware}`)}v.relation==="after"&&y.after.push(v),v.relation==="before"&&y.before.push(v)}}),s(h).map(c).reduce((v,y)=>(v.push(...y),v),[])},l={add:(d,h={})=>{const{name:p,override:m,aliases:_}=h,v={step:"initialize",priority:"normal",middleware:d,...h},y=ms(p,_);if(y.length>0){if(y.some(E=>n.has(E))){if(!m)throw new Error(`Duplicate middleware name '${Vn(p,_)}'`);for(const E of y){const b=t.findIndex(k=>{var R;return k.name===E||((R=k.aliases)==null?void 0:R.some(P=>P===E))});if(b===-1)continue;const I=t[b];if(I.step!==v.step||v.priority!==I.priority)throw new Error(`"${Vn(I.name,I.aliases)}" middleware with ${I.priority} priority in ${I.step} step cannot be overridden by "${Vn(p,_)}" middleware with ${v.priority} priority in ${v.step} step.`);t.splice(b,1)}}for(const E of y)n.add(E)}t.push(v)},addRelativeTo:(d,h)=>{const{name:p,override:m,aliases:_}=h,v={middleware:d,...h},y=ms(p,_);if(y.length>0){if(y.some(E=>n.has(E))){if(!m)throw new Error(`Duplicate middleware name '${Vn(p,_)}'`);for(const E of y){const b=e.findIndex(k=>{var R;return k.name===E||((R=k.aliases)==null?void 0:R.some(P=>P===E))});if(b===-1)continue;const I=e[b];if(I.toMiddleware!==v.toMiddleware||I.relation!==v.relation)throw new Error(`"${Vn(I.name,I.aliases)}" middleware ${I.relation} "${I.toMiddleware}" middleware cannot be overridden by "${Vn(p,_)}" middleware ${v.relation} "${v.toMiddleware}" middleware.`);e.splice(b,1)}}for(const E of y)n.add(E)}e.push(v)},clone:()=>o($c()),use:d=>{d.applyToStack(l)},remove:d=>typeof d=="string"?i(d):a(d),removeByTag:d=>{let h=!1;const p=m=>{const{tags:_,name:v,aliases:y}=m;if(_&&_.includes(d)){const E=ms(v,y);for(const b of E)n.delete(b);return h=!0,!1}return!0};return t=t.filter(p),e=e.filter(p),h},concat:d=>{var p;const h=o($c());return h.use(d),h.identifyOnResolve(r||h.identifyOnResolve()||(((p=d.identifyOnResolve)==null?void 0:p.call(d))??!1)),h},applyToStack:o,identify:()=>u(!0).map(d=>{const h=d.step??d.relation+" "+d.toMiddleware;return Vn(d.name,d.aliases)+" - "+h}),identifyOnResolve(d){return typeof d=="boolean"&&(r=d),r},resolve:(d,h)=>{for(const p of u().map(m=>m.middleware).reverse())d=p(d,h);return r&&console.log(l.identify()),d}};return l},Uy={initialize:5,serialize:4,build:3,finalizeRequest:2,deserialize:1},By={high:3,normal:2,low:1};class z4{constructor(e){f(this,"config");f(this,"middlewareStack",$c());f(this,"initConfig");f(this,"handlers");this.config=e}send(e,r,n){const s=typeof r!="function"?r:void 0,i=typeof r=="function"?r:n,a=s===void 0&&this.config.cacheMiddleware===!0;let o;if(a){this.handlers||(this.handlers=new WeakMap);const c=this.handlers;c.has(e.constructor)?o=c.get(e.constructor):(o=e.resolveMiddleware(this.middlewareStack,this.config,s),c.set(e.constructor,o))}else delete this.handlers,o=e.resolveMiddleware(this.middlewareStack,this.config,s);if(i)o(e).then(c=>i(null,c.output),c=>i(c)).catch(()=>{});else return o(e).then(c=>c.output)}destroy(){var e,r,n;(n=(r=(e=this.config)==null?void 0:e.requestHandler)==null?void 0:r.destroy)==null||n.call(r),delete this.handlers}}const yd="***SensitiveInformation***";function xh(t,e){if(e==null)return e;const r=$a.of(t);if(r.getMergedTraits().sensitive)return yd;if(r.isListSchema()){if(!!r.getValueSchema().getMergedTraits().sensitive)return yd}else if(r.isMapSchema()){if(!!r.getKeySchema().getMergedTraits().sensitive||!!r.getValueSchema().getMergedTraits().sensitive)return yd}else if(r.isStructSchema()&&typeof e=="object"){const n=e,s={};for(const[i,a]of r.structIterator())n[i]!=null&&(s[i]=xh(a,n[i]));return s}return e}class up{constructor(){f(this,"middlewareStack",$c());f(this,"schema")}static classBuilder(){return new V4}resolveMiddlewareWithContext(e,r,n,{middlewareFn:s,clientName:i,commandName:a,inputFilterSensitiveLog:o,outputFilterSensitiveLog:c,smithyContext:u,additionalContext:l,CommandCtor:d}){for(const v of s.bind(this)(d,e,r,n))this.middlewareStack.use(v);const h=e.concat(this.middlewareStack),{logger:p}=r,m={logger:p,clientName:i,commandName:a,inputFilterSensitiveLog:o,outputFilterSensitiveLog:c,[vh]:{commandInstance:this,...u},...l},{requestHandler:_}=r;return h.resolve(v=>_.handle(v.request,n||{}),m)}}class V4{constructor(){f(this,"_init",()=>{});f(this,"_ep",{});f(this,"_middlewareFn",()=>[]);f(this,"_commandName","");f(this,"_clientName","");f(this,"_additionalContext",{});f(this,"_smithyContext",{});f(this,"_inputFilterSensitiveLog");f(this,"_outputFilterSensitiveLog");f(this,"_serializer",null);f(this,"_deserializer",null);f(this,"_operationSchema")}init(e){this._init=e}ep(e){return this._ep=e,this}m(e){return this._middlewareFn=e,this}s(e,r,n={}){return this._smithyContext={service:e,operation:r,...n},this}c(e={}){return this._additionalContext=e,this}n(e,r){return this._clientName=e,this._commandName=r,this}f(e=n=>n,r=n=>n){return this._inputFilterSensitiveLog=e,this._outputFilterSensitiveLog=r,this}ser(e){return this._serializer=e,this}de(e){return this._deserializer=e,this}sc(e){return this._operationSchema=e,this._smithyContext.operationSchema=e,this}build(){const e=this;let r;return r=class extends up{constructor(...[s]){super();f(this,"input");f(this,"serialize",e._serializer);f(this,"deserialize",e._deserializer);this.input=s??{},e._init(this),this.schema=e._operationSchema}static getEndpointParameterInstructions(){return e._ep}resolveMiddleware(s,i,a){const o=e._operationSchema,c=(o==null?void 0:o[4])??(o==null?void 0:o.input),u=(o==null?void 0:o[5])??(o==null?void 0:o.output);return this.resolveMiddlewareWithContext(s,i,a,{CommandCtor:r,middlewareFn:e._middlewareFn,clientName:e._clientName,commandName:e._commandName,inputFilterSensitiveLog:e._inputFilterSensitiveLog??(o?xh.bind(null,c):l=>l),outputFilterSensitiveLog:e._outputFilterSensitiveLog??(o?xh.bind(null,u):l=>l),smithyContext:e._smithyContext,additionalContext:e._additionalContext})}}}}const Ln="***SensitiveInformation***";class ii extends Error{constructor(r){super(r.message);f(this,"$fault");f(this,"$response");f(this,"$retryable");f(this,"$metadata");Object.setPrototypeOf(this,Object.getPrototypeOf(this).constructor.prototype),this.name=r.name,this.$fault=r.$fault,this.$metadata=r.$metadata}static isInstance(r){if(!r)return!1;const n=r;return ii.prototype.isPrototypeOf(n)||!!n.$fault&&!!n.$metadata&&(n.$fault==="client"||n.$fault==="server")}static[Symbol.hasInstance](r){if(!r)return!1;const n=r;return this===ii?ii.isInstance(r):ii.isInstance(r)?n.name&&this.name?this.prototype.isPrototypeOf(r)||n.name===this.name:this.prototype.isPrototypeOf(r):!1}}const wr=(t,e={})=>{Object.entries(e).filter(([,n])=>n!==void 0).forEach(([n,s])=>{(t[n]==null||t[n]==="")&&(t[n]=s)});const r=t.message||t.Message||"UnknownError";return t.message=r,delete t.Message,t},G4=({output:t,parsedBody:e,exceptionCtor:r,errorCode:n})=>{const s=q4(t),i=s.httpStatusCode?s.httpStatusCode+"":void 0,a=new r({name:(e==null?void 0:e.code)||(e==null?void 0:e.Code)||n||i||"UnknownError",$fault:"client",$metadata:s});throw wr(a,e)},H4=t=>({output:e,parsedBody:r,errorCode:n})=>{G4({output:e,parsedBody:r,exceptionCtor:t,errorCode:n})},q4=t=>({httpStatusCode:t.statusCode,requestId:t.headers["x-amzn-requestid"]??t.headers["x-amzn-request-id"]??t.headers["x-amz-request-id"],extendedRequestId:t.headers["x-amz-id-2"],cfId:t.headers["x-amz-cf-id"]}),W4=t=>{switch(t){case"standard":return{retryMode:"standard",connectionTimeout:3100};case"in-region":return{retryMode:"standard",connectionTimeout:1100};case"cross-region":return{retryMode:"standard",connectionTimeout:3100};case"mobile":return{retryMode:"standard",connectionTimeout:3e4};default:return{}}},J4=t=>{const e=[];for(const r in kc){const n=kc[r];t[n]!==void 0&&e.push({algorithmId:()=>n,checksumConstructor:()=>t[n]})}return{addChecksumAlgorithm(r){e.push(r)},checksumAlgorithms(){return e}}},Z4=t=>{const e={};return t.checksumAlgorithms().forEach(r=>{e[r.algorithmId()]=r.checksumConstructor()}),e},K4=t=>({setRetryStrategy(e){t.retryStrategy=e},retryStrategy(){return t.retryStrategy}}),X4=t=>{const e={};return e.retryStrategy=t.retryStrategy(),e},Y4=t=>Object.assign(J4(t),K4(t)),Q4=t=>Object.assign(Z4(t),X4(t));class XE{trace(){}debug(){}info(){}warn(){}error(){}}function ur(t,e,r){let n,s;n={},s=t;for(const i of Object.keys(s)){if(!Array.isArray(s[i])){n[i]=s[i];continue}YE(n,null,s,i)}return n}const _e=(t,e)=>{const r={};for(const n in e)YE(r,t,e,n);return r},YE=(t,e,r,n)=>{if(e!==null){let a=r[n];typeof a=="function"&&(a=[,a]);const[o=eM,c=tM,u=n]=a;(typeof o=="function"&&o(e[u])||typeof o!="function"&&o)&&(t[n]=c(e[u]));return}let[s,i]=r[n];if(typeof i=="function"){let a;const o=s===void 0&&(a=i())!=null,c=typeof s=="function"&&!!s(void 0)||typeof s!="function"&&!!s;o?t[n]=a:c&&(t[n]=i())}else{const a=s===void 0&&i!=null,o=typeof s=="function"&&!!s(i)||typeof s!="function"&&!!s;(a||o)&&(t[n]=i)}},eM=t=>t!=null,tM=t=>t,Fy=t=>{if(t!==t)return"NaN";switch(t){case 1/0:return"Infinity";case-1/0:return"-Infinity";default:return t}},Y=t=>{if(t==null)return{};if(Array.isArray(t))return t.filter(e=>e!=null).map(Y);if(typeof t=="object"){const e={};for(const r of Object.keys(t))t[r]!=null&&(e[r]=Y(t[r]));return e}return t},rM=(t,e)=>fD(t,e).then(r=>((e==null?void 0:e.utf8Encoder)??sp)(r)),vr=(t,e)=>rM(t,e).then(r=>{if(r.length)try{return JSON.parse(r)}catch(n){throw(n==null?void 0:n.name)==="SyntaxError"&&Object.defineProperty(n,"$responseBodyText",{value:r}),n}return{}}),nM=async(t,e)=>{const r=await vr(t,e);return r.message=r.message??r.Message,r},sM=(t,e)=>{const r=(i,a)=>Object.keys(i).find(o=>o.toLowerCase()===a.toLowerCase()),n=i=>{let a=i;return typeof a=="number"&&(a=a.toString()),a.indexOf(",")>=0&&(a=a.split(",")[0]),a.indexOf(":")>=0&&(a=a.split(":")[0]),a.indexOf("#")>=0&&(a=a.split("#")[1]),a},s=r(t.headers,"x-amzn-errortype");if(s!==void 0)return n(t.headers[s]);if(e&&typeof e=="object"){const i=r(e,"code");if(i&&e[i]!==void 0)return n(e[i]);if(e.__type!==void 0)return n(e.__type)}},$r=t=>{if(t!=null)return typeof t=="object"&&"__type"in t&&delete t.__type,bD(t)},iM=/\d{12}\.ddb/;async function aM(t,e,r){var i,a,o,c,u,l,d;const n=r.request;if(((i=n==null?void 0:n.headers)==null?void 0:i["smithy-protocol"])==="rpc-v2-cbor"&&Kr(t,"PROTOCOL_RPC_V2_CBOR","M"),typeof e.retryStrategy=="function"){const h=await e.retryStrategy();typeof h.acquireInitialRetryToken=="function"?(o=(a=h.constructor)==null?void 0:a.name)!=null&&o.includes("Adaptive")?Kr(t,"RETRY_MODE_ADAPTIVE","F"):Kr(t,"RETRY_MODE_STANDARD","E"):Kr(t,"RETRY_MODE_LEGACY","D")}if(typeof e.accountIdEndpointMode=="function"){const h=t.endpointV2;switch(String((c=h==null?void 0:h.url)==null?void 0:c.hostname).match(iM)&&Kr(t,"ACCOUNT_ID_ENDPOINT","O"),await((u=e.accountIdEndpointMode)==null?void 0:u.call(e))){case"disabled":Kr(t,"ACCOUNT_ID_MODE_DISABLED","Q");break;case"preferred":Kr(t,"ACCOUNT_ID_MODE_PREFERRED","P");break;case"required":Kr(t,"ACCOUNT_ID_MODE_REQUIRED","R");break}}const s=(d=(l=t.__smithy_context)==null?void 0:l.selectedHttpAuthScheme)==null?void 0:d.identity;if(s!=null&&s.$source){const h=s;h.accountId&&Kr(t,"RESOLVED_ACCOUNT_ID","T");for(const[p,m]of Object.entries(h.$source??{}))Kr(t,p,m)}}const jy="user-agent",_d="x-amz-user-agent",zy=" ",wd="/",oM=/[^\!\$\%\&\'\*\+\-\.\^\_\`\|\~\d\w]/g,cM=/[^\!\$\%\&\'\*\+\-\.\^\_\`\|\~\d\w\#]/g,Vy="-",uM=1024;function lM(t){let e="";for(const r in t){const n=t[r];if(e.length+n.length+1<=uM){e.length?e+=","+n:e+=n;continue}break}return e}const dM=t=>(e,r)=>async n=>{var p,m,_,v;const{request:s}=n;if(!or.isInstance(s))return e(n);const{headers:i}=s,a=((p=r==null?void 0:r.userAgent)==null?void 0:p.map(Ao))||[],o=(await t.defaultUserAgentProvider()).map(Ao);await aM(r,t,n);const c=r;o.push(`m/${lM(Object.assign({},(m=r.__smithy_context)==null?void 0:m.features,(_=c.__aws_sdk_context)==null?void 0:_.features))}`);const u=((v=t==null?void 0:t.customUserAgent)==null?void 0:v.map(Ao))||[],l=await t.userAgentAppId();l&&o.push(Ao([`app/${l}`]));const d=[].concat([...o,...a,...u]).join(zy),h=[...o.filter(y=>y.startsWith("aws-sdk-")),...u].join(zy);return t.runtime!=="browser"?(h&&(i[_d]=i[_d]?`${i[jy]} ${h}`:h),i[jy]=d):i[_d]=d,e({...n,request:s})},Ao=t=>{var a;const e=t[0].split(wd).map(o=>o.replace(oM,Vy)).join(wd),r=(a=t[1])==null?void 0:a.replace(cM,Vy),n=e.indexOf(wd),s=e.substring(0,n);let i=e.substring(n+1);return s==="api"&&(i=i.toLowerCase()),[s,i,r].filter(o=>o&&o.length>0).reduce((o,c,u)=>{switch(u){case 0:return c;case 1:return`${o}/${c}`;default:return`${o}#${c}`}},"")},hM={name:"getUserAgentMiddleware",step:"build",priority:"low",tags:["SET_USER_AGENT","USER_AGENT"],override:!0},fM=t=>({applyToStack:e=>{e.add(dM(t),hM)}});function pM(t,e,r,n){function s(i){return i instanceof r?i:new r(function(a){a(i)})}return new(r||(r=Promise))(function(i,a){function o(l){try{u(n.next(l))}catch(d){a(d)}}function c(l){try{u(n.throw(l))}catch(d){a(d)}}function u(l){l.done?i(l.value):s(l.value).then(o,c)}u((n=n.apply(t,e||[])).next())})}function mM(t,e){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,s,i,a=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(u){return function(l){return c([u,l])}}function c(u){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(r=0)),r;)try{if(n=1,s&&(i=u[0]&2?s.return:u[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,u[1])).done)return i;switch(s=0,i&&(u=[u[0]&2,i.value]),u[0]){case 0:case 1:i=u;break;case 4:return r.label++,{value:u[1],done:!1};case 5:r.label++,s=u[1],u=[0];continue;case 7:u=r.ops.pop(),r.trys.pop();continue;default:if(i=r.trys,!(i=i.length>0&&i[i.length-1])&&(u[0]===6||u[0]===2)){r=0;continue}if(u[0]===3&&(!i||u[1]>i[0]&&u[1]<i[3])){r.label=u[1];break}if(u[0]===6&&r.label<i[1]){r.label=i[1],i=u;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(u);break}i[2]&&r.ops.pop(),r.trys.pop();continue}u=e.call(t,r)}catch(l){u=[6,l],s=0}finally{n=i=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function gM(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}const yM=t=>new TextEncoder().encode(t);var _M=typeof ln<"u"&&ln.from?function(t){return ln.from(t,"utf8")}:yM;function La(t){return t instanceof Uint8Array?t:typeof t=="string"?_M(t):ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength/Uint8Array.BYTES_PER_ELEMENT):new Uint8Array(t)}function Th(t){return typeof t=="string"?t.length===0:t.byteLength===0}function wM(t){if(!Uint32Array.from){for(var e=new Uint32Array(t.length),r=0;r<t.length;)e[r]=t[r],r+=1;return e}return Uint32Array.from(t)}var QE=(function(){function t(){this.checksum=4294967295}return t.prototype.update=function(e){var r,n;try{for(var s=gM(e),i=s.next();!i.done;i=s.next()){var a=i.value;this.checksum=this.checksum>>>8^bM[(this.checksum^a)&255]}}catch(o){r={error:o}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return this},t.prototype.digest=function(){return(this.checksum^4294967295)>>>0},t})(),vM=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],bM=wM(vM);class oa{constructor(e){f(this,"bytes");if(this.bytes=e,e.byteLength!==8)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(e){if(e>9223372036854776e3||e<-9223372036854776e3)throw new Error(`${e} is too large (or, if negative, too small) to represent as an Int64`);const r=new Uint8Array(8);for(let n=7,s=Math.abs(Math.round(e));n>-1&&s>0;n--,s/=256)r[n]=s;return e<0&&Gy(r),new oa(r)}valueOf(){const e=this.bytes.slice(0),r=e[0]&128;return r&&Gy(e),parseInt(pr(e),16)*(r?-1:1)}toString(){return String(this.valueOf())}}function Gy(t){for(let e=0;e<8;e++)t[e]^=255;for(let e=7;e>-1&&(t[e]++,t[e]===0);e--);}class EM{constructor(e,r){f(this,"toUtf8");f(this,"fromUtf8");this.toUtf8=e,this.fromUtf8=r}format(e){const r=[];for(const i of Object.keys(e)){const a=this.fromUtf8(i);r.push(Uint8Array.from([a.byteLength]),a,this.formatHeaderValue(e[i]))}const n=new Uint8Array(r.reduce((i,a)=>i+a.byteLength,0));let s=0;for(const i of r)n.set(i,s),s+=i.byteLength;return n}formatHeaderValue(e){switch(e.type){case"boolean":return Uint8Array.from([e.value?0:1]);case"byte":return Uint8Array.from([2,e.value]);case"short":const r=new DataView(new ArrayBuffer(3));return r.setUint8(0,3),r.setInt16(1,e.value,!1),new Uint8Array(r.buffer);case"integer":const n=new DataView(new ArrayBuffer(5));return n.setUint8(0,4),n.setInt32(1,e.value,!1),new Uint8Array(n.buffer);case"long":const s=new Uint8Array(9);return s[0]=5,s.set(e.value.bytes,1),s;case"binary":const i=new DataView(new ArrayBuffer(3+e.value.byteLength));i.setUint8(0,6),i.setUint16(1,e.value.byteLength,!1);const a=new Uint8Array(i.buffer);return a.set(e.value,3),a;case"string":const o=this.fromUtf8(e.value),c=new DataView(new ArrayBuffer(3+o.byteLength));c.setUint8(0,7),c.setUint16(1,o.byteLength,!1);const u=new Uint8Array(c.buffer);return u.set(o,3),u;case"timestamp":const l=new Uint8Array(9);return l[0]=8,l.set(oa.fromNumber(e.value.valueOf()).bytes,1),l;case"uuid":if(!OM.test(e.value))throw new Error(`Invalid UUID received: ${e.value}`);const d=new Uint8Array(17);return d[0]=9,d.set(ip(e.value.replace(/\-/g,"")),1),d}}parse(e){const r={};let n=0;for(;n<e.byteLength;){const s=e.getUint8(n++),i=this.toUtf8(new Uint8Array(e.buffer,e.byteOffset+n,s));switch(n+=s,e.getUint8(n++)){case 0:r[i]={type:qy,value:!0};break;case 1:r[i]={type:qy,value:!1};break;case 2:r[i]={type:SM,value:e.getInt8(n++)};break;case 3:r[i]={type:xM,value:e.getInt16(n,!1)},n+=2;break;case 4:r[i]={type:TM,value:e.getInt32(n,!1)},n+=4;break;case 5:r[i]={type:AM,value:new oa(new Uint8Array(e.buffer,e.byteOffset+n,8))},n+=8;break;case 6:const a=e.getUint16(n,!1);n+=2,r[i]={type:CM,value:new Uint8Array(e.buffer,e.byteOffset+n,a)},n+=a;break;case 7:const o=e.getUint16(n,!1);n+=2,r[i]={type:kM,value:this.toUtf8(new Uint8Array(e.buffer,e.byteOffset+n,o))},n+=o;break;case 8:r[i]={type:IM,value:new Date(new oa(new Uint8Array(e.buffer,e.byteOffset+n,8)).valueOf())},n+=8;break;case 9:const c=new Uint8Array(e.buffer,e.byteOffset+n,16);n+=16,r[i]={type:RM,value:`${pr(c.subarray(0,4))}-${pr(c.subarray(4,6))}-${pr(c.subarray(6,8))}-${pr(c.subarray(8,10))}-${pr(c.subarray(10))}`};break;default:throw new Error("Unrecognized header type tag")}}return r}}var Hy;(function(t){t[t.boolTrue=0]="boolTrue",t[t.boolFalse=1]="boolFalse",t[t.byte=2]="byte",t[t.short=3]="short",t[t.integer=4]="integer",t[t.long=5]="long",t[t.byteArray=6]="byteArray",t[t.string=7]="string",t[t.timestamp=8]="timestamp",t[t.uuid=9]="uuid"})(Hy||(Hy={}));const qy="boolean",SM="byte",xM="short",TM="integer",AM="long",CM="binary",kM="string",IM="timestamp",RM="uuid",OM=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/,eS=4,Gn=eS*2,_s=4,NM=Gn+_s*2;function $M({byteLength:t,byteOffset:e,buffer:r}){if(t<NM)throw new Error("Provided message too short to accommodate event stream message overhead");const n=new DataView(r,e,t),s=n.getUint32(0,!1);if(t!==s)throw new Error("Reported message length does not match received message length");const i=n.getUint32(eS,!1),a=n.getUint32(Gn,!1),o=n.getUint32(t-_s,!1),c=new QE().update(new Uint8Array(r,e,Gn));if(a!==c.digest())throw new Error(`The prelude checksum specified in the message (${a}) does not match the calculated CRC32 checksum (${c.digest()})`);if(c.update(new Uint8Array(r,e+Gn,t-(Gn+_s))),o!==c.digest())throw new Error(`The message checksum (${c.digest()}) did not match the expected value of ${o}`);return{headers:new DataView(r,e+Gn+_s,i),body:new Uint8Array(r,e+Gn+_s+i,s-i-(Gn+_s+_s))}}class tS{constructor(e,r){f(this,"headerMarshaller");f(this,"messageBuffer");f(this,"isEndOfStream");this.headerMarshaller=new EM(e,r),this.messageBuffer=[],this.isEndOfStream=!1}feed(e){this.messageBuffer.push(this.decode(e))}endOfStream(){this.isEndOfStream=!0}getMessage(){const e=this.messageBuffer.pop(),r=this.isEndOfStream;return{getMessage(){return e},isEndOfStream(){return r}}}getAvailableMessages(){const e=this.messageBuffer;this.messageBuffer=[];const r=this.isEndOfStream;return{getMessages(){return e},isEndOfStream(){return r}}}encode({headers:e,body:r}){const n=this.headerMarshaller.format(e),s=n.byteLength+r.byteLength+16,i=new Uint8Array(s),a=new DataView(i.buffer,i.byteOffset,i.byteLength),o=new QE;return a.setUint32(0,s,!1),a.setUint32(4,n.byteLength,!1),a.setUint32(8,o.update(i.subarray(0,8)).digest(),!1),i.set(n,12),i.set(r,n.byteLength+12),a.setUint32(s-4,o.update(i.subarray(8,s-4)).digest(),!1),i}decode(e){const{headers:r,body:n}=$M(e);return{headers:this.headerMarshaller.parse(r),body:n}}formatHeaders(e){return this.headerMarshaller.format(e)}}class PM{constructor(e){f(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.inputStream)yield this.options.decoder.decode(e)}}class LM{constructor(e){f(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.messageStream)yield this.options.encoder.encode(e);this.options.includeEndFrame&&(yield new Uint8Array(0))}}class DM{constructor(e){f(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.messageStream){const r=await this.options.deserializer(e);r!==void 0&&(yield r)}}}class MM{constructor(e){f(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.inputStream)yield this.options.serializer(e)}}const UM=(t,e,r,n)=>{let s=t;const i={start(){},async transform(a,o){try{const c=new Date(Date.now()+await n()),u={":date":{type:"timestamp",value:c}},l=await e.sign({message:{body:a,headers:u},priorSignature:s},{signingDate:c});s=l.signature;const d=r.encode({headers:{...u,":chunk-signature":{type:"binary",value:ip(l.signature)}},body:a});o.enqueue(d)}catch(c){o.error(c)}}};return new TransformStream({...i})};class BM{constructor(e){f(this,"messageSigner");f(this,"eventStreamCodec");f(this,"systemClockOffsetProvider");this.messageSigner=e.messageSigner,this.eventStreamCodec=new tS(e.utf8Encoder,e.utf8Decoder),this.systemClockOffsetProvider=async()=>e.systemClockOffset??0}async handle(e,r,n={}){const s=r.request,{body:i,headers:a,query:o}=s;if(!(i instanceof ReadableStream))throw new Error("Eventstream payload must be a ReadableStream.");const c=new TransformStream;s.body=c.readable;let u;try{u=await e(r)}catch(m){throw s.body.cancel(),m}const d=((a.authorization||"").match(/Signature=([\w]+)$/)||[])[1]||o&&o["X-Amz-Signature"]||"",h=UM(d,await this.messageSigner(),this.eventStreamCodec,this.systemClockOffsetProvider);return i.pipeThrough(h).pipeThrough(c),u}}const FM=t=>new BM(t),rS=t=>t.protocol==="ws:"||t.protocol==="wss:";class jM{constructor(e){f(this,"signer");this.signer=e.signer}presign(e,r={}){return this.signer.presign(e,r)}async sign(e,r){return or.isInstance(e)&&rS(e)?{...await this.signer.presign({...e,body:""},{...r,expiresIn:60,unsignableHeaders:new Set(Object.keys(e.headers).filter(s=>s!=="host"))}),body:e.body}:this.signer.sign(e,r)}}const zM=t=>{const{signer:e}=t;return Object.assign(t,{signer:async r=>{const n=await e(r);if(VM(n))return new jM({signer:n});throw new Error("Expected WebsocketSignatureV4 signer, please check the client constructor.")}})},VM=t=>!!t;function GM(t){const{port:e,query:r}=t;let{protocol:n,path:s,hostname:i}=t;n&&n.slice(-1)!==":"&&(n+=":"),e&&(i+=`:${e}`),s&&s.charAt(0)!=="/"&&(s=`/${s}`);let a=r?TE(r):"";a&&a[0]!=="?"&&(a=`?${a}`);let o="";if(t.username!=null||t.password!=null){const u=t.username??"",l=t.password??"";o=`${u}:${l}@`}let c="";return t.fragment&&(c=`#${t.fragment}`),`${n}//${o}${i}${s}${a}${c}`}function HM(t){let e=0,r=0,n=null,s=null;const i=o=>{if(typeof o!="number")throw new Error("Attempted to allocate an event message where size was not a number: "+o);e=o,r=4,n=new Uint8Array(o),new DataView(n.buffer).setUint32(0,o,!1)},a=async function*(){const o=t[Symbol.asyncIterator]();for(;;){const{value:c,done:u}=await o.next();if(u){if(e)if(e===r)yield n;else throw new Error("Truncated event message received.");else return;return}const l=c.length;let d=0;for(;d<l;){if(!n){const p=l-d;s||(s=new Uint8Array(4));const m=Math.min(4-r,p);if(s.set(c.slice(d,d+m),r),r+=m,d+=m,r<4)break;i(new DataView(s.buffer).getUint32(0,!1)),s=null}const h=Math.min(e-r,l-d);n.set(c.slice(d,d+h),r),r+=h,d+=h,e&&e===r&&(yield n,n=null,e=0,r=0)}}};return{[Symbol.asyncIterator]:a}}function qM(t,e){return async function(r){const{value:n}=r.headers[":message-type"];if(n==="error"){const s=new Error(r.headers[":error-message"].value||"UnknownError");throw s.name=r.headers[":error-code"].value,s}else if(n==="exception"){const s=r.headers[":exception-type"].value,i={[s]:r},a=await t(i);if(a.$unknown){const o=new Error(e(r.body));throw o.name=s,o}throw a[s]}else if(n==="event"){const s={[r.headers[":event-type"].value]:r},i=await t(s);return i.$unknown?void 0:i}else throw Error(`Unrecognizable event type: ${r.headers[":event-type"].value}`)}}let WM=class{constructor({utf8Encoder:e,utf8Decoder:r}){f(this,"eventStreamCodec");f(this,"utfEncoder");this.eventStreamCodec=new tS(e,r),this.utfEncoder=e}deserialize(e,r){const n=HM(e);return new DM({messageStream:new PM({inputStream:n,decoder:this.eventStreamCodec}),deserializer:qM(r,this.utfEncoder)})}serialize(e,r){return new LM({messageStream:new MM({inputStream:e,serializer:r}),encoder:this.eventStreamCodec,includeEndFrame:!0})}};const nS=t=>({[Symbol.asyncIterator]:async function*(){const e=t.getReader();try{for(;;){const{done:r,value:n}=await e.read();if(r)return;yield n}}finally{e.releaseLock()}}}),sS=t=>{const e=t[Symbol.asyncIterator]();return new ReadableStream({async pull(r){const{done:n,value:s}=await e.next();if(n)return r.close();r.enqueue(s)}})};class JM{constructor({utf8Encoder:e,utf8Decoder:r}){f(this,"universalMarshaller");this.universalMarshaller=new WM({utf8Decoder:r,utf8Encoder:e})}deserialize(e,r){const n=ZM(e)?nS(e):e;return this.universalMarshaller.deserialize(n,r)}serialize(e,r){const n=this.universalMarshaller.serialize(e,r);return typeof ReadableStream=="function"?sS(n):n}}const ZM=t=>typeof ReadableStream=="function"&&t instanceof ReadableStream,KM=t=>new JM(t),XM=2e3;class lp{constructor(e,r=new Na){f(this,"metadata",{handlerProtocol:"websocket/h1.1"});f(this,"config");f(this,"configPromise");f(this,"httpHandler");f(this,"sockets",{});this.httpHandler=r,typeof e=="function"?(this.config={},this.configPromise=e().then(n=>this.config=n??{})):(this.config=e??{},this.configPromise=Promise.resolve(this.config))}static create(e,r=new Na){return typeof(e==null?void 0:e.handle)=="function"?e:new lp(e,r)}destroy(){for(const[e,r]of Object.entries(this.sockets)){for(const n of r)n.close(1e3,"Socket closed through destroy() call");delete this.sockets[e]}}async handle(e){if(!rS(e))return this.httpHandler.handle(e);const r=GM(e),n=new WebSocket(r);this.sockets[r]||(this.sockets[r]=[]),this.sockets[r].push(n),n.binaryType="arraybuffer",this.config=await this.configPromise;const{connectionTimeout:s=XM}=this.config;await this.waitForReady(n,s);const{body:i}=e,a=YM(i),o=this.connect(n,a),c=QM(o);return{response:new Ti({statusCode:200,body:c})}}updateHttpClientConfig(e,r){this.configPromise=this.configPromise.then(n=>(n[e]=r,n))}httpHandlerConfigs(){return this.config??{}}removeNotUsableSockets(e){this.sockets[e]=(this.sockets[e]??[]).filter(r=>![WebSocket.CLOSING,WebSocket.CLOSED].includes(r.readyState))}waitForReady(e,r){return new Promise((n,s)=>{const i=setTimeout(()=>{this.removeNotUsableSockets(e.url),s({$metadata:{httpStatusCode:500}})},r);e.onopen=()=>{clearTimeout(i),n()}})}connect(e,r){let n,s=!1,i=()=>{},a=()=>{};e.onmessage=u=>{a({done:!1,value:new Uint8Array(u.data)})},e.onerror=u=>{s=!0,e.close(),i(u)},e.onclose=()=>{this.removeNotUsableSockets(e.url),!s&&(n?i(n):a({done:!0,value:void 0}))};const o={[Symbol.asyncIterator]:()=>({next:()=>new Promise((u,l)=>{a=u,i=l})})};return(async()=>{try{for await(const u of r)e.send(u)}catch(u){n=u}finally{e.close(1e3)}})(),o}}const YM=t=>t[Symbol.asyncIterator]?t:eU(t)?nS(t):{[Symbol.asyncIterator]:async function*(){yield t}},QM=t=>typeof ReadableStream=="function"?sS(t):t,eU=t=>typeof ReadableStream=="function"&&t instanceof ReadableStream,tU=!1,rU=!1,Wy=new Set,nU=(t,e=du)=>{if(!Wy.has(t)&&!e(t))throw new Error(`Region not accepted: region="${t}" is not a valid hostname component.`);Wy.add(t)},iS=t=>typeof t=="string"&&(t.startsWith("fips-")||t.endsWith("-fips")),sU=t=>iS(t)?["fips-aws-global","aws-fips"].includes(t)?"us-east-1":t.replace(/fips-(dkr-|prod-)?|-fips/,""):t,iU=t=>{const{region:e,useFipsEndpoint:r}=t;if(!e)throw new Error("Region is missing");return Object.assign(t,{region:async()=>{const n=typeof e=="function"?await e():e,s=sU(n);return nU(s),s},useFipsEndpoint:async()=>{const n=typeof e=="string"?e:await e();return iS(n)?!0:typeof r!="function"?Promise.resolve(!!r):r()}})},aU=t=>Object.assign(t,{eventStreamMarshaller:t.eventStreamSerdeProvider(t)}),Jy="content-length";function oU(t){return e=>async r=>{const n=r.request;if(or.isInstance(n)){const{body:s,headers:i}=n;if(s&&Object.keys(i).map(a=>a.toLowerCase()).indexOf(Jy)===-1)try{const a=t(s);n.headers={...n.headers,[Jy]:String(a)}}catch{}}return e({...r,request:n})}}const cU={step:"build",tags:["SET_CONTENT_LENGTH","CONTENT_LENGTH"],name:"contentLengthMiddleware",override:!0},uU=t=>({applyToStack:e=>{e.add(oU(t.bodyLengthChecker),cU)}}),lU=async t=>{const e=(t==null?void 0:t.Bucket)||"";if(typeof t.Bucket=="string"&&(t.Bucket=e.replace(/#/g,encodeURIComponent("#")).replace(/\?/g,encodeURIComponent("?"))),mU(e)){if(t.ForcePathStyle===!0)throw new Error("Path-style addressing cannot be used with ARN buckets")}else(!pU(e)||e.indexOf(".")!==-1&&!String(t.Endpoint).startsWith("http:")||e.toLowerCase()!==e||e.length<3)&&(t.ForcePathStyle=!0);return t.DisableMultiRegionAccessPoints&&(t.disableMultiRegionAccessPoints=!0,t.DisableMRAP=!0),t},dU=/^[a-z0-9][a-z0-9\.\-]{1,61}[a-z0-9]$/,hU=/(\d+\.){3}\d+/,fU=/\.\./,pU=t=>dU.test(t)&&!hU.test(t)&&!fU.test(t),mU=t=>{const[e,r,n,,,s]=t.split(":"),i=e==="arn"&&t.split(":").length>=6,a=!!(i&&r&&n&&s);if(i&&!a)throw new Error(`Invalid ARN: ${t} was an invalid ARN.`);return a},gU=(t,e,r)=>{const n=async()=>{const s=r[t]??r[e];return typeof s=="function"?s():s};return t==="credentialScope"||e==="CredentialScope"?async()=>{const s=typeof r.credentials=="function"?await r.credentials():r.credentials;return(s==null?void 0:s.credentialScope)??(s==null?void 0:s.CredentialScope)}:t==="accountId"||e==="AccountId"?async()=>{const s=typeof r.credentials=="function"?await r.credentials():r.credentials;return(s==null?void 0:s.accountId)??(s==null?void 0:s.AccountId)}:t==="endpoint"||e==="endpoint"?async()=>{if(r.isCustomEndpoint===!1)return;const s=await n();if(s&&typeof s=="object"){if("url"in s)return s.url.href;if("hostname"in s){const{protocol:i,hostname:a,port:o,path:c}=s;return`${i}//${a}${o?":"+o:""}${c}`}}return s}:n},aS=async t=>{},oS=t=>typeof t=="object"?"url"in t?Nc(t.url):t:Nc(t),yU=async(t,e,r,n)=>{if(!r.isCustomEndpoint){let a;r.serviceConfiguredEndpoint?a=await r.serviceConfiguredEndpoint():a=await aS(r.serviceId),a&&(r.endpoint=()=>Promise.resolve(oS(a)),r.isCustomEndpoint=!0)}const s=await _U(t,e,r);if(typeof r.endpointProvider!="function")throw new Error("config.endpointProvider is not set.");return r.endpointProvider(s,n)},_U=async(t,e,r)=>{var i;const n={},s=((i=e==null?void 0:e.getEndpointParameterInstructions)==null?void 0:i.call(e))||{};for(const[a,o]of Object.entries(s))switch(o.type){case"staticContextParams":n[a]=o.value;break;case"contextParams":n[a]=t[o.name];break;case"clientContextParams":case"builtInParams":n[a]=await gU(o.name,a,r)();break;case"operationContextParams":n[a]=o.get(t);break;default:throw new Error("Unrecognized endpoint parameter instruction: "+JSON.stringify(o))}return Object.keys(s).length===0&&Object.assign(n,r),String(r.serviceId).toLowerCase()==="s3"&&await lU(n),n},wU=({config:t,instructions:e})=>(r,n)=>async s=>{var o,c,u;t.isCustomEndpoint&&AD(n,"ENDPOINT_OVERRIDE","N");const i=await yU(s.input,{getEndpointParameterInstructions(){return e}},{...t},n);n.endpointV2=i,n.authSchemes=(o=i.properties)==null?void 0:o.authSchemes;const a=(c=n.authSchemes)==null?void 0:c[0];if(a){n.signing_region=a.signingRegion,n.signing_service=a.signingName;const l=lu(n),d=(u=l==null?void 0:l.selectedHttpAuthScheme)==null?void 0:u.httpAuthOption;d&&(d.signingProperties=Object.assign(d.signingProperties||{},{signing_region:a.signingRegion,signingRegion:a.signingRegion,signing_service:a.signingName,signingName:a.signingName,signingRegionSet:a.signingRegionSet},a.properties))}return r({...s})},vU={step:"serialize",tags:["ENDPOINT_PARAMETERS","ENDPOINT_V2","ENDPOINT"],name:"endpointV2Middleware",override:!0,relation:"before",toMiddleware:bE.name},cS=(t,e)=>({applyToStack:r=>{r.addRelativeTo(wU({config:t,instructions:e}),vU)}}),bU=t=>{const e=t.tls??!0,{endpoint:r,useDualstackEndpoint:n,useFipsEndpoint:s}=t,i=r!=null?async()=>oS(await In(r)()):void 0,o=Object.assign(t,{endpoint:i,tls:e,isCustomEndpoint:!!r,useDualstackEndpoint:In(n??!1),useFipsEndpoint:In(s??!1)});let c;return o.serviceConfiguredEndpoint=async()=>(t.serviceId&&!c&&(c=aS(t.serviceId)),c),o};var Ci;(function(t){t.STANDARD="standard",t.ADAPTIVE="adaptive"})(Ci||(Ci={}));const Pc=3,EU=Ci.STANDARD,SU=["BandwidthLimitExceeded","EC2ThrottledException","LimitExceededException","PriorRequestNotComplete","ProvisionedThroughputExceededException","RequestLimitExceeded","RequestThrottled","RequestThrottledException","SlowDown","ThrottledException","Throttling","ThrottlingException","TooManyRequestsException","TransactionInProgressException"],xU=["TimeoutError","RequestTimeout","RequestTimeoutException"],TU=[500,502,503,504],AU=["ECONNRESET","ECONNREFUSED","EPIPE","ETIMEDOUT"],CU=["EHOSTUNREACH","ENETUNREACH","ENOTFOUND"],kU=t=>(t==null?void 0:t.$retryable)!==void 0,IU=t=>{var e;return(e=t.$metadata)==null?void 0:e.clockSkewCorrected},RU=t=>{const e=new Set(["Failed to fetch","NetworkError when attempting to fetch resource","The Internet connection appears to be offline","Load failed","Network request failed"]);return t&&t instanceof TypeError?e.has(t.message):!1},uS=t=>{var e,r;return((e=t.$metadata)==null?void 0:e.httpStatusCode)===429||SU.includes(t.name)||((r=t.$retryable)==null?void 0:r.throttling)==!0},dp=(t,e=0)=>{var r;return kU(t)||IU(t)||xU.includes(t.name)||AU.includes((t==null?void 0:t.code)||"")||CU.includes((t==null?void 0:t.code)||"")||TU.includes(((r=t.$metadata)==null?void 0:r.httpStatusCode)||0)||RU(t)||t.cause!==void 0&&e<=10&&dp(t.cause,e+1)},OU=t=>{var e;if(((e=t.$metadata)==null?void 0:e.httpStatusCode)!==void 0){const r=t.$metadata.httpStatusCode;return 500<=r&&r<=599&&!dp(t)}return!1},Lc=class Lc{constructor(e){f(this,"beta");f(this,"minCapacity");f(this,"minFillRate");f(this,"scaleConstant");f(this,"smooth");f(this,"currentCapacity",0);f(this,"enabled",!1);f(this,"lastMaxRate",0);f(this,"measuredTxRate",0);f(this,"requestCount",0);f(this,"fillRate");f(this,"lastThrottleTime");f(this,"lastTimestamp",0);f(this,"lastTxRateBucket");f(this,"maxCapacity");f(this,"timeWindow",0);this.beta=(e==null?void 0:e.beta)??.7,this.minCapacity=(e==null?void 0:e.minCapacity)??1,this.minFillRate=(e==null?void 0:e.minFillRate)??.5,this.scaleConstant=(e==null?void 0:e.scaleConstant)??.4,this.smooth=(e==null?void 0:e.smooth)??.8;const r=this.getCurrentTimeInSeconds();this.lastThrottleTime=r,this.lastTxRateBucket=Math.floor(this.getCurrentTimeInSeconds()),this.fillRate=this.minFillRate,this.maxCapacity=this.minCapacity}getCurrentTimeInSeconds(){return Date.now()/1e3}async getSendToken(){return this.acquireTokenBucket(1)}async acquireTokenBucket(e){if(this.enabled){if(this.refillTokenBucket(),e>this.currentCapacity){const r=(e-this.currentCapacity)/this.fillRate*1e3;await new Promise(n=>Lc.setTimeoutFn(n,r))}this.currentCapacity=this.currentCapacity-e}}refillTokenBucket(){const e=this.getCurrentTimeInSeconds();if(!this.lastTimestamp){this.lastTimestamp=e;return}const r=(e-this.lastTimestamp)*this.fillRate;this.currentCapacity=Math.min(this.maxCapacity,this.currentCapacity+r),this.lastTimestamp=e}updateClientSendingRate(e){let r;if(this.updateMeasuredRate(),uS(e)){const s=this.enabled?Math.min(this.measuredTxRate,this.fillRate):this.measuredTxRate;this.lastMaxRate=s,this.calculateTimeWindow(),this.lastThrottleTime=this.getCurrentTimeInSeconds(),r=this.cubicThrottle(s),this.enableTokenBucket()}else this.calculateTimeWindow(),r=this.cubicSuccess(this.getCurrentTimeInSeconds());const n=Math.min(r,2*this.measuredTxRate);this.updateTokenBucketRate(n)}calculateTimeWindow(){this.timeWindow=this.getPrecise(Math.pow(this.lastMaxRate*(1-this.beta)/this.scaleConstant,1/3))}cubicThrottle(e){return this.getPrecise(e*this.beta)}cubicSuccess(e){return this.getPrecise(this.scaleConstant*Math.pow(e-this.lastThrottleTime-this.timeWindow,3)+this.lastMaxRate)}enableTokenBucket(){this.enabled=!0}updateTokenBucketRate(e){this.refillTokenBucket(),this.fillRate=Math.max(e,this.minFillRate),this.maxCapacity=Math.max(e,this.minCapacity),this.currentCapacity=Math.min(this.currentCapacity,this.maxCapacity)}updateMeasuredRate(){const e=this.getCurrentTimeInSeconds(),r=Math.floor(e*2)/2;if(this.requestCount++,r>this.lastTxRateBucket){const n=this.requestCount/(r-this.lastTxRateBucket);this.measuredTxRate=this.getPrecise(n*this.smooth+this.measuredTxRate*(1-this.smooth)),this.requestCount=0,this.lastTxRateBucket=r}}getPrecise(e){return parseFloat(e.toFixed(8))}};f(Lc,"setTimeoutFn",setTimeout);let Ah=Lc;const Ch=100,lS=20*1e3,NU=500,Zy=500,$U=5,PU=10,LU=1,DU="amz-sdk-invocation-id",MU="amz-sdk-request",UU=()=>{let t=Ch;return{computeNextBackoffDelay:n=>Math.floor(Math.min(lS,Math.random()*2**n*t)),setDelayBase:n=>{t=n}}},Ky=({retryDelay:t,retryCount:e,retryCost:r})=>({getRetryCount:()=>e,getRetryDelay:()=>Math.min(lS,t),getRetryCost:()=>r});class dS{constructor(e){f(this,"maxAttempts");f(this,"mode",Ci.STANDARD);f(this,"capacity",Zy);f(this,"retryBackoffStrategy",UU());f(this,"maxAttemptsProvider");this.maxAttempts=e,this.maxAttemptsProvider=typeof e=="function"?e:async()=>e}async acquireInitialRetryToken(e){return Ky({retryDelay:Ch,retryCount:0})}async refreshRetryTokenForRetry(e,r){const n=await this.getMaxAttempts();if(this.shouldRetry(e,r,n)){const s=r.errorType;this.retryBackoffStrategy.setDelayBase(s==="THROTTLING"?NU:Ch);const i=this.retryBackoffStrategy.computeNextBackoffDelay(e.getRetryCount()),a=r.retryAfterHint?Math.max(r.retryAfterHint.getTime()-Date.now()||0,i):i,o=this.getCapacityCost(s);return this.capacity-=o,Ky({retryDelay:a,retryCount:e.getRetryCount()+1,retryCost:o})}throw new Error("No retry token available")}recordSuccess(e){this.capacity=Math.max(Zy,this.capacity+(e.getRetryCost()??LU))}getCapacity(){return this.capacity}async getMaxAttempts(){try{return await this.maxAttemptsProvider()}catch{return console.warn(`Max attempts provider could not resolve. Using default of ${Pc}`),Pc}}shouldRetry(e,r,n){return e.getRetryCount()+1<n&&this.capacity>=this.getCapacityCost(r.errorType)&&this.isRetryableError(r.errorType)}getCapacityCost(e){return e==="TRANSIENT"?PU:$U}isRetryableError(e){return e==="THROTTLING"||e==="TRANSIENT"}}class BU{constructor(e,r){f(this,"maxAttemptsProvider");f(this,"rateLimiter");f(this,"standardRetryStrategy");f(this,"mode",Ci.ADAPTIVE);this.maxAttemptsProvider=e;const{rateLimiter:n}=r??{};this.rateLimiter=n??new Ah,this.standardRetryStrategy=new dS(e)}async acquireInitialRetryToken(e){return await this.rateLimiter.getSendToken(),this.standardRetryStrategy.acquireInitialRetryToken(e)}async refreshRetryTokenForRetry(e,r){return this.rateLimiter.updateClientSendingRate(r),this.standardRetryStrategy.refreshRetryTokenForRetry(e,r)}recordSuccess(e){this.rateLimiter.updateClientSendingRate({}),this.standardRetryStrategy.recordSuccess(e)}}const FU=t=>t instanceof Error?t:t instanceof Object?Object.assign(new Error,t):typeof t=="string"?new Error(t):new Error(`AWS SDK error wrapper for ${t}`),jU=t=>{const{retryStrategy:e,retryMode:r,maxAttempts:n}=t,s=In(n??Pc);return Object.assign(t,{maxAttempts:s,retryStrategy:async()=>e||(await In(r)()===Ci.ADAPTIVE?new BU(s):new dS(s))})},zU=t=>(t==null?void 0:t.body)instanceof ReadableStream,VU=t=>(e,r)=>async n=>{var a;let s=await t.retryStrategy();const i=await t.maxAttempts();if(GU(s)){s=s;let o=await s.acquireInitialRetryToken(r.partition_id),c=new Error,u=0,l=0;const{request:d}=n,h=or.isInstance(d);for(h&&(d.headers[DU]=SD());;)try{h&&(d.headers[MU]=`attempt=${u+1}; max=${i}`);const{response:p,output:m}=await e(n);return s.recordSuccess(o),m.$metadata.attempts=u+1,m.$metadata.totalRetryDelay=l,{response:p,output:m}}catch(p){const m=HU(p);if(c=FU(p),h&&zU(d))throw(a=r.logger instanceof XE?console:r.logger)==null||a.warn("An error was encountered in a non-retryable streaming request."),c;try{o=await s.refreshRetryTokenForRetry(o,m)}catch{throw c.$metadata||(c.$metadata={}),c.$metadata.attempts=u+1,c.$metadata.totalRetryDelay=l,c}u=o.getRetryCount();const _=o.getRetryDelay();l+=_,await new Promise(v=>setTimeout(v,_))}}else return s=s,s!=null&&s.mode&&(r.userAgent=[...r.userAgent||[],["cfg/retry-mode",s.mode]]),s.retry(e,n)},GU=t=>typeof t.acquireInitialRetryToken<"u"&&typeof t.refreshRetryTokenForRetry<"u"&&typeof t.recordSuccess<"u",HU=t=>{const e={error:t,errorType:qU(t)},r=ZU(t.$response);return r&&(e.retryAfterHint=r),e},qU=t=>uS(t)?"THROTTLING":dp(t)?"TRANSIENT":OU(t)?"SERVER_ERROR":"CLIENT_ERROR",WU={name:"retryMiddleware",tags:["RETRY"],step:"finalizeRequest",priority:"high",override:!0},JU=t=>({applyToStack:e=>{e.add(VU(t),WU)}}),ZU=t=>{if(!Ti.isInstance(t))return;const e=Object.keys(t.headers).find(i=>i.toLowerCase()==="retry-after");if(!e)return;const r=t.headers[e],n=Number(r);return Number.isNaN(n)?new Date(r):new Date(n*1e3)},KU=async(t,e,r)=>({operation:lu(e).operation,region:await In(t.region)()||(()=>{throw new Error("expected `region` to be configured for `aws.auth#sigv4`")})()});function XU(t){return{schemeId:"aws.auth#sigv4",signingProperties:{name:"bedrock",region:t.region},propertiesExtractor:(e,r)=>({signingProperties:{config:e,context:r}})}}function YU(t){return{schemeId:"smithy.api#httpBearerAuth",propertiesExtractor:({profile:e,filepath:r,configFilepath:n,ignoreCache:s},i)=>({identityProperties:{profile:e,filepath:r,configFilepath:n,ignoreCache:s}})}}const QU=t=>{const e=[];switch(t.operation){default:e.push(XU(t)),e.push(YU())}return e},eB=t=>{const e=RE(t.token,IE,op),r=U4(t);return Object.assign(r,{authSchemePreference:In(t.authSchemePreference??[]),token:e})},tB=t=>Object.assign(t,{useDualstackEndpoint:t.useDualstackEndpoint??!1,useFipsEndpoint:t.useFipsEndpoint??!1,defaultSigningName:"bedrock"}),hS={UseFIPS:{type:"builtInParams",name:"useFipsEndpoint"},Endpoint:{type:"builtInParams",name:"endpoint"},Region:{type:"builtInParams",name:"region"},UseDualStack:{type:"builtInParams",name:"useDualstackEndpoint"}},rB="3.917.0",nB={version:rB};var fS={name:"SHA-256"},Xy={name:"HMAC",hash:fS},sB=new Uint8Array([227,176,196,66,152,252,28,20,154,251,244,200,153,111,185,36,39,174,65,228,100,155,147,76,164,149,153,27,120,82,184,85]);const iB={};function Ko(){return typeof window<"u"?window:typeof self<"u"?self:iB}var aB=(function(){function t(e){this.toHash=new Uint8Array(0),this.secret=e,this.reset()}return t.prototype.update=function(e){if(!Th(e)){var r=La(e),n=new Uint8Array(this.toHash.byteLength+r.byteLength);n.set(this.toHash,0),n.set(r,this.toHash.byteLength),this.toHash=n}},t.prototype.digest=function(){var e=this;return this.key?this.key.then(function(r){return Ko().crypto.subtle.sign(Xy,r,e.toHash).then(function(n){return new Uint8Array(n)})}):Th(this.toHash)?Promise.resolve(sB):Promise.resolve().then(function(){return Ko().crypto.subtle.digest(fS,e.toHash)}).then(function(r){return Promise.resolve(new Uint8Array(r))})},t.prototype.reset=function(){var e=this;this.toHash=new Uint8Array(0),this.secret&&this.secret!==void 0&&(this.key=new Promise(function(r,n){Ko().crypto.subtle.importKey("raw",La(e.secret),Xy,!1,["sign"]).then(r,n)}),this.key.catch(function(){}))},t})(),Sr=64,oB=32,cB=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),uB=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],lB=Math.pow(2,53)-1,Xo=(function(){function t(){this.state=Int32Array.from(uB),this.temp=new Int32Array(64),this.buffer=new Uint8Array(64),this.bufferLength=0,this.bytesHashed=0,this.finished=!1}return t.prototype.update=function(e){if(this.finished)throw new Error("Attempted to update an already finished hash.");var r=0,n=e.byteLength;if(this.bytesHashed+=n,this.bytesHashed*8>lB)throw new Error("Cannot hash more than 2^53 - 1 bits");for(;n>0;)this.buffer[this.bufferLength++]=e[r++],n--,this.bufferLength===Sr&&(this.hashBuffer(),this.bufferLength=0)},t.prototype.digest=function(){if(!this.finished){var e=this.bytesHashed*8,r=new DataView(this.buffer.buffer,this.buffer.byteOffset,this.buffer.byteLength),n=this.bufferLength;if(r.setUint8(this.bufferLength++,128),n%Sr>=Sr-8){for(var s=this.bufferLength;s<Sr;s++)r.setUint8(s,0);this.hashBuffer(),this.bufferLength=0}for(var s=this.bufferLength;s<Sr-8;s++)r.setUint8(s,0);r.setUint32(Sr-8,Math.floor(e/4294967296),!0),r.setUint32(Sr-4,e),this.hashBuffer(),this.finished=!0}for(var i=new Uint8Array(oB),s=0;s<8;s++)i[s*4]=this.state[s]>>>24&255,i[s*4+1]=this.state[s]>>>16&255,i[s*4+2]=this.state[s]>>>8&255,i[s*4+3]=this.state[s]>>>0&255;return i},t.prototype.hashBuffer=function(){for(var e=this,r=e.buffer,n=e.state,s=n[0],i=n[1],a=n[2],o=n[3],c=n[4],u=n[5],l=n[6],d=n[7],h=0;h<Sr;h++){if(h<16)this.temp[h]=(r[h*4]&255)<<24|(r[h*4+1]&255)<<16|(r[h*4+2]&255)<<8|r[h*4+3]&255;else{var p=this.temp[h-2],m=(p>>>17|p<<15)^(p>>>19|p<<13)^p>>>10;p=this.temp[h-15];var _=(p>>>7|p<<25)^(p>>>18|p<<14)^p>>>3;this.temp[h]=(m+this.temp[h-7]|0)+(_+this.temp[h-16]|0)}var v=(((c>>>6|c<<26)^(c>>>11|c<<21)^(c>>>25|c<<7))+(c&u^~c&l)|0)+(d+(cB[h]+this.temp[h]|0)|0)|0,y=((s>>>2|s<<30)^(s>>>13|s<<19)^(s>>>22|s<<10))+(s&i^s&a^i&a)|0;d=l,l=u,u=c,c=o+v|0,o=a,a=i,i=s,s=v+y|0}n[0]+=s,n[1]+=i,n[2]+=a,n[3]+=o,n[4]+=c,n[5]+=u,n[6]+=l,n[7]+=d},t})(),dB=(function(){function t(e){this.secret=e,this.hash=new Xo,this.reset()}return t.prototype.update=function(e){if(!(Th(e)||this.error))try{this.hash.update(La(e))}catch(r){this.error=r}},t.prototype.digestSync=function(){if(this.error)throw this.error;return this.outer?(this.outer.finished||this.outer.update(this.hash.digest()),this.outer.digest()):this.hash.digest()},t.prototype.digest=function(){return pM(this,void 0,void 0,function(){return mM(this,function(e){return[2,this.digestSync()]})})},t.prototype.reset=function(){if(this.hash=new Xo,this.secret){this.outer=new Xo;var e=hB(this.secret),r=new Uint8Array(Sr);r.set(e);for(var n=0;n<Sr;n++)e[n]^=54,r[n]^=92;this.hash.update(e),this.outer.update(r);for(var n=0;n<e.byteLength;n++)e[n]=0}},t})();function hB(t){var e=La(t);if(e.byteLength>Sr){var r=new Xo;r.update(e),e=r.digest()}var n=new Uint8Array(Sr);return n.set(e),n}var fB=["decrypt","digest","encrypt","exportKey","generateKey","importKey","sign","verify"];function pB(t){if(mB(t)&&typeof t.crypto.subtle=="object"){var e=t.crypto.subtle;return gB(e)}return!1}function mB(t){if(typeof t=="object"&&typeof t.crypto=="object"){var e=t.crypto.getRandomValues;return typeof e=="function"}return!1}function gB(t){return t&&fB.every(function(e){return typeof t[e]=="function"})}var yB=(function(){function t(e){pB(Ko())?this.hash=new aB(e):this.hash=new dB(e)}return t.prototype.update=function(e,r){this.hash.update(La(e))},t.prototype.digest=function(){return this.hash.digest()},t.prototype.reset=function(){this.hash.reset()},t})();const _B=({serviceId:t,clientVersion:e})=>async r=>{var p,m,_;const n=typeof window<"u"?window.navigator:void 0,s=(n==null?void 0:n.userAgent)??"",i=((p=n==null?void 0:n.userAgentData)==null?void 0:p.platform)??Yy.os(s)??"other",a=void 0,o=((m=n==null?void 0:n.userAgentData)==null?void 0:m.brands)??[],c=o[o.length-1],u=(c==null?void 0:c.brand)??Yy.browser(s)??"unknown",l=(c==null?void 0:c.version)??"unknown",d=[["aws-sdk-js",e],["ua","2.1"],[`os/${i}`,a],["lang/js"],["md/browser",`${u}_${l}`]];t&&d.push([`api/${t}`,e]);const h=await((_=r==null?void 0:r.userAgentAppId)==null?void 0:_.call(r));return h&&d.push([`app/${h}`]),d},Yy={os(t){if(/iPhone|iPad|iPod/.test(t))return"iOS";if(/Macintosh|Mac OS X/.test(t))return"macOS";if(/Windows NT/.test(t))return"Windows";if(/Android/.test(t))return"Android";if(/Linux/.test(t))return"Linux"},browser(t){if(/EdgiOS|EdgA|Edg\//.test(t))return"Microsoft Edge";if(/Firefox\//.test(t))return"Firefox";if(/Chrome\//.test(t))return"Chrome";if(/Safari\//.test(t))return"Safari"}},wB=t=>()=>Promise.reject(t),pS="required",nn="fn",sn="argv",Di="ref",Qy=!0,e_="isSet",Da="booleanEquals",Ws="error",zi="endpoint",zt="tree",hp="PartitionResult",t_={[pS]:!1,type:"String"},r_={[pS]:!0,default:!1,type:"Boolean"},n_={[Di]:"Endpoint"},mS={[nn]:Da,[sn]:[{[Di]:"UseFIPS"},!0]},gS={[nn]:Da,[sn]:[{[Di]:"UseDualStack"},!0]},Xr={},s_={[nn]:"getAttr",[sn]:[{[Di]:hp},"supportsFIPS"]},i_={[nn]:Da,[sn]:[!0,{[nn]:"getAttr",[sn]:[{[Di]:hp},"supportsDualStack"]}]},a_=[mS],o_=[gS],c_=[{[Di]:"Region"}],vB={parameters:{Region:t_,UseDualStack:r_,UseFIPS:r_,Endpoint:t_},rules:[{conditions:[{[nn]:e_,[sn]:[n_]}],rules:[{conditions:a_,error:"Invalid Configuration: FIPS and custom endpoint are not supported",type:Ws},{rules:[{conditions:o_,error:"Invalid Configuration: Dualstack and custom endpoint are not supported",type:Ws},{endpoint:{url:n_,properties:Xr,headers:Xr},type:zi}],type:zt}],type:zt},{rules:[{conditions:[{[nn]:e_,[sn]:c_}],rules:[{conditions:[{[nn]:"aws.partition",[sn]:c_,assign:hp}],rules:[{conditions:[mS,gS],rules:[{conditions:[{[nn]:Da,[sn]:[Qy,s_]},i_],rules:[{rules:[{endpoint:{url:"https://bedrock-runtime-fips.{Region}.{PartitionResult#dualStackDnsSuffix}",properties:Xr,headers:Xr},type:zi}],type:zt}],type:zt},{error:"FIPS and DualStack are enabled, but this partition does not support one or both",type:Ws}],type:zt},{conditions:a_,rules:[{conditions:[{[nn]:Da,[sn]:[s_,Qy]}],rules:[{rules:[{endpoint:{url:"https://bedrock-runtime-fips.{Region}.{PartitionResult#dnsSuffix}",properties:Xr,headers:Xr},type:zi}],type:zt}],type:zt},{error:"FIPS is enabled but this partition does not support FIPS",type:Ws}],type:zt},{conditions:o_,rules:[{conditions:[i_],rules:[{rules:[{endpoint:{url:"https://bedrock-runtime.{Region}.{PartitionResult#dualStackDnsSuffix}",properties:Xr,headers:Xr},type:zi}],type:zt}],type:zt},{error:"DualStack is enabled but this partition does not support DualStack",type:Ws}],type:zt},{rules:[{endpoint:{url:"https://bedrock-runtime.{Region}.{PartitionResult#dnsSuffix}",properties:Xr,headers:Xr},type:zi}],type:zt}],type:zt}],type:zt},{error:"Invalid Configuration: Missing Region",type:Ws}],type:zt}]},bB=vB,EB=new PD({size:50,params:["Endpoint","Region","UseDualStack","UseFIPS"]}),SB=(t,e={})=>EB.get(t,()=>QD(bB,{endpointParams:t,logger:e.logger}));Oc.aws=zE;const xB=t=>({apiVersion:"2023-09-30",base64Decoder:(t==null?void 0:t.base64Decoder)??np,base64Encoder:(t==null?void 0:t.base64Encoder)??xE,disableHostPrefix:(t==null?void 0:t.disableHostPrefix)??!1,endpointProvider:(t==null?void 0:t.endpointProvider)??SB,extensions:(t==null?void 0:t.extensions)??[],httpAuthSchemeProvider:(t==null?void 0:t.httpAuthSchemeProvider)??QU,httpAuthSchemes:(t==null?void 0:t.httpAuthSchemes)??[{schemeId:"aws.auth#sigv4",identityProvider:e=>e.getIdentityProvider("aws.auth#sigv4"),signer:new l4},{schemeId:"smithy.api#httpBearerAuth",identityProvider:e=>e.getIdentityProvider("smithy.api#httpBearerAuth"),signer:new kD}],logger:(t==null?void 0:t.logger)??new XE,serviceId:(t==null?void 0:t.serviceId)??"Bedrock Runtime",urlParser:(t==null?void 0:t.urlParser)??Nc,utf8Decoder:(t==null?void 0:t.utf8Decoder)??Ai,utf8Encoder:(t==null?void 0:t.utf8Encoder)??sp}),TB=["in-region","cross-region","mobile","standard","legacy"],AB=({defaultsMode:t}={})=>d4(async()=>{const e=typeof t=="function"?await t():t;switch(e==null?void 0:e.toLowerCase()){case"auto":return Promise.resolve(CB()?"mobile":"standard");case"mobile":case"in-region":case"cross-region":case"standard":case"legacy":return Promise.resolve(e==null?void 0:e.toLocaleLowerCase());case void 0:return Promise.resolve("legacy");default:throw new Error(`Invalid parameter for "defaultsMode", expect ${TB.join(", ")}, got ${e}`)}}),CB=()=>{var e;const t=window==null?void 0:window.navigator;if(t!=null&&t.connection){const{effectiveType:r,rtt:n,downlink:s}=t==null?void 0:t.connection;if(typeof r=="string"&&r!=="4g"||Number(n)>100||Number(s)<10)return!0}return((e=t==null?void 0:t.userAgentData)==null?void 0:e.mobile)||typeof(t==null?void 0:t.maxTouchPoints)=="number"&&(t==null?void 0:t.maxTouchPoints)>1},kB=t=>{const e=AB(t),r=()=>e().then(W4),n=xB(t);return{...n,...t,runtime:"browser",defaultsMode:e,bodyLengthChecker:(t==null?void 0:t.bodyLengthChecker)??j4,credentialDefaultProvider:(t==null?void 0:t.credentialDefaultProvider)??(s=>()=>Promise.reject(new Error("Credential is missing"))),defaultUserAgentProvider:(t==null?void 0:t.defaultUserAgentProvider)??_B({serviceId:n.serviceId,clientVersion:nB.version}),eventStreamPayloadHandlerProvider:(t==null?void 0:t.eventStreamPayloadHandlerProvider)??FM,eventStreamSerdeProvider:(t==null?void 0:t.eventStreamSerdeProvider)??KM,maxAttempts:(t==null?void 0:t.maxAttempts)??Pc,region:(t==null?void 0:t.region)??wB("Region is missing"),requestHandler:lp.create((t==null?void 0:t.requestHandler)??r,Na.create(r)),retryMode:(t==null?void 0:t.retryMode)??(async()=>(await r()).retryMode||EU),sha256:(t==null?void 0:t.sha256)??yB,streamCollector:(t==null?void 0:t.streamCollector)??uD,useDualstackEndpoint:(t==null?void 0:t.useDualstackEndpoint)??(()=>Promise.resolve(tU)),useFipsEndpoint:(t==null?void 0:t.useFipsEndpoint)??(()=>Promise.resolve(rU))}},IB=t=>({setRegion(e){t.region=e},region(){return t.region}}),RB=t=>({region:t.region()}),OB=t=>{const e=t.httpAuthSchemes;let r=t.httpAuthSchemeProvider,n=t.credentials,s=t.token;return{setHttpAuthScheme(i){const a=e.findIndex(o=>o.schemeId===i.schemeId);a===-1?e.push(i):e.splice(a,1,i)},httpAuthSchemes(){return e},setHttpAuthSchemeProvider(i){r=i},httpAuthSchemeProvider(){return r},setCredentials(i){n=i},credentials(){return n},setToken(i){s=i},token(){return s}}},NB=t=>({httpAuthSchemes:t.httpAuthSchemes(),httpAuthSchemeProvider:t.httpAuthSchemeProvider(),credentials:t.credentials(),token:t.token()}),$B=(t,e)=>{const r=Object.assign(IB(t),Y4(t),PL(t),OB(t));return e.forEach(n=>n.configure(r)),Object.assign(t,RB(r),Q4(r),LL(r),NB(r))};class PB extends z4{constructor(...[r]){const n=kB(r||{});super(n);f(this,"config");this.initConfig=n;const s=tB(n),i=$D(s),a=jU(i),o=iU(a),c=o,u=bU(c),l=aU(u),d=eB(l),h=$L(d),p=zM(h),m=$B(p,(r==null?void 0:r.extensions)||[]);this.config=m,this.middlewareStack.use(fM(this.config)),this.middlewareStack.use(JU(this.config)),this.middlewareStack.use(uU(this.config)),this.middlewareStack.use(BL(this.config)),this.middlewareStack.use(zL(this.config)),this.middlewareStack.use(HL(this.config)),this.middlewareStack.use(KL(this.config,{httpAuthSchemeParametersProvider:KU,identityProviderConfigProvider:async _=>new CD({"aws.auth#sigv4":_.credentials,"smithy.api#httpBearerAuth":_.token})})),this.middlewareStack.use(sD(this.config))}destroy(){super.destroy()}}class Zt extends ii{constructor(e){super(e),Object.setPrototypeOf(this,Zt.prototype)}}class fp extends Zt{constructor(r){super({name:"AccessDeniedException",$fault:"client",...r});f(this,"name","AccessDeniedException");f(this,"$fault","client");Object.setPrototypeOf(this,fp.prototype)}}var u_;(function(t){t.visit=(e,r)=>e.s3OutputDataConfig!==void 0?r.s3OutputDataConfig(e.s3OutputDataConfig):r._(e.$unknown[0],e.$unknown[1])})(u_||(u_={}));class pp extends Zt{constructor(r){super({name:"InternalServerException",$fault:"server",...r});f(this,"name","InternalServerException");f(this,"$fault","server");Object.setPrototypeOf(this,pp.prototype)}}class mp extends Zt{constructor(r){super({name:"ThrottlingException",$fault:"client",...r});f(this,"name","ThrottlingException");f(this,"$fault","client");Object.setPrototypeOf(this,mp.prototype)}}class gp extends Zt{constructor(r){super({name:"ValidationException",$fault:"client",...r});f(this,"name","ValidationException");f(this,"$fault","client");Object.setPrototypeOf(this,gp.prototype)}}class yp extends Zt{constructor(r){super({name:"ConflictException",$fault:"client",...r});f(this,"name","ConflictException");f(this,"$fault","client");Object.setPrototypeOf(this,yp.prototype)}}class _p extends Zt{constructor(r){super({name:"ResourceNotFoundException",$fault:"client",...r});f(this,"name","ResourceNotFoundException");f(this,"$fault","client");Object.setPrototypeOf(this,_p.prototype)}}class wp extends Zt{constructor(r){super({name:"ServiceQuotaExceededException",$fault:"client",...r});f(this,"name","ServiceQuotaExceededException");f(this,"$fault","client");Object.setPrototypeOf(this,wp.prototype)}}class vp extends Zt{constructor(r){super({name:"ServiceUnavailableException",$fault:"server",...r});f(this,"name","ServiceUnavailableException");f(this,"$fault","server");Object.setPrototypeOf(this,vp.prototype)}}var l_;(function(t){t.visit=(e,r)=>e.bytes!==void 0?r.bytes(e.bytes):r._(e.$unknown[0],e.$unknown[1])})(l_||(l_={}));var d_;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.image!==void 0?r.image(e.image):r._(e.$unknown[0],e.$unknown[1])})(d_||(d_={}));var h_;(function(t){t.visit=(e,r)=>e.valid!==void 0?r.valid(e.valid):e.invalid!==void 0?r.invalid(e.invalid):e.satisfiable!==void 0?r.satisfiable(e.satisfiable):e.impossible!==void 0?r.impossible(e.impossible):e.translationAmbiguous!==void 0?r.translationAmbiguous(e.translationAmbiguous):e.tooComplex!==void 0?r.tooComplex(e.tooComplex):e.noTranslations!==void 0?r.noTranslations(e.noTranslations):r._(e.$unknown[0],e.$unknown[1])})(h_||(h_={}));var f_;(function(t){t.visit=(e,r)=>e.documentChar!==void 0?r.documentChar(e.documentChar):e.documentPage!==void 0?r.documentPage(e.documentPage):e.documentChunk!==void 0?r.documentChunk(e.documentChunk):r._(e.$unknown[0],e.$unknown[1])})(f_||(f_={}));var p_;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):r._(e.$unknown[0],e.$unknown[1])})(p_||(p_={}));var m_;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):r._(e.$unknown[0],e.$unknown[1])})(m_||(m_={}));var g_;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):r._(e.$unknown[0],e.$unknown[1])})(g_||(g_={}));var kh;(function(t){t.visit=(e,r)=>e.bytes!==void 0?r.bytes(e.bytes):e.s3Location!==void 0?r.s3Location(e.s3Location):e.text!==void 0?r.text(e.text):e.content!==void 0?r.content(e.content):r._(e.$unknown[0],e.$unknown[1])})(kh||(kh={}));var Ih;(function(t){t.visit=(e,r)=>e.bytes!==void 0?r.bytes(e.bytes):r._(e.$unknown[0],e.$unknown[1])})(Ih||(Ih={}));var Rh;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.image!==void 0?r.image(e.image):r._(e.$unknown[0],e.$unknown[1])})(Rh||(Rh={}));var Oh;(function(t){t.visit=(e,r)=>e.bytes!==void 0?r.bytes(e.bytes):e.s3Location!==void 0?r.s3Location(e.s3Location):r._(e.$unknown[0],e.$unknown[1])})(Oh||(Oh={}));var Nh;(function(t){t.visit=(e,r)=>e.reasoningText!==void 0?r.reasoningText(e.reasoningText):e.redactedContent!==void 0?r.redactedContent(e.redactedContent):r._(e.$unknown[0],e.$unknown[1])})(Nh||(Nh={}));var $h;(function(t){t.visit=(e,r)=>e.bytes!==void 0?r.bytes(e.bytes):e.s3Location!==void 0?r.s3Location(e.s3Location):r._(e.$unknown[0],e.$unknown[1])})($h||($h={}));var Ph;(function(t){t.visit=(e,r)=>e.json!==void 0?r.json(e.json):e.text!==void 0?r.text(e.text):e.image!==void 0?r.image(e.image):e.document!==void 0?r.document(e.document):e.video!==void 0?r.video(e.video):r._(e.$unknown[0],e.$unknown[1])})(Ph||(Ph={}));var Lh;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.image!==void 0?r.image(e.image):e.document!==void 0?r.document(e.document):e.video!==void 0?r.video(e.video):e.toolUse!==void 0?r.toolUse(e.toolUse):e.toolResult!==void 0?r.toolResult(e.toolResult):e.guardContent!==void 0?r.guardContent(e.guardContent):e.cachePoint!==void 0?r.cachePoint(e.cachePoint):e.reasoningContent!==void 0?r.reasoningContent(e.reasoningContent):e.citationsContent!==void 0?r.citationsContent(e.citationsContent):r._(e.$unknown[0],e.$unknown[1])})(Lh||(Lh={}));var y_;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):r._(e.$unknown[0],e.$unknown[1])})(y_||(y_={}));var Dh;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.guardContent!==void 0?r.guardContent(e.guardContent):e.cachePoint!==void 0?r.cachePoint(e.cachePoint):r._(e.$unknown[0],e.$unknown[1])})(Dh||(Dh={}));var __;(function(t){t.visit=(e,r)=>e.auto!==void 0?r.auto(e.auto):e.any!==void 0?r.any(e.any):e.tool!==void 0?r.tool(e.tool):r._(e.$unknown[0],e.$unknown[1])})(__||(__={}));var Mh;(function(t){t.visit=(e,r)=>e.json!==void 0?r.json(e.json):r._(e.$unknown[0],e.$unknown[1])})(Mh||(Mh={}));var Uh;(function(t){t.visit=(e,r)=>e.toolSpec!==void 0?r.toolSpec(e.toolSpec):e.cachePoint!==void 0?r.cachePoint(e.cachePoint):r._(e.$unknown[0],e.$unknown[1])})(Uh||(Uh={}));var w_;(function(t){t.visit=(e,r)=>e.message!==void 0?r.message(e.message):r._(e.$unknown[0],e.$unknown[1])})(w_||(w_={}));class bp extends Zt{constructor(r){super({name:"ModelErrorException",$fault:"client",...r});f(this,"name","ModelErrorException");f(this,"$fault","client");f(this,"originalStatusCode");f(this,"resourceName");Object.setPrototypeOf(this,bp.prototype),this.originalStatusCode=r.originalStatusCode,this.resourceName=r.resourceName}}class Ep extends Zt{constructor(r){super({name:"ModelNotReadyException",$fault:"client",...r});f(this,"name","ModelNotReadyException");f(this,"$fault","client");f(this,"$retryable",{});Object.setPrototypeOf(this,Ep.prototype)}}class Sp extends Zt{constructor(r){super({name:"ModelTimeoutException",$fault:"client",...r});f(this,"name","ModelTimeoutException");f(this,"$fault","client");Object.setPrototypeOf(this,Sp.prototype)}}var v_;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.redactedContent!==void 0?r.redactedContent(e.redactedContent):e.signature!==void 0?r.signature(e.signature):r._(e.$unknown[0],e.$unknown[1])})(v_||(v_={}));var b_;(function(t){t.visit=(e,r)=>e.text!==void 0?r.text(e.text):e.toolUse!==void 0?r.toolUse(e.toolUse):e.reasoningContent!==void 0?r.reasoningContent(e.reasoningContent):e.citation!==void 0?r.citation(e.citation):r._(e.$unknown[0],e.$unknown[1])})(b_||(b_={}));var E_;(function(t){t.visit=(e,r)=>e.toolUse!==void 0?r.toolUse(e.toolUse):r._(e.$unknown[0],e.$unknown[1])})(E_||(E_={}));class xp extends Zt{constructor(r){super({name:"ModelStreamErrorException",$fault:"client",...r});f(this,"name","ModelStreamErrorException");f(this,"$fault","client");f(this,"originalStatusCode");f(this,"originalMessage");Object.setPrototypeOf(this,xp.prototype),this.originalStatusCode=r.originalStatusCode,this.originalMessage=r.originalMessage}}var S_;(function(t){t.visit=(e,r)=>e.messageStart!==void 0?r.messageStart(e.messageStart):e.contentBlockStart!==void 0?r.contentBlockStart(e.contentBlockStart):e.contentBlockDelta!==void 0?r.contentBlockDelta(e.contentBlockDelta):e.contentBlockStop!==void 0?r.contentBlockStop(e.contentBlockStop):e.messageStop!==void 0?r.messageStop(e.messageStop):e.metadata!==void 0?r.metadata(e.metadata):e.internalServerException!==void 0?r.internalServerException(e.internalServerException):e.modelStreamErrorException!==void 0?r.modelStreamErrorException(e.modelStreamErrorException):e.validationException!==void 0?r.validationException(e.validationException):e.throttlingException!==void 0?r.throttlingException(e.throttlingException):e.serviceUnavailableException!==void 0?r.serviceUnavailableException(e.serviceUnavailableException):r._(e.$unknown[0],e.$unknown[1])})(S_||(S_={}));var x_;(function(t){t.visit=(e,r)=>e.chunk!==void 0?r.chunk(e.chunk):r._(e.$unknown[0],e.$unknown[1])})(x_||(x_={}));var T_;(function(t){t.visit=(e,r)=>e.chunk!==void 0?r.chunk(e.chunk):e.internalServerException!==void 0?r.internalServerException(e.internalServerException):e.modelStreamErrorException!==void 0?r.modelStreamErrorException(e.modelStreamErrorException):e.validationException!==void 0?r.validationException(e.validationException):e.throttlingException!==void 0?r.throttlingException(e.throttlingException):e.modelTimeoutException!==void 0?r.modelTimeoutException(e.modelTimeoutException):e.serviceUnavailableException!==void 0?r.serviceUnavailableException(e.serviceUnavailableException):r._(e.$unknown[0],e.$unknown[1])})(T_||(T_={}));var A_;(function(t){t.visit=(e,r)=>e.chunk!==void 0?r.chunk(e.chunk):e.internalServerException!==void 0?r.internalServerException(e.internalServerException):e.modelStreamErrorException!==void 0?r.modelStreamErrorException(e.modelStreamErrorException):e.validationException!==void 0?r.validationException(e.validationException):e.throttlingException!==void 0?r.throttlingException(e.throttlingException):e.modelTimeoutException!==void 0?r.modelTimeoutException(e.modelTimeoutException):e.serviceUnavailableException!==void 0?r.serviceUnavailableException(e.serviceUnavailableException):r._(e.$unknown[0],e.$unknown[1])})(A_||(A_={}));var C_;(function(t){t.visit=(e,r)=>e.invokeModel!==void 0?r.invokeModel(e.invokeModel):e.converse!==void 0?r.converse(e.converse):r._(e.$unknown[0],e.$unknown[1])})(C_||(C_={}));const Ma=t=>({...t,...t.logic&&{logic:Ln},...t.naturalLanguage&&{naturalLanguage:Ln}}),fu=t=>({...t,...t.premises&&{premises:t.premises.map(e=>Ma(e))},...t.claims&&{claims:t.claims.map(e=>Ma(e))}}),k_=t=>({...t,...t.text&&{text:Ln}}),pu=t=>({...t,...t.premises&&{premises:t.premises.map(e=>Ma(e))},...t.claims&&{claims:t.claims.map(e=>Ma(e))},...t.untranslatedPremises&&{untranslatedPremises:t.untranslatedPremises.map(e=>k_(e))},...t.untranslatedClaims&&{untranslatedClaims:t.untranslatedClaims.map(e=>k_(e))}}),LB=t=>({...t,...t.translation&&{translation:pu(t.translation)},...t.logicWarning&&{logicWarning:fu(t.logicWarning)}}),DB=t=>({...t,...t.translation&&{translation:pu(t.translation)},...t.logicWarning&&{logicWarning:fu(t.logicWarning)}}),Bh=t=>({...t,...t.statements&&{statements:t.statements.map(e=>Ma(e))}}),MB=t=>({...t,...t.translation&&{translation:pu(t.translation)},...t.claimsTrueScenario&&{claimsTrueScenario:Bh(t.claimsTrueScenario)},...t.claimsFalseScenario&&{claimsFalseScenario:Bh(t.claimsFalseScenario)},...t.logicWarning&&{logicWarning:fu(t.logicWarning)}}),UB=t=>({...t}),BB=t=>({...t,...t.translation&&{translation:pu(t.translation)},...t.claimsTrueScenario&&{claimsTrueScenario:Bh(t.claimsTrueScenario)},...t.logicWarning&&{logicWarning:fu(t.logicWarning)}}),FB=t=>{if(t.valid!==void 0)return{valid:BB(t.valid)};if(t.invalid!==void 0)return{invalid:DB(t.invalid)};if(t.satisfiable!==void 0)return{satisfiable:MB(t.satisfiable)};if(t.impossible!==void 0)return{impossible:LB(t.impossible)};if(t.translationAmbiguous!==void 0)return{translationAmbiguous:UB(t.translationAmbiguous)};if(t.tooComplex!==void 0)return{tooComplex:t.tooComplex};if(t.noTranslations!==void 0)return{noTranslations:t.noTranslations};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},jB=t=>({...t,...t.findings&&{findings:t.findings.map(e=>FB(e))}}),I_=t=>({...t,...t.automatedReasoningPolicy&&{automatedReasoningPolicy:jB(t.automatedReasoningPolicy)}}),yS=t=>{if(t.text!==void 0)return{text:t.text};if(t.image!==void 0)return{image:Ln};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},zB=t=>{if(t.text!==void 0)return{text:t.text};if(t.image!==void 0)return{image:t.image};if(t.document!==void 0)return{document:t.document};if(t.video!==void 0)return{video:t.video};if(t.toolUse!==void 0)return{toolUse:t.toolUse};if(t.toolResult!==void 0)return{toolResult:t.toolResult};if(t.guardContent!==void 0)return{guardContent:yS(t.guardContent)};if(t.cachePoint!==void 0)return{cachePoint:t.cachePoint};if(t.reasoningContent!==void 0)return{reasoningContent:Ln};if(t.citationsContent!==void 0)return{citationsContent:t.citationsContent};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},Tp=t=>({...t,...t.content&&{content:t.content.map(e=>zB(e))}}),_S=t=>{if(t.text!==void 0)return{text:t.text};if(t.guardContent!==void 0)return{guardContent:yS(t.guardContent)};if(t.cachePoint!==void 0)return{cachePoint:t.cachePoint};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},VB=t=>({...t,...t.messages&&{messages:t.messages.map(e=>Tp(e))},...t.system&&{system:t.system.map(e=>_S(e))},...t.toolConfig&&{toolConfig:t.toolConfig},...t.promptVariables&&{promptVariables:Ln},...t.requestMetadata&&{requestMetadata:Ln}}),GB=t=>{if(t.message!==void 0)return{message:Tp(t.message)};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},HB=t=>({...t,...t.inputAssessment&&{inputAssessment:Object.entries(t.inputAssessment).reduce((e,[r,n])=>(e[r]=I_(n),e),{})},...t.outputAssessments&&{outputAssessments:Object.entries(t.outputAssessments).reduce((e,[r,n])=>(e[r]=n.map(s=>I_(s)),e),{})}}),qB=t=>({...t,...t.guardrail&&{guardrail:HB(t.guardrail)}}),WB=t=>({...t,...t.output&&{output:GB(t.output)},...t.trace&&{trace:qB(t.trace)}}),JB=t=>({...t,...t.messages&&{messages:t.messages.map(e=>Tp(e))},...t.system&&{system:t.system.map(e=>_S(e))},...t.toolConfig&&{toolConfig:t.toolConfig},...t.promptVariables&&{promptVariables:Ln},...t.requestMetadata&&{requestMetadata:Ln}}),ZB=t=>({...t,...t.stream&&{stream:"STREAMING_CONTENT"}}),KB=async(t,e)=>{const r=kE(t,e),n={"content-type":"application/json"};r.bp("/model/{modelId}/converse"),r.p("modelId",()=>t.modelId,"{modelId}",!1);let s;return s=JSON.stringify(_e(t,{additionalModelRequestFields:i=>Ya(i),additionalModelResponseFieldPaths:i=>Y(i),guardrailConfig:i=>Y(i),inferenceConfig:i=>kS(i),messages:i=>IS(i,e),performanceConfig:i=>Y(i),promptVariables:i=>Y(i),requestMetadata:i=>Y(i),system:i=>RS(i,e),toolConfig:i=>OS(i)})),r.m("POST").h(n).b(s),r.build()},XB=async(t,e)=>{const r=kE(t,e),n={"content-type":"application/json"};r.bp("/model/{modelId}/converse-stream"),r.p("modelId",()=>t.modelId,"{modelId}",!1);let s;return s=JSON.stringify(_e(t,{additionalModelRequestFields:i=>Ya(i),additionalModelResponseFieldPaths:i=>Y(i),guardrailConfig:i=>Y(i),inferenceConfig:i=>kS(i),messages:i=>IS(i,e),performanceConfig:i=>Y(i),promptVariables:i=>Y(i),requestMetadata:i=>Y(i),system:i=>RS(i,e),toolConfig:i=>OS(i)})),r.m("POST").h(n).b(s),r.build()},YB=async(t,e)=>{if(t.statusCode!==200&&t.statusCode>=300)return wS(t,e);const r=ur({$metadata:lr(t)}),n=vD(CE(await vr(t.body,e)),"body"),s=_e(n,{additionalModelResponseFields:i=>mu(i),metrics:Y,output:i=>zF($r(i),e),performanceConfig:Y,stopReason:Ce,trace:i=>HF(i),usage:Y});return Object.assign(r,s),r},QB=async(t,e)=>{if(t.statusCode!==200&&t.statusCode>=300)return wS(t,e);const r=ur({$metadata:lr(t)}),n=t.body;return r.stream=cF(n,e),r},wS=async(t,e)=>{const r={...t,body:await nM(t.body,e)},n=sM(t,r.body);switch(n){case"AccessDeniedException":case"com.amazonaws.bedrockruntime#AccessDeniedException":throw await tF(r);case"InternalServerException":case"com.amazonaws.bedrockruntime#InternalServerException":throw await vS(r);case"ResourceNotFoundException":case"com.amazonaws.bedrockruntime#ResourceNotFoundException":throw await aF(r);case"ServiceQuotaExceededException":case"com.amazonaws.bedrockruntime#ServiceQuotaExceededException":throw await oF(r);case"ServiceUnavailableException":case"com.amazonaws.bedrockruntime#ServiceUnavailableException":throw await ES(r);case"ThrottlingException":case"com.amazonaws.bedrockruntime#ThrottlingException":throw await SS(r);case"ValidationException":case"com.amazonaws.bedrockruntime#ValidationException":throw await xS(r);case"ModelErrorException":case"com.amazonaws.bedrockruntime#ModelErrorException":throw await nF(r);case"ModelNotReadyException":case"com.amazonaws.bedrockruntime#ModelNotReadyException":throw await sF(r);case"ModelTimeoutException":case"com.amazonaws.bedrockruntime#ModelTimeoutException":throw await iF(r);case"ModelStreamErrorException":case"com.amazonaws.bedrockruntime#ModelStreamErrorException":throw await bS(r);case"ConflictException":case"com.amazonaws.bedrockruntime#ConflictException":throw await rF(r);default:const s=r.body;return eF({output:t,parsedBody:s,errorCode:n})}},eF=H4(Zt),tF=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce});Object.assign(r,s);const i=new fp({$metadata:lr(t),...r});return wr(i,t.body)},rF=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce});Object.assign(r,s);const i=new yp({$metadata:lr(t),...r});return wr(i,t.body)},vS=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce});Object.assign(r,s);const i=new pp({$metadata:lr(t),...r});return wr(i,t.body)},nF=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce,originalStatusCode:ap,resourceName:Ce});Object.assign(r,s);const i=new bp({$metadata:lr(t),...r});return wr(i,t.body)},sF=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce});Object.assign(r,s);const i=new Ep({$metadata:lr(t),...r});return wr(i,t.body)},bS=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce,originalMessage:Ce,originalStatusCode:ap});Object.assign(r,s);const i=new xp({$metadata:lr(t),...r});return wr(i,t.body)},iF=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce});Object.assign(r,s);const i=new Sp({$metadata:lr(t),...r});return wr(i,t.body)},aF=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce});Object.assign(r,s);const i=new _p({$metadata:lr(t),...r});return wr(i,t.body)},oF=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce});Object.assign(r,s);const i=new wp({$metadata:lr(t),...r});return wr(i,t.body)},ES=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce});Object.assign(r,s);const i=new vp({$metadata:lr(t),...r});return wr(i,t.body)},SS=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce});Object.assign(r,s);const i=new mp({$metadata:lr(t),...r});return wr(i,t.body)},xS=async(t,e)=>{const r=ur({}),n=t.body,s=_e(n,{message:Ce});Object.assign(r,s);const i=new gp({$metadata:lr(t),...r});return wr(i,t.body)},cF=(t,e)=>e.eventStreamMarshaller.deserialize(t,async r=>r.messageStart!=null?{messageStart:await pF(r.messageStart,e)}:r.contentBlockStart!=null?{contentBlockStart:await lF(r.contentBlockStart,e)}:r.contentBlockDelta!=null?{contentBlockDelta:await uF(r.contentBlockDelta,e)}:r.contentBlockStop!=null?{contentBlockStop:await dF(r.contentBlockStop,e)}:r.messageStop!=null?{messageStop:await mF(r.messageStop,e)}:r.metadata!=null?{metadata:await hF(r.metadata,e)}:r.internalServerException!=null?{internalServerException:await fF(r.internalServerException,e)}:r.modelStreamErrorException!=null?{modelStreamErrorException:await gF(r.modelStreamErrorException,e)}:r.validationException!=null?{validationException:await wF(r.validationException,e)}:r.throttlingException!=null?{throttlingException:await _F(r.throttlingException,e)}:r.serviceUnavailableException!=null?{serviceUnavailableException:await yF(r.serviceUnavailableException,e)}:{$unknown:r}),uF=async(t,e)=>{const r={},n=await vr(t.body,e);return Object.assign(r,FF(n,e)),r},lF=async(t,e)=>{const r={},n=await vr(t.body,e);return Object.assign(r,Y(n)),r},dF=async(t,e)=>{const r={},n=await vr(t.body,e);return Object.assign(r,Y(n)),r},hF=async(t,e)=>{const r={},n=await vr(t.body,e);return Object.assign(r,VF(n)),r},fF=async(t,e)=>{const r={...t,body:await vr(t.body,e)};return vS(r)},pF=async(t,e)=>{const r={},n=await vr(t.body,e);return Object.assign(r,Y(n)),r},mF=async(t,e)=>{const r={},n=await vr(t.body,e);return Object.assign(r,mj(n)),r},gF=async(t,e)=>{const r={...t,body:await vr(t.body,e)};return bS(r)},yF=async(t,e)=>{const r={...t,body:await vr(t.body,e)};return ES(r)},_F=async(t,e)=>{const r={...t,body:await vr(t.body,e)};return SS(r)},wF=async(t,e)=>{const r={...t,body:await vr(t.body,e)};return xS(r)},vF=(t,e)=>Lh.visit(t,{cachePoint:r=>({cachePoint:Y(r)}),citationsContent:r=>({citationsContent:Y(r)}),document:r=>({document:TS(r,e)}),guardContent:r=>({guardContent:AS(r,e)}),image:r=>({image:CS(r,e)}),reasoningContent:r=>({reasoningContent:CF(r,e)}),text:r=>({text:r}),toolResult:r=>({toolResult:OF(r,e)}),toolUse:r=>({toolUse:DF(r)}),video:r=>({video:NS(r,e)}),_:(r,n)=>({[r]:n})}),bF=(t,e)=>t.filter(r=>r!=null).map(r=>vF(r,e)),TS=(t,e)=>_e(t,{citations:Y,context:[],format:[],name:[],source:r=>EF(r,e)}),EF=(t,e)=>kh.visit(t,{bytes:r=>({bytes:e.base64Encoder(r)}),content:r=>({content:Y(r)}),s3Location:r=>({s3Location:Y(r)}),text:r=>({text:r}),_:(r,n)=>({[r]:n})}),AS=(t,e)=>Rh.visit(t,{image:r=>({image:SF(r,e)}),text:r=>({text:Y(r)}),_:(r,n)=>({[r]:n})}),SF=(t,e)=>_e(t,{format:[],source:r=>xF(r,e)}),xF=(t,e)=>Ih.visit(t,{bytes:r=>({bytes:e.base64Encoder(r)}),_:(r,n)=>({[r]:n})}),CS=(t,e)=>_e(t,{format:[],source:r=>TF(r,e)}),TF=(t,e)=>Oh.visit(t,{bytes:r=>({bytes:e.base64Encoder(r)}),s3Location:r=>({s3Location:Y(r)}),_:(r,n)=>({[r]:n})}),kS=(t,e)=>_e(t,{maxTokens:[],stopSequences:Y,temperature:Fy,topP:Fy}),AF=(t,e)=>_e(t,{content:r=>bF(r,e),role:[]}),IS=(t,e)=>t.filter(r=>r!=null).map(r=>AF(r,e)),CF=(t,e)=>Nh.visit(t,{reasoningText:r=>({reasoningText:Y(r)}),redactedContent:r=>({redactedContent:e.base64Encoder(r)}),_:(r,n)=>({[r]:n})}),kF=(t,e)=>Dh.visit(t,{cachePoint:r=>({cachePoint:Y(r)}),guardContent:r=>({guardContent:AS(r,e)}),text:r=>({text:r}),_:(r,n)=>({[r]:n})}),RS=(t,e)=>t.filter(r=>r!=null).map(r=>kF(r,e)),IF=(t,e)=>Uh.visit(t,{cachePoint:r=>({cachePoint:Y(r)}),toolSpec:r=>({toolSpec:LF(r)}),_:(r,n)=>({[r]:n})}),OS=(t,e)=>_e(t,{toolChoice:Y,tools:r=>PF(r)}),RF=(t,e)=>Mh.visit(t,{json:r=>({json:Ya(r)}),_:(r,n)=>({[r]:n})}),OF=(t,e)=>_e(t,{content:r=>$F(r,e),status:[],toolUseId:[]}),NF=(t,e)=>Ph.visit(t,{document:r=>({document:TS(r,e)}),image:r=>({image:CS(r,e)}),json:r=>({json:Ya(r)}),text:r=>({text:r}),video:r=>({video:NS(r,e)}),_:(r,n)=>({[r]:n})}),$F=(t,e)=>t.filter(r=>r!=null).map(r=>NF(r,e)),PF=(t,e)=>t.filter(r=>r!=null).map(r=>IF(r)),LF=(t,e)=>_e(t,{description:[],inputSchema:r=>RF(r),name:[]}),DF=(t,e)=>_e(t,{input:r=>Ya(r),name:[],toolUseId:[]}),NS=(t,e)=>_e(t,{format:[],source:r=>MF(r,e)}),MF=(t,e)=>$h.visit(t,{bytes:r=>({bytes:e.base64Encoder(r)}),s3Location:r=>({s3Location:Y(r)}),_:(r,n)=>({[r]:n})}),Ya=(t,e)=>t,UF=(t,e)=>t.cachePoint!=null?{cachePoint:Y(t.cachePoint)}:t.citationsContent!=null?{citationsContent:Y(t.citationsContent)}:t.document!=null?{document:$S(t.document,e)}:t.guardContent!=null?{guardContent:lj($r(t.guardContent),e)}:t.image!=null?{image:DS(t.image,e)}:t.reasoningContent!=null?{reasoningContent:gj($r(t.reasoningContent),e)}:Ce(t.text)!==void 0?{text:Ce(t.text)}:t.toolResult!=null?{toolResult:_j(t.toolResult,e)}:t.toolUse!=null?{toolUse:bj(t.toolUse)}:t.video!=null?{video:MS(t.video,e)}:{$unknown:Object.entries(t)[0]},BF=(t,e)=>t.citation!=null?{citation:Y(t.citation)}:t.reasoningContent!=null?{reasoningContent:yj($r(t.reasoningContent),e)}:Ce(t.text)!==void 0?{text:Ce(t.text)}:t.toolUse!=null?{toolUse:Y(t.toolUse)}:{$unknown:Object.entries(t)[0]},FF=(t,e)=>_e(t,{contentBlockIndex:ap,delta:r=>BF($r(r),e)}),jF=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>UF($r(n),e)),zF=(t,e)=>t.message!=null?{message:pj(t.message,e)}:{$unknown:Object.entries(t)[0]},VF=(t,e)=>_e(t,{metrics:Y,performanceConfig:Y,trace:r=>GF(r),usage:Y}),GF=(t,e)=>_e(t,{guardrail:r=>LS(r),promptRouter:Y}),HF=(t,e)=>_e(t,{guardrail:r=>LS(r),promptRouter:Y}),$S=(t,e)=>_e(t,{citations:Y,context:Ce,format:Ce,name:Ce,source:r=>qF($r(r),e)}),qF=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:t.content!=null?{content:Y(t.content)}:t.s3Location!=null?{s3Location:Y(t.s3Location)}:Ce(t.text)!==void 0?{text:Ce(t.text)}:{$unknown:Object.entries(t)[0]},PS=(t,e)=>_e(t,{automatedReasoningPolicy:r=>ej(r),contentPolicy:Y,contextualGroundingPolicy:r=>uj(r),invocationMetrics:Y,sensitiveInformationPolicy:Y,topicPolicy:Y,wordPolicy:Y}),WF=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>PS(n)),JF=(t,e)=>Object.entries(t).reduce((r,[n,s])=>(s===null||(r[n]=WF(s)),r),{}),ZF=(t,e)=>Object.entries(t).reduce((r,[n,s])=>(s===null||(r[n]=PS(s)),r),{}),KF=(t,e)=>t.impossible!=null?{impossible:YF(t.impossible)}:t.invalid!=null?{invalid:QF(t.invalid)}:t.noTranslations!=null?{noTranslations:Y(t.noTranslations)}:t.satisfiable!=null?{satisfiable:tj(t.satisfiable)}:t.tooComplex!=null?{tooComplex:Y(t.tooComplex)}:t.translationAmbiguous!=null?{translationAmbiguous:rj(t.translationAmbiguous)}:t.valid!=null?{valid:aj(t.valid)}:{$unknown:Object.entries(t)[0]},XF=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>KF($r(n))),YF=(t,e)=>_e(t,{contradictingRules:Y,logicWarning:Y,translation:r=>Qa(r)}),QF=(t,e)=>_e(t,{contradictingRules:Y,logicWarning:Y,translation:r=>Qa(r)}),ej=(t,e)=>_e(t,{findings:r=>XF(r)}),tj=(t,e)=>_e(t,{claimsFalseScenario:Y,claimsTrueScenario:Y,logicWarning:Y,translation:r=>Qa(r)}),Qa=(t,e)=>_e(t,{claims:Y,confidence:Eh,premises:Y,untranslatedClaims:Y,untranslatedPremises:Y}),rj=(t,e)=>_e(t,{differenceScenarios:Y,options:r=>ij(r)}),nj=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>Qa(n)),sj=(t,e)=>_e(t,{translations:r=>nj(r)}),ij=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>sj(n)),aj=(t,e)=>_e(t,{claimsTrueScenario:Y,logicWarning:Y,supportingRules:Y,translation:r=>Qa(r)}),oj=(t,e)=>_e(t,{action:Ce,detected:mD,score:Eh,threshold:Eh,type:Ce}),cj=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>oj(n)),uj=(t,e)=>_e(t,{filters:r=>cj(r)}),lj=(t,e)=>t.image!=null?{image:dj(t.image,e)}:t.text!=null?{text:Y(t.text)}:{$unknown:Object.entries(t)[0]},dj=(t,e)=>_e(t,{format:Ce,source:r=>hj($r(r),e)}),hj=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:{$unknown:Object.entries(t)[0]},LS=(t,e)=>_e(t,{actionReason:Ce,inputAssessment:r=>ZF(r),modelOutput:Y,outputAssessments:r=>JF(r)}),DS=(t,e)=>_e(t,{format:Ce,source:r=>fj($r(r),e)}),fj=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:t.s3Location!=null?{s3Location:Y(t.s3Location)}:{$unknown:Object.entries(t)[0]},pj=(t,e)=>_e(t,{content:r=>jF(r,e),role:Ce}),mj=(t,e)=>_e(t,{additionalModelResponseFields:r=>mu(r),stopReason:Ce}),gj=(t,e)=>t.reasoningText!=null?{reasoningText:Y(t.reasoningText)}:t.redactedContent!=null?{redactedContent:e.base64Decoder(t.redactedContent)}:{$unknown:Object.entries(t)[0]},yj=(t,e)=>t.redactedContent!=null?{redactedContent:e.base64Decoder(t.redactedContent)}:Ce(t.signature)!==void 0?{signature:Ce(t.signature)}:Ce(t.text)!==void 0?{text:Ce(t.text)}:{$unknown:Object.entries(t)[0]},_j=(t,e)=>_e(t,{content:r=>vj(r,e),status:Ce,toolUseId:Ce}),wj=(t,e)=>t.document!=null?{document:$S(t.document,e)}:t.image!=null?{image:DS(t.image,e)}:t.json!=null?{json:mu(t.json)}:Ce(t.text)!==void 0?{text:Ce(t.text)}:t.video!=null?{video:MS(t.video,e)}:{$unknown:Object.entries(t)[0]},vj=(t,e)=>(t||[]).filter(n=>n!=null).map(n=>wj($r(n),e)),bj=(t,e)=>_e(t,{input:r=>mu(r),name:Ce,toolUseId:Ce}),MS=(t,e)=>_e(t,{format:Ce,source:r=>Ej($r(r),e)}),Ej=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:t.s3Location!=null?{s3Location:Y(t.s3Location)}:{$unknown:Object.entries(t)[0]},mu=(t,e)=>t,lr=t=>({httpStatusCode:t.statusCode,requestId:t.headers["x-amzn-requestid"]??t.headers["x-amzn-request-id"]??t.headers["x-amz-request-id"],extendedRequestId:t.headers["x-amz-id-2"],cfId:t.headers["x-amz-cf-id"]});class Sj extends up.classBuilder().ep(hS).m(function(e,r,n,s){return[EE(n,this.serialize,this.deserialize),cS(n,e.getEndpointParameterInstructions())]}).s("AmazonBedrockFrontendService","Converse",{}).n("BedrockRuntimeClient","ConverseCommand").f(VB,WB).ser(KB).de(YB).build(){}class xj extends up.classBuilder().ep(hS).m(function(e,r,n,s){return[EE(n,this.serialize,this.deserialize),cS(n,e.getEndpointParameterInstructions())]}).s("AmazonBedrockFrontendService","ConverseStream",{eventStream:{output:!0}}).n("BedrockRuntimeClient","ConverseStreamCommand").f(JB,ZB).ser(XB).de(QB).build(){}const Tj=()=>async()=>{throw new Error("Credential provider not available in browser. Please pass credentials directly.")},Aj=Tj;var US=class extends $i{constructor(e){super(e??{});f(this,"model","anthropic.claude-3-haiku-20240307-v1:0");f(this,"streaming",!1);f(this,"region");f(this,"temperature");f(this,"maxTokens");f(this,"endpointHost");f(this,"topP");f(this,"additionalModelRequestFields");f(this,"streamUsage",!0);f(this,"guardrailConfig");f(this,"performanceConfig");f(this,"client");f(this,"clientOptions");f(this,"supportsToolChoiceValues");const{profile:r,filepath:n,configFilepath:s,ignoreCache:i,mfaCodeProvider:a,roleAssumer:o,roleArn:c,webIdentityTokenFile:u,roleAssumerWithWebIdentity:l,...d}=e??{},h=(d==null?void 0:d.credentials)??Aj(),p=(d==null?void 0:d.region)??cn("AWS_DEFAULT_REGION");if(!p)throw new Error("Please set the AWS_DEFAULT_REGION environment variable or pass it to the constructor as the region field.");this.client=(e==null?void 0:e.client)??new PB({...e==null?void 0:e.clientOptions,region:p,credentials:h,endpoint:d.endpointHost?`https://${d.endpointHost}`:void 0}),this.region=p,this.model=(d==null?void 0:d.model)??this.model,this.streaming=(d==null?void 0:d.streaming)??this.streaming,this.temperature=d==null?void 0:d.temperature,this.maxTokens=d==null?void 0:d.maxTokens,this.endpointHost=d==null?void 0:d.endpointHost,this.topP=d==null?void 0:d.topP,this.additionalModelRequestFields=d==null?void 0:d.additionalModelRequestFields,this.streamUsage=(d==null?void 0:d.streamUsage)??this.streamUsage,this.guardrailConfig=d==null?void 0:d.guardrailConfig,this.performanceConfig=d==null?void 0:d.performanceConfig,this.clientOptions=d==null?void 0:d.clientOptions,(d==null?void 0:d.supportsToolChoiceValues)===void 0?this.supportsToolChoiceValues=gL(this.model):this.supportsToolChoiceValues=d.supportsToolChoiceValues}static lc_name(){return"ChatBedrockConverse"}get lc_secrets(){return{apiKey:"API_KEY_NAME"}}get lc_aliases(){return{apiKey:"API_KEY_NAME"}}getLsParams(e){var n,s;const r=this.invocationParams(e);return{ls_provider:"amazon_bedrock",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:((n=r.inferenceConfig)==null?void 0:n.temperature)??this.temperature,ls_max_tokens:((s=r.inferenceConfig)==null?void 0:s.maxTokens)??void 0,ls_stop:e.stop}}bindTools(e,r){return this.withConfig({tools:Ey(e),...r})}_llmType(){return"chat_bedrock_converse"}invocationParams(e){let r;if(e!=null&&e.tools&&e.tools.length){const n=Ey(e.tools);r={tools:n,toolChoice:e.tool_choice?mL(e.tool_choice,n,{model:this.model,supportsToolChoiceValues:this.supportsToolChoiceValues}):void 0}}return{inferenceConfig:{maxTokens:this.maxTokens,temperature:this.temperature,topP:this.topP,stopSequences:e==null?void 0:e.stop},toolConfig:r,additionalModelRequestFields:this.additionalModelRequestFields??(e==null?void 0:e.additionalModelRequestFields),guardrailConfig:this.guardrailConfig??(e==null?void 0:e.guardrailConfig),performanceConfig:e==null?void 0:e.performanceConfig}}async _generate(e,r,n){if(this.streaming){const s=this._streamResponseChunks(e,r,n);let i;for await(const a of s)i===void 0?i=a:i=i.concat(a);if(i===void 0)throw new Error("Could not parse final output from Bedrock streaming call.");return{generations:[i],llmOutput:i.generationInfo}}return this._generateNonStreaming(e,r,n)}async _generateNonStreaming(e,r,n){const{converseMessages:s,converseSystem:i}=Sy(e),a=this.invocationParams(r),o=new Sj({modelId:this.model,messages:s,system:i,requestMetadata:r.requestMetadata,...a}),c=await this.client.send(o,{abortSignal:r.signal}),{output:u,...l}=c;if(!(u!=null&&u.message))throw new Error("No message found in Bedrock response.");const d=CL(u.message,l);return{generations:[{text:typeof d.content=="string"?d.content:"",message:d}]}}async*_streamResponseChunks(e,r,n){const{converseMessages:s,converseSystem:i}=Sy(e),a=this.invocationParams(r);let{streamUsage:o}=this;r.streamUsage!==void 0&&(o=r.streamUsage);const c=new xj({modelId:this.model,messages:s,system:i,requestMetadata:r.requestMetadata,...a}),u=await this.client.send(c,{abortSignal:r.signal});if(u.stream)for await(const l of u.stream)if(l.contentBlockStart)yield IL(l.contentBlockStart);else if(l.contentBlockDelta){const d=kL(l.contentBlockDelta);yield d,await(n==null?void 0:n.handleLLMNewToken(d.text,void 0,void 0,void 0,void 0,{chunk:d}))}else l.metadata?yield RL(l.metadata,{streamUsage:o}):yield new Rr({text:"",message:new $t({content:"",response_metadata:{...l}})})}withStructuredOutput(e,r){const n=e,s=r==null?void 0:r.name,i=mi(n)??"A function available to call.",a=r==null?void 0:r.method,o=r==null?void 0:r.includeRaw;if(a==="jsonMode")throw new Error("ChatBedrockConverse does not support 'jsonMode'.");let c=s??"extract",u;hs(n)?u=[{type:"function",function:{name:c,description:i,parameters:kr(n)}}]:("name"in n&&(c=n.name),u=[{type:"function",function:{name:c,description:i,parameters:n}}]);const l=this.supportsToolChoiceValues??[];let d;l.includes("tool")?d={tool_choice:u[0].function.name}:l.includes("any")&&(d={tool_choice:"any"});const h=this.bindTools(u,d),p=mn.from(y=>{if(!y.tool_calls||y.tool_calls.length===0)throw new Error("No tool calls found in the response.");const E=y.tool_calls.find(b=>b.name===c);if(!E)throw new Error(`No tool call found with name ${c}.`);return E.args});if(!o)return h.pipe(p).withConfig({runName:"StructuredOutput"});const m=$s.assign({parsed:(y,E)=>p.invoke(y.raw,E)}),_=$s.assign({parsed:()=>null}),v=m.withFallbacks({fallbacks:[_]});return Pn.from([{raw:h},v]).withConfig({runName:"StructuredOutputRunnable"})}};const Cj={model_main:{assets:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:64e3,reasoning_budget:{1:16e3,2:32e3,3:63999}},flows:{id:"global.anthropic.claude-sonnet-4-5-20250929-v1:0",max_tokens:64e3,reasoning_budget:{1:8e3,2:16e3,3:24e3}},threats:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:64e3,reasoning_budget:{1:24e3,2:48e3,3:63999}},gaps:{id:"global.anthropic.claude-sonnet-4-5-20250929-v1:0",max_tokens:64e3,reasoning_budget:{1:4e3,2:8e3,3:12e3}}},model_summary:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:4e3},model_struct:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:64e3},reasoning_models:["global.anthropic.claude-haiku-4-5-20251001-v1:0","anthropic.claude-3-5-haiku-20241022-v1:0","global.anthropic.claude-sonnet-4-5-20250929-v1:0"]};function kj(t){if(!t||typeof t!="object")throw new Error("Configuration must be a valid object");if(!t.model_main)throw new Error("Configuration missing model_main");if(typeof t.model_main!="object")throw new Error("Configuration model_main must be an object");const e=["assets","flows","threats","gaps"];for(const r of e)Ij(t.model_main,r);if(R_(t,"model_summary"),R_(t,"model_struct"),!Array.isArray(t.reasoning_models))throw new Error("Configuration reasoning_models must be an array");return!0}function Ij(t,e){if(!t[e])throw new Error(`Configuration missing model_main.${e}`);const r=t[e];if(typeof r!="object")throw new Error(`Configuration model_main.${e} must be an object`);if(!r.id)throw new Error(`Configuration missing model_main.${e}.id`);if(typeof r.id!="string"||r.id.trim()==="")throw new Error(`Configuration model_main.${e}.id must be a non-empty string`);if(typeof r.max_tokens!="number")throw new Error(`Configuration model_main.${e}.max_tokens must be a number`);if(r.max_tokens<=0||!Number.isInteger(r.max_tokens))throw new Error(`Configuration model_main.${e}.max_tokens must be a positive integer`);if(!r.reasoning_budget)throw new Error(`Configuration missing model_main.${e}.reasoning_budget`);if(typeof r.reasoning_budget!="object")throw new Error(`Configuration model_main.${e}.reasoning_budget must be an object`);const n=["1","2","3"];for(const s of n){if(!(s in r.reasoning_budget))throw new Error(`Configuration missing model_main.${e}.reasoning_budget["${s}"]`);const i=r.reasoning_budget[s];if(typeof i!="number")throw new Error(`Configuration model_main.${e}.reasoning_budget["${s}"] must be a number`);if(i<=0||!Number.isInteger(i))throw new Error(`Configuration model_main.${e}.reasoning_budget["${s}"] must be a positive integer`)}}function R_(t,e){if(!t[e])throw new Error(`Configuration missing ${e}`);const r=t[e];if(typeof r!="object")throw new Error(`Configuration ${e} must be an object`);if(!r.id)throw new Error(`Configuration missing ${e}.id`);if(typeof r.id!="string"||r.id.trim()==="")throw new Error(`Configuration ${e}.id must be a non-empty string`);if(typeof r.max_tokens!="number")throw new Error(`Configuration ${e}.max_tokens must be a number`);if(r.max_tokens<=0||!Number.isInteger(r.max_tokens))throw new Error(`Configuration ${e}.max_tokens must be a positive integer`)}const BS=0;function Co(t,e,r,n,s){const i=t.id,a=t.max_tokens,o={model:i,region:n.region,credentials:{accessKeyId:n.accessKeyId,secretAccessKey:n.secretAccessKey},maxTokens:a};if(n.sessionToken&&n.sessionToken.trim()&&(o.credentials.sessionToken=n.sessionToken.trim()),e>0&&r.includes(i)){const u=t.reasoning_budget[e.toString()];u?(o.additionalModelRequestFields={thinking:{type:"enabled",budget_tokens:u}},console.log(`Reasoning enabled for ${s}: budget=${u}, model=${i}`)):console.warn(`No reasoning budget defined for ${s} at level ${e}, using default`)}else o.temperature=BS,e>0&&console.warn(`Reasoning requested for ${s} but model ${i} does not support it`);return new US(o)}function O_(t,e,r){const n={model:t.id,region:e.region,credentials:{accessKeyId:e.accessKeyId,secretAccessKey:e.secretAccessKey},maxTokens:t.max_tokens,temperature:BS};return e.sessionToken&&e.sessionToken.trim()&&(n.credentials.sessionToken=e.sessionToken.trim()),console.log(`Initialized ${r} model: ${t.id}`),new US(n)}function Rj(t=0,e=null){try{const r=e||Cj;kj(r);const n=L_();if(!n)throw new Error("AWS credentials not configured");if(!n.accessKeyId||!n.secretAccessKey)throw new Error("Invalid AWS credentials: missing accessKeyId or secretAccessKey");console.log("Initializing models with reasoning level:",t);const s=Co(r.model_main.assets,t,r.reasoning_models,n,"assets"),i=Co(r.model_main.flows,t,r.reasoning_models,n,"flows"),a=Co(r.model_main.threats,t,r.reasoning_models,n,"threats"),o=Co(r.model_main.gaps,t,r.reasoning_models,n,"gaps"),c=O_(r.model_summary,n,"summary"),u=O_(r.model_struct,n,"struct");return console.log("All models initialized successfully"),{assets_model:s,flows_model:i,threats_model:a,gaps_model:o,summary_model:c,struct_model:u}}catch(r){throw console.error("Failed to initialize models:",r),r.message.includes("credentials")?new Error("AWS credentials are invalid or missing: "+r.message):r.message.includes("Configuration")?new Error("Model configuration is invalid: "+r.message):new Error("Failed to initialize models: "+r.message)}}const N_={VALIDATION_ERROR:{code:400,message:"Validation failed"},UNAUTHORIZED:{code:401,message:"Unauthorized access"},NOT_FOUND:{code:404,message:"Resource not found"},CREDENTIALS_ERROR:{code:401,message:"Invalid AWS credentials"},MODEL_ERROR:{code:422,message:"Model invocation failed"},INTERNAL_ERROR:{code:500,message:"Internal server error"}};class xt extends Error{constructor(e,r,n=null){var s;super(r),this.name="ThreatModelingError",this.type=e,this.statusCode=((s=N_[e])==null?void 0:s.code)||500,this.jobId=n,Error.captureStackTrace&&Error.captureStackTrace(this,xt)}toResponse(){var e;return{error:((e=N_[this.type])==null?void 0:e.message)||"Unknown error",message:this.message,job_id:this.jobId}}toFetchError(){return{response:{status:this.statusCode,data:this.toResponse()}}}}function gn(t){return async function(...e){try{return await t(...e)}catch(r){throw r instanceof xt?r.toFetchError():r.response&&r.response.status&&r.response.data?r:new xt("INTERNAL_ERROR",r.message||"An unexpected error occurred",null).toFetchError()}}}function Dn(t,e){const r=e.filter(n=>t[n]===void 0||t[n]===null);if(r.length>0)throw new xt("VALIDATION_ERROR",`Missing required parameters: ${r.join(", ")}`,t.id||null)}function Oj(t){if(!t)throw new xt("CREDENTIALS_ERROR","AWS credentials not configured",null);if(!t.accessKeyId||!t.secretAccessKey)throw new xt("CREDENTIALS_ERROR","Invalid AWS credentials: missing accessKeyId or secretAccessKey",null);if(!t.region)throw new xt("CREDENTIALS_ERROR","AWS region not configured",null)}const er={START:"START",ASSETS:"ASSETS",FLOW:"FLOW",THREAT:"THREAT",THREAT_RETRY:"THREAT_RETRY",FINALIZE:"FINALIZE",COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"},Sn=new Map;function Nj(t=0){const e=L_();Oj(e);const r=Rj(t);return{configurable:{model_assets:r.assets_model,model_flows:r.flows_model,model_threats:r.threats_model,model_gaps:r.gaps_model,model_summary:r.summary_model,model_struct:r.struct_model,reasoning:t>0,max_retry:15}}}function $j(t){const{id:e,s3_location:r,iteration:n,description:s,assumptions:i,title:a,instructions:o}=t;let c=null;if(r){const u=ce.getUploadedFile(r);if(u)try{const l=JSON.parse(u);c=l.data||null,!c&&l.error&&console.warn(`Image data not available: ${l.error}`)}catch{c=u}}return{job_id:e,s3_location:r||"",owner:"LIGHTNING_USER",title:a||"",description:s||"",assumptions:i||[],iteration:n||0,retry:0,image_data:c,replay:!1,instructions:o||null,summary:null,assets:null,system_architecture:null,threat_list:null,gap:[],stop:!1}}function Pj(t,e){const{iteration:r,instructions:n}=e,s=ce.getJobResults(t);if(!s)throw new xt("NOT_FOUND",`Job ${t} not found for replay`,t);const i={assets:s.assets,system_architecture:s.system_architecture,threat_list:s.threat_list};ce.updateJobResults(t,{backup:i});let a=null;if(s.s3_location){const c=ce.getUploadedFile(s.s3_location);if(c)try{const u=JSON.parse(c);a=u.data||null,!a&&u.error&&console.warn(`Image data not available: ${u.error}`)}catch{a=c}}let o=null;if(s.threat_list){const c={...s.threat_list};c.threats=(c.threats||[]).filter(u=>u.starred===!0),o=c}return{job_id:t,s3_location:s.s3_location||"",owner:"LIGHTNING_USER",title:s.title||"",description:s.description||"",assumptions:s.assumptions||[],iteration:r||0,retry:0,image_data:a,replay:!0,instructions:n||null,summary:s.summary||null,assets:s.assets||null,system_architecture:s.system_architecture||null,threat_list:o,gap:[],stop:!1}}async function Lj(t){const{s3_location:e,id:r,iteration:n,reasoning:s,description:i,assumptions:a,title:o,replay:c=!1,instructions:u}=t,l=r||D_();try{let d;return c?d=Pj(l,{iteration:n,reasoning:s,instructions:u}):d=$j({id:l,s3_location:e,iteration:n,reasoning:s,description:i,assumptions:a,title:o,instructions:u}),ce.setJobStatus(l,er.START,0),ce.setJobTrail(l,{id:l,assets:"",flows:"",gaps:[],threats:[]}),c||ce.addJobToIndex(l,{title:o||"",owner:"LIGHTNING_USER",s3_location:e||""}),Dj(l,d,s||1),{id:l}}catch(d){throw console.error("Error executing agent:",d),ce.setJobStatus(l,er.FAILED,0),d instanceof xt?d:new xt("INTERNAL_ERROR",`Failed to execute agent: ${d.message}`,l)}}function Dj(t,e,r){const n=typeof AbortController<"u";n||console.warn("AbortController not available, interruption will not be supported");const s=n?new AbortController:null,i=(async()=>{try{console.log(`Starting background execution for job ${t}`);const a=Nj(r);s&&(a.signal=s.signal);const o=fL();console.log("Invoking workflow...");const c=await o.invoke(e,a);if(!Sn.has(t)){console.log(`Job ${t} was cancelled during execution, skipping completion`);return}console.log(`Workflow completed for job ${t}`),console.log(`Job ${t} completed successfully`),Sn.delete(t)}catch(a){if(a.name==="AbortError"||a.message==="AbortError"||s&&s.signal.aborted){console.log(`Job ${t} was aborted - interruption successful`),Sn.delete(t);return}if(console.error(`Background execution failed for job ${t}:`,a),console.error("Error details:",{name:a.name,message:a.message,stack:a.stack}),!Sn.has(t)){console.log(`Job ${t} was cancelled during error handling, skipping status update`);return}const u=ce.getJobStatus(t),l=(u==null?void 0:u.retry)||0;try{ce.setJobStatus(t,er.FAILED,l);const d=ce.getJobResults(t)||{};ce.setJobResults(t,{...d,error:a.message||"Unknown error",error_type:a.name||"Error",failed_at:new Date().toISOString()})}catch(d){console.error(`Failed to store error state for job ${t}:`,d)}Sn.delete(t)}})();Sn.set(t,{abortController:s,status:"RUNNING",startTime:Date.now(),workflowPromise:i}),setTimeout(()=>i,0)}function f6(t){const e=ce.getJobStatus(t);return e?[er.START,er.ASSETS,er.FLOW,er.THREAT,er.THREAT_RETRY,er.FINALIZE].includes(e.state):!1}function p6(t){const e=Sn.get(t);if(!e){console.log(`Interruption requested for job ${t}, but job not found in active jobs registry`);const r=ce.getJobStatus(t);return r&&(console.log(`Job ${t} exists in storage with status: ${r.state}`),![er.COMPLETE,er.FAILED,er.CANCELLED].includes(r.state))?(console.log(`Updating orphaned job ${t} to CANCELLED state`),ce.setJobStatus(t,er.CANCELLED,r.retry||0),!0):!1}console.log(`Interrupting job ${t} (started at ${new Date(e.startTime).toISOString()})`);try{e.abortController?(e.abortController.abort(),console.log(`Abort signal sent for job ${t}`)):console.warn(`No AbortController available for job ${t}, interruption may not be immediate`);const r=ce.getJobStatus(t);r?(ce.setJobStatus(t,er.CANCELLED,r.retry||0),console.log(`Job ${t} status updated to CANCELLED`)):console.warn(`Job ${t} status not found during interruption, may have been cleared`);try{const n=ce.getJobResults(t)||{};ce.setJobResults(t,{...n,cancelled_at:new Date().toISOString(),cancellation_reason:"User requested interruption"})}catch(n){console.error(`Failed to store cancellation metadata for job ${t}:`,n)}return Sn.delete(t),console.log(`Job ${t} interrupted successfully and removed from active registry`),!0}catch(r){return console.error(`Error during interruption of job ${t}:`,r),Sn.delete(t),!0}}const Mj=gn(async(t,e,r,n,s,i,a=!1,o=null,c=null)=>(console.log("startThreatModeling called",{key:t,iteration:e,reasoning:r,title:n,replay:a,id:o}),a?Dn({iteration:e,reasoning:r,id:o},["iteration","reasoning","id"]):Dn({iteration:e,reasoning:r,title:n,description:s},["iteration","reasoning","title","description"]),{data:await Lj({s3_location:t,id:o,iteration:e,reasoning:r,description:s,assumptions:i||[],title:n,replay:a,instructions:c})})),Uj=gn(async(t,e)=>{if(console.log("updateTm called",{id:t,payload:e}),Dn({id:t},["id"]),!e||typeof e!="object")throw new xt("VALIDATION_ERROR","Payload must be an object",t);const r=ce.getJobResults(t);if(!r)throw new xt("NOT_FOUND",`Job ${t} not found`,t);const n=["owner","s3_location","job_id"],s=Object.keys(e).filter(a=>!n.includes(a)).reduce((a,o)=>(a[o]=e[o],a),{});if(!r.backup){const a={assets:r.assets,system_architecture:r.system_architecture,threat_list:r.threat_list};s.backup=a}return ce.updateJobResults(t,s),{data:ce.getJobResults(t)}}),Bj=gn(async t=>{console.log("restoreTm called",{id:t}),Dn({id:t},["id"]);const e=ce.getJobResults(t);if(!e)throw new xt("NOT_FOUND",`Job ${t} not found`,t);if(!e.backup)throw new xt("NOT_FOUND",`No backup found for job ${t}`,t);const r={...e,assets:e.backup.assets,system_architecture:e.backup.system_architecture,threat_list:e.backup.threat_list};ce.setJobResults(t,r);const n=ce.getJobStatus(t);return n&&ce.setJobStatus(t,"COMPLETE",n.retry||0),{data:!0}}),Fj=gn(async(t="image/png")=>{console.log("generateUrl called",{fileType:t});const e=D_();return{data:{presigned:`lightning://upload/${e}`,name:e}}}),jj=gn(async t=>{console.log("getDownloadUrl called",{fileName:t}),Dn({fileName:t},["fileName"]);const e=ce.getUploadedFile(t);if(!e)throw new xt("NOT_FOUND",`File ${t} not found`,null);try{let r,n;try{const o=JSON.parse(e);if(o.data&&o.type)n=o.data,r=o.type;else throw new Error("Invalid JSON format")}catch{const c=e.match(/^data:([^;]+);base64,(.+)$/);if(!c)throw new Error("Invalid data format - not JSON or data URL");r=c[1],n=c[2]}const s=atob(n),i=new Uint8Array(s.length);for(let o=0;o<s.length;o++)i[o]=s.charCodeAt(o);return new Blob([i],{type:r})}catch(r){throw new xt("INTERNAL_ERROR",`Failed to retrieve file: ${r.message}`,null)}}),zj=gn(async t=>{Dn({id:t},["id"]);const e=ce.getJobStatus(t);return e?{data:{id:e.id,state:e.state,retry:e.retry||0}}:{data:{id:t,state:"Not Found",retry:0}}}),Vj=gn(async t=>{console.log("getThreatModelingTrail called",{id:t}),Dn({id:t},["id"]);const e=ce.getJobTrail(t);return e?{data:{id:e.id,assets:e.assets||"",flows:e.flows||"",gaps:e.gaps||[],threats:e.threats||[]}}:{data:{id:t,assets:"",flows:"",gaps:[],threats:[]}}}),Gj=gn(async t=>{console.log("getThreatModelingResults called",{id:t}),Dn({id:t},["id"]);const e=ce.getJobResults(t);return e?{data:{job_id:t,state:"Found",item:e}}:{data:{job_id:t,state:"Not Found",item:null}}}),Hj=gn(async()=>(console.log("getThreatModelingAllResults called"),{data:{catalogs:ce.getAllJobs().map(r=>ce.getJobResults(r.id)||r).filter(Boolean)}})),qj=gn(async t=>{console.log("deleteTm called",{id:t}),Dn({id:t},["id"]);const e=ce.getJobResults(t);if(!e)throw new xt("NOT_FOUND",`Job ${t} not found`,t);return e.s3_location&&ce.deleteUploadedFile(e.s3_location),ce.clearJobData(t),{data:{job_id:t,state:"Deleted"}}}),m6=Mj,g6=Uj,y6=Bj,_6=Fj,w6=jj,v6=zj,b6=Vj,E6=Gj,S6=Hj,x6=qj;export{N_ as ERROR_TYPES,xt as ThreatModelingError,C6 as clearCredentials,x6 as deleteTm,_6 as generateUrl,L_ as getCredentials,w6 as getDownloadUrl,S6 as getThreatModelingAllResults,E6 as getThreatModelingResults,v6 as getThreatModelingStatus,b6 as getThreatModelingTrail,k6 as hasValidCredentials,p6 as interruptJob,f6 as isJobExecuting,y6 as restoreTm,I6 as setCredentials,m6 as startThreatModeling,ce as stateManager,g6 as updateTm};
//# sourceMappingURL=index-BuCkqIjf.js.map
