var _I=Object.defineProperty;var wI=(t,e,n)=>e in t?_I(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var p=(t,e,n)=>wI(t,typeof e!="symbol"?e+"":e,n);import{g as Ra,a as Fl}from"./index-0YWjbRLd.js";import{c as DH,h as UH,s as BH}from"./index-0YWjbRLd.js";const jt=[];for(let t=0;t<256;++t)jt.push((t+256).toString(16).slice(1));function bI(t,e=0){return(jt[t[e+0]]+jt[t[e+1]]+jt[t[e+2]]+jt[t[e+3]]+"-"+jt[t[e+4]]+jt[t[e+5]]+"-"+jt[t[e+6]]+jt[t[e+7]]+"-"+jt[t[e+8]]+jt[t[e+9]]+"-"+jt[t[e+10]]+jt[t[e+11]]+jt[t[e+12]]+jt[t[e+13]]+jt[t[e+14]]+jt[t[e+15]]).toLowerCase()}let $d;const vI=new Uint8Array(16);function EI(){if(!$d){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");$d=crypto.getRandomValues.bind(crypto)}return $d(vI)}const SI=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),By={randomUUID:SI};function xI(t,e,n){var s;t=t||{};const r=t.random??((s=t.rng)==null?void 0:s.call(t))??EI();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,bI(r)}function kv(t,e,n){return By.randomUUID&&!t?By.randomUUID():xI(t)}const Tt={JOB_STATUS:"tm_job_status_",JOB_RESULTS:"tm_job_results_",JOB_TRAIL:"tm_job_trail_",ALL_JOBS:"tm_all_jobs",UPLOADED_FILES:"tm_uploaded_files_",AWS_CREDENTIALS:"tm_aws_credentials"},Nd={COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"};class TI{setJobStatus(e,n,r=0){const s={id:e,state:n,retry:r,owner:"LIGHTNING_USER",updated_at:new Date().toISOString()};sessionStorage.setItem(`${Tt.JOB_STATUS}${e}`,JSON.stringify(s))}getJobStatus(e){const n=sessionStorage.getItem(`${Tt.JOB_STATUS}${e}`);if(!n)return null;try{return JSON.parse(n)}catch(r){return console.error("Failed to parse job status:",r),null}}setJobResults(e,n){sessionStorage.setItem(`${Tt.JOB_RESULTS}${e}`,JSON.stringify(n))}getJobResults(e){const n=sessionStorage.getItem(`${Tt.JOB_RESULTS}${e}`);if(!n)return null;try{return JSON.parse(n)}catch(r){return console.error("Failed to parse job results:",r),null}}updateJobResults(e,n){const s={...this.getJobResults(e)||{},...n};this.setJobResults(e,s)}setJobTrail(e,n){sessionStorage.setItem(`${Tt.JOB_TRAIL}${e}`,JSON.stringify(n))}getJobTrail(e){const n=sessionStorage.getItem(`${Tt.JOB_TRAIL}${e}`);if(!n)return null;try{return JSON.parse(n)}catch(r){return console.error("Failed to parse job trail:",r),null}}updateJobTrail(e,n){const r=this.getJobTrail(e)||{id:e,assets:"",flows:"",gaps:[],threats:[]},s={...r};n.assets!==void 0&&(s.assets=n.assets),n.flows!==void 0&&(s.flows=n.flows),n.gaps!==void 0&&(s.gaps=Array.isArray(n.gaps)?[...r.gaps||[],...n.gaps]:[...r.gaps||[],n.gaps]),n.threats!==void 0&&(s.threats=Array.isArray(n.threats)?[...r.threats||[],...n.threats]:[...r.threats||[],n.threats]),this.setJobTrail(e,s)}addJobToIndex(e,n){const r=this.getAllJobs(),s=r.findIndex(a=>a.id===e),i={id:e,...n,created_at:n.created_at||new Date().toISOString()};s>=0?r[s]={...r[s],...i}:r.push(i),sessionStorage.setItem(Tt.ALL_JOBS,JSON.stringify(r))}getAllJobs(){const e=sessionStorage.getItem(Tt.ALL_JOBS);if(!e)return[];try{return JSON.parse(e)}catch(n){return console.error("Failed to parse all jobs:",n),[]}}removeJobFromIndex(e){const r=this.getAllJobs().filter(s=>s.id!==e);sessionStorage.setItem(Tt.ALL_JOBS,JSON.stringify(r))}storeUploadedFile(e,n){sessionStorage.setItem(`${Tt.UPLOADED_FILES}${e}`,n)}getUploadedFile(e){return sessionStorage.getItem(`${Tt.UPLOADED_FILES}${e}`)}deleteUploadedFile(e){sessionStorage.removeItem(`${Tt.UPLOADED_FILES}${e}`)}clearJobData(e){sessionStorage.removeItem(`${Tt.JOB_STATUS}${e}`),sessionStorage.removeItem(`${Tt.JOB_RESULTS}${e}`),sessionStorage.removeItem(`${Tt.JOB_TRAIL}${e}`),this.removeJobFromIndex(e)}clearAllData(){const e=sessionStorage.getItem(Tt.AWS_CREDENTIALS);this.getAllJobs().forEach(r=>{this.clearJobData(r.id)}),sessionStorage.removeItem(Tt.ALL_JOBS),Object.keys(sessionStorage).forEach(r=>{r.startsWith(Tt.UPLOADED_FILES)&&sessionStorage.removeItem(r)}),e&&sessionStorage.setItem(Tt.AWS_CREDENTIALS,e)}isJobActive(e){const n=this.getJobStatus(e);return n?![Nd.CANCELLED,Nd.COMPLETE,Nd.FAILED].includes(n.state):!1}}const de=new TI;var Ii=class extends Error{constructor(e,n){let r=e??"";n!=null&&n.lc_error_code&&(r=`${r}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langgraph/${n.lc_error_code}/
`);super(r);p(this,"lc_error_code");this.lc_error_code=n==null?void 0:n.lc_error_code}},Iv=class extends Ii{get is_bubble_up(){return!0}},AI=class extends Ii{constructor(t,e){super(t,e),this.name="GraphRecursionError"}static get unminifiable_name(){return"GraphRecursionError"}},uu=class extends Ii{constructor(t,e){super(t,e),this.name="GraphValueError"}static get unminifiable_name(){return"GraphValueError"}},la=class extends Iv{constructor(e,n){super(JSON.stringify(e,null,2),n);p(this,"interrupts");this.name="GraphInterrupt",this.interrupts=e??[]}static get unminifiable_name(){return"GraphInterrupt"}},Rv=class extends la{constructor(t,e){super([{value:t}],e),this.name="NodeInterrupt"}static get unminifiable_name(){return"NodeInterrupt"}},Ov=class extends Iv{constructor(e){super();p(this,"command");this.name="ParentCommand",this.command=e}static get unminifiable_name(){return"ParentCommand"}};function CI(t){return t!==void 0&&t.name===Ov.unminifiable_name}function lu(t){return t!==void 0&&t.is_bubble_up===!0}function ea(t){return t!==void 0&&[la.unminifiable_name,Rv.unminifiable_name].includes(t.name)}var jy=class extends Ii{constructor(t,e){super(t,e),this.name="EmptyInputError"}static get unminifiable_name(){return"EmptyInputError"}},Zt=class extends Ii{constructor(t,e){super(t,e),this.name="EmptyChannelError"}static get unminifiable_name(){return"EmptyChannelError"}},at=class extends Ii{constructor(t,e){super(t,e),this.name="InvalidUpdateError"}static get unminifiable_name(){return"InvalidUpdateError"}},kI=class extends Ii{constructor(t,e){super(t,e),this.name="UnreachableNodeError"}static get unminifiable_name(){return"UnreachableNodeError"}};const II=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function RI(t){return typeof t=="string"&&II.test(t)}function $v(t){if(!RI(t))throw TypeError("Invalid UUID");var e,n=new Uint8Array(16);return n[0]=(e=parseInt(t.slice(0,8),16))>>>24,n[1]=e>>>16&255,n[2]=e>>>8&255,n[3]=e&255,n[4]=(e=parseInt(t.slice(9,13),16))>>>8,n[5]=e&255,n[6]=(e=parseInt(t.slice(14,18),16))>>>8,n[7]=e&255,n[8]=(e=parseInt(t.slice(19,23),16))>>>8,n[9]=e&255,n[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,n[11]=e/4294967296&255,n[12]=e>>>24&255,n[13]=e>>>16&255,n[14]=e>>>8&255,n[15]=e&255,n}var Ft=[];for(var Pd=0;Pd<256;++Pd)Ft.push((Pd+256).toString(16).slice(1));function zl(t,e=0){return(Ft[t[e+0]]+Ft[t[e+1]]+Ft[t[e+2]]+Ft[t[e+3]]+"-"+Ft[t[e+4]]+Ft[t[e+5]]+"-"+Ft[t[e+6]]+Ft[t[e+7]]+"-"+Ft[t[e+8]]+Ft[t[e+9]]+"-"+Ft[t[e+10]]+Ft[t[e+11]]+Ft[t[e+12]]+Ft[t[e+13]]+Ft[t[e+14]]+Ft[t[e+15]]).toLowerCase()}var kc,OI=new Uint8Array(16);function $I(){if(!kc&&(kc=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!kc))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return kc(OI)}var Ld,Ic,Md=0,Dd=0;function NI(t,e,n){var r=0,s=e||new Array(16);t=t||{};var i=t.node,a=t.clockseq;if(t._v6||(i||(i=Ld),a==null&&(a=Ic)),i==null||a==null){var o=t.random||(t.rng||$I)();i==null&&(i=[o[0],o[1],o[2],o[3],o[4],o[5]],!Ld&&!t._v6&&(i[0]|=1,Ld=i)),a==null&&(a=(o[6]<<8|o[7])&16383,Ic===void 0&&!t._v6&&(Ic=a))}var c=t.msecs!==void 0?t.msecs:Date.now(),u=t.nsecs!==void 0?t.nsecs:Dd+1,l=c-Md+(u-Dd)/1e4;if(l<0&&t.clockseq===void 0&&(a=a+1&16383),(l<0||c>Md)&&t.nsecs===void 0&&(u=0),u>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");Md=c,Dd=u,Ic=a,c+=122192928e5;var d=((c&268435455)*1e4+u)%4294967296;s[r++]=d>>>24&255,s[r++]=d>>>16&255,s[r++]=d>>>8&255,s[r++]=d&255;var h=c/4294967296*1e4&268435455;s[r++]=h>>>8&255,s[r++]=h&255,s[r++]=h>>>24&15|16,s[r++]=h>>>16&255,s[r++]=a>>>8|128,s[r++]=a&255;for(var f=0;f<6;++f)s[r+f]=i[f];return e||zl(s)}function PI(t){var e=typeof t=="string"?$v(t):t,n=LI(e);return typeof t=="string"?zl(n):n}function LI(t,e=!1){return Uint8Array.of((t[6]&15)<<4|t[7]>>4&15,(t[7]&15)<<4|(t[4]&240)>>4,(t[4]&15)<<4|(t[5]&240)>>4,(t[5]&15)<<4|(t[0]&240)>>4,(t[0]&15)<<4|(t[1]&240)>>4,(t[1]&15)<<4|(t[2]&240)>>4,96|t[2]&15,t[3],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}function MI(t){t=unescape(encodeURIComponent(t));for(var e=[],n=0;n<t.length;++n)e.push(t.charCodeAt(n));return e}var DI="6ba7b810-9dad-11d1-80b4-00c04fd430c8",UI="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function BI(t,e,n){function r(s,i,a,o){var c;if(typeof s=="string"&&(s=MI(s)),typeof i=="string"&&(i=$v(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var u=new Uint8Array(16+s.length);if(u.set(i),u.set(s,i.length),u=n(u),u[6]=u[6]&15|e,u[8]=u[8]&63|128,a){o=o||0;for(var l=0;l<16;++l)a[o+l]=u[l];return a}return zl(u)}try{r.name=t}catch{}return r.DNS=DI,r.URL=UI,r}function jI(t,e,n,r){switch(t){case 0:return e&n^~e&r;case 1:return e^n^r;case 2:return e&n^e&r^n&r;case 3:return e^n^r}}function Ud(t,e){return t<<e|t>>>32-e}function FI(t){var e=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var r=unescape(encodeURIComponent(t));t=[];for(var s=0;s<r.length;++s)t.push(r.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var i=t.length/4+2,a=Math.ceil(i/16),o=new Array(a),c=0;c<a;++c){for(var u=new Uint32Array(16),l=0;l<16;++l)u[l]=t[c*64+l*4]<<24|t[c*64+l*4+1]<<16|t[c*64+l*4+2]<<8|t[c*64+l*4+3];o[c]=u}o[a-1][14]=(t.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var h=new Uint32Array(80),f=0;f<16;++f)h[f]=o[d][f];for(var m=16;m<80;++m)h[m]=Ud(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var g=n[0],_=n[1],b=n[2],y=n[3],E=n[4],C=0;C<80;++C){var k=Math.floor(C/20),R=Ud(g,5)+jI(k,_,b,y)+E+e[k]+h[C]>>>0;E=y,y=b,b=Ud(_,30)>>>0,_=g,g=R}n[0]=n[0]+g>>>0,n[1]=n[1]+_>>>0,n[2]=n[2]+b>>>0,n[3]=n[3]+y>>>0,n[4]=n[4]+E>>>0}return[n[0]>>24&255,n[0]>>16&255,n[0]>>8&255,n[0]&255,n[1]>>24&255,n[1]>>16&255,n[1]>>8&255,n[1]&255,n[2]>>24&255,n[2]>>16&255,n[2]>>8&255,n[2]&255,n[3]>>24&255,n[3]>>16&255,n[3]>>8&255,n[3]&255,n[4]>>24&255,n[4]>>16&255,n[4]>>8&255,n[4]&255]}var zI=BI("v5",80,FI);function Fy(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(s){return Object.getOwnPropertyDescriptor(t,s).enumerable})),n.push.apply(n,r)}return n}function zy(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Fy(Object(n),!0).forEach(function(r){VI(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Fy(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function VI(t,e,n){return(e=qI(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function qI(t){var e=HI(t,"string");return typeof e=="symbol"?e:e+""}function HI(t,e){if(typeof t!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var r=n.call(t,e);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function GI(t={},e,n=0){var r=NI(zy(zy({},t),{},{_v6:!0}),new Uint8Array(16));return r=PI(r),zl(r)}function Nv(t){return GI({clockseq:t})}function ta(t,e){const n=e.replace(/-/g,"").match(/.{2}/g).map(r=>parseInt(r,16));return zI(t,new Uint8Array(n))}const WI="__error__",du="__scheduled__",JI="__interrupt__",ZI="__resume__";var Vy="[...]",KI="[Circular]",zu=[],na=[];function XI(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function YI(t,e,n,r){typeof r>"u"&&(r=XI()),Jf(t,"",0,[],void 0,0,r);var s;try{na.length===0?s=JSON.stringify(t,e,n):s=JSON.stringify(t,QI(e),n)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;zu.length!==0;){var i=zu.pop();i.length===4?Object.defineProperty(i[0],i[1],i[3]):i[0][i[1]]=i[2]}}return s}function Bd(t,e,n,r){var s=Object.getOwnPropertyDescriptor(r,n);s.get!==void 0?s.configurable?(Object.defineProperty(r,n,{value:t}),zu.push([r,n,e,s])):na.push([e,n,t]):(r[n]=t,zu.push([r,n,e]))}function Jf(t,e,n,r,s,i,a){i+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<r.length;o++)if(r[o]===t){Bd(KI,t,e,s);return}if(typeof a.depthLimit<"u"&&i>a.depthLimit){Bd(Vy,t,e,s);return}if(typeof a.edgesLimit<"u"&&n+1>a.edgesLimit){Bd(Vy,t,e,s);return}if(r.push(t),Array.isArray(t))for(o=0;o<t.length;o++)Jf(t[o],o,o,r,t,i,a);else{var c=Object.keys(t);for(o=0;o<c.length;o++){var u=c[o];Jf(t[u],u,o,r,t,i,a)}}r.pop()}}function QI(t){return t=typeof t<"u"?t:function(e,n){return n},function(e,n){if(na.length>0)for(var r=0;r<na.length;r++){var s=na[r];if(s[1]===e&&s[0]===n){n=s[2],na.splice(r,1);break}}return t.call(this,e,n)}}var jd,qy;function e1(){return qy||(qy=1,jd=function(t,e){if(typeof t!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,t.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}),jd}var t1=e1();const n1=Ra(t1);var Rc={exports:{}},Hy;function r1(){if(Hy)return Rc.exports;Hy=1;const t=/[\p{Lu}]/u,e=/[\p{Ll}]/u,n=/^[\p{Lu}](?![\p{Lu}])/gu,r=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,i=new RegExp("^"+s.source),a=new RegExp(s.source+r.source,"gu"),o=new RegExp("\\d+"+r.source,"gu"),c=(h,f,m)=>{let g=!1,_=!1,b=!1;for(let y=0;y<h.length;y++){const E=h[y];g&&t.test(E)?(h=h.slice(0,y)+"-"+h.slice(y),g=!1,b=_,_=!0,y++):_&&b&&e.test(E)?(h=h.slice(0,y-1)+"-"+h.slice(y-1),b=_,_=!1,g=!0):(g=f(E)===E&&m(E)!==E,b=_,_=m(E)===E&&f(E)!==E)}return h},u=(h,f)=>(n.lastIndex=0,h.replace(n,m=>f(m))),l=(h,f)=>(a.lastIndex=0,o.lastIndex=0,h.replace(a,(m,g)=>f(g)).replace(o,m=>f(m))),d=(h,f)=>{if(!(typeof h=="string"||Array.isArray(h)))throw new TypeError("Expected the input to be `string | string[]`");if(f={pascalCase:!1,preserveConsecutiveUppercase:!1,...f},Array.isArray(h)?h=h.map(b=>b.trim()).filter(b=>b.length).join("-"):h=h.trim(),h.length===0)return"";const m=f.locale===!1?b=>b.toLowerCase():b=>b.toLocaleLowerCase(f.locale),g=f.locale===!1?b=>b.toUpperCase():b=>b.toLocaleUpperCase(f.locale);return h.length===1?f.pascalCase?g(h):m(h):(h!==m(h)&&(h=c(h,m,g)),h=h.replace(i,""),f.preserveConsecutiveUppercase?h=u(h,m):h=m(h),f.pascalCase&&(h=g(h.charAt(0))+h.slice(1)),l(h,g))};return Rc.exports=d,Rc.exports.default=d,Rc.exports}var s1=r1();const i1=Ra(s1);function a1(t,e){return(e==null?void 0:e[t])||n1(t)}function o1(t,e){return(e==null?void 0:e[t])||i1(t)}function Pv(t,e,n){const r={};for(const s in t)Object.hasOwn(t,s)&&(r[e(s,n)]=t[s]);return r}var c1=Object.defineProperty,ve=(t,e)=>{for(var n in e)c1(t,n,{get:e[n],enumerable:!0})},Lv={};ve(Lv,{Serializable:()=>sr,get_lc_unique_name:()=>Vl});function Gy(t){return Array.isArray(t)?[...t]:{...t}}function u1(t,e){const n=Gy(t);for(const[r,s]of Object.entries(e)){const[i,...a]=r.split(".").reverse();let o=n;for(const c of a.reverse()){if(o[c]===void 0)break;o[c]=Gy(o[c]),o=o[c]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[s]})}return n}function Vl(t){const e=Object.getPrototypeOf(t);return typeof t.lc_name=="function"&&(typeof e.lc_name!="function"||t.lc_name()!==e.lc_name())?t.lc_name():t.name}var sr=class Mv{constructor(e,...n){p(this,"lc_serializable",!1);p(this,"lc_kwargs");this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([r])=>{var s;return(s=this.lc_serializable_keys)==null?void 0:s.includes(r)})):this.lc_kwargs=e??{}}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Vl(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Mv||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},n={},r=Object.keys(this.lc_kwargs).reduce((s,i)=>(s[i]=i in this?this[i]:this.lc_kwargs[i],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(n,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(n).forEach(s=>{let i=this,a=r;const[o,...c]=s.split(".").reverse();for(const u of c.reverse()){if(!(u in i)||i[u]===void 0)return;(!(u in a)||a[u]===void 0)&&(typeof i[u]=="object"&&i[u]!=null?a[u]={}:Array.isArray(i[u])&&(a[u]=[])),i=i[u],a=a[u]}o in i&&i[o]!==void 0&&(a[o]=a[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Pv(Object.keys(n).length?u1(r,n):r,a1,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function l1(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Dv={exports:{}},mt=Dv.exports={},Or,$r;function Zf(){throw new Error("setTimeout has not been defined")}function Kf(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?Or=setTimeout:Or=Zf}catch{Or=Zf}try{typeof clearTimeout=="function"?$r=clearTimeout:$r=Kf}catch{$r=Kf}})();function Uv(t){if(Or===setTimeout)return setTimeout(t,0);if((Or===Zf||!Or)&&setTimeout)return Or=setTimeout,setTimeout(t,0);try{return Or(t,0)}catch{try{return Or.call(null,t,0)}catch{return Or.call(this,t,0)}}}function d1(t){if($r===clearTimeout)return clearTimeout(t);if(($r===Kf||!$r)&&clearTimeout)return $r=clearTimeout,clearTimeout(t);try{return $r(t)}catch{try{return $r.call(null,t)}catch{return $r.call(this,t)}}}var os=[],da=!1,oi,hu=-1;function h1(){!da||!oi||(da=!1,oi.length?os=oi.concat(os):hu=-1,os.length&&Bv())}function Bv(){if(!da){var t=Uv(h1);da=!0;for(var e=os.length;e;){for(oi=os,os=[];++hu<e;)oi&&oi[hu].run();hu=-1,e=os.length}oi=null,da=!1,d1(t)}}mt.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];os.push(new jv(t,e)),os.length===1&&!da&&Uv(Bv)};function jv(t,e){this.fun=t,this.array=e}jv.prototype.run=function(){this.fun.apply(null,this.array)};mt.title="browser";mt.browser=!0;mt.env={};mt.argv=[];mt.version="";mt.versions={};function _s(){}mt.on=_s;mt.addListener=_s;mt.once=_s;mt.off=_s;mt.removeListener=_s;mt.removeAllListeners=_s;mt.emit=_s;mt.prependListener=_s;mt.prependOnceListener=_s;mt.listeners=function(t){return[]};mt.binding=function(t){throw new Error("process.binding is not supported")};mt.cwd=function(){return"/"};mt.chdir=function(t){throw new Error("process.chdir is not supported")};mt.umask=function(){return 0};var f1=Dv.exports;const Fr=l1(f1);var Fd={},Fv={};ve(Fv,{getEnv:()=>Gv,getEnvironmentVariable:()=>nr,getRuntimeEnvironment:()=>Wv,isBrowser:()=>zv,isDeno:()=>ql,isJsDom:()=>qv,isNode:()=>Hv,isWebWorker:()=>Vv});const zv=()=>typeof window<"u"&&typeof window.document<"u",Vv=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",qv=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),ql=()=>typeof Deno<"u",Hv=()=>typeof Fr<"u"&&typeof Fr.versions<"u"&&typeof Fr.versions.node<"u"&&!ql(),Gv=()=>{let t;return zv()?t="browser":Hv()?t="node":Vv()?t="webworker":qv()?t="jsdom":ql()?t="deno":t="other",t};let zd;function Wv(){return zd===void 0&&(zd={library:"langchain-js",runtime:Gv()}),zd}function nr(t){try{return typeof Fr<"u"?Fd==null?void 0:Fd[t]:ql()?Deno==null?void 0:Deno.env.get(t):void 0}catch{return}}const p1=[];var m1={};function vr(t){return typeof t=="object"&&t!==null&&"type"in t&&typeof t.type=="string"&&"source_type"in t&&(t.source_type==="url"||t.source_type==="base64"||t.source_type==="text"||t.source_type==="id")}function Om(t){return vr(t)&&t.source_type==="url"&&"url"in t&&typeof t.url=="string"}function $m(t){return vr(t)&&t.source_type==="base64"&&"data"in t&&typeof t.data=="string"}function g1(t){return vr(t)&&t.source_type==="text"&&"text"in t&&typeof t.text=="string"}function Jv(t){return vr(t)&&t.source_type==="id"&&"id"in t&&typeof t.id=="string"}function Zv(t){if(vr(t)){if(t.source_type==="url")return{type:"image_url",image_url:{url:t.url}};if(t.source_type==="base64"){if(!t.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${t.mime_type};base64,${t.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function ci(t){const e=t.split(";")[0].split("/");if(e.length!==2)throw new Error(`Invalid mime type: "${t}" - does not match type/subtype format.`);const n=e[0].trim(),r=e[1].trim();if(n===""||r==="")throw new Error(`Invalid mime type: "${t}" - type or subtype is empty.`);const s={};for(const i of t.split(";").slice(1)){const a=i.split("=");if(a.length!==2)throw new Error(`Invalid parameter syntax in mime type: "${t}".`);const o=a[0].trim(),c=a[1].trim();if(o==="")throw new Error(`Invalid parameter syntax in mime type: "${t}".`);s[o]=c}return{type:n,subtype:r,parameters:s}}function vi({dataUrl:t,asTypedArray:e=!1}){const n=t.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let r;if(n){r=n[1].toLowerCase();const s=e?Uint8Array.from(atob(n[2]),i=>i.charCodeAt(0)):n[2];return{mime_type:r,data:s}}}function Hl(t,e){if(t.type==="text"){if(!e.fromStandardTextBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardTextBlock\` method.`);return e.fromStandardTextBlock(t)}if(t.type==="image"){if(!e.fromStandardImageBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardImageBlock\` method.`);return e.fromStandardImageBlock(t)}if(t.type==="audio"){if(!e.fromStandardAudioBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardAudioBlock\` method.`);return e.fromStandardAudioBlock(t)}if(t.type==="file"){if(!e.fromStandardFileBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardFileBlock\` method.`);return e.fromStandardFileBlock(t)}throw new Error(`Unable to convert content block type '${t.type}' to provider-specific format: not recognized.`)}function be(t,e){return Ie(t)&&t.type===e}function Ie(t){return typeof t=="object"&&t!==null}function zr(t){return Array.isArray(t)}function se(t){return typeof t=="string"}function pr(t){return typeof t=="number"}function Nm(t){return t instanceof Uint8Array}function Wy(t){try{return JSON.parse(t)}catch{return}}const To=t=>t();function y1(t){if(t.type==="char_location"&&se(t.document_title)&&pr(t.start_char_index)&&pr(t.end_char_index)&&se(t.cited_text)){const{document_title:e,start_char_index:n,end_char_index:r,cited_text:s,...i}=t;return{...i,type:"citation",source:"char",title:e??void 0,startIndex:n,endIndex:r,citedText:s}}if(t.type==="page_location"&&se(t.document_title)&&pr(t.start_page_number)&&pr(t.end_page_number)&&se(t.cited_text)){const{document_title:e,start_page_number:n,end_page_number:r,cited_text:s,...i}=t;return{...i,type:"citation",source:"page",title:e??void 0,startIndex:n,endIndex:r,citedText:s}}if(t.type==="content_block_location"&&se(t.document_title)&&pr(t.start_block_index)&&pr(t.end_block_index)&&se(t.cited_text)){const{document_title:e,start_block_index:n,end_block_index:r,cited_text:s,...i}=t;return{...i,type:"citation",source:"block",title:e??void 0,startIndex:n,endIndex:r,citedText:s}}if(t.type==="web_search_result_location"&&se(t.url)&&se(t.title)&&se(t.encrypted_index)&&se(t.cited_text)){const{url:e,title:n,encrypted_index:r,cited_text:s,...i}=t;return{...i,type:"citation",source:"url",url:e,title:n,startIndex:Number(r),endIndex:Number(r),citedText:s}}if(t.type==="search_result_location"&&se(t.source)&&se(t.title)&&pr(t.start_block_index)&&pr(t.end_block_index)&&se(t.cited_text)){const{source:e,title:n,start_block_index:r,end_block_index:s,cited_text:i,...a}=t;return{...a,type:"citation",source:"search",url:e,title:n??void 0,startIndex:r,endIndex:s,citedText:i}}}function Kv(t){if(be(t,"document")&&Ie(t.source)&&"type"in t.source){if(t.source.type==="base64"&&se(t.source.media_type)&&se(t.source.data))return{type:"file",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&se(t.source.url))return{type:"file",url:t.source.url};if(t.source.type==="file"&&se(t.source.file_id))return{type:"file",fileId:t.source.file_id};if(t.source.type==="text"&&se(t.source.data))return{type:"file",mimeType:String(t.source.media_type??"text/plain"),data:t.source.data}}else if(be(t,"image")&&Ie(t.source)&&"type"in t.source){if(t.source.type==="base64"&&se(t.source.media_type)&&se(t.source.data))return{type:"image",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&se(t.source.url))return{type:"image",url:t.source.url};if(t.source.type==="file"&&se(t.source.file_id))return{type:"image",fileId:t.source.file_id}}}function _1(t){function*e(){for(const n of t){const r=Kv(n);r?yield r:yield n}}return Array.from(e())}function Jy(t){function*e(){var r;const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const s of n){if(be(s,"text")&&se(s.text)){const{text:i,citations:a,...o}=s;if(zr(a)&&a.length){const c=a.reduce((u,l)=>{const d=y1(l);return d?[...u,d]:u},[]);yield{...o,type:"text",text:i,annotations:c};continue}else{yield{...o,type:"text",text:i};continue}}else if(be(s,"thinking")&&se(s.thinking)){const{thinking:i,signature:a,...o}=s;yield{...o,type:"reasoning",reasoning:i,signature:a};continue}else if(be(s,"redacted_thinking")){yield{type:"non_standard",value:s};continue}else if(be(s,"tool_use")&&se(s.name)&&se(s.id)){yield{type:"tool_call",id:s.id,name:s.name,args:s.input};continue}else if(be(s,"input_json_delta")){if(b1(t)&&((r=t.tool_call_chunks)!=null&&r.length)){const i=t.tool_call_chunks[0];yield{type:"tool_call_chunk",id:i.id,name:i.name,args:i.args,index:i.index};continue}}else if(be(s,"server_tool_use")&&se(s.name)&&se(s.id)){const{name:i,id:a}=s;if(i==="web_search"){const o=To(()=>{if(typeof s.input=="string")return s.input;if(Ie(s.input)&&se(s.input.query))return s.input.query;if(se(s.partial_json)){const c=Wy(s.partial_json);if(c!=null&&c.query)return c.query}return""});yield{id:a,type:"server_tool_call",name:"web_search",args:{query:o}};continue}else if(s.name==="code_execution"){const o=To(()=>{if(typeof s.input=="string")return s.input;if(Ie(s.input)&&se(s.input.code))return s.input.code;if(se(s.partial_json)){const c=Wy(s.partial_json);if(c!=null&&c.code)return c.code}return""});yield{id:a,type:"server_tool_call",name:"code_execution",args:{code:o}};continue}}else if(be(s,"web_search_tool_result")&&se(s.tool_use_id)&&zr(s.content)){const{content:i,tool_use_id:a}=s,o=i.reduce((c,u)=>be(u,"web_search_result")?[...c,u.url]:c,[]);yield{type:"server_tool_call_result",name:"web_search",toolCallId:a,status:"success",output:{urls:o}};continue}else if(be(s,"code_execution_tool_result")&&se(s.tool_use_id)&&Ie(s.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(be(s,"mcp_tool_use")){yield{id:s.id,type:"server_tool_call",name:"mcp_tool_use",args:s.input};continue}else if(be(s,"mcp_tool_result")&&se(s.tool_use_id)&&Ie(s.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(be(s,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:s.input};continue}else if(be(s,"search_result")){yield{id:s.id,type:"non_standard",value:s};continue}else if(be(s,"tool_result")){yield{id:s.id,type:"non_standard",value:s};continue}else{const i=Kv(s);if(i){yield i;continue}}yield{type:"non_standard",value:s}}}return Array.from(e())}const w1={translateContent:Jy,translateContentChunk:Jy};function b1(t){return typeof(t==null?void 0:t._getType)=="function"&&typeof t.concat=="function"&&t._getType()==="ai"}function v1(t){return Om(t)?{type:t.type,mimeType:t.mime_type,url:t.url,metadata:t.metadata}:$m(t)?{type:t.type,mimeType:t.mime_type??"application/octet-stream",data:t.data,metadata:t.metadata}:Jv(t)?{type:t.type,mimeType:t.mime_type,fileId:t.id,metadata:t.metadata}:t}function E1(t){return t.map(v1)}function S1(t){return!!(be(t,"image_url")&&Ie(t.image_url)||be(t,"input_audio")&&Ie(t.input_audio)||be(t,"file")&&Ie(t.file))}function x1(t){if(be(t,"image_url")&&Ie(t.image_url)&&se(t.image_url.url)){const e=vi({dataUrl:t.image_url.url});return e?{type:"image",mimeType:e.mime_type,data:e.data}:{type:"image",url:t.image_url.url}}else{if(be(t,"input_audio")&&Ie(t.input_audio)&&se(t.input_audio.data)&&se(t.input_audio.format))return{type:"audio",data:t.input_audio.data,mimeType:`audio/${t.input_audio.format}`};if(be(t,"file")&&Ie(t.file)&&se(t.file.data)){const e=vi({dataUrl:t.file.data});if(e)return{type:"file",data:e.data,mimeType:e.mime_type};if(se(t.file.file_id))return{type:"file",fileId:t.file.file_id}}}return t}function T1(t){const e=[];typeof t.content=="string"?e.push({type:"text",text:t.content}):e.push(...Pm(t.content));for(const n of t.tool_calls??[])e.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return e}function A1(t){const e=[];typeof t.content=="string"?e.push({type:"text",text:t.content}):e.push(...Pm(t.content));for(const n of t.tool_calls??[])e.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return e}function Pm(t){const e=[];for(const n of t)S1(n)?e.push(x1(n)):e.push(n);return e}function C1(t){if(t.type==="url_citation"){const{url:e,title:n,start_index:r,end_index:s}=t;return{type:"citation",url:e,title:n,startIndex:r,endIndex:s}}if(t.type==="file_citation"){const{file_id:e,filename:n,index:r}=t;return{type:"citation",title:n,startIndex:r,endIndex:r,fileId:e}}return t}function Xv(t){function*e(){var r;Ie((r=t.additional_kwargs)==null?void 0:r.reasoning)&&zr(t.additional_kwargs.reasoning.summary)&&(yield{type:"reasoning",reasoning:t.additional_kwargs.reasoning.summary.reduce((i,a)=>Ie(a)&&se(a.text)?`${i}${a.text}`:i,"")});const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const s of n)if(be(s,"text")){const{text:i,annotations:a,...o}=s;Array.isArray(a)?yield{...o,type:"text",text:String(i),annotations:a.map(C1)}:yield{...o,type:"text",text:String(i)}}for(const s of t.tool_calls??[])yield{type:"tool_call",id:s.id,name:s.name,args:s.args};if(Ie(t.additional_kwargs)&&zr(t.additional_kwargs.tool_outputs))for(const s of t.additional_kwargs.tool_outputs){if(be(s,"web_search_call")){yield{id:s.id,type:"server_tool_call",name:"web_search",args:{query:s.query}};continue}else if(be(s,"file_search_call")){yield{id:s.id,type:"server_tool_call",name:"file_search",args:{query:s.query}};continue}else if(be(s,"computer_call")){yield{type:"non_standard",value:s};continue}else if(be(s,"code_interpreter_call")){if(se(s.code)&&(yield{id:s.id,type:"server_tool_call",name:"code_interpreter",args:{code:s.code}}),zr(s.outputs)){const i=To(()=>{if(s.status!=="in_progress"){if(s.status==="completed")return 0;if(s.status==="incomplete")return 127;if(s.status!=="interpreting"&&s.status==="failed")return 1}});for(const a of s.outputs)if(be(a,"logs")){yield{type:"server_tool_call_result",toolCallId:s.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:i??0,stderr:[0,void 0].includes(i)?void 0:String(a.logs),stdout:[0,void 0].includes(i)?String(a.logs):void 0}};continue}}continue}else if(be(s,"mcp_call")){yield{id:s.id,type:"server_tool_call",name:"mcp_call",args:s.input};continue}else if(be(s,"mcp_list_tools")){yield{id:s.id,type:"server_tool_call",name:"mcp_list_tools",args:s.input};continue}else if(be(s,"mcp_approval_request")){yield{type:"non_standard",value:s};continue}else if(be(s,"image_generation_call")){yield{type:"non_standard",value:s};continue}Ie(s)&&(yield{type:"non_standard",value:s})}}return Array.from(e())}function k1(t){function*e(){yield*Xv(t);for(const n of t.tool_call_chunks??[])yield{type:"tool_call_chunk",id:n.id,name:n.name,args:n.args}}return Array.from(e())}const I1={translateContent:t=>typeof t.content=="string"?T1(t):Xv(t),translateContentChunk:t=>typeof t.content=="string"?A1(t):k1(t)};function Yv(t){return typeof t=="object"&&t!==null&&"type"in t&&"content"in t&&(typeof t.content=="string"||Array.isArray(t.content))}const Vd=Symbol.for("langchain.message");function Ri(t,e){return typeof t=="string"?t===""?e:typeof e=="string"?t+e:Array.isArray(e)&&e.some(n=>vr(n))?[{type:"text",source_type:"text",text:t},...e]:[{type:"text",text:t},...e]:Array.isArray(e)?nc(t,e)??[...t,...e]:e===""?t:Array.isArray(t)&&t.some(n=>vr(n))?[...t,{type:"file",source_type:"text",text:e}]:[...t,{type:"text",text:e}]}function Qv(t,e){return t==="error"||e==="error"?"error":"success"}function R1(t,e){function n(r,s){if(typeof r!="object"||r===null||r===void 0)return r;if(s>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(a=>n(a,s+1));const i={};for(const a of Object.keys(r))i[a]=n(r[a],s+1);return i}return JSON.stringify(n(t,0),null,2)}var Av,rr=class extends sr{constructor(e){const n=typeof e=="string"||Array.isArray(e)?{content:e}:e;n.additional_kwargs||(n.additional_kwargs={}),n.response_metadata||(n.response_metadata={});super(n);p(this,"lc_namespace",["langchain_core","messages"]);p(this,"lc_serializable",!0);p(this,Av,!0);p(this,"id");p(this,"name");p(this,"content");p(this,"additional_kwargs");p(this,"response_metadata");this.name=n.name,n.content===void 0&&n.contentBlocks!==void 0?(this.content=n.contentBlocks,this.response_metadata={output_version:"v1",...n.response_metadata}):n.content!==void 0?(this.content=n.content??[],this.response_metadata=n.response_metadata):(this.content=[],this.response_metadata=n.response_metadata),this.additional_kwargs=n.additional_kwargs,this.id=n.id}get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}_getType(){return this.type}getType(){return this._getType()}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}get contentBlocks(){const e=typeof this.content=="string"?[{type:"text",text:this.content}]:this.content;return[E1,Pm,_1].reduce((s,i)=>i(s),e)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(e){return typeof e=="object"&&e!==null&&Vd in e&&e[Vd]===!0&&Yv(e)}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[(Av=Vd,Symbol.toStringTag)](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const n=R1(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${n}`}};function O1(t){return Array.isArray(t)&&t.every(e=>typeof e.index=="number")}function rn(t={},e={}){const n={...t};for(const[r,s]of Object.entries(e))if(n[r]==null)n[r]=s;else{if(s==null)continue;if(typeof n[r]!=typeof s||Array.isArray(n[r])!==Array.isArray(s))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof n[r]=="string"){if(r==="type")continue;["id","name","output_version","model_provider"].includes(r)?n[r]=s:n[r]+=s}else if(typeof n[r]=="object"&&!Array.isArray(n[r]))n[r]=rn(n[r],s);else if(Array.isArray(n[r]))n[r]=nc(n[r],s);else{if(n[r]===s)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return n}function nc(t,e){if(!(t===void 0&&e===void 0)){if(t===void 0||e===void 0)return t||e;{const n=[...t];for(const r of e)if(typeof r=="object"&&r!==null&&"index"in r&&typeof r.index=="number"){const s=n.findIndex(i=>{const a=typeof i=="object",o="index"in i&&i.index===r.index,c="id"in i&&"id"in r&&(i==null?void 0:i.id)===(r==null?void 0:r.id),u=!("id"in i)||!(i!=null&&i.id)||!("id"in r)||!(r!=null&&r.id);return a&&o&&(c||u)});s!==-1&&typeof n[s]=="object"&&n[s]!==null?n[s]=rn(n[s],r):n.push(r)}else{if(typeof r=="object"&&r!==null&&"text"in r&&r.text==="")continue;n.push(r)}return n}}}function eE(t,e){if(!t&&!e)throw new Error("Cannot merge two undefined objects.");if(!t||!e)return t||e;if(typeof t!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof t}
Right ${typeof e}`);if(typeof t=="string"&&typeof e=="string")return t+e;if(Array.isArray(t)&&Array.isArray(e))return nc(t,e);if(typeof t=="object"&&typeof e=="object")return rn(t,e);if(t===e)return t;throw new Error(`Can not merge objects of different types.
Left ${t}
Right ${e}`)}var Oi=class extends rr{static isInstance(t){return super.isInstance(t)&&"concat"in t&&typeof t.concat=="function"}};function tE(t){return typeof t.role=="string"}function Lt(t){return typeof(t==null?void 0:t._getType)=="function"}function Ao(t){return Lt(t)&&typeof t.concat=="function"}var nE={};ve(nE,{ToolMessage:()=>Hr,ToolMessageChunk:()=>rc,defaultToolCallParser:()=>Mm,isDirectToolOutput:()=>Lm,isToolMessage:()=>Dm,isToolMessageChunk:()=>rE});function Lm(t){return t!=null&&typeof t=="object"&&"lc_direct_tool_output"in t&&t.lc_direct_tool_output===!0}var Hr=class extends rr{constructor(e,n,r){const s=typeof e=="string"||Array.isArray(e)?{content:e,name:r,tool_call_id:n}:e;super(s);p(this,"lc_direct_tool_output",!0);p(this,"type","tool");p(this,"status");p(this,"tool_call_id");p(this,"metadata");p(this,"artifact");this.tool_call_id=s.tool_call_id,this.artifact=s.artifact,this.status=s.status,this.metadata=s.metadata}static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}static isInstance(e){return super.isInstance(e)&&e.type==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},rc=class extends Oi{constructor(e){super(e);p(this,"type","tool");p(this,"tool_call_id");p(this,"status");p(this,"artifact");this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}concat(e){const n=this.constructor;return new n({content:Ri(this.content,e.content),additional_kwargs:rn(this.additional_kwargs,e.additional_kwargs),response_metadata:rn(this.response_metadata,e.response_metadata),artifact:eE(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:Qv(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function Mm(t){const e=[],n=[];for(const r of t)if(r.function){const s=r.function.name;try{const i=JSON.parse(r.function.arguments);e.push({name:s||"",args:i||{},id:r.id})}catch{n.push({name:s,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,n]}function Dm(t){return typeof t=="object"&&t!==null&&"getType"in t&&typeof t.getType=="function"&&t.getType()==="tool"}function rE(t){return t._getType()==="tool"}const $1=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function lo(t){return typeof t=="string"&&$1.test(t)}function N1(t){if(!lo(t))throw TypeError("Invalid UUID");var e,n=new Uint8Array(16);return n[0]=(e=parseInt(t.slice(0,8),16))>>>24,n[1]=e>>>16&255,n[2]=e>>>8&255,n[3]=e&255,n[4]=(e=parseInt(t.slice(9,13),16))>>>8,n[5]=e&255,n[6]=(e=parseInt(t.slice(14,18),16))>>>8,n[7]=e&255,n[8]=(e=parseInt(t.slice(19,23),16))>>>8,n[9]=e&255,n[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,n[11]=e/4294967296&255,n[12]=e>>>24&255,n[13]=e>>>16&255,n[14]=e>>>8&255,n[15]=e&255,n}var zt=[];for(var qd=0;qd<256;++qd)zt.push((qd+256).toString(16).slice(1));function sE(t,e=0){return(zt[t[e+0]]+zt[t[e+1]]+zt[t[e+2]]+zt[t[e+3]]+"-"+zt[t[e+4]]+zt[t[e+5]]+"-"+zt[t[e+6]]+zt[t[e+7]]+"-"+zt[t[e+8]]+zt[t[e+9]]+"-"+zt[t[e+10]]+zt[t[e+11]]+zt[t[e+12]]+zt[t[e+13]]+zt[t[e+14]]+zt[t[e+15]]).toLowerCase()}var Oc,P1=new Uint8Array(16);function L1(){if(!Oc&&(Oc=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Oc))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Oc(P1)}function M1(t){t=unescape(encodeURIComponent(t));for(var e=[],n=0;n<t.length;++n)e.push(t.charCodeAt(n));return e}var D1="6ba7b810-9dad-11d1-80b4-00c04fd430c8",U1="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function B1(t,e,n){function r(s,i,a,o){var c;if(typeof s=="string"&&(s=M1(s)),typeof i=="string"&&(i=N1(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var u=new Uint8Array(16+s.length);if(u.set(i),u.set(s,i.length),u=n(u),u[6]=u[6]&15|e,u[8]=u[8]&63|128,a){o=o||0;for(var l=0;l<16;++l)a[o+l]=u[l];return a}return sE(u)}try{r.name=t}catch{}return r.DNS=D1,r.URL=U1,r}var j1=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Zy={randomUUID:j1};function ns(t,e,n){if(Zy.randomUUID&&!t)return Zy.randomUUID();t=t||{};var r=t.random||(t.rng||L1)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,sE(r)}function F1(t,e,n,r){switch(t){case 0:return e&n^~e&r;case 1:return e^n^r;case 2:return e&n^e&r^n&r;case 3:return e^n^r}}function Hd(t,e){return t<<e|t>>>32-e}function z1(t){var e=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var r=unescape(encodeURIComponent(t));t=[];for(var s=0;s<r.length;++s)t.push(r.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var i=t.length/4+2,a=Math.ceil(i/16),o=new Array(a),c=0;c<a;++c){for(var u=new Uint32Array(16),l=0;l<16;++l)u[l]=t[c*64+l*4]<<24|t[c*64+l*4+1]<<16|t[c*64+l*4+2]<<8|t[c*64+l*4+3];o[c]=u}o[a-1][14]=(t.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var h=new Uint32Array(80),f=0;f<16;++f)h[f]=o[d][f];for(var m=16;m<80;++m)h[m]=Hd(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var g=n[0],_=n[1],b=n[2],y=n[3],E=n[4],C=0;C<80;++C){var k=Math.floor(C/20),R=Hd(g,5)+F1(k,_,b,y)+E+e[k]+h[C]>>>0;E=y,y=b,b=Hd(_,30)>>>0,_=g,g=R}n[0]=n[0]+g>>>0,n[1]=n[1]+_>>>0,n[2]=n[2]+b>>>0,n[3]=n[3]+y>>>0,n[4]=n[4]+E>>>0}return[n[0]>>24&255,n[0]>>16&255,n[0]>>8&255,n[0]&255,n[1]>>24&255,n[1]>>16&255,n[1]>>8&255,n[1]&255,n[2]>>24&255,n[2]>>16&255,n[2]>>8&255,n[2]&255,n[3]>>24&255,n[3]>>16&255,n[3]>>8&255,n[3]&255,n[4]>>24&255,n[4]>>16&255,n[4]>>8&255,n[4]&255]}var Ky=B1("v5",80,z1),iE={};ve(iE,{BaseCallbackHandler:()=>Oa,callbackHandlerPrefersStreaming:()=>Um,isBaseCallbackHandler:()=>aE});var V1=class{};function Um(t){return"lc_prefer_streaming"in t&&t.lc_prefer_streaming}var Oa=class extends V1{constructor(e){super();p(this,"lc_serializable",!1);p(this,"lc_kwargs");p(this,"ignoreLLM",!1);p(this,"ignoreChain",!1);p(this,"ignoreAgent",!1);p(this,"ignoreRetriever",!1);p(this,"ignoreCustomEvent",!1);p(this,"raiseError",!1);p(this,"awaitHandlers",nr("LANGCHAIN_CALLBACKS_BACKGROUND")==="false");this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Vl(this.constructor)]}copy(){return new this.constructor(this)}toJSON(){return sr.prototype.toJSON.call(this)}toJSONNotImplemented(){return sr.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class n extends Oa{constructor(){super();p(this,"name",ns());Object.assign(this,e)}}return new n}};const aE=t=>{const e=t;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"},q1=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function H1(t){return typeof t=="string"&&q1.test(t)}function G1(t){if(!H1(t))throw TypeError("Invalid UUID");var e,n=new Uint8Array(16);return n[0]=(e=parseInt(t.slice(0,8),16))>>>24,n[1]=e>>>16&255,n[2]=e>>>8&255,n[3]=e&255,n[4]=(e=parseInt(t.slice(9,13),16))>>>8,n[5]=e&255,n[6]=(e=parseInt(t.slice(14,18),16))>>>8,n[7]=e&255,n[8]=(e=parseInt(t.slice(19,23),16))>>>8,n[9]=e&255,n[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,n[11]=e/4294967296&255,n[12]=e>>>24&255,n[13]=e>>>16&255,n[14]=e>>>8&255,n[15]=e&255,n}var Vt=[];for(var Gd=0;Gd<256;++Gd)Vt.push((Gd+256).toString(16).slice(1));function oE(t,e=0){return(Vt[t[e+0]]+Vt[t[e+1]]+Vt[t[e+2]]+Vt[t[e+3]]+"-"+Vt[t[e+4]]+Vt[t[e+5]]+"-"+Vt[t[e+6]]+Vt[t[e+7]]+"-"+Vt[t[e+8]]+Vt[t[e+9]]+"-"+Vt[t[e+10]]+Vt[t[e+11]]+Vt[t[e+12]]+Vt[t[e+13]]+Vt[t[e+14]]+Vt[t[e+15]]).toLowerCase()}var $c,W1=new Uint8Array(16);function J1(){if(!$c&&($c=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!$c))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return $c(W1)}function Z1(t){t=unescape(encodeURIComponent(t));for(var e=[],n=0;n<t.length;++n)e.push(t.charCodeAt(n));return e}var K1="6ba7b810-9dad-11d1-80b4-00c04fd430c8",X1="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function Y1(t,e,n){function r(s,i,a,o){var c;if(typeof s=="string"&&(s=Z1(s)),typeof i=="string"&&(i=G1(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var u=new Uint8Array(16+s.length);if(u.set(i),u.set(s,i.length),u=n(u),u[6]=u[6]&15|e,u[8]=u[8]&63|128,a){o=o||0;for(var l=0;l<16;++l)a[o+l]=u[l];return a}return oE(u)}try{r.name=t}catch{}return r.DNS=K1,r.URL=X1,r}var Q1=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Xy={randomUUID:Q1};function Ji(t,e,n){if(Xy.randomUUID&&!t)return Xy.randomUUID();t=t||{};var r=t.random||(t.rng||J1)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,oE(r)}function eR(t,e,n,r){switch(t){case 0:return e&n^~e&r;case 1:return e^n^r;case 2:return e&n^e&r^n&r;case 3:return e^n^r}}function Wd(t,e){return t<<e|t>>>32-e}function tR(t){var e=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var r=unescape(encodeURIComponent(t));t=[];for(var s=0;s<r.length;++s)t.push(r.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var i=t.length/4+2,a=Math.ceil(i/16),o=new Array(a),c=0;c<a;++c){for(var u=new Uint32Array(16),l=0;l<16;++l)u[l]=t[c*64+l*4]<<24|t[c*64+l*4+1]<<16|t[c*64+l*4+2]<<8|t[c*64+l*4+3];o[c]=u}o[a-1][14]=(t.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var h=new Uint32Array(80),f=0;f<16;++f)h[f]=o[d][f];for(var m=16;m<80;++m)h[m]=Wd(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var g=n[0],_=n[1],b=n[2],y=n[3],E=n[4],C=0;C<80;++C){var k=Math.floor(C/20),R=Wd(g,5)+eR(k,_,b,y)+E+e[k]+h[C]>>>0;E=y,y=b,b=Wd(_,30)>>>0,_=g,g=R}n[0]=n[0]+g>>>0,n[1]=n[1]+_>>>0,n[2]=n[2]+b>>>0,n[3]=n[3]+y>>>0,n[4]=n[4]+E>>>0}return[n[0]>>24&255,n[0]>>16&255,n[0]>>8&255,n[0]&255,n[1]>>24&255,n[1]>>16&255,n[1]>>8&255,n[1]&255,n[2]>>24&255,n[2]>>16&255,n[2]>>8&255,n[2]&255,n[3]>>24&255,n[3]>>16&255,n[3]>>8&255,n[3]&255,n[4]>>24&255,n[4]>>16&255,n[4]>>8&255,n[4]&255]}var Yy=Y1("v5",80,tR);const nR="gen_ai.operation.name",rR="gen_ai.system",Qy="gen_ai.request.model",sR="gen_ai.response.model",e_="gen_ai.usage.input_tokens",t_="gen_ai.usage.output_tokens",n_="gen_ai.usage.total_tokens",iR="gen_ai.request.max_tokens",aR="gen_ai.request.temperature",oR="gen_ai.request.top_p",cR="gen_ai.request.frequency_penalty",uR="gen_ai.request.presence_penalty",lR="gen_ai.response.finish_reasons",dR="gen_ai.prompt",hR="gen_ai.completion",fR="gen_ai.request.extra_query",pR="gen_ai.request.extra_body",mR="gen_ai.serialized.name",gR="gen_ai.serialized.signature",yR="gen_ai.serialized.doc",_R="gen_ai.response.id",wR="gen_ai.response.service_tier",bR="gen_ai.response.system_fingerprint",vR="gen_ai.usage.input_token_details",ER="gen_ai.usage.output_token_details",SR="langsmith.trace.session_id",xR="langsmith.trace.session_name",TR="langsmith.span.kind",AR="langsmith.trace.name",CR="langsmith.metadata",r_="langsmith.span.tags",kR="langsmith.request.streaming",IR="langsmith.request.headers",RR=(...t)=>fetch(...t),cE=Symbol.for("ls:fetch_implementation"),OR=()=>{const t=globalThis[cE];return t?typeof t=="function"&&"Headers"in t&&"Request"in t&&"Response"in t:!1},$R=t=>async(...e)=>{if(t||En("DEBUG")==="true"){const[r,s]=e;console.log(`→ ${(s==null?void 0:s.method)||"GET"} ${r}`)}const n=await(globalThis[cE]??RR)(...e);return(t||En("DEBUG")==="true")&&console.log(`← ${n.status} ${n.statusText} ${n.url}`),n},uE=()=>En("PROJECT")??Gr("LANGCHAIN_SESSION")??"default",lE="0.3.74";var ho={};let Ar;const NR=()=>typeof window<"u"&&typeof window.document<"u",PR=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",LR=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),dE=()=>typeof Deno<"u",MR=()=>typeof Fr<"u"&&typeof Fr.versions<"u"&&typeof Fr.versions.node<"u"&&!dE(),hE=()=>Ar||(typeof Bun<"u"?Ar="bun":NR()?Ar="browser":MR()?Ar="node":PR()?Ar="webworker":LR()?Ar="jsdom":dE()?Ar="deno":Ar="other",Ar);let Jd;function fE(){if(Jd===void 0){const t=hE(),e=UR();Jd={library:"langsmith",runtime:t,sdk:"langsmith-js",sdk_version:lE,...e}}return Jd}function pE(){const t=DR(),e={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,s]of Object.entries(t))typeof s=="string"&&!n.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[r]=s);return e}function DR(){const t={};try{if(typeof Fr<"u"&&ho)for(const[e,n]of Object.entries(ho))(e.startsWith("LANGCHAIN_")||e.startsWith("LANGSMITH_"))&&n!=null&&((e.toLowerCase().includes("key")||e.toLowerCase().includes("secret")||e.toLowerCase().includes("token"))&&typeof n=="string"?t[e]=n.slice(0,2)+"*".repeat(n.length-4)+n.slice(-2):t[e]=n)}catch{}return t}function Gr(t){try{return typeof Fr<"u"?ho==null?void 0:ho[t]:void 0}catch{return}}function En(t){return Gr(`LANGSMITH_${t}`)||Gr(`LANGCHAIN_${t}`)}let Zd;function UR(){if(Zd!==void 0)return Zd;const t=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const n of t){const r=Gr(n);r!==void 0&&(e[n]=r)}return Zd=e,e}function mE(){return Gr("OTEL_ENABLED")==="true"||En("OTEL_ENABLED")==="true"}class BR{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...n){!this.hasWarned&&mE()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let r;if(n.length===1&&typeof n[0]=="function"?r=n[0]:n.length===2&&typeof n[1]=="function"?r=n[1]:n.length===3&&typeof n[2]=="function"&&(r=n[2]),typeof r=="function")return r()}}class jR{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new BR})}getTracer(e,n){return this.mockTracer}getActiveSpan(){}setSpan(e,n){return e}getSpan(e){}setSpanContext(e,n){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}}class FR{active(){return{}}with(e,n){return n()}}const Kd=Symbol.for("ls:otel_trace"),Xd=Symbol.for("ls:otel_context"),s_=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),zR=new jR,VR=new FR;class qR{getTraceInstance(){return globalThis[Kd]??zR}getContextInstance(){return globalThis[Xd]??VR}initializeGlobalInstances(e){globalThis[Kd]===void 0&&(globalThis[Kd]=e.trace),globalThis[Xd]===void 0&&(globalThis[Xd]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[s_]=e}getDefaultOTLPTracerComponents(){return globalThis[s_]??void 0}}const Bm=new qR;function gE(){return Bm.getTraceInstance()}function HR(){return Bm.getContextInstance()}function GR(){return Bm.getDefaultOTLPTracerComponents()}const WR={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function JR(t){return WR[t]||t}class ZR{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,n){for(const r of e)try{if(!r.run)continue;if(r.operation==="post"){const s=this.createSpanForRun(r,r.run,n.get(r.id));s&&!r.run.end_time&&this.spans.set(r.id,s)}else this.updateSpanForRun(r,r.run)}catch(s){console.error(`Error processing operation ${r.id}:`,s)}}createSpanForRun(e,n,r){const s=r&&gE().getSpan(r);if(s)try{return this.finishSpanSetup(s,n,e)}catch(i){console.error(`Failed to create span for run ${e.id}:`,i);return}}finishSpanSetup(e,n,r){return this.setSpanAttributes(e,n,r),n.error?(e.setStatus({code:2}),e.recordException(new Error(n.error))):e.setStatus({code:1}),n.end_time&&e.end(new Date(n.end_time)),e}updateSpanForRun(e,n){try{const r=this.spans.get(e.id);if(!r){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(r,n,e),n.error?(r.setStatus({code:2}),r.recordException(new Error(n.error))):r.setStatus({code:1});const s=n.end_time;s&&(r.end(new Date(s)),this.spans.delete(e.id))}catch(r){console.error(`Failed to update span for run ${e.id}:`,r)}}extractModelName(e){var n;if((n=e.extra)!=null&&n.metadata){const r=e.extra.metadata;if(r.ls_model_name)return r.ls_model_name;if(r.invocation_params){const s=r.invocation_params;if(s.model)return s.model;if(s.model_name)return s.model_name}}}setSpanAttributes(e,n,r){var o;if("run_type"in n&&n.run_type){e.setAttribute(TR,n.run_type);const c=JR(n.run_type||"chain");e.setAttribute(nR,c)}"name"in n&&n.name&&e.setAttribute(AR,n.name),"session_id"in n&&n.session_id&&e.setAttribute(SR,n.session_id),"session_name"in n&&n.session_name&&e.setAttribute(xR,n.session_name),this.setGenAiSystem(e,n);const s=this.extractModelName(n);s&&e.setAttribute(Qy,s),"prompt_tokens"in n&&typeof n.prompt_tokens=="number"&&e.setAttribute(e_,n.prompt_tokens),"completion_tokens"in n&&typeof n.completion_tokens=="number"&&e.setAttribute(t_,n.completion_tokens),"total_tokens"in n&&typeof n.total_tokens=="number"&&e.setAttribute(n_,n.total_tokens),this.setInvocationParameters(e,n);const i=((o=n.extra)==null?void 0:o.metadata)||{};for(const[c,u]of Object.entries(i))u!=null&&e.setAttribute(`${CR}.${c}`,String(u));const a=n.tags;if(a&&Array.isArray(a)?e.setAttribute(r_,a.join(", ")):a&&e.setAttribute(r_,String(a)),"serialized"in n&&typeof n.serialized=="object"){const c=n.serialized;c.name&&e.setAttribute(mR,String(c.name)),c.signature&&e.setAttribute(gR,String(c.signature)),c.doc&&e.setAttribute(yR,String(c.doc))}this.setIOAttributes(e,r)}setGenAiSystem(e,n){let r="langchain";const s=this.extractModelName(n);if(s){const i=s.toLowerCase();i.includes("anthropic")||i.startsWith("claude")?r="anthropic":i.includes("bedrock")?r="aws.bedrock":i.includes("azure")&&i.includes("openai")?r="az.ai.openai":i.includes("azure")&&i.includes("inference")?r="az.ai.inference":i.includes("cohere")?r="cohere":i.includes("deepseek")?r="deepseek":i.includes("gemini")?r="gemini":i.includes("groq")?r="groq":i.includes("watson")||i.includes("ibm")?r="ibm.watsonx.ai":i.includes("mistral")?r="mistral_ai":i.includes("gpt")||i.includes("openai")?r="openai":i.includes("perplexity")||i.includes("sonar")?r="perplexity":i.includes("vertex")?r="vertex_ai":(i.includes("xai")||i.includes("grok"))&&(r="xai")}e.setAttribute(rR,r)}setInvocationParameters(e,n){var s,i;if(!((i=(s=n.extra)==null?void 0:s.metadata)!=null&&i.invocation_params))return;const r=n.extra.metadata.invocation_params;r.max_tokens!==void 0&&e.setAttribute(iR,r.max_tokens),r.temperature!==void 0&&e.setAttribute(aR,r.temperature),r.top_p!==void 0&&e.setAttribute(oR,r.top_p),r.frequency_penalty!==void 0&&e.setAttribute(cR,r.frequency_penalty),r.presence_penalty!==void 0&&e.setAttribute(uR,r.presence_penalty)}setIOAttributes(e,n){if(n.run.inputs)try{const r=n.run.inputs;typeof r=="object"&&r!==null&&(r.model&&Array.isArray(r.messages)&&e.setAttribute(Qy,r.model),r.stream!==void 0&&e.setAttribute(kR,r.stream),r.extra_headers&&e.setAttribute(IR,JSON.stringify(r.extra_headers)),r.extra_query&&e.setAttribute(fR,JSON.stringify(r.extra_query)),r.extra_body&&e.setAttribute(pR,JSON.stringify(r.extra_body))),e.setAttribute(dR,JSON.stringify(r))}catch(r){console.debug(`Failed to process inputs for run ${n.id}`,r)}if(n.run.outputs)try{const r=n.run.outputs,s=this.getUnifiedRunTokens(r);if(s&&(e.setAttribute(e_,s[0]),e.setAttribute(t_,s[1]),e.setAttribute(n_,s[0]+s[1])),r&&typeof r=="object"){if(r.model&&e.setAttribute(sR,String(r.model)),r.id&&e.setAttribute(_R,r.id),r.choices&&Array.isArray(r.choices)){const i=r.choices.map(a=>a.finish_reason).filter(a=>a).map(String);i.length>0&&e.setAttribute(lR,i.join(", "))}if(r.service_tier&&e.setAttribute(wR,r.service_tier),r.system_fingerprint&&e.setAttribute(bR,r.system_fingerprint),r.usage_metadata&&typeof r.usage_metadata=="object"){const i=r.usage_metadata;i.input_token_details&&e.setAttribute(vR,JSON.stringify(i.input_token_details)),i.output_token_details&&e.setAttribute(ER,JSON.stringify(i.output_token_details))}}e.setAttribute(hR,JSON.stringify(r))}catch(r){console.debug(`Failed to process outputs for run ${n.id}`,r)}}getUnifiedRunTokens(e){if(!e)return null;let n=this.extractUnifiedRunTokens(e.usage_metadata);if(n)return n;const r=Object.keys(e);for(const a of r){const o=e[a];if(!(!o||typeof o!="object")&&(n=this.extractUnifiedRunTokens(o.usage_metadata),n||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(n=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),n)))return n}const s=e.generations||[];if(!Array.isArray(s))return null;const i=Array.isArray(s[0])?s.flat():s;for(const a of i)if(typeof a=="object"&&a.message&&typeof a.message=="object"&&a.message.kwargs&&typeof a.message.kwargs=="object"&&(n=this.extractUnifiedRunTokens(a.message.kwargs.usage_metadata),n))return n;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}var Fa={exports:{}},Yd={},Qd,i_;function KR(){if(i_)return Qd;i_=1;function t(e,n){typeof n=="boolean"&&(n={forever:n}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=n||{},this._maxRetryTime=n&&n.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return Qd=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var n=new Date().getTime();if(e&&n-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},r),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,n){this._fn=e,n&&(n.timeout&&(this._operationTimeout=n.timeout),n.cb&&(this._operationTimeoutCb=n.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},n=null,r=0,s=0;s<this._errors.length;s++){var i=this._errors[s],a=i.message,o=(e[a]||0)+1;e[a]=o,o>=r&&(n=i,r=o)}return n},Qd}var a_;function XR(){return a_||(a_=1,(function(t){var e=KR();t.operation=function(n){var r=t.timeouts(n);return new e(r,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})},t.timeouts=function(n){if(n instanceof Array)return[].concat(n);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in n)r[s]=n[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],a=0;a<r.retries;a++)i.push(this.createTimeout(a,r));return n&&n.forever&&!i.length&&i.push(this.createTimeout(a,r)),i.sort(function(o,c){return o-c}),i},t.createTimeout=function(n,r){var s=r.randomize?Math.random()+1:1,i=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,n));return i=Math.min(i,r.maxTimeout),i},t.wrap=function(n,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var i in n)typeof n[i]=="function"&&s.push(i)}for(var a=0;a<s.length;a++){var o=s[a],c=n[o];n[o]=(function(l){var d=t.operation(r),h=Array.prototype.slice.call(arguments,1),f=h.pop();h.push(function(m){d.retry(m)||(m&&(arguments[0]=d.mainError()),f.apply(this,arguments))}),d.attempt(function(){l.apply(n,h)})}).bind(n,c),n[o].options=r}}})(Yd)),Yd}var eh,o_;function YR(){return o_||(o_=1,eh=XR()),eh}var c_;function QR(){if(c_)return Fa.exports;c_=1;const t=YR(),e=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class n extends Error{constructor(o){super(),o instanceof Error?(this.originalError=o,{message:o}=o):(this.originalError=new Error(o),this.originalError.stack=this.stack),this.name="AbortError",this.message=o}}const r=(a,o,c)=>{const u=c.retries-(o-1);return a.attemptNumber=o,a.retriesLeft=u,a},s=a=>e.includes(a),i=(a,o)=>new Promise((c,u)=>{o={onFailedAttempt:()=>{},retries:10,...o};const l=t.operation(o);l.attempt(async d=>{try{c(await a(d))}catch(h){if(!(h instanceof Error)){u(new TypeError(`Non-error was thrown: "${h}". You should only throw errors.`));return}if(h instanceof n)l.stop(),u(h.originalError);else if(h instanceof TypeError&&!s(h.message))l.stop(),u(h);else{r(h,d,o);try{await o.onFailedAttempt(h)}catch(f){u(f);return}l.retry(h)||u(l.mainError())}}})});return Fa.exports=i,Fa.exports.default=i,Fa.exports.AbortError=n,Fa.exports}var eO=QR();const Vu=Ra(eO);var Nc={},th={exports:{}},u_;function tO(){return u_||(u_=1,(function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1));function s(c,u,l){this.fn=c,this.context=u,this.once=l||!1}function i(c,u,l,d,h){if(typeof l!="function")throw new TypeError("The listener must be a function");var f=new s(l,d||c,h),m=n?n+u:u;return c._events[m]?c._events[m].fn?c._events[m]=[c._events[m],f]:c._events[m].push(f):(c._events[m]=f,c._eventsCount++),c}function a(c,u){--c._eventsCount===0?c._events=new r:delete c._events[u]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var u=[],l,d;if(this._eventsCount===0)return u;for(d in l=this._events)e.call(l,d)&&u.push(n?d.slice(1):d);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(l)):u},o.prototype.listeners=function(u){var l=n?n+u:u,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,m=new Array(f);h<f;h++)m[h]=d[h].fn;return m},o.prototype.listenerCount=function(u){var l=n?n+u:u,d=this._events[l];return d?d.fn?1:d.length:0},o.prototype.emit=function(u,l,d,h,f,m){var g=n?n+u:u;if(!this._events[g])return!1;var _=this._events[g],b=arguments.length,y,E;if(_.fn){switch(_.once&&this.removeListener(u,_.fn,void 0,!0),b){case 1:return _.fn.call(_.context),!0;case 2:return _.fn.call(_.context,l),!0;case 3:return _.fn.call(_.context,l,d),!0;case 4:return _.fn.call(_.context,l,d,h),!0;case 5:return _.fn.call(_.context,l,d,h,f),!0;case 6:return _.fn.call(_.context,l,d,h,f,m),!0}for(E=1,y=new Array(b-1);E<b;E++)y[E-1]=arguments[E];_.fn.apply(_.context,y)}else{var C=_.length,k;for(E=0;E<C;E++)switch(_[E].once&&this.removeListener(u,_[E].fn,void 0,!0),b){case 1:_[E].fn.call(_[E].context);break;case 2:_[E].fn.call(_[E].context,l);break;case 3:_[E].fn.call(_[E].context,l,d);break;case 4:_[E].fn.call(_[E].context,l,d,h);break;default:if(!y)for(k=1,y=new Array(b-1);k<b;k++)y[k-1]=arguments[k];_[E].fn.apply(_[E].context,y)}}return!0},o.prototype.on=function(u,l,d){return i(this,u,l,d,!1)},o.prototype.once=function(u,l,d){return i(this,u,l,d,!0)},o.prototype.removeListener=function(u,l,d,h){var f=n?n+u:u;if(!this._events[f])return this;if(!l)return a(this,f),this;var m=this._events[f];if(m.fn)m.fn===l&&(!h||m.once)&&(!d||m.context===d)&&a(this,f);else{for(var g=0,_=[],b=m.length;g<b;g++)(m[g].fn!==l||h&&!m[g].once||d&&m[g].context!==d)&&_.push(m[g]);_.length?this._events[f]=_.length===1?_[0]:_:a(this,f)}return this},o.prototype.removeAllListeners=function(u){var l;return u?(l=n?n+u:u,this._events[l]&&a(this,l)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,t.exports=o})(th)),th.exports}var za={exports:{}},nh,l_;function nO(){return l_||(l_=1,nh=(t,e)=>(e=e||(()=>{}),t.then(n=>new Promise(r=>{r(e())}).then(()=>n),n=>new Promise(r=>{r(e())}).then(()=>{throw n})))),nh}var d_;function rO(){if(d_)return za.exports;d_=1;const t=nO();class e extends Error{constructor(s){super(s),this.name="TimeoutError"}}const n=(r,s,i)=>new Promise((a,o)=>{if(typeof s!="number"||s<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(s===1/0){a(r);return}const c=setTimeout(()=>{if(typeof i=="function"){try{a(i())}catch(d){o(d)}return}const u=typeof i=="string"?i:`Promise timed out after ${s} milliseconds`,l=i instanceof Error?i:new e(u);typeof r.cancel=="function"&&r.cancel(),o(l)},s);t(r.then(a,o),()=>{clearTimeout(c)})});return za.exports=n,za.exports.default=n,za.exports.TimeoutError=e,za.exports}var Pc={},Lc={},h_;function sO(){if(h_)return Lc;h_=1,Object.defineProperty(Lc,"__esModule",{value:!0});function t(e,n,r){let s=0,i=e.length;for(;i>0;){const a=i/2|0;let o=s+a;r(e[o],n)<=0?(s=++o,i-=a+1):i=a}return s}return Lc.default=t,Lc}var f_;function iO(){if(f_)return Pc;f_=1,Object.defineProperty(Pc,"__esModule",{value:!0});const t=sO();class e{constructor(){this._queue=[]}enqueue(r,s){s=Object.assign({priority:0},s);const i={priority:s.priority,run:r};if(this.size&&this._queue[this.size-1].priority>=s.priority){this._queue.push(i);return}const a=t.default(this._queue,i,(o,c)=>c.priority-o.priority);this._queue.splice(a,0,i)}dequeue(){const r=this._queue.shift();return r==null?void 0:r.run}filter(r){return this._queue.filter(s=>s.priority===r.priority).map(s=>s.run)}get size(){return this._queue.length}}return Pc.default=e,Pc}var p_;function aO(){if(p_)return Nc;p_=1,Object.defineProperty(Nc,"__esModule",{value:!0});const t=tO(),e=rO(),n=iO(),r=()=>{},s=new e.TimeoutError;class i extends t{constructor(o){var c,u,l,d;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=r,this._resolveIdle=r,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:n.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(u=(c=o.intervalCap)===null||c===void 0?void 0:c.toString())!==null&&u!==void 0?u:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(d=(l=o.interval)===null||l===void 0?void 0:l.toString())!==null&&d!==void 0?d:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=r,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=r,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const o=Date.now();if(this._intervalId===void 0){const c=this._intervalEnd-o;if(c<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},c)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const c=this._queue.dequeue();return c?(this.emit("active"),c(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,c={}){return new Promise((u,l)=>{const d=async()=>{this._pendingCount++,this._intervalCount++;try{const h=this._timeout===void 0&&c.timeout===void 0?o():e.default(Promise.resolve(o()),c.timeout===void 0?this._timeout:c.timeout,()=>{(c.throwOnTimeout===void 0?this._throwOnTimeout:c.throwOnTimeout)&&l(s)});u(await h)}catch(h){l(h)}this._next()};this._queue.enqueue(d,c),this._tryToStartAnother(),this.emit("add")})}async addAll(o,c){return Promise.all(o.map(async u=>this.add(u,c)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{const c=this._resolveEmpty;this._resolveEmpty=()=>{c(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{const c=this._resolveIdle;this._resolveIdle=()=>{c(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}}return Nc.default=i,Nc}var oO=aO();const us=Ra(oO),cO=[429,500,502,503,504];let m_=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in us?this.queue=new us.default({concurrency:this.maxConcurrency}):this.queue=new us({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...n){const r=this.onFailedResponseHook;return this.queue.add(()=>Vu(()=>e(...n).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.name==="TimeoutError"||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;const i=s==null?void 0:s.response;if(r&&await r(i))return;const a=(i==null?void 0:i.status)??(s==null?void 0:s.status);if(a&&!cO.includes(+a))throw s},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,n,...r){return e.signal?Promise.race([this.call(n,...r),new Promise((s,i)=>{var a;(a=e.signal)==null||a.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(n,...r)}};function g_(t){return typeof(t==null?void 0:t._getType)=="function"}function y_(t){const e={type:t._getType(),data:{content:t.content}};return t!=null&&t.additional_kwargs&&Object.keys(t.additional_kwargs).length>0&&(e.data.additional_kwargs={...t.additional_kwargs}),e}const uO=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function Oe(t,e){if(!uO.test(t)){const n=e!==void 0?`Invalid UUID for ${e}: ${t}`:`Invalid UUID: ${t}`;throw new Error(n)}return t}const __={};function Xf(t){__[t]||(console.warn(t),__[t]=!0)}var Mc={exports:{}},rh,w_;function Gl(){if(w_)return rh;w_=1;const t="2.0.0",e=256,n=Number.MAX_SAFE_INTEGER||9007199254740991,r=16,s=e-6;return rh={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:s,MAX_SAFE_INTEGER:n,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:t,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},rh}var sh,b_;function Wl(){if(b_)return sh;b_=1;var t={};return sh=typeof Fr=="object"&&t&&t.NODE_DEBUG&&/\bsemver\b/i.test(t.NODE_DEBUG)?(...n)=>console.error("SEMVER",...n):()=>{},sh}var v_;function sc(){return v_||(v_=1,(function(t,e){const{MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:s}=Gl(),i=Wl();e=t.exports={};const a=e.re=[],o=e.safeRe=[],c=e.src=[],u=e.safeSrc=[],l=e.t={};let d=0;const h="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",s],[h,r]],m=_=>{for(const[b,y]of f)_=_.split(`${b}*`).join(`${b}{0,${y}}`).split(`${b}+`).join(`${b}{1,${y}}`);return _},g=(_,b,y)=>{const E=m(b),C=d++;i(_,C,b),l[_]=C,c[C]=b,u[C]=E,a[C]=new RegExp(b,y?"g":void 0),o[C]=new RegExp(E,y?"g":void 0)};g("NUMERICIDENTIFIER","0|[1-9]\\d*"),g("NUMERICIDENTIFIERLOOSE","\\d+"),g("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),g("MAINVERSION",`(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})`),g("MAINVERSIONLOOSE",`(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})`),g("PRERELEASEIDENTIFIER",`(?:${c[l.NONNUMERICIDENTIFIER]}|${c[l.NUMERICIDENTIFIER]})`),g("PRERELEASEIDENTIFIERLOOSE",`(?:${c[l.NONNUMERICIDENTIFIER]}|${c[l.NUMERICIDENTIFIERLOOSE]})`),g("PRERELEASE",`(?:-(${c[l.PRERELEASEIDENTIFIER]}(?:\\.${c[l.PRERELEASEIDENTIFIER]})*))`),g("PRERELEASELOOSE",`(?:-?(${c[l.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[l.PRERELEASEIDENTIFIERLOOSE]})*))`),g("BUILDIDENTIFIER",`${h}+`),g("BUILD",`(?:\\+(${c[l.BUILDIDENTIFIER]}(?:\\.${c[l.BUILDIDENTIFIER]})*))`),g("FULLPLAIN",`v?${c[l.MAINVERSION]}${c[l.PRERELEASE]}?${c[l.BUILD]}?`),g("FULL",`^${c[l.FULLPLAIN]}$`),g("LOOSEPLAIN",`[v=\\s]*${c[l.MAINVERSIONLOOSE]}${c[l.PRERELEASELOOSE]}?${c[l.BUILD]}?`),g("LOOSE",`^${c[l.LOOSEPLAIN]}$`),g("GTLT","((?:<|>)?=?)"),g("XRANGEIDENTIFIERLOOSE",`${c[l.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),g("XRANGEIDENTIFIER",`${c[l.NUMERICIDENTIFIER]}|x|X|\\*`),g("XRANGEPLAIN",`[v=\\s]*(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:${c[l.PRERELEASE]})?${c[l.BUILD]}?)?)?`),g("XRANGEPLAINLOOSE",`[v=\\s]*(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:${c[l.PRERELEASELOOSE]})?${c[l.BUILD]}?)?)?`),g("XRANGE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAIN]}$`),g("XRANGELOOSE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAINLOOSE]}$`),g("COERCEPLAIN",`(^|[^\\d])(\\d{1,${n}})(?:\\.(\\d{1,${n}}))?(?:\\.(\\d{1,${n}}))?`),g("COERCE",`${c[l.COERCEPLAIN]}(?:$|[^\\d])`),g("COERCEFULL",c[l.COERCEPLAIN]+`(?:${c[l.PRERELEASE]})?(?:${c[l.BUILD]})?(?:$|[^\\d])`),g("COERCERTL",c[l.COERCE],!0),g("COERCERTLFULL",c[l.COERCEFULL],!0),g("LONETILDE","(?:~>?)"),g("TILDETRIM",`(\\s*)${c[l.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",g("TILDE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAIN]}$`),g("TILDELOOSE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAINLOOSE]}$`),g("LONECARET","(?:\\^)"),g("CARETTRIM",`(\\s*)${c[l.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",g("CARET",`^${c[l.LONECARET]}${c[l.XRANGEPLAIN]}$`),g("CARETLOOSE",`^${c[l.LONECARET]}${c[l.XRANGEPLAINLOOSE]}$`),g("COMPARATORLOOSE",`^${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]})$|^$`),g("COMPARATOR",`^${c[l.GTLT]}\\s*(${c[l.FULLPLAIN]})$|^$`),g("COMPARATORTRIM",`(\\s*)${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]}|${c[l.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",g("HYPHENRANGE",`^\\s*(${c[l.XRANGEPLAIN]})\\s+-\\s+(${c[l.XRANGEPLAIN]})\\s*$`),g("HYPHENRANGELOOSE",`^\\s*(${c[l.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[l.XRANGEPLAINLOOSE]})\\s*$`),g("STAR","(<|>)?=?\\s*\\*"),g("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),g("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(Mc,Mc.exports)),Mc.exports}var ih,E_;function jm(){if(E_)return ih;E_=1;const t=Object.freeze({loose:!0}),e=Object.freeze({});return ih=r=>r?typeof r!="object"?t:r:e,ih}var ah,S_;function yE(){if(S_)return ah;S_=1;const t=/^[0-9]+$/,e=(r,s)=>{if(typeof r=="number"&&typeof s=="number")return r===s?0:r<s?-1:1;const i=t.test(r),a=t.test(s);return i&&a&&(r=+r,s=+s),r===s?0:i&&!a?-1:a&&!i?1:r<s?-1:1};return ah={compareIdentifiers:e,rcompareIdentifiers:(r,s)=>e(s,r)},ah}var oh,x_;function pn(){if(x_)return oh;x_=1;const t=Wl(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:n}=Gl(),{safeRe:r,t:s}=sc(),i=jm(),{compareIdentifiers:a}=yE();class o{constructor(u,l){if(l=i(l),u instanceof o){if(u.loose===!!l.loose&&u.includePrerelease===!!l.includePrerelease)return u;u=u.version}else if(typeof u!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof u}".`);if(u.length>e)throw new TypeError(`version is longer than ${e} characters`);t("SemVer",u,l),this.options=l,this.loose=!!l.loose,this.includePrerelease=!!l.includePrerelease;const d=u.trim().match(l.loose?r[s.LOOSE]:r[s.FULL]);if(!d)throw new TypeError(`Invalid Version: ${u}`);if(this.raw=u,this.major=+d[1],this.minor=+d[2],this.patch=+d[3],this.major>n||this.major<0)throw new TypeError("Invalid major version");if(this.minor>n||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>n||this.patch<0)throw new TypeError("Invalid patch version");d[4]?this.prerelease=d[4].split(".").map(h=>{if(/^[0-9]+$/.test(h)){const f=+h;if(f>=0&&f<n)return f}return h}):this.prerelease=[],this.build=d[5]?d[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(u){if(t("SemVer.compare",this.version,this.options,u),!(u instanceof o)){if(typeof u=="string"&&u===this.version)return 0;u=new o(u,this.options)}return u.version===this.version?0:this.compareMain(u)||this.comparePre(u)}compareMain(u){return u instanceof o||(u=new o(u,this.options)),this.major<u.major?-1:this.major>u.major?1:this.minor<u.minor?-1:this.minor>u.minor?1:this.patch<u.patch?-1:this.patch>u.patch?1:0}comparePre(u){if(u instanceof o||(u=new o(u,this.options)),this.prerelease.length&&!u.prerelease.length)return-1;if(!this.prerelease.length&&u.prerelease.length)return 1;if(!this.prerelease.length&&!u.prerelease.length)return 0;let l=0;do{const d=this.prerelease[l],h=u.prerelease[l];if(t("prerelease compare",l,d,h),d===void 0&&h===void 0)return 0;if(h===void 0)return 1;if(d===void 0)return-1;if(d===h)continue;return a(d,h)}while(++l)}compareBuild(u){u instanceof o||(u=new o(u,this.options));let l=0;do{const d=this.build[l],h=u.build[l];if(t("build compare",l,d,h),d===void 0&&h===void 0)return 0;if(h===void 0)return 1;if(d===void 0)return-1;if(d===h)continue;return a(d,h)}while(++l)}inc(u,l,d){if(u.startsWith("pre")){if(!l&&d===!1)throw new Error("invalid increment argument: identifier is empty");if(l){const h=`-${l}`.match(this.options.loose?r[s.PRERELEASELOOSE]:r[s.PRERELEASE]);if(!h||h[1]!==l)throw new Error(`invalid identifier: ${l}`)}}switch(u){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",l,d);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",l,d);break;case"prepatch":this.prerelease.length=0,this.inc("patch",l,d),this.inc("pre",l,d);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",l,d),this.inc("pre",l,d);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const h=Number(d)?1:0;if(this.prerelease.length===0)this.prerelease=[h];else{let f=this.prerelease.length;for(;--f>=0;)typeof this.prerelease[f]=="number"&&(this.prerelease[f]++,f=-2);if(f===-1){if(l===this.prerelease.join(".")&&d===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(h)}}if(l){let f=[l,h];d===!1&&(f=[l]),a(this.prerelease[0],l)===0?isNaN(this.prerelease[1])&&(this.prerelease=f):this.prerelease=f}break}default:throw new Error(`invalid increment argument: ${u}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return oh=o,oh}var ch,T_;function $a(){if(T_)return ch;T_=1;const t=pn();return ch=(n,r,s=!1)=>{if(n instanceof t)return n;try{return new t(n,r)}catch(i){if(!s)return null;throw i}},ch}var uh,A_;function lO(){if(A_)return uh;A_=1;const t=$a();return uh=(n,r)=>{const s=t(n,r);return s?s.version:null},uh}var lh,C_;function dO(){if(C_)return lh;C_=1;const t=$a();return lh=(n,r)=>{const s=t(n.trim().replace(/^[=v]+/,""),r);return s?s.version:null},lh}var dh,k_;function hO(){if(k_)return dh;k_=1;const t=pn();return dh=(n,r,s,i,a)=>{typeof s=="string"&&(a=i,i=s,s=void 0);try{return new t(n instanceof t?n.version:n,s).inc(r,i,a).version}catch{return null}},dh}var hh,I_;function fO(){if(I_)return hh;I_=1;const t=$a();return hh=(n,r)=>{const s=t(n,null,!0),i=t(r,null,!0),a=s.compare(i);if(a===0)return null;const o=a>0,c=o?s:i,u=o?i:s,l=!!c.prerelease.length;if(!!u.prerelease.length&&!l){if(!u.patch&&!u.minor)return"major";if(u.compareMain(c)===0)return u.minor&&!u.patch?"minor":"patch"}const h=l?"pre":"";return s.major!==i.major?h+"major":s.minor!==i.minor?h+"minor":s.patch!==i.patch?h+"patch":"prerelease"},hh}var fh,R_;function pO(){if(R_)return fh;R_=1;const t=pn();return fh=(n,r)=>new t(n,r).major,fh}var ph,O_;function mO(){if(O_)return ph;O_=1;const t=pn();return ph=(n,r)=>new t(n,r).minor,ph}var mh,$_;function gO(){if($_)return mh;$_=1;const t=pn();return mh=(n,r)=>new t(n,r).patch,mh}var gh,N_;function yO(){if(N_)return gh;N_=1;const t=$a();return gh=(n,r)=>{const s=t(n,r);return s&&s.prerelease.length?s.prerelease:null},gh}var yh,P_;function Sr(){if(P_)return yh;P_=1;const t=pn();return yh=(n,r,s)=>new t(n,s).compare(new t(r,s)),yh}var _h,L_;function _O(){if(L_)return _h;L_=1;const t=Sr();return _h=(n,r,s)=>t(r,n,s),_h}var wh,M_;function wO(){if(M_)return wh;M_=1;const t=Sr();return wh=(n,r)=>t(n,r,!0),wh}var bh,D_;function Fm(){if(D_)return bh;D_=1;const t=pn();return bh=(n,r,s)=>{const i=new t(n,s),a=new t(r,s);return i.compare(a)||i.compareBuild(a)},bh}var vh,U_;function bO(){if(U_)return vh;U_=1;const t=Fm();return vh=(n,r)=>n.sort((s,i)=>t(s,i,r)),vh}var Eh,B_;function vO(){if(B_)return Eh;B_=1;const t=Fm();return Eh=(n,r)=>n.sort((s,i)=>t(i,s,r)),Eh}var Sh,j_;function Jl(){if(j_)return Sh;j_=1;const t=Sr();return Sh=(n,r,s)=>t(n,r,s)>0,Sh}var xh,F_;function zm(){if(F_)return xh;F_=1;const t=Sr();return xh=(n,r,s)=>t(n,r,s)<0,xh}var Th,z_;function _E(){if(z_)return Th;z_=1;const t=Sr();return Th=(n,r,s)=>t(n,r,s)===0,Th}var Ah,V_;function wE(){if(V_)return Ah;V_=1;const t=Sr();return Ah=(n,r,s)=>t(n,r,s)!==0,Ah}var Ch,q_;function Vm(){if(q_)return Ch;q_=1;const t=Sr();return Ch=(n,r,s)=>t(n,r,s)>=0,Ch}var kh,H_;function qm(){if(H_)return kh;H_=1;const t=Sr();return kh=(n,r,s)=>t(n,r,s)<=0,kh}var Ih,G_;function bE(){if(G_)return Ih;G_=1;const t=_E(),e=wE(),n=Jl(),r=Vm(),s=zm(),i=qm();return Ih=(o,c,u,l)=>{switch(c){case"===":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o===u;case"!==":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o!==u;case"":case"=":case"==":return t(o,u,l);case"!=":return e(o,u,l);case">":return n(o,u,l);case">=":return r(o,u,l);case"<":return s(o,u,l);case"<=":return i(o,u,l);default:throw new TypeError(`Invalid operator: ${c}`)}},Ih}var Rh,W_;function EO(){if(W_)return Rh;W_=1;const t=pn(),e=$a(),{safeRe:n,t:r}=sc();return Rh=(i,a)=>{if(i instanceof t)return i;if(typeof i=="number"&&(i=String(i)),typeof i!="string")return null;a=a||{};let o=null;if(!a.rtl)o=i.match(a.includePrerelease?n[r.COERCEFULL]:n[r.COERCE]);else{const f=a.includePrerelease?n[r.COERCERTLFULL]:n[r.COERCERTL];let m;for(;(m=f.exec(i))&&(!o||o.index+o[0].length!==i.length);)(!o||m.index+m[0].length!==o.index+o[0].length)&&(o=m),f.lastIndex=m.index+m[1].length+m[2].length;f.lastIndex=-1}if(o===null)return null;const c=o[2],u=o[3]||"0",l=o[4]||"0",d=a.includePrerelease&&o[5]?`-${o[5]}`:"",h=a.includePrerelease&&o[6]?`+${o[6]}`:"";return e(`${c}.${u}.${l}${d}${h}`,a)},Rh}var Oh,J_;function SO(){if(J_)return Oh;J_=1;class t{constructor(){this.max=1e3,this.map=new Map}get(n){const r=this.map.get(n);if(r!==void 0)return this.map.delete(n),this.map.set(n,r),r}delete(n){return this.map.delete(n)}set(n,r){if(!this.delete(n)&&r!==void 0){if(this.map.size>=this.max){const i=this.map.keys().next().value;this.delete(i)}this.map.set(n,r)}return this}}return Oh=t,Oh}var $h,Z_;function xr(){if(Z_)return $h;Z_=1;const t=/\s+/g;class e{constructor(F,H){if(H=s(H),F instanceof e)return F.loose===!!H.loose&&F.includePrerelease===!!H.includePrerelease?F:new e(F.raw,H);if(F instanceof i)return this.raw=F.value,this.set=[[F]],this.formatted=void 0,this;if(this.options=H,this.loose=!!H.loose,this.includePrerelease=!!H.includePrerelease,this.raw=F.trim().replace(t," "),this.set=this.raw.split("||").map(re=>this.parseRange(re.trim())).filter(re=>re.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const re=this.set[0];if(this.set=this.set.filter(ue=>!g(ue[0])),this.set.length===0)this.set=[re];else if(this.set.length>1){for(const ue of this.set)if(ue.length===1&&_(ue[0])){this.set=[ue];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let F=0;F<this.set.length;F++){F>0&&(this.formatted+="||");const H=this.set[F];for(let re=0;re<H.length;re++)re>0&&(this.formatted+=" "),this.formatted+=H[re].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(F){const re=((this.options.includePrerelease&&f)|(this.options.loose&&m))+":"+F,ue=r.get(re);if(ue)return ue;const ne=this.options.loose,fe=ne?c[u.HYPHENRANGELOOSE]:c[u.HYPHENRANGE];F=F.replace(fe,ie(this.options.includePrerelease)),a("hyphen replace",F),F=F.replace(c[u.COMPARATORTRIM],l),a("comparator trim",F),F=F.replace(c[u.TILDETRIM],d),a("tilde trim",F),F=F.replace(c[u.CARETTRIM],h),a("caret trim",F);let Ce=F.split(" ").map(Z=>y(Z,this.options)).join(" ").split(/\s+/).map(Z=>q(Z,this.options));ne&&(Ce=Ce.filter(Z=>(a("loose invalid filter",Z,this.options),!!Z.match(c[u.COMPARATORLOOSE])))),a("range list",Ce);const J=new Map,Q=Ce.map(Z=>new i(Z,this.options));for(const Z of Q){if(g(Z))return[Z];J.set(Z.value,Z)}J.size>1&&J.has("")&&J.delete("");const ae=[...J.values()];return r.set(re,ae),ae}intersects(F,H){if(!(F instanceof e))throw new TypeError("a Range is required");return this.set.some(re=>b(re,H)&&F.set.some(ue=>b(ue,H)&&re.every(ne=>ue.every(fe=>ne.intersects(fe,H)))))}test(F){if(!F)return!1;if(typeof F=="string")try{F=new o(F,this.options)}catch{return!1}for(let H=0;H<this.set.length;H++)if(me(this.set[H],F,this.options))return!0;return!1}}$h=e;const n=SO(),r=new n,s=jm(),i=Zl(),a=Wl(),o=pn(),{safeRe:c,t:u,comparatorTrimReplace:l,tildeTrimReplace:d,caretTrimReplace:h}=sc(),{FLAG_INCLUDE_PRERELEASE:f,FLAG_LOOSE:m}=Gl(),g=j=>j.value==="<0.0.0-0",_=j=>j.value==="",b=(j,F)=>{let H=!0;const re=j.slice();let ue=re.pop();for(;H&&re.length;)H=re.every(ne=>ue.intersects(ne,F)),ue=re.pop();return H},y=(j,F)=>(j=j.replace(c[u.BUILD],""),a("comp",j,F),j=R(j,F),a("caret",j),j=C(j,F),a("tildes",j),j=T(j,F),a("xrange",j),j=z(j,F),a("stars",j),j),E=j=>!j||j.toLowerCase()==="x"||j==="*",C=(j,F)=>j.trim().split(/\s+/).map(H=>k(H,F)).join(" "),k=(j,F)=>{const H=F.loose?c[u.TILDELOOSE]:c[u.TILDE];return j.replace(H,(re,ue,ne,fe,Ce)=>{a("tilde",j,re,ue,ne,fe,Ce);let J;return E(ue)?J="":E(ne)?J=`>=${ue}.0.0 <${+ue+1}.0.0-0`:E(fe)?J=`>=${ue}.${ne}.0 <${ue}.${+ne+1}.0-0`:Ce?(a("replaceTilde pr",Ce),J=`>=${ue}.${ne}.${fe}-${Ce} <${ue}.${+ne+1}.0-0`):J=`>=${ue}.${ne}.${fe} <${ue}.${+ne+1}.0-0`,a("tilde return",J),J})},R=(j,F)=>j.trim().split(/\s+/).map(H=>$(H,F)).join(" "),$=(j,F)=>{a("caret",j,F);const H=F.loose?c[u.CARETLOOSE]:c[u.CARET],re=F.includePrerelease?"-0":"";return j.replace(H,(ue,ne,fe,Ce,J)=>{a("caret",j,ue,ne,fe,Ce,J);let Q;return E(ne)?Q="":E(fe)?Q=`>=${ne}.0.0${re} <${+ne+1}.0.0-0`:E(Ce)?ne==="0"?Q=`>=${ne}.${fe}.0${re} <${ne}.${+fe+1}.0-0`:Q=`>=${ne}.${fe}.0${re} <${+ne+1}.0.0-0`:J?(a("replaceCaret pr",J),ne==="0"?fe==="0"?Q=`>=${ne}.${fe}.${Ce}-${J} <${ne}.${fe}.${+Ce+1}-0`:Q=`>=${ne}.${fe}.${Ce}-${J} <${ne}.${+fe+1}.0-0`:Q=`>=${ne}.${fe}.${Ce}-${J} <${+ne+1}.0.0-0`):(a("no pr"),ne==="0"?fe==="0"?Q=`>=${ne}.${fe}.${Ce}${re} <${ne}.${fe}.${+Ce+1}-0`:Q=`>=${ne}.${fe}.${Ce}${re} <${ne}.${+fe+1}.0-0`:Q=`>=${ne}.${fe}.${Ce} <${+ne+1}.0.0-0`),a("caret return",Q),Q})},T=(j,F)=>(a("replaceXRanges",j,F),j.split(/\s+/).map(H=>B(H,F)).join(" ")),B=(j,F)=>{j=j.trim();const H=F.loose?c[u.XRANGELOOSE]:c[u.XRANGE];return j.replace(H,(re,ue,ne,fe,Ce,J)=>{a("xRange",j,re,ue,ne,fe,Ce,J);const Q=E(ne),ae=Q||E(fe),Z=ae||E(Ce),A=Z;return ue==="="&&A&&(ue=""),J=F.includePrerelease?"-0":"",Q?ue===">"||ue==="<"?re="<0.0.0-0":re="*":ue&&A?(ae&&(fe=0),Ce=0,ue===">"?(ue=">=",ae?(ne=+ne+1,fe=0,Ce=0):(fe=+fe+1,Ce=0)):ue==="<="&&(ue="<",ae?ne=+ne+1:fe=+fe+1),ue==="<"&&(J="-0"),re=`${ue+ne}.${fe}.${Ce}${J}`):ae?re=`>=${ne}.0.0${J} <${+ne+1}.0.0-0`:Z&&(re=`>=${ne}.${fe}.0${J} <${ne}.${+fe+1}.0-0`),a("xRange return",re),re})},z=(j,F)=>(a("replaceStars",j,F),j.trim().replace(c[u.STAR],"")),q=(j,F)=>(a("replaceGTE0",j,F),j.trim().replace(c[F.includePrerelease?u.GTE0PRE:u.GTE0],"")),ie=j=>(F,H,re,ue,ne,fe,Ce,J,Q,ae,Z,A)=>(E(re)?H="":E(ue)?H=`>=${re}.0.0${j?"-0":""}`:E(ne)?H=`>=${re}.${ue}.0${j?"-0":""}`:fe?H=`>=${H}`:H=`>=${H}${j?"-0":""}`,E(Q)?J="":E(ae)?J=`<${+Q+1}.0.0-0`:E(Z)?J=`<${Q}.${+ae+1}.0-0`:A?J=`<=${Q}.${ae}.${Z}-${A}`:j?J=`<${Q}.${ae}.${+Z+1}-0`:J=`<=${J}`,`${H} ${J}`.trim()),me=(j,F,H)=>{for(let re=0;re<j.length;re++)if(!j[re].test(F))return!1;if(F.prerelease.length&&!H.includePrerelease){for(let re=0;re<j.length;re++)if(a(j[re].semver),j[re].semver!==i.ANY&&j[re].semver.prerelease.length>0){const ue=j[re].semver;if(ue.major===F.major&&ue.minor===F.minor&&ue.patch===F.patch)return!0}return!1}return!0};return $h}var Nh,K_;function Zl(){if(K_)return Nh;K_=1;const t=Symbol("SemVer ANY");class e{static get ANY(){return t}constructor(l,d){if(d=n(d),l instanceof e){if(l.loose===!!d.loose)return l;l=l.value}l=l.trim().split(/\s+/).join(" "),a("comparator",l,d),this.options=d,this.loose=!!d.loose,this.parse(l),this.semver===t?this.value="":this.value=this.operator+this.semver.version,a("comp",this)}parse(l){const d=this.options.loose?r[s.COMPARATORLOOSE]:r[s.COMPARATOR],h=l.match(d);if(!h)throw new TypeError(`Invalid comparator: ${l}`);this.operator=h[1]!==void 0?h[1]:"",this.operator==="="&&(this.operator=""),h[2]?this.semver=new o(h[2],this.options.loose):this.semver=t}toString(){return this.value}test(l){if(a("Comparator.test",l,this.options.loose),this.semver===t||l===t)return!0;if(typeof l=="string")try{l=new o(l,this.options)}catch{return!1}return i(l,this.operator,this.semver,this.options)}intersects(l,d){if(!(l instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(l.value,d).test(this.value):l.operator===""?l.value===""?!0:new c(this.value,d).test(l.semver):(d=n(d),d.includePrerelease&&(this.value==="<0.0.0-0"||l.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||l.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&l.operator.startsWith(">")||this.operator.startsWith("<")&&l.operator.startsWith("<")||this.semver.version===l.semver.version&&this.operator.includes("=")&&l.operator.includes("=")||i(this.semver,"<",l.semver,d)&&this.operator.startsWith(">")&&l.operator.startsWith("<")||i(this.semver,">",l.semver,d)&&this.operator.startsWith("<")&&l.operator.startsWith(">")))}}Nh=e;const n=jm(),{safeRe:r,t:s}=sc(),i=bE(),a=Wl(),o=pn(),c=xr();return Nh}var Ph,X_;function Kl(){if(X_)return Ph;X_=1;const t=xr();return Ph=(n,r,s)=>{try{r=new t(r,s)}catch{return!1}return r.test(n)},Ph}var Lh,Y_;function xO(){if(Y_)return Lh;Y_=1;const t=xr();return Lh=(n,r)=>new t(n,r).set.map(s=>s.map(i=>i.value).join(" ").trim().split(" ")),Lh}var Mh,Q_;function TO(){if(Q_)return Mh;Q_=1;const t=pn(),e=xr();return Mh=(r,s,i)=>{let a=null,o=null,c=null;try{c=new e(s,i)}catch{return null}return r.forEach(u=>{c.test(u)&&(!a||o.compare(u)===-1)&&(a=u,o=new t(a,i))}),a},Mh}var Dh,ew;function AO(){if(ew)return Dh;ew=1;const t=pn(),e=xr();return Dh=(r,s,i)=>{let a=null,o=null,c=null;try{c=new e(s,i)}catch{return null}return r.forEach(u=>{c.test(u)&&(!a||o.compare(u)===1)&&(a=u,o=new t(a,i))}),a},Dh}var Uh,tw;function CO(){if(tw)return Uh;tw=1;const t=pn(),e=xr(),n=Jl();return Uh=(s,i)=>{s=new e(s,i);let a=new t("0.0.0");if(s.test(a)||(a=new t("0.0.0-0"),s.test(a)))return a;a=null;for(let o=0;o<s.set.length;++o){const c=s.set[o];let u=null;c.forEach(l=>{const d=new t(l.semver.version);switch(l.operator){case">":d.prerelease.length===0?d.patch++:d.prerelease.push(0),d.raw=d.format();case"":case">=":(!u||n(d,u))&&(u=d);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${l.operator}`)}}),u&&(!a||n(a,u))&&(a=u)}return a&&s.test(a)?a:null},Uh}var Bh,nw;function kO(){if(nw)return Bh;nw=1;const t=xr();return Bh=(n,r)=>{try{return new t(n,r).range||"*"}catch{return null}},Bh}var jh,rw;function Hm(){if(rw)return jh;rw=1;const t=pn(),e=Zl(),{ANY:n}=e,r=xr(),s=Kl(),i=Jl(),a=zm(),o=qm(),c=Vm();return jh=(l,d,h,f)=>{l=new t(l,f),d=new r(d,f);let m,g,_,b,y;switch(h){case">":m=i,g=o,_=a,b=">",y=">=";break;case"<":m=a,g=c,_=i,b="<",y="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(s(l,d,f))return!1;for(let E=0;E<d.set.length;++E){const C=d.set[E];let k=null,R=null;if(C.forEach($=>{$.semver===n&&($=new e(">=0.0.0")),k=k||$,R=R||$,m($.semver,k.semver,f)?k=$:_($.semver,R.semver,f)&&(R=$)}),k.operator===b||k.operator===y||(!R.operator||R.operator===b)&&g(l,R.semver))return!1;if(R.operator===y&&_(l,R.semver))return!1}return!0},jh}var Fh,sw;function IO(){if(sw)return Fh;sw=1;const t=Hm();return Fh=(n,r,s)=>t(n,r,">",s),Fh}var zh,iw;function RO(){if(iw)return zh;iw=1;const t=Hm();return zh=(n,r,s)=>t(n,r,"<",s),zh}var Vh,aw;function OO(){if(aw)return Vh;aw=1;const t=xr();return Vh=(n,r,s)=>(n=new t(n,s),r=new t(r,s),n.intersects(r,s)),Vh}var qh,ow;function $O(){if(ow)return qh;ow=1;const t=Kl(),e=Sr();return qh=(n,r,s)=>{const i=[];let a=null,o=null;const c=n.sort((h,f)=>e(h,f,s));for(const h of c)t(h,r,s)?(o=h,a||(a=h)):(o&&i.push([a,o]),o=null,a=null);a&&i.push([a,null]);const u=[];for(const[h,f]of i)h===f?u.push(h):!f&&h===c[0]?u.push("*"):f?h===c[0]?u.push(`<=${f}`):u.push(`${h} - ${f}`):u.push(`>=${h}`);const l=u.join(" || "),d=typeof r.raw=="string"?r.raw:String(r);return l.length<d.length?l:r},qh}var Hh,cw;function NO(){if(cw)return Hh;cw=1;const t=xr(),e=Zl(),{ANY:n}=e,r=Kl(),s=Sr(),i=(d,h,f={})=>{if(d===h)return!0;d=new t(d,f),h=new t(h,f);let m=!1;e:for(const g of d.set){for(const _ of h.set){const b=c(g,_,f);if(m=m||b!==null,b)continue e}if(m)return!1}return!0},a=[new e(">=0.0.0-0")],o=[new e(">=0.0.0")],c=(d,h,f)=>{if(d===h)return!0;if(d.length===1&&d[0].semver===n){if(h.length===1&&h[0].semver===n)return!0;f.includePrerelease?d=a:d=o}if(h.length===1&&h[0].semver===n){if(f.includePrerelease)return!0;h=o}const m=new Set;let g,_;for(const T of d)T.operator===">"||T.operator===">="?g=u(g,T,f):T.operator==="<"||T.operator==="<="?_=l(_,T,f):m.add(T.semver);if(m.size>1)return null;let b;if(g&&_){if(b=s(g.semver,_.semver,f),b>0)return null;if(b===0&&(g.operator!==">="||_.operator!=="<="))return null}for(const T of m){if(g&&!r(T,String(g),f)||_&&!r(T,String(_),f))return null;for(const B of h)if(!r(T,String(B),f))return!1;return!0}let y,E,C,k,R=_&&!f.includePrerelease&&_.semver.prerelease.length?_.semver:!1,$=g&&!f.includePrerelease&&g.semver.prerelease.length?g.semver:!1;R&&R.prerelease.length===1&&_.operator==="<"&&R.prerelease[0]===0&&(R=!1);for(const T of h){if(k=k||T.operator===">"||T.operator===">=",C=C||T.operator==="<"||T.operator==="<=",g){if($&&T.semver.prerelease&&T.semver.prerelease.length&&T.semver.major===$.major&&T.semver.minor===$.minor&&T.semver.patch===$.patch&&($=!1),T.operator===">"||T.operator===">="){if(y=u(g,T,f),y===T&&y!==g)return!1}else if(g.operator===">="&&!r(g.semver,String(T),f))return!1}if(_){if(R&&T.semver.prerelease&&T.semver.prerelease.length&&T.semver.major===R.major&&T.semver.minor===R.minor&&T.semver.patch===R.patch&&(R=!1),T.operator==="<"||T.operator==="<="){if(E=l(_,T,f),E===T&&E!==_)return!1}else if(_.operator==="<="&&!r(_.semver,String(T),f))return!1}if(!T.operator&&(_||g)&&b!==0)return!1}return!(g&&C&&!_&&b!==0||_&&k&&!g&&b!==0||$||R)},u=(d,h,f)=>{if(!d)return h;const m=s(d.semver,h.semver,f);return m>0?d:m<0||h.operator===">"&&d.operator===">="?h:d},l=(d,h,f)=>{if(!d)return h;const m=s(d.semver,h.semver,f);return m<0?d:m>0||h.operator==="<"&&d.operator==="<="?h:d};return Hh=i,Hh}var Gh,uw;function PO(){if(uw)return Gh;uw=1;const t=sc(),e=Gl(),n=pn(),r=yE(),s=$a(),i=lO(),a=dO(),o=hO(),c=fO(),u=pO(),l=mO(),d=gO(),h=yO(),f=Sr(),m=_O(),g=wO(),_=Fm(),b=bO(),y=vO(),E=Jl(),C=zm(),k=_E(),R=wE(),$=Vm(),T=qm(),B=bE(),z=EO(),q=Zl(),ie=xr(),me=Kl(),j=xO(),F=TO(),H=AO(),re=CO(),ue=kO(),ne=Hm(),fe=IO(),Ce=RO(),J=OO(),Q=$O(),ae=NO();return Gh={parse:s,valid:i,clean:a,inc:o,diff:c,major:u,minor:l,patch:d,prerelease:h,compare:f,rcompare:m,compareLoose:g,compareBuild:_,sort:b,rsort:y,gt:E,lt:C,eq:k,neq:R,gte:$,lte:T,cmp:B,coerce:z,Comparator:q,Range:ie,satisfies:me,toComparators:j,maxSatisfying:F,minSatisfying:H,minVersion:re,validRange:ue,outside:ne,gtr:fe,ltr:Ce,intersects:J,simplifyRange:Q,subset:ae,SemVer:n,re:t.re,src:t.src,tokens:t.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:r.compareIdentifiers,rcompareIdentifiers:r.rcompareIdentifiers},Gh}PO();function vs(t){if(!t||t.split("/").length>2||t.startsWith("/")||t.endsWith("/")||t.split(":").length>2)throw new Error(`Invalid identifier format: ${t}`);const[e,n]=t.split(":"),r=n||"latest";if(e.includes("/")){const[s,i]=e.split("/",2);if(!s||!i)throw new Error(`Invalid identifier format: ${t}`);return[s,i,r]}else{if(!e)throw new Error(`Invalid identifier format: ${t}`);return["-",e,r]}}class LO extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function _e(t,e,n){let r;if(t.ok){n&&(r=await t.text());return}if(t.status===403)try{const a=await t.json();(a==null?void 0:a.error)==="org_scoped_key_requires_workspace"&&(r="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const o=new Error(`${t.status} ${t.statusText}`);throw o.status=t==null?void 0:t.status,o}if(r===void 0)try{r=await t.text()}catch{r=""}const s=`Failed to ${e}. Received status [${t.status}]: ${t.statusText}. Message: ${r}`;if(t.status===409)throw new LO(s);const i=new Error(s);throw i.status=t.status,i}const vE="ERR_CONFLICTING_ENDPOINTS";class MO extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:vE}),this.name="ConflictingEndpointsError"}}function DO(t){return typeof t=="object"&&t!==null&&t.code===vE}var lw="[...]",UO={result:"[Circular]"},qu=[],ra=[];const BO=new TextEncoder;function jO(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function Dc(t){return BO.encode(t)}function EE(t){if(t&&typeof t=="object"&&t!==null){if(t instanceof Map)return Object.fromEntries(t);if(t instanceof Set)return Array.from(t);if(t instanceof Date)return t.toISOString();if(t instanceof RegExp)return t.toString();if(t instanceof Error)return{name:t.name,message:t.message}}else if(typeof t=="bigint")return t.toString();return t}function FO(t){return function(e,n){return EE(n)}}function Pn(t,e,n,r,s){var i;try{const a=JSON.stringify(t,FO(n),r);return Dc(a)}catch(a){if(!((i=a.message)!=null&&i.includes("Converting circular structure to JSON")))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),Dc("[Unserializable]");En("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof s>"u"&&(s=jO()),Yf(t,"",0,[],void 0,0,s);let o;try{ra.length===0?o=JSON.stringify(t,n,r):o=JSON.stringify(t,zO(n),r)}catch{return Dc("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;qu.length!==0;){const c=qu.pop();c.length===4?Object.defineProperty(c[0],c[1],c[3]):c[0][c[1]]=c[2]}}return Dc(o)}}function Wh(t,e,n,r){var s=Object.getOwnPropertyDescriptor(r,n);s.get!==void 0?s.configurable?(Object.defineProperty(r,n,{value:t}),qu.push([r,n,e,s])):ra.push([e,n,t]):(r[n]=t,qu.push([r,n,e]))}function Yf(t,e,n,r,s,i,a){i+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<r.length;o++)if(r[o]===t){Wh(UO,t,e,s);return}if(typeof a.depthLimit<"u"&&i>a.depthLimit){Wh(lw,t,e,s);return}if(typeof a.edgesLimit<"u"&&n+1>a.edgesLimit){Wh(lw,t,e,s);return}if(r.push(t),Array.isArray(t))for(o=0;o<t.length;o++)Yf(t[o],o,o,r,t,i,a);else{t=EE(t);var c=Object.keys(t);for(o=0;o<c.length;o++){var u=c[o];Yf(t[u],u,o,r,t,i,a)}}r.pop()}}function zO(t){return t=typeof t<"u"?t:function(e,n){return n},function(e,n){if(ra.length>0)for(var r=0;r<ra.length;r++){var s=ra[r];if(s[1]===e&&s[0]===n){n=s[2],ra.splice(r,1);break}}return t.call(this,e,n)}}function dw(t,e){const n=fE(),r=e??pE(),s=t.extra??{},i=s.metadata;return t.extra={...s,runtime:{...n,...s==null?void 0:s.runtime},metadata:{...r,...r.revision_id||"revision_id"in t&&t.revision_id?{revision_id:("revision_id"in t?t.revision_id:void 0)??r.revision_id}:{},...i}},t}const VO=t=>{const e=(t==null?void 0:t.toString())??En("TRACING_SAMPLING_RATE");if(e===void 0)return;const n=parseFloat(e);if(n<0||n>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${n}`);return n},qO=t=>{const n=t.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return n==="localhost"||n==="127.0.0.1"||n==="::1"};async function HO(t){const e=[];for await(const n of t)e.push(n);return e}function Uc(t){if(t!==void 0)return t.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const GO=async t=>{if((t==null?void 0:t.status)===429){const e=parseInt(t.headers.get("retry-after")??"10",10)*1e3;if(e>0)return await new Promise(n=>setTimeout(n,e)),!0}return!1};function hw(t){return typeof t=="number"?Number(t.toFixed(4)):t}class WO{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let n;const r=new Promise(i=>{n=i}),s=Pn(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:n,itemPromise:r,size:s}),this.sizeBytes+=s,r}pop({upToSizeBytes:e,upToSize:n}){var i;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const r=[];let s=0;for(;s+(((i=this.peek())==null?void 0:i.size)??0)<e&&this.items.length>0&&r.length<n;){const a=this.items.shift();a&&(r.push(a),s+=a.size,this.sizeBytes-=a.size)}if(r.length===0&&this.items.length>0){const a=this.items.shift();r.push(a),s+=a.size,this.sizeBytes-=a.size}return[r.map(a=>({action:a.action,item:a.payload,otelContext:a.otelContext,apiKey:a.apiKey,apiUrl:a.apiUrl})),()=>r.forEach(a=>a.itemPromiseResolve())]}}const JO=24*1024*1024,ZO=1e4,KO=100,fw="https://api.smith.langchain.com";let Gm=class Qf{get _fetch(){return this.fetchImplementation||$R(this.debug)}constructor(e={}){var r;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new WO}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Gr("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:Gr("LANGSMITH_DEBUG")==="true"});const n=Qf.getDefaultClientConfig();if(this.tracingSampleRate=VO(e.tracingSamplingRate),this.apiUrl=Uc(e.apiUrl??n.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Uc(e.apiKey??n.apiKey),this.webUrl=Uc(e.webUrl??n.webUrl),(r=this.webUrl)!=null&&r.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=Uc(e.workspaceId??En("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new m_({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation,this.batchIngestCaller=new m_({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:GO,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??n.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??n.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,mE()&&(this.langSmithToOTELTranslator=new ZR),this.cachedLSEnvVarsForMetadata=pE()}static getDefaultClientConfig(){const e=En("API_KEY"),n=En("ENDPOINT")??fw,r=En("HIDE_INPUTS")==="true",s=En("HIDE_OUTPUTS")==="true";return{apiUrl:n,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:qO(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${lE}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const n={...e};return n.inputs!==void 0&&(n.inputs=await this.processInputs(n.inputs)),n.outputs!==void 0&&(n.outputs=await this.processOutputs(n.outputs)),n}async _getResponse(e,n){const r=(n==null?void 0:n.toString())??"",s=`${this.apiUrl}${e}?${r}`;return await this.caller.call(async()=>{const a=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,`fetch ${e}`),a})}async _get(e,n){return(await this._getResponse(e,n)).json()}async*_getPaginated(e,n=new URLSearchParams,r){let s=Number(n.get("offset"))||0;const i=Number(n.get("limit"))||100;for(;;){n.set("offset",String(s)),n.set("limit",String(i));const a=`${this.apiUrl}${e}?${n}`,o=await this.caller.call(async()=>{const u=await this._fetch(a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(u,`fetch ${e}`),u}),c=r?r(await o.json()):await o.json();if(c.length===0||(yield c,c.length<i))break;s+=c.length}}async*_getCursorPaginatedList(e,n=null,r="POST",s="runs"){const i=n?{...n}:{};for(;;){const a=JSON.stringify(i),c=await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(l,`fetch ${e}`),l})).json();if(!c||!c[s])break;yield c[s];const u=c.cursors;if(!u||!u.next)break;i.cursor=u.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,n=!1){if(this.tracingSampleRate===void 0)return e;if(n){const r=[];for(const s of e)this.filteredPostUuids.has(s.trace_id)?s.id===s.trace_id&&this.filteredPostUuids.delete(s.trace_id):r.push(s);return r}else{const r=[];for(const s of e){const i=s.trace_id??s.id;this.filteredPostUuids.has(i)||(s.id===i?this._shouldSample()?r.push(s):this.filteredPostUuids.add(i):r.push(s))}return r}}async _getBatchSizeLimitBytes(){var n;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((n=e.batch_ingest_config)==null?void 0:n.size_limit_bytes)??JO}async _getBatchSizeLimit(){var n;const e=await this._ensureServerInfo();return this.batchSizeLimit??((n=e.batch_ingest_config)==null?void 0:n.size_limit)??KO}async _getDatasetExamplesMultiPartSupport(){var n;return((n=(await this._ensureServerInfo()).instance_flags)==null?void 0:n.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:n}){const r=[];for(;this.autoBatchQueue.items.length>0;){const[s,i]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:n});if(!s.length){i();break}const a=s.reduce((u,l)=>{const d=l.apiUrl??this.apiUrl,h=l.apiKey??this.apiKey,m=l.apiKey===this.apiKey&&l.apiUrl===this.apiUrl?"default":`${d}|${h}`;return u[m]||(u[m]=[]),u[m].push(l),u},{}),o=[];for(const[u,l]of Object.entries(a)){const d=this._processBatch(l,{apiUrl:u==="default"?void 0:u.split("|")[0],apiKey:u==="default"?void 0:u.split("|")[1]});o.push(d)}const c=Promise.all(o).finally(i);r.push(c)}return Promise.all(r)}async _processBatch(e,n){var r,s;if(e.length)try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(e);else{const i={runCreates:e.filter(o=>o.action==="create").map(o=>o.item),runUpdates:e.filter(o=>o.action==="update").map(o=>o.item)},a=await this._ensureServerInfo();if((r=a==null?void 0:a.batch_ingest_config)!=null&&r.use_multipart_endpoint){const o=(s=a==null?void 0:a.instance_flags)==null?void 0:s.gzip_body_enabled;await this.multipartIngestRuns(i,{...n,useGzip:o})}else await this.batchIngestRuns(i,n)}}catch(i){console.error("Error exporting batch:",i)}}_sendBatchToOTELTranslator(e){if(this.langSmithToOTELTranslator!==void 0){const n=new Map,r=[];for(const s of e)s.item.id&&s.otelContext&&(n.set(s.item.id,s.otelContext),s.action==="create"?r.push({operation:"post",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}):r.push({operation:"patch",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}));this.langSmithToOTELTranslator.exportBatch(r,n)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=dw(e.item,this.cachedLSEnvVarsForMetadata);const n=this.autoBatchQueue.push(e);if(this.manualFlushMode)return n;const r=await this._getBatchSizeLimitBytes(),s=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>r||this.autoBatchQueue.items.length>s)&&this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:s}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:s})},this.autoBatchAggregationDelayMs)),n}async _getServerInfo(){const n=await(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(ZO),...this.fetchOptions});return await _e(r,"get server info"),r})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(n,null,2)+`
`),n}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),n=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:n})}_cloneCurrentOTELContext(){const e=gE(),n=HR();if(this.langSmithToOTELTranslator!==void 0){const r=e.getActiveSpan();if(r)return e.setSpan(n.active(),r)}}async createRun(e,n){if(!this._filterForSampling([e]).length)return;const r={...this.headers,"Content-Type":"application/json"},s=e.project_name;delete e.project_name;const i=await this.prepareRunCreateOrUpdateInputs({session_name:s,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){const c=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:i,otelContext:c,apiKey:n==null?void 0:n.apiKey,apiUrl:n==null?void 0:n.apiUrl}).catch(console.error);return}const a=dw(i,this.cachedLSEnvVarsForMetadata);(n==null?void 0:n.apiKey)!==void 0&&(r["x-api-key"]=n.apiKey),(n==null?void 0:n.workspaceId)!==void 0&&(r["x-tenant-id"]=n.workspaceId);const o=Pn(a,`Creating run with id: ${a.id}`);await this.caller.call(async()=>{const c=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"create run",!0),c})}async batchIngestRuns({runCreates:e,runUpdates:n},r){if(e===void 0&&n===void 0)return;let s=await Promise.all((e==null?void 0:e.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[]),i=await Promise.all((n==null?void 0:n.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[]);if(s.length>0&&i.length>0){const c=s.reduce((l,d)=>(d.id&&(l[d.id]=d),l),{}),u=[];for(const l of i)l.id!==void 0&&c[l.id]?c[l.id]={...c[l.id],...l}:u.push(l);s=Object.values(c),i=u}const a={post:s,patch:i};if(!a.post.length&&!a.patch.length)return;const o={post:[],patch:[]};for(const c of["post","patch"]){const u=c,l=a[u].reverse();let d=l.pop();for(;d!==void 0;)o[u].push(d),d=l.pop()}if(o.post.length>0||o.patch.length>0){const c=o.post.map(u=>u.id).concat(o.patch.map(u=>u.id)).join(",");await this._postBatchIngestRuns(Pn(o,`Ingesting runs with ids: ${c}`),r)}}async _postBatchIngestRuns(e,n){const r={...this.headers,"Content-Type":"application/json",Accept:"application/json"};(n==null?void 0:n.apiKey)!==void 0&&(r["x-api-key"]=n.apiKey),await this.batchIngestCaller.call(async()=>{const s=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/batch`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await _e(s,"batch create run",!0),s})}async multipartIngestRuns({runCreates:e,runUpdates:n},r){if(e===void 0&&n===void 0)return;const s={};let i=[];for(const d of e??[]){const h=await this.prepareRunCreateOrUpdateInputs(d);h.id!==void 0&&h.attachments!==void 0&&(s[h.id]=h.attachments),delete h.attachments,i.push(h)}let a=[];for(const d of n??[])a.push(await this.prepareRunCreateOrUpdateInputs(d));if(i.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(a.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(i.length>0&&a.length>0){const d=i.reduce((f,m)=>(m.id&&(f[m.id]=m),f),{}),h=[];for(const f of a)f.id!==void 0&&d[f.id]?d[f.id]={...d[f.id],...f}:h.push(f);i=Object.values(d),a=h}if(i.length===0&&a.length===0)return;const u=[],l=[];for(const[d,h]of[["post",i],["patch",a]])for(const f of h){const{inputs:m,outputs:g,events:_,extra:b,error:y,serialized:E,attachments:C,...k}=f,R={inputs:m,outputs:g,events:_,extra:b,error:y,serialized:E},$=Pn(k,`Serializing for multipart ingestion of run with id: ${k.id}`);l.push({name:`${d}.${k.id}`,payload:new Blob([$],{type:`application/json; length=${$.length}`})});for(const[T,B]of Object.entries(R)){if(B===void 0)continue;const z=Pn(B,`Serializing ${T} for multipart ingestion of run with id: ${k.id}`);l.push({name:`${d}.${k.id}.${T}`,payload:new Blob([z],{type:`application/json; length=${z.length}`})})}if(k.id!==void 0){const T=s[k.id];if(T){delete s[k.id];for(const[B,z]of Object.entries(T)){let q,ie;if(Array.isArray(z)?[q,ie]=z:(q=z.mimeType,ie=z.data),B.includes(".")){console.warn(`Skipping attachment '${B}' for run ${k.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}l.push({name:`attachment.${k.id}.${B}`,payload:new Blob([ie],{type:`${q}; length=${ie.byteLength}`})})}}}u.push(`trace=${k.trace_id},id=${k.id}`)}await this._sendMultipartRequest(l,u.join("; "),r)}async _createNodeFetchBody(e,n){const r=[];for(const a of e)r.push(new Blob([`--${n}\r
`])),r.push(new Blob([`Content-Disposition: form-data; name="${a.name}"\r
`,`Content-Type: ${a.payload.type}\r
\r
`])),r.push(a.payload),r.push(new Blob([`\r
`]));return r.push(new Blob([`--${n}--\r
`])),await new Blob(r).arrayBuffer()}async _createMultipartStream(e,n){const r=new TextEncoder;return new ReadableStream({async start(i){const a=async o=>{typeof o=="string"?i.enqueue(r.encode(o)):i.enqueue(o)};for(const o of e){await a(`--${n}\r
`),await a(`Content-Disposition: form-data; name="${o.name}"\r
`),await a(`Content-Type: ${o.payload.type}\r
\r
`);const u=o.payload.stream().getReader();try{let l;for(;!(l=await u.read()).done;)i.enqueue(l.value)}finally{u.releaseLock()}await a(`\r
`)}await a(`--${n}--\r
`),i.close()}})}async _sendMultipartRequest(e,n,r){const s="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),i=OR(),a=()=>this._createNodeFetchBody(e,s),o=()=>this._createMultipartStream(e,s),c=async u=>this.batchIngestCaller.call(async()=>{const l=await u(),d={...this.headers,"Content-Type":`multipart/form-data; boundary=${s}`};(r==null?void 0:r.apiKey)!==void 0&&(d["x-api-key"]=r.apiKey);let h=l;r!=null&&r.useGzip&&typeof l=="object"&&"pipeThrough"in l&&(h=l.pipeThrough(new CompressionStream("gzip")),d["Content-Encoding"]="gzip");const f=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/multipart`,{method:"POST",headers:d,body:h,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(f,"Failed to send multipart request",!0),f});try{let u,l=!1;!i&&!this.multipartStreamingDisabled&&hE()!=="bun"?(l=!0,u=await c(o)):u=await c(a),(!this.multipartStreamingDisabled||l)&&u.status===422&&((r==null?void 0:r.apiUrl)??this.apiUrl)!==fw&&(console.warn(`Streaming multipart upload to ${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${n}".`),this.multipartStreamingDisabled=!0,u=await c(a))}catch(u){console.warn(`${u.message.trim()}

Context: ${n}`)}}async updateRun(e,n,r){Oe(e),n.inputs&&(n.inputs=await this.processInputs(n.inputs)),n.outputs&&(n.outputs=await this.processOutputs(n.outputs));const s={...n,id:e};if(!this._filterForSampling([s],!0).length)return;if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){const o=this._cloneCurrentOTELContext();if(n.end_time!==void 0&&s.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:r==null?void 0:r.apiKey,apiUrl:r==null?void 0:r.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:r==null?void 0:r.apiKey,apiUrl:r==null?void 0:r.apiUrl}).catch(console.error);return}const i={...this.headers,"Content-Type":"application/json"};(r==null?void 0:r.apiKey)!==void 0&&(i["x-api-key"]=r.apiKey),(r==null?void 0:r.workspaceId)!==void 0&&(i["x-tenant-id"]=r.workspaceId);const a=Pn(n,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const o=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(o,"update run",!0),o})}async readRun(e,{loadChildRuns:n}={loadChildRuns:!1}){Oe(e);let r=await this._get(`/runs/${e}`);return n&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:n,projectOpts:r}){if(n!==void 0){let s;n.session_id?s=n.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:En("PROJECT")||"default"})).id;const i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${s}/r/${n.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){var i;const n=await HO(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),r={},s={};n.sort((a,o)=>((a==null?void 0:a.dotted_order)??"").localeCompare((o==null?void 0:o.dotted_order)??""));for(const a of n){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);(i=a.dotted_order)!=null&&i.startsWith(e.dotted_order??"")&&a.id!==e.id&&(a.parent_run_id in r||(r[a.parent_run_id]=[]),r[a.parent_run_id].push(a),s[a.id]=a)}e.child_runs=r[e.id]||[];for(const a in r)a!==e.id&&(s[a].child_runs=r[a]);return e}async*listRuns(e){const{projectId:n,projectName:r,parentRunId:s,traceId:i,referenceExampleId:a,startTime:o,executionOrder:c,isRoot:u,runType:l,error:d,id:h,query:f,filter:m,traceFilter:g,treeFilter:_,limit:b,select:y,order:E}=e;let C=[];if(n&&(C=Array.isArray(n)?n:[n]),r){const T=Array.isArray(r)?r:[r],B=await Promise.all(T.map(z=>this.readProject({projectName:z}).then(q=>q.id)));C.push(...B)}const k=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],R={session:C.length?C:null,run_type:l,reference_example:a,query:f,filter:m,trace_filter:g,tree_filter:_,execution_order:c,parent_run:s,start_time:o?o.toISOString():null,error:d,id:h,limit:b,trace:i,select:y||k,is_root:u,order:E};R.select.includes("child_run_ids")&&Xf("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let $=0;for await(const T of this._getCursorPaginatedList("/runs/query",R))if(b){if($>=b)break;if(T.length+$>b){yield*T.slice(0,b-$);break}$+=T.length,yield*T}else yield*T}async*listGroupRuns(e){const{projectId:n,projectName:r,groupBy:s,filter:i,startTime:a,endTime:o,limit:c,offset:u}=e,d={session_id:n||(await this.readProject({projectName:r})).id,group_by:s,filter:i,start_time:a?a.toISOString():null,end_time:o?o.toISOString():null,limit:Number(c)||100};let h=Number(u)||0;const f="/runs/group",m=`${this.apiUrl}${f}`;for(;;){const g={...d,offset:h},_=Object.fromEntries(Object.entries(g).filter(([R,$])=>$!==void 0)),b=JSON.stringify(_),E=await(await this.caller.call(async()=>{const R=await this._fetch(m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:b});return await _e(R,`Failed to fetch ${f}`),R})).json(),{groups:C,total:k}=E;if(C.length===0)break;for(const R of C)yield R;if(h+=C.length,h>=k)break}}async getRunStats({id:e,trace:n,parentRun:r,runType:s,projectNames:i,projectIds:a,referenceExampleIds:o,startTime:c,endTime:u,error:l,query:d,filter:h,traceFilter:f,treeFilter:m,isRoot:g,dataSourceType:_}){let b=a||[];i&&(b=[...a||[],...await Promise.all(i.map($=>this.readProject({projectName:$}).then(T=>T.id)))]);const E=Object.fromEntries(Object.entries({id:e,trace:n,parent_run:r,run_type:s,session:b,reference_example:o,start_time:c,end_time:u,error:l,query:d,filter:h,trace_filter:f,tree_filter:m,is_root:g,data_source_type:_}).filter(([$,T])=>T!==void 0)),C=JSON.stringify(E);return await(await this.caller.call(async()=>{const $=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:C});return await _e($,"get run stats"),$})).json()}async shareRun(e,{shareId:n}={}){const r={run_id:e,share_token:n||Ji()};Oe(e);const s=JSON.stringify(r),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(o,"share run"),o})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){Oe(e),await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"unshare run",!0),n})}async readRunSharedLink(e){Oe(e);const r=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"read run shared link"),s})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:n}={}){const r=new URLSearchParams({share_token:e});if(n!==void 0)for(const a of n)r.append("id",a);return Oe(e),await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"list shared runs"),a})).json()}async readDatasetSharedSchema(e,n){if(!e&&!n)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:n})).id),Oe(e);const s=await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,"read dataset shared schema"),i})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,n){if(!e&&!n)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:n})).id);const r={dataset_id:e};Oe(e);const s=JSON.stringify(r),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(o,"share dataset"),o})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){Oe(e),await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"unshare dataset",!0),n})}async readSharedDataset(e){return Oe(e),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"read shared dataset"),s})).json()}async listSharedExamples(e,n){const r={};n!=null&&n.exampleIds&&(r.id=n.exampleIds);const s=new URLSearchParams;Object.entries(r).forEach(([o,c])=>{Array.isArray(c)?c.forEach(u=>s.append(o,u)):s.append(o,c)});const i=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(o,"list shared examples"),o}),a=await i.json();if(!i.ok)throw"detail"in a?new Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(a.detail)?a.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${i.status} ${i.statusText}`);return a.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:n=null,metadata:r=null,upsert:s=!1,projectExtra:i=null,referenceDatasetId:a=null}){const o=s?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,u=i||{};r&&(u.metadata=r);const l={name:e,extra:u,description:n};a!==null&&(l.reference_dataset_id=a);const d=JSON.stringify(l);return await(await this.caller.call(async()=>{const m=await this._fetch(c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await _e(m,"create project"),m})).json()}async updateProject(e,{name:n=null,description:r=null,metadata:s=null,projectExtra:i=null,endTime:a=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=i;s&&(c={...c||{},metadata:s});const u=JSON.stringify({name:n,extra:c,description:r,end_time:a?new Date(a).toISOString():null});return await(await this.caller.call(async()=>{const h=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(h,"update project"),h})).json()}async hasProject({projectId:e,projectName:n}){let r="/sessions";const s=new URLSearchParams;if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Oe(e),r+=`/${e}`;else if(n!==void 0)s.append("name",n);else throw new Error("Must provide projectName or projectId");const i=await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${r}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"has project"),a});try{const a=await i.json();return i.ok?Array.isArray(a)?a.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:n,includeStats:r}){let s="/sessions";const i=new URLSearchParams;if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Oe(e),s+=`/${e}`;else if(n!==void 0)i.append("name",n);else throw new Error("Must provide projectName or projectId");r!==void 0&&i.append("include_stats",r.toString());const a=await this._get(s,i);let o;if(Array.isArray(a)){if(a.length===0)throw new Error(`Project[id=${e}, name=${n}] not found`);o=a[0]}else o=a;return o}async getProjectUrl({projectId:e,projectName:n}){if(e===void 0&&n===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:n}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:n}){if(e===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:n}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const n of this._getPaginated("/sessions",e))return this._tenantId=n[0].tenant_id,n[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:n,nameContains:r,referenceDatasetId:s,referenceDatasetName:i,includeStats:a,datasetVersion:o,referenceFree:c,metadata:u}={}){const l=new URLSearchParams;if(e!==void 0)for(const d of e)l.append("id",d);if(n!==void 0&&l.append("name",n),r!==void 0&&l.append("name_contains",r),s!==void 0)l.append("reference_dataset",s);else if(i!==void 0){const d=await this.readDataset({datasetName:i});l.append("reference_dataset",d.id)}a!==void 0&&l.append("include_stats",a.toString()),o!==void 0&&l.append("dataset_version",o),c!==void 0&&l.append("reference_free",c.toString()),u!==void 0&&l.append("metadata",JSON.stringify(u));for await(const d of this._getPaginated("/sessions",l))yield*d}async deleteProject({projectId:e,projectName:n}){let r;if(e===void 0&&n===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:n})).id:r=e,Oe(r),await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,`delete session ${r} (${n})`,!0),s})}async uploadCsv({csvFile:e,fileName:n,inputKeys:r,outputKeys:s,description:i,dataType:a,name:o}){const c=`${this.apiUrl}/datasets/upload`,u=new FormData;return u.append("file",e,n),r.forEach(h=>{u.append("input_keys",h)}),s.forEach(h=>{u.append("output_keys",h)}),i&&u.append("description",i),a&&u.append("data_type",a),o&&u.append("name",o),await(await this.caller.call(async()=>{const h=await this._fetch(c,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(h,"upload CSV"),h})).json()}async createDataset(e,{description:n,dataType:r,inputsSchema:s,outputsSchema:i,metadata:a}={}){const o={name:e,description:n,extra:a?{metadata:a}:void 0};r&&(o.data_type=r),s&&(o.inputs_schema_definition=s),i&&(o.outputs_schema_definition=i);const c=JSON.stringify(o);return await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(d,"create dataset"),d})).json()}async readDataset({datasetId:e,datasetName:n}){let r="/datasets";const s=new URLSearchParams({limit:"1"});if(e&&n)throw new Error("Must provide either datasetName or datasetId, not both");if(e)Oe(e),r+=`/${e}`;else if(n)s.append("name",n);else throw new Error("Must provide datasetName or datasetId");const i=await this._get(r,s);let a;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${e}, name=${n}] not found`);a=i[0]}else a=i;return a}async hasDataset({datasetId:e,datasetName:n}){try{return await this.readDataset({datasetId:e,datasetName:n}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:n,fromVersion:r,toVersion:s}){let i=e;if(i===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:n})).id);const a=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,a)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:n}){const r="/datasets";if(e===void 0)if(n!==void 0)e=(await this.readDataset({datasetName:n})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:n=0,datasetIds:r,datasetName:s,datasetNameContains:i,metadata:a}={}){const o="/datasets",c=new URLSearchParams({limit:e.toString(),offset:n.toString()});if(r!==void 0)for(const u of r)c.append("id",u);s!==void 0&&c.append("name",s),i!==void 0&&c.append("name_contains",i),a!==void 0&&c.append("metadata",JSON.stringify(a));for await(const u of this._getPaginated(o,c))yield*u}async updateDataset(e){const{datasetId:n,datasetName:r,...s}=e;if(!n&&!r)throw new Error("Must provide either datasetName or datasetId");const i=n??(await this.readDataset({datasetName:r})).id;Oe(i);const a=JSON.stringify(s);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(c,"update dataset"),c})).json()}async updateDatasetTag(e){const{datasetId:n,datasetName:r,asOf:s,tag:i}=e;if(!n&&!r)throw new Error("Must provide either datasetName or datasetId");const a=n??(await this.readDataset({datasetName:r})).id;Oe(a);const o=JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:i});await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"update dataset tags",!0),c})}async deleteDataset({datasetId:e,datasetName:n}){let r="/datasets",s=e;if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(n!==void 0&&(s=(await this.readDataset({datasetName:n})).id),s!==void 0)Oe(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const i=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,`delete ${r}`,!0),i})}async indexDataset({datasetId:e,datasetName:n,tag:r}){let s=e;if(!s&&!n)throw new Error("Must provide either datasetName or datasetId");if(s&&n)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:n})).id),Oe(s);const a=JSON.stringify({tag:r});await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(c,"index dataset"),c})).json()}async similarExamples(e,n,r,{filter:s}={}){const i={limit:r,inputs:e};s!==void 0&&(i.filter=s),Oe(n);const a=JSON.stringify(i);return(await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${n}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:a});return await _e(u,"fetch similar examples"),u})).json()).examples}async createExample(e,n,r){var l;if(pw(e)&&(n!==void 0||r!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let s=n?r==null?void 0:r.datasetId:e.dataset_id;const i=n?r==null?void 0:r.datasetName:e.dataset_name;if(s===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:i})).id);const a=(n?r==null?void 0:r.createdAt:e.created_at)||new Date;let o;pw(e)?o=e:o={inputs:e,outputs:n,created_at:a==null?void 0:a.toISOString(),id:r==null?void 0:r.exampleId,metadata:r==null?void 0:r.metadata,split:r==null?void 0:r.split,source_run_id:r==null?void 0:r.sourceRunId,use_source_run_io:r==null?void 0:r.useSourceRunIO,use_source_run_attachments:r==null?void 0:r.useSourceRunAttachments,attachments:r==null?void 0:r.attachments};const c=await this._uploadExamplesMultipart(s,[o]);return await this.readExample(((l=c.example_ids)==null?void 0:l[0])??Ji())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const y=e;let E=y[0].dataset_id;const C=y[0].dataset_name;if(E===void 0&&C===void 0)throw new Error("Must provide either datasetName or datasetId");if(E!==void 0&&C!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");E===void 0&&(E=(await this.readDataset({datasetName:C})).id);const k=await this._uploadExamplesMultipart(E,y);return await Promise.all(k.example_ids.map($=>this.readExample($)))}const{inputs:n,outputs:r,metadata:s,splits:i,sourceRunIds:a,useSourceRunIOs:o,useSourceRunAttachments:c,attachments:u,exampleIds:l,datasetId:d,datasetName:h}=e;if(n===void 0)throw new Error("Must provide inputs when using legacy parameters");let f=d;const m=h;if(f===void 0&&m===void 0)throw new Error("Must provide either datasetName or datasetId");if(f!==void 0&&m!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");f===void 0&&(f=(await this.readDataset({datasetName:m})).id);const g=n.map((y,E)=>({dataset_id:f,inputs:y,outputs:r==null?void 0:r[E],metadata:s==null?void 0:s[E],split:i==null?void 0:i[E],id:l==null?void 0:l[E],attachments:u==null?void 0:u[E],source_run_id:a==null?void 0:a[E],use_source_run_io:o==null?void 0:o[E],use_source_run_attachments:c==null?void 0:c[E]})),_=await this._uploadExamplesMultipart(f,g);return await Promise.all(_.example_ids.map(y=>this.readExample(y)))}async createLLMExample(e,n,r){return this.createExample({input:e},{output:n},r)}async createChatExample(e,n,r){const s=e.map(a=>g_(a)?y_(a):a),i=g_(n)?y_(n):n;return this.createExample({input:s},{output:i},r)}async readExample(e){Oe(e);const n=`/examples/${e}`,r=await this._get(n),{attachment_urls:s,...i}=r,a=i;return s&&(a.attachments=Object.entries(s).reduce((o,[c,u])=>(o[c.slice(11)]={presigned_url:u.presigned_url,mime_type:u.mime_type},o),{})),a}async*listExamples({datasetId:e,datasetName:n,exampleIds:r,asOf:s,splits:i,inlineS3Urls:a,metadata:o,limit:c,offset:u,filter:l,includeAttachments:d}={}){let h;if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(n!==void 0)h=(await this.readDataset({datasetName:n})).id;else throw new Error("Must provide a datasetName or datasetId");const f=new URLSearchParams({dataset:h}),m=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;m&&f.append("as_of",m);const g=a??!0;if(f.append("inline_s3_urls",g.toString()),r!==void 0)for(const b of r)f.append("id",b);if(i!==void 0)for(const b of i)f.append("splits",b);if(o!==void 0){const b=JSON.stringify(o);f.append("metadata",b)}c!==void 0&&f.append("limit",c.toString()),u!==void 0&&f.append("offset",u.toString()),l!==void 0&&f.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(b=>f.append("select",b));let _=0;for await(const b of this._getPaginated("/examples",f)){for(const y of b){const{attachment_urls:E,...C}=y,k=C;E&&(k.attachments=Object.entries(E).reduce((R,[$,T])=>(R[$.slice(11)]={presigned_url:T.presigned_url,mime_type:T.mime_type||void 0},R),{})),yield k,_++}if(c!==void 0&&_>=c)break}}async deleteExample(e){Oe(e);const n=`/examples/${e}`;await this.caller.call(async()=>{const r=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,`delete ${n}`,!0),r})}async updateExample(e,n){let r;n?r=e:r=e.id,Oe(r);let s;n?s={id:r,...n}:s=e;let i;return s.dataset_id!==void 0?i=s.dataset_id:i=(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(i,[s])}async updateExamples(e){let n;return e[0].dataset_id===void 0?n=(await this.readExample(e[0].id)).dataset_id:n=e[0].dataset_id,this._updateExamplesMultipart(n,e)}async readDatasetVersion({datasetId:e,datasetName:n,asOf:r,tag:s}){let i;if(e?i=e:i=(await this.readDataset({datasetName:n})).id,Oe(i),r&&s||!r&&!s)throw new Error("Exactly one of asOf and tag must be specified.");const a=new URLSearchParams;return r!==void 0&&a.append("as_of",typeof r=="string"?r:r.toISOString()),s!==void 0&&a.append("tag",s),await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}/version?${a.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(c,"read dataset version"),c})).json()}async listDatasetSplits({datasetId:e,datasetName:n,asOf:r}){let s;if(e===void 0&&n===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:n})).id:s=e,Oe(s);const i=new URLSearchParams,a=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return a&&i.append("as_of",a),await this._get(`/datasets/${s}/splits`,i)}async updateDatasetSplits({datasetId:e,datasetName:n,splitName:r,exampleIds:s,remove:i=!1}){let a;if(e===void 0&&n===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:n})).id:a=e,Oe(a);const o={split_name:r,examples:s.map(u=>(Oe(u),u)),remove:i},c=JSON.stringify(o);await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${a}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(u,"update dataset splits",!0),u})}async evaluateRun(e,n,{sourceInfo:r,loadChildRuns:s,referenceExample:i}={loadChildRuns:!1}){Xf("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let a;if(typeof e=="string")a=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)a=e;else throw new Error(`Invalid run type: ${typeof e}`);a.reference_example_id!==null&&a.reference_example_id!==void 0&&(i=await this.readExample(a.reference_example_id));const o=await n.evaluateRun(a,i),[c,u]=await this._logEvaluationFeedback(o,a,r);return u[0]}async createFeedback(e,n,{score:r,value:s,correction:i,comment:a,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:u,feedbackId:l,feedbackConfig:d,projectId:h,comparativeExperimentId:f}){var y;if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const m={type:c??"api",metadata:o??{}};u!==void 0&&(m==null?void 0:m.metadata)!==void 0&&!m.metadata.__run&&(m.metadata.__run={run_id:u}),(m==null?void 0:m.metadata)!==void 0&&((y=m.metadata.__run)==null?void 0:y.run_id)!==void 0&&Oe(m.metadata.__run.run_id);const g={id:l??Ji(),run_id:e,key:n,score:hw(r),value:s,correction:i,comment:a,feedback_source:m,comparative_experiment_id:f,feedbackConfig:d,session_id:h},_=JSON.stringify(g),b=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const E=await this._fetch(b,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:_});return await _e(E,"create feedback",!0),E}),g}async updateFeedback(e,{score:n,value:r,correction:s,comment:i}){const a={};n!=null&&(a.score=hw(n)),r!=null&&(a.value=r),s!=null&&(a.correction=s),i!=null&&(a.comment=i),Oe(e);const o=JSON.stringify(a);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"update feedback",!0),c})}async readFeedback(e){Oe(e);const n=`/feedback/${e}`;return await this._get(n)}async deleteFeedback(e){Oe(e);const n=`/feedback/${e}`;await this.caller.call(async()=>{const r=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,`delete ${n}`,!0),r})}async*listFeedback({runIds:e,feedbackKeys:n,feedbackSourceTypes:r}={}){const s=new URLSearchParams;if(e)for(const i of e)Oe(i),s.append("run",i);if(n)for(const i of n)s.append("key",i);if(r)for(const i of r)s.append("source",i);for await(const i of this._getPaginated("/feedback",s))yield*i}async createPresignedFeedbackToken(e,n,{expiration:r,feedbackConfig:s}={}){const i={run_id:e,feedback_key:n,feedback_config:s};r?typeof r=="string"?i.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(i.expires_in=r):i.expires_in={hours:3};const a=JSON.stringify(i);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(c,"create presigned feedback token"),c})).json()}async createComparativeExperiment({name:e,experimentIds:n,referenceDatasetId:r,createdAt:s,description:i,metadata:a,id:o}){var d;if(n.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:n[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const c={id:o,name:e,experiment_ids:n,reference_dataset_id:r,description:i,created_at:(d=s??new Date)==null?void 0:d.toISOString(),extra:{}};a&&(c.extra.metadata=a);const u=JSON.stringify(c);return(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(h,"create comparative experiment"),h})).json()}async*listPresignedFeedbackTokens(e){Oe(e);const n=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",n))yield*r}_selectEvalResults(e){let n;return"results"in e?n=e.results:Array.isArray(e)?n=e:n=[e],n}async _logEvaluationFeedback(e,n,r){const s=this._selectEvalResults(e),i=[];for(const a of s){let o=r||{};a.evaluatorInfo&&(o={...a.evaluatorInfo,...o});let c=null;a.targetRunId?c=a.targetRunId:n&&(c=n.id),i.push(await this.createFeedback(c,a.key,{score:a.score,value:a.value,comment:a.comment,correction:a.correction,sourceInfo:o,sourceRunId:a.sourceRunId,feedbackConfig:a.feedbackConfig,feedbackSourceType:"model"}))}return[s,i]}async logEvaluationFeedback(e,n,r){const[s]=await this._logEvaluationFeedback(e,n,r);return s}async*listAnnotationQueues(e={}){const{queueIds:n,name:r,nameContains:s,limit:i}=e,a=new URLSearchParams;n&&n.forEach((c,u)=>{Oe(c,`queueIds[${u}]`),a.append("ids",c)}),r&&a.append("name",r),s&&a.append("name_contains",s),a.append("limit",(i!==void 0?Math.min(i,100):100).toString());let o=0;for await(const c of this._getPaginated("/annotation-queues",a))if(yield*c,o++,i!==void 0&&o>=i)break}async createAnnotationQueue(e){const{name:n,description:r,queueId:s,rubricInstructions:i}=e,a={name:n,description:r,id:s||Ji(),rubric_instructions:i},o=JSON.stringify(Object.fromEntries(Object.entries(a).filter(([u,l])=>l!==void 0)));return(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(u,"create annotation queue"),u})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"read annotation queue"),r})).json()}async updateAnnotationQueue(e,n){const{name:r,description:s,rubricInstructions:i}=n,a=JSON.stringify({name:r,description:s,rubric_instructions:i});await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"delete annotation queue",!0),n})}async addRunsToAnnotationQueue(e,n){const r=JSON.stringify(n.map((s,i)=>Oe(s,`runIds[${i}]`).toString()));await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await _e(s,"add runs to annotation queue",!0),s})}async getRunFromAnnotationQueue(e,n){const r=`/annotation-queues/${Oe(e,"queueId")}/run`;return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${r}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,"get run from annotation queue"),i})).json()}async deleteRunFromAnnotationQueue(e,n){await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}/runs/${Oe(n,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"delete run from annotation queue",!0),r})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Oe(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"get size from annotation queue"),r})).json()}async _currentTenantIsOwner(e){const n=await this._getSettings();return e=="-"||n.tenant_handle===e}async _ownerConflictError(e,n){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${n}`)}async _getLatestCommitHash(e){const r=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"get latest commit hash"),s})).json();if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,n){const[r,s,i]=vs(e),a=JSON.stringify({like:n});return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/likes/${r}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(c,`${n?"like":"unlike"} prompt`),c})).json()}async _getPromptUrl(e){const[n,r,s]=vs(e);if(await this._currentTenantIsOwner(n)){const i=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${r}/${s.substring(0,8)}?organizationId=${i.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${i.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${n}/${r}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${n}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const n of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*n}async*listPrompts(e){const n=new URLSearchParams;n.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),n.append("sort_direction","desc"),n.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&n.append("is_public",e.isPublic.toString()),e!=null&&e.query&&n.append("query",e.query);for await(const r of this._getPaginated("/repos",n,s=>s.repos))yield*r}async getPrompt(e){const[n,r,s]=vs(e),i=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${n}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return(o==null?void 0:o.status)===404?null:(await _e(o,"get prompt"),o)}),a=await(i==null?void 0:i.json());return a!=null&&a.repo?a.repo:null}async createPrompt(e,n){const r=await this._getSettings();if(n!=null&&n.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,i,a]=vs(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const o={repo_handle:i,...(n==null?void 0:n.description)&&{description:n.description},...(n==null?void 0:n.readme)&&{readme:n.readme},...(n==null?void 0:n.tags)&&{tags:n.tags},is_public:!!(n!=null&&n.isPublic)},c=JSON.stringify(o),u=await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(d,"create prompt"),d}),{repo:l}=await u.json();return l}async createCommit(e,n,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,i,a]=vs(e),o=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${s}/${i}`):r==null?void 0:r.parentCommitHash,c={manifest:JSON.parse(JSON.stringify(n)),parent_commit:o},u=JSON.stringify(c),d=await(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/commits/${s}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(h,"create commit"),h})).json();return this._getPromptUrl(`${s}/${i}${d.commit_hash?`:${d.commit_hash}`:""}`)}async updateExamplesMultipart(e,n=[]){return this._updateExamplesMultipart(e,n)}async _updateExamplesMultipart(e,n=[]){var a;if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const o of n){const c=o.id,u={...o.metadata&&{metadata:o.metadata},...o.split&&{split:o.split}},l=Pn(u,`Serializing body for example with id: ${c}`),d=new Blob([l],{type:"application/json"});if(r.append(c,d),o.inputs){const h=Pn(o.inputs,`Serializing inputs for example with id: ${c}`),f=new Blob([h],{type:"application/json"});r.append(`${c}.inputs`,f)}if(o.outputs){const h=Pn(o.outputs,`Serializing outputs whle updating example with id: ${c}`),f=new Blob([h],{type:"application/json"});r.append(`${c}.outputs`,f)}if(o.attachments)for(const[h,f]of Object.entries(o.attachments)){let m,g;Array.isArray(f)?[m,g]=f:(m=f.mimeType,g=f.data);const _=new Blob([g],{type:`${m}; length=${g.byteLength}`});r.append(`${c}.attachment.${h}`,_)}if(o.attachments_operations){const h=Pn(o.attachments_operations,`Serializing attachments while updating example with id: ${c}`),f=new Blob([h],{type:"application/json"});r.append(`${c}.attachments_operations`,f)}}const s=e??((a=n[0])==null?void 0:a.dataset_id);return(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${s}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await _e(o,"update examples"),o})).json()}async uploadExamplesMultipart(e,n=[]){return this._uploadExamplesMultipart(e,n)}async _uploadExamplesMultipart(e,n=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const i of n){const a=(i.id??Ji()).toString(),o={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split},...i.source_run_id&&{source_run_id:i.source_run_id},...i.use_source_run_io&&{use_source_run_io:i.use_source_run_io},...i.use_source_run_attachments&&{use_source_run_attachments:i.use_source_run_attachments}},c=Pn(o,`Serializing body for uploaded example with id: ${a}`),u=new Blob([c],{type:"application/json"});if(r.append(a,u),i.inputs){const l=Pn(i.inputs,`Serializing inputs for uploaded example with id: ${a}`),d=new Blob([l],{type:"application/json"});r.append(`${a}.inputs`,d)}if(i.outputs){const l=Pn(i.outputs,`Serializing outputs for uploaded example with id: ${a}`),d=new Blob([l],{type:"application/json"});r.append(`${a}.outputs`,d)}if(i.attachments)for(const[l,d]of Object.entries(i.attachments)){let h,f;Array.isArray(d)?[h,f]=d:(h=d.mimeType,f=d.data);const m=new Blob([f],{type:`${h}; length=${f.byteLength}`});r.append(`${a}.attachment.${l}`,m)}}return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await _e(i,"upload examples"),i})).json()}async updatePrompt(e,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s]=vs(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const i={};if((n==null?void 0:n.description)!==void 0&&(i.description=n.description),(n==null?void 0:n.readme)!==void 0&&(i.readme=n.readme),(n==null?void 0:n.tags)!==void 0&&(i.tags=n.tags),(n==null?void 0:n.isPublic)!==void 0&&(i.is_public=n.isPublic),(n==null?void 0:n.isArchived)!==void 0&&(i.is_archived=n.isArchived),Object.keys(i).length===0)throw new Error("No valid update options provided");const a=JSON.stringify(i);return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/repos/${r}/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(c,"update prompt"),c})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r,s]=vs(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("delete a prompt",n);return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/repos/${n}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"delete prompt"),a})).json()}async pullPromptCommit(e,n){const[r,s,i]=vs(e),o=await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/commits/${r}/${s}/${i}${n!=null&&n.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(c,"pull prompt commit"),c})).json();return{owner:r,repo:s,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,n){const r=await this.pullPromptCommit(e,{includeModel:n==null?void 0:n.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,n){return await this.promptExists(e)?n&&Object.keys(n).some(s=>s!=="object")&&await this.updatePrompt(e,{description:n==null?void 0:n.description,readme:n==null?void 0:n.readme,tags:n==null?void 0:n.tags,isPublic:n==null?void 0:n.isPublic}):await this.createPrompt(e,{description:n==null?void 0:n.description,readme:n==null?void 0:n.readme,tags:n==null?void 0:n.tags,isPublic:n==null?void 0:n.isPublic}),n!=null&&n.object?await this.createCommit(e,n==null?void 0:n.object,{parentCommitHash:n==null?void 0:n.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,n={}){const{sourceApiUrl:r=this.apiUrl,datasetName:s}=n,[i,a]=this.parseTokenOrUrl(e,r),o=new Qf({apiUrl:i,apiKey:"placeholder"}),c=await o.readSharedDataset(a),u=s||c.name;try{if(await this.hasDataset({datasetId:u})){console.log(`Dataset ${u} already exists in your tenant. Skipping.`);return}}catch{}const l=await o.listSharedExamples(a),d=await this.createDataset(u,{description:c.description,dataType:c.data_type||"kv",inputsSchema:c.inputs_schema_definition??void 0,outputsSchema:c.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(h=>h.inputs),outputs:l.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${u}. You should delete it manually.`),h}}parseTokenOrUrl(e,n,r=2,s="dataset"){try{return Oe(e),[n,e]}catch{}try{const a=new URL(e).pathname.split("/").filter(o=>o!=="");if(a.length>=r){const o=a[a.length-r];return[n,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}async awaitPendingTraceBatches(){var e,n;if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:r})=>r),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await((n=(e=GR())==null?void 0:e.DEFAULT_LANGSMITH_SPAN_PROCESSOR)==null?void 0:n.forceFlush())}};function pw(t){return"dataset_id"in t||"dataset_name"in t}const XO=t=>!!["TRACING_V2","TRACING"].find(n=>En(n)==="true"),Jh=Symbol.for("lc:context_variables");function YO(t){return t.replace(/[-:.]/g,"")}function SE(t,e,n=1){const r=n.toFixed(0).slice(0,3).padStart(3,"0"),s=`${new Date(t).toISOString().slice(0,-1)}${r}Z`;return{dottedOrder:YO(s)+e,microsecondPrecisionDatestring:s}}class Hu{constructor(e,n,r,s){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=n,this.project_name=r,this.replicas=s}static fromHeader(e){const n=e.split(",");let r={},s=[],i,a;for(const o of n){const[c,u]=o.split("="),l=decodeURIComponent(u);c==="langsmith-metadata"?r=JSON.parse(l):c==="langsmith-tags"?s=l.split(","):c==="langsmith-project"?i=l:c==="langsmith-replicas"&&(a=JSON.parse(l))}return new Hu(r,s,i,a)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class wn{constructor(e){var o;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),QO(e)){Object.assign(this,{...e});return}const n=wn.getDefaultConfig(),{metadata:r,...s}=e,i=s.client??wn.getSharedClient(),a={...r,...(o=s==null?void 0:s.extra)==null?void 0:o.metadata};if(s.extra={...s.extra,metadata:a},Object.assign(this,{...n,...s,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=s$(this.replicas),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){const{dottedOrder:c,microsecondPrecisionDatestring:u}=SE(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+c:this.dotted_order=c,this._serialized_start_time=u}}set metadata(e){var n;this.extra={...this.extra,metadata:{...(n=this.extra)==null?void 0:n.metadata,...e}}}get metadata(){var e;return(e=this.extra)==null?void 0:e.metadata}static getDefaultConfig(){return{id:Ji(),run_type:"chain",project_name:uE(),child_runs:[],api_url:Gr("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Gr("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return wn.sharedClient||(wn.sharedClient=new Gm),wn.sharedClient}createChild(e){var c,u,l,d,h,f;const n=this.child_execution_order+1,r=new wn({...e,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:n,child_execution_order:n});Jh in this&&(r[Jh]=this[Jh]);const s=Symbol.for("lc:child_config"),i=((c=e.extra)==null?void 0:c[s])??this.extra[s];if(t$(i)){const m={...i},g=e$(m.callbacks)?(l=(u=m.callbacks).copy)==null?void 0:l.call(u):void 0;g&&(Object.assign(g,{_parentRunId:r.id}),(f=(h=(d=g.handlers)==null?void 0:d.find(xE))==null?void 0:h.updateFromRunTree)==null||f.call(h,r),m.callbacks=g),r.extra[s]=m}const a=new Set;let o=this;for(;o!=null&&!a.has(o.id);)a.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,n),o=o.parent_run;return this.child_runs.push(r),r}async end(e,n,r=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??n,this.end_time=this.end_time??r,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,n,r=!0){var o,c;const s=e.extra??{};if(((o=s==null?void 0:s.runtime)==null?void 0:o.library)===void 0&&(s.runtime||(s.runtime={}),n))for(const[u,l]of Object.entries(n))s.runtime[u]||(s.runtime[u]=l);let i,a;return r?(a=((c=e.parent_run)==null?void 0:c.id)??e.parent_run_id,i=[]):(i=e.child_runs.map(u=>this._convertToCreate(u,n,r)),a=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:i,parent_run_id:a,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_remapForProject(e,n,r=!0){const s=this._convertToCreate(this,n,r);if(e===this.project_name)return s;const i=d=>Yy(`${d}:${e}`,Yy.DNS),a=i(s.id),o=s.trace_id?i(s.trace_id):void 0,c=s.parent_run_id?i(s.parent_run_id):void 0;let u;if(s.dotted_order){const d=n$(s.dotted_order),h=[];for(let m=0;m<d.length-1;m++){const[g,_]=d[m],b=i(_);h.push(g.toISOString().replace(/[-:]/g,"").replace(".","")+b)}const[f]=d[d.length-1];h.push(f.toISOString().replace(/[-:]/g,"").replace(".","")+a),u=h.join(".")}else u=void 0;return{...s,id:a,trace_id:o,parent_run_id:c,dotted_order:u,session_name:e}}async postRun(e=!0){try{const n=fE();if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:s,apiUrl:i,workspaceId:a}of this.replicas){const o=this._remapForProject(r??this.project_name,n,!0);await this.client.createRun(o,{apiKey:s,apiUrl:i,workspaceId:a})}else{const r=this._convertToCreate(this,n,e);await this.client.createRun(r)}if(!e){Xf("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const r of this.child_runs)await r.postRun(!1)}}catch(n){console.error(`Error in postRun for run ${this.id}:`,n)}}async patchRun(e){var n;if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:s,apiUrl:i,workspaceId:a,updates:o}of this.replicas){const c=this._remapForProject(r??this.project_name),u={id:c.id,outputs:c.outputs,error:c.error,parent_run_id:c.parent_run_id,session_name:c.session_name,reference_example_id:c.reference_example_id,end_time:c.end_time,dotted_order:c.dotted_order,trace_id:c.trace_id,events:c.events,tags:c.tags,extra:c.extra,attachments:this.attachments,...o};e!=null&&e.excludeInputs||(u.inputs=c.inputs),await this.client.updateRun(c.id,u,{apiKey:s,apiUrl:i,workspaceId:a})}else try{const r={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:((n=this.parent_run)==null?void 0:n.id)??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e!=null&&e.excludeInputs||(r.inputs=this.inputs),await this.client.updateRun(this.id,r)}catch(r){console.error(`Error in patchRun for run ${this.id}`,r)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,n){var u,l,d,h;const r=e==null?void 0:e.callbacks;let s,i,a,o=XO();if(r){const f=((u=r==null?void 0:r.getParentRunId)==null?void 0:u.call(r))??"",m=(l=r==null?void 0:r.handlers)==null?void 0:l.find(g=>(g==null?void 0:g.name)=="langchain_tracer");s=(d=m==null?void 0:m.getRun)==null?void 0:d.call(m,f),i=m==null?void 0:m.projectName,a=m==null?void 0:m.client,o=o||!!m}return s?new wn({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:a,tracingEnabled:o,project_name:i,tags:[...new Set(((s==null?void 0:s.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(h=s==null?void 0:s.extra)==null?void 0:h.metadata,...e==null?void 0:e.metadata}}}).createChild(n):new wn({...n,client:a,tracingEnabled:o,project_name:i})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,n){var u;const r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=r["langsmith-trace"];if(!s||typeof s!="string")return;const i=s.trim(),a=i.split(".").map(l=>{const[d,h]=l.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:h}}),o=a[0].uuid,c={...n,name:(n==null?void 0:n.name)??"parent",run_type:(n==null?void 0:n.run_type)??"chain",start_time:(n==null?void 0:n.start_time)??Date.now(),id:(u=a.at(-1))==null?void 0:u.uuid,trace_id:o,dotted_order:i};if(r.baggage&&typeof r.baggage=="string"){const l=Hu.fromHeader(r.baggage);c.metadata=l.metadata,c.tags=l.tags,c.project_name=l.project_name,c.replicas=l.replicas}return new wn(c)}toHeaders(e){var r;const n={"langsmith-trace":this.dotted_order,baggage:new Hu((r=this.extra)==null?void 0:r.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[s,i]of Object.entries(n))e.set(s,i);return n}}Object.defineProperty(wn,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function QO(t){return t!=null&&typeof t.createChild=="function"&&typeof t.postRun=="function"}function xE(t){return typeof t=="object"&&t!=null&&typeof t.name=="string"&&t.name==="langchain_tracer"}function mw(t){return Array.isArray(t)&&t.some(e=>xE(e))}function e$(t){return typeof t=="object"&&t!=null&&Array.isArray(t.handlers)}function t$(t){var e;return t!=null&&typeof t.callbacks=="object"&&(mw((e=t.callbacks)==null?void 0:e.handlers)||mw(t.callbacks))}function n$(t){return t.split(".").map(n=>{const r=n.slice(0,-36),s=n.slice(-36),i=parseInt(r.slice(0,4)),a=parseInt(r.slice(4,6))-1,o=parseInt(r.slice(6,8)),c=parseInt(r.slice(9,11)),u=parseInt(r.slice(11,13)),l=parseInt(r.slice(13,15)),d=parseInt(r.slice(15,21));return[new Date(i,a,o,c,u,l,d/1e3),s]})}function r$(){const t=Gr("LANGSMITH_RUNS_ENDPOINTS");if(!t)return[];try{const e=JSON.parse(t);if(Array.isArray(e)){const n=[];for(const r of e){if(typeof r!="object"||r===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof r}`);continue}if(typeof r.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_url}`);continue}if(typeof r.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_key}`);continue}n.push({apiUrl:r.api_url.replace(/\/$/,""),apiKey:r.api_key})}return n}else if(typeof e=="object"&&e!==null){i$(e);const n=[];for(const[r,s]of Object.entries(e)){const i=r.replace(/\/$/,"");if(typeof s=="string")n.push({apiUrl:i,apiKey:s});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${r}: expected string, got ${typeof s}`);continue}}return n}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS – must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof e}`),[]}catch(e){if(DO(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS – must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function s$(t){return t?t.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):r$()}function i$(t){if(Object.keys(t).length>0&&En("ENDPOINT"))throw new MO}var TE={};ve(TE,{BaseTracer:()=>ws,isBaseTracer:()=>Zi});const a$=t=>{if(t)return t.events=t.events??[],t.child_runs=t.child_runs??[],t};function ep(t,e){if(t)return new wn({...t,start_time:t._serialized_start_time??t.start_time,parent_run:ep(e),child_runs:t.child_runs.map(n=>ep(n)).filter(n=>n!==void 0),extra:{...t.extra,runtime:Wv()},tracingEnabled:!1})}function Zh(t,e){return t&&!Array.isArray(t)&&typeof t=="object"?t:{[e]:t}}function Zi(t){return typeof t._addRunToRunMap=="function"}var ws=class extends Oa{constructor(e){super(...arguments);p(this,"runMap",new Map);p(this,"runTreeMap",new Map);p(this,"usesRunTreeMap",!1)}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?a$(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,n){e.child_runs.push(n)}_addRunToRunMap(e){const{dottedOrder:n,microsecondPrecisionDatestring:r}=SE(new Date(e.start_time).getTime(),e.id,e.execution_order),s={...e},i=this.getRunById(s.parent_run_id);if(s.parent_run_id!==void 0?i&&(this._addChildRun(i,s),i.child_execution_order=Math.max(i.child_execution_order,s.child_execution_order),s.trace_id=i.trace_id,i.dotted_order!==void 0&&(s.dotted_order=[i.dotted_order,n].join("."),s._serialized_start_time=r)):(s.trace_id=s.id,s.dotted_order=n,s._serialized_start_time=r),this.usesRunTreeMap){const a=ep(s,i);a!==void 0&&this.runTreeMap.set(s.id,a)}else this.runMap.set(s.id,s);return s}async _endTrace(e){var r;const n=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);n?n.child_execution_order=Math.max(n.child_execution_order,e.child_execution_order):await this.persistRun(e),await((r=this.onRunUpdate)==null?void 0:r.call(this,e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const n=e!==void 0&&this.getRunById(e);return n?n.child_execution_order+1:1}_createRunForLLMStart(e,n,r,s,i,a,o,c){const u=this._getExecutionOrder(s),l=Date.now(),d=o?{...i,metadata:o}:i,h={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:n},execution_order:u,child_runs:[],child_execution_order:u,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,n,r,s,i,a,o,c){var l,d;const u=this.getRunById(r)??this._createRunForLLMStart(e,n,r,s,i,a,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onLLMStart)==null?void 0:d.call(this,u)),u}_createRunForChatModelStart(e,n,r,s,i,a,o,c){const u=this._getExecutionOrder(s),l=Date.now(),d=o?{...i,metadata:o}:i,h={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:n},execution_order:u,child_runs:[],child_execution_order:u,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,n,r,s,i,a,o,c){var l,d;const u=this.getRunById(r)??this._createRunForChatModelStart(e,n,r,s,i,a,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onLLMStart)==null?void 0:d.call(this,u)),u}async handleLLMEnd(e,n,r,s,i){var o;const a=this.getRunById(n);if(!a||(a==null?void 0:a.run_type)!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.outputs=e,a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await((o=this.onLLMEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleLLMError(e,n,r,s,i){var o;const a=this.getRunById(n);if(!a||(a==null?void 0:a.run_type)!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await((o=this.onLLMError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}_createRunForChainStart(e,n,r,s,i,a,o,c){const u=this._getExecutionOrder(s),l=Date.now(),d={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:n,execution_order:u,child_execution_order:u,run_type:o??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(d)}async handleChainStart(e,n,r,s,i,a,o,c){var l,d;const u=this.getRunById(r)??this._createRunForChainStart(e,n,r,s,i,a,o,c);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onChainStart)==null?void 0:d.call(this,u)),u}async handleChainEnd(e,n,r,s,i){var o;const a=this.getRunById(n);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=Zh(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=Zh(i.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleChainError(e,n,r,s,i){var o;const a=this.getRunById(n);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=Zh(i.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}_createRunForToolStart(e,n,r,s,i,a,o){const c=this._getExecutionOrder(s),u=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{input:n},execution_order:c,child_execution_order:c,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleToolStart(e,n,r,s,i,a,o){var u,l;const c=this.getRunById(r)??this._createRunForToolStart(e,n,r,s,i,a,o);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((l=this.onToolStart)==null?void 0:l.call(this,c)),c}async handleToolEnd(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,n){var i;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((i=this.onAgentAction)==null?void 0:i.call(this,r))}async handleAgentEnd(e,n){var s;const r=this.getRunById(n);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}_createRunForRetrieverStart(e,n,r,s,i,a,o){const c=this._getExecutionOrder(s),u=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{query:n},execution_order:c,child_execution_order:c,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,n,r,s,i,a,o){var u,l;const c=this.getRunById(r)??this._createRunForRetrieverStart(e,n,r,s,i,a,o);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((l=this.onRetrieverStart)==null?void 0:l.call(this,c)),c}async handleRetrieverEnd(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,n){var s;const r=this.getRunById(n);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,n,r,s,i,a){var c;const o=this.getRunById(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:n,chunk:a==null?void 0:a.chunk}}),await((c=this.onLLMNewToken)==null?void 0:c.call(this,o,e,{chunk:a==null?void 0:a.chunk})),o}},fu={exports:{}};fu.exports;var gw;function o$(){return gw||(gw=1,(function(t){const n=(i=0)=>a=>`\x1B[${38+i};5;${a}m`,r=(i=0)=>(a,o,c)=>`\x1B[${38+i};2;${a};${o};${c}m`;function s(){const i=new Map,a={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};a.color.gray=a.color.blackBright,a.bgColor.bgGray=a.bgColor.bgBlackBright,a.color.grey=a.color.blackBright,a.bgColor.bgGrey=a.bgColor.bgBlackBright;for(const[o,c]of Object.entries(a)){for(const[u,l]of Object.entries(c))a[u]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},c[u]=a[u],i.set(l[0],l[1]);Object.defineProperty(a,o,{value:c,enumerable:!1})}return Object.defineProperty(a,"codes",{value:i,enumerable:!1}),a.color.close="\x1B[39m",a.bgColor.close="\x1B[49m",a.color.ansi256=n(),a.color.ansi16m=r(),a.bgColor.ansi256=n(10),a.bgColor.ansi16m=r(10),Object.defineProperties(a,{rgbToAnsi256:{value:(o,c,u)=>o===c&&c===u?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(u/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:u}=c.groups;u.length===3&&(u=u.split("").map(d=>d+d).join(""));const l=Number.parseInt(u,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>a.rgbToAnsi256(...a.hexToRgb(o)),enumerable:!1}}),a}Object.defineProperty(t,"exports",{enumerable:!0,get:s})})(fu)),fu.exports}var c$=o$();const AE=Ra(c$);var CE={};ve(CE,{ConsoleCallbackHandler:()=>tp});function sn(t,e){return`${t.open}${e}${t.close}`}function Jn(t,e){try{return JSON.stringify(t,null,2)}catch{return e}}function yw(t){return typeof t=="string"?t.trim():t==null?t:Jn(t,t.toString())}function Es(t){if(!t.end_time)return"";const e=t.end_time-t.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:_n}=AE;var tp=class extends ws{constructor(){super(...arguments);p(this,"name","console_callback_handler")}persistRun(e){return Promise.resolve()}getParents(e){const n=[];let r=e;for(;r.parent_run_id;){const s=this.runMap.get(r.parent_run_id);if(s)n.push(s),r=s;else break}return n}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((s,i,a)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return i===a.length-1?sn(AE.bold,o):o}).join(" > ");return sn(_n.grey,r)}onChainStart(e){const n=this.getBreadcrumbs(e);console.log(`${sn(_n.green,"[chain/start]")} [${n}] Entering Chain run with input: ${Jn(e.inputs,"[inputs]")}`)}onChainEnd(e){const n=this.getBreadcrumbs(e);console.log(`${sn(_n.cyan,"[chain/end]")} [${n}] [${Es(e)}] Exiting Chain run with output: ${Jn(e.outputs,"[outputs]")}`)}onChainError(e){const n=this.getBreadcrumbs(e);console.log(`${sn(_n.red,"[chain/error]")} [${n}] [${Es(e)}] Chain run errored with error: ${Jn(e.error,"[error]")}`)}onLLMStart(e){const n=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${sn(_n.green,"[llm/start]")} [${n}] Entering LLM run with input: ${Jn(r,"[inputs]")}`)}onLLMEnd(e){const n=this.getBreadcrumbs(e);console.log(`${sn(_n.cyan,"[llm/end]")} [${n}] [${Es(e)}] Exiting LLM run with output: ${Jn(e.outputs,"[response]")}`)}onLLMError(e){const n=this.getBreadcrumbs(e);console.log(`${sn(_n.red,"[llm/error]")} [${n}] [${Es(e)}] LLM run errored with error: ${Jn(e.error,"[error]")}`)}onToolStart(e){const n=this.getBreadcrumbs(e);console.log(`${sn(_n.green,"[tool/start]")} [${n}] Entering Tool run with input: "${yw(e.inputs.input)}"`)}onToolEnd(e){var r;const n=this.getBreadcrumbs(e);console.log(`${sn(_n.cyan,"[tool/end]")} [${n}] [${Es(e)}] Exiting Tool run with output: "${yw((r=e.outputs)==null?void 0:r.output)}"`)}onToolError(e){const n=this.getBreadcrumbs(e);console.log(`${sn(_n.red,"[tool/error]")} [${n}] [${Es(e)}] Tool run errored with error: ${Jn(e.error,"[error]")}`)}onRetrieverStart(e){const n=this.getBreadcrumbs(e);console.log(`${sn(_n.green,"[retriever/start]")} [${n}] Entering Retriever run with input: ${Jn(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const n=this.getBreadcrumbs(e);console.log(`${sn(_n.cyan,"[retriever/end]")} [${n}] [${Es(e)}] Exiting Retriever run with output: ${Jn(e.outputs,"[outputs]")}`)}onRetrieverError(e){const n=this.getBreadcrumbs(e);console.log(`${sn(_n.red,"[retriever/error]")} [${n}] [${Es(e)}] Retriever run errored with error: ${Jn(e.error,"[error]")}`)}onAgentAction(e){const n=e,r=this.getBreadcrumbs(e);console.log(`${sn(_n.blue,"[agent/action]")} [${r}] Agent selected action: ${Jn(n.actions[n.actions.length-1],"[action]")}`)}};let Kh;const kE=()=>{if(Kh===void 0){const t=nr("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Kh=new Gm(t)}return Kh};let u$=class{getStore(){}run(e,n){return n()}};const Xh=Symbol.for("ls:tracing_async_local_storage"),l$=new u$;let d$=class{getInstance(){return globalThis[Xh]??l$}initializeGlobalInstance(e){globalThis[Xh]===void 0&&(globalThis[Xh]=e)}};const h$=new d$;function f$(t=!1){const e=h$.getInstance().getStore();if(!t&&e===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function Wm(t){return typeof t=="function"&&"langsmith:traceable"in t}var IE={};ve(IE,{LangChainTracer:()=>pu});var pu=class RE extends ws{constructor(n={}){super(n);p(this,"name","langchain_tracer");p(this,"projectName");p(this,"exampleId");p(this,"client");p(this,"replicas");p(this,"usesRunTreeMap",!0);const{exampleId:r,projectName:s,client:i,replicas:a}=n;this.projectName=s??uE(),this.replicas=a,this.exampleId=r,this.client=i??kE();const o=RE.getTraceableRunTree();o&&this.updateFromRunTree(o)}async persistRun(n){}async onRunCreate(n){const r=this.getRunTreeWithTracingConfig(n.id);await(r==null?void 0:r.postRun())}async onRunUpdate(n){const r=this.getRunTreeWithTracingConfig(n.id);await(r==null?void 0:r.patchRun())}getRun(n){return this.runTreeMap.get(n)}updateFromRunTree(n){this.runTreeMap.set(n.id,n);let r=n;const s=new Set;for(;r.parent_run&&!(s.has(r.id)||(s.add(r.id),!r.parent_run));)r=r.parent_run;s.clear();const i=[r];for(;i.length>0;){const a=i.shift();!a||s.has(a.id)||(s.add(a.id),this.runTreeMap.set(a.id,a),a.child_runs&&i.push(...a.child_runs))}this.client=n.client??this.client,this.replicas=n.replicas??this.replicas,this.projectName=n.project_name??this.projectName,this.exampleId=n.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(n){const r=this.runTreeMap.get(n);if(r)return new wn({...r,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return f$(!0)}catch{return}}};const OE=Symbol.for("ls:tracing_async_local_storage"),fo=Symbol.for("lc:context_variables"),p$=t=>{globalThis[OE]=t},Co=()=>globalThis[OE];let hi;function m$(){const t="default"in us?us.default:us;return new t({autoStart:!0,concurrency:1})}function g$(){return typeof hi>"u"&&(hi=m$()),hi}async function wt(t,e){if(e===!0){const n=Co();n!==void 0?await n.run(void 0,async()=>t()):await t()}else hi=g$(),hi.add(async()=>{const n=Co();n!==void 0?await n.run(void 0,async()=>t()):await t()})}async function y$(){const t=kE();await Promise.allSettled([typeof hi<"u"?hi.onIdle():Promise.resolve(),t.awaitPendingTraceBatches()])}var $E={};ve($E,{awaitAllCallbacks:()=>y$,consumeCallback:()=>wt});function np(t,e=ma){t=t.trim();const n=t.indexOf("```");if(n===-1)return e(t);let r=t.substring(n+3);r.startsWith(`json
`)?r=r.substring(5):r.startsWith("json")?r=r.substring(4):r.startsWith(`
`)&&(r=r.substring(1));const s=r.indexOf("```");let i=r;return s!==-1&&(i=r.substring(0,s)),e(i.trim())}function ma(t){if(typeof t>"u")return null;try{return JSON.parse(t)}catch{}let e="";const n=[];let r=!1,s=!1;for(let i of t){if(r)i==='"'&&!s?r=!1:i===`
`&&!s?i="\\n":i==="\\"?s=!s:s=!1;else if(i==='"')r=!0,s=!1;else if(i==="{")n.push("}");else if(i==="[")n.push("]");else if(i==="}"||i==="]")if(n&&n[n.length-1]===i)n.pop();else return null;e+=i}r&&(e+='"');for(let i=n.length-1;i>=0;i-=1)e+=n[i];try{return JSON.parse(e)}catch{return null}}var NE={},Xl={};Xl.byteLength=b$;Xl.toByteArray=E$;Xl.fromByteArray=T$;var Lr=[],Zn=[],_$=typeof Uint8Array<"u"?Uint8Array:Array,Yh="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Ui=0,w$=Yh.length;Ui<w$;++Ui)Lr[Ui]=Yh[Ui],Zn[Yh.charCodeAt(Ui)]=Ui;Zn[45]=62;Zn[95]=63;function PE(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function b$(t){var e=PE(t),n=e[0],r=e[1];return(n+r)*3/4-r}function v$(t,e,n){return(e+n)*3/4-n}function E$(t){var e,n=PE(t),r=n[0],s=n[1],i=new _$(v$(t,r,s)),a=0,o=s>0?r-4:r,c;for(c=0;c<o;c+=4)e=Zn[t.charCodeAt(c)]<<18|Zn[t.charCodeAt(c+1)]<<12|Zn[t.charCodeAt(c+2)]<<6|Zn[t.charCodeAt(c+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return s===2&&(e=Zn[t.charCodeAt(c)]<<2|Zn[t.charCodeAt(c+1)]>>4,i[a++]=e&255),s===1&&(e=Zn[t.charCodeAt(c)]<<10|Zn[t.charCodeAt(c+1)]<<4|Zn[t.charCodeAt(c+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function S$(t){return Lr[t>>18&63]+Lr[t>>12&63]+Lr[t>>6&63]+Lr[t&63]}function x$(t,e,n){for(var r,s=[],i=e;i<n;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(S$(r));return s.join("")}function T$(t){for(var e,n=t.length,r=n%3,s=[],i=16383,a=0,o=n-r;a<o;a+=i)s.push(x$(t,a,a+i>o?o:a+i));return r===1?(e=t[n-1],s.push(Lr[e>>2]+Lr[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(Lr[e>>10]+Lr[e>>4&63]+Lr[e<<2&63]+"=")),s.join("")}var Jm={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */Jm.read=function(t,e,n,r,s){var i,a,o=s*8-r-1,c=(1<<o)-1,u=c>>1,l=-7,d=n?s-1:0,h=n?-1:1,f=t[e+d];for(d+=h,i=f&(1<<-l)-1,f>>=-l,l+=o;l>0;i=i*256+t[e+d],d+=h,l-=8);for(a=i&(1<<-l)-1,i>>=-l,l+=r;l>0;a=a*256+t[e+d],d+=h,l-=8);if(i===0)i=1-u;else{if(i===c)return a?NaN:(f?-1:1)*(1/0);a=a+Math.pow(2,r),i=i-u}return(f?-1:1)*a*Math.pow(2,i-r)};Jm.write=function(t,e,n,r,s,i){var a,o,c,u=i*8-s-1,l=(1<<u)-1,d=l>>1,h=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:i-1,m=r?1:-1,g=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(o=isNaN(e)?1:0,a=l):(a=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-a))<1&&(a--,c*=2),a+d>=1?e+=h/c:e+=h*Math.pow(2,1-d),e*c>=2&&(a++,c/=2),a+d>=l?(o=0,a=l):a+d>=1?(o=(e*c-1)*Math.pow(2,s),a=a+d):(o=e*Math.pow(2,d-1)*Math.pow(2,s),a=0));s>=8;t[n+f]=o&255,f+=m,o/=256,s-=8);for(a=a<<s|o,u+=s;u>0;t[n+f]=a&255,f+=m,a/=256,u-=8);t[n+f-m]|=g*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(t){const e=Xl,n=Jm,r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=l,t.SlowBuffer=k,t.INSPECT_MAX_BYTES=50;const s=2147483647;t.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:a,SharedArrayBuffer:o}=globalThis;l.TYPED_ARRAY_SUPPORT=c(),!l.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function c(){try{const x=new i(1),w={foo:function(){return 42}};return Object.setPrototypeOf(w,i.prototype),Object.setPrototypeOf(x,w),x.foo()===42}catch{return!1}}Object.defineProperty(l.prototype,"parent",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.buffer}}),Object.defineProperty(l.prototype,"offset",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.byteOffset}});function u(x){if(x>s)throw new RangeError('The value "'+x+'" is invalid for option "size"');const w=new i(x);return Object.setPrototypeOf(w,l.prototype),w}function l(x,w,v){if(typeof x=="number"){if(typeof w=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return m(x)}return d(x,w,v)}l.poolSize=8192;function d(x,w,v){if(typeof x=="string")return g(x,w);if(a.isView(x))return b(x);if(x==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof x);if(Y(x,a)||x&&Y(x.buffer,a)||typeof o<"u"&&(Y(x,o)||x&&Y(x.buffer,o)))return y(x,w,v);if(typeof x=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const I=x.valueOf&&x.valueOf();if(I!=null&&I!==x)return l.from(I,w,v);const O=E(x);if(O)return O;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof x[Symbol.toPrimitive]=="function")return l.from(x[Symbol.toPrimitive]("string"),w,v);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof x)}l.from=function(x,w,v){return d(x,w,v)},Object.setPrototypeOf(l.prototype,i.prototype),Object.setPrototypeOf(l,i);function h(x){if(typeof x!="number")throw new TypeError('"size" argument must be of type number');if(x<0)throw new RangeError('The value "'+x+'" is invalid for option "size"')}function f(x,w,v){return h(x),x<=0?u(x):w!==void 0?typeof v=="string"?u(x).fill(w,v):u(x).fill(w):u(x)}l.alloc=function(x,w,v){return f(x,w,v)};function m(x){return h(x),u(x<0?0:C(x)|0)}l.allocUnsafe=function(x){return m(x)},l.allocUnsafeSlow=function(x){return m(x)};function g(x,w){if((typeof w!="string"||w==="")&&(w="utf8"),!l.isEncoding(w))throw new TypeError("Unknown encoding: "+w);const v=R(x,w)|0;let I=u(v);const O=I.write(x,w);return O!==v&&(I=I.slice(0,O)),I}function _(x){const w=x.length<0?0:C(x.length)|0,v=u(w);for(let I=0;I<w;I+=1)v[I]=x[I]&255;return v}function b(x){if(Y(x,i)){const w=new i(x);return y(w.buffer,w.byteOffset,w.byteLength)}return _(x)}function y(x,w,v){if(w<0||x.byteLength<w)throw new RangeError('"offset" is outside of buffer bounds');if(x.byteLength<w+(v||0))throw new RangeError('"length" is outside of buffer bounds');let I;return w===void 0&&v===void 0?I=new i(x):v===void 0?I=new i(x,w):I=new i(x,w,v),Object.setPrototypeOf(I,l.prototype),I}function E(x){if(l.isBuffer(x)){const w=C(x.length)|0,v=u(w);return v.length===0||x.copy(v,0,0,w),v}if(x.length!==void 0)return typeof x.length!="number"||K(x.length)?u(0):_(x);if(x.type==="Buffer"&&Array.isArray(x.data))return _(x.data)}function C(x){if(x>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return x|0}function k(x){return+x!=x&&(x=0),l.alloc(+x)}l.isBuffer=function(w){return w!=null&&w._isBuffer===!0&&w!==l.prototype},l.compare=function(w,v){if(Y(w,i)&&(w=l.from(w,w.offset,w.byteLength)),Y(v,i)&&(v=l.from(v,v.offset,v.byteLength)),!l.isBuffer(w)||!l.isBuffer(v))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(w===v)return 0;let I=w.length,O=v.length;for(let L=0,U=Math.min(I,O);L<U;++L)if(w[L]!==v[L]){I=w[L],O=v[L];break}return I<O?-1:O<I?1:0},l.isEncoding=function(w){switch(String(w).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(w,v){if(!Array.isArray(w))throw new TypeError('"list" argument must be an Array of Buffers');if(w.length===0)return l.alloc(0);let I;if(v===void 0)for(v=0,I=0;I<w.length;++I)v+=w[I].length;const O=l.allocUnsafe(v);let L=0;for(I=0;I<w.length;++I){let U=w[I];if(Y(U,i))L+U.length>O.length?(l.isBuffer(U)||(U=l.from(U)),U.copy(O,L)):i.prototype.set.call(O,U,L);else if(l.isBuffer(U))U.copy(O,L);else throw new TypeError('"list" argument must be an Array of Buffers');L+=U.length}return O};function R(x,w){if(l.isBuffer(x))return x.length;if(a.isView(x)||Y(x,a))return x.byteLength;if(typeof x!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof x);const v=x.length,I=arguments.length>2&&arguments[2]===!0;if(!I&&v===0)return 0;let O=!1;for(;;)switch(w){case"ascii":case"latin1":case"binary":return v;case"utf8":case"utf-8":return X(x).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return v*2;case"hex":return v>>>1;case"base64":return pe(x).length;default:if(O)return I?-1:X(x).length;w=(""+w).toLowerCase(),O=!0}}l.byteLength=R;function $(x,w,v){let I=!1;if((w===void 0||w<0)&&(w=0),w>this.length||((v===void 0||v>this.length)&&(v=this.length),v<=0)||(v>>>=0,w>>>=0,v<=w))return"";for(x||(x="utf8");;)switch(x){case"hex":return J(this,w,v);case"utf8":case"utf-8":return re(this,w,v);case"ascii":return fe(this,w,v);case"latin1":case"binary":return Ce(this,w,v);case"base64":return H(this,w,v);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Q(this,w,v);default:if(I)throw new TypeError("Unknown encoding: "+x);x=(x+"").toLowerCase(),I=!0}}l.prototype._isBuffer=!0;function T(x,w,v){const I=x[w];x[w]=x[v],x[v]=I}l.prototype.swap16=function(){const w=this.length;if(w%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let v=0;v<w;v+=2)T(this,v,v+1);return this},l.prototype.swap32=function(){const w=this.length;if(w%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let v=0;v<w;v+=4)T(this,v,v+3),T(this,v+1,v+2);return this},l.prototype.swap64=function(){const w=this.length;if(w%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let v=0;v<w;v+=8)T(this,v,v+7),T(this,v+1,v+6),T(this,v+2,v+5),T(this,v+3,v+4);return this},l.prototype.toString=function(){const w=this.length;return w===0?"":arguments.length===0?re(this,0,w):$.apply(this,arguments)},l.prototype.toLocaleString=l.prototype.toString,l.prototype.equals=function(w){if(!l.isBuffer(w))throw new TypeError("Argument must be a Buffer");return this===w?!0:l.compare(this,w)===0},l.prototype.inspect=function(){let w="";const v=t.INSPECT_MAX_BYTES;return w=this.toString("hex",0,v).replace(/(.{2})/g,"$1 ").trim(),this.length>v&&(w+=" ... "),"<Buffer "+w+">"},r&&(l.prototype[r]=l.prototype.inspect),l.prototype.compare=function(w,v,I,O,L){if(Y(w,i)&&(w=l.from(w,w.offset,w.byteLength)),!l.isBuffer(w))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof w);if(v===void 0&&(v=0),I===void 0&&(I=w?w.length:0),O===void 0&&(O=0),L===void 0&&(L=this.length),v<0||I>w.length||O<0||L>this.length)throw new RangeError("out of range index");if(O>=L&&v>=I)return 0;if(O>=L)return-1;if(v>=I)return 1;if(v>>>=0,I>>>=0,O>>>=0,L>>>=0,this===w)return 0;let U=L-O,Ue=I-v;const ct=Math.min(U,Ue),st=this.slice(O,L),ut=w.slice(v,I);for(let tt=0;tt<ct;++tt)if(st[tt]!==ut[tt]){U=st[tt],Ue=ut[tt];break}return U<Ue?-1:Ue<U?1:0};function B(x,w,v,I,O){if(x.length===0)return-1;if(typeof v=="string"?(I=v,v=0):v>2147483647?v=2147483647:v<-2147483648&&(v=-2147483648),v=+v,K(v)&&(v=O?0:x.length-1),v<0&&(v=x.length+v),v>=x.length){if(O)return-1;v=x.length-1}else if(v<0)if(O)v=0;else return-1;if(typeof w=="string"&&(w=l.from(w,I)),l.isBuffer(w))return w.length===0?-1:z(x,w,v,I,O);if(typeof w=="number")return w=w&255,typeof i.prototype.indexOf=="function"?O?i.prototype.indexOf.call(x,w,v):i.prototype.lastIndexOf.call(x,w,v):z(x,[w],v,I,O);throw new TypeError("val must be string, number or Buffer")}function z(x,w,v,I,O){let L=1,U=x.length,Ue=w.length;if(I!==void 0&&(I=String(I).toLowerCase(),I==="ucs2"||I==="ucs-2"||I==="utf16le"||I==="utf-16le")){if(x.length<2||w.length<2)return-1;L=2,U/=2,Ue/=2,v/=2}function ct(ut,tt){return L===1?ut[tt]:ut.readUInt16BE(tt*L)}let st;if(O){let ut=-1;for(st=v;st<U;st++)if(ct(x,st)===ct(w,ut===-1?0:st-ut)){if(ut===-1&&(ut=st),st-ut+1===Ue)return ut*L}else ut!==-1&&(st-=st-ut),ut=-1}else for(v+Ue>U&&(v=U-Ue),st=v;st>=0;st--){let ut=!0;for(let tt=0;tt<Ue;tt++)if(ct(x,st+tt)!==ct(w,tt)){ut=!1;break}if(ut)return st}return-1}l.prototype.includes=function(w,v,I){return this.indexOf(w,v,I)!==-1},l.prototype.indexOf=function(w,v,I){return B(this,w,v,I,!0)},l.prototype.lastIndexOf=function(w,v,I){return B(this,w,v,I,!1)};function q(x,w,v,I){v=Number(v)||0;const O=x.length-v;I?(I=Number(I),I>O&&(I=O)):I=O;const L=w.length;I>L/2&&(I=L/2);let U;for(U=0;U<I;++U){const Ue=parseInt(w.substr(U*2,2),16);if(K(Ue))return U;x[v+U]=Ue}return U}function ie(x,w,v,I){return Ee(X(w,x.length-v),x,v,I)}function me(x,w,v,I){return Ee(Xr(w),x,v,I)}function j(x,w,v,I){return Ee(pe(w),x,v,I)}function F(x,w,v,I){return Ee(Se(w,x.length-v),x,v,I)}l.prototype.write=function(w,v,I,O){if(v===void 0)O="utf8",I=this.length,v=0;else if(I===void 0&&typeof v=="string")O=v,I=this.length,v=0;else if(isFinite(v))v=v>>>0,isFinite(I)?(I=I>>>0,O===void 0&&(O="utf8")):(O=I,I=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const L=this.length-v;if((I===void 0||I>L)&&(I=L),w.length>0&&(I<0||v<0)||v>this.length)throw new RangeError("Attempt to write outside buffer bounds");O||(O="utf8");let U=!1;for(;;)switch(O){case"hex":return q(this,w,v,I);case"utf8":case"utf-8":return ie(this,w,v,I);case"ascii":case"latin1":case"binary":return me(this,w,v,I);case"base64":return j(this,w,v,I);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return F(this,w,v,I);default:if(U)throw new TypeError("Unknown encoding: "+O);O=(""+O).toLowerCase(),U=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function H(x,w,v){return w===0&&v===x.length?e.fromByteArray(x):e.fromByteArray(x.slice(w,v))}function re(x,w,v){v=Math.min(x.length,v);const I=[];let O=w;for(;O<v;){const L=x[O];let U=null,Ue=L>239?4:L>223?3:L>191?2:1;if(O+Ue<=v){let ct,st,ut,tt;switch(Ue){case 1:L<128&&(U=L);break;case 2:ct=x[O+1],(ct&192)===128&&(tt=(L&31)<<6|ct&63,tt>127&&(U=tt));break;case 3:ct=x[O+1],st=x[O+2],(ct&192)===128&&(st&192)===128&&(tt=(L&15)<<12|(ct&63)<<6|st&63,tt>2047&&(tt<55296||tt>57343)&&(U=tt));break;case 4:ct=x[O+1],st=x[O+2],ut=x[O+3],(ct&192)===128&&(st&192)===128&&(ut&192)===128&&(tt=(L&15)<<18|(ct&63)<<12|(st&63)<<6|ut&63,tt>65535&&tt<1114112&&(U=tt))}}U===null?(U=65533,Ue=1):U>65535&&(U-=65536,I.push(U>>>10&1023|55296),U=56320|U&1023),I.push(U),O+=Ue}return ne(I)}const ue=4096;function ne(x){const w=x.length;if(w<=ue)return String.fromCharCode.apply(String,x);let v="",I=0;for(;I<w;)v+=String.fromCharCode.apply(String,x.slice(I,I+=ue));return v}function fe(x,w,v){let I="";v=Math.min(x.length,v);for(let O=w;O<v;++O)I+=String.fromCharCode(x[O]&127);return I}function Ce(x,w,v){let I="";v=Math.min(x.length,v);for(let O=w;O<v;++O)I+=String.fromCharCode(x[O]);return I}function J(x,w,v){const I=x.length;(!w||w<0)&&(w=0),(!v||v<0||v>I)&&(v=I);let O="";for(let L=w;L<v;++L)O+=Te[x[L]];return O}function Q(x,w,v){const I=x.slice(w,v);let O="";for(let L=0;L<I.length-1;L+=2)O+=String.fromCharCode(I[L]+I[L+1]*256);return O}l.prototype.slice=function(w,v){const I=this.length;w=~~w,v=v===void 0?I:~~v,w<0?(w+=I,w<0&&(w=0)):w>I&&(w=I),v<0?(v+=I,v<0&&(v=0)):v>I&&(v=I),v<w&&(v=w);const O=this.subarray(w,v);return Object.setPrototypeOf(O,l.prototype),O};function ae(x,w,v){if(x%1!==0||x<0)throw new RangeError("offset is not uint");if(x+w>v)throw new RangeError("Trying to access beyond buffer length")}l.prototype.readUintLE=l.prototype.readUIntLE=function(w,v,I){w=w>>>0,v=v>>>0,I||ae(w,v,this.length);let O=this[w],L=1,U=0;for(;++U<v&&(L*=256);)O+=this[w+U]*L;return O},l.prototype.readUintBE=l.prototype.readUIntBE=function(w,v,I){w=w>>>0,v=v>>>0,I||ae(w,v,this.length);let O=this[w+--v],L=1;for(;v>0&&(L*=256);)O+=this[w+--v]*L;return O},l.prototype.readUint8=l.prototype.readUInt8=function(w,v){return w=w>>>0,v||ae(w,1,this.length),this[w]},l.prototype.readUint16LE=l.prototype.readUInt16LE=function(w,v){return w=w>>>0,v||ae(w,2,this.length),this[w]|this[w+1]<<8},l.prototype.readUint16BE=l.prototype.readUInt16BE=function(w,v){return w=w>>>0,v||ae(w,2,this.length),this[w]<<8|this[w+1]},l.prototype.readUint32LE=l.prototype.readUInt32LE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),(this[w]|this[w+1]<<8|this[w+2]<<16)+this[w+3]*16777216},l.prototype.readUint32BE=l.prototype.readUInt32BE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),this[w]*16777216+(this[w+1]<<16|this[w+2]<<8|this[w+3])},l.prototype.readBigUInt64LE=ye(function(w){w=w>>>0,Ke(w,"offset");const v=this[w],I=this[w+7];(v===void 0||I===void 0)&&$t(w,this.length-8);const O=v+this[++w]*2**8+this[++w]*2**16+this[++w]*2**24,L=this[++w]+this[++w]*2**8+this[++w]*2**16+I*2**24;return BigInt(O)+(BigInt(L)<<BigInt(32))}),l.prototype.readBigUInt64BE=ye(function(w){w=w>>>0,Ke(w,"offset");const v=this[w],I=this[w+7];(v===void 0||I===void 0)&&$t(w,this.length-8);const O=v*2**24+this[++w]*2**16+this[++w]*2**8+this[++w],L=this[++w]*2**24+this[++w]*2**16+this[++w]*2**8+I;return(BigInt(O)<<BigInt(32))+BigInt(L)}),l.prototype.readIntLE=function(w,v,I){w=w>>>0,v=v>>>0,I||ae(w,v,this.length);let O=this[w],L=1,U=0;for(;++U<v&&(L*=256);)O+=this[w+U]*L;return L*=128,O>=L&&(O-=Math.pow(2,8*v)),O},l.prototype.readIntBE=function(w,v,I){w=w>>>0,v=v>>>0,I||ae(w,v,this.length);let O=v,L=1,U=this[w+--O];for(;O>0&&(L*=256);)U+=this[w+--O]*L;return L*=128,U>=L&&(U-=Math.pow(2,8*v)),U},l.prototype.readInt8=function(w,v){return w=w>>>0,v||ae(w,1,this.length),this[w]&128?(255-this[w]+1)*-1:this[w]},l.prototype.readInt16LE=function(w,v){w=w>>>0,v||ae(w,2,this.length);const I=this[w]|this[w+1]<<8;return I&32768?I|4294901760:I},l.prototype.readInt16BE=function(w,v){w=w>>>0,v||ae(w,2,this.length);const I=this[w+1]|this[w]<<8;return I&32768?I|4294901760:I},l.prototype.readInt32LE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),this[w]|this[w+1]<<8|this[w+2]<<16|this[w+3]<<24},l.prototype.readInt32BE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),this[w]<<24|this[w+1]<<16|this[w+2]<<8|this[w+3]},l.prototype.readBigInt64LE=ye(function(w){w=w>>>0,Ke(w,"offset");const v=this[w],I=this[w+7];(v===void 0||I===void 0)&&$t(w,this.length-8);const O=this[w+4]+this[w+5]*2**8+this[w+6]*2**16+(I<<24);return(BigInt(O)<<BigInt(32))+BigInt(v+this[++w]*2**8+this[++w]*2**16+this[++w]*2**24)}),l.prototype.readBigInt64BE=ye(function(w){w=w>>>0,Ke(w,"offset");const v=this[w],I=this[w+7];(v===void 0||I===void 0)&&$t(w,this.length-8);const O=(v<<24)+this[++w]*2**16+this[++w]*2**8+this[++w];return(BigInt(O)<<BigInt(32))+BigInt(this[++w]*2**24+this[++w]*2**16+this[++w]*2**8+I)}),l.prototype.readFloatLE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),n.read(this,w,!0,23,4)},l.prototype.readFloatBE=function(w,v){return w=w>>>0,v||ae(w,4,this.length),n.read(this,w,!1,23,4)},l.prototype.readDoubleLE=function(w,v){return w=w>>>0,v||ae(w,8,this.length),n.read(this,w,!0,52,8)},l.prototype.readDoubleBE=function(w,v){return w=w>>>0,v||ae(w,8,this.length),n.read(this,w,!1,52,8)};function Z(x,w,v,I,O,L){if(!l.isBuffer(x))throw new TypeError('"buffer" argument must be a Buffer instance');if(w>O||w<L)throw new RangeError('"value" argument is out of bounds');if(v+I>x.length)throw new RangeError("Index out of range")}l.prototype.writeUintLE=l.prototype.writeUIntLE=function(w,v,I,O){if(w=+w,v=v>>>0,I=I>>>0,!O){const Ue=Math.pow(2,8*I)-1;Z(this,w,v,I,Ue,0)}let L=1,U=0;for(this[v]=w&255;++U<I&&(L*=256);)this[v+U]=w/L&255;return v+I},l.prototype.writeUintBE=l.prototype.writeUIntBE=function(w,v,I,O){if(w=+w,v=v>>>0,I=I>>>0,!O){const Ue=Math.pow(2,8*I)-1;Z(this,w,v,I,Ue,0)}let L=I-1,U=1;for(this[v+L]=w&255;--L>=0&&(U*=256);)this[v+L]=w/U&255;return v+I},l.prototype.writeUint8=l.prototype.writeUInt8=function(w,v,I){return w=+w,v=v>>>0,I||Z(this,w,v,1,255,0),this[v]=w&255,v+1},l.prototype.writeUint16LE=l.prototype.writeUInt16LE=function(w,v,I){return w=+w,v=v>>>0,I||Z(this,w,v,2,65535,0),this[v]=w&255,this[v+1]=w>>>8,v+2},l.prototype.writeUint16BE=l.prototype.writeUInt16BE=function(w,v,I){return w=+w,v=v>>>0,I||Z(this,w,v,2,65535,0),this[v]=w>>>8,this[v+1]=w&255,v+2},l.prototype.writeUint32LE=l.prototype.writeUInt32LE=function(w,v,I){return w=+w,v=v>>>0,I||Z(this,w,v,4,4294967295,0),this[v+3]=w>>>24,this[v+2]=w>>>16,this[v+1]=w>>>8,this[v]=w&255,v+4},l.prototype.writeUint32BE=l.prototype.writeUInt32BE=function(w,v,I){return w=+w,v=v>>>0,I||Z(this,w,v,4,4294967295,0),this[v]=w>>>24,this[v+1]=w>>>16,this[v+2]=w>>>8,this[v+3]=w&255,v+4};function A(x,w,v,I,O){Bt(w,I,O,x,v,7);let L=Number(w&BigInt(4294967295));x[v++]=L,L=L>>8,x[v++]=L,L=L>>8,x[v++]=L,L=L>>8,x[v++]=L;let U=Number(w>>BigInt(32)&BigInt(4294967295));return x[v++]=U,U=U>>8,x[v++]=U,U=U>>8,x[v++]=U,U=U>>8,x[v++]=U,v}function S(x,w,v,I,O){Bt(w,I,O,x,v,7);let L=Number(w&BigInt(4294967295));x[v+7]=L,L=L>>8,x[v+6]=L,L=L>>8,x[v+5]=L,L=L>>8,x[v+4]=L;let U=Number(w>>BigInt(32)&BigInt(4294967295));return x[v+3]=U,U=U>>8,x[v+2]=U,U=U>>8,x[v+1]=U,U=U>>8,x[v]=U,v+8}l.prototype.writeBigUInt64LE=ye(function(w,v=0){return A(this,w,v,BigInt(0),BigInt("0xffffffffffffffff"))}),l.prototype.writeBigUInt64BE=ye(function(w,v=0){return S(this,w,v,BigInt(0),BigInt("0xffffffffffffffff"))}),l.prototype.writeIntLE=function(w,v,I,O){if(w=+w,v=v>>>0,!O){const ct=Math.pow(2,8*I-1);Z(this,w,v,I,ct-1,-ct)}let L=0,U=1,Ue=0;for(this[v]=w&255;++L<I&&(U*=256);)w<0&&Ue===0&&this[v+L-1]!==0&&(Ue=1),this[v+L]=(w/U>>0)-Ue&255;return v+I},l.prototype.writeIntBE=function(w,v,I,O){if(w=+w,v=v>>>0,!O){const ct=Math.pow(2,8*I-1);Z(this,w,v,I,ct-1,-ct)}let L=I-1,U=1,Ue=0;for(this[v+L]=w&255;--L>=0&&(U*=256);)w<0&&Ue===0&&this[v+L+1]!==0&&(Ue=1),this[v+L]=(w/U>>0)-Ue&255;return v+I},l.prototype.writeInt8=function(w,v,I){return w=+w,v=v>>>0,I||Z(this,w,v,1,127,-128),w<0&&(w=255+w+1),this[v]=w&255,v+1},l.prototype.writeInt16LE=function(w,v,I){return w=+w,v=v>>>0,I||Z(this,w,v,2,32767,-32768),this[v]=w&255,this[v+1]=w>>>8,v+2},l.prototype.writeInt16BE=function(w,v,I){return w=+w,v=v>>>0,I||Z(this,w,v,2,32767,-32768),this[v]=w>>>8,this[v+1]=w&255,v+2},l.prototype.writeInt32LE=function(w,v,I){return w=+w,v=v>>>0,I||Z(this,w,v,4,2147483647,-2147483648),this[v]=w&255,this[v+1]=w>>>8,this[v+2]=w>>>16,this[v+3]=w>>>24,v+4},l.prototype.writeInt32BE=function(w,v,I){return w=+w,v=v>>>0,I||Z(this,w,v,4,2147483647,-2147483648),w<0&&(w=4294967295+w+1),this[v]=w>>>24,this[v+1]=w>>>16,this[v+2]=w>>>8,this[v+3]=w&255,v+4},l.prototype.writeBigInt64LE=ye(function(w,v=0){return A(this,w,v,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),l.prototype.writeBigInt64BE=ye(function(w,v=0){return S(this,w,v,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function M(x,w,v,I,O,L){if(v+I>x.length)throw new RangeError("Index out of range");if(v<0)throw new RangeError("Index out of range")}function N(x,w,v,I,O){return w=+w,v=v>>>0,O||M(x,w,v,4),n.write(x,w,v,I,23,4),v+4}l.prototype.writeFloatLE=function(w,v,I){return N(this,w,v,!0,I)},l.prototype.writeFloatBE=function(w,v,I){return N(this,w,v,!1,I)};function ke(x,w,v,I,O){return w=+w,v=v>>>0,O||M(x,w,v,8),n.write(x,w,v,I,52,8),v+8}l.prototype.writeDoubleLE=function(w,v,I){return ke(this,w,v,!0,I)},l.prototype.writeDoubleBE=function(w,v,I){return ke(this,w,v,!1,I)},l.prototype.copy=function(w,v,I,O){if(!l.isBuffer(w))throw new TypeError("argument should be a Buffer");if(I||(I=0),!O&&O!==0&&(O=this.length),v>=w.length&&(v=w.length),v||(v=0),O>0&&O<I&&(O=I),O===I||w.length===0||this.length===0)return 0;if(v<0)throw new RangeError("targetStart out of bounds");if(I<0||I>=this.length)throw new RangeError("Index out of range");if(O<0)throw new RangeError("sourceEnd out of bounds");O>this.length&&(O=this.length),w.length-v<O-I&&(O=w.length-v+I);const L=O-I;return this===w&&typeof i.prototype.copyWithin=="function"?this.copyWithin(v,I,O):i.prototype.set.call(w,this.subarray(I,O),v),L},l.prototype.fill=function(w,v,I,O){if(typeof w=="string"){if(typeof v=="string"?(O=v,v=0,I=this.length):typeof I=="string"&&(O=I,I=this.length),O!==void 0&&typeof O!="string")throw new TypeError("encoding must be a string");if(typeof O=="string"&&!l.isEncoding(O))throw new TypeError("Unknown encoding: "+O);if(w.length===1){const U=w.charCodeAt(0);(O==="utf8"&&U<128||O==="latin1")&&(w=U)}}else typeof w=="number"?w=w&255:typeof w=="boolean"&&(w=Number(w));if(v<0||this.length<v||this.length<I)throw new RangeError("Out of range index");if(I<=v)return this;v=v>>>0,I=I===void 0?this.length:I>>>0,w||(w=0);let L;if(typeof w=="number")for(L=v;L<I;++L)this[L]=w;else{const U=l.isBuffer(w)?w:l.from(w,O),Ue=U.length;if(Ue===0)throw new TypeError('The value "'+w+'" is invalid for argument "value"');for(L=0;L<I-v;++L)this[L+v]=U[L%Ue]}return this};const $e={};function We(x,w,v){$e[x]=class extends v{constructor(){super(),Object.defineProperty(this,"message",{value:w.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${x}]`,this.stack,delete this.name}get code(){return x}set code(O){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:O,writable:!0})}toString(){return`${this.name} [${x}]: ${this.message}`}}}We("ERR_BUFFER_OUT_OF_BOUNDS",function(x){return x?`${x} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),We("ERR_INVALID_ARG_TYPE",function(x,w){return`The "${x}" argument must be of type number. Received type ${typeof w}`},TypeError),We("ERR_OUT_OF_RANGE",function(x,w,v){let I=`The value of "${x}" is out of range.`,O=v;return Number.isInteger(v)&&Math.abs(v)>2**32?O=nt(String(v)):typeof v=="bigint"&&(O=String(v),(v>BigInt(2)**BigInt(32)||v<-(BigInt(2)**BigInt(32)))&&(O=nt(O)),O+="n"),I+=` It must be ${w}. Received ${O}`,I},RangeError);function nt(x){let w="",v=x.length;const I=x[0]==="-"?1:0;for(;v>=I+4;v-=3)w=`_${x.slice(v-3,v)}${w}`;return`${x.slice(0,v)}${w}`}function ot(x,w,v){Ke(w,"offset"),(x[w]===void 0||x[w+v]===void 0)&&$t(w,x.length-(v+1))}function Bt(x,w,v,I,O,L){if(x>v||x<w){const U=typeof w=="bigint"?"n":"";let Ue;throw w===0||w===BigInt(0)?Ue=`>= 0${U} and < 2${U} ** ${(L+1)*8}${U}`:Ue=`>= -(2${U} ** ${(L+1)*8-1}${U}) and < 2 ** ${(L+1)*8-1}${U}`,new $e.ERR_OUT_OF_RANGE("value",Ue,x)}ot(I,O,L)}function Ke(x,w){if(typeof x!="number")throw new $e.ERR_INVALID_ARG_TYPE(w,"number",x)}function $t(x,w,v){throw Math.floor(x)!==x?(Ke(x,v),new $e.ERR_OUT_OF_RANGE("offset","an integer",x)):w<0?new $e.ERR_BUFFER_OUT_OF_BOUNDS:new $e.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${w}`,x)}const bs=/[^+/0-9A-Za-z-_]/g;function Di(x){if(x=x.split("=")[0],x=x.trim().replace(bs,""),x.length<2)return"";for(;x.length%4!==0;)x=x+"=";return x}function X(x,w){w=w||1/0;let v;const I=x.length;let O=null;const L=[];for(let U=0;U<I;++U){if(v=x.charCodeAt(U),v>55295&&v<57344){if(!O){if(v>56319){(w-=3)>-1&&L.push(239,191,189);continue}else if(U+1===I){(w-=3)>-1&&L.push(239,191,189);continue}O=v;continue}if(v<56320){(w-=3)>-1&&L.push(239,191,189),O=v;continue}v=(O-55296<<10|v-56320)+65536}else O&&(w-=3)>-1&&L.push(239,191,189);if(O=null,v<128){if((w-=1)<0)break;L.push(v)}else if(v<2048){if((w-=2)<0)break;L.push(v>>6|192,v&63|128)}else if(v<65536){if((w-=3)<0)break;L.push(v>>12|224,v>>6&63|128,v&63|128)}else if(v<1114112){if((w-=4)<0)break;L.push(v>>18|240,v>>12&63|128,v>>6&63|128,v&63|128)}else throw new Error("Invalid code point")}return L}function Xr(x){const w=[];for(let v=0;v<x.length;++v)w.push(x.charCodeAt(v)&255);return w}function Se(x,w){let v,I,O;const L=[];for(let U=0;U<x.length&&!((w-=2)<0);++U)v=x.charCodeAt(U),I=v>>8,O=v%256,L.push(O),L.push(I);return L}function pe(x){return e.toByteArray(Di(x))}function Ee(x,w,v,I){let O;for(O=0;O<I&&!(O+v>=w.length||O>=x.length);++O)w[O+v]=x[O];return O}function Y(x,w){return x instanceof w||x!=null&&x.constructor!=null&&x.constructor.name!=null&&x.constructor.name===w.name}function K(x){return x!==x}const Te=(function(){const x="0123456789abcdef",w=new Array(256);for(let v=0;v<16;++v){const I=v*16;for(let O=0;O<16;++O)w[I+O]=x[v]+x[O]}return w})();function ye(x){return typeof BigInt>"u"?Qt:x}function Qt(){throw new Error("BigInt not supported")}})(NE);const Kt=NE.Buffer;function Zm(t){switch(t){case"csv":return"text/csv";case"doc":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":return"image/jpeg";case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function A$(t){if(Ie(t.document)&&Ie(t.document.source)){const e=Ie(t.document)&&se(t.document.format)?t.document.format:"",n=Zm(e);if(Ie(t.document.source)){if(Ie(t.document.source.s3Location)&&se(t.document.source.s3Location.uri))return{type:"file",mimeType:n,fileId:t.document.source.s3Location.uri};if(Nm(t.document.source.bytes))return{type:"file",mimeType:n,data:t.document.source.bytes};if(se(t.document.source.text))return{type:"file",mimeType:n,data:Kt.from(t.document.source.text).toString("base64")};if(zr(t.document.source.content)){const r=t.document.source.content.reduce((s,i)=>Ie(i)&&se(i.text)?s+i.text:s,"");return{type:"file",mimeType:n,data:r}}}}return{type:"non_standard",value:t}}function C$(t){if(be(t,"image")&&Ie(t.image)){const e=Ie(t.image)&&se(t.image.format)?t.image.format:"",n=Zm(e);if(Ie(t.image.source)){if(Ie(t.image.source.s3Location)&&se(t.image.source.s3Location.uri))return{type:"image",mimeType:n,fileId:t.image.source.s3Location.uri};if(Nm(t.image.source.bytes))return{type:"image",mimeType:n,data:t.image.source.bytes}}}return{type:"non_standard",value:t}}function k$(t){if(be(t,"video")&&Ie(t.video)){const e=Ie(t.video)&&se(t.video.format)?t.video.format:"",n=Zm(e);if(Ie(t.video.source)){if(Ie(t.video.source.s3Location)&&se(t.video.source.s3Location.uri))return{type:"video",mimeType:n,fileId:t.video.source.s3Location.uri};if(Nm(t.video.source.bytes))return{type:"video",mimeType:n,data:t.video.source.bytes}}}return{type:"non_standard",value:t}}function _w(t){function*e(){const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const r of n){if(be(r,"cache_point")){yield{type:"non_standard",value:r};continue}else if(be(r,"citations_content")&&Ie(r.citationsContent)){const s=zr(r.citationsContent.content)?r.citationsContent.content.reduce((a,o)=>Ie(o)&&se(o.text)?a+o.text:a,""):"",i=zr(r.citationsContent.citations)?r.citationsContent.citations.reduce((a,o)=>{if(Ie(o)){const c=zr(o.sourceContent)?o.sourceContent.reduce((l,d)=>Ie(d)&&se(d.text)?l+d.text:l,""):"",u=To(()=>{if(Ie(o.location)){const l=o.location.documentChar||o.location.documentPage||o.location.documentChunk;if(Ie(l))return{source:pr(l.documentIndex)?l.documentIndex.toString():void 0,startIndex:pr(l.start)?l.start:void 0,endIndex:pr(l.end)?l.end:void 0}}return{}});a.push({type:"citation",citedText:c,...u})}return a},[]):[];yield{type:"text",text:s,annotations:i};continue}else if(be(r,"document")&&Ie(r.document)){yield A$(r);continue}else if(be(r,"guard_content")){yield{type:"non_standard",value:r};continue}else if(be(r,"image")&&Ie(r.image)){yield C$(r);continue}else if(be(r,"reasoning_content")&&se(r.reasoningText)){yield{type:"reasoning",reasoning:r.reasoningText};continue}else if(be(r,"text")&&se(r.text)){yield{type:"text",text:r.text};continue}else if(be(r,"tool_result")){yield{type:"non_standard",value:r};continue}else{if(be(r,"tool_call"))continue;if(be(r,"video")&&Ie(r.video)){yield k$(r);continue}}yield{type:"non_standard",value:r}}}return Array.from(e())}const I$={translateContent:_w,translateContentChunk:_w};function ww(t){function*e(){const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const r of n){if(be(r,"text")&&se(r.text)){yield{type:"text",text:r.text};continue}else if(be(r,"inlineData")&&Ie(r.inlineData)&&se(r.inlineData.mimeType)&&se(r.inlineData.data)){yield{type:"file",mimeType:r.inlineData.mimeType,data:r.inlineData.data};continue}else if(be(r,"functionCall")&&Ie(r.functionCall)&&se(r.functionCall.name)&&Ie(r.functionCall.args)){yield{type:"tool_call",id:t.id,name:r.functionCall.name,args:r.functionCall.args};continue}else if(be(r,"functionResponse")){yield{type:"non_standard",value:r};continue}else if(be(r,"fileData")&&Ie(r.fileData)&&se(r.fileData.mimeType)&&se(r.fileData.fileUri)){yield{type:"file",mimeType:r.fileData.mimeType,fileId:r.fileData.fileUri};continue}else if(be(r,"executableCode")){yield{type:"non_standard",value:r};continue}else if(be(r,"codeExecutionResult")){yield{type:"non_standard",value:r};continue}yield{type:"non_standard",value:r}}}return Array.from(e())}const R$={translateContent:ww,translateContentChunk:ww};function bw(t){function*e(){const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const r of n){if(be(r,"reasoning")&&se(r.reasoning)){const s=To(()=>{var a;const i=n.indexOf(r);if(zr((a=t.additional_kwargs)==null?void 0:a.signatures)&&i>=0)return t.additional_kwargs.signatures.at(i)});se(s)?yield{type:"reasoning",reasoning:r.reasoning,signature:s}:yield{type:"reasoning",reasoning:r.reasoning};continue}else if(be(r,"text")&&se(r.text)){yield{type:"text",text:r.text};continue}else if(be(r,"image_url")){if(se(r.image_url))if(r.image_url.startsWith("data:")){const s=/^data:([^;]+);base64,(.+)$/,i=r.image_url.match(s);i?yield{type:"image",data:i[2],mimeType:i[1]}:yield{type:"image",url:r.image_url}}else yield{type:"image",url:r.image_url};continue}else if(be(r,"media")&&se(r.mimeType)&&se(r.data)){yield{type:"file",mimeType:r.mimeType,data:r.data};continue}yield{type:"non_standard",value:r}}}return Array.from(e())}const O$={translateContent:bw,translateContentChunk:bw};globalThis.lc_block_translators_registry??(globalThis.lc_block_translators_registry=new Map([["anthropic",w1],["bedrock-converse",I$],["google-genai",R$],["google-vertexai",O$],["openai",I1]]));function LE(t){return globalThis.lc_block_translators_registry.get(t)}function ME(t,e){return rn(t??{},e??{})}function DE(t,e){const n={};return((t==null?void 0:t.audio)!==void 0||(e==null?void 0:e.audio)!==void 0)&&(n.audio=((t==null?void 0:t.audio)??0)+((e==null?void 0:e.audio)??0)),((t==null?void 0:t.image)!==void 0||(e==null?void 0:e.image)!==void 0)&&(n.image=((t==null?void 0:t.image)??0)+((e==null?void 0:e.image)??0)),((t==null?void 0:t.video)!==void 0||(e==null?void 0:e.video)!==void 0)&&(n.video=((t==null?void 0:t.video)??0)+((e==null?void 0:e.video)??0)),((t==null?void 0:t.document)!==void 0||(e==null?void 0:e.document)!==void 0)&&(n.document=((t==null?void 0:t.document)??0)+((e==null?void 0:e.document)??0)),((t==null?void 0:t.text)!==void 0||(e==null?void 0:e.text)!==void 0)&&(n.text=((t==null?void 0:t.text)??0)+((e==null?void 0:e.text)??0)),n}function $$(t,e){const n={...DE(t,e)};return((t==null?void 0:t.cache_read)!==void 0||(e==null?void 0:e.cache_read)!==void 0)&&(n.cache_read=((t==null?void 0:t.cache_read)??0)+((e==null?void 0:e.cache_read)??0)),((t==null?void 0:t.cache_creation)!==void 0||(e==null?void 0:e.cache_creation)!==void 0)&&(n.cache_creation=((t==null?void 0:t.cache_creation)??0)+((e==null?void 0:e.cache_creation)??0)),n}function N$(t,e){const n={...DE(t,e)};return((t==null?void 0:t.reasoning)!==void 0||(e==null?void 0:e.reasoning)!==void 0)&&(n.reasoning=((t==null?void 0:t.reasoning)??0)+((e==null?void 0:e.reasoning)??0)),n}function UE(t,e){return{input_tokens:((t==null?void 0:t.input_tokens)??0)+((e==null?void 0:e.input_tokens)??0),output_tokens:((t==null?void 0:t.output_tokens)??0)+((e==null?void 0:e.output_tokens)??0),total_tokens:((t==null?void 0:t.total_tokens)??0)+((e==null?void 0:e.total_tokens)??0),input_token_details:$$(t==null?void 0:t.input_token_details,e==null?void 0:e.input_token_details),output_token_details:N$(t==null?void 0:t.output_token_details,e==null?void 0:e.output_token_details)}}var ht=class extends rr{constructor(e){var r;let n;if(typeof e=="string"||Array.isArray(e))n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:{}};else{n=e;const s=(r=n.additional_kwargs)==null?void 0:r.tool_calls,i=n.tool_calls;s!=null&&s.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `pnpm install @langchain/anthropic`,","pnpm install @langchain/openai`, etc."].join(" "));try{if(s!=null&&i===void 0){const[a,o]=Mm(s);n.tool_calls=a??[],n.invalid_tool_calls=o??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch{n.tool_calls=[],n.invalid_tool_calls=[]}if(n.response_metadata!==void 0&&"output_version"in n.response_metadata&&n.response_metadata.output_version==="v1"&&(n.contentBlocks=n.content,n.content=void 0),n.contentBlocks!==void 0){n.contentBlocks.push(...n.tool_calls.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})));const a=n.contentBlocks.filter(o=>o.type==="tool_call").filter(o=>{var c;return!((c=n.tool_calls)!=null&&c.some(u=>u.id===o.id&&u.name===o.name))});a.length>0&&(n.tool_calls=a.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})))}}super(n);p(this,"type","ai");p(this,"tool_calls",[]);p(this,"invalid_tool_calls",[]);p(this,"usage_metadata");typeof n!="string"&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}static lc_name(){return"AIMessage"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const n=LE(this.response_metadata.model_provider);if(n)return n.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls){const n=this.tool_calls.filter(r=>!e.some(s=>s.id===r.id&&s.name===r.name));e.push(...n.map(r=>({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})))}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}};function $i(t){return t._getType()==="ai"}function rp(t){return t._getType()==="ai"}var Et=class extends Oi{constructor(e){var r,s;let n;if(typeof e=="string"||Array.isArray(e))n={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)n={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const i=e.tool_call_chunks.reduce((c,u)=>{const l=c.findIndex(([d])=>"id"in u&&u.id&&"index"in u&&u.index!==void 0?u.id===d.id&&u.index===d.index:"id"in u&&u.id?u.id===d.id:"index"in u&&u.index!==void 0?u.index===d.index:!1);return l!==-1?c[l].push(u):c.push([u]),c},[]),a=[],o=[];for(const c of i){let u=null;const l=((r=c[0])==null?void 0:r.name)??"",d=c.map(m=>m.args||"").join(""),h=d.length?d:"{}",f=(s=c[0])==null?void 0:s.id;try{if(u=ma(h),!f||u===null||typeof u!="object"||Array.isArray(u))throw new Error("Malformed tool call chunk args.");a.push({name:l,args:u,id:f,type:"tool_call"})}catch{o.push({name:l,args:h,id:f,error:"Malformed args.",type:"invalid_tool_call"})}}n={...e,tool_calls:a,invalid_tool_calls:o,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(n);p(this,"type","ai");p(this,"tool_calls",[]);p(this,"invalid_tool_calls",[]);p(this,"tool_call_chunks",[]);p(this,"usage_metadata");this.tool_call_chunks=n.tool_call_chunks??this.tool_call_chunks,this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=n.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const n=LE(this.response_metadata.model_provider);if(n)return n.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls&&typeof this.content!="string"){const n=this.content.filter(r=>r.type==="tool_call").map(r=>r.id);for(const r of this.tool_calls)r.id&&!n.includes(r.id)&&e.push({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const n={content:Ri(this.content,e.content),additional_kwargs:rn(this.additional_kwargs,e.additional_kwargs),response_metadata:ME(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const s=nc(this.tool_call_chunks,e.tool_call_chunks);s!==void 0&&s.length>0&&(n.tool_call_chunks=s)}(this.usage_metadata!==void 0||e.usage_metadata!==void 0)&&(n.usage_metadata=UE(this.usage_metadata,e.usage_metadata));const r=this.constructor;return new r(n)}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}},Zr=class BE extends rr{constructor(n,r){(typeof n=="string"||Array.isArray(n))&&(n={content:n,role:r});super(n);p(this,"type","generic");p(this,"role");this.role=n.role}static lc_name(){return"ChatMessage"}static _chatMessageClass(){return BE}static isInstance(n){return super.isInstance(n)&&n.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},ic=class extends Oi{constructor(e,n){(typeof e=="string"||Array.isArray(e))&&(e={content:e,role:n});super(e);p(this,"type","generic");p(this,"role");this.role=e.role}static lc_name(){return"ChatMessageChunk"}concat(e){const n=this.constructor;return new n({content:Ri(this.content,e.content),additional_kwargs:rn(this.additional_kwargs,e.additional_kwargs),response_metadata:rn(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}};function P$(t){return t._getType()==="generic"}function L$(t){return t._getType()==="generic"}var Yl=class extends rr{constructor(e){super(e);p(this,"type","function");p(this,"name");this.name=e.name}static lc_name(){return"FunctionMessage"}},ac=class extends Oi{constructor(){super(...arguments);p(this,"type","function")}static lc_name(){return"FunctionMessageChunk"}concat(e){const n=this.constructor;return new n({content:Ri(this.content,e.content),additional_kwargs:rn(this.additional_kwargs,e.additional_kwargs),response_metadata:rn(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}};function M$(t){return t._getType()==="function"}function D$(t){return t._getType()==="function"}var It=class extends rr{constructor(e){super(e);p(this,"type","human")}static lc_name(){return"HumanMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="human"}},oc=class extends Oi{constructor(e){super(e);p(this,"type","human")}static lc_name(){return"HumanMessageChunk"}concat(e){const n=this.constructor;return new n({content:Ri(this.content,e.content),additional_kwargs:rn(this.additional_kwargs,e.additional_kwargs),response_metadata:rn(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="human"}};function U$(t){return t.getType()==="human"}function B$(t){return t.getType()==="human"}var vt=class extends rr{constructor(e){super(e);p(this,"type","system")}static lc_name(){return"SystemMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="system"}},js=class extends Oi{constructor(e){super(e);p(this,"type","system")}static lc_name(){return"SystemMessageChunk"}concat(e){const n=this.constructor;return new n({content:Ri(this.content,e.content),additional_kwargs:rn(this.additional_kwargs,e.additional_kwargs),response_metadata:rn(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="system"}};function j$(t){return t._getType()==="system"}function F$(t){return t._getType()==="system"}function Ql(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function po(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="tool_call")}function z$(t){return!!(t&&typeof t=="object"&&"toolCall"in t&&t.toolCall!=null&&typeof t.toolCall=="object"&&"id"in t.toolCall&&typeof t.toolCall.id=="string")}var Gu=class extends Error{constructor(e,n){super(e);p(this,"output");this.output=n}},Wu=class extends rr{constructor(e){super({...e,content:[]});p(this,"type","remove");p(this,"id");this.id=e.id}get _printableFields(){return{...super._printableFields,id:this.id}}static isInstance(e){return super.isInstance(e)&&e.type==="remove"}};const V$=t=>t();function q$(t){return po(t)?t:typeof t.id=="string"&&t.type==="function"&&typeof t.function=="object"&&t.function!==null&&"arguments"in t.function&&typeof t.function.arguments=="string"&&"name"in t.function&&typeof t.function.name=="string"?{id:t.id,args:JSON.parse(t.function.arguments),name:t.function.name,type:"tool_call"}:t}function H$(t){return typeof t=="object"&&t!=null&&t.lc===1&&Array.isArray(t.id)&&t.kwargs!=null&&typeof t.kwargs=="object"}function Qh(t){let e,n;if(H$(t)){const r=t.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":r==="FunctionMessage"||r==="FunctionMessageChunk"?e="function":r==="ToolMessage"||r==="ToolMessageChunk"?e="tool":e="unknown",n=t.kwargs}else{const{type:r,...s}=t;e=r,n=s}if(e==="human"||e==="user")return new It(n);if(e==="ai"||e==="assistant"){const{tool_calls:r,...s}=n;if(!Array.isArray(r))return new ht(n);const i=r.map(q$);return new ht({...s,tool_calls:i})}else{if(e==="system")return new vt(n);if(e==="developer")return new vt({...n,additional_kwargs:{...n.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in n)return new Hr({...n,content:n.content,tool_call_id:n.tool_call_id,name:n.name});if(e==="remove"&&"id"in n&&typeof n.id=="string")return new Wu({...n,id:n.id});throw Ql(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(t,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Vr(t){if(typeof t=="string")return new It(t);if(Lt(t))return t;if(Array.isArray(t)){const[e,n]=t;return Qh({type:e,content:n})}else if(tE(t)){const{role:e,...n}=t;return Qh({...n,type:e})}else return Qh(t)}function Km(t,e="Human",n="AI"){const r=[];for(const s of t){let i;if(s._getType()==="human")i=e;else if(s._getType()==="ai")i=n;else if(s._getType()==="system")i="System";else if(s._getType()==="tool")i="Tool";else if(s._getType()==="generic")i=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const a=s.name?`${s.name}, `:"",o=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);r.push(`${i}: ${a}${o}`)}return r.join(`
`)}function G$(t){if(t.data!==void 0)return t;{const e=t;return{type:e.type,data:{content:e.text,role:e.role,name:void 0,tool_call_id:void 0}}}}function Xm(t){const e=G$(t);switch(e.type){case"human":return new It(e.data);case"ai":return new ht(e.data);case"system":return new vt(e.data);case"function":if(e.data.name===void 0)throw new Error("Name must be defined for function messages");return new Yl(e.data);case"tool":if(e.data.tool_call_id===void 0)throw new Error("Tool call ID must be defined for tool messages");return new Hr(e.data);case"generic":if(e.data.role===void 0)throw new Error("Role must be defined for chat messages");return new Zr(e.data);default:throw new Error(`Got unexpected type: ${e.type}`)}}function W$(t){return t.map(Xm)}function J$(t){return t.map(e=>e.toDict())}function Ju(t){var n;const e=t._getType();if(e==="human")return new oc({...t});if(e==="ai"){let r={...t};return"tool_calls"in r&&(r={...r,tool_call_chunks:(n=r.tool_calls)==null?void 0:n.map(s=>({...s,type:"tool_call_chunk",index:void 0,args:JSON.stringify(s.args)}))}),new Et({...r})}else{if(e==="system")return new js({...t});if(e==="function")return new ac({...t});if(Zr.isInstance(t))return new ic({...t});throw new Error("Unknown message type.")}}const Z$=t=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(n=>nr(n)==="true");function jE(t){var r;const e=Co();if(e===void 0)return;const n=e.getStore();return(r=n==null?void 0:n[fo])==null?void 0:r[t]}const K$=Symbol("lc:configure_hooks"),X$=()=>jE(K$)||[];var FE={};ve(FE,{BaseCallbackManager:()=>zE,BaseRunManager:()=>uc,CallbackManager:()=>hn,CallbackManagerForChainRun:()=>qE,CallbackManagerForLLMRun:()=>sp,CallbackManagerForRetrieverRun:()=>VE,CallbackManagerForToolRun:()=>HE,ensureHandler:()=>ko,parseCallbackConfigArg:()=>cc});function cc(t){return t?Array.isArray(t)||"name"in t?{callbacks:t}:t:{}}var zE=class{setHandler(t){return this.setHandlers([t])}},uc=class{constructor(t,e,n,r,s,i,a,o){this.runId=t,this.handlers=e,this.inheritableHandlers=n,this.tags=r,this.inheritableTags=s,this.metadata=i,this.inheritableMetadata=a,this._parentRunId=o}get parentRunId(){return this._parentRunId}async handleText(t){await Promise.all(this.handlers.map(e=>wt(async()=>{var n;try{await((n=e.handleText)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleText: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleCustomEvent(t,e,n,r,s){await Promise.all(this.handlers.map(i=>wt(async()=>{var a;try{await((a=i.handleCustomEvent)==null?void 0:a.call(i,t,e,this.runId,this.tags,this.metadata))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}},VE=class extends uc{getChild(t){const e=new hn(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleRetrieverEnd(t){await Promise.all(this.handlers.map(e=>wt(async()=>{var n;if(!e.ignoreRetriever)try{await((n=e.handleRetrieverEnd)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetriever`),e.raiseError)throw r}},e.awaitHandlers)))}async handleRetrieverError(t){await Promise.all(this.handlers.map(e=>wt(async()=>{var n;if(!e.ignoreRetriever)try{await((n=e.handleRetrieverError)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetrieverError: ${r}`),e.raiseError)throw t}},e.awaitHandlers)))}},sp=class extends uc{async handleLLMNewToken(t,e,n,r,s,i){await Promise.all(this.handlers.map(a=>wt(async()=>{var o;if(!a.ignoreLLM)try{await((o=a.handleLLMNewToken)==null?void 0:o.call(a,t,e??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMNewToken: ${c}`),a.raiseError)throw c}},a.awaitHandlers)))}async handleLLMError(t,e,n,r,s){await Promise.all(this.handlers.map(i=>wt(async()=>{var a;if(!i.ignoreLLM)try{await((a=i.handleLLMError)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleLLMEnd(t,e,n,r,s){await Promise.all(this.handlers.map(i=>wt(async()=>{var a;if(!i.ignoreLLM)try{await((a=i.handleLLMEnd)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}},qE=class extends uc{getChild(t){const e=new hn(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleChainError(t,e,n,r,s){await Promise.all(this.handlers.map(i=>wt(async()=>{var a;if(!i.ignoreChain)try{await((a=i.handleChainError)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleChainEnd(t,e,n,r,s){await Promise.all(this.handlers.map(i=>wt(async()=>{var a;if(!i.ignoreChain)try{await((a=i.handleChainEnd)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleAgentAction(t){await Promise.all(this.handlers.map(e=>wt(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleAgentAction)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentAction: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleAgentEnd(t){await Promise.all(this.handlers.map(e=>wt(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleAgentEnd)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentEnd: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}},HE=class extends uc{getChild(t){const e=new hn(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleToolError(t){await Promise.all(this.handlers.map(e=>wt(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleToolError)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolError: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleToolEnd(t){await Promise.all(this.handlers.map(e=>wt(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleToolEnd)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolEnd: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}},hn=class Ja extends zE{constructor(n,r){super();p(this,"handlers",[]);p(this,"inheritableHandlers",[]);p(this,"tags",[]);p(this,"inheritableTags",[]);p(this,"metadata",{});p(this,"inheritableMetadata",{});p(this,"name","callback_manager");p(this,"_parentRunId");this.handlers=(r==null?void 0:r.handlers)??this.handlers,this.inheritableHandlers=(r==null?void 0:r.inheritableHandlers)??this.inheritableHandlers,this.tags=(r==null?void 0:r.tags)??this.tags,this.inheritableTags=(r==null?void 0:r.inheritableTags)??this.inheritableTags,this.metadata=(r==null?void 0:r.metadata)??this.metadata,this.inheritableMetadata=(r==null?void 0:r.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=n}getParentRunId(){return this._parentRunId}async handleLLMStart(n,r,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0,u=void 0){return Promise.all(r.map(async(l,d)=>{const h=d===0&&s?s:ns();return await Promise.all(this.handlers.map(f=>{if(!f.ignoreLLM)return Zi(f)&&f._createRunForLLMStart(n,[l],h,this._parentRunId,a,this.tags,this.metadata,u),wt(async()=>{var m;try{await((m=f.handleLLMStart)==null?void 0:m.call(f,n,[l],h,this._parentRunId,a,this.tags,this.metadata,u))}catch(g){if((f.raiseError?console.error:console.warn)(`Error in handler ${f.constructor.name}, handleLLMStart: ${g}`),f.raiseError)throw g}},f.awaitHandlers)})),new sp(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(n,r,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0,u=void 0){return Promise.all(r.map(async(l,d)=>{const h=d===0&&s?s:ns();return await Promise.all(this.handlers.map(f=>{if(!f.ignoreLLM)return Zi(f)&&f._createRunForChatModelStart(n,[l],h,this._parentRunId,a,this.tags,this.metadata,u),wt(async()=>{var m,g;try{if(f.handleChatModelStart)await((m=f.handleChatModelStart)==null?void 0:m.call(f,n,[l],h,this._parentRunId,a,this.tags,this.metadata,u));else if(f.handleLLMStart){const _=Km(l);await((g=f.handleLLMStart)==null?void 0:g.call(f,n,[_],h,this._parentRunId,a,this.tags,this.metadata,u))}}catch(_){if((f.raiseError?console.error:console.warn)(`Error in handler ${f.constructor.name}, handleLLMStart: ${_}`),f.raiseError)throw _}},f.awaitHandlers)})),new sp(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(n,r,s=ns(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return Zi(u)&&u._createRunForChainStart(n,r,s,this._parentRunId,this.tags,this.metadata,i,c),wt(async()=>{var l;try{await((l=u.handleChainStart)==null?void 0:l.call(u,n,r,s,this._parentRunId,this.tags,this.metadata,i,c))}catch(d){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${d}`),u.raiseError)throw d}},u.awaitHandlers)})),new qE(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(n,r,s=ns(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return Zi(u)&&u._createRunForToolStart(n,r,s,this._parentRunId,this.tags,this.metadata,c),wt(async()=>{var l;try{await((l=u.handleToolStart)==null?void 0:l.call(u,n,r,s,this._parentRunId,this.tags,this.metadata,c))}catch(d){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${d}`),u.raiseError)throw d}},u.awaitHandlers)})),new HE(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(n,r,s=ns(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return Zi(u)&&u._createRunForRetrieverStart(n,r,s,this._parentRunId,this.tags,this.metadata,c),wt(async()=>{var l;try{await((l=u.handleRetrieverStart)==null?void 0:l.call(u,n,r,s,this._parentRunId,this.tags,this.metadata,c))}catch(d){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${d}`),u.raiseError)throw d}},u.awaitHandlers)})),new VE(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(n,r,s,i,a){await Promise.all(this.handlers.map(o=>wt(async()=>{var c;if(!o.ignoreCustomEvent)try{await((c=o.handleCustomEvent)==null?void 0:c.call(o,n,r,s,this.tags,this.metadata))}catch(u){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleCustomEvent: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}addHandler(n,r=!0){this.handlers.push(n),r&&this.inheritableHandlers.push(n)}removeHandler(n){this.handlers=this.handlers.filter(r=>r!==n),this.inheritableHandlers=this.inheritableHandlers.filter(r=>r!==n)}setHandlers(n,r=!0){this.handlers=[],this.inheritableHandlers=[];for(const s of n)this.addHandler(s,r)}addTags(n,r=!0){this.removeTags(n),this.tags.push(...n),r&&this.inheritableTags.push(...n)}removeTags(n){this.tags=this.tags.filter(r=>!n.includes(r)),this.inheritableTags=this.inheritableTags.filter(r=>!n.includes(r))}addMetadata(n,r=!0){this.metadata={...this.metadata,...n},r&&(this.inheritableMetadata={...this.inheritableMetadata,...n})}removeMetadata(n){for(const r of Object.keys(n))delete this.metadata[r],delete this.inheritableMetadata[r]}copy(n=[],r=!0){const s=new Ja(this._parentRunId);for(const i of this.handlers){const a=this.inheritableHandlers.includes(i);s.addHandler(i,a)}for(const i of this.tags){const a=this.inheritableTags.includes(i);s.addTags([i],a)}for(const i of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(i);s.addMetadata({[i]:this.metadata[i]},a)}for(const i of n)s.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===i.name)||s.addHandler(i,r);return s}static fromHandlers(n){class r extends Oa{constructor(){super();p(this,"name",ns());Object.assign(this,n)}}const s=new this;return s.addHandler(new r),s}static configure(n,r,s,i,a,o,c){return this._configureSync(n,r,s,i,a,o,c)}static _configureSync(n,r,s,i,a,o,c){var f;let u;(n||r)&&(Array.isArray(n)||!n?(u=new Ja,u.setHandlers((n==null?void 0:n.map(ko))??[],!0)):u=n,u=u.copy(Array.isArray(r)?r.map(ko):r==null?void 0:r.handlers,!1));const l=nr("LANGCHAIN_VERBOSE")==="true"||(c==null?void 0:c.verbose),d=((f=pu.getTraceableRunTree())==null?void 0:f.tracingEnabled)||Z$(),h=d||(nr("LANGCHAIN_TRACING")??!1);if(l||h){if(u||(u=new Ja),l&&!u.handlers.some(m=>m.name===tp.prototype.name)){const m=new tp;u.addHandler(m,!0)}if(h&&!u.handlers.some(m=>m.name==="langchain_tracer")&&d){const m=new pu;u.addHandler(m,!0)}if(d){const m=pu.getTraceableRunTree();if(m&&u._parentRunId===void 0){u._parentRunId=m.id;const g=u.handlers.find(_=>_.name==="langchain_tracer");g==null||g.updateFromRunTree(m)}}}for(const{contextVar:m,inheritable:g=!0,handlerClass:_,envVar:b}of X$()){const y=b&&nr(b)==="true"&&_;let E;const C=m!==void 0?jE(m):void 0;C&&aE(C)?E=C:y&&(E=new _({})),E!==void 0&&(u||(u=new Ja),u.handlers.some(k=>k.name===E.name)||u.addHandler(E,g))}return(s||i)&&u&&(u.addTags(s??[]),u.addTags(i??[],!1)),(a||o)&&u&&(u.addMetadata(a??{}),u.addMetadata(o??{},!1)),u}};function ko(t){return"name"in t?t:Oa.fromMethods(t)}var GE=class{getStore(){}run(t,e){return e()}enterWith(t){}};const Y$=new GE,vw=Symbol.for("lc:child_config");var Q$=class{getInstance(){return Co()??Y$}getRunnableConfig(){var e,n;return(n=(e=this.getInstance().getStore())==null?void 0:e.extra)==null?void 0:n[vw]}runWithConfig(t,e,n){var u;const r=hn._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),s=this.getInstance(),i=s.getStore(),a=r==null?void 0:r.getParentRunId(),o=(u=r==null?void 0:r.handlers)==null?void 0:u.find(l=>(l==null?void 0:l.name)==="langchain_tracer");let c;return o&&a?c=o.getRunTreeWithTracingConfig(a):n||(c=new wn({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[vw]:t}),i!==void 0&&i[fo]!==void 0&&(c===void 0&&(c={}),c[fo]=i[fo]),s.run(c,e)}initializeGlobalInstance(t){Co()===void 0&&p$(t)}};const Dt=new Q$;var WE={};ve(WE,{AsyncLocalStorageProviderSingleton:()=>Dt,MockAsyncLocalStorage:()=>GE,_CONTEXT_VARIABLES_KEY:()=>fo});const ef=25;async function An(t){return hn._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata)}function er(...t){const e={};for(const n of t.filter(r=>!!r))for(const r of Object.keys(n))if(r==="metadata")e[r]={...e[r],...n[r]};else if(r==="tags"){const s=e[r]??[];e[r]=[...new Set(s.concat(n[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...n[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=n.timeout:n.timeout!==void 0&&(e.timeout=Math.min(e.timeout,n.timeout));else if(r==="signal")e.signal===void 0?e.signal=n.signal:n.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,n.signal]):e.signal=n.signal);else if(r==="callbacks"){const s=e.callbacks,i=n.callbacks;if(Array.isArray(i))if(!s)e.callbacks=i;else if(Array.isArray(s))e.callbacks=s.concat(i);else{const a=s.copy();for(const o of i)a.addHandler(ko(o),!0);e.callbacks=a}else if(i)if(!s)e.callbacks=i;else if(Array.isArray(s)){const a=i.copy();for(const o of s)a.addHandler(ko(o),!0);e.callbacks=a}else e.callbacks=new hn(i._parentRunId,{handlers:s.handlers.concat(i.handlers),inheritableHandlers:s.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(i.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(i.inheritableTags))),metadata:{...s.metadata,...i.metadata}})}else{const s=r;e[s]=n[s]??e[s]}return e}const eN=new Set(["string","number","boolean"]);function ze(t){var r;const e=Dt.getRunnableConfig();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:s,runName:i,...a}=e;n=Object.entries(a).reduce((o,[c,u])=>(u!==void 0&&(o[c]=u),o),n)}if(t&&(n=Object.entries(t).reduce((s,[i,a])=>(a!==void 0&&(s[i]=a),s),n)),n!=null&&n.configurable)for(const s of Object.keys(n.configurable))eN.has(typeof n.configurable[s])&&!((r=n.metadata)!=null&&r[s])&&(n.metadata||(n.metadata={}),n.metadata[s]=n.configurable[s]);if(n.timeout!==void 0){if(n.timeout<=0)throw new Error("Timeout must be a positive number");const s=AbortSignal.timeout(n.timeout);n.signal!==void 0?"any"in AbortSignal&&(n.signal=AbortSignal.any([n.signal,s])):n.signal=s,delete n.timeout}return n}function Je(t={},{callbacks:e,maxConcurrency:n,recursionLimit:r,runName:s,configurable:i,runId:a}={}){const o=ze(t);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),n!==void 0&&(o.maxConcurrency=n),s!==void 0&&(o.runName=s),i!==void 0&&(o.configurable={...o.configurable,...i}),a!==void 0&&delete o.runId,o}function fs(t){return t?{configurable:t.configurable,recursionLimit:t.recursionLimit,callbacks:t.callbacks,tags:t.tags,metadata:t.metadata,maxConcurrency:t.maxConcurrency,timeout:t.timeout,signal:t.signal}:void 0}async function Fs(t,e){if(e===void 0)return t;let n;return Promise.race([t.catch(r=>{if(!(e!=null&&e.aborted))throw r}),new Promise((r,s)=>{n=()=>{s(Io(e))},e.addEventListener("abort",n),e.aborted&&s(Io(e))})]).finally(()=>e.removeEventListener("abort",n))}function Io(t){return(t==null?void 0:t.reason)instanceof Error?t.reason:typeof(t==null?void 0:t.reason)=="string"?new Error(t.reason):new Error("Aborted")}var JE={};ve(JE,{AsyncGeneratorWithSetup:()=>Ni,IterableReadableStream:()=>kn,atee:()=>Ym,concat:()=>zs,pipeGeneratorWithSetup:()=>ZE});var kn=class ip extends ReadableStream{constructor(){super(...arguments);p(this,"reader")}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const n=await this.reader.read();return n.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:n.value}}catch(n){throw this.reader.releaseLock(),n}}async return(){if(this.ensureReader(),this.locked){const n=this.reader.cancel();this.reader.releaseLock(),await n}return{done:!0,value:void 0}}async throw(n){if(this.ensureReader(),this.locked){const r=this.reader.cancel();this.reader.releaseLock(),await r}throw n}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(n){const r=n.getReader();return new ip({start(s){return i();function i(){return r.read().then(({done:a,value:o})=>{if(a){s.close();return}return s.enqueue(o),i()})}},cancel(){r.releaseLock()}})}static fromAsyncGenerator(n){return new ip({async pull(r){const{value:s,done:i}=await n.next();i&&r.close(),r.enqueue(s)},async cancel(r){await n.return(r)}})}};function Ym(t,e=2){const n=Array.from({length:e},()=>[]);return n.map(async function*(s){for(;;)if(s.length===0){const i=await t.next();for(const a of n)a.push(i)}else{if(s[0].done)return;yield s.shift().value}})}function zs(t,e){if(Array.isArray(t)&&Array.isArray(e))return t.concat(e);if(typeof t=="string"&&typeof e=="string")return t+e;if(typeof t=="number"&&typeof e=="number")return t+e;if("concat"in t&&typeof t.concat=="function")return t.concat(e);if(typeof t=="object"&&typeof e=="object"){const n={...t};for(const[r,s]of Object.entries(e))r in n&&!Array.isArray(n[r])?n[r]=zs(n[r],s):n[r]=s;return n}else throw new Error(`Cannot concat ${typeof t} and ${typeof e}`)}var Ni=class{constructor(t){p(this,"generator");p(this,"setup");p(this,"config");p(this,"signal");p(this,"firstResult");p(this,"firstResultUsed",!1);var e;this.generator=t.generator,this.config=t.config,this.signal=t.signal??((e=this.config)==null?void 0:e.signal),this.setup=new Promise((n,r)=>{Dt.runWithConfig(fs(t.config),async()=>{this.firstResult=t.generator.next(),t.startSetup?this.firstResult.then(t.startSetup).then(n,r):this.firstResult.then(s=>n(void 0),r)},!0)})}async next(...t){var e;return(e=this.signal)==null||e.throwIfAborted(),this.firstResultUsed?Dt.runWithConfig(fs(this.config),this.signal?async()=>Fs(this.generator.next(...t),this.signal):async()=>this.generator.next(...t),!0):(this.firstResultUsed=!0,this.firstResult)}async return(t){return this.generator.return(t)}async throw(t){return this.generator.throw(t)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function ZE(t,e,n,r,...s){const i=new Ni({generator:e,startSetup:n,signal:r}),a=await i.setup;return{output:t(i,a,...s),setup:a}}/*!
* https://github.com/Starcounter-Jack/JSON-Patch
* (c) 2017-2022 Joachim Wester
* MIT licensed
*/const tN=Object.prototype.hasOwnProperty;function ap(t,e){return tN.call(t,e)}function op(t){if(Array.isArray(t)){const n=new Array(t.length);for(let r=0;r<n.length;r++)n[r]=""+r;return n}if(Object.keys)return Object.keys(t);let e=[];for(let n in t)ap(t,n)&&e.push(n);return e}function wr(t){switch(typeof t){case"object":return JSON.parse(JSON.stringify(t));case"undefined":return null;default:return t}}function cp(t){let e=0;const n=t.length;let r;for(;e<n;){if(r=t.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Bi(t){return t.indexOf("/")===-1&&t.indexOf("~")===-1?t:t.replace(/~/g,"~0").replace(/\//g,"~1")}function nN(t){return t.replace(/~1/g,"/").replace(/~0/g,"~")}function up(t){if(t===void 0)return!0;if(t){if(Array.isArray(t)){for(let n=0,r=t.length;n<r;n++)if(up(t[n]))return!0}else if(typeof t=="object"){const n=op(t),r=n.length;for(var e=0;e<r;e++)if(up(t[n[e]]))return!0}}return!1}function Ew(t,e){const n=[t];for(const r in e){const s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s<"u"&&n.push(`${r}: ${s}`)}return n.join(`
`)}var rN=class extends Error{constructor(t,e,n,r,s){super(Ew(t,{name:e,index:n,operation:r,tree:s})),this.name=e,this.index=n,this.operation=r,this.tree=s,Object.setPrototypeOf(this,new.target.prototype),this.message=Ew(t,{name:e,index:n,operation:r,tree:s})}},KE={};ve(KE,{JsonPatchError:()=>lt,_areEquals:()=>Ro,applyOperation:()=>fi,applyPatch:()=>ga,applyReducer:()=>aN,deepClone:()=>sN,getValueByPointer:()=>Zu,validate:()=>XE,validator:()=>Ku});const lt=rN,sN=wr,sa={add:function(t,e,n){return t[e]=this.value,{newDocument:n}},remove:function(t,e,n){var r=t[e];return delete t[e],{newDocument:n,removed:r}},replace:function(t,e,n){var r=t[e];return t[e]=this.value,{newDocument:n,removed:r}},move:function(t,e,n){let r=Zu(n,this.path);r&&(r=wr(r));const s=fi(n,{op:"remove",path:this.from}).removed;return fi(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(t,e,n){const r=Zu(n,this.from);return fi(n,{op:"add",path:this.path,value:wr(r)}),{newDocument:n}},test:function(t,e,n){return{newDocument:n,test:Ro(t[e],this.value)}},_get:function(t,e,n){return this.value=t[e],{newDocument:n}}};var iN={add:function(t,e,n){return cp(e)?t.splice(e,0,this.value):t[e]=this.value,{newDocument:n,index:e}},remove:function(t,e,n){var r=t.splice(e,1);return{newDocument:n,removed:r[0]}},replace:function(t,e,n){var r=t[e];return t[e]=this.value,{newDocument:n,removed:r}},move:sa.move,copy:sa.copy,test:sa.test,_get:sa._get};function Zu(t,e){if(e=="")return t;var n={op:"_get",path:e};return fi(t,n),n.value}function fi(t,e,n=!1,r=!0,s=!0,i=0){if(n&&(typeof n=="function"?n(e,0,t,e.path):Ku(e,0)),e.path===""){let a={newDocument:t};if(e.op==="add")return a.newDocument=e.value,a;if(e.op==="replace")return a.newDocument=e.value,a.removed=t,a;if(e.op==="move"||e.op==="copy")return a.newDocument=Zu(t,e.from),e.op==="move"&&(a.removed=t),a;if(e.op==="test"){if(a.test=Ro(t,e.value),a.test===!1)throw new lt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return a.newDocument=t,a}else{if(e.op==="remove")return a.removed=t,a.newDocument=null,a;if(e.op==="_get")return e.value=t,a;if(n)throw new lt("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,t);return a}}else{r||(t=wr(t));const o=(e.path||"").split("/");let c=t,u=1,l=o.length,d,h,f;for(typeof n=="function"?f=n:f=Ku;;){if(h=o[u],h&&h.indexOf("~")!=-1&&(h=nN(h)),s&&(h=="__proto__"||h=="prototype"&&u>0&&o[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&d===void 0&&(c[h]===void 0?d=o.slice(0,u).join("/"):u==l-1&&(d=e.path),d!==void 0&&f(e,0,t,d)),u++,Array.isArray(c)){if(h==="-")h=c.length;else{if(n&&!cp(h))throw new lt("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,t);cp(h)&&(h=~~h)}if(u>=l){if(n&&e.op==="add"&&h>c.length)throw new lt("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,t);const m=iN[e.op].call(e,c,h,t);if(m.test===!1)throw new lt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return m}}else if(u>=l){const m=sa[e.op].call(e,c,h,t);if(m.test===!1)throw new lt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return m}if(c=c[h],n&&u<l&&(!c||typeof c!="object"))throw new lt("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,t)}}}function ga(t,e,n,r=!0,s=!0){if(n&&!Array.isArray(e))throw new lt("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(t=wr(t));const i=new Array(e.length);for(let a=0,o=e.length;a<o;a++)i[a]=fi(t,e[a],n,!0,s,a),t=i[a].newDocument;return i.newDocument=t,i}function aN(t,e,n){const r=fi(t,e);if(r.test===!1)throw new lt("Test operation failed","TEST_OPERATION_FAILED",n,e,t);return r.newDocument}function Ku(t,e,n,r){if(typeof t!="object"||t===null||Array.isArray(t))throw new lt("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,t,n);if(sa[t.op]){if(typeof t.path!="string")throw new lt("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,t,n);if(t.path.indexOf("/")!==0&&t.path.length>0)throw new lt('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,t,n);if((t.op==="move"||t.op==="copy")&&typeof t.from!="string")throw new lt("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,t,n);if((t.op==="add"||t.op==="replace"||t.op==="test")&&t.value===void 0)throw new lt("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,t,n);if((t.op==="add"||t.op==="replace"||t.op==="test")&&up(t.value))throw new lt("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,t,n);if(n){if(t.op=="add"){var s=t.path.split("/").length,i=r.split("/").length;if(s!==i+1&&s!==i)throw new lt("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,t,n)}else if(t.op==="replace"||t.op==="remove"||t.op==="_get"){if(t.path!==r)throw new lt("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,t,n)}else if(t.op==="move"||t.op==="copy"){var a={op:"_get",path:t.from,value:void 0},o=XE([a],n);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new lt("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,t,n)}}}else throw new lt("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,t,n)}function XE(t,e,n){try{if(!Array.isArray(t))throw new lt("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)ga(wr(e),wr(t),n||!0);else{n=n||Ku;for(var r=0;r<t.length;r++)n(t[r],r,e,void 0)}}catch(s){if(s instanceof lt)return s;throw s}}function Ro(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){var n=Array.isArray(t),r=Array.isArray(e),s,i,a;if(n&&r){if(i=t.length,i!=e.length)return!1;for(s=i;s--!==0;)if(!Ro(t[s],e[s]))return!1;return!0}if(n!=r)return!1;var o=Object.keys(t);if(i=o.length,i!==Object.keys(e).length)return!1;for(s=i;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=i;s--!==0;)if(a=o[s],!Ro(t[a],e[a]))return!1;return!0}return t!==t&&e!==e}function YE(t,e,n,r,s){if(e!==t){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=op(e),a=op(t),o=!1,c=a.length-1;c>=0;c--){var u=a[c],l=t[u];if(ap(e,u)&&!(e[u]===void 0&&l!==void 0&&Array.isArray(e)===!1)){var d=e[u];typeof l=="object"&&l!=null&&typeof d=="object"&&d!=null&&Array.isArray(l)===Array.isArray(d)?YE(l,d,n,r+"/"+Bi(u),s):l!==d&&(s&&n.push({op:"test",path:r+"/"+Bi(u),value:wr(l)}),n.push({op:"replace",path:r+"/"+Bi(u),value:wr(d)}))}else Array.isArray(t)===Array.isArray(e)?(s&&n.push({op:"test",path:r+"/"+Bi(u),value:wr(l)}),n.push({op:"remove",path:r+"/"+Bi(u)}),o=!0):(s&&n.push({op:"test",path:r,value:t}),n.push({op:"replace",path:r,value:e}))}if(!(!o&&i.length==a.length))for(var c=0;c<i.length;c++){var u=i[c];!ap(t,u)&&e[u]!==void 0&&n.push({op:"add",path:r+"/"+Bi(u),value:wr(e[u])})}}}function ed(t,e,n=!1){var r=[];return YE(t,e,r,"",n),r}({...KE});var QE={};ve(QE,{LogStreamCallbackHandler:()=>dp,RunLog:()=>Qm,RunLogPatch:()=>rs,isLogStreamHandler:()=>eS});var rs=class{constructor(t){p(this,"ops");this.ops=t.ops??[]}concat(t){const e=this.ops.concat(t.ops),n=ga({},e);return new Qm({ops:e,state:n[n.length-1].newDocument})}},Qm=class lp extends rs{constructor(n){super(n);p(this,"state");this.state=n.state}concat(n){const r=this.ops.concat(n.ops),s=ga(this.state,n.ops);return new lp({ops:r,state:s[s.length-1].newDocument})}static fromRunLogPatch(n){const r=ga({},n.ops);return new lp({ops:n.ops,state:r[r.length-1].newDocument})}};const eS=t=>t.name==="log_stream_tracer";async function Sw(t,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=t;if(["retriever","llm","prompt"].includes(t.run_type))return n;if(!(Object.keys(n).length===1&&(n==null?void 0:n.input)===""))return n.input}async function xw(t,e){const{outputs:n}=t;return e==="original"||["retriever","llm","prompt"].includes(t.run_type)?n:n!==void 0&&Object.keys(n).length===1&&(n==null?void 0:n.output)!==void 0?n.output:n}function oN(t){return t!==void 0&&t.message!==void 0}var dp=class extends ws{constructor(e){super({_awaitHandler:!0,...e});p(this,"autoClose",!0);p(this,"includeNames");p(this,"includeTypes");p(this,"includeTags");p(this,"excludeNames");p(this,"excludeTypes");p(this,"excludeTags");p(this,"_schemaFormat","original");p(this,"rootId");p(this,"keyMapByRunId",{});p(this,"counterMapByRunName",{});p(this,"transformStream");p(this,"writer");p(this,"receiveStream");p(this,"name","log_stream_tracer");p(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=kn.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const n=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||n.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,n){for await(const r of n){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new rs({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new rs({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const n=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=n===1?e.name:`${e.name}:${n}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await Sw(e,this._schemaFormat)),await this.writer.write(new rs({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const n=this.keyMapByRunId[e.id];if(n===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${n}/inputs`,value:await Sw(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${n}/final_output`,value:await xw(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${n}/end_time`,value:new Date(e.end_time).toISOString()});const s=new rs({ops:r});await this.writer.write(s)}finally{if(e.id===this.rootId){const n=new rs({ops:[{op:"replace",path:"/final_output",value:await xw(e,this._schemaFormat)}]});await this.writer.write(n),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,n,r){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const i=e.inputs.messages!==void 0;let a;i?oN(r==null?void 0:r.chunk)?a=r==null?void 0:r.chunk:a=new Et({id:`run-${e.id}`,content:n}):a=n;const o=new rs({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:n},{op:"add",path:`/logs/${s}/streamed_output/-`,value:a}]});await this.writer.write(o)}},tS={};ve(tS,{ChatGenerationChunk:()=>fn,GenerationChunk:()=>ya,RUN_KEY:()=>Oo});const Oo="__run";var ya=class nS{constructor(e){p(this,"text");p(this,"generationInfo");this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new nS({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},fn=class rS extends ya{constructor(n){super(n);p(this,"message");this.message=n.message}concat(n){return new rS({text:this.text+n.text,generationInfo:{...this.generationInfo,...n.generationInfo},message:this.message.concat(n.message)})}},sS={};ve(sS,{AsyncCaller:()=>lc});const cN=[400,401,402,403,404,405,406,407,409],uN=t=>{var n,r;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||(t==null?void 0:t.code)==="ECONNABORTED")throw t;const e=((n=t==null?void 0:t.response)==null?void 0:n.status)??(t==null?void 0:t.status);if(e&&cN.includes(+e))throw t;if(((r=t==null?void 0:t.error)==null?void 0:r.code)==="insufficient_quota"){const s=new Error(t==null?void 0:t.message);throw s.name="InsufficientQuotaError",s}};var lc=class{constructor(t){p(this,"maxConcurrency");p(this,"maxRetries");p(this,"onFailedAttempt");p(this,"queue");this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6,this.onFailedAttempt=t.onFailedAttempt??uN;const e="default"in us?us.default:us;this.queue=new e({concurrency:this.maxConcurrency})}call(t,...e){return this.queue.add(()=>Vu(()=>t(...e).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(t,e,...n){return t.signal?Promise.race([this.call(e,...n),new Promise((r,s)=>{var i;(i=t.signal)==null||i.addEventListener("abort",()=>{s(Io(t.signal))})})]):this.call(e,...n)}fetch(...t){return this.call(()=>fetch(...t).then(e=>e.ok?e:Promise.reject(e)))}};function Le(t,e,n){function r(o,c){var u;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(u=o._zod).traits??(u.traits=new Set),o._zod.traits.add(t),e(o,c);for(const l in a.prototype)l in o||Object.defineProperty(o,l,{value:a.prototype[l].bind(o)});o._zod.constr=a,o._zod.def=c}const s=(n==null?void 0:n.Parent)??Object;class i extends s{}Object.defineProperty(i,"name",{value:t});function a(o){var c;const u=n!=null&&n.Parent?new i:this;r(u,o),(c=u._zod).deferred??(c.deferred=[]);for(const l of u._zod.deferred)l();return u}return Object.defineProperty(a,"init",{value:r}),Object.defineProperty(a,Symbol.hasInstance,{value:o=>{var c,u;return n!=null&&n.Parent&&o instanceof n.Parent?!0:(u=(c=o==null?void 0:o._zod)==null?void 0:c.traits)==null?void 0:u.has(t)}}),Object.defineProperty(a,"name",{value:t}),a}class $o extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const lN={};function Ei(t){return lN}function dN(t){const e=Object.values(t).filter(r=>typeof r=="number");return Object.entries(t).filter(([r,s])=>e.indexOf(+r)===-1).map(([r,s])=>s)}function hN(t,e){return typeof e=="bigint"?e.toString():e}function eg(t){return t==null}function tg(t){const e=t.startsWith("^")?1:0,n=t.endsWith("$")?t.length-1:t.length;return t.slice(e,n)}function dt(t,e,n){Object.defineProperty(t,e,{get(){{const r=n();return t[e]=r,r}},set(r){Object.defineProperty(t,e,{value:r})},configurable:!0})}function fN(t,e,n){Object.defineProperty(t,e,{value:n,writable:!0,enumerable:!0,configurable:!0})}const iS=Error.captureStackTrace?Error.captureStackTrace:(...t)=>{};function Tw(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function hp(t){if(Tw(t)===!1)return!1;const e=t.constructor;if(e===void 0)return!0;const n=e.prototype;return!(Tw(n)===!1||Object.prototype.hasOwnProperty.call(n,"isPrototypeOf")===!1)}function Wr(t,e,n){const r=new t._zod.constr(e??t._zod.def);return(!e||n!=null&&n.parent)&&(r._zod.parent=t),r}function Zs(t){const e=t;if(!e)return{};if(typeof e=="string")return{error:()=>e};if((e==null?void 0:e.message)!==void 0){if((e==null?void 0:e.error)!==void 0)throw new Error("Cannot specify both `message` and `error` params");e.error=e.message}return delete e.message,typeof e.error=="string"?{...e,error:()=>e.error}:e}function pN(t,e){if(!hp(e))throw new Error("Invalid input to extend: expected a plain object");const n={...t._zod.def,get shape(){const r={...t._zod.def.shape,...e};return fN(this,"shape",r),r},checks:[]};return Wr(t,n)}function mN(t,e,n){const r=e._zod.def.shape,s={...r};for(const i in r)s[i]=t?new t({type:"optional",innerType:r[i]}):r[i];return Wr(e,{...e._zod.def,shape:s,checks:[]})}function mo(t,e=0){var n;for(let r=e;r<t.issues.length;r++)if(((n=t.issues[r])==null?void 0:n.continue)!==!0)return!0;return!1}function gN(t,e){return e.map(n=>{var r;return(r=n).path??(r.path=[]),n.path.unshift(t),n})}function Bc(t){return typeof t=="string"?t:t==null?void 0:t.message}function Si(t,e,n){var s,i,a,o,c,u;const r={...t,path:t.path??[]};if(!t.message){const l=Bc((a=(i=(s=t.inst)==null?void 0:s._zod.def)==null?void 0:i.error)==null?void 0:a.call(i,t))??Bc((o=e==null?void 0:e.error)==null?void 0:o.call(e,t))??Bc((c=n.customError)==null?void 0:c.call(n,t))??Bc((u=n.localeError)==null?void 0:u.call(n,t))??"Invalid input";r.message=l}return delete r.inst,delete r.continue,e!=null&&e.reportInput||delete r.input,r}function ng(t){return Array.isArray(t)?"array":typeof t=="string"?"string":"unknown"}function No(...t){const[e,n,r]=t;return typeof e=="string"?{message:e,code:"custom",input:n,inst:r}:{...e}}const aS=(t,e)=>{t.name="$ZodError",Object.defineProperty(t,"_zod",{value:t._zod,enumerable:!1}),Object.defineProperty(t,"issues",{value:e,enumerable:!1}),Object.defineProperty(t,"message",{get(){return JSON.stringify(e,hN,2)},enumerable:!0}),Object.defineProperty(t,"toString",{value:()=>t.message,enumerable:!1})},oS=Le("$ZodError",aS),td=Le("$ZodError",aS,{Parent:Error});function yN(t,e=n=>n.message){const n={},r=[];for(const s of t.issues)s.path.length>0?(n[s.path[0]]=n[s.path[0]]||[],n[s.path[0]].push(e(s))):r.push(e(s));return{formErrors:r,fieldErrors:n}}function _N(t,e){const n=e||function(i){return i.message},r={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union"&&a.errors.length)a.errors.map(o=>s({issues:o}));else if(a.code==="invalid_key")s({issues:a.issues});else if(a.code==="invalid_element")s({issues:a.issues});else if(a.path.length===0)r._errors.push(n(a));else{let o=r,c=0;for(;c<a.path.length;){const u=a.path[c];c===a.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(n(a))):o[u]=o[u]||{_errors:[]},o=o[u],c++}}};return s(t),r}function wN(t){const e=[];for(const n of t)typeof n=="number"?e.push(`[${n}]`):typeof n=="symbol"?e.push(`[${JSON.stringify(String(n))}]`):/[^\w$]/.test(n)?e.push(`[${JSON.stringify(n)}]`):(e.length&&e.push("."),e.push(n));return e.join("")}function bN(t){var r;const e=[],n=[...t.issues].sort((s,i)=>s.path.length-i.path.length);for(const s of n)e.push(`✖ ${s.message}`),(r=s.path)!=null&&r.length&&e.push(`  → at ${wN(s.path)}`);return e.join(`
`)}const cS=t=>(e,n,r,s)=>{const i=r?Object.assign(r,{async:!1}):{async:!1},a=e._zod.run({value:n,issues:[]},i);if(a instanceof Promise)throw new $o;if(a.issues.length){const o=new((s==null?void 0:s.Err)??t)(a.issues.map(c=>Si(c,i,Ei())));throw iS(o,s==null?void 0:s.callee),o}return a.value},nd=cS(td),uS=t=>async(e,n,r,s)=>{const i=r?Object.assign(r,{async:!0}):{async:!0};let a=e._zod.run({value:n,issues:[]},i);if(a instanceof Promise&&(a=await a),a.issues.length){const o=new((s==null?void 0:s.Err)??t)(a.issues.map(c=>Si(c,i,Ei())));throw iS(o,s==null?void 0:s.callee),o}return a.value},lS=uS(td),dS=t=>(e,n,r)=>{const s=r?{...r,async:!1}:{async:!1},i=e._zod.run({value:n,issues:[]},s);if(i instanceof Promise)throw new $o;return i.issues.length?{success:!1,error:new(t??oS)(i.issues.map(a=>Si(a,s,Ei())))}:{success:!0,data:i.value}},vN=dS(td),hS=t=>async(e,n,r)=>{const s=r?Object.assign(r,{async:!0}):{async:!0};let i=e._zod.run({value:n,issues:[]},s);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new t(i.issues.map(a=>Si(a,s,Ei())))}:{success:!0,data:i.value}},EN=hS(td),Na=Le("$ZodCheck",(t,e)=>{var n;t._zod??(t._zod={}),t._zod.def=e,(n=t._zod).onattach??(n.onattach=[])}),SN=Le("$ZodCheckMaxLength",(t,e)=>{var n;Na.init(t,e),(n=t._zod.def).when??(n.when=r=>{const s=r.value;return!eg(s)&&s.length!==void 0}),t._zod.onattach.push(r=>{const s=r._zod.bag.maximum??Number.POSITIVE_INFINITY;e.maximum<s&&(r._zod.bag.maximum=e.maximum)}),t._zod.check=r=>{const s=r.value;if(s.length<=e.maximum)return;const a=ng(s);r.issues.push({origin:a,code:"too_big",maximum:e.maximum,inclusive:!0,input:s,inst:t,continue:!e.abort})}}),xN=Le("$ZodCheckMinLength",(t,e)=>{var n;Na.init(t,e),(n=t._zod.def).when??(n.when=r=>{const s=r.value;return!eg(s)&&s.length!==void 0}),t._zod.onattach.push(r=>{const s=r._zod.bag.minimum??Number.NEGATIVE_INFINITY;e.minimum>s&&(r._zod.bag.minimum=e.minimum)}),t._zod.check=r=>{const s=r.value;if(s.length>=e.minimum)return;const a=ng(s);r.issues.push({origin:a,code:"too_small",minimum:e.minimum,inclusive:!0,input:s,inst:t,continue:!e.abort})}}),TN=Le("$ZodCheckLengthEquals",(t,e)=>{var n;Na.init(t,e),(n=t._zod.def).when??(n.when=r=>{const s=r.value;return!eg(s)&&s.length!==void 0}),t._zod.onattach.push(r=>{const s=r._zod.bag;s.minimum=e.length,s.maximum=e.length,s.length=e.length}),t._zod.check=r=>{const s=r.value,i=s.length;if(i===e.length)return;const a=ng(s),o=i>e.length;r.issues.push({origin:a,...o?{code:"too_big",maximum:e.length}:{code:"too_small",minimum:e.length},inclusive:!0,exact:!0,input:r.value,inst:t,continue:!e.abort})}}),AN=Le("$ZodCheckOverwrite",(t,e)=>{Na.init(t,e),t._zod.check=n=>{n.value=e.tx(n.value)}}),CN={major:4,minor:0,patch:0},Yt=Le("$ZodType",(t,e)=>{var s;var n;t??(t={}),t._zod.def=e,t._zod.bag=t._zod.bag||{},t._zod.version=CN;const r=[...t._zod.def.checks??[]];t._zod.traits.has("$ZodCheck")&&r.unshift(t);for(const i of r)for(const a of i._zod.onattach)a(t);if(r.length===0)(n=t._zod).deferred??(n.deferred=[]),(s=t._zod.deferred)==null||s.push(()=>{t._zod.run=t._zod.parse});else{const i=(a,o,c)=>{let u=mo(a),l;for(const d of o){if(d._zod.def.when){if(!d._zod.def.when(a))continue}else if(u)continue;const h=a.issues.length,f=d._zod.check(a);if(f instanceof Promise&&(c==null?void 0:c.async)===!1)throw new $o;if(l||f instanceof Promise)l=(l??Promise.resolve()).then(async()=>{await f,a.issues.length!==h&&(u||(u=mo(a,h)))});else{if(a.issues.length===h)continue;u||(u=mo(a,h))}}return l?l.then(()=>a):a};t._zod.run=(a,o)=>{const c=t._zod.parse(a,o);if(c instanceof Promise){if(o.async===!1)throw new $o;return c.then(u=>i(u,r,o))}return i(c,r,o)}}t["~standard"]={validate:i=>{var a;try{const o=vN(t,i);return o.success?{value:o.data}:{issues:(a=o.error)==null?void 0:a.issues}}catch{return EN(t,i).then(c=>{var u;return c.success?{value:c.data}:{issues:(u=c.error)==null?void 0:u.issues}})}},vendor:"zod",version:1}}),kN=Le("$ZodAny",(t,e)=>{Yt.init(t,e),t._zod.parse=n=>n}),IN=Le("$ZodUnknown",(t,e)=>{Yt.init(t,e),t._zod.parse=n=>n}),RN=Le("$ZodNever",(t,e)=>{Yt.init(t,e),t._zod.parse=(n,r)=>(n.issues.push({expected:"never",code:"invalid_type",input:n.value,inst:t}),n)});function Aw(t,e,n){t.issues.length&&e.issues.push(...gN(n,t.issues)),e.value[n]=t.value}const ON=Le("$ZodArray",(t,e)=>{Yt.init(t,e),t._zod.parse=(n,r)=>{const s=n.value;if(!Array.isArray(s))return n.issues.push({expected:"array",code:"invalid_type",input:s,inst:t}),n;n.value=Array(s.length);const i=[];for(let a=0;a<s.length;a++){const o=s[a],c=e.element._zod.run({value:o,issues:[]},r);c instanceof Promise?i.push(c.then(u=>Aw(u,n,a))):Aw(c,n,a)}return i.length?Promise.all(i).then(()=>n):n}});function Cw(t,e,n,r){for(const s of t)if(s.issues.length===0)return e.value=s.value,e;return e.issues.push({code:"invalid_union",input:e.value,inst:n,errors:t.map(s=>s.issues.map(i=>Si(i,r,Ei())))}),e}const $N=Le("$ZodUnion",(t,e)=>{Yt.init(t,e),dt(t._zod,"optin",()=>e.options.some(n=>n._zod.optin==="optional")?"optional":void 0),dt(t._zod,"optout",()=>e.options.some(n=>n._zod.optout==="optional")?"optional":void 0),dt(t._zod,"values",()=>{if(e.options.every(n=>n._zod.values))return new Set(e.options.flatMap(n=>Array.from(n._zod.values)))}),dt(t._zod,"pattern",()=>{if(e.options.every(n=>n._zod.pattern)){const n=e.options.map(r=>r._zod.pattern);return new RegExp(`^(${n.map(r=>tg(r.source)).join("|")})$`)}}),t._zod.parse=(n,r)=>{let s=!1;const i=[];for(const a of e.options){const o=a._zod.run({value:n.value,issues:[]},r);if(o instanceof Promise)i.push(o),s=!0;else{if(o.issues.length===0)return o;i.push(o)}}return s?Promise.all(i).then(a=>Cw(a,n,t,r)):Cw(i,n,t,r)}}),NN=Le("$ZodIntersection",(t,e)=>{Yt.init(t,e),t._zod.parse=(n,r)=>{const s=n.value,i=e.left._zod.run({value:s,issues:[]},r),a=e.right._zod.run({value:s,issues:[]},r);return i instanceof Promise||a instanceof Promise?Promise.all([i,a]).then(([c,u])=>kw(n,c,u)):kw(n,i,a)}});function fp(t,e){if(t===e)return{valid:!0,data:t};if(t instanceof Date&&e instanceof Date&&+t==+e)return{valid:!0,data:t};if(hp(t)&&hp(e)){const n=Object.keys(e),r=Object.keys(t).filter(i=>n.indexOf(i)!==-1),s={...t,...e};for(const i of r){const a=fp(t[i],e[i]);if(!a.valid)return{valid:!1,mergeErrorPath:[i,...a.mergeErrorPath]};s[i]=a.data}return{valid:!0,data:s}}if(Array.isArray(t)&&Array.isArray(e)){if(t.length!==e.length)return{valid:!1,mergeErrorPath:[]};const n=[];for(let r=0;r<t.length;r++){const s=t[r],i=e[r],a=fp(s,i);if(!a.valid)return{valid:!1,mergeErrorPath:[r,...a.mergeErrorPath]};n.push(a.data)}return{valid:!0,data:n}}return{valid:!1,mergeErrorPath:[]}}function kw(t,e,n){if(e.issues.length&&t.issues.push(...e.issues),n.issues.length&&t.issues.push(...n.issues),mo(t))return t;const r=fp(e.value,n.value);if(!r.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(r.mergeErrorPath)}`);return t.value=r.data,t}const PN=Le("$ZodTransform",(t,e)=>{Yt.init(t,e),t._zod.parse=(n,r)=>{const s=e.transform(n.value,n);if(r.async)return(s instanceof Promise?s:Promise.resolve(s)).then(a=>(n.value=a,n));if(s instanceof Promise)throw new $o;return n.value=s,n}}),rg=Le("$ZodOptional",(t,e)=>{Yt.init(t,e),t._zod.optin="optional",t._zod.optout="optional",dt(t._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,void 0]):void 0),dt(t._zod,"pattern",()=>{const n=e.innerType._zod.pattern;return n?new RegExp(`^(${tg(n.source)})?$`):void 0}),t._zod.parse=(n,r)=>e.innerType._zod.optin==="optional"?e.innerType._zod.run(n,r):n.value===void 0?n:e.innerType._zod.run(n,r)}),LN=Le("$ZodNullable",(t,e)=>{Yt.init(t,e),dt(t._zod,"optin",()=>e.innerType._zod.optin),dt(t._zod,"optout",()=>e.innerType._zod.optout),dt(t._zod,"pattern",()=>{const n=e.innerType._zod.pattern;return n?new RegExp(`^(${tg(n.source)}|null)$`):void 0}),dt(t._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,null]):void 0),t._zod.parse=(n,r)=>n.value===null?n:e.innerType._zod.run(n,r)}),MN=Le("$ZodDefault",(t,e)=>{Yt.init(t,e),t._zod.optin="optional",dt(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(n,r)=>{if(n.value===void 0)return n.value=e.defaultValue,n;const s=e.innerType._zod.run(n,r);return s instanceof Promise?s.then(i=>Iw(i,e)):Iw(s,e)}});function Iw(t,e){return t.value===void 0&&(t.value=e.defaultValue),t}const DN=Le("$ZodPrefault",(t,e)=>{Yt.init(t,e),t._zod.optin="optional",dt(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(n,r)=>(n.value===void 0&&(n.value=e.defaultValue),e.innerType._zod.run(n,r))}),UN=Le("$ZodNonOptional",(t,e)=>{Yt.init(t,e),dt(t._zod,"values",()=>{const n=e.innerType._zod.values;return n?new Set([...n].filter(r=>r!==void 0)):void 0}),t._zod.parse=(n,r)=>{const s=e.innerType._zod.run(n,r);return s instanceof Promise?s.then(i=>Rw(i,t)):Rw(s,t)}});function Rw(t,e){return!t.issues.length&&t.value===void 0&&t.issues.push({code:"invalid_type",expected:"nonoptional",input:t.value,inst:e}),t}const BN=Le("$ZodCatch",(t,e)=>{Yt.init(t,e),t._zod.optin="optional",dt(t._zod,"optout",()=>e.innerType._zod.optout),dt(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(n,r)=>{const s=e.innerType._zod.run(n,r);return s instanceof Promise?s.then(i=>(n.value=i.value,i.issues.length&&(n.value=e.catchValue({...n,error:{issues:i.issues.map(a=>Si(a,r,Ei()))},input:n.value}),n.issues=[]),n)):(n.value=s.value,s.issues.length&&(n.value=e.catchValue({...n,error:{issues:s.issues.map(i=>Si(i,r,Ei()))},input:n.value}),n.issues=[]),n)}}),jN=Le("$ZodPipe",(t,e)=>{Yt.init(t,e),dt(t._zod,"values",()=>e.in._zod.values),dt(t._zod,"optin",()=>e.in._zod.optin),dt(t._zod,"optout",()=>e.out._zod.optout),t._zod.parse=(n,r)=>{const s=e.in._zod.run(n,r);return s instanceof Promise?s.then(i=>Ow(i,e,r)):Ow(s,e,r)}});function Ow(t,e,n){return mo(t)?t:e.out._zod.run({value:t.value,issues:t.issues},n)}const FN=Le("$ZodReadonly",(t,e)=>{Yt.init(t,e),dt(t._zod,"propValues",()=>e.innerType._zod.propValues),dt(t._zod,"values",()=>e.innerType._zod.values),dt(t._zod,"optin",()=>e.innerType._zod.optin),dt(t._zod,"optout",()=>e.innerType._zod.optout),t._zod.parse=(n,r)=>{const s=e.innerType._zod.run(n,r);return s instanceof Promise?s.then($w):$w(s)}});function $w(t){return t.value=Object.freeze(t.value),t}const zN=Le("$ZodCustom",(t,e)=>{Na.init(t,e),Yt.init(t,e),t._zod.parse=(n,r)=>n,t._zod.check=n=>{const r=n.value,s=e.fn(r);if(s instanceof Promise)return s.then(i=>Nw(i,n,r,t));Nw(s,n,r,t)}});function Nw(t,e,n,r){if(!t){const s={code:"custom",input:n,inst:r,path:[...r._zod.def.path??[]],continue:!r._zod.def.abort};r._zod.def.params&&(s.params=r._zod.def.params),e.issues.push(No(s))}}class fS{constructor(){this._map=new Map,this._idmap=new Map}add(e,...n){const r=n[0];if(this._map.set(e,r),r&&typeof r=="object"&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const n=this._map.get(e);return n&&typeof n=="object"&&"id"in n&&this._idmap.delete(n.id),this._map.delete(e),this}get(e){const n=e._zod.parent;if(n){const r={...this.get(n)??{}};return delete r.id,{...r,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function VN(){return new fS}const Mt=VN();function qN(t){return new t({type:"any"})}function HN(t){return new t({type:"unknown"})}function GN(t,e){return new t({type:"never",...Zs(e)})}function WN(t,e){return new SN({check:"max_length",...Zs(e),maximum:t})}function Pw(t,e){return new xN({check:"min_length",...Zs(e),minimum:t})}function JN(t,e){return new TN({check:"length_equals",...Zs(e),length:t})}function ZN(t){return new AN({check:"overwrite",tx:t})}function KN(t,e,n){return new t({type:"array",element:e,...Zs(n)})}function XN(t,e,n){return new t({type:"custom",check:"custom",fn:e,...Zs(n)})}class Lw{constructor(e){this.counter=0,this.metadataRegistry=(e==null?void 0:e.metadata)??Mt,this.target=(e==null?void 0:e.target)??"draft-2020-12",this.unrepresentable=(e==null?void 0:e.unrepresentable)??"throw",this.override=(e==null?void 0:e.override)??(()=>{}),this.io=(e==null?void 0:e.io)??"output",this.seen=new Map}process(e,n={path:[],schemaPath:[]}){var d,h,f;var r;const s=e._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},a=this.seen.get(e);if(a)return a.count++,n.schemaPath.includes(e)&&(a.cycle=n.path),a.schema;const o={schema:{},count:1,cycle:void 0,path:n.path};this.seen.set(e,o);const c=(h=(d=e._zod).toJSONSchema)==null?void 0:h.call(d);if(c)o.schema=c;else{const m={...n,schemaPath:[...n.schemaPath,e],path:n.path},g=e._zod.parent;if(g)o.ref=g,this.process(g,m),this.seen.get(g).isParent=!0;else{const _=o.schema;switch(s.type){case"string":{const b=_;b.type="string";const{minimum:y,maximum:E,format:C,patterns:k,contentEncoding:R}=e._zod.bag;if(typeof y=="number"&&(b.minLength=y),typeof E=="number"&&(b.maxLength=E),C&&(b.format=i[C]??C,b.format===""&&delete b.format),R&&(b.contentEncoding=R),k&&k.size>0){const $=[...k];$.length===1?b.pattern=$[0].source:$.length>1&&(o.schema.allOf=[...$.map(T=>({...this.target==="draft-7"?{type:"string"}:{},pattern:T.source}))])}break}case"number":{const b=_,{minimum:y,maximum:E,format:C,multipleOf:k,exclusiveMaximum:R,exclusiveMinimum:$}=e._zod.bag;typeof C=="string"&&C.includes("int")?b.type="integer":b.type="number",typeof $=="number"&&(b.exclusiveMinimum=$),typeof y=="number"&&(b.minimum=y,typeof $=="number"&&($>=y?delete b.minimum:delete b.exclusiveMinimum)),typeof R=="number"&&(b.exclusiveMaximum=R),typeof E=="number"&&(b.maximum=E,typeof R=="number"&&(R<=E?delete b.maximum:delete b.exclusiveMaximum)),typeof k=="number"&&(b.multipleOf=k);break}case"boolean":{const b=_;b.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{_.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{_.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const b=_,{minimum:y,maximum:E}=e._zod.bag;typeof y=="number"&&(b.minItems=y),typeof E=="number"&&(b.maxItems=E),b.type="array",b.items=this.process(s.element,{...m,path:[...m.path,"items"]});break}case"object":{const b=_;b.type="object",b.properties={};const y=s.shape;for(const k in y)b.properties[k]=this.process(y[k],{...m,path:[...m.path,"properties",k]});const E=new Set(Object.keys(y)),C=new Set([...E].filter(k=>{const R=s.shape[k]._zod;return this.io==="input"?R.optin===void 0:R.optout===void 0}));C.size>0&&(b.required=Array.from(C)),((f=s.catchall)==null?void 0:f._zod.def.type)==="never"?b.additionalProperties=!1:s.catchall?s.catchall&&(b.additionalProperties=this.process(s.catchall,{...m,path:[...m.path,"additionalProperties"]})):this.io==="output"&&(b.additionalProperties=!1);break}case"union":{const b=_;b.anyOf=s.options.map((y,E)=>this.process(y,{...m,path:[...m.path,"anyOf",E]}));break}case"intersection":{const b=_,y=this.process(s.left,{...m,path:[...m.path,"allOf",0]}),E=this.process(s.right,{...m,path:[...m.path,"allOf",1]}),C=R=>"allOf"in R&&Object.keys(R).length===1,k=[...C(y)?y.allOf:[y],...C(E)?E.allOf:[E]];b.allOf=k;break}case"tuple":{const b=_;b.type="array";const y=s.items.map((k,R)=>this.process(k,{...m,path:[...m.path,"prefixItems",R]}));if(this.target==="draft-2020-12"?b.prefixItems=y:b.items=y,s.rest){const k=this.process(s.rest,{...m,path:[...m.path,"items"]});this.target==="draft-2020-12"?b.items=k:b.additionalItems=k}s.rest&&(b.items=this.process(s.rest,{...m,path:[...m.path,"items"]}));const{minimum:E,maximum:C}=e._zod.bag;typeof E=="number"&&(b.minItems=E),typeof C=="number"&&(b.maxItems=C);break}case"record":{const b=_;b.type="object",b.propertyNames=this.process(s.keyType,{...m,path:[...m.path,"propertyNames"]}),b.additionalProperties=this.process(s.valueType,{...m,path:[...m.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const b=_,y=dN(s.entries);y.every(E=>typeof E=="number")&&(b.type="number"),y.every(E=>typeof E=="string")&&(b.type="string"),b.enum=y;break}case"literal":{const b=_,y=[];for(const E of s.values)if(E===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof E=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");y.push(Number(E))}else y.push(E);if(y.length!==0)if(y.length===1){const E=y[0];b.type=E===null?"null":typeof E,b.const=E}else y.every(E=>typeof E=="number")&&(b.type="number"),y.every(E=>typeof E=="string")&&(b.type="string"),y.every(E=>typeof E=="boolean")&&(b.type="string"),y.every(E=>E===null)&&(b.type="null"),b.enum=y;break}case"file":{const b=_,y={type:"string",format:"binary",contentEncoding:"binary"},{minimum:E,maximum:C,mime:k}=e._zod.bag;E!==void 0&&(y.minLength=E),C!==void 0&&(y.maxLength=C),k?k.length===1?(y.contentMediaType=k[0],Object.assign(b,y)):b.anyOf=k.map(R=>({...y,contentMediaType:R})):Object.assign(b,y);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const b=this.process(s.innerType,m);_.anyOf=[b,{type:"null"}];break}case"nonoptional":{this.process(s.innerType,m),o.ref=s.innerType;break}case"success":{const b=_;b.type="boolean";break}case"default":{this.process(s.innerType,m),o.ref=s.innerType,_.default=JSON.parse(JSON.stringify(s.defaultValue));break}case"prefault":{this.process(s.innerType,m),o.ref=s.innerType,this.io==="input"&&(_._prefault=JSON.parse(JSON.stringify(s.defaultValue)));break}case"catch":{this.process(s.innerType,m),o.ref=s.innerType;let b;try{b=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}_.default=b;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const b=_,y=e._zod.pattern;if(!y)throw new Error("Pattern not found in template literal");b.type="string",b.pattern=y.source;break}case"pipe":{const b=this.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;this.process(b,m),o.ref=b;break}case"readonly":{this.process(s.innerType,m),o.ref=s.innerType,_.readOnly=!0;break}case"promise":{this.process(s.innerType,m),o.ref=s.innerType;break}case"optional":{this.process(s.innerType,m),o.ref=s.innerType;break}case"lazy":{const b=e._zod.innerType;this.process(b,m),o.ref=b;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}}}}const u=this.metadataRegistry.get(e);return u&&Object.assign(o.schema,u),this.io==="input"&&Ct(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((r=o.schema).default??(r.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,n){var l,d,h,f,m,g;const r={cycles:(n==null?void 0:n.cycles)??"ref",reused:(n==null?void 0:n.reused)??"inline",external:(n==null?void 0:n.external)??void 0},s=this.seen.get(e);if(!s)throw new Error("Unprocessed schema. This is a bug in Zod.");const i=_=>{var k;const b=this.target==="draft-2020-12"?"$defs":"definitions";if(r.external){const R=(k=r.external.registry.get(_[0]))==null?void 0:k.id,$=r.external.uri??(B=>B);if(R)return{ref:$(R)};const T=_[1].defId??_[1].schema.id??`schema${this.counter++}`;return _[1].defId=T,{defId:T,ref:`${$("__shared")}#/${b}/${T}`}}if(_[1]===s)return{ref:"#"};const E=`#/${b}/`,C=_[1].schema.id??`__schema${this.counter++}`;return{defId:C,ref:E+C}},a=_=>{if(_[1].schema.$ref)return;const b=_[1],{ref:y,defId:E}=i(_);b.def={...b.schema},E&&(b.defId=E);const C=b.schema;for(const k in C)delete C[k];C.$ref=y};if(r.cycles==="throw")for(const _ of this.seen.entries()){const b=_[1];if(b.cycle)throw new Error(`Cycle detected: #/${(l=b.cycle)==null?void 0:l.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const _ of this.seen.entries()){const b=_[1];if(e===_[0]){a(_);continue}if(r.external){const E=(d=r.external.registry.get(_[0]))==null?void 0:d.id;if(e!==_[0]&&E){a(_);continue}}if((h=this.metadataRegistry.get(_[0]))==null?void 0:h.id){a(_);continue}if(b.cycle){a(_);continue}if(b.count>1&&r.reused==="ref"){a(_);continue}}const o=(_,b)=>{const y=this.seen.get(_),E=y.def??y.schema,C={...E};if(y.ref===null)return;const k=y.ref;if(y.ref=null,k){o(k,b);const R=this.seen.get(k).schema;R.$ref&&b.target==="draft-7"?(E.allOf=E.allOf??[],E.allOf.push(R)):(Object.assign(E,R),Object.assign(E,C))}y.isParent||this.override({zodSchema:_,jsonSchema:E,path:y.path??[]})};for(const _ of[...this.seen.entries()].reverse())o(_[0],{target:this.target});const c={};if(this.target==="draft-2020-12"?c.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?c.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),(f=r.external)!=null&&f.uri){const _=(m=r.external.registry.get(e))==null?void 0:m.id;if(!_)throw new Error("Schema is missing an `id` property");c.$id=r.external.uri(_)}Object.assign(c,s.def);const u=((g=r.external)==null?void 0:g.defs)??{};for(const _ of this.seen.entries()){const b=_[1];b.def&&b.defId&&(u[b.defId]=b.def)}r.external||Object.keys(u).length>0&&(this.target==="draft-2020-12"?c.$defs=u:c.definitions=u);try{return JSON.parse(JSON.stringify(c))}catch{throw new Error("Error converting schema to JSON.")}}}function Xu(t,e){if(t instanceof fS){const r=new Lw(e),s={};for(const o of t._idmap.entries()){const[c,u]=o;r.process(u)}const i={},a={registry:t,uri:e==null?void 0:e.uri,defs:s};for(const o of t._idmap.entries()){const[c,u]=o;i[c]=r.emit(u,{...e,external:a})}if(Object.keys(s).length>0){const o=r.target==="draft-2020-12"?"$defs":"definitions";i.__shared={[o]:s}}return{schemas:i}}const n=new Lw(e);return n.process(t),n.emit(t,e)}function Ct(t,e){const n=e??{seen:new Set};if(n.seen.has(t))return!1;n.seen.add(t);const s=t._zod.def;switch(s.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return Ct(s.element,n);case"object":{for(const i in s.shape)if(Ct(s.shape[i],n))return!0;return!1}case"union":{for(const i of s.options)if(Ct(i,n))return!0;return!1}case"intersection":return Ct(s.left,n)||Ct(s.right,n);case"tuple":{for(const i of s.items)if(Ct(i,n))return!0;return!!(s.rest&&Ct(s.rest,n))}case"record":return Ct(s.keyType,n)||Ct(s.valueType,n);case"map":return Ct(s.keyType,n)||Ct(s.valueType,n);case"set":return Ct(s.valueType,n);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return Ct(s.innerType,n);case"lazy":return Ct(s.getter(),n);case"default":return Ct(s.innerType,n);case"prefault":return Ct(s.innerType,n);case"custom":return!1;case"transform":return!0;case"pipe":return Ct(s.in,n)||Ct(s.out,n);case"success":return!1;case"catch":return!1}throw new Error(`Unknown schema type: ${s.type}`)}function ft(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_zod"in e))return!1;const n=e._zod;return typeof n=="object"&&n!==null&&"def"in n}function gt(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_def"in e)||"_zod"in e)return!1;const n=e._def;return typeof n=="object"&&n!=null&&"typeName"in n}function YN(t){return ft(t)&&console.warn("[WARNING] Attempting to use Zod 4 schema in a context where Zod 3 schema is expected. This may cause unexpected behavior."),gt(t)}function tr(t){return!t||typeof t!="object"||Array.isArray(t)?!1:!!(ft(t)||gt(t))}function pS(t){return typeof t=="object"&&t!==null&&"_def"in t&&typeof t._def=="object"&&t._def!==null&&"typeName"in t._def&&t._def.typeName==="ZodLiteral"}function mS(t){return ft(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="literal":!1}function QN(t){return!!(pS(t)||mS(t))}async function gS(t,e){if(ft(t))try{return{success:!0,data:await lS(t,e)}}catch(n){return{success:!1,error:n}}if(gt(t))return await t.safeParseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function rd(t,e){if(ft(t))return await lS(t,e);if(gt(t))return await t.parseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function eP(t,e){if(ft(t))try{return{success:!0,data:nd(t,e)}}catch(n){return{success:!1,error:n}}if(gt(t))return t.safeParse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function mu(t,e){if(ft(t))return nd(t,e);if(gt(t))return t.parse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function xi(t){var e;if(ft(t))return(e=Mt.get(t))==null?void 0:e.description;if(gt(t)||"description"in t&&typeof t.description=="string")return t.description}function tP(t){if(!tr(t))return!1;if(gt(t)){const e=t._def;if(e.typeName==="ZodObject"){const n=t;return!n.shape||Object.keys(n.shape).length===0}if(e.typeName==="ZodRecord")return!0}if(ft(t)){const e=t._zod.def;if(e.type==="object"){const n=t;return!n.shape||Object.keys(n.shape).length===0}if(e.type==="record")return!0}return typeof t=="object"&&t!==null&&!("shape"in t)}function sg(t){return tr(t)?gt(t)?t._def.typeName==="ZodString":ft(t)?t._zod.def.type==="string":!1:!1}function ig(t){return typeof t=="object"&&t!==null&&"_def"in t&&typeof t._def=="object"&&t._def!==null&&"typeName"in t._def&&t._def.typeName==="ZodObject"}function qr(t){return ft(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="object":!1}function sd(t){return ft(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="array":!1}function yr(t){return!!(ig(t)||qr(t))}function Po(t){if(gt(t))return t.shape;if(ft(t))return t._zod.def.shape;throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function yS(t,e){if(gt(t))return t.extend(e);if(ft(t))return pN(t,e);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function ag(t){if(gt(t))return t.partial();if(ft(t))return mN(rg,t);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function Yu(t,e=!1){if(gt(t))return t.strict();if(qr(t)){const n=t._zod.def.shape;if(e)for(const[i,a]of Object.entries(t._zod.def.shape)){if(qr(a)){const c=Yu(a,e);n[i]=c}else if(sd(a)){let c=a._zod.def.element;qr(c)&&(c=Yu(c,e)),n[i]=Wr(a,{...a._zod.def,element:c})}else n[i]=a;const o=Mt.get(a);o&&Mt.add(n[i],o)}const r=Wr(t,{...t._zod.def,shape:n,catchall:GN(RN)}),s=Mt.get(t);return s&&Mt.add(r,s),r}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function pp(t,e=!1){if(ig(t))return t.passthrough();if(qr(t)){const n=t._zod.def.shape;if(e)for(const[i,a]of Object.entries(t._zod.def.shape)){if(qr(a)){const c=pp(a,e);n[i]=c}else if(sd(a)){let c=a._zod.def.element;qr(c)&&(c=pp(c,e)),n[i]=Wr(a,{...a._zod.def,element:c})}else n[i]=a;const o=Mt.get(a);o&&Mt.add(n[i],o)}const r=Wr(t,{...t._zod.def,shape:n,catchall:HN(IN)}),s=Mt.get(t);return s&&Mt.add(r,s),r}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function _S(t){if(gt(t))try{const e=t.parse(void 0);return()=>e}catch{return}if(ft(t))try{const e=nd(t,void 0);return()=>e}catch{return}}function nP(t){return gt(t)&&"typeName"in t._def&&t._def.typeName==="ZodEffects"}function rP(t){return ft(t)&&t._zod.def.type==="pipe"}function ia(t,e=!1){if(gt(t))return nP(t)?ia(t._def.schema,e):t;if(ft(t)){let n=t;if(rP(t)&&(n=ia(t._zod.def.in,e)),e){if(qr(n)){const s=n._zod.def.shape;for(const[i,a]of Object.entries(n._zod.def.shape))s[i]=ia(a,e);n=Wr(n,{...n._zod.def,shape:s})}else if(sd(n)){const s=ia(n._zod.def.element,e);n=Wr(n,{...n._zod.def,element:s})}}const r=Mt.get(t);return r&&Mt.add(n,r),n}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function sP(t,e){if(gt(t)){const n=Po(t),r={};for(const[s,i]of Object.entries(n))e(s,i)?r[s]=i.optional():r[s]=i;return t.extend(r)}if(ft(t)){const n=Po(t),r={...t._zod.def.shape};for(const[a,o]of Object.entries(n))e(a,o)&&(r[a]=new rg({type:"optional",innerType:o}));const s=Wr(t,{...t._zod.def,shape:r}),i=Mt.get(t);return i&&Mt.add(s,i),s}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}const iP=Symbol("Let zodToJsonSchema decide on which parser to use"),aP={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},oP=t=>({...aP,...t}),cP=t=>{const e=oP(t),n=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,flags:{hasReferencedOpenAiAnyType:!1},currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}},wS=(t,e)=>{let n=0;for(;n<t.length&&n<e.length&&t[n]===e[n];n++);return[(t.length-n).toString(),...e.slice(n)].join("/")};function zn(t){if(t.target!=="openAi")return{};const e=[...t.basePath,t.definitionPath,t.openAiAnyTypeName];return t.flags.hasReferencedOpenAiAnyType=!0,{$ref:t.$refStrategy==="relative"?wS(e,t.currentPath):e.join("/")}}function bS(t,e,n,r){r!=null&&r.errorMessages&&n&&(t.errorMessage={...t.errorMessage,[e]:n})}function Xe(t,e,n,r,s){t[e]=n,bS(t,e,r,s)}var He;(function(t){t.assertEqual=s=>{};function e(s){}t.assertIs=e;function n(s){throw new Error}t.assertNever=n,t.arrayToEnum=s=>{const i={};for(const a of s)i[a]=a;return i},t.getValidEnumValues=s=>{const i=t.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),a={};for(const o of i)a[o]=s[o];return t.objectValues(a)},t.objectValues=s=>t.objectKeys(s).map(function(i){return s[i]}),t.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const i=[];for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&i.push(a);return i},t.find=(s,i)=>{for(const a of s)if(i(a))return a},t.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function r(s,i=" | "){return s.map(a=>typeof a=="string"?`'${a}'`:a).join(i)}t.joinValues=r,t.jsonStringifyReplacer=(s,i)=>typeof i=="bigint"?i.toString():i})(He||(He={}));var Mw;(function(t){t.mergeShapes=(e,n)=>({...e,...n})})(Mw||(Mw={}));const le=He.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),ks=t=>{switch(typeof t){case"undefined":return le.undefined;case"string":return le.string;case"number":return Number.isNaN(t)?le.nan:le.number;case"boolean":return le.boolean;case"function":return le.function;case"bigint":return le.bigint;case"symbol":return le.symbol;case"object":return Array.isArray(t)?le.array:t===null?le.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?le.promise:typeof Map<"u"&&t instanceof Map?le.map:typeof Set<"u"&&t instanceof Set?le.set:typeof Date<"u"&&t instanceof Date?le.date:le.object;default:return le.unknown}},W=He.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class ps extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const n=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,n):this.__proto__=n,this.name="ZodError",this.issues=e}format(e){const n=e||function(i){return i.message},r={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union")a.unionErrors.map(s);else if(a.code==="invalid_return_type")s(a.returnTypeError);else if(a.code==="invalid_arguments")s(a.argumentsError);else if(a.path.length===0)r._errors.push(n(a));else{let o=r,c=0;for(;c<a.path.length;){const u=a.path[c];c===a.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(n(a))):o[u]=o[u]||{_errors:[]},o=o[u],c++}}};return s(this),r}static assert(e){if(!(e instanceof ps))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,He.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=n=>n.message){const n={},r=[];for(const s of this.issues)if(s.path.length>0){const i=s.path[0];n[i]=n[i]||[],n[i].push(e(s))}else r.push(e(s));return{formErrors:r,fieldErrors:n}}get formErrors(){return this.flatten()}}ps.create=t=>new ps(t);const mp=(t,e)=>{let n;switch(t.code){case W.invalid_type:t.received===le.undefined?n="Required":n=`Expected ${t.expected}, received ${t.received}`;break;case W.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(t.expected,He.jsonStringifyReplacer)}`;break;case W.unrecognized_keys:n=`Unrecognized key(s) in object: ${He.joinValues(t.keys,", ")}`;break;case W.invalid_union:n="Invalid input";break;case W.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${He.joinValues(t.options)}`;break;case W.invalid_enum_value:n=`Invalid enum value. Expected ${He.joinValues(t.options)}, received '${t.received}'`;break;case W.invalid_arguments:n="Invalid function arguments";break;case W.invalid_return_type:n="Invalid function return type";break;case W.invalid_date:n="Invalid date";break;case W.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(n=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(n=`${n} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?n=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?n=`Invalid input: must end with "${t.validation.endsWith}"`:He.assertNever(t.validation):t.validation!=="regex"?n=`Invalid ${t.validation}`:n="Invalid";break;case W.too_small:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="bigint"?n=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:n="Invalid input";break;case W.too_big:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?n=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:n="Invalid input";break;case W.custom:n="Invalid input";break;case W.invalid_intersection_types:n="Intersection results could not be merged";break;case W.not_multiple_of:n=`Number must be a multiple of ${t.multipleOf}`;break;case W.not_finite:n="Number must be finite";break;default:n=e.defaultError,He.assertNever(t)}return{message:n}};let uP=mp;function lP(){return uP}const dP=t=>{const{data:e,path:n,errorMaps:r,issueData:s}=t,i=[...n,...s.path||[]],a={...s,path:i};if(s.message!==void 0)return{...s,path:i,message:s.message};let o="";const c=r.filter(u=>!!u).slice().reverse();for(const u of c)o=u(a,{data:e,defaultError:o}).message;return{...s,path:i,message:o}};function ee(t,e){const n=lP(),r=dP({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,n,n===mp?void 0:mp].filter(s=>!!s)});t.common.issues.push(r)}class Vn{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,n){const r=[];for(const s of n){if(s.status==="aborted")return Re;s.status==="dirty"&&e.dirty(),r.push(s.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,n){const r=[];for(const s of n){const i=await s.key,a=await s.value;r.push({key:i,value:a})}return Vn.mergeObjectSync(e,r)}static mergeObjectSync(e,n){const r={};for(const s of n){const{key:i,value:a}=s;if(i.status==="aborted"||a.status==="aborted")return Re;i.status==="dirty"&&e.dirty(),a.status==="dirty"&&e.dirty(),i.value!=="__proto__"&&(typeof a.value<"u"||s.alwaysSet)&&(r[i.value]=a.value)}return{status:e.value,value:r}}}const Re=Object.freeze({status:"aborted"}),Za=t=>({status:"dirty",value:t}),or=t=>({status:"valid",value:t}),Dw=t=>t.status==="aborted",Uw=t=>t.status==="dirty",_a=t=>t.status==="valid",Qu=t=>typeof Promise<"u"&&t instanceof Promise;var he;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(he||(he={}));class Vs{constructor(e,n,r,s){this._cachedPath=[],this.parent=e,this.data=n,this._path=r,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Bw=(t,e)=>{if(_a(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const n=new ps(t.common.issues);return this._error=n,this._error}}};function De(t){if(!t)return{};const{errorMap:e,invalid_type_error:n,required_error:r,description:s}=t;if(e&&(n||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(a,o)=>{const{message:c}=t;return a.code==="invalid_enum_value"?{message:c??o.defaultError}:typeof o.data>"u"?{message:c??r??o.defaultError}:a.code!=="invalid_type"?{message:o.defaultError}:{message:c??n??o.defaultError}},description:s}}let Ve=class{get description(){return this._def.description}_getType(e){return ks(e.data)}_getOrReturnCtx(e,n){return n||{common:e.parent.common,data:e.data,parsedType:ks(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Vn,ctx:{common:e.parent.common,data:e.data,parsedType:ks(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const n=this._parse(e);if(Qu(n))throw new Error("Synchronous parse encountered promise.");return n}_parseAsync(e){const n=this._parse(e);return Promise.resolve(n)}parse(e,n){const r=this.safeParse(e,n);if(r.success)return r.data;throw r.error}safeParse(e,n){const r={common:{issues:[],async:(n==null?void 0:n.async)??!1,contextualErrorMap:n==null?void 0:n.errorMap},path:(n==null?void 0:n.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ks(e)},s=this._parseSync({data:e,path:r.path,parent:r});return Bw(r,s)}"~validate"(e){var r,s;const n={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ks(e)};if(!this["~standard"].async)try{const i=this._parseSync({data:e,path:[],parent:n});return _a(i)?{value:i.value}:{issues:n.common.issues}}catch(i){(s=(r=i==null?void 0:i.message)==null?void 0:r.toLowerCase())!=null&&s.includes("encountered")&&(this["~standard"].async=!0),n.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:n}).then(i=>_a(i)?{value:i.value}:{issues:n.common.issues})}async parseAsync(e,n){const r=await this.safeParseAsync(e,n);if(r.success)return r.data;throw r.error}async safeParseAsync(e,n){const r={common:{issues:[],contextualErrorMap:n==null?void 0:n.errorMap,async:!0},path:(n==null?void 0:n.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ks(e)},s=this._parse({data:e,path:r.path,parent:r}),i=await(Qu(s)?s:Promise.resolve(s));return Bw(r,i)}refine(e,n){const r=s=>typeof n=="string"||typeof n>"u"?{message:n}:typeof n=="function"?n(s):n;return this._refinement((s,i)=>{const a=e(s),o=()=>i.addIssue({code:W.custom,...r(s)});return typeof Promise<"u"&&a instanceof Promise?a.then(c=>c?!0:(o(),!1)):a?!0:(o(),!1)})}refinement(e,n){return this._refinement((r,s)=>e(r)?!0:(s.addIssue(typeof n=="function"?n(r,s):n),!1))}_refinement(e){return new va({schema:this,typeName:D.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:n=>this["~validate"](n)}}optional(){return Ls.create(this,this._def)}nullable(){return Ea.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return wa.create(this)}promise(){return sl.create(this,this._def)}or(e){return nl.create([this,e],this._def)}and(e){return rl.create(this,e,this._def)}transform(e){return new va({...De(this._def),schema:this,typeName:D.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const n=typeof e=="function"?e:()=>e;return new _p({...De(this._def),innerType:this,defaultValue:n,typeName:D.ZodDefault})}brand(){return new PP({typeName:D.ZodBranded,type:this,...De(this._def)})}catch(e){const n=typeof e=="function"?e:()=>e;return new wp({...De(this._def),innerType:this,catchValue:n,typeName:D.ZodCatch})}describe(e){const n=this.constructor;return new n({...this._def,description:e})}pipe(e){return og.create(this,e)}readonly(){return bp.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}};const hP=/^c[^\s-]{8,}$/i,fP=/^[0-9a-z]+$/,pP=/^[0-9A-HJKMNP-TV-Z]{26}$/i,mP=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,gP=/^[a-z0-9_-]{21}$/i,yP=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,_P=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,wP=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,bP="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let tf;const vP=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,EP=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,SP=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,xP=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,TP=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,AP=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,vS="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",CP=new RegExp(`^${vS}$`);function ES(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);const n=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${n}`}function kP(t){return new RegExp(`^${ES(t)}$`)}function IP(t){let e=`${vS}T${ES(t)}`;const n=[];return n.push(t.local?"Z?":"Z"),t.offset&&n.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${n.join("|")})`,new RegExp(`^${e}$`)}function RP(t,e){return!!((e==="v4"||!e)&&vP.test(t)||(e==="v6"||!e)&&SP.test(t))}function OP(t,e){if(!yP.test(t))return!1;try{const[n]=t.split(".");if(!n)return!1;const r=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),s=JSON.parse(atob(r));return!(typeof s!="object"||s===null||"typ"in s&&(s==null?void 0:s.typ)!=="JWT"||!s.alg||e&&s.alg!==e)}catch{return!1}}function $P(t,e){return!!((e==="v4"||!e)&&EP.test(t)||(e==="v6"||!e)&&xP.test(t))}class $s extends Ve{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==le.string){const i=this._getOrReturnCtx(e);return ee(i,{code:W.invalid_type,expected:le.string,received:i.parsedType}),Re}const r=new Vn;let s;for(const i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(s=this._getOrReturnCtx(e,s),ee(s,{code:W.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),r.dirty());else if(i.kind==="max")e.data.length>i.value&&(s=this._getOrReturnCtx(e,s),ee(s,{code:W.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),r.dirty());else if(i.kind==="length"){const a=e.data.length>i.value,o=e.data.length<i.value;(a||o)&&(s=this._getOrReturnCtx(e,s),a?ee(s,{code:W.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&ee(s,{code:W.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),r.dirty())}else if(i.kind==="email")wP.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"email",code:W.invalid_string,message:i.message}),r.dirty());else if(i.kind==="emoji")tf||(tf=new RegExp(bP,"u")),tf.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"emoji",code:W.invalid_string,message:i.message}),r.dirty());else if(i.kind==="uuid")mP.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"uuid",code:W.invalid_string,message:i.message}),r.dirty());else if(i.kind==="nanoid")gP.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"nanoid",code:W.invalid_string,message:i.message}),r.dirty());else if(i.kind==="cuid")hP.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"cuid",code:W.invalid_string,message:i.message}),r.dirty());else if(i.kind==="cuid2")fP.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"cuid2",code:W.invalid_string,message:i.message}),r.dirty());else if(i.kind==="ulid")pP.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"ulid",code:W.invalid_string,message:i.message}),r.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),ee(s,{validation:"url",code:W.invalid_string,message:i.message}),r.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"regex",code:W.invalid_string,message:i.message}),r.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(s=this._getOrReturnCtx(e,s),ee(s,{code:W.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),r.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(s=this._getOrReturnCtx(e,s),ee(s,{code:W.invalid_string,validation:{startsWith:i.value},message:i.message}),r.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(s=this._getOrReturnCtx(e,s),ee(s,{code:W.invalid_string,validation:{endsWith:i.value},message:i.message}),r.dirty()):i.kind==="datetime"?IP(i).test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{code:W.invalid_string,validation:"datetime",message:i.message}),r.dirty()):i.kind==="date"?CP.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{code:W.invalid_string,validation:"date",message:i.message}),r.dirty()):i.kind==="time"?kP(i).test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{code:W.invalid_string,validation:"time",message:i.message}),r.dirty()):i.kind==="duration"?_P.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"duration",code:W.invalid_string,message:i.message}),r.dirty()):i.kind==="ip"?RP(e.data,i.version)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"ip",code:W.invalid_string,message:i.message}),r.dirty()):i.kind==="jwt"?OP(e.data,i.alg)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"jwt",code:W.invalid_string,message:i.message}),r.dirty()):i.kind==="cidr"?$P(e.data,i.version)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"cidr",code:W.invalid_string,message:i.message}),r.dirty()):i.kind==="base64"?TP.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"base64",code:W.invalid_string,message:i.message}),r.dirty()):i.kind==="base64url"?AP.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"base64url",code:W.invalid_string,message:i.message}),r.dirty()):He.assertNever(i);return{status:r.value,value:e.data}}_regex(e,n,r){return this.refinement(s=>e.test(s),{validation:n,code:W.invalid_string,...he.errToObj(r)})}_addCheck(e){return new $s({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...he.errToObj(e)})}url(e){return this._addCheck({kind:"url",...he.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...he.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...he.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...he.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...he.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...he.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...he.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...he.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...he.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...he.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...he.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...he.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...he.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...he.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...he.errToObj(e)})}regex(e,n){return this._addCheck({kind:"regex",regex:e,...he.errToObj(n)})}includes(e,n){return this._addCheck({kind:"includes",value:e,position:n==null?void 0:n.position,...he.errToObj(n==null?void 0:n.message)})}startsWith(e,n){return this._addCheck({kind:"startsWith",value:e,...he.errToObj(n)})}endsWith(e,n){return this._addCheck({kind:"endsWith",value:e,...he.errToObj(n)})}min(e,n){return this._addCheck({kind:"min",value:e,...he.errToObj(n)})}max(e,n){return this._addCheck({kind:"max",value:e,...he.errToObj(n)})}length(e,n){return this._addCheck({kind:"length",value:e,...he.errToObj(n)})}nonempty(e){return this.min(1,he.errToObj(e))}trim(){return new $s({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new $s({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new $s({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxLength(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}}$s.create=t=>new $s({checks:[],typeName:D.ZodString,coerce:(t==null?void 0:t.coerce)??!1,...De(t)});function NP(t,e){const n=(t.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=n>r?n:r,i=Number.parseInt(t.toFixed(s).replace(".","")),a=Number.parseInt(e.toFixed(s).replace(".",""));return i%a/10**s}class Lo extends Ve{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==le.number){const i=this._getOrReturnCtx(e);return ee(i,{code:W.invalid_type,expected:le.number,received:i.parsedType}),Re}let r;const s=new Vn;for(const i of this._def.checks)i.kind==="int"?He.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),ee(r,{code:W.invalid_type,expected:"integer",received:"float",message:i.message}),s.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(r=this._getOrReturnCtx(e,r),ee(r,{code:W.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(r=this._getOrReturnCtx(e,r),ee(r,{code:W.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="multipleOf"?NP(e.data,i.value)!==0&&(r=this._getOrReturnCtx(e,r),ee(r,{code:W.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),ee(r,{code:W.not_finite,message:i.message}),s.dirty()):He.assertNever(i);return{status:s.value,value:e.data}}gte(e,n){return this.setLimit("min",e,!0,he.toString(n))}gt(e,n){return this.setLimit("min",e,!1,he.toString(n))}lte(e,n){return this.setLimit("max",e,!0,he.toString(n))}lt(e,n){return this.setLimit("max",e,!1,he.toString(n))}setLimit(e,n,r,s){return new Lo({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:r,message:he.toString(s)}]})}_addCheck(e){return new Lo({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:he.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:he.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:he.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:he.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:he.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:he.toString(n)})}finite(e){return this._addCheck({kind:"finite",message:he.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:he.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:he.toString(e)})}get minValue(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&He.isInteger(e.value))}get isFinite(){let e=null,n=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(n===null||r.value>n)&&(n=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(n)&&Number.isFinite(e)}}Lo.create=t=>new Lo({checks:[],typeName:D.ZodNumber,coerce:(t==null?void 0:t.coerce)||!1,...De(t)});class Mo extends Ve{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==le.bigint)return this._getInvalidInput(e);let r;const s=new Vn;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(r=this._getOrReturnCtx(e,r),ee(r,{code:W.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(r=this._getOrReturnCtx(e,r),ee(r,{code:W.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),ee(r,{code:W.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):He.assertNever(i);return{status:s.value,value:e.data}}_getInvalidInput(e){const n=this._getOrReturnCtx(e);return ee(n,{code:W.invalid_type,expected:le.bigint,received:n.parsedType}),Re}gte(e,n){return this.setLimit("min",e,!0,he.toString(n))}gt(e,n){return this.setLimit("min",e,!1,he.toString(n))}lte(e,n){return this.setLimit("max",e,!0,he.toString(n))}lt(e,n){return this.setLimit("max",e,!1,he.toString(n))}setLimit(e,n,r,s){return new Mo({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:r,message:he.toString(s)}]})}_addCheck(e){return new Mo({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:he.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:he.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:he.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:he.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:he.toString(n)})}get minValue(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}}Mo.create=t=>new Mo({checks:[],typeName:D.ZodBigInt,coerce:(t==null?void 0:t.coerce)??!1,...De(t)});class gp extends Ve{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==le.boolean){const r=this._getOrReturnCtx(e);return ee(r,{code:W.invalid_type,expected:le.boolean,received:r.parsedType}),Re}return or(e.data)}}gp.create=t=>new gp({typeName:D.ZodBoolean,coerce:(t==null?void 0:t.coerce)||!1,...De(t)});class el extends Ve{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==le.date){const i=this._getOrReturnCtx(e);return ee(i,{code:W.invalid_type,expected:le.date,received:i.parsedType}),Re}if(Number.isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return ee(i,{code:W.invalid_date}),Re}const r=new Vn;let s;for(const i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(s=this._getOrReturnCtx(e,s),ee(s,{code:W.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),r.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(s=this._getOrReturnCtx(e,s),ee(s,{code:W.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),r.dirty()):He.assertNever(i);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new el({...this._def,checks:[...this._def.checks,e]})}min(e,n){return this._addCheck({kind:"min",value:e.getTime(),message:he.toString(n)})}max(e,n){return this._addCheck({kind:"max",value:e.getTime(),message:he.toString(n)})}get minDate(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e!=null?new Date(e):null}}el.create=t=>new el({checks:[],coerce:(t==null?void 0:t.coerce)||!1,typeName:D.ZodDate,...De(t)});class jw extends Ve{_parse(e){if(this._getType(e)!==le.symbol){const r=this._getOrReturnCtx(e);return ee(r,{code:W.invalid_type,expected:le.symbol,received:r.parsedType}),Re}return or(e.data)}}jw.create=t=>new jw({typeName:D.ZodSymbol,...De(t)});class Fw extends Ve{_parse(e){if(this._getType(e)!==le.undefined){const r=this._getOrReturnCtx(e);return ee(r,{code:W.invalid_type,expected:le.undefined,received:r.parsedType}),Re}return or(e.data)}}Fw.create=t=>new Fw({typeName:D.ZodUndefined,...De(t)});class zw extends Ve{_parse(e){if(this._getType(e)!==le.null){const r=this._getOrReturnCtx(e);return ee(r,{code:W.invalid_type,expected:le.null,received:r.parsedType}),Re}return or(e.data)}}zw.create=t=>new zw({typeName:D.ZodNull,...De(t)});let tl=class extends Ve{constructor(){super(...arguments),this._any=!0}_parse(e){return or(e.data)}};tl.create=t=>new tl({typeName:D.ZodAny,...De(t)});class Vw extends Ve{constructor(){super(...arguments),this._unknown=!0}_parse(e){return or(e.data)}}Vw.create=t=>new Vw({typeName:D.ZodUnknown,...De(t)});class qs extends Ve{_parse(e){const n=this._getOrReturnCtx(e);return ee(n,{code:W.invalid_type,expected:le.never,received:n.parsedType}),Re}}qs.create=t=>new qs({typeName:D.ZodNever,...De(t)});class qw extends Ve{_parse(e){if(this._getType(e)!==le.undefined){const r=this._getOrReturnCtx(e);return ee(r,{code:W.invalid_type,expected:le.void,received:r.parsedType}),Re}return or(e.data)}}qw.create=t=>new qw({typeName:D.ZodVoid,...De(t)});let wa=class gu extends Ve{_parse(e){const{ctx:n,status:r}=this._processInputParams(e),s=this._def;if(n.parsedType!==le.array)return ee(n,{code:W.invalid_type,expected:le.array,received:n.parsedType}),Re;if(s.exactLength!==null){const a=n.data.length>s.exactLength.value,o=n.data.length<s.exactLength.value;(a||o)&&(ee(n,{code:a?W.too_big:W.too_small,minimum:o?s.exactLength.value:void 0,maximum:a?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),r.dirty())}if(s.minLength!==null&&n.data.length<s.minLength.value&&(ee(n,{code:W.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),r.dirty()),s.maxLength!==null&&n.data.length>s.maxLength.value&&(ee(n,{code:W.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),r.dirty()),n.common.async)return Promise.all([...n.data].map((a,o)=>s.type._parseAsync(new Vs(n,a,n.path,o)))).then(a=>Vn.mergeArray(r,a));const i=[...n.data].map((a,o)=>s.type._parseSync(new Vs(n,a,n.path,o)));return Vn.mergeArray(r,i)}get element(){return this._def.type}min(e,n){return new gu({...this._def,minLength:{value:e,message:he.toString(n)}})}max(e,n){return new gu({...this._def,maxLength:{value:e,message:he.toString(n)}})}length(e,n){return new gu({...this._def,exactLength:{value:e,message:he.toString(n)}})}nonempty(e){return this.min(1,e)}};wa.create=(t,e)=>new wa({type:t,minLength:null,maxLength:null,exactLength:null,typeName:D.ZodArray,...De(e)});function Ki(t){if(t instanceof _t){const e={};for(const n in t.shape){const r=t.shape[n];e[n]=Ls.create(Ki(r))}return new _t({...t._def,shape:()=>e})}else return t instanceof wa?new wa({...t._def,type:Ki(t.element)}):t instanceof Ls?Ls.create(Ki(t.unwrap())):t instanceof Ea?Ea.create(Ki(t.unwrap())):t instanceof Ti?Ti.create(t.items.map(e=>Ki(e))):t}class _t extends Ve{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),n=He.objectKeys(e);return this._cached={shape:e,keys:n},this._cached}_parse(e){if(this._getType(e)!==le.object){const u=this._getOrReturnCtx(e);return ee(u,{code:W.invalid_type,expected:le.object,received:u.parsedType}),Re}const{status:r,ctx:s}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof qs&&this._def.unknownKeys==="strip"))for(const u in s.data)a.includes(u)||o.push(u);const c=[];for(const u of a){const l=i[u],d=s.data[u];c.push({key:{status:"valid",value:u},value:l._parse(new Vs(s,d,s.path,u)),alwaysSet:u in s.data})}if(this._def.catchall instanceof qs){const u=this._def.unknownKeys;if(u==="passthrough")for(const l of o)c.push({key:{status:"valid",value:l},value:{status:"valid",value:s.data[l]}});else if(u==="strict")o.length>0&&(ee(s,{code:W.unrecognized_keys,keys:o}),r.dirty());else if(u!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const u=this._def.catchall;for(const l of o){const d=s.data[l];c.push({key:{status:"valid",value:l},value:u._parse(new Vs(s,d,s.path,l)),alwaysSet:l in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const u=[];for(const l of c){const d=await l.key,h=await l.value;u.push({key:d,value:h,alwaysSet:l.alwaysSet})}return u}).then(u=>Vn.mergeObjectSync(r,u)):Vn.mergeObjectSync(r,c)}get shape(){return this._def.shape()}strict(e){return he.errToObj,new _t({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(n,r)=>{var i,a;const s=((a=(i=this._def).errorMap)==null?void 0:a.call(i,n,r).message)??r.defaultError;return n.code==="unrecognized_keys"?{message:he.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new _t({...this._def,unknownKeys:"strip"})}passthrough(){return new _t({...this._def,unknownKeys:"passthrough"})}extend(e){return new _t({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new _t({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:D.ZodObject})}setKey(e,n){return this.augment({[e]:n})}catchall(e){return new _t({...this._def,catchall:e})}pick(e){const n={};for(const r of He.objectKeys(e))e[r]&&this.shape[r]&&(n[r]=this.shape[r]);return new _t({...this._def,shape:()=>n})}omit(e){const n={};for(const r of He.objectKeys(this.shape))e[r]||(n[r]=this.shape[r]);return new _t({...this._def,shape:()=>n})}deepPartial(){return Ki(this)}partial(e){const n={};for(const r of He.objectKeys(this.shape)){const s=this.shape[r];e&&!e[r]?n[r]=s:n[r]=s.optional()}return new _t({...this._def,shape:()=>n})}required(e){const n={};for(const r of He.objectKeys(this.shape))if(e&&!e[r])n[r]=this.shape[r];else{let i=this.shape[r];for(;i instanceof Ls;)i=i._def.innerType;n[r]=i}return new _t({...this._def,shape:()=>n})}keyof(){return SS(He.objectKeys(this.shape))}}_t.create=(t,e)=>new _t({shape:()=>t,unknownKeys:"strip",catchall:qs.create(),typeName:D.ZodObject,...De(e)});_t.strictCreate=(t,e)=>new _t({shape:()=>t,unknownKeys:"strict",catchall:qs.create(),typeName:D.ZodObject,...De(e)});_t.lazycreate=(t,e)=>new _t({shape:t,unknownKeys:"strip",catchall:qs.create(),typeName:D.ZodObject,...De(e)});let nl=class extends Ve{_parse(e){const{ctx:n}=this._processInputParams(e),r=this._def.options;function s(i){for(const o of i)if(o.result.status==="valid")return o.result;for(const o of i)if(o.result.status==="dirty")return n.common.issues.push(...o.ctx.common.issues),o.result;const a=i.map(o=>new ps(o.ctx.common.issues));return ee(n,{code:W.invalid_union,unionErrors:a}),Re}if(n.common.async)return Promise.all(r.map(async i=>{const a={...n,common:{...n.common,issues:[]},parent:null};return{result:await i._parseAsync({data:n.data,path:n.path,parent:a}),ctx:a}})).then(s);{let i;const a=[];for(const c of r){const u={...n,common:{...n.common,issues:[]},parent:null},l=c._parseSync({data:n.data,path:n.path,parent:u});if(l.status==="valid")return l;l.status==="dirty"&&!i&&(i={result:l,ctx:u}),u.common.issues.length&&a.push(u.common.issues)}if(i)return n.common.issues.push(...i.ctx.common.issues),i.result;const o=a.map(c=>new ps(c));return ee(n,{code:W.invalid_union,unionErrors:o}),Re}}get options(){return this._def.options}};nl.create=(t,e)=>new nl({options:t,typeName:D.ZodUnion,...De(e)});function yp(t,e){const n=ks(t),r=ks(e);if(t===e)return{valid:!0,data:t};if(n===le.object&&r===le.object){const s=He.objectKeys(e),i=He.objectKeys(t).filter(o=>s.indexOf(o)!==-1),a={...t,...e};for(const o of i){const c=yp(t[o],e[o]);if(!c.valid)return{valid:!1};a[o]=c.data}return{valid:!0,data:a}}else if(n===le.array&&r===le.array){if(t.length!==e.length)return{valid:!1};const s=[];for(let i=0;i<t.length;i++){const a=t[i],o=e[i],c=yp(a,o);if(!c.valid)return{valid:!1};s.push(c.data)}return{valid:!0,data:s}}else return n===le.date&&r===le.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}let rl=class extends Ve{_parse(e){const{status:n,ctx:r}=this._processInputParams(e),s=(i,a)=>{if(Dw(i)||Dw(a))return Re;const o=yp(i.value,a.value);return o.valid?((Uw(i)||Uw(a))&&n.dirty(),{status:n.value,value:o.data}):(ee(r,{code:W.invalid_intersection_types}),Re)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([i,a])=>s(i,a)):s(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}};rl.create=(t,e,n)=>new rl({left:t,right:e,typeName:D.ZodIntersection,...De(n)});class Ti extends Ve{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==le.array)return ee(r,{code:W.invalid_type,expected:le.array,received:r.parsedType}),Re;if(r.data.length<this._def.items.length)return ee(r,{code:W.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Re;!this._def.rest&&r.data.length>this._def.items.length&&(ee(r,{code:W.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),n.dirty());const i=[...r.data].map((a,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new Vs(r,a,r.path,o)):null}).filter(a=>!!a);return r.common.async?Promise.all(i).then(a=>Vn.mergeArray(n,a)):Vn.mergeArray(n,i)}get items(){return this._def.items}rest(e){return new Ti({...this._def,rest:e})}}Ti.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Ti({items:t,typeName:D.ZodTuple,rest:null,...De(e)})};class Hw extends Ve{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==le.map)return ee(r,{code:W.invalid_type,expected:le.map,received:r.parsedType}),Re;const s=this._def.keyType,i=this._def.valueType,a=[...r.data.entries()].map(([o,c],u)=>({key:s._parse(new Vs(r,o,r.path,[u,"key"])),value:i._parse(new Vs(r,c,r.path,[u,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of a){const u=await c.key,l=await c.value;if(u.status==="aborted"||l.status==="aborted")return Re;(u.status==="dirty"||l.status==="dirty")&&n.dirty(),o.set(u.value,l.value)}return{status:n.value,value:o}})}else{const o=new Map;for(const c of a){const u=c.key,l=c.value;if(u.status==="aborted"||l.status==="aborted")return Re;(u.status==="dirty"||l.status==="dirty")&&n.dirty(),o.set(u.value,l.value)}return{status:n.value,value:o}}}}Hw.create=(t,e,n)=>new Hw({valueType:e,keyType:t,typeName:D.ZodMap,...De(n)});class Do extends Ve{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==le.set)return ee(r,{code:W.invalid_type,expected:le.set,received:r.parsedType}),Re;const s=this._def;s.minSize!==null&&r.data.size<s.minSize.value&&(ee(r,{code:W.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),n.dirty()),s.maxSize!==null&&r.data.size>s.maxSize.value&&(ee(r,{code:W.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),n.dirty());const i=this._def.valueType;function a(c){const u=new Set;for(const l of c){if(l.status==="aborted")return Re;l.status==="dirty"&&n.dirty(),u.add(l.value)}return{status:n.value,value:u}}const o=[...r.data.values()].map((c,u)=>i._parse(new Vs(r,c,r.path,u)));return r.common.async?Promise.all(o).then(c=>a(c)):a(o)}min(e,n){return new Do({...this._def,minSize:{value:e,message:he.toString(n)}})}max(e,n){return new Do({...this._def,maxSize:{value:e,message:he.toString(n)}})}size(e,n){return this.min(e,n).max(e,n)}nonempty(e){return this.min(1,e)}}Do.create=(t,e)=>new Do({valueType:t,minSize:null,maxSize:null,typeName:D.ZodSet,...De(e)});class Gw extends Ve{get schema(){return this._def.getter()}_parse(e){const{ctx:n}=this._processInputParams(e);return this._def.getter()._parse({data:n.data,path:n.path,parent:n})}}Gw.create=(t,e)=>new Gw({getter:t,typeName:D.ZodLazy,...De(e)});class Ww extends Ve{_parse(e){if(e.data!==this._def.value){const n=this._getOrReturnCtx(e);return ee(n,{received:n.data,code:W.invalid_literal,expected:this._def.value}),Re}return{status:"valid",value:e.data}}get value(){return this._def.value}}Ww.create=(t,e)=>new Ww({value:t,typeName:D.ZodLiteral,...De(e)});function SS(t,e){return new ba({values:t,typeName:D.ZodEnum,...De(e)})}class ba extends Ve{_parse(e){if(typeof e.data!="string"){const n=this._getOrReturnCtx(e),r=this._def.values;return ee(n,{expected:He.joinValues(r),received:n.parsedType,code:W.invalid_type}),Re}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const n=this._getOrReturnCtx(e),r=this._def.values;return ee(n,{received:n.data,code:W.invalid_enum_value,options:r}),Re}return or(e.data)}get options(){return this._def.values}get enum(){const e={};for(const n of this._def.values)e[n]=n;return e}get Values(){const e={};for(const n of this._def.values)e[n]=n;return e}get Enum(){const e={};for(const n of this._def.values)e[n]=n;return e}extract(e,n=this._def){return ba.create(e,{...this._def,...n})}exclude(e,n=this._def){return ba.create(this.options.filter(r=>!e.includes(r)),{...this._def,...n})}}ba.create=SS;class Jw extends Ve{_parse(e){const n=He.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==le.string&&r.parsedType!==le.number){const s=He.objectValues(n);return ee(r,{expected:He.joinValues(s),received:r.parsedType,code:W.invalid_type}),Re}if(this._cache||(this._cache=new Set(He.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const s=He.objectValues(n);return ee(r,{received:r.data,code:W.invalid_enum_value,options:s}),Re}return or(e.data)}get enum(){return this._def.values}}Jw.create=(t,e)=>new Jw({values:t,typeName:D.ZodNativeEnum,...De(e)});class sl extends Ve{unwrap(){return this._def.type}_parse(e){const{ctx:n}=this._processInputParams(e);if(n.parsedType!==le.promise&&n.common.async===!1)return ee(n,{code:W.invalid_type,expected:le.promise,received:n.parsedType}),Re;const r=n.parsedType===le.promise?n.data:Promise.resolve(n.data);return or(r.then(s=>this._def.type.parseAsync(s,{path:n.path,errorMap:n.common.contextualErrorMap})))}}sl.create=(t,e)=>new sl({type:t,typeName:D.ZodPromise,...De(e)});class va extends Ve{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===D.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:n,ctx:r}=this._processInputParams(e),s=this._def.effect||null,i={addIssue:a=>{ee(r,a),a.fatal?n.abort():n.dirty()},get path(){return r.path}};if(i.addIssue=i.addIssue.bind(i),s.type==="preprocess"){const a=s.transform(r.data,i);if(r.common.async)return Promise.resolve(a).then(async o=>{if(n.value==="aborted")return Re;const c=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return c.status==="aborted"?Re:c.status==="dirty"||n.value==="dirty"?Za(c.value):c});{if(n.value==="aborted")return Re;const o=this._def.schema._parseSync({data:a,path:r.path,parent:r});return o.status==="aborted"?Re:o.status==="dirty"||n.value==="dirty"?Za(o.value):o}}if(s.type==="refinement"){const a=o=>{const c=s.refinement(o,i);if(r.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?Re:(o.status==="dirty"&&n.dirty(),a(o.value),{status:n.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?Re:(o.status==="dirty"&&n.dirty(),a(o.value).then(()=>({status:n.value,value:o.value}))))}if(s.type==="transform")if(r.common.async===!1){const a=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!_a(a))return Re;const o=s.transform(a.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:n.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(a=>_a(a)?Promise.resolve(s.transform(a.value,i)).then(o=>({status:n.value,value:o})):Re);He.assertNever(s)}}va.create=(t,e,n)=>new va({schema:t,typeName:D.ZodEffects,effect:e,...De(n)});va.createWithPreprocess=(t,e,n)=>new va({schema:e,effect:{type:"preprocess",transform:t},typeName:D.ZodEffects,...De(n)});let Ls=class extends Ve{_parse(e){return this._getType(e)===le.undefined?or(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Ls.create=(t,e)=>new Ls({innerType:t,typeName:D.ZodOptional,...De(e)});let Ea=class extends Ve{_parse(e){return this._getType(e)===le.null?or(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Ea.create=(t,e)=>new Ea({innerType:t,typeName:D.ZodNullable,...De(e)});let _p=class extends Ve{_parse(e){const{ctx:n}=this._processInputParams(e);let r=n.data;return n.parsedType===le.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:n.path,parent:n})}removeDefault(){return this._def.innerType}};_p.create=(t,e)=>new _p({innerType:t,typeName:D.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...De(e)});let wp=class extends Ve{_parse(e){const{ctx:n}=this._processInputParams(e),r={...n,common:{...n.common,issues:[]}},s=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Qu(s)?s.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new ps(r.common.issues)},input:r.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new ps(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}};wp.create=(t,e)=>new wp({innerType:t,typeName:D.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...De(e)});class Zw extends Ve{_parse(e){if(this._getType(e)!==le.nan){const r=this._getOrReturnCtx(e);return ee(r,{code:W.invalid_type,expected:le.nan,received:r.parsedType}),Re}return{status:"valid",value:e.data}}}Zw.create=t=>new Zw({typeName:D.ZodNaN,...De(t)});class PP extends Ve{_parse(e){const{ctx:n}=this._processInputParams(e),r=n.data;return this._def.type._parse({data:r,path:n.path,parent:n})}unwrap(){return this._def.type}}class og extends Ve{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return i.status==="aborted"?Re:i.status==="dirty"?(n.dirty(),Za(i.value)):this._def.out._parseAsync({data:i.value,path:r.path,parent:r})})();{const s=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?Re:s.status==="dirty"?(n.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:r.path,parent:r})}}static create(e,n){return new og({in:e,out:n,typeName:D.ZodPipeline})}}let bp=class extends Ve{_parse(e){const n=this._def.innerType._parse(e),r=s=>(_a(s)&&(s.value=Object.freeze(s.value)),s);return Qu(n)?n.then(s=>r(s)):r(n)}unwrap(){return this._def.innerType}};bp.create=(t,e)=>new bp({innerType:t,typeName:D.ZodReadonly,...De(e)});function LP(t,e={},n){return tl.create()}var D;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(D||(D={}));const rt=$s.create,xS=gp.create,Kw=tl.create;qs.create;const pi=wa.create,mn=_t.create;nl.create;rl.create;Ti.create;const vp=ba.create;sl.create;Ls.create;Ea.create;function MP(t,e){var r,s,i;const n={type:"array"};return(r=t.type)!=null&&r._def&&((i=(s=t.type)==null?void 0:s._def)==null?void 0:i.typeName)!==D.ZodAny&&(n.items=Ze(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&Xe(n,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&Xe(n,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(Xe(n,"minItems",t.exactLength.value,t.exactLength.message,e),Xe(n,"maxItems",t.exactLength.value,t.exactLength.message,e)),n}function DP(t,e){const n={type:"integer",format:"int64"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?Xe(n,"minimum",r.value,r.message,e):Xe(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),Xe(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?Xe(n,"maximum",r.value,r.message,e):Xe(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),Xe(n,"maximum",r.value,r.message,e));break;case"multipleOf":Xe(n,"multipleOf",r.value,r.message,e);break}return n}function UP(){return{type:"boolean"}}function TS(t,e){return Ze(t.type._def,e)}const BP=(t,e)=>Ze(t.innerType._def,e);function AS(t,e,n){const r=n??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(s=>AS(t,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return jP(t,e)}}const jP=(t,e)=>{const n={type:"integer",format:"unix-time"};if(e.target==="openApi3")return n;for(const r of t.checks)switch(r.kind){case"min":Xe(n,"minimum",r.value,r.message,e);break;case"max":Xe(n,"maximum",r.value,r.message,e);break}return n};function FP(t,e){return{...Ze(t.innerType._def,e),default:t.defaultValue()}}function zP(t,e){return e.effectStrategy==="input"?Ze(t.schema._def,e):zn(e)}function VP(t){return{type:"string",enum:Array.from(t.values)}}const qP=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function HP(t,e){const n=[Ze(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),Ze(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(i=>{if(qP(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(r=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;a=c}else r=void 0;s.push(a)}}),s.length?{allOf:s,...r}:void 0}function GP(t,e){const n=typeof t.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[t.value]}:{type:n==="bigint"?"integer":n,const:t.value}}let nf;const cr={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(nf===void 0&&(nf=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),nf),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function CS(t,e){const n={type:"string"};if(t.checks)for(const r of t.checks)switch(r.kind){case"min":Xe(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e);break;case"max":Xe(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":ur(n,"email",r.message,e);break;case"format:idn-email":ur(n,"idn-email",r.message,e);break;case"pattern:zod":an(n,cr.email,r.message,e);break}break;case"url":ur(n,"uri",r.message,e);break;case"uuid":ur(n,"uuid",r.message,e);break;case"regex":an(n,r.regex,r.message,e);break;case"cuid":an(n,cr.cuid,r.message,e);break;case"cuid2":an(n,cr.cuid2,r.message,e);break;case"startsWith":an(n,RegExp(`^${rf(r.value,e)}`),r.message,e);break;case"endsWith":an(n,RegExp(`${rf(r.value,e)}$`),r.message,e);break;case"datetime":ur(n,"date-time",r.message,e);break;case"date":ur(n,"date",r.message,e);break;case"time":ur(n,"time",r.message,e);break;case"duration":ur(n,"duration",r.message,e);break;case"length":Xe(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e),Xe(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"includes":an(n,RegExp(rf(r.value,e)),r.message,e);break;case"ip":r.version!=="v6"&&ur(n,"ipv4",r.message,e),r.version!=="v4"&&ur(n,"ipv6",r.message,e);break;case"base64url":an(n,cr.base64url,r.message,e);break;case"jwt":an(n,cr.jwt,r.message,e);break;case"cidr":r.version!=="v6"&&an(n,cr.ipv4Cidr,r.message,e),r.version!=="v4"&&an(n,cr.ipv6Cidr,r.message,e);break;case"emoji":an(n,cr.emoji(),r.message,e);break;case"ulid":an(n,cr.ulid,r.message,e);break;case"base64":switch(e.base64Strategy){case"format:binary":ur(n,"binary",r.message,e);break;case"contentEncoding:base64":Xe(n,"contentEncoding","base64",r.message,e);break;case"pattern:zod":an(n,cr.base64,r.message,e);break}break;case"nanoid":an(n,cr.nanoid,r.message,e);break}return n}function rf(t,e){return e.patternStrategy==="escape"?JP(t):t}const WP=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function JP(t){let e="";for(let n=0;n<t.length;n++)WP.has(t[n])||(e+="\\"),e+=t[n];return e}function ur(t,e,n,r){var s;t.format||(s=t.anyOf)!=null&&s.some(i=>i.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&r.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...n&&r.errorMessages&&{errorMessage:{format:n}}})):Xe(t,"format",e,n,r)}function an(t,e,n,r){var s;t.pattern||(s=t.allOf)!=null&&s.some(i=>i.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&r.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:Xw(e,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):Xe(t,"pattern",Xw(e,r),n,r)}function Xw(t,e){var c;if(!e.applyRegexFlags||!t.flags)return t.source;const n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},r=n.i?t.source.toLowerCase():t.source;let s="",i=!1,a=!1,o=!1;for(let u=0;u<r.length;u++){if(i){s+=r[u],i=!1;continue}if(n.i){if(a){if(r[u].match(/[a-z]/)){o?(s+=r[u],s+=`${r[u-2]}-${r[u]}`.toUpperCase(),o=!1):r[u+1]==="-"&&((c=r[u+2])!=null&&c.match(/[a-z]/))?(s+=r[u],o=!0):s+=`${r[u]}${r[u].toUpperCase()}`;continue}}else if(r[u].match(/[a-z]/)){s+=`[${r[u]}${r[u].toUpperCase()}]`;continue}}if(n.m){if(r[u]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(r[u]==="$"){s+=`($|(?=[\r
]))`;continue}}if(n.s&&r[u]==="."){s+=a?`${r[u]}\r
`:`[${r[u]}\r
]`;continue}s+=r[u],r[u]==="\\"?i=!0:a&&r[u]==="]"?a=!1:!a&&r[u]==="["&&(a=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s}function kS(t,e){var r,s,i,a,o,c;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=t.keyType)==null?void 0:r._def.typeName)===D.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((u,l)=>({...u,[l]:Ze(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",l]})??zn(e)}),{}),additionalProperties:e.rejectedAdditionalProperties};const n={type:"object",additionalProperties:Ze(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return n;if(((s=t.keyType)==null?void 0:s._def.typeName)===D.ZodString&&((i=t.keyType._def.checks)!=null&&i.length)){const{type:u,...l}=CS(t.keyType._def,e);return{...n,propertyNames:l}}else{if(((a=t.keyType)==null?void 0:a._def.typeName)===D.ZodEnum)return{...n,propertyNames:{enum:t.keyType._def.values}};if(((o=t.keyType)==null?void 0:o._def.typeName)===D.ZodBranded&&t.keyType._def.type._def.typeName===D.ZodString&&((c=t.keyType._def.type._def.checks)!=null&&c.length)){const{type:u,...l}=TS(t.keyType._def,e);return{...n,propertyNames:l}}}return n}function ZP(t,e){if(e.mapStrategy==="record")return kS(t,e);const n=Ze(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||zn(e),r=Ze(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||zn(e);return{type:"array",maxItems:125,items:{type:"array",items:[n,r],minItems:2,maxItems:2}}}function KP(t){const e=t.values,r=Object.keys(t.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(r.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function XP(t){return t.target==="openAi"?void 0:{not:zn({...t,currentPath:[...t.currentPath,"not"]})}}function YP(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const il={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function QP(t,e){if(e.target==="openApi3")return Yw(t,e);const n=t.options instanceof Map?Array.from(t.options.values()):t.options;if(n.every(r=>r._def.typeName in il&&(!r._def.checks||!r._def.checks.length))){const r=n.reduce((s,i)=>{const a=il[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:r.length>1?r:r[0]}}else if(n.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=n.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":return i._def.value===null?[...s,"null"]:s;case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===n.length){const s=r.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:n.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(n.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((r,s)=>[...r,...s._def.values.filter(i=>!r.includes(i))],[])};return Yw(t,e)}const Yw=(t,e)=>{const n=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((r,s)=>Ze(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return n.length?{anyOf:n}:void 0};function e2(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"?{type:il[t.innerType._def.typeName],nullable:!0}:{type:[il[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=Ze(t.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const n=Ze(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function t2(t,e){const n={type:"number"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"int":n.type="integer",bS(n,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?Xe(n,"minimum",r.value,r.message,e):Xe(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),Xe(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?Xe(n,"maximum",r.value,r.message,e):Xe(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),Xe(n,"maximum",r.value,r.message,e));break;case"multipleOf":Xe(n,"multipleOf",r.value,r.message,e);break}return n}function n2(t,e){const n=e.target==="openAi",r={type:"object",properties:{}},s=[],i=t.shape();for(const o in i){let c=i[o];if(c===void 0||c._def===void 0)continue;let u=s2(c);u&&n&&(c._def.typeName==="ZodOptional"&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),u=!1);const l=Ze(c._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});l!==void 0&&(r.properties[o]=l,u||s.push(o))}s.length&&(r.required=s);const a=r2(t,e);return a!==void 0&&(r.additionalProperties=a),r}function r2(t,e){if(t.catchall._def.typeName!=="ZodNever")return Ze(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(t.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function s2(t){try{return t.isOptional()}catch{return!0}}const i2=(t,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return Ze(t.innerType._def,e);const n=Ze(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return n?{anyOf:[{not:zn(e)},n]}:zn(e)},a2=(t,e)=>{if(e.pipeStrategy==="input")return Ze(t.in._def,e);if(e.pipeStrategy==="output")return Ze(t.out._def,e);const n=Ze(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=Ze(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,r].filter(s=>s!==void 0)}};function o2(t,e){return Ze(t.type._def,e)}function c2(t,e){const r={type:"array",uniqueItems:!0,items:Ze(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&Xe(r,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&Xe(r,"maxItems",t.maxSize.value,t.maxSize.message,e),r}function u2(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((n,r)=>Ze(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[]),additionalItems:Ze(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((n,r)=>Ze(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[])}}function l2(t){return{not:zn(t)}}function d2(t){return zn(t)}const h2=(t,e)=>Ze(t.innerType._def,e),f2=(t,e,n)=>{switch(e){case D.ZodString:return CS(t,n);case D.ZodNumber:return t2(t,n);case D.ZodObject:return n2(t,n);case D.ZodBigInt:return DP(t,n);case D.ZodBoolean:return UP();case D.ZodDate:return AS(t,n);case D.ZodUndefined:return l2(n);case D.ZodNull:return YP(n);case D.ZodArray:return MP(t,n);case D.ZodUnion:case D.ZodDiscriminatedUnion:return QP(t,n);case D.ZodIntersection:return HP(t,n);case D.ZodTuple:return u2(t,n);case D.ZodRecord:return kS(t,n);case D.ZodLiteral:return GP(t,n);case D.ZodEnum:return VP(t);case D.ZodNativeEnum:return KP(t);case D.ZodNullable:return e2(t,n);case D.ZodOptional:return i2(t,n);case D.ZodMap:return ZP(t,n);case D.ZodSet:return c2(t,n);case D.ZodLazy:return()=>t.getter()._def;case D.ZodPromise:return o2(t,n);case D.ZodNaN:case D.ZodNever:return XP(n);case D.ZodEffects:return zP(t,n);case D.ZodAny:return zn(n);case D.ZodUnknown:return d2(n);case D.ZodDefault:return FP(t,n);case D.ZodBranded:return TS(t,n);case D.ZodReadonly:return h2(t,n);case D.ZodCatch:return BP(t,n);case D.ZodPipeline:return a2(t,n);case D.ZodFunction:case D.ZodVoid:case D.ZodSymbol:return;default:return(r=>{})()}};function Ze(t,e,n=!1){var o;const r=e.seen.get(t);if(e.override){const c=(o=e.override)==null?void 0:o.call(e,t,e,r,n);if(c!==iP)return c}if(r&&!n){const c=p2(r,e);if(c!==void 0)return c}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const i=f2(t,t.typeName,e),a=typeof i=="function"?Ze(i(),e):i;if(a&&m2(t,e,a),e.postProcess){const c=e.postProcess(a,t,e);return s.jsonSchema=a,c}return s.jsonSchema=a,a}const p2=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"relative":return{$ref:wS(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((n,r)=>e.currentPath[r]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),zn(e)):e.$refStrategy==="seen"?zn(e):void 0}},m2=(t,e,n)=>(t.description&&(n.description=t.description,e.markdownDescription&&(n.markdownDescription=t.description)),n),g2=(t,e)=>{const n=cP(e);let r;const s=Ze(t._def,n,!1)??zn(n);n.flags.hasReferencedOpenAiAnyType&&(r||(r={}),r[n.openAiAnyTypeName]||(r[n.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:n.$refStrategy==="relative"?"1":[...n.basePath,n.definitionPath,n.openAiAnyTypeName].join("/")}}));const i=r?{...s,[n.definitionPath]:r}:s;return n.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(n.target==="jsonSchema2019-09"||n.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),n.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function mi(t,e){const n=typeof t;if(n!==typeof e)return!1;if(Array.isArray(t)){if(!Array.isArray(e))return!1;const r=t.length;if(r!==e.length)return!1;for(let s=0;s<r;s++)if(!mi(t[s],e[s]))return!1;return!0}if(n==="object"){if(!t||!e)return t===e;const r=Object.keys(t),s=Object.keys(e);if(r.length!==s.length)return!1;for(const a of r)if(!mi(t[a],e[a]))return!1;return!0}return t===e}function fr(t){return encodeURI(y2(t))}function y2(t){return t.replace(/~/g,"~0").replace(/\//g,"~1")}const _2={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},w2={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},b2={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let v2=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function Ns(t,e=Object.create(null),n=v2,r=""){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t.$id||t.id;if(i){const a=new URL(i,n.href);a.hash.length>1?e[a.href]=t:(a.hash="",r===""?n=a:Ns(t,e,n))}}else if(t!==!0&&t!==!1)return e;const s=n.href+(r?"#"+r:"");if(e[s]!==void 0)throw new Error(`Duplicate schema URI "${s}".`);if(e[s]=t,t===!0||t===!1)return e;if(t.__absolute_uri__===void 0&&Object.defineProperty(t,"__absolute_uri__",{enumerable:!1,value:s}),t.$ref&&t.__absolute_ref__===void 0){const i=new URL(t.$ref,n.href);i.hash=i.hash,Object.defineProperty(t,"__absolute_ref__",{enumerable:!1,value:i.href})}if(t.$recursiveRef&&t.__absolute_recursive_ref__===void 0){const i=new URL(t.$recursiveRef,n.href);i.hash=i.hash,Object.defineProperty(t,"__absolute_recursive_ref__",{enumerable:!1,value:i.href})}if(t.$anchor){const i=new URL("#"+t.$anchor,n.href);e[i.href]=t}for(let i in t){if(b2[i])continue;const a=`${r}/${fr(i)}`,o=t[i];if(Array.isArray(o)){if(_2[i]){const c=o.length;for(let u=0;u<c;u++)Ns(o[u],e,n,`${a}/${u}`)}}else if(w2[i])for(let c in o)Ns(o[c],e,n,`${a}/${fr(c)}`);else Ns(o,e,n,a)}return e}const E2=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,S2=[0,31,28,31,30,31,30,31,31,30,31,30,31],x2=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,T2=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,A2=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,C2=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,k2=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,I2=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,R2=/^(?:\/(?:[^~/]|~0|~1)*)*$/,O2=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,$2=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,N2=t=>{if(t[0]==='"')return!1;const[e,n,...r]=t.split("@");return!e||!n||r.length!==0||e.length>64||n.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(n)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:n.split(".").every(s=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(s))},P2=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,L2=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,M2=t=>t.length>1&&t.length<80&&(/^P\d+([.,]\d+)?W$/.test(t)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(t)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(t));function Cr(t){return t.test.bind(t)}const Qw={date:IS,time:RS.bind(void 0,!1),"date-time":B2,duration:M2,uri:z2,"uri-reference":Cr(A2),"uri-template":Cr(C2),url:Cr(k2),email:N2,hostname:Cr(T2),ipv4:Cr(P2),ipv6:Cr(L2),regex:q2,uuid:Cr(I2),"json-pointer":Cr(R2),"json-pointer-uri-fragment":Cr(O2),"relative-json-pointer":Cr($2)};function D2(t){return t%4===0&&(t%100!==0||t%400===0)}function IS(t){const e=t.match(E2);if(!e)return!1;const n=+e[1],r=+e[2],s=+e[3];return r>=1&&r<=12&&s>=1&&s<=(r==2&&D2(n)?29:S2[r])}function RS(t,e){const n=e.match(x2);if(!n)return!1;const r=+n[1],s=+n[2],i=+n[3],a=!!n[5];return(r<=23&&s<=59&&i<=59||r==23&&s==59&&i==60)&&(!t||a)}const U2=/t|\s/i;function B2(t){const e=t.split(U2);return e.length==2&&IS(e[0])&&RS(!0,e[1])}const j2=/\/|:/,F2=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function z2(t){return j2.test(t)&&F2.test(t)}const V2=/[^\\]\\Z/;function q2(t){if(V2.test(t))return!1;try{return new RegExp(t,"u"),!0}catch{return!1}}function H2(t){let e=0,n=t.length,r=0,s;for(;r<n;)e++,s=t.charCodeAt(r++),s>=55296&&s<=56319&&r<n&&(s=t.charCodeAt(r),(s&64512)==56320&&r++);return e}function it(t,e,n="2019-09",r=Ns(e),s=!0,i=null,a="#",o="#",c=Object.create(null)){if(e===!0)return{valid:!0,errors:[]};if(e===!1)return{valid:!1,errors:[{instanceLocation:a,keyword:"false",keywordLocation:a,error:"False boolean schema."}]};const u=typeof t;let l;switch(u){case"boolean":case"number":case"string":l=u;break;case"object":t===null?l="null":Array.isArray(t)?l="array":l="object";break;default:throw new Error(`Instances of "${u}" type are not supported.`)}const{$ref:d,$recursiveRef:h,$recursiveAnchor:f,type:m,const:g,enum:_,required:b,not:y,anyOf:E,allOf:C,oneOf:k,if:R,then:$,else:T,format:B,properties:z,patternProperties:q,additionalProperties:ie,unevaluatedProperties:me,minProperties:j,maxProperties:F,propertyNames:H,dependentRequired:re,dependentSchemas:ue,dependencies:ne,prefixItems:fe,items:Ce,additionalItems:J,unevaluatedItems:Q,contains:ae,minContains:Z,maxContains:A,minItems:S,maxItems:M,uniqueItems:N,minimum:ke,maximum:$e,exclusiveMinimum:We,exclusiveMaximum:nt,multipleOf:ot,minLength:Bt,maxLength:Ke,pattern:$t,__absolute_ref__:bs,__absolute_recursive_ref__:Di}=e,X=[];if(f===!0&&i===null&&(i=e),h==="#"){const Se=i===null?r[Di]:i,pe=`${o}/$recursiveRef`,Ee=it(t,i===null?e:i,n,r,s,Se,a,pe,c);Ee.valid||X.push({instanceLocation:a,keyword:"$recursiveRef",keywordLocation:pe,error:"A subschema had errors."},...Ee.errors)}if(d!==void 0){const pe=r[bs||d];if(pe===void 0){let K=`Unresolved $ref "${d}".`;throw bs&&bs!==d&&(K+=`  Absolute URI "${bs}".`),K+=`
Known schemas:
- ${Object.keys(r).join(`
- `)}`,new Error(K)}const Ee=`${o}/$ref`,Y=it(t,pe,n,r,s,i,a,Ee,c);if(Y.valid||X.push({instanceLocation:a,keyword:"$ref",keywordLocation:Ee,error:"A subschema had errors."},...Y.errors),n==="4"||n==="7")return{valid:X.length===0,errors:X}}if(Array.isArray(m)){let Se=m.length,pe=!1;for(let Ee=0;Ee<Se;Ee++)if(l===m[Ee]||m[Ee]==="integer"&&l==="number"&&t%1===0&&t===t){pe=!0;break}pe||X.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${m.join('", "')}".`})}else m==="integer"?(l!=="number"||t%1||t!==t)&&X.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${m}".`}):m!==void 0&&l!==m&&X.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${m}".`});if(g!==void 0&&(l==="object"||l==="array"?mi(t,g)||X.push({instanceLocation:a,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(g)}.`}):t!==g&&X.push({instanceLocation:a,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(g)}.`})),_!==void 0&&(l==="object"||l==="array"?_.some(Se=>mi(t,Se))||X.push({instanceLocation:a,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(_)}.`}):_.some(Se=>t===Se)||X.push({instanceLocation:a,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(_)}.`})),y!==void 0){const Se=`${o}/not`;it(t,y,n,r,s,i,a,Se).valid&&X.push({instanceLocation:a,keyword:"not",keywordLocation:Se,error:'Instance matched "not" schema.'})}let Xr=[];if(E!==void 0){const Se=`${o}/anyOf`,pe=X.length;let Ee=!1;for(let Y=0;Y<E.length;Y++){const K=E[Y],Te=Object.create(c),ye=it(t,K,n,r,s,f===!0?i:null,a,`${Se}/${Y}`,Te);X.push(...ye.errors),Ee=Ee||ye.valid,ye.valid&&Xr.push(Te)}Ee?X.length=pe:X.splice(pe,0,{instanceLocation:a,keyword:"anyOf",keywordLocation:Se,error:"Instance does not match any subschemas."})}if(C!==void 0){const Se=`${o}/allOf`,pe=X.length;let Ee=!0;for(let Y=0;Y<C.length;Y++){const K=C[Y],Te=Object.create(c),ye=it(t,K,n,r,s,f===!0?i:null,a,`${Se}/${Y}`,Te);X.push(...ye.errors),Ee=Ee&&ye.valid,ye.valid&&Xr.push(Te)}Ee?X.length=pe:X.splice(pe,0,{instanceLocation:a,keyword:"allOf",keywordLocation:Se,error:"Instance does not match every subschema."})}if(k!==void 0){const Se=`${o}/oneOf`,pe=X.length,Ee=k.filter((Y,K)=>{const Te=Object.create(c),ye=it(t,Y,n,r,s,f===!0?i:null,a,`${Se}/${K}`,Te);return X.push(...ye.errors),ye.valid&&Xr.push(Te),ye.valid}).length;Ee===1?X.length=pe:X.splice(pe,0,{instanceLocation:a,keyword:"oneOf",keywordLocation:Se,error:`Instance does not match exactly one subschema (${Ee} matches).`})}if((l==="object"||l==="array")&&Object.assign(c,...Xr),R!==void 0){const Se=`${o}/if`;if(it(t,R,n,r,s,i,a,Se,c).valid){if($!==void 0){const Ee=it(t,$,n,r,s,i,a,`${o}/then`,c);Ee.valid||X.push({instanceLocation:a,keyword:"if",keywordLocation:Se,error:'Instance does not match "then" schema.'},...Ee.errors)}}else if(T!==void 0){const Ee=it(t,T,n,r,s,i,a,`${o}/else`,c);Ee.valid||X.push({instanceLocation:a,keyword:"if",keywordLocation:Se,error:'Instance does not match "else" schema.'},...Ee.errors)}}if(l==="object"){if(b!==void 0)for(const Y of b)Y in t||X.push({instanceLocation:a,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${Y}".`});const Se=Object.keys(t);if(j!==void 0&&Se.length<j&&X.push({instanceLocation:a,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${j} properties.`}),F!==void 0&&Se.length>F&&X.push({instanceLocation:a,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${F} properties.`}),H!==void 0){const Y=`${o}/propertyNames`;for(const K in t){const Te=`${a}/${fr(K)}`,ye=it(K,H,n,r,s,i,Te,Y);ye.valid||X.push({instanceLocation:a,keyword:"propertyNames",keywordLocation:Y,error:`Property name "${K}" does not match schema.`},...ye.errors)}}if(re!==void 0){const Y=`${o}/dependantRequired`;for(const K in re)if(K in t){const Te=re[K];for(const ye of Te)ye in t||X.push({instanceLocation:a,keyword:"dependentRequired",keywordLocation:Y,error:`Instance has "${K}" but does not have "${ye}".`})}}if(ue!==void 0)for(const Y in ue){const K=`${o}/dependentSchemas`;if(Y in t){const Te=it(t,ue[Y],n,r,s,i,a,`${K}/${fr(Y)}`,c);Te.valid||X.push({instanceLocation:a,keyword:"dependentSchemas",keywordLocation:K,error:`Instance has "${Y}" but does not match dependant schema.`},...Te.errors)}}if(ne!==void 0){const Y=`${o}/dependencies`;for(const K in ne)if(K in t){const Te=ne[K];if(Array.isArray(Te))for(const ye of Te)ye in t||X.push({instanceLocation:a,keyword:"dependencies",keywordLocation:Y,error:`Instance has "${K}" but does not have "${ye}".`});else{const ye=it(t,Te,n,r,s,i,a,`${Y}/${fr(K)}`);ye.valid||X.push({instanceLocation:a,keyword:"dependencies",keywordLocation:Y,error:`Instance has "${K}" but does not match dependant schema.`},...ye.errors)}}}const pe=Object.create(null);let Ee=!1;if(z!==void 0){const Y=`${o}/properties`;for(const K in z){if(!(K in t))continue;const Te=`${a}/${fr(K)}`,ye=it(t[K],z[K],n,r,s,i,Te,`${Y}/${fr(K)}`);if(ye.valid)c[K]=pe[K]=!0;else if(Ee=s,X.push({instanceLocation:a,keyword:"properties",keywordLocation:Y,error:`Property "${K}" does not match schema.`},...ye.errors),Ee)break}}if(!Ee&&q!==void 0){const Y=`${o}/patternProperties`;for(const K in q){const Te=new RegExp(K,"u"),ye=q[K];for(const Qt in t){if(!Te.test(Qt))continue;const x=`${a}/${fr(Qt)}`,w=it(t[Qt],ye,n,r,s,i,x,`${Y}/${fr(K)}`);w.valid?c[Qt]=pe[Qt]=!0:(Ee=s,X.push({instanceLocation:a,keyword:"patternProperties",keywordLocation:Y,error:`Property "${Qt}" matches pattern "${K}" but does not match associated schema.`},...w.errors))}}}if(!Ee&&ie!==void 0){const Y=`${o}/additionalProperties`;for(const K in t){if(pe[K])continue;const Te=`${a}/${fr(K)}`,ye=it(t[K],ie,n,r,s,i,Te,Y);ye.valid?c[K]=!0:(Ee=s,X.push({instanceLocation:a,keyword:"additionalProperties",keywordLocation:Y,error:`Property "${K}" does not match additional properties schema.`},...ye.errors))}}else if(!Ee&&me!==void 0){const Y=`${o}/unevaluatedProperties`;for(const K in t)if(!c[K]){const Te=`${a}/${fr(K)}`,ye=it(t[K],me,n,r,s,i,Te,Y);ye.valid?c[K]=!0:X.push({instanceLocation:a,keyword:"unevaluatedProperties",keywordLocation:Y,error:`Property "${K}" does not match unevaluated properties schema.`},...ye.errors)}}}else if(l==="array"){M!==void 0&&t.length>M&&X.push({instanceLocation:a,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${t.length} > ${M}).`}),S!==void 0&&t.length<S&&X.push({instanceLocation:a,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${t.length} < ${S}).`});const Se=t.length;let pe=0,Ee=!1;if(fe!==void 0){const Y=`${o}/prefixItems`,K=Math.min(fe.length,Se);for(;pe<K;pe++){const Te=it(t[pe],fe[pe],n,r,s,i,`${a}/${pe}`,`${Y}/${pe}`);if(c[pe]=!0,!Te.valid&&(Ee=s,X.push({instanceLocation:a,keyword:"prefixItems",keywordLocation:Y,error:"Items did not match schema."},...Te.errors),Ee))break}}if(Ce!==void 0){const Y=`${o}/items`;if(Array.isArray(Ce)){const K=Math.min(Ce.length,Se);for(;pe<K;pe++){const Te=it(t[pe],Ce[pe],n,r,s,i,`${a}/${pe}`,`${Y}/${pe}`);if(c[pe]=!0,!Te.valid&&(Ee=s,X.push({instanceLocation:a,keyword:"items",keywordLocation:Y,error:"Items did not match schema."},...Te.errors),Ee))break}}else for(;pe<Se;pe++){const K=it(t[pe],Ce,n,r,s,i,`${a}/${pe}`,Y);if(c[pe]=!0,!K.valid&&(Ee=s,X.push({instanceLocation:a,keyword:"items",keywordLocation:Y,error:"Items did not match schema."},...K.errors),Ee))break}if(!Ee&&J!==void 0){const K=`${o}/additionalItems`;for(;pe<Se;pe++){const Te=it(t[pe],J,n,r,s,i,`${a}/${pe}`,K);c[pe]=!0,Te.valid||(Ee=s,X.push({instanceLocation:a,keyword:"additionalItems",keywordLocation:K,error:"Items did not match additional items schema."},...Te.errors))}}}if(ae!==void 0)if(Se===0&&Z===void 0)X.push({instanceLocation:a,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(Z!==void 0&&Se<Z)X.push({instanceLocation:a,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${Se}) than minContains (${Z}).`});else{const Y=`${o}/contains`,K=X.length;let Te=0;for(let ye=0;ye<Se;ye++){const Qt=it(t[ye],ae,n,r,s,i,`${a}/${ye}`,Y);Qt.valid?(c[ye]=!0,Te++):X.push(...Qt.errors)}Te>=(Z||0)&&(X.length=K),Z===void 0&&A===void 0&&Te===0?X.splice(K,0,{instanceLocation:a,keyword:"contains",keywordLocation:Y,error:"Array does not contain item matching schema."}):Z!==void 0&&Te<Z?X.push({instanceLocation:a,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${Z} items matching schema. Only ${Te} items were found.`}):A!==void 0&&Te>A&&X.push({instanceLocation:a,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${A} items matching schema. ${Te} items were found.`})}if(!Ee&&Q!==void 0){const Y=`${o}/unevaluatedItems`;for(pe;pe<Se;pe++){if(c[pe])continue;const K=it(t[pe],Q,n,r,s,i,`${a}/${pe}`,Y);c[pe]=!0,K.valid||X.push({instanceLocation:a,keyword:"unevaluatedItems",keywordLocation:Y,error:"Items did not match unevaluated items schema."},...K.errors)}}if(N)for(let Y=0;Y<Se;Y++){const K=t[Y],Te=typeof K=="object"&&K!==null;for(let ye=0;ye<Se;ye++){if(Y===ye)continue;const Qt=t[ye];(K===Qt||Te&&(typeof Qt=="object"&&Qt!==null)&&mi(K,Qt))&&(X.push({instanceLocation:a,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${Y} and ${ye}.`}),Y=Number.MAX_SAFE_INTEGER,ye=Number.MAX_SAFE_INTEGER)}}}else if(l==="number"){if(n==="4"?(ke!==void 0&&(We===!0&&t<=ke||t<ke)&&X.push({instanceLocation:a,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${t} is less than ${We?"or equal to ":""} ${ke}.`}),$e!==void 0&&(nt===!0&&t>=$e||t>$e)&&X.push({instanceLocation:a,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${t} is greater than ${nt?"or equal to ":""} ${$e}.`})):(ke!==void 0&&t<ke&&X.push({instanceLocation:a,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${t} is less than ${ke}.`}),$e!==void 0&&t>$e&&X.push({instanceLocation:a,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${t} is greater than ${$e}.`}),We!==void 0&&t<=We&&X.push({instanceLocation:a,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${t} is less than ${We}.`}),nt!==void 0&&t>=nt&&X.push({instanceLocation:a,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${t} is greater than or equal to ${nt}.`})),ot!==void 0){const Se=t%ot;Math.abs(0-Se)>=11920929e-14&&Math.abs(ot-Se)>=11920929e-14&&X.push({instanceLocation:a,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${t} is not a multiple of ${ot}.`})}}else if(l==="string"){const Se=Bt===void 0&&Ke===void 0?0:H2(t);Bt!==void 0&&Se<Bt&&X.push({instanceLocation:a,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${Se} < ${Bt}).`}),Ke!==void 0&&Se>Ke&&X.push({instanceLocation:a,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${Se} > ${Ke}).`}),$t!==void 0&&!new RegExp($t,"u").test(t)&&X.push({instanceLocation:a,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),B!==void 0&&Qw[B]&&!Qw[B](t)&&X.push({instanceLocation:a,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${B}".`})}return{valid:X.length===0,errors:X}}class G2{constructor(e,n="2019-09",r=!0){p(this,"schema");p(this,"draft");p(this,"shortCircuit");p(this,"lookup");this.schema=e,this.draft=n,this.shortCircuit=r,this.lookup=Ns(e)}validate(e){return it(e,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(e,n){n&&(e={...e,$id:n}),Ns(e,this.lookup)}}var OS={};ve(OS,{Validator:()=>G2,deepCompareStrict:()=>mi,toJsonSchema:()=>nn,validatesOnlyStrings:()=>go});function nn(t){if(ft(t)){const e=ia(t,!0);if(qr(e)){const n=Yu(e,!0);return Xu(n)}else return Xu(t)}return gt(t)?g2(t):t}function go(t){if(!t||typeof t!="object"||Object.keys(t).length===0||Array.isArray(t))return!1;if("type"in t)return typeof t.type=="string"?t.type==="string":Array.isArray(t.type)?t.type.every(e=>e==="string"):!1;if("enum"in t)return Array.isArray(t.enum)&&t.enum.length>0&&t.enum.every(e=>typeof e=="string");if("const"in t)return typeof t.const=="string";if("allOf"in t&&Array.isArray(t.allOf))return t.allOf.some(e=>go(e));if("anyOf"in t&&Array.isArray(t.anyOf)||"oneOf"in t&&Array.isArray(t.oneOf)){const e="anyOf"in t?t.anyOf:t.oneOf;return e.length>0&&e.every(n=>go(n))}if("not"in t)return!1;if("$ref"in t&&typeof t.$ref=="string"){const e=t.$ref,n=Ns(t);return n[e]?go(n[e]):!1}return!1}function cg(t){return t?t.lc_runnable:!1}var W2=class{constructor(t){p(this,"includeNames");p(this,"includeTypes");p(this,"includeTags");p(this,"excludeNames");p(this,"excludeTypes");p(this,"excludeTags");this.includeNames=t.includeNames,this.includeTypes=t.includeTypes,this.includeTags=t.includeTags,this.excludeNames=t.excludeNames,this.excludeTypes=t.excludeTypes,this.excludeTags=t.excludeTags}includeEvent(t,e){let n=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const r=t.tags??[];return this.includeNames!==void 0&&(n=n||this.includeNames.includes(t.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e)),this.includeTags!==void 0&&(n=n||r.some(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(t.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e)),this.excludeTags!==void 0&&(n=n&&r.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),n}};function sf(t){return t.replace(/[^a-zA-Z-_0-9]/g,"_")}const J2=["*","_","`"];function Z2(t){let e="";for(const[n,r]of Object.entries(t))e+=`	classDef ${n} ${r};
`;return e}function K2(t,e,n){const{firstNode:r,lastNode:s,nodeColors:i,withStyles:a=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=n??{};let u=a?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(a){const f="default",m={[f]:"{0}({1})"};r!==void 0&&(m[r]="{0}([{1}]):::first"),s!==void 0&&(m[s]="{0}([{1}]):::last");for(const[g,_]of Object.entries(t)){const b=_.name.split(":").pop()??"";let E=J2.some(k=>b.startsWith(k)&&b.endsWith(k))?`<p>${b}</p>`:b;Object.keys(_.metadata??{}).length&&(E+=`<hr/><small><em>${Object.entries(_.metadata??{}).map(([k,R])=>`${k} = ${R}`).join(`
`)}</em></small>`);const C=(m[g]??m[f]).replace("{0}",sf(g)).replace("{1}",E);u+=`	${C}
`}}const l={};for(const f of e){const m=f.source.split(":"),g=f.target.split(":"),_=m.filter((b,y)=>b===g[y]).join(":");l[_]||(l[_]=[]),l[_].push(f)}const d=new Set;function h(f,m){const g=f.length===1&&f[0].source===f[0].target;if(m&&!g){const _=m.split(":").pop();if(d.has(_))throw new Error(`Found duplicate subgraph '${_}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(_),u+=`	subgraph ${_}
`}for(const _ of f){const{source:b,target:y,data:E,conditional:C}=_;let k="";if(E!==void 0){let R=E;const $=R.split(" ");$.length>c&&(R=Array.from({length:Math.ceil($.length/c)},(T,B)=>$.slice(B*c,(B+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),k=C?` -. &nbsp;${R}&nbsp; .-> `:` -- &nbsp;${R}&nbsp; --> `}else k=C?" -.-> ":" --> ";u+=`	${sf(b)}${k}${sf(y)};
`}for(const _ in l)_.startsWith(`${m}:`)&&_!==m&&h(l[_],_);m&&!g&&(u+=`	end
`)}h(l[""]??[],"");for(const f in l)!f.includes(":")&&f!==""&&h(l[f],f);return a&&(u+=Z2(i??{})),u}async function X2(t,e){let n=(e==null?void 0:e.backgroundColor)??"white";const r=(e==null?void 0:e.imageType)??"png",s=btoa(t);n!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const i=`https://mermaid.ink/img/${s}?bgColor=${n}&type=${r}`,a=await fetch(i);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join(`
`));return await a.blob()}var $S={};ve($S,{Graph:()=>Uo});function Y2(t,e){if(t!==void 0&&!lo(t))return t;if(cg(e))try{let n=e.getName();return n=n.startsWith("Runnable")?n.slice(8):n,n}catch{return e.getName()}else return e.name??"UnknownSchema"}function Q2(t){return cg(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...nn(t.data.schema),title:t.data.name}}}var Uo=class NS{constructor(e){p(this,"nodes",{});p(this,"edges",[]);this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((n,r)=>{e[n.id]=lo(n.id)?r:n.id}),{nodes:Object.values(this.nodes).map(n=>({id:e[n.id],...Q2(n)})),edges:this.edges.map(n=>{const r={source:e[n.source],target:e[n.target]};return typeof n.data<"u"&&(r.data=n.data),typeof n.conditional<"u"&&(r.conditional=n.conditional),r})}}addNode(e,n,r){if(n!==void 0&&this.nodes[n]!==void 0)throw new Error(`Node with id ${n} already exists`);const s=n??ns(),i={id:s,data:e,name:Y2(n,e),metadata:r};return this.nodes[s]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(n=>n.source!==e.id&&n.target!==e.id)}addEdge(e,n,r,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[n.id]===void 0)throw new Error(`Target node ${n.id} not in graph`);const i={source:e.id,target:n.id,data:r,conditional:s};return this.edges.push(i),i}firstNode(){return eb(this)}lastNode(){return tb(this)}extend(e,n=""){let r=n;Object.values(e.nodes).map(u=>u.id).every(lo)&&(r="");const i=u=>r?`${r}:${u}`:u;Object.entries(e.nodes).forEach(([u,l])=>{this.nodes[i(u)]={...l,id:i(u)}});const a=e.edges.map(u=>({...u,source:i(u.source),target:i(u.target)}));this.edges=[...this.edges,...a];const o=e.firstNode(),c=e.lastNode();return[o?{id:i(o.id),data:o.data}:void 0,c?{id:i(c.id),data:c.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&eb(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&tb(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),n=new Map;Object.values(e).forEach(s=>{n.set(s,(n.get(s)||0)+1)});const r=s=>{const i=e[s];return lo(s)&&n.get(i)===1?i:s};return new NS({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,i])=>[r(s),{...i,id:r(s)}])),edges:this.edges.map(s=>({...s,source:r(s.source),target:r(s.target)}))})}drawMermaid(e){const{withStyles:n,curveStyle:r,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=e??{},a=this.reid(),o=a.firstNode(),c=a.lastNode();return K2(a.nodes,a.edges,{firstNode:o==null?void 0:o.id,lastNode:c==null?void 0:c.id,withStyles:n,curveStyle:r,nodeColors:s,wrapLabelNWords:i})}async drawMermaidPng(e){const n=this.drawMermaid(e);return X2(n,{backgroundColor:e==null?void 0:e.backgroundColor})}};function eb(t,e=[]){const n=new Set(t.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),r=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!n.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function tb(t,e=[]){const n=new Set(t.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),r=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!n.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function jc({name:t,serialized:e}){return t!==void 0?t:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const eL=t=>t.name==="event_stream_tracer";var tL=class extends ws{constructor(e){super({_awaitHandler:!0,...e});p(this,"autoClose",!0);p(this,"includeNames");p(this,"includeTypes");p(this,"includeTags");p(this,"excludeNames");p(this,"excludeTypes");p(this,"excludeTags");p(this,"runInfoMap",new Map);p(this,"tappedPromises",new Map);p(this,"transformStream");p(this,"writer");p(this,"receiveStream");p(this,"name","event_stream_tracer");p(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=kn.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const n=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||n.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,n){const r=await n.next();if(r.done)return;const s=this.runInfoMap.get(e);if(s===void 0){yield r.value;return}function i(o,c){return o==="llm"&&typeof c=="string"?new ya({text:c}):c}let a=this.tappedPromises.get(e);if(a===void 0){let o;a=new Promise(c=>{o=c}),this.tappedPromises.set(e,a);try{const c={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...c,data:{chunk:i(s.runType,r.value)}},s),yield r.value;for await(const u of n)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...c,data:{chunk:i(s.runType,u)}},s),yield u}finally{o==null||o()}}else{yield r.value;for await(const o of n)yield o}}async send(e,n){this._includeRun(n)&&await this.writer.write(e)}async sendEndEvent(e,n){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,n)}):await this.send(e,n)}async onLLMStart(e){var a,o;const n=jc(e),r=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:n,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,s);const i=`on_${r}_start`;await this.send({event:i,data:{input:e.inputs},name:n,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onLLMNewToken(e,n,r){const s=this.runInfoMap.get(e.id);let i,a;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")a="on_chat_model_stream",(r==null?void 0:r.chunk)===void 0?i=new Et({content:n,id:`run-${e.id}`}):i=r.chunk.message;else if(s.runType==="llm")a="on_llm_stream",(r==null?void 0:r.chunk)===void 0?i=new ya({text:n}):i=r.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:a,data:{chunk:i},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){var a,o,c;const n=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(n===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const s=(a=e.outputs)==null?void 0:a.generations;let i;if(n.runType==="chat_model"){for(const u of s??[]){if(i!==void 0)break;i=(o=u[0])==null?void 0:o.message}r="on_chat_model_end"}else if(n.runType==="llm")i={generations:s==null?void 0:s.map(u=>u.map(l=>({text:l.text,generationInfo:l.generationInfo}))),llmOutput:((c=e.outputs)==null?void 0:c.llmOutput)??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${n.runType}`);await this.sendEndEvent({event:r,data:{output:i,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async onChainStart(e){var a,o;const n=jc(e),r=e.run_type??"chain",s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:n,runType:e.run_type};let i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},s.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,s.inputs=e.inputs.input):(i.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${r}_start`,data:i,name:n,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onChainEnd(e){var o;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,s=e.inputs??n.inputs??{},a={output:((o=e.outputs)==null?void 0:o.output)??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(a.input=s.input,n.inputs=s.input),await this.sendEndEvent({event:r,data:a,run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata??{}},n)}async onToolStart(e){var s,i;const n=jc(e),r={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:n,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:n,run_id:e.id,tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{}},r)}async onToolEnd(e){var s;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(n.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=((s=e.outputs)==null?void 0:s.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async onRetrieverStart(e){var i,a;const n=jc(e),s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:n,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:n,tags:e.tags??[],run_id:e.id,metadata:((a=e.extra)==null?void 0:a.metadata)??{}},s)}async onRetrieverEnd(e){var r;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((r=e.outputs)==null?void 0:r.documents)??e.outputs,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async handleCustomEvent(e,n,r){const s=this.runInfoMap.get(r);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:s.tags,metadata:s.metadata,data:n},s)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}},PS=class extends ws{constructor({config:e,onStart:n,onEnd:r,onError:s}){super({_awaitHandler:!0});p(this,"name","RootListenersTracer");p(this,"rootId");p(this,"config");p(this,"argOnStart");p(this,"argOnEnd");p(this,"argOnError");this.config=e,this.argOnStart=n,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function nL(t){const e=new TextEncoder,n=new ReadableStream({async start(r){for await(const s of t)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return kn.fromReadableStream(n)}function nb(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.iterator]=="function"&&typeof t.next=="function"}const rL=t=>t!=null&&typeof t=="object"&&"next"in t&&typeof t.next=="function";function Ep(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.asyncIterator]=="function"}function*rb(t,e){for(;;){const{value:n,done:r}=Dt.runWithConfig(fs(t),e.next.bind(e),!0);if(r)break;yield n}}async function*Sp(t,e){const n=e[Symbol.asyncIterator]();for(;;){const{value:r,done:s}=await Dt.runWithConfig(fs(t),n.next.bind(e),!0);if(s)break;yield r}}function Rt(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}var je=class extends sr{constructor(){super(...arguments);p(this,"lc_runnable",!0);p(this,"name")}getName(e){const n=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${n}${e}`:n}withRetry(e){return new ug({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Hs({bound:this,config:e,kwargs:{}})}withFallbacks(e){const n=Array.isArray(e)?e:e.fallbacks;return new jS({runnable:this,fallbacks:n})}_getOptionsList(e,n=0){if(Array.isArray(e)&&e.length!==n)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${n} inputs`);if(Array.isArray(e))return e.map(ze);if(n>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:n},(s,i)=>ze(i===0?e:r))}return Array.from({length:n},()=>ze(e))}async batch(e,n,r){var c;const s=this._getOptionsList(n??{},e.length),i=((c=s[0])==null?void 0:c.maxConcurrency)??(r==null?void 0:r.maxConcurrency),a=new lc({maxConcurrency:i,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>a.call(async()=>{try{return await this.invoke(u,s[l])}catch(d){if(r!=null&&r.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,n){yield this.invoke(e,n)}async stream(e,n){const r=ze(n),s=new Ni({generator:this._streamIterator(e,r),config:r});return await s.setup,kn.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let n;e===void 0?n=ze(e):n=ze({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[n,r]}async _callWithConfig(e,n,r){const s=ze(r),i=await An(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),Rt(n,"input"),s.runId,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));delete s.runId;let o;try{const c=e.call(this,n,s,a);o=await Fs(c,r==null?void 0:r.signal)}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(Rt(o,"output"))),o}async _batchWithConfig(e,n,r,s){var u;const i=this._getOptionsList(r??{},n.length),a=await Promise.all(i.map(An)),o=await Promise.all(a.map(async(l,d)=>{const h=await(l==null?void 0:l.handleChainStart(this.toJSON(),Rt(n[d],"input"),i[d].runId,i[d].runType,void 0,void 0,i[d].runName??this.getName()));return delete i[d].runId,h}));let c;try{const l=e.call(this,n,i,o,s);c=await Fs(l,(u=i==null?void 0:i[0])==null?void 0:u.signal)}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(Rt(c,"output")))),c}_concatOutputChunks(e,n){return zs(e,n)}async*_transformStreamWithConfig(e,n,r){let s,i=!0,a,o=!0;const c=ze(r),u=await An(c),l=this;async function*d(){for await(const f of e){if(i)if(s===void 0)s=f;else try{s=l._concatOutputChunks(s,f)}catch{s=void 0,i=!1}yield f}}let h;try{const f=await ZE(n.bind(this),d(),async()=>u==null?void 0:u.handleChainStart(this.toJSON(),{input:""},c.runId,c.runType,void 0,void 0,c.runName??this.getName()),r==null?void 0:r.signal,c);delete c.runId,h=f.setup;const m=h==null?void 0:h.handlers.find(eL);let g=f.output;m!==void 0&&h!==void 0&&(g=m.tapOutputIterable(h.runId,g));const _=h==null?void 0:h.handlers.find(eS);_!==void 0&&h!==void 0&&(g=_.tapOutputIterable(h.runId,g));for await(const b of g)if(yield b,o)if(a===void 0)a=b;else try{a=this._concatOutputChunks(a,b)}catch{a=void 0,o=!1}}catch(f){throw await(h==null?void 0:h.handleChainError(f,void 0,void 0,void 0,{inputs:Rt(s,"input")})),f}await(h==null?void 0:h.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:Rt(s,"input")}))}getGraph(e){const n=new Uo,r=n.addNode({name:`${this.getName()}Input`,schema:Kw()}),s=n.addNode(this),i=n.addNode({name:`${this.getName()}Output`,schema:Kw()});return n.addEdge(r,s),n.addEdge(s,i),n}pipe(e){return new Jr({first:this,last:Jt(e)})}pick(e){return this.pipe(new FS(e))}assign(e){return this.pipe(new lg(new Pa({steps:e})))}async*transform(e,n){let r;for await(const s of e)r===void 0?r=s:r=this._concatOutputChunks(r,s);yield*this._streamIterator(r,ze(n))}async*streamLog(e,n,r){const s=new dp({...r,autoClose:!1,_schemaFormat:"original"}),i=ze(n);yield*this._streamLog(e,s,i)}async*_streamLog(e,n,r){const{callbacks:s}=r;if(s===void 0)r.callbacks=[n];else if(Array.isArray(s))r.callbacks=s.concat([n]);else{const c=s.copy();c.addHandler(n,!0),r.callbacks=c}const i=this.stream(e,r);async function a(){try{const c=await i;for await(const u of c){const l=new rs({ops:[{op:"add",path:"/streamed_output/-",value:u}]});await n.writer.write(l)}}finally{await n.writer.close()}}const o=a();try{for await(const c of n)yield c}finally{await o}}streamEvents(e,n,r){let s;if(n.version==="v1")s=this._streamEventsV1(e,n,r);else if(n.version==="v2")s=this._streamEventsV2(e,n,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return n.encoding==="text/event-stream"?nL(s):kn.fromAsyncGenerator(s)}async*_streamEventsV2(e,n,r){var m;const s=new tL({...r,autoClose:!1}),i=ze(n),a=i.runId??ns();i.runId=a;const o=i.callbacks;if(o===void 0)i.callbacks=[s];else if(Array.isArray(o))i.callbacks=o.concat(s);else{const g=o.copy();g.addHandler(s,!0),i.callbacks=g}const c=new AbortController,u=this;async function l(){let g,_=null;try{n!=null&&n.signal?"any"in AbortSignal?g=AbortSignal.any([c.signal,n.signal]):(g=n.signal,_=()=>{c.abort()},n.signal.addEventListener("abort",_,{once:!0})):g=c.signal;const b=await u.stream(e,{...i,signal:g}),y=s.tapOutputIterable(a,b);for await(const E of y)if(c.signal.aborted)break}finally{await s.finish(),g&&_&&g.removeEventListener("abort",_)}}const d=l();let h=!1,f;try{for await(const g of s){if(!h){g.data.input=e,h=!0,f=g.run_id,yield g;continue}g.run_id===f&&g.event.endsWith("_end")&&(m=g.data)!=null&&m.input&&delete g.data.input,yield g}}finally{c.abort(),await d}}async*_streamEventsV1(e,n,r){let s,i=!1;const a=ze(n),o=a.tags??[],c=a.metadata??{},u=a.runName??this.getName(),l=new dp({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new W2({...r}),h=this._streamLog(e,l,a);for await(const m of h){if(s?s=s.concat(m):s=Qm.fromRunLogPatch(m),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const y={...s.state},E={run_id:y.id,event:`on_${y.type}_start`,name:u,tags:o,metadata:c,data:{input:e}};d.includeEvent(E,y.type)&&(yield E)}const g=m.ops.filter(y=>y.path.startsWith("/logs/")).map(y=>y.path.split("/")[2]),_=[...new Set(g)];for(const y of _){let E,C={};const k=s.state.logs[y];if(k.end_time===void 0?k.streamed_output.length>0?E="stream":E="start":E="end",E==="start")k.inputs!==void 0&&(C.input=k.inputs);else if(E==="end")k.inputs!==void 0&&(C.input=k.inputs),C.output=k.final_output;else if(E==="stream"){const R=k.streamed_output.length;if(R!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${R} instead. Encountered in: "${k.name}"`);C={chunk:k.streamed_output[0]},k.streamed_output=[]}yield{event:`on_${k.type}_${E}`,name:k.name,run_id:k.id,tags:k.tags,metadata:k.metadata,data:C}}const{state:b}=s;if(b.streamed_output.length>0){const y=b.streamed_output.length;if(y!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${y} instead. Encountered in: "${b.name}"`);const E={chunk:b.streamed_output[0]};b.streamed_output=[];const C={event:`on_${b.type}_stream`,run_id:b.id,tags:o,metadata:c,name:u,data:E};d.includeEvent(C,b.type)&&(yield C)}}const f=s==null?void 0:s.state;if(f!==void 0){const m={event:`on_${f.type}_end`,name:u,run_id:f.id,tags:o,metadata:c,data:{output:f.final_output}};d.includeEvent(m,f.type)&&(yield m)}}static isRunnable(e){return cg(e)}withListeners({onStart:e,onEnd:n,onError:r}){return new Hs({bound:this,config:{},configFactories:[s=>({callbacks:[new PS({config:s,onStart:e,onEnd:n,onError:r})]})]})}asTool(e){return cL(this,e)}},Hs=class LS extends je{constructor(n){super(n);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"bound");p(this,"config");p(this,"kwargs");p(this,"configFactories");this.bound=n.bound,this.kwargs=n.kwargs,this.config=n.config,this.configFactories=n.configFactories}static lc_name(){return"RunnableBinding"}getName(n){return this.bound.getName(n)}async _mergeConfig(...n){const r=er(this.config,...n);return er(r,...this.configFactories?await Promise.all(this.configFactories.map(async s=>await s(r))):[])}withConfig(n){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...n}})}withRetry(n){return new ug({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:n==null?void 0:n.stopAfterAttempt,...n})}async invoke(n,r){return this.bound.invoke(n,await this._mergeConfig(r,this.kwargs))}async batch(n,r,s){const i=Array.isArray(r)?await Promise.all(r.map(async a=>this._mergeConfig(ze(a),this.kwargs))):await this._mergeConfig(ze(r),this.kwargs);return this.bound.batch(n,i,s)}_concatOutputChunks(n,r){return this.bound._concatOutputChunks(n,r)}async*_streamIterator(n,r){yield*this.bound._streamIterator(n,await this._mergeConfig(ze(r),this.kwargs))}async stream(n,r){return this.bound.stream(n,await this._mergeConfig(ze(r),this.kwargs))}async*transform(n,r){yield*this.bound.transform(n,await this._mergeConfig(ze(r),this.kwargs))}streamEvents(n,r,s){const i=this,a=async function*(){yield*i.bound.streamEvents(n,{...await i._mergeConfig(ze(r),i.kwargs),version:r.version},s)};return kn.fromAsyncGenerator(a())}static isRunnableBinding(n){return n.bound&&je.isRunnable(n.bound)}withListeners({onStart:n,onEnd:r,onError:s}){return new LS({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[i=>({callbacks:[new PS({config:i,onStart:n,onEnd:r,onError:s})]})]})}},sL=class MS extends je{constructor(n){super(n);p(this,"lc_serializable",!0);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"bound");this.bound=n.bound}static lc_name(){return"RunnableEach"}async invoke(n,r){return this._callWithConfig(this._invoke.bind(this),n,r)}async _invoke(n,r,s){return this.bound.batch(n,Je(r,{callbacks:s==null?void 0:s.getChild()}))}withListeners({onStart:n,onEnd:r,onError:s}){return new MS({bound:this.bound.withListeners({onStart:n,onEnd:r,onError:s})})}},ug=class extends Hs{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"maxAttemptNumber",3);p(this,"onFailedAttempt",()=>{});this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}static lc_name(){return"RunnableRetry"}_patchConfigForRetry(e,n,r){const s=e>1?`retry:attempt:${e}`:void 0;return Je(n,{callbacks:r==null?void 0:r.getChild(s)})}async _invoke(e,n,r){return Vu(s=>super.invoke(e,this._patchConfigForRetry(s,n,r)),{onFailedAttempt:s=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,n){return this._callWithConfig(this._invoke.bind(this),e,n)}async _batch(e,n,r,s){const i={};try{await Vu(async a=>{const o=e.map((h,f)=>f).filter(h=>i[h.toString()]===void 0||i[h.toString()]instanceof Error),c=o.map(h=>e[h]),u=o.map(h=>this._patchConfigForRetry(a,n==null?void 0:n[h],r==null?void 0:r[h])),l=await super.batch(c,u,{...s,returnExceptions:!0});let d;for(let h=0;h<l.length;h+=1){const f=l[h],m=o[h];f instanceof Error&&d===void 0&&(d=f,d.input=c[h]),i[m.toString()]=f}if(d)throw d;return l},{onFailedAttempt:a=>this.onFailedAttempt(a,a.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if((s==null?void 0:s.returnExceptions)!==!0)throw a}return Object.keys(i).sort((a,o)=>parseInt(a,10)-parseInt(o,10)).map(a=>i[parseInt(a,10)])}async batch(e,n,r){return this._batchWithConfig(this._batch.bind(this),e,n,r)}},Jr=class Ka extends je{constructor(n){super(n);p(this,"first");p(this,"middle",[]);p(this,"last");p(this,"omitSequenceTags",!1);p(this,"lc_serializable",!0);p(this,"lc_namespace",["langchain_core","runnables"]);this.first=n.first,this.middle=n.middle??this.middle,this.last=n.last,this.name=n.name,this.omitSequenceTags=n.omitSequenceTags??this.omitSequenceTags}static lc_name(){return"RunnableSequence"}get steps(){return[this.first,...this.middle,this.last]}async invoke(n,r){var u;const s=ze(r),i=await An(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),Rt(n,"input"),s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;let o=n,c;try{const l=[this.first,...this.middle];for(let d=0;d<l.length;d+=1){const f=l[d].invoke(o,Je(s,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${d+1}`)}));o=await Fs(f,r==null?void 0:r.signal)}if((u=r==null?void 0:r.signal)!=null&&u.aborted)throw Io(r.signal);c=await this.last.invoke(o,Je(s,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(l){throw await(a==null?void 0:a.handleChainError(l)),l}return await(a==null?void 0:a.handleChainEnd(Rt(c,"output"))),c}async batch(n,r,s){var u;const i=this._getOptionsList(r??{},n.length),a=await Promise.all(i.map(An)),o=await Promise.all(a.map(async(l,d)=>{const h=await(l==null?void 0:l.handleChainStart(this.toJSON(),Rt(n[d],"input"),i[d].runId,void 0,void 0,void 0,i[d].runName));return delete i[d].runId,h}));let c=n;try{for(let l=0;l<this.steps.length;l+=1){const h=this.steps[l].batch(c,o.map((f,m)=>{const g=f==null?void 0:f.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`);return Je(i[m],{callbacks:g})}),s);c=await Fs(h,(u=i[0])==null?void 0:u.signal)}}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(Rt(c,"output")))),c}_concatOutputChunks(n,r){return this.last._concatOutputChunks(n,r)}async*_streamIterator(n,r){var h;const s=await An(r),{runId:i,...a}=r??{},o=await(s==null?void 0:s.handleChainStart(this.toJSON(),Rt(n,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName)),c=[this.first,...this.middle,this.last];let u=!0,l;async function*d(){yield n}try{let f=c[0].transform(d(),Je(a,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let m=1;m<c.length;m+=1)f=await c[m].transform(f,Je(a,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:`seq:step:${m+1}`)}));for await(const m of f)if((h=r==null?void 0:r.signal)==null||h.throwIfAborted(),yield m,u)if(l===void 0)l=m;else try{l=this._concatOutputChunks(l,m)}catch{l=void 0,u=!1}}catch(f){throw await(o==null?void 0:o.handleChainError(f)),f}await(o==null?void 0:o.handleChainEnd(Rt(l,"output")))}getGraph(n){const r=new Uo;let s=null;return this.steps.forEach((i,a)=>{const o=i.getGraph(n);a!==0&&o.trimFirstNode(),a!==this.steps.length-1&&o.trimLastNode(),r.extend(o);const c=o.firstNode();if(!c)throw new Error(`Runnable ${i} has no first node`);s&&r.addEdge(s,c),s=o.lastNode()}),r}pipe(n){return Ka.isRunnableSequence(n)?new Ka({first:this.first,middle:this.middle.concat([this.last,n.first,...n.middle]),last:n.last,name:this.name??n.name}):new Ka({first:this.first,middle:[...this.middle,this.last],last:Jt(n),name:this.name})}static isRunnableSequence(n){return Array.isArray(n.middle)&&je.isRunnable(n)}static from([n,...r],s){let i={};return typeof s=="string"?i.name=s:s!==void 0&&(i=s),new Ka({...i,first:Jt(n),middle:r.slice(0,-1).map(Jt),last:Jt(r[r.length-1])})}},Pa=class DS extends je{constructor(n){super(n);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"steps");this.steps={};for(const[r,s]of Object.entries(n.steps))this.steps[r]=Jt(s)}static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}static from(n){return new DS({steps:n})}async invoke(n,r){const s=ze(r),i=await An(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),{input:n},s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;const o={};try{const c=Object.entries(this.steps).map(async([u,l])=>{o[u]=await l.invoke(n,Je(s,{callbacks:a==null?void 0:a.getChild(`map:key:${u}`)}))});await Fs(Promise.all(c),r==null?void 0:r.signal)}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(o)),o}async*_transform(n,r,s){const i={...this.steps},a=Ym(n,Object.keys(i).length),o=new Map(Object.entries(i).map(([c,u],l)=>{const d=u.transform(a[l],Je(s,{callbacks:r==null?void 0:r.getChild(`map:key:${c}`)}));return[c,d.next().then(h=>({key:c,gen:d,result:h}))]}));for(;o.size;){const c=Promise.race(o.values()),{key:u,result:l,gen:d}=await Fs(c,s==null?void 0:s.signal);o.delete(u),l.done||(yield{[u]:l.value},o.set(u,d.next().then(h=>({key:u,gen:d,result:h}))))}}transform(n,r){return this._transformStreamWithConfig(n,this._transform.bind(this),r)}async stream(n,r){async function*s(){yield n}const i=ze(r),a=new Ni({generator:this.transform(s(),i),config:i});return await a.setup,kn.fromAsyncGenerator(a)}},iL=class US extends je{constructor(n){super(n);p(this,"lc_serializable",!1);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"func");if(!Wm(n.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=n.func}async invoke(n,r){const[s]=this._getOptionsList(r??{},1),i=await An(s),a=this.func(Je(s,{callbacks:i}),n);return Fs(a,s==null?void 0:s.signal)}async*_streamIterator(n,r){var a,o;const[s]=this._getOptionsList(r??{},1),i=await this.invoke(n,r);if(Ep(i)){for await(const c of i)(a=s==null?void 0:s.signal)==null||a.throwIfAborted(),yield c;return}if(rL(i)){for(;;){(o=s==null?void 0:s.signal)==null||o.throwIfAborted();const c=i.next();if(c.done)break;yield c.value}return}yield i}static from(n){return new US({func:n})}};function aL(t){if(Wm(t))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Tr=class BS extends je{constructor(n){if(Wm(n.func))return iL.from(n.func);super(n);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"func");aL(n.func),this.func=n.func}static lc_name(){return"RunnableLambda"}static from(n){return new BS({func:n})}async _invoke(n,r,s){return new Promise((i,a)=>{const o=Je(r,{callbacks:s==null?void 0:s.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??ef)-1});Dt.runWithConfig(fs(o),async()=>{var c,u;try{let l=await this.func(n,{...o});if(l&&je.isRunnable(l)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");l=await l.invoke(n,{...o,recursionLimit:(o.recursionLimit??ef)-1})}else if(Ep(l)){let d;for await(const h of Sp(o,l))if((c=r==null?void 0:r.signal)==null||c.throwIfAborted(),d===void 0)d=h;else try{d=this._concatOutputChunks(d,h)}catch{d=h}l=d}else if(nb(l)){let d;for(const h of rb(o,l))if((u=r==null?void 0:r.signal)==null||u.throwIfAborted(),d===void 0)d=h;else try{d=this._concatOutputChunks(d,h)}catch{d=h}l=d}i(l)}catch(l){a(l)}})})}async invoke(n,r){return this._callWithConfig(this._invoke.bind(this),n,r)}async*_transform(n,r,s){var c,u;let i;for await(const l of n)if(i===void 0)i=l;else try{i=this._concatOutputChunks(i,l)}catch{i=l}const a=Je(s,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((s==null?void 0:s.recursionLimit)??ef)-1}),o=await new Promise((l,d)=>{Dt.runWithConfig(fs(a),async()=>{try{const h=await this.func(i,{...a,config:a});l(h)}catch(h){d(h)}})});if(o&&je.isRunnable(o)){if((s==null?void 0:s.recursionLimit)===0)throw new Error("Recursion limit reached.");const l=await o.stream(i,a);for await(const d of l)yield d}else if(Ep(o))for await(const l of Sp(a,o))(c=s==null?void 0:s.signal)==null||c.throwIfAborted(),yield l;else if(nb(o))for(const l of rb(a,o))(u=s==null?void 0:s.signal)==null||u.throwIfAborted(),yield l;else yield o}transform(n,r){return this._transformStreamWithConfig(n,this._transform.bind(this),r)}async stream(n,r){async function*s(){yield n}const i=ze(r),a=new Ni({generator:this.transform(s(),i),config:i});return await a.setup,kn.fromAsyncGenerator(a)}},oL=class extends Pa{},jS=class extends je{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"runnable");p(this,"fallbacks");this.runnable=e.runnable,this.fallbacks=e.fallbacks}static lc_name(){return"RunnableWithFallbacks"}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,n){const r=ze(n),s=await An(r),{runId:i,...a}=r,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),Rt(e,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName)),c=Je(a,{callbacks:o==null?void 0:o.getChild()});return await Dt.runWithConfig(c,async()=>{var d;let l;for(const h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();try{const f=await h.invoke(e,c);return await(o==null?void 0:o.handleChainEnd(Rt(f,"output"))),f}catch(f){l===void 0&&(l=f)}}throw l===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(l)),l)})}async*_streamIterator(e,n){var d;const r=ze(n),s=await An(r),{runId:i,...a}=r,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),Rt(e,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName));let c,u;for(const h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();const f=Je(a,{callbacks:o==null?void 0:o.getChild()});try{const m=await h.stream(e,f);u=Sp(f,m);break}catch(m){c===void 0&&(c=m)}}if(u===void 0){const h=c??new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(h)),h}let l;try{for await(const h of u){yield h;try{l=l===void 0?l:this._concatOutputChunks(l,h)}catch{l=void 0}}}catch(h){throw await(o==null?void 0:o.handleChainError(h)),h}await(o==null?void 0:o.handleChainEnd(Rt(l,"output")))}async batch(e,n,r){var c;if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(n??{},e.length),i=await Promise.all(s.map(u=>An(u))),a=await Promise.all(i.map(async(u,l)=>{const d=await(u==null?void 0:u.handleChainStart(this.toJSON(),Rt(e[l],"input"),s[l].runId,void 0,void 0,void 0,s[l].runName));return delete s[l].runId,d}));let o;for(const u of this.runnables()){(c=s[0].signal)==null||c.throwIfAborted();try{const l=await u.batch(e,a.map((d,h)=>Je(s[h],{callbacks:d==null?void 0:d.getChild()})),r);return await Promise.all(a.map((d,h)=>d==null?void 0:d.handleChainEnd(Rt(l[h],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(a.map(u=>u==null?void 0:u.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function Jt(t){if(typeof t=="function")return new Tr({func:t});if(je.isRunnable(t))return t;if(!Array.isArray(t)&&typeof t=="object"){const e={};for(const[n,r]of Object.entries(t))e[n]=Jt(r);return new Pa({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var lg=class extends je{constructor(e){e instanceof Pa&&(e={mapper:e});super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"mapper");this.mapper=e.mapper}static lc_name(){return"RunnableAssign"}async invoke(e,n){const r=await this.mapper.invoke(e,n);return{...e,...r}}async*_transform(e,n,r){const s=this.mapper.getStepsKeys(),[i,a]=Ym(e),o=this.mapper.transform(a,Je(r,{callbacks:n==null?void 0:n.getChild()})),c=o.next();for await(const u of i){if(typeof u!="object"||Array.isArray(u))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof u}`);const l=Object.fromEntries(Object.entries(u).filter(([d])=>!s.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await c).value;for await(const u of o)yield u}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=ze(n),i=new Ni({generator:this.transform(r(),s),config:s});return await i.setup,kn.fromAsyncGenerator(i)}},FS=class extends je{constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e});super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"keys");this.keys=e.keys}static lc_name(){return"RunnablePick"}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const n=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return n.length===0?void 0:Object.fromEntries(n)}}async invoke(e,n){return this._callWithConfig(this._pick.bind(this),e,n)}async*_transform(e){for await(const n of e){const r=await this._pick(n);r!==void 0&&(yield r)}}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=ze(n),i=new Ni({generator:this.transform(r(),s),config:s});return await i.setup,kn.fromAsyncGenerator(i)}},xp=class extends Hs{constructor(e){const n=Jr.from([Tr.from(async r=>{let s;if(po(r))try{s=await rd(this.schema,r.args)}catch{throw new Gu("Received tool input did not match expected schema",JSON.stringify(r.args))}else s=r;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:n,config:e.config??{}});p(this,"name");p(this,"description");p(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function cL(t,e){const n=e.name??t.getName(),r=e.description??xi(e.schema);return sg(e.schema)?new xp({name:n,description:r,schema:mn({input:rt()}).transform(s=>s.input),bound:t}):new xp({name:n,description:r,schema:e.schema,bound:t})}const al=(t,e)=>{const n=[...new Set(e==null?void 0:e.map(s=>{if(typeof s=="string")return s;const i=new s({});if(!("getType"in i)||typeof i.getType!="function")throw new Error("Invalid type provided.");return i.getType()}))],r=t.getType();return n.some(s=>s===r)};function uL(t,e){return Array.isArray(t)?sb(t,e):Tr.from(n=>sb(n,t))}function sb(t,e={}){const{includeNames:n,excludeNames:r,includeTypes:s,excludeTypes:i,includeIds:a,excludeIds:o}=e,c=[];for(const u of t)if(!(r&&u.name&&r.includes(u.name))){{if(i&&al(u,i))continue;if(o&&u.id&&o.includes(u.id))continue}s||a||n?(n&&u.name&&n.some(l=>l===u.name)||s&&al(u,s)||a&&u.id&&a.some(l=>l===u.id))&&c.push(u):c.push(u)}return c}function lL(t){return Array.isArray(t)?ib(t):Tr.from(ib)}function ib(t){if(!t.length)return[];const e=[];for(const n of t){const r=n,s=e.pop();if(!s)e.push(r);else if(r.getType()==="tool"||r.getType()!==s.getType())e.push(s,r);else{const i=Ju(s),a=Ju(r),o=i.concat(a);typeof i.content=="string"&&typeof a.content=="string"&&(o.content=`${i.content}
${a.content}`),e.push(fL(o))}}return e}function dL(t,e){if(Array.isArray(t)){const n=t;if(!e)throw new Error("Options parameter is required when providing messages.");return ab(n,e)}else{const n=t;return Tr.from(r=>ab(r,n)).withConfig({runName:"trim_messages"})}}async function ab(t,e){const{maxTokens:n,tokenCounter:r,strategy:s="last",allowPartial:i=!1,endOn:a,startOn:o,includeSystem:c=!1,textSplitter:u}=e;if(o&&s==="first")throw new Error("`startOn` should only be specified if `strategy` is 'last'.");if(c&&s==="first")throw new Error("`includeSystem` should only be specified if `strategy` is 'last'.");let l;"getNumTokens"in r?l=async h=>(await Promise.all(h.map(m=>r.getNumTokens(m.content)))).reduce((m,g)=>m+g,0):l=async h=>r(h);let d=VS;if(u&&("splitText"in u?d=u.splitText:d=async h=>u(h)),s==="first")return zS(t,{maxTokens:n,tokenCounter:l,textSplitter:d,partialStrategy:i?"first":void 0,endOn:a});if(s==="last")return hL(t,{maxTokens:n,tokenCounter:l,textSplitter:d,allowPartial:i,includeSystem:c,startOn:o,endOn:a});throw new Error(`Unrecognized strategy: '${s}'. Must be one of 'first' or 'last'.`)}async function zS(t,e){const{maxTokens:n,tokenCounter:r,textSplitter:s,partialStrategy:i,endOn:a}=e;let o=[...t],c=0;for(let u=0;u<o.length;u+=1){const l=u>0?o.slice(0,-u):o;if(await r(l)<=n){c=o.length-u;break}}if(c<o.length&&i){let u=!1;if(Array.isArray(o[c].content)){const l=o[c];if(typeof l.content=="string")throw new Error("Expected content to be an array.");const d=l.content.length,h=i==="last"?[...l.content].reverse():l.content;for(let f=1;f<=d;f+=1){const m=i==="first"?h.slice(0,f):h.slice(-f),g=Object.fromEntries(Object.entries(l).filter(([y])=>y!=="type"&&!y.startsWith("lc_"))),_=dg(l.getType(),{...g,content:m}),b=[...o.slice(0,c),_];if(await r(b)<=n)o=b,c+=1,u=!0;else break}u&&i==="last"&&(l.content=[...h].reverse())}if(!u){const l=o[c];let d;if(Array.isArray(l.content)&&l.content.some(h=>typeof h=="string"||h.type==="text")){const h=l.content.find(f=>f.type==="text"&&f.text);d=h==null?void 0:h.text}else typeof l.content=="string"&&(d=l.content);if(d){const h=await s(d),f=h.length;i==="last"&&h.reverse();for(let m=0;m<f-1;m+=1)if(h.pop(),l.content=h.join(""),await r([...o.slice(0,c),l])<=n){i==="last"&&(l.content=[...h].reverse().join("")),o=[...o.slice(0,c),l],c+=1;break}}}}if(a){const u=Array.isArray(a)?a:[a];for(;c>0&&!al(o[c-1],u);)c-=1}return o.slice(0,c)}async function hL(t,e){var l;const{allowPartial:n=!1,includeSystem:r=!1,endOn:s,startOn:i,...a}=e;let o=t.map(d=>{const h=Object.fromEntries(Object.entries(d).filter(([f])=>f!=="type"&&!f.startsWith("lc_")));return dg(d.getType(),h,Ao(d))});if(s){const d=Array.isArray(s)?s:[s];for(;o.length>0&&!al(o[o.length-1],d);)o=o.slice(0,-1)}const c=r&&((l=o[0])==null?void 0:l.getType())==="system";let u=c?o.slice(0,1).concat(o.slice(1).reverse()):o.reverse();return u=await zS(u,{...a,partialStrategy:n?"last":void 0,endOn:i}),c?[u[0],...u.slice(1).reverse()]:u.reverse()}const ob={human:{message:It,messageChunk:oc},ai:{message:ht,messageChunk:Et},system:{message:vt,messageChunk:js},developer:{message:vt,messageChunk:js},tool:{message:Hr,messageChunk:rc},function:{message:Yl,messageChunk:ac},generic:{message:Zr,messageChunk:ic},remove:{message:Wu,messageChunk:Wu}};function dg(t,e,n){var i;let r,s;switch(t){case"human":n?r=new oc(e):s=new It(e);break;case"ai":if(n){let a={...e};"tool_calls"in a&&(a={...a,tool_call_chunks:(i=a.tool_calls)==null?void 0:i.map(o=>({...o,type:"tool_call_chunk",index:void 0,args:JSON.stringify(o.args)}))}),r=new Et(a)}else s=new ht(e);break;case"system":n?r=new js(e):s=new vt(e);break;case"developer":n?r=new js({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}}):s=new vt({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}});break;case"tool":if("tool_call_id"in e)n?r=new rc(e):s=new Hr(e);else throw new Error("Can not convert ToolMessage to ToolMessageChunk if 'tool_call_id' field is not defined.");break;case"function":if(n)r=new ac(e);else{if(!e.name)throw new Error("FunctionMessage must have a 'name' field");s=new Yl(e)}break;case"generic":if("role"in e)n?r=new ic(e):s=new Zr(e);else throw new Error("Can not convert ChatMessage to ChatMessageChunk if 'role' field is not defined.");break;default:throw new Error(`Unrecognized message type ${t}`)}if(n&&r)return r;if(s)return s;throw new Error(`Unrecognized message type ${t}`)}function fL(t){const e=t.getType();let n;const r=Object.fromEntries(Object.entries(t).filter(([s])=>!["type","tool_call_chunks"].includes(s)&&!s.startsWith("lc_")));if(e in ob&&(n=dg(e,r)),!n)throw new Error(`Unrecognized message chunk class ${e}. Supported classes are ${Object.keys(ob)}`);return n}function VS(t){const e=t.split(`
`);return Promise.resolve([...e.slice(0,-1).map(n=>`${n}
`),e[e.length-1]])}const pL=["tool_call","tool_call_chunk","invalid_tool_call","server_tool_call","server_tool_call_chunk","server_tool_call_result"],mL=["image","video","audio","text-plain","file"],gL=["text","reasoning",...pL,...mL];var qS={};ve(qS,{AIMessage:()=>ht,AIMessageChunk:()=>Et,BaseMessage:()=>rr,BaseMessageChunk:()=>Oi,ChatMessage:()=>Zr,ChatMessageChunk:()=>ic,FunctionMessage:()=>Yl,FunctionMessageChunk:()=>ac,HumanMessage:()=>It,HumanMessageChunk:()=>oc,KNOWN_BLOCK_TYPES:()=>gL,RemoveMessage:()=>Wu,SystemMessage:()=>vt,SystemMessageChunk:()=>js,ToolMessage:()=>Hr,ToolMessageChunk:()=>rc,_isMessageFieldWithRole:()=>tE,_mergeDicts:()=>rn,_mergeLists:()=>nc,_mergeObj:()=>eE,_mergeStatus:()=>Qv,coerceMessageLikeToMessage:()=>Vr,convertToChunk:()=>Ju,convertToOpenAIImageBlock:()=>Zv,convertToProviderContentBlock:()=>Hl,defaultTextSplitter:()=>VS,defaultToolCallParser:()=>Mm,filterMessages:()=>uL,getBufferString:()=>Km,iife:()=>V$,isAIMessage:()=>$i,isAIMessageChunk:()=>rp,isBase64ContentBlock:()=>$m,isBaseMessage:()=>Lt,isBaseMessageChunk:()=>Ao,isChatMessage:()=>P$,isChatMessageChunk:()=>L$,isDataContentBlock:()=>vr,isDirectToolOutput:()=>Lm,isFunctionMessage:()=>M$,isFunctionMessageChunk:()=>D$,isHumanMessage:()=>U$,isHumanMessageChunk:()=>B$,isIDContentBlock:()=>Jv,isMessage:()=>Yv,isOpenAIToolCallArray:()=>O1,isPlainTextContentBlock:()=>g1,isSystemMessage:()=>j$,isSystemMessageChunk:()=>F$,isToolMessage:()=>Dm,isToolMessageChunk:()=>rE,isURLContentBlock:()=>Om,mapChatMessagesToStoredMessages:()=>J$,mapStoredMessageToChatMessage:()=>Xm,mapStoredMessagesToChatMessages:()=>W$,mergeContent:()=>Ri,mergeMessageRuns:()=>lL,mergeResponseMetadata:()=>ME,mergeUsageMetadata:()=>UE,parseBase64DataUrl:()=>vi,parseMimeType:()=>ci,trimMessages:()=>dL});var HS={};ve(HS,{BaseChatMessageHistory:()=>GS,BaseListChatMessageHistory:()=>hg,InMemoryChatMessageHistory:()=>yL});var GS=class extends sr{async addMessages(t){for(const e of t)await this.addMessage(e)}},hg=class extends sr{addUserMessage(t){return this.addMessage(new It(t))}addAIMessage(t){return this.addMessage(new ht(t))}async addMessages(t){for(const e of t)await this.addMessage(e)}clear(){throw new Error("Not implemented.")}},yL=class extends hg{constructor(e){super(...arguments);p(this,"lc_namespace",["langchain","stores","message","in_memory"]);p(this,"messages",[]);this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}},WS={};ve(WS,{Embeddings:()=>fg});var fg=class{constructor(e){p(this,"caller");this.caller=new lc(e??{})}},_L={},JS={};ve(JS,{BaseMemory:()=>wL,getInputValue:()=>bL,getOutputValue:()=>vL,getPromptInputKey:()=>EL});var wL=class{};const ZS=(t,e)=>{if(e!==void 0)return t[e];const n=Object.keys(t);if(n.length===1)return t[n[0]]},bL=(t,e)=>{const n=ZS(t,e);if(!n){const r=Object.keys(t);throw new Error(`input values have ${r.length} keys, you must specify an input key or pass only 1 key as input`)}return n},vL=(t,e)=>{const n=ZS(t,e);if(!n&&n!==""){const r=Object.keys(t);throw new Error(`output values have ${r.length} keys, you must specify an output key or pass only 1 key as output`)}return n};function EL(t,e){const n=Object.keys(t).filter(r=>!e.includes(r)&&r!=="stop");if(n.length!==1)throw new Error(`One input key expected, but got ${n.length}`);return n[0]}var KS={};ve(KS,{BasePromptValue:()=>id,ChatPromptValue:()=>mg,ImagePromptValue:()=>XS,StringPromptValue:()=>pg});var id=class extends sr{},pg=class extends id{constructor(e){super({value:e});p(this,"lc_namespace",["langchain_core","prompt_values"]);p(this,"lc_serializable",!0);p(this,"value");this.value=e}static lc_name(){return"StringPromptValue"}toString(){return this.value}toChatMessages(){return[new It(this.value)]}},mg=class extends id{constructor(e){Array.isArray(e)&&(e={messages:e});super(e);p(this,"lc_namespace",["langchain_core","prompt_values"]);p(this,"lc_serializable",!0);p(this,"messages");this.messages=e.messages}static lc_name(){return"ChatPromptValue"}toString(){return Km(this.messages)}toChatMessages(){return this.messages}},XS=class extends id{constructor(e){"imageUrl"in e||(e={imageUrl:e});super(e);p(this,"lc_namespace",["langchain_core","prompt_values"]);p(this,"lc_serializable",!0);p(this,"imageUrl");p(this,"value");this.imageUrl=e.imageUrl}static lc_name(){return"ImagePromptValue"}toString(){return this.imageUrl.url}toChatMessages(){return[new It({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}},YS={};ve(YS,{BaseStore:()=>QS,InMemoryStore:()=>SL});var QS=class extends sr{},SL=class extends QS{constructor(){super(...arguments);p(this,"lc_namespace",["langchain","storage"]);p(this,"store",{})}async mget(e){return e.map(n=>this.store[n])}async mset(e){for(const[n,r]of e)this.store[n]=r}async mdelete(e){for(const n of e)delete this.store[n]}async*yieldKeys(e){const n=Object.keys(this.store);for(const r of n)(e===void 0||r.startsWith(e))&&(yield r)}},ex={};ve(ex,{BaseRetriever:()=>gg});var gg=class extends je{constructor(e){super(e);p(this,"callbacks");p(this,"tags");p(this,"metadata");p(this,"verbose");this.callbacks=e==null?void 0:e.callbacks,this.tags=(e==null?void 0:e.tags)??[],this.metadata=(e==null?void 0:e.metadata)??{},this.verbose=(e==null?void 0:e.verbose)??!1}_getRelevantDocuments(e,n){throw new Error("Not implemented!")}async invoke(e,n){const r=ze(cc(n)),s=await hn.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),i=await(s==null?void 0:s.handleRetrieverStart(this.toJSON(),e,r.runId,void 0,void 0,void 0,r.runName));try{const a=await this._getRelevantDocuments(e,i);return await(i==null?void 0:i.handleRetrieverEnd(a)),a}catch(a){throw await(i==null?void 0:i.handleRetrieverError(a)),a}}},tx={};ve(tx,{SaveableVectorStore:()=>xL,VectorStore:()=>yg,VectorStoreRetriever:()=>yu});var yu=class extends gg{constructor(e){super(e);p(this,"vectorStore");p(this,"k",4);p(this,"searchType","similarity");p(this,"searchKwargs");p(this,"filter");this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,e.searchType==="mmr"&&(this.searchKwargs=e.searchKwargs)}static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}async _getRelevantDocuments(e,n){if(this.searchType==="mmr"){if(typeof this.vectorStore.maxMarginalRelevanceSearch!="function")throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},n==null?void 0:n.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,n==null?void 0:n.getChild("vectorstore"))}async addDocuments(e,n){return this.vectorStore.addDocuments(e,n)}},yg=class extends sr{constructor(e,n){super(n);p(this,"lc_namespace",["langchain","vectorstores",this._vectorstoreType()]);p(this,"embeddings");this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,n=4,r=void 0,s=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),n,r)).map(a=>a[0])}async similaritySearchWithScore(e,n=4,r=void 0,s=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),n,r)}static fromTexts(e,n,r,s){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,n,r){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,n,r,s,i,a){if(typeof e=="number")return new yu({vectorStore:this,k:e,filter:n,tags:[...s??[],this._vectorstoreType()],metadata:i,verbose:a,callbacks:r});{const o={vectorStore:this,k:e==null?void 0:e.k,filter:e==null?void 0:e.filter,tags:[...(e==null?void 0:e.tags)??[],this._vectorstoreType()],metadata:e==null?void 0:e.metadata,verbose:e==null?void 0:e.verbose,callbacks:e==null?void 0:e.callbacks,searchType:e==null?void 0:e.searchType};return(e==null?void 0:e.searchType)==="mmr"?new yu({...o,searchKwargs:e.searchKwargs}):new yu({...o})}}},xL=class extends yg{static load(t,e){throw new Error("Not implemented")}},ce="0123456789abcdef".split(""),TL=[-2147483648,8388608,32768,128],lr=[24,16,8,0],Fc=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],Nt=[];function Er(t,e){e?(Nt[0]=Nt[16]=Nt[1]=Nt[2]=Nt[3]=Nt[4]=Nt[5]=Nt[6]=Nt[7]=Nt[8]=Nt[9]=Nt[10]=Nt[11]=Nt[12]=Nt[13]=Nt[14]=Nt[15]=0,this.blocks=Nt):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=t}Er.prototype.update=function(t){if(!this.finalized){var e,n=typeof t;if(n!=="string"){if(n==="object"){if(t===null)throw new Error(ERROR);if(ARRAY_BUFFER&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!Array.isArray(t)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(t)))throw new Error(ERROR)}else throw new Error(ERROR);e=!0}for(var r,s=0,i,a=t.length,o=this.blocks;s<a;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),e)for(i=this.start;s<a&&i<64;++s)o[i>>>2]|=t[s]<<lr[i++&3];else for(i=this.start;s<a&&i<64;++s)r=t.charCodeAt(s),r<128?o[i>>>2]|=r<<lr[i++&3]:r<2048?(o[i>>>2]|=(192|r>>>6)<<lr[i++&3],o[i>>>2]|=(128|r&63)<<lr[i++&3]):r<55296||r>=57344?(o[i>>>2]|=(224|r>>>12)<<lr[i++&3],o[i>>>2]|=(128|r>>>6&63)<<lr[i++&3],o[i>>>2]|=(128|r&63)<<lr[i++&3]):(r=65536+((r&1023)<<10|t.charCodeAt(++s)&1023),o[i>>>2]|=(240|r>>>18)<<lr[i++&3],o[i>>>2]|=(128|r>>>12&63)<<lr[i++&3],o[i>>>2]|=(128|r>>>6&63)<<lr[i++&3],o[i>>>2]|=(128|r&63)<<lr[i++&3]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=o[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Er.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>>2]|=TL[e&3],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}};Er.prototype.hash=function(){var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=this.blocks,u,l,d,h,f,m,g,_,b,y,E;for(u=16;u<64;++u)f=c[u-15],l=(f>>>7|f<<25)^(f>>>18|f<<14)^f>>>3,f=c[u-2],d=(f>>>17|f<<15)^(f>>>19|f<<13)^f>>>10,c[u]=c[u-16]+l+c[u-7]+d<<0;for(E=e&n,u=0;u<64;u+=4)this.first?(this.is224?(_=300032,f=c[0]-1413257819,o=f-150054599<<0,r=f+24177077<<0):(_=704751109,f=c[0]-210244248,o=f-1521486534<<0,r=f+143694565<<0),this.first=!1):(l=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),d=(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7),_=t&e,h=_^t&n^E,g=s&i^~s&a,f=o+d+g+Fc[u]+c[u],m=l+h,o=r+f<<0,r=f+m<<0),l=(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10),d=(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7),b=r&t,h=b^r&e^_,g=a&o^~a&s,f=i+d+g+Fc[u+1]+c[u+1],m=l+h,a=n+f<<0,n=f+m<<0,l=(n>>>2|n<<30)^(n>>>13|n<<19)^(n>>>22|n<<10),d=(a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7),y=n&r,h=y^n&t^b,g=i&a^~i&o,f=s+d+g+Fc[u+2]+c[u+2],m=l+h,i=e+f<<0,e=f+m<<0,l=(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10),d=(i>>>6|i<<26)^(i>>>11|i<<21)^(i>>>25|i<<7),E=e&n,h=E^e&r^y,g=i&a^~i&o,f=s+d+g+Fc[u+3]+c[u+3],m=l+h,s=t+f<<0,t=f+m<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+t<<0,this.h1=this.h1+e<<0,this.h2=this.h2+n<<0,this.h3=this.h3+r<<0,this.h4=this.h4+s<<0,this.h5=this.h5+i<<0,this.h6=this.h6+a<<0,this.h7=this.h7+o<<0};Er.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=ce[t>>>28&15]+ce[t>>>24&15]+ce[t>>>20&15]+ce[t>>>16&15]+ce[t>>>12&15]+ce[t>>>8&15]+ce[t>>>4&15]+ce[t&15]+ce[e>>>28&15]+ce[e>>>24&15]+ce[e>>>20&15]+ce[e>>>16&15]+ce[e>>>12&15]+ce[e>>>8&15]+ce[e>>>4&15]+ce[e&15]+ce[n>>>28&15]+ce[n>>>24&15]+ce[n>>>20&15]+ce[n>>>16&15]+ce[n>>>12&15]+ce[n>>>8&15]+ce[n>>>4&15]+ce[n&15]+ce[r>>>28&15]+ce[r>>>24&15]+ce[r>>>20&15]+ce[r>>>16&15]+ce[r>>>12&15]+ce[r>>>8&15]+ce[r>>>4&15]+ce[r&15]+ce[s>>>28&15]+ce[s>>>24&15]+ce[s>>>20&15]+ce[s>>>16&15]+ce[s>>>12&15]+ce[s>>>8&15]+ce[s>>>4&15]+ce[s&15]+ce[i>>>28&15]+ce[i>>>24&15]+ce[i>>>20&15]+ce[i>>>16&15]+ce[i>>>12&15]+ce[i>>>8&15]+ce[i>>>4&15]+ce[i&15]+ce[a>>>28&15]+ce[a>>>24&15]+ce[a>>>20&15]+ce[a>>>16&15]+ce[a>>>12&15]+ce[a>>>8&15]+ce[a>>>4&15]+ce[a&15];return this.is224||(c+=ce[o>>>28&15]+ce[o>>>24&15]+ce[o>>>20&15]+ce[o>>>16&15]+ce[o>>>12&15]+ce[o>>>8&15]+ce[o>>>4&15]+ce[o&15]),c};Er.prototype.toString=Er.prototype.hex;Er.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=[t>>>24&255,t>>>16&255,t>>>8&255,t&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255,i>>>24&255,i>>>16&255,i>>>8&255,i&255,a>>>24&255,a>>>16&255,a>>>8&255,a&255];return this.is224||c.push(o>>>24&255,o>>>16&255,o>>>8&255,o&255),c};Er.prototype.array=Er.prototype.digest;Er.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(this.is224?28:32),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),e.setUint32(20,this.h5),e.setUint32(24,this.h6),this.is224||e.setUint32(28,this.h7),t};const _g=(...t)=>new Er(!1,!0).update(t.join("")).hex();var nx={};ve(nx,{sha256:()=>_g});var rx={};ve(rx,{BaseCache:()=>ix,InMemoryCache:()=>ax,defaultHashKeyEncoder:()=>sx,deserializeStoredGeneration:()=>AL,serializeGeneration:()=>CL});const sx=(...t)=>_g(t.join("_"));function AL(t){return t.message!==void 0?{text:t.text,message:Xm(t.message)}:{text:t.text}}function CL(t){const e={text:t.text};return t.message!==void 0&&(e.message=t.message.toDict()),e}var ix=class{constructor(){p(this,"keyEncoder",sx)}makeDefaultKeyEncoder(e){this.keyEncoder=e}};const kL=new Map;var ax=class ox extends ix{constructor(n){super();p(this,"cache");this.cache=n??new Map}lookup(n,r){return Promise.resolve(this.cache.get(this.keyEncoder(n,r))??null)}async update(n,r,s){this.cache.set(this.keyEncoder(n,r),s)}static global(){return new ox(kL)}},cx={};ve(cx,{BaseDocumentLoader:()=>ux});var ux=class{},lx={};ve(lx,{LangSmithLoader:()=>IL});var IL=class extends ux{constructor(e){super();p(this,"datasetId");p(this,"datasetName");p(this,"exampleIds");p(this,"asOf");p(this,"splits");p(this,"inlineS3Urls");p(this,"offset");p(this,"limit");p(this,"metadata");p(this,"filter");p(this,"contentKey");p(this,"formatContent");p(this,"client");if(e.client&&e.clientConfig)throw new Error("client and clientConfig cannot both be provided.");this.client=e.client??new Gm(e==null?void 0:e.clientConfig),this.contentKey=e.contentKey?e.contentKey.split("."):[],this.formatContent=e.formatContent??RL,this.datasetId=e.datasetId,this.datasetName=e.datasetName,this.exampleIds=e.exampleIds,this.asOf=e.asOf,this.splits=e.splits,this.inlineS3Urls=e.inlineS3Urls,this.offset=e.offset,this.limit=e.limit,this.metadata=e.metadata,this.filter=e.filter}async load(){const e=[];for await(const n of this.client.listExamples({datasetId:this.datasetId,datasetName:this.datasetName,exampleIds:this.exampleIds,asOf:this.asOf,splits:this.splits,inlineS3Urls:this.inlineS3Urls,offset:this.offset,limit:this.limit,metadata:this.metadata,filter:this.filter})){let r=n.inputs;for(const a of this.contentKey)r=r[a];const s=this.formatContent(r),i=n;["created_at","modified_at"].forEach(a=>{a in i&&typeof i[a]=="object"&&(i[a]=i[a].toString())}),e.push({pageContent:s,metadata:i})}return e}};function RL(t){if(typeof t=="string")return t;try{return JSON.stringify(t,null,2)}catch{return String(t)}}var Ms=class{constructor(t){p(this,"pageContent");p(this,"metadata");p(this,"id");this.pageContent=t.pageContent!==void 0?t.pageContent.toString():"",this.metadata=t.metadata??{},this.id=t.id}},dx=class extends je{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","documents","transformers"])}invoke(e,n){return this.transformDocuments(e)}},OL=class extends dx{async transformDocuments(t){const e=[];for(const n of t){const r=await this._transformDocument(n);e.push(r)}return e}},hx={};ve(hx,{BaseDocumentTransformer:()=>dx,Document:()=>Ms,MappingDocumentTransformer:()=>OL});var wg=class extends sr{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","example_selectors","base"])}},fx=class{async getPromptAsync(t,e){return this.getPrompt(t).partial((e==null?void 0:e.partialVariables)??{})}},$L=class extends fx{constructor(e,n=[]){super();p(this,"defaultPrompt");p(this,"conditionals");this.defaultPrompt=e,this.conditionals=n}getPrompt(e){for(const[n,r]of this.conditionals)if(n(e))return r;return this.defaultPrompt}};function NL(t){return t._modelType()==="base_llm"}function PL(t){return t._modelType()==="base_chat_model"}function cb(t){return t.split(/\n| /).length}var LL=class px extends wg{constructor(n){super(n);p(this,"examples",[]);p(this,"examplePrompt");p(this,"getTextLength",cb);p(this,"maxLength",2048);p(this,"exampleTextLengths",[]);this.examplePrompt=n.examplePrompt,this.maxLength=n.maxLength??2048,this.getTextLength=n.getTextLength??cb}async addExample(n){this.examples.push(n);const r=await this.examplePrompt.format(n);this.exampleTextLengths.push(this.getTextLength(r))}async calculateExampleTextLengths(n,r){if(n.length>0)return n;const{examples:s,examplePrompt:i}=r;return(await Promise.all(s.map(o=>i.format(o)))).map(o=>this.getTextLength(o))}async selectExamples(n){const r=Object.values(n).join(" ");let s=this.maxLength-this.getTextLength(r),i=0;const a=[];for(;s>0&&i<this.examples.length;){const o=s-this.exampleTextLengths[i];if(o<0)break;a.push(this.examples[i]),s=o,i+=1}return a}static async fromExamples(n,r){const s=new px(r);return await Promise.all(n.map(i=>s.addExample(i))),s}};function af(t){return Object.keys(t).sort().map(e=>t[e])}var ML=class mx extends wg{constructor(n){super(n);p(this,"vectorStoreRetriever");p(this,"exampleKeys");p(this,"inputKeys");if(this.exampleKeys=n.exampleKeys,this.inputKeys=n.inputKeys,n.vectorStore!==void 0)this.vectorStoreRetriever=n.vectorStore.asRetriever({k:n.k??4,filter:n.filter});else if(n.vectorStoreRetriever)this.vectorStoreRetriever=n.vectorStoreRetriever;else throw new Error('You must specify one of "vectorStore" and "vectorStoreRetriever".')}async addExample(n){const r=this.inputKeys??Object.keys(n),s=af(r.reduce((i,a)=>({...i,[a]:n[a]}),{})).join(" ");await this.vectorStoreRetriever.addDocuments([new Ms({pageContent:s,metadata:n})])}async selectExamples(n){const r=this.inputKeys??Object.keys(n),s=af(r.reduce((o,c)=>({...o,[c]:n[c]}),{})).join(" "),a=(await this.vectorStoreRetriever.invoke(s)).map(o=>o.metadata);return this.exampleKeys?a.map(o=>this.exampleKeys.reduce((c,u)=>({...c,[u]:o[u]}),{})):a}static async fromExamples(n,r,s,i={}){const a=i.inputKeys??null,o=n.map(u=>af(a?a.reduce((l,d)=>({...l,[d]:u[d]}),{}):u).join(" ")),c=await s.fromTexts(o,n,r,i);return new mx({vectorStore:c,k:i.k??4,exampleKeys:i.exampleKeys,inputKeys:i.inputKeys})}},gx={};ve(gx,{BaseExampleSelector:()=>wg,BasePromptSelector:()=>fx,ConditionalPromptSelector:()=>$L,LengthBasedExampleSelector:()=>LL,SemanticSimilarityExampleSelector:()=>ML,isChatModel:()=>PL,isLLM:()=>NL});const Tp="10f90ea3-90a4-4962-bf75-83a0f3c1c62a";var DL=class extends sr{constructor(){super(...arguments);p(this,"lc_namespace",["langchain","recordmanagers"])}},yx=class{constructor(t){p(this,"uid");p(this,"hash_");p(this,"contentHash");p(this,"metadataHash");p(this,"pageContent");p(this,"metadata");p(this,"keyEncoder",_g);this.uid=t.uid,this.pageContent=t.pageContent,this.metadata=t.metadata}makeDefaultKeyEncoder(t){this.keyEncoder=t}calculateHashes(){const t=["hash_","content_hash","metadata_hash"];for(const n of t)if(n in this.metadata)throw new Error(`Metadata cannot contain key ${n} as it is reserved for internal use. Restricted keys: [${t.join(", ")}]`);const e=this._hashStringToUUID(this.pageContent);try{const n=this._hashNestedDictToUUID(this.metadata);this.contentHash=e,this.metadataHash=n}catch(n){throw new Error(`Failed to hash metadata: ${n}. Please use a dict that can be serialized using json.`)}this.hash_=this._hashStringToUUID(this.contentHash+this.metadataHash),this.uid||(this.uid=this.hash_)}toDocument(){return new Ms({pageContent:this.pageContent,metadata:this.metadata})}static fromDocument(t,e){const n=new this({pageContent:t.pageContent,metadata:t.metadata,uid:e||t.uid});return n.calculateHashes(),n}_hashStringToUUID(t){const e=this.keyEncoder(t);return Ky(e,Tp)}_hashNestedDictToUUID(t){const e=JSON.stringify(t,Object.keys(t).sort()),n=this.keyEncoder(e);return Ky(n,Tp)}};function _x(t,e){const n=[];let r=[];return e.forEach(s=>{r.push(s),r.length>=t&&(n.push(r),r=[])}),r.length>0&&n.push(r),n}function wx(t){const e=new Set,n=[];for(const r of t){if(!r.hash_)throw new Error("Hashed document does not have a hash");e.has(r.hash_)||(e.add(r.hash_),n.push(r))}return n}function bx(t){if(t===null)return e=>null;if(typeof t=="string")return e=>e.metadata[t];if(typeof t=="function")return t;throw new Error(`sourceIdKey should be null, a string or a function, got ${typeof t}`)}const vx=t=>"load"in t&&typeof t.load=="function"&&"loadAndSplit"in t&&typeof t.loadAndSplit=="function";async function UL(t){const{docsSource:e,recordManager:n,vectorStore:r,options:s}=t,{batchSize:i=100,cleanup:a,sourceIdKey:o,cleanupBatchSize:c=1e3,forceUpdate:u=!1}=s??{};if(a==="incremental"&&!o)throw new Error("sourceIdKey is required when cleanup mode is incremental. Please provide through 'options.sourceIdKey'.");const l=vx(e)?await e.load():e,d=bx(o??null),h=await n.getTime();let f=0,m=0,g=0,_=0;const b=_x(i??100,l);for(const y of b){const E=wx(y.map(z=>yx.fromDocument(z))),C=E.map(z=>d(z));a==="incremental"&&E.forEach((z,q)=>{if(C[q]===null)throw new Error("sourceIdKey must be provided when cleanup is incremental")});const k=await n.exists(E.map(z=>z.uid)),R=[],$=[],T=[],B=new Set;if(E.forEach((z,q)=>{if(k[q])if(u)B.add(z.uid);else{T.push(z.uid);return}R.push(z.uid),$.push(z.toDocument())}),T.length>0&&(await n.update(T,{timeAtLeast:h}),_+=T.length),$.length>0&&(await r.addDocuments($,{ids:R}),f+=$.length-B.size,g+=B.size),await n.update(E.map(z=>z.uid),{timeAtLeast:h,groupIds:C}),a==="incremental"){C.forEach(q=>{if(!q)throw new Error("Source id cannot be null")});const z=await n.listKeys({before:h,groupIds:C});z.length>0&&(await r.delete({ids:z}),await n.deleteKeys(z),m+=z.length)}}if(a==="full"){let y=await n.listKeys({before:h,limit:c});for(;y.length>0;)await r.delete({ids:y}),await n.deleteKeys(y),m+=y.length,y=await n.listKeys({before:h,limit:c})}return{numAdded:f,numDeleted:m,numUpdated:g,numSkipped:_}}var Ex={};ve(Ex,{RecordManager:()=>DL,UUIDV5_NAMESPACE:()=>Tp,_HashedDocument:()=>yx,_batch:()=>_x,_deduplicateInOrder:()=>wx,_getSourceIdAssigner:()=>bx,_isBaseDocumentLoader:()=>vx,index:()=>UL});var Va={},ub;function BL(){if(ub)return Va;ub=1,Va.byteLength=o,Va.toByteArray=u,Va.fromByteArray=h;for(var t=[],e=[],n=typeof Uint8Array<"u"?Uint8Array:Array,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,i=r.length;s<i;++s)t[s]=r[s],e[r.charCodeAt(s)]=s;e[45]=62,e[95]=63;function a(f){var m=f.length;if(m%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var g=f.indexOf("=");g===-1&&(g=m);var _=g===m?0:4-g%4;return[g,_]}function o(f){var m=a(f),g=m[0],_=m[1];return(g+_)*3/4-_}function c(f,m,g){return(m+g)*3/4-g}function u(f){var m,g=a(f),_=g[0],b=g[1],y=new n(c(f,_,b)),E=0,C=b>0?_-4:_,k;for(k=0;k<C;k+=4)m=e[f.charCodeAt(k)]<<18|e[f.charCodeAt(k+1)]<<12|e[f.charCodeAt(k+2)]<<6|e[f.charCodeAt(k+3)],y[E++]=m>>16&255,y[E++]=m>>8&255,y[E++]=m&255;return b===2&&(m=e[f.charCodeAt(k)]<<2|e[f.charCodeAt(k+1)]>>4,y[E++]=m&255),b===1&&(m=e[f.charCodeAt(k)]<<10|e[f.charCodeAt(k+1)]<<4|e[f.charCodeAt(k+2)]>>2,y[E++]=m>>8&255,y[E++]=m&255),y}function l(f){return t[f>>18&63]+t[f>>12&63]+t[f>>6&63]+t[f&63]}function d(f,m,g){for(var _,b=[],y=m;y<g;y+=3)_=(f[y]<<16&16711680)+(f[y+1]<<8&65280)+(f[y+2]&255),b.push(l(_));return b.join("")}function h(f){for(var m,g=f.length,_=g%3,b=[],y=16383,E=0,C=g-_;E<C;E+=y)b.push(d(f,E,E+y>C?C:E+y));return _===1?(m=f[g-1],b.push(t[m>>2]+t[m<<4&63]+"==")):_===2&&(m=(f[g-2]<<8)+f[g-1],b.push(t[m>>10]+t[m>>4&63]+t[m<<2&63]+"=")),b.join("")}return Va}var jL=BL();const FL=Ra(jL);var zL=Object.defineProperty,VL=(t,e,n)=>e in t?zL(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,qL=(t,e,n)=>(VL(t,e+"",n),n);function HL(t,e){let n=Array.from({length:t.length},(r,s)=>({start:s,end:s+1}));for(;n.length>1;){let r=null;for(let s=0;s<n.length-1;s++){const i=t.slice(n[s].start,n[s+1].end),a=e.get(i.join(","));a!=null&&(r==null||a<r[0])&&(r=[a,s])}if(r!=null){const s=r[1];n[s]={start:n[s].start,end:n[s+1].end},n.splice(s+1,1)}else break}return n}function GL(t,e){return t.length===1?[e.get(t.join(","))]:HL(t,e).map(n=>e.get(t.slice(n.start,n.end).join(","))).filter(n=>n!=null)}function WL(t){return t.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Ap=class{constructor(t,e){p(this,"specialTokens");p(this,"inverseSpecialTokens");p(this,"patStr");p(this,"textEncoder",new TextEncoder);p(this,"textDecoder",new TextDecoder("utf-8"));p(this,"rankMap",new Map);p(this,"textMap",new Map);this.patStr=t.pat_str;const n=t.bpe_ranks.split(`
`).filter(Boolean).reduce((r,s)=>{const[i,a,...o]=s.split(" "),c=Number.parseInt(a,10);return o.forEach((u,l)=>r[u]=c+l),r},{});for(const[r,s]of Object.entries(n)){const i=FL.toByteArray(r);this.rankMap.set(i.join(","),s),this.textMap.set(s,i)}this.specialTokens={...t.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[s,i])=>(r[i]=this.textEncoder.encode(s),r),{})}encode(t,e=[],n="all"){const r=new RegExp(this.patStr,"ug"),s=Ap.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(n==="all"?Object.keys(this.specialTokens).filter(u=>!a.has(u)):n);if(o.size>0){const u=Ap.specialTokenRegex([...o]),l=t.match(u);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let c=0;for(;;){let u=null,l=c;for(;s.lastIndex=l,u=s.exec(t),!(u==null||a.has(u[0]));)l=u.index+1;const d=(u==null?void 0:u.index)??t.length;for(const f of t.substring(c,d).matchAll(r)){const m=this.textEncoder.encode(f[0]),g=this.rankMap.get(m.join(","));if(g!=null){i.push(g);continue}i.push(...GL(m,this.rankMap))}if(u==null)break;let h=this.specialTokens[u[0]];i.push(h),c=u.index+u[0].length}return i}decode(t){const e=[];let n=0;for(let i=0;i<t.length;++i){const a=t[i],o=this.textMap.get(a)??this.inverseSpecialTokens[a];o!=null&&(e.push(o),n+=o.length)}const r=new Uint8Array(n);let s=0;for(const i of e)r.set(i,s),s+=i.length;return this.textDecoder.decode(r)}},Sx=Ap;qL(Sx,"specialTokenRegex",t=>new RegExp(t.map(e=>WL(e)).join("|"),"g"));function JL(t){switch(t){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}var xx={};ve(xx,{encodingForModel:()=>bg,getEncoding:()=>Tx});const zc={},ZL=new lc({});async function Tx(t){return t in zc||(zc[t]=ZL.fetch(`https://tiktoken.pages.dev/js/${t}.json`).then(e=>e.json()).then(e=>new Sx(e)).catch(e=>{throw delete zc[t],e})),await zc[t]}async function bg(t){return Tx(JL(t))}var Ax={};ve(Ax,{BaseLangChain:()=>vg,BaseLanguageModel:()=>Eg,calculateMaxTokens:()=>XL,getEmbeddingContextSize:()=>KL,getModelContextSize:()=>Cx,getModelNameForTiktoken:()=>ad,isOpenAITool:()=>od});const ad=t=>t.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":t.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":t.startsWith("gpt-4-32k")?"gpt-4-32k":t.startsWith("gpt-4-")?"gpt-4":t.startsWith("gpt-4o")?"gpt-4o":t,KL=t=>{switch(t){case"text-embedding-ada-002":return 8191;default:return 2046}},Cx=t=>{switch(ad(t)){case"gpt-3.5-turbo-16k":return 16384;case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":return 4097;case"text-curie-001":return 2048;case"text-babbage-001":return 2048;case"text-ada-001":return 2048;case"code-davinci-002":return 8e3;case"code-cushman-001":return 2048;default:return 4097}};function od(t){return typeof t!="object"||!t?!1:!!("type"in t&&t.type==="function"&&"function"in t&&typeof t.function=="object"&&t.function&&"name"in t.function&&"parameters"in t.function)}const XL=async({prompt:t,modelName:e})=>{let n;try{n=(await bg(ad(e))).encode(t).length}catch{console.warn("Failed to calculate number of tokens, falling back to approximate count"),n=Math.ceil(t.length/4)}return Cx(e)-n},YL=()=>!1;var vg=class extends je{constructor(e){super(e);p(this,"verbose");p(this,"callbacks");p(this,"tags");p(this,"metadata");this.verbose=e.verbose??YL(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}get lc_attributes(){return{callbacks:void 0,verbose:void 0}}},Eg=class extends vg{constructor({callbacks:e,callbackManager:n,...r}){const{cache:s,...i}=r;super({callbacks:e??n,...i});p(this,"caller");p(this,"cache");p(this,"_encoding");typeof s=="object"?this.cache=s:s?this.cache=ax.global():this.cache=void 0,this.caller=new lc(r??{})}get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}async getNumTokens(e){let n;typeof e=="string"?n=e:n=e.map(s=>typeof s=="string"?s:s.type==="text"&&"text"in s?s.text:"").join("");let r=Math.ceil(n.length/4);if(!this._encoding)try{this._encoding=await bg("modelName"in this?ad(this.modelName):"gpt2")}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}if(this._encoding)try{r=this._encoding.encode(n).length}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}return r}static _convertInputToPromptValue(e){return typeof e=="string"?new pg(e):Array.isArray(e)?new mg(e.map(Vr)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...n}){const r={...this._identifyingParams(),...n,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([a,o])=>o!==void 0).map(([a,o])=>`${a}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}},ms=class extends je{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"func");e&&(this.func=e.func)}static lc_name(){return"RunnablePassthrough"}async invoke(e,n){const r=ze(n);return this.func&&await this.func(e,r),this._callWithConfig(s=>Promise.resolve(s),e,r)}async*transform(e,n){const r=ze(n);let s,i=!0;for await(const a of this._transformStreamWithConfig(e,o=>o,r))if(yield a,i)if(s===void 0)s=a;else try{s=zs(s,a)}catch{s=void 0,i=!1}this.func&&s!==void 0&&await this.func(s,r)}static assign(e){return new lg(new Pa({steps:e}))}};const QL=t=>t();function of(t){const e=t.constructor;return new e({...t,content:t.contentBlocks,response_metadata:{...t.response_metadata,output_version:"v1"}})}var kx={};ve(kx,{BaseChatModel:()=>Pi,SimpleChatModel:()=>eM});function cf(t){const e=[];for(const n of t){let r=n;if(Array.isArray(n.content))for(let s=0;s<n.content.length;s++){const i=n.content[s];(Om(i)||$m(i))&&r===n&&(r=new n.constructor({...r,content:[...n.content.slice(0,s),Zv(i),...n.content.slice(s+1)]}))}e.push(r)}return e}var Pi=class ei extends Eg{constructor(n){super(n);p(this,"lc_namespace",["langchain","chat_models",this._llmType()]);p(this,"disableStreaming",!1);p(this,"outputVersion");this.outputVersion=QL(()=>{const r=n.outputVersion??nr("LC_OUTPUT_VERSION");return r&&["v0","v1"].includes(r)?r:"v0"})}get callKeys(){return[...super.callKeys,"outputVersion"]}_separateRunnableConfigFromCallOptionsCompat(n){const[r,s]=super._separateRunnableConfigFromCallOptions(n);return s.signal=r.signal,[r,s]}async invoke(n,r){const s=ei._convertInputToPromptValue(n);return(await this.generatePrompt([s],r,r==null?void 0:r.callbacks)).generations[0][0].message}async*_streamResponseChunks(n,r,s){throw new Error("Not implemented.")}async*_streamIterator(n,r){var s;if(this._streamResponseChunks===ei.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(n,r);else{const a=ei._convertInputToPromptValue(n).toChatMessages(),[o,c]=this._separateRunnableConfigFromCallOptionsCompat(r),u={...o.metadata,...this.getLsParams(c)},l=await hn.configure(o.callbacks,this.callbacks,o.tags,this.tags,u,this.metadata,{verbose:this.verbose}),d={options:c,invocation_params:this==null?void 0:this.invocationParams(c),batch_size:1},h=c.outputVersion??this.outputVersion,f=await(l==null?void 0:l.handleChatModelStart(this.toJSON(),[cf(a)],o.runId,void 0,d,void 0,void 0,o.runName));let m,g;try{for await(const _ of this._streamResponseChunks(a,c,f==null?void 0:f[0])){if(_.message.id==null){const b=(s=f==null?void 0:f.at(0))==null?void 0:s.runId;b!=null&&_.message._updateId(`run-${b}`)}_.message.response_metadata={..._.generationInfo,..._.message.response_metadata},h==="v1"?yield of(_.message):yield _.message,m?m=m.concat(_):m=_,rp(_.message)&&_.message.usage_metadata!==void 0&&(g={tokenUsage:{promptTokens:_.message.usage_metadata.input_tokens,completionTokens:_.message.usage_metadata.output_tokens,totalTokens:_.message.usage_metadata.total_tokens}})}}catch(_){throw await Promise.all((f??[]).map(b=>b==null?void 0:b.handleLLMError(_))),_}await Promise.all((f??[]).map(_=>_==null?void 0:_.handleLLMEnd({generations:[[m]],llmOutput:g})))}}getLsParams(n){const r=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:n.stop,ls_provider:r}}async _generateUncached(n,r,s,i){var f,m;const a=n.map(g=>g.map(Vr));let o;if(i!==void 0&&i.length===a.length)o=i;else{const g={...s.metadata,...this.getLsParams(r)},_=await hn.configure(s.callbacks,this.callbacks,s.tags,this.tags,g,this.metadata,{verbose:this.verbose}),b={options:r,invocation_params:this==null?void 0:this.invocationParams(r),batch_size:1};o=await(_==null?void 0:_.handleChatModelStart(this.toJSON(),a.map(cf),s.runId,void 0,b,void 0,void 0,s.runName))}const c=r.outputVersion??this.outputVersion,u=[],l=[];if(!!(o!=null&&o[0].handlers.find(Um))&&!this.disableStreaming&&a.length===1&&this._streamResponseChunks!==ei.prototype._streamResponseChunks)try{const g=await this._streamResponseChunks(a[0],r,o==null?void 0:o[0]);let _,b;for await(const y of g){if(y.message.id==null){const E=(f=o==null?void 0:o.at(0))==null?void 0:f.runId;E!=null&&y.message._updateId(`run-${E}`)}_===void 0?_=y:_=zs(_,y),rp(y.message)&&y.message.usage_metadata!==void 0&&(b={tokenUsage:{promptTokens:y.message.usage_metadata.input_tokens,completionTokens:y.message.usage_metadata.output_tokens,totalTokens:y.message.usage_metadata.total_tokens}})}if(_===void 0)throw new Error("Received empty response from chat model call.");u.push([_]),await(o==null?void 0:o[0].handleLLMEnd({generations:u,llmOutput:b}))}catch(g){throw await(o==null?void 0:o[0].handleLLMError(g)),g}else{const g=await Promise.allSettled(a.map(async(_,b)=>{const y=await this._generate(_,{...r,promptIndex:b},o==null?void 0:o[b]);if(c==="v1")for(const E of y.generations)E.message=of(E.message);return y}));await Promise.all(g.map(async(_,b)=>{var y,E,C;if(_.status==="fulfilled"){const k=_.value;for(const R of k.generations){if(R.message.id==null){const $=(y=o==null?void 0:o.at(0))==null?void 0:y.runId;$!=null&&R.message._updateId(`run-${$}`)}R.message.response_metadata={...R.generationInfo,...R.message.response_metadata}}return k.generations.length===1&&(k.generations[0].message.response_metadata={...k.llmOutput,...k.generations[0].message.response_metadata}),u[b]=k.generations,l[b]=k.llmOutput,(E=o==null?void 0:o[b])==null?void 0:E.handleLLMEnd({generations:[k.generations],llmOutput:k.llmOutput})}else return await((C=o==null?void 0:o[b])==null?void 0:C.handleLLMError(_.reason)),Promise.reject(_.reason)}))}const h={generations:u,llmOutput:l.length?(m=this._combineLLMOutput)==null?void 0:m.call(this,...l):void 0};return Object.defineProperty(h,Oo,{value:o?{runIds:o==null?void 0:o.map(g=>g.runId)}:void 0,configurable:!0}),h}async _generateCached({messages:n,cache:r,llmStringKey:s,parsedOptions:i,handledOptions:a}){const o=n.map(y=>y.map(Vr)),c={...a.metadata,...this.getLsParams(i)},u=await hn.configure(a.callbacks,this.callbacks,a.tags,this.tags,c,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},d=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),o.map(cf),a.runId,void 0,l,void 0,void 0,a.runName)),h=[],m=(await Promise.allSettled(o.map(async(y,E)=>{const C=ei._convertInputToPromptValue(y).toString(),k=await r.lookup(C,s);return k==null&&h.push(E),k}))).map((y,E)=>({result:y,runManager:d==null?void 0:d[E]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),g=i.outputVersion??this.outputVersion,_=[];await Promise.all(m.map(async({result:y,runManager:E},C)=>{if(y.status==="fulfilled"){const k=y.value;return _[C]=k.map(R=>("message"in R&&Lt(R.message)&&$i(R.message)&&(R.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0},g==="v1"&&(R.message=of(R.message))),R.generationInfo={...R.generationInfo,tokenUsage:{}},R)),k.length&&await(E==null?void 0:E.handleLLMNewToken(k[0].text)),E==null?void 0:E.handleLLMEnd({generations:[k]},void 0,void 0,void 0,{cached:!0})}else return await(E==null?void 0:E.handleLLMError(y.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(y.reason)}));const b={generations:_,missingPromptIndices:h,startedRunManagers:d};return Object.defineProperty(b,Oo,{value:d?{runIds:d==null?void 0:d.map(y=>y.runId)}:void 0,configurable:!0}),b}async generate(n,r,s){let i;Array.isArray(r)?i={stop:r}:i=r;const a=n.map(g=>g.map(Vr)),[o,c]=this._separateRunnableConfigFromCallOptionsCompat(i);if(o.callbacks=o.callbacks??s,!this.cache)return this._generateUncached(a,c,o);const{cache:u}=this,l=this._getSerializedCacheKeyParametersForCall(c),{generations:d,missingPromptIndices:h,startedRunManagers:f}=await this._generateCached({messages:a,cache:u,llmStringKey:l,parsedOptions:c,handledOptions:o});let m={};if(h.length>0){const g=await this._generateUncached(h.map(_=>a[_]),c,o,f!==void 0?h.map(_=>f==null?void 0:f[_]):void 0);await Promise.all(g.generations.map(async(_,b)=>{const y=h[b];d[y]=_;const E=ei._convertInputToPromptValue(a[y]).toString();return u.update(E,l,_)})),m=g.llmOutput??{}}return{generations:d,llmOutput:m}}invocationParams(n){return{}}_modelType(){return"base_chat_model"}async generatePrompt(n,r,s){const i=n.map(a=>a.toChatMessages());return this.generate(i,r,s)}withStructuredOutput(n,r){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(r!=null&&r.strict)throw new Error('"strict" mode is not supported for this model by default.');const s=n,i=r==null?void 0:r.name,a=xi(s)??"A function available to call.",o=r==null?void 0:r.method,c=r==null?void 0:r.includeRaw;if(o==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=i??"extract",l;tr(s)?l=[{type:"function",function:{name:u,description:a,parameters:nn(s)}}]:("name"in s&&(u=s.name),l=[{type:"function",function:{name:u,description:a,parameters:s}}]);const d=this.bindTools(l),h=Tr.from(_=>{if(!Et.isInstance(_))throw new Error("Input is not an AIMessageChunk.");if(!_.tool_calls||_.tool_calls.length===0)throw new Error("No tool calls found in the response.");const b=_.tool_calls.find(y=>y.name===u);if(!b)throw new Error(`No tool call found with name ${u}.`);return b.args});if(!c)return d.pipe(h).withConfig({runName:"StructuredOutput"});const f=ms.assign({parsed:(_,b)=>h.invoke(_.raw,b)}),m=ms.assign({parsed:()=>null}),g=f.withFallbacks({fallbacks:[m]});return Jr.from([{raw:d},g]).withConfig({runName:"StructuredOutputRunnable"})}},eM=class extends Pi{async _generate(t,e,n){const r=await this._call(t,e,n),s=new ht(r);if(typeof s.content!="string")throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:s.content,message:s}]}}},Ix={};ve(Ix,{BaseLLM:()=>Rx,LLM:()=>Sg});var Rx=class Xa extends Eg{constructor(){super(...arguments);p(this,"lc_namespace",["langchain","llms",this._llmType()])}async invoke(n,r){const s=Xa._convertInputToPromptValue(n);return(await this.generatePrompt([s],r,r==null?void 0:r.callbacks)).generations[0][0].text}async*_streamResponseChunks(n,r,s){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptionsCompat(n){const[r,s]=super._separateRunnableConfigFromCallOptions(n);return s.signal=r.signal,[r,s]}async*_streamIterator(n,r){if(this._streamResponseChunks===Xa.prototype._streamResponseChunks)yield this.invoke(n,r);else{const s=Xa._convertInputToPromptValue(n),[i,a]=this._separateRunnableConfigFromCallOptionsCompat(r),o=await hn.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},u=await(o==null?void 0:o.handleLLMStart(this.toJSON(),[s.toString()],i.runId,void 0,c,void 0,void 0,i.runName));let l=new ya({text:""});try{for await(const d of this._streamResponseChunks(s.toString(),a,u==null?void 0:u[0]))l?l=l.concat(d):l=d,typeof d.text=="string"&&(yield d.text)}catch(d){throw await Promise.all((u??[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}await Promise.all((u??[]).map(d=>d==null?void 0:d.handleLLMEnd({generations:[[l]]})))}}async generatePrompt(n,r,s){const i=n.map(a=>a.toString());return this.generate(i,r,s)}invocationParams(n){return{}}_flattenLLMResult(n){const r=[];for(let s=0;s<n.generations.length;s+=1){const i=n.generations[s];if(s===0)r.push({generations:[i],llmOutput:n.llmOutput});else{const a=n.llmOutput?{...n.llmOutput,tokenUsage:{}}:void 0;r.push({generations:[i],llmOutput:a})}}return r}async _generateUncached(n,r,s,i){let a;if(i!==void 0&&i.length===n.length)a=i;else{const l=await hn.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),d={options:r,invocation_params:this==null?void 0:this.invocationParams(r),batch_size:n.length};a=await(l==null?void 0:l.handleLLMStart(this.toJSON(),n,s.runId,void 0,d,void 0,void 0,s==null?void 0:s.runName))}const o=!!(a!=null&&a[0].handlers.find(Um));let c;if(o&&n.length===1&&this._streamResponseChunks!==Xa.prototype._streamResponseChunks)try{const l=await this._streamResponseChunks(n[0],r,a==null?void 0:a[0]);let d;for await(const h of l)d===void 0?d=h:d=zs(d,h);if(d===void 0)throw new Error("Received empty response from chat model call.");c={generations:[[d]],llmOutput:{}},await(a==null?void 0:a[0].handleLLMEnd(c))}catch(l){throw await(a==null?void 0:a[0].handleLLMError(l)),l}else{try{c=await this._generate(n,r,a==null?void 0:a[0])}catch(d){throw await Promise.all((a??[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}const l=this._flattenLLMResult(c);await Promise.all((a??[]).map((d,h)=>d==null?void 0:d.handleLLMEnd(l[h])))}const u=(a==null?void 0:a.map(l=>l.runId))||void 0;return Object.defineProperty(c,Oo,{value:u?{runIds:u}:void 0,configurable:!0}),c}async _generateCached({prompts:n,cache:r,llmStringKey:s,parsedOptions:i,handledOptions:a,runId:o}){const c=await hn.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),u={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:n.length},l=await(c==null?void 0:c.handleLLMStart(this.toJSON(),n,o,void 0,u,void 0,void 0,a==null?void 0:a.runName)),d=[],f=(await Promise.allSettled(n.map(async(_,b)=>{const y=await r.lookup(_,s);return y==null&&d.push(b),y}))).map((_,b)=>({result:_,runManager:l==null?void 0:l[b]})).filter(({result:_})=>_.status==="fulfilled"&&_.value!=null||_.status==="rejected"),m=[];await Promise.all(f.map(async({result:_,runManager:b},y)=>{if(_.status==="fulfilled"){const E=_.value;return m[y]=E.map(C=>(C.generationInfo={...C.generationInfo,tokenUsage:{}},C)),E.length&&await(b==null?void 0:b.handleLLMNewToken(E[0].text)),b==null?void 0:b.handleLLMEnd({generations:[E]},void 0,void 0,void 0,{cached:!0})}else return await(b==null?void 0:b.handleLLMError(_.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(_.reason)}));const g={generations:m,missingPromptIndices:d,startedRunManagers:l};return Object.defineProperty(g,Oo,{value:l?{runIds:l==null?void 0:l.map(_=>_.runId)}:void 0,configurable:!0}),g}async generate(n,r,s){if(!Array.isArray(n))throw new Error("Argument 'prompts' is expected to be a string[]");let i;Array.isArray(r)?i={stop:r}:i=r;const[a,o]=this._separateRunnableConfigFromCallOptionsCompat(i);if(a.callbacks=a.callbacks??s,!this.cache)return this._generateUncached(n,o,a);const{cache:c}=this,u=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d,startedRunManagers:h}=await this._generateCached({prompts:n,cache:c,llmStringKey:u,parsedOptions:o,handledOptions:a,runId:a.runId});let f={};if(d.length>0){const m=await this._generateUncached(d.map(g=>n[g]),o,a,h!==void 0?d.map(g=>h==null?void 0:h[g]):void 0);await Promise.all(m.generations.map(async(g,_)=>{const b=d[_];return l[b]=g,c.update(n[b],u,g)})),f=m.llmOutput??{}}return{generations:l,llmOutput:f}}_identifyingParams(){return{}}_modelType(){return"base_llm"}},Sg=class extends Rx{async _generate(t,e,n){return{generations:await Promise.all(t.map((s,i)=>this._call(s,{...e,promptIndex:i},n).then(a=>[{text:a}])))}}},tM=class extends je{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"runnables");this.runnables=e.runnables}static lc_name(){return"RouterRunnable"}async invoke(e,n){const{key:r,input:s}=e,i=this.runnables[r];if(i===void 0)throw new Error(`No runnable associated with key "${r}".`);return i.invoke(s,ze(n))}async batch(e,n,r){var h;const s=e.map(f=>f.key),i=e.map(f=>f.input);if(s.find(f=>this.runnables[f]===void 0)!==void 0)throw new Error("One or more keys do not have a corresponding runnable.");const o=s.map(f=>this.runnables[f]),c=this._getOptionsList(n??{},e.length),u=((h=c[0])==null?void 0:h.maxConcurrency)??(r==null?void 0:r.maxConcurrency),l=u&&u>0?u:e.length,d=[];for(let f=0;f<i.length;f+=l){const m=i.slice(f,f+l).map((_,b)=>o[b].invoke(_,c[b])),g=await Promise.all(m);d.push(g)}return d.flat()}async stream(e,n){const{key:r,input:s}=e,i=this.runnables[r];if(i===void 0)throw new Error(`No runnable associated with key "${r}".`);return i.stream(s,n)}},nM=class extends je{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"default");p(this,"branches");this.branches=e.branches,this.default=e.default}static lc_name(){return"RunnableBranch"}static from(e){if(e.length<1)throw new Error("RunnableBranch requires at least one branch");const r=e.slice(0,-1).map(([i,a])=>[Jt(i),Jt(a)]),s=Jt(e[e.length-1]);return new this({branches:r,default:s})}async _invoke(e,n,r){let s;for(let i=0;i<this.branches.length;i+=1){const[a,o]=this.branches[i];if(await a.invoke(e,Je(n,{callbacks:r==null?void 0:r.getChild(`condition:${i+1}`)}))){s=await o.invoke(e,Je(n,{callbacks:r==null?void 0:r.getChild(`branch:${i+1}`)}));break}}return s||(s=await this.default.invoke(e,Je(n,{callbacks:r==null?void 0:r.getChild("branch:default")}))),s}async invoke(e,n={}){return this._callWithConfig(this._invoke,e,n)}async*_streamIterator(e,n){const r=await An(n),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),Rt(e,"input"),n==null?void 0:n.runId,void 0,void 0,void 0,n==null?void 0:n.runName));let i,a=!0,o;try{for(let c=0;c<this.branches.length;c+=1){const[u,l]=this.branches[c];if(await u.invoke(e,Je(n,{callbacks:s==null?void 0:s.getChild(`condition:${c+1}`)}))){o=await l.stream(e,Je(n,{callbacks:s==null?void 0:s.getChild(`branch:${c+1}`)}));for await(const h of o)if(yield h,a)if(i===void 0)i=h;else try{i=zs(i,h)}catch{i=void 0,a=!1}break}}if(o===void 0){o=await this.default.stream(e,Je(n,{callbacks:s==null?void 0:s.getChild("branch:default")}));for await(const c of o)if(yield c,a)if(i===void 0)i=c;else try{i=zs(i,c)}catch{i=void 0,a=!1}}}catch(c){throw await(s==null?void 0:s.handleChainError(c)),c}await(s==null?void 0:s.handleChainEnd(i??{}))}},rM=class extends Hs{constructor(e){let n=Tr.from((a,o)=>this._enterHistory(a,o??{})).withConfig({runName:"loadHistory"});const r=e.historyMessagesKey??e.inputMessagesKey;r&&(n=ms.assign({[r]:n}).withConfig({runName:"insertHistory"}));const s=n.pipe(e.runnable.withListeners({onEnd:(a,o)=>this._exitHistory(a,o??{})})).withConfig({runName:"RunnableWithMessageHistory"}),i=e.config??{};super({...e,config:i,bound:s});p(this,"runnable");p(this,"inputMessagesKey");p(this,"outputMessagesKey");p(this,"historyMessagesKey");p(this,"getMessageHistory");this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let n;if(typeof e=="object"&&!Array.isArray(e)&&!Lt(e)){let r;this.inputMessagesKey?r=this.inputMessagesKey:Object.keys(e).length===1?r=Object.keys(e)[0]:r="input",Array.isArray(e[r])&&Array.isArray(e[r][0])?n=e[r][0]:n=e[r]}else n=e;if(typeof n=="string")return[new It(n)];if(Array.isArray(n))return n;if(Lt(n))return[n];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(n,null,2)}`)}_getOutputMessages(e){let n;if(!Array.isArray(e)&&!Lt(e)&&typeof e!="string"){let r;this.outputMessagesKey!==void 0?r=this.outputMessagesKey:Object.keys(e).length===1?r=Object.keys(e)[0]:r="output",e.generations!==void 0?n=e.generations[0][0].message:n=e[r]}else n=e;if(typeof n=="string")return[new ht(n)];if(Array.isArray(n))return n;if(Lt(n))return[n];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(n,null,2)}`)}async _enterHistory(e,n){var i;const s=await((i=n==null?void 0:n.configurable)==null?void 0:i.messageHistory).getMessages();return this.historyMessagesKey===void 0?s.concat(this._getInputMessages(e)):s}async _exitHistory(e,n){var c;const r=(c=n.configurable)==null?void 0:c.messageHistory;let s;Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?s=e.inputs[0]:s=e.inputs;let i=this._getInputMessages(s);if(this.historyMessagesKey===void 0){const u=await r.getMessages();i=i.slice(u.length)}const a=e.outputs;if(!a)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);const o=this._getOutputMessages(a);await r.addMessages([...i,...o])}async _mergeConfig(...e){const n=await super._mergeConfig(...e);if(!n.configurable||!n.configurable.sessionId){const s={[this.inputMessagesKey??"input"]:"foo"},i={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(s)}, ${JSON.stringify(i)})`)}const{sessionId:r}=n.configurable;return n.configurable.messageHistory=await this.getMessageHistory(r),n}},Ox={};ve(Ox,{RouterRunnable:()=>tM,Runnable:()=>je,RunnableAssign:()=>lg,RunnableBinding:()=>Hs,RunnableBranch:()=>nM,RunnableEach:()=>sL,RunnableLambda:()=>Tr,RunnableMap:()=>Pa,RunnableParallel:()=>oL,RunnablePassthrough:()=>ms,RunnablePick:()=>FS,RunnableRetry:()=>ug,RunnableSequence:()=>Jr,RunnableToolLike:()=>xp,RunnableWithFallbacks:()=>jS,RunnableWithMessageHistory:()=>rM,_coerceToRunnable:()=>Jt,ensureConfig:()=>ze,getCallbackManagerForConfig:()=>An,mergeConfigs:()=>er,patchConfig:()=>Je,pickRunnableConfigKeys:()=>fs});var $x={};ve($x,{applyPatch:()=>ga,compare:()=>ed});var cd=class extends je{parseResultWithPrompt(t,e,n){return this.parseResult(t,n)}_baseMessageToString(t){return typeof t.content=="string"?t.content:this._baseMessageContentToString(t.content)}_baseMessageContentToString(t){return JSON.stringify(t)}async invoke(t,e){return typeof t=="string"?this._callWithConfig(async(n,r)=>this.parseResult([{text:n}],r==null?void 0:r.callbacks),t,{...e,runType:"parser"}):this._callWithConfig(async(n,r)=>this.parseResult([{message:n,text:this._baseMessageToString(n)}],r==null?void 0:r.callbacks),t,{...e,runType:"parser"})}},dc=class extends cd{parseResult(t,e){return this.parse(t[0].text,e)}async parseWithPrompt(t,e,n){return this.parse(t,n)}_type(){throw new Error("_type not implemented")}},ls=class extends Error{constructor(e,n,r,s=!1){super(e);p(this,"llmOutput");p(this,"observation");p(this,"sendToLLM");if(this.llmOutput=n,this.observation=r,this.sendToLLM=s,s&&(r===void 0||n===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Ql(this,"OUTPUT_PARSING_FAILURE")}},hc=class extends dc{async*_transform(t){for await(const e of t)typeof e=="string"?yield this.parseResult([{text:e}]):yield this.parseResult([{message:e,text:this._baseMessageToString(e)}])}async*transform(t,e){yield*this._transformStreamWithConfig(t,this._transform.bind(this),{...e,runType:"parser"})}},fc=class extends hc{constructor(e){super(e);p(this,"diff",!1);this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let n,r;for await(const s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let i;if(Ao(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new fn({message:s,text:s.content})}else if(Lt(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new fn({message:Ju(s),text:s.content})}else i=new ya({text:s});r===void 0?r=i:r=r.concat(i);const a=await this.parsePartialResult([r]);a!=null&&!mi(a,n)&&(this.diff?yield this._diff(n,a):yield a,n=a)}}getFormatInstructions(){return""}},sM=class extends hc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","bytes"]);p(this,"lc_serializable",!0);p(this,"textEncoder",new TextEncoder)}static lc_name(){return"BytesOutputParser"}parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}},pc=class extends hc{constructor(){super(...arguments);p(this,"re")}async*_transform(e){let n="";for await(const r of e)if(typeof r=="string"?n+=r:n+=r.content,this.re){const s=[...n.matchAll(this.re)];if(s.length>1){let i=0;for(const a of s.slice(0,-1))yield[a[1]],i+=(a.index??0)+a[0].length;n=n.slice(i)}}else{const s=await this.parse(n);if(s.length>1){for(const i of s.slice(0,-1))yield[i];n=s[s.length-1]}}for(const r of await this.parse(n))yield[r]}},iM=class extends pc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"lc_serializable",!0)}static lc_name(){return"CommaSeparatedListOutputParser"}async parse(e){try{return e.trim().split(",").map(n=>n.trim())}catch{throw new ls(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},aM=class extends pc{constructor({length:e,separator:n}){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"length");p(this,"separator");this.length=e,this.separator=n||","}async parse(e){try{const n=e.trim().split(this.separator).map(r=>r.trim());if(this.length!==void 0&&n.length!==this.length)throw new ls(`Incorrect number of items. Expected ${this.length}, got ${n.length}.`);return n}catch(n){throw Object.getPrototypeOf(n)===ls.prototype?n:new ls(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${this.length===void 0?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}},oM=class extends pc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"lc_serializable",!0);p(this,"re",/\d+\.\s([^\n]+)/g)}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(n=>n[1])}},cM=class extends pc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"lc_serializable",!0);p(this,"re",/^\s*[-*]\s([^\n]+)$/gm)}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(n=>n[1])}},uM=class extends hc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","string"]);p(this,"lc_serializable",!0)}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((n,r)=>n+this._messageContentToString(r),"")}},ol=class extends dc{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","structured"]);this.schema=e}static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const n=mn(Object.fromEntries(Object.entries(e).map(([r,s])=>[r,rt().describe(s)])));return new this(n)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(nn(this.schema))}
\`\`\`
`}async parse(e){var n,r;try{const s=e.trim(),a=(((n=s.match(/^```(?:json)?\s*([\s\S]*?)```/))==null?void 0:n[1])||((r=s.match(/```json\s*([\s\S]*?)```/))==null?void 0:r[1])||s).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(o,c)=>`"${c.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await rd(this.schema,JSON.parse(a))}catch(s){throw new ls(`Failed to parse. Text: "${e}". Error: ${s}`,e)}}},Nx=class extends ol{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(t){const e=(t==null?void 0:t.interpolationDepth)??1;if(e<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction(nn(this.schema)).replaceAll("{","{".repeat(e)).replaceAll("}","}".repeat(e))}
\`\`\``}_schemaToInstruction(t,e=2){const n=t;if("type"in n){let r=!1,s;if(Array.isArray(n.type)){const o=n.type.findIndex(c=>c==="null");o!==-1&&(r=!0,n.type.splice(o,1)),s=n.type.join(" | ")}else s=n.type;if(n.type==="object"&&n.properties){const o=n.description?` // ${n.description}`:"";return`{
${Object.entries(n.properties).map(([u,l])=>{var h;const d=(h=n.required)!=null&&h.includes(u)?"":" (optional)";return`${" ".repeat(e)}"${u}": ${this._schemaToInstruction(l,e+2)}${d}`}).join(`
`)}
${" ".repeat(e-2)}}${o}`}if(n.type==="array"&&n.items){const o=n.description?` // ${n.description}`:"";return`array[
${" ".repeat(e)}${this._schemaToInstruction(n.items,e+2)}
${" ".repeat(e-2)}] ${o}`}const i=r?" (nullable)":"",a=n.description?` // ${n.description}`:"";return`${s}${a}${i}`}if("anyOf"in n)return n.anyOf.map(r=>this._schemaToInstruction(r,e)).join(`
${" ".repeat(e-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(t){return new this(t)}static fromNamesAndDescriptions(t){const e=mn(Object.fromEntries(Object.entries(t).map(([n,r])=>[n,rt().describe(r)])));return new this(e)}},lM=class extends dc{constructor({inputSchema:e}){super(...arguments);p(this,"structuredInputParser");this.structuredInputParser=new Nx(e)}async parse(e){let n;try{n=await this.structuredInputParser.parse(e)}catch(r){throw new ls(`Failed to parse. Text: "${e}". Error: ${r}`,e)}return this.outputProcessor(n)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}},Cp=class extends fc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers"]);p(this,"lc_serializable",!0)}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,n){return this.diff?super._concatOutputChunks(e,n):n}_diff(e,n){if(n)return e?ed(e,n):[{op:"replace",path:"",value:n}]}async parsePartialResult(e){return np(e[0].text)}async parse(e){return np(e,JSON.parse)}getFormatInstructions(){return""}};const dM=function(){const t={};t.parser=function(A,S){return new n(A,S)},t.SAXParser=n,t.SAXStream=u,t.createStream=c,t.MAX_BUFFER_LENGTH=64*1024;const e=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];t.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"];function n(A,S){if(!(this instanceof n))return new n(A,S);var M=this;s(M),M.q=M.c="",M.bufferCheckPosition=t.MAX_BUFFER_LENGTH,M.opt=S||{},M.opt.lowercase=M.opt.lowercase||M.opt.lowercasetags,M.looseCase=M.opt.lowercase?"toLowerCase":"toUpperCase",M.tags=[],M.closed=M.closedRoot=M.sawRoot=!1,M.tag=M.error=null,M.strict=!!A,M.noscript=!!(A||M.opt.noscript),M.state=T.BEGIN,M.strictEntities=M.opt.strictEntities,M.ENTITIES=M.strictEntities?Object.create(t.XML_ENTITIES):Object.create(t.ENTITIES),M.attribList=[],M.opt.xmlns&&(M.ns=Object.create(m)),M.trackPosition=M.opt.position!==!1,M.trackPosition&&(M.position=M.line=M.column=0),z(M,"onready")}Object.create||(Object.create=function(A){function S(){}S.prototype=A;var M=new S;return M}),Object.keys||(Object.keys=function(A){var S=[];for(var M in A)A.hasOwnProperty(M)&&S.push(M);return S});function r(A){for(var S=Math.max(t.MAX_BUFFER_LENGTH,10),M=0,N=0,ke=e.length;N<ke;N++){var $e=A[e[N]].length;if($e>S)switch(e[N]){case"textNode":ie(A);break;case"cdata":q(A,"oncdata",A.cdata),A.cdata="";break;case"script":q(A,"onscript",A.script),A.script="";break;default:j(A,"Max buffer length exceeded: "+e[N])}M=Math.max(M,$e)}var We=t.MAX_BUFFER_LENGTH-M;A.bufferCheckPosition=We+A.position}function s(A){for(var S=0,M=e.length;S<M;S++)A[e[S]]=""}function i(A){ie(A),A.cdata!==""&&(q(A,"oncdata",A.cdata),A.cdata=""),A.script!==""&&(q(A,"onscript",A.script),A.script="")}n.prototype={end:function(){F(this)},write:Z,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){i(this)}};var a=ReadableStream;a||(a=function(){});var o=t.EVENTS.filter(function(A){return A!=="error"&&A!=="end"});function c(A,S){return new u(A,S)}function u(A,S){if(!(this instanceof u))return new u(A,S);a.apply(this),this._parser=new n(A,S),this.writable=!0,this.readable=!0;var M=this;this._parser.onend=function(){M.emit("end")},this._parser.onerror=function(N){M.emit("error",N),M._parser.error=null},this._decoder=null,o.forEach(function(N){Object.defineProperty(M,"on"+N,{get:function(){return M._parser["on"+N]},set:function(ke){if(!ke)return M.removeAllListeners(N),M._parser["on"+N]=ke,ke;M.on(N,ke)},enumerable:!0,configurable:!1})})}u.prototype=Object.create(a.prototype,{constructor:{value:u}}),u.prototype.write=function(A){return this._parser.write(A.toString()),this.emit("data",A),!0},u.prototype.end=function(A){return A&&A.length&&this.write(A),this._parser.end(),!0},u.prototype.on=function(A,S){var M=this;return!M._parser["on"+A]&&o.indexOf(A)!==-1&&(M._parser["on"+A]=function(){var N=arguments.length===1?[arguments[0]]:Array.apply(null,arguments);N.splice(0,0,A),M.emit.apply(M,N)}),a.prototype.on.call(M,A,S)};var l="[CDATA[",d="DOCTYPE",h="http://www.w3.org/XML/1998/namespace",f="http://www.w3.org/2000/xmlns/",m={xml:h,xmlns:f},g=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,_=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,b=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,y=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function E(A){return A===" "||A===`
`||A==="\r"||A==="	"}function C(A){return A==='"'||A==="'"}function k(A){return A===">"||E(A)}function R(A,S){return A.test(S)}function $(A,S){return!R(A,S)}var T=0;t.STATE={BEGIN:T++,BEGIN_WHITESPACE:T++,TEXT:T++,TEXT_ENTITY:T++,OPEN_WAKA:T++,SGML_DECL:T++,SGML_DECL_QUOTED:T++,DOCTYPE:T++,DOCTYPE_QUOTED:T++,DOCTYPE_DTD:T++,DOCTYPE_DTD_QUOTED:T++,COMMENT_STARTING:T++,COMMENT:T++,COMMENT_ENDING:T++,COMMENT_ENDED:T++,CDATA:T++,CDATA_ENDING:T++,CDATA_ENDING_2:T++,PROC_INST:T++,PROC_INST_BODY:T++,PROC_INST_ENDING:T++,OPEN_TAG:T++,OPEN_TAG_SLASH:T++,ATTRIB:T++,ATTRIB_NAME:T++,ATTRIB_NAME_SAW_WHITE:T++,ATTRIB_VALUE:T++,ATTRIB_VALUE_QUOTED:T++,ATTRIB_VALUE_CLOSED:T++,ATTRIB_VALUE_UNQUOTED:T++,ATTRIB_VALUE_ENTITY_Q:T++,ATTRIB_VALUE_ENTITY_U:T++,CLOSE_TAG:T++,CLOSE_TAG_SAW_WHITE:T++,SCRIPT:T++,SCRIPT_ENDING:T++},t.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},t.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(t.ENTITIES).forEach(function(A){var S=t.ENTITIES[A],M=typeof S=="number"?String.fromCharCode(S):S;t.ENTITIES[A]=M});for(var B in t.STATE)t.STATE[t.STATE[B]]=B;T=t.STATE;function z(A,S,M){A[S]&&A[S](M)}function q(A,S,M){A.textNode&&ie(A),z(A,S,M)}function ie(A){A.textNode=me(A.opt,A.textNode),A.textNode&&z(A,"ontext",A.textNode),A.textNode=""}function me(A,S){return A.trim&&(S=S.trim()),A.normalize&&(S=S.replace(/\s+/g," ")),S}function j(A,S){return ie(A),A.trackPosition&&(S+=`
Line: `+A.line+`
Column: `+A.column+`
Char: `+A.c),S=new Error(S),A.error=S,z(A,"onerror",S),A}function F(A){return A.sawRoot&&!A.closedRoot&&H(A,"Unclosed root tag"),A.state!==T.BEGIN&&A.state!==T.BEGIN_WHITESPACE&&A.state!==T.TEXT&&j(A,"Unexpected end"),ie(A),A.c="",A.closed=!0,z(A,"onend"),n.call(A,A.strict,A.opt),A}function H(A,S){if(typeof A!="object"||!(A instanceof n))throw new Error("bad call to strictFail");A.strict&&j(A,S)}function re(A){A.strict||(A.tagName=A.tagName[A.looseCase]());var S=A.tags[A.tags.length-1]||A,M=A.tag={name:A.tagName,attributes:{}};A.opt.xmlns&&(M.ns=S.ns),A.attribList.length=0,q(A,"onopentagstart",M)}function ue(A,S){var M=A.indexOf(":"),N=M<0?["",A]:A.split(":"),ke=N[0],$e=N[1];return S&&A==="xmlns"&&(ke="xmlns",$e=""),{prefix:ke,local:$e}}function ne(A){if(A.strict||(A.attribName=A.attribName[A.looseCase]()),A.attribList.indexOf(A.attribName)!==-1||A.tag.attributes.hasOwnProperty(A.attribName)){A.attribName=A.attribValue="";return}if(A.opt.xmlns){var S=ue(A.attribName,!0),M=S.prefix,N=S.local;if(M==="xmlns")if(N==="xml"&&A.attribValue!==h)H(A,"xml: prefix must be bound to "+h+`
Actual: `+A.attribValue);else if(N==="xmlns"&&A.attribValue!==f)H(A,"xmlns: prefix must be bound to "+f+`
Actual: `+A.attribValue);else{var ke=A.tag,$e=A.tags[A.tags.length-1]||A;ke.ns===$e.ns&&(ke.ns=Object.create($e.ns)),ke.ns[N]=A.attribValue}A.attribList.push([A.attribName,A.attribValue])}else A.tag.attributes[A.attribName]=A.attribValue,q(A,"onattribute",{name:A.attribName,value:A.attribValue});A.attribName=A.attribValue=""}function fe(A,S){if(A.opt.xmlns){var M=A.tag,N=ue(A.tagName);M.prefix=N.prefix,M.local=N.local,M.uri=M.ns[N.prefix]||"",M.prefix&&!M.uri&&(H(A,"Unbound namespace prefix: "+JSON.stringify(A.tagName)),M.uri=N.prefix);var ke=A.tags[A.tags.length-1]||A;M.ns&&ke.ns!==M.ns&&Object.keys(M.ns).forEach(function(Xr){q(A,"onopennamespace",{prefix:Xr,uri:M.ns[Xr]})});for(var $e=0,We=A.attribList.length;$e<We;$e++){var nt=A.attribList[$e],ot=nt[0],Bt=nt[1],Ke=ue(ot,!0),$t=Ke.prefix,bs=Ke.local,Di=$t===""?"":M.ns[$t]||"",X={name:ot,value:Bt,prefix:$t,local:bs,uri:Di};$t&&$t!=="xmlns"&&!Di&&(H(A,"Unbound namespace prefix: "+JSON.stringify($t)),X.uri=$t),A.tag.attributes[ot]=X,q(A,"onattribute",X)}A.attribList.length=0}A.tag.isSelfClosing=!!S,A.sawRoot=!0,A.tags.push(A.tag),q(A,"onopentag",A.tag),S||(!A.noscript&&A.tagName.toLowerCase()==="script"?A.state=T.SCRIPT:A.state=T.TEXT,A.tag=null,A.tagName=""),A.attribName=A.attribValue="",A.attribList.length=0}function Ce(A){if(!A.tagName){H(A,"Weird empty close tag."),A.textNode+="</>",A.state=T.TEXT;return}if(A.script){if(A.tagName!=="script"){A.script+="</"+A.tagName+">",A.tagName="",A.state=T.SCRIPT;return}q(A,"onscript",A.script),A.script=""}var S=A.tags.length,M=A.tagName;A.strict||(M=M[A.looseCase]());for(var N=M;S--;){var ke=A.tags[S];if(ke.name!==N)H(A,"Unexpected close tag");else break}if(S<0){H(A,"Unmatched closing tag: "+A.tagName),A.textNode+="</"+A.tagName+">",A.state=T.TEXT;return}A.tagName=M;for(var $e=A.tags.length;$e-- >S;){var We=A.tag=A.tags.pop();A.tagName=A.tag.name,q(A,"onclosetag",A.tagName);var nt={};for(var ot in We.ns)nt[ot]=We.ns[ot];var Bt=A.tags[A.tags.length-1]||A;A.opt.xmlns&&We.ns!==Bt.ns&&Object.keys(We.ns).forEach(function(Ke){var $t=We.ns[Ke];q(A,"onclosenamespace",{prefix:Ke,uri:$t})})}S===0&&(A.closedRoot=!0),A.tagName=A.attribValue=A.attribName="",A.attribList.length=0,A.state=T.TEXT}function J(A){var S=A.entity,M=S.toLowerCase(),N,ke="";return A.ENTITIES[S]?A.ENTITIES[S]:A.ENTITIES[M]?A.ENTITIES[M]:(S=M,S.charAt(0)==="#"&&(S.charAt(1)==="x"?(S=S.slice(2),N=parseInt(S,16),ke=N.toString(16)):(S=S.slice(1),N=parseInt(S,10),ke=N.toString(10))),S=S.replace(/^0+/,""),isNaN(N)||ke.toLowerCase()!==S?(H(A,"Invalid character entity"),"&"+A.entity+";"):String.fromCodePoint(N))}function Q(A,S){S==="<"?(A.state=T.OPEN_WAKA,A.startTagPosition=A.position):E(S)||(H(A,"Non-whitespace before first tag."),A.textNode=S,A.state=T.TEXT)}function ae(A,S){var M="";return S<A.length&&(M=A.charAt(S)),M}function Z(A){var S=this;if(this.error)throw this.error;if(S.closed)return j(S,"Cannot write after close. Assign an onready handler.");if(A===null)return F(S);typeof A=="object"&&(A=A.toString());for(var M=0,N="";N=ae(A,M++),S.c=N,!!N;)switch(S.trackPosition&&(S.position++,N===`
`?(S.line++,S.column=0):S.column++),S.state){case T.BEGIN:if(S.state=T.BEGIN_WHITESPACE,N==="\uFEFF")continue;Q(S,N);continue;case T.BEGIN_WHITESPACE:Q(S,N);continue;case T.TEXT:if(S.sawRoot&&!S.closedRoot){for(var ke=M-1;N&&N!=="<"&&N!=="&";)N=ae(A,M++),N&&S.trackPosition&&(S.position++,N===`
`?(S.line++,S.column=0):S.column++);S.textNode+=A.substring(ke,M-1)}N==="<"&&!(S.sawRoot&&S.closedRoot&&!S.strict)?(S.state=T.OPEN_WAKA,S.startTagPosition=S.position):(!E(N)&&(!S.sawRoot||S.closedRoot)&&H(S,"Text data outside of root node."),N==="&"?S.state=T.TEXT_ENTITY:S.textNode+=N);continue;case T.SCRIPT:N==="<"?S.state=T.SCRIPT_ENDING:S.script+=N;continue;case T.SCRIPT_ENDING:N==="/"?S.state=T.CLOSE_TAG:(S.script+="<"+N,S.state=T.SCRIPT);continue;case T.OPEN_WAKA:if(N==="!")S.state=T.SGML_DECL,S.sgmlDecl="";else if(!E(N))if(R(g,N))S.state=T.OPEN_TAG,S.tagName=N;else if(N==="/")S.state=T.CLOSE_TAG,S.tagName="";else if(N==="?")S.state=T.PROC_INST,S.procInstName=S.procInstBody="";else{if(H(S,"Unencoded <"),S.startTagPosition+1<S.position){var $e=S.position-S.startTagPosition;N=new Array($e).join(" ")+N}S.textNode+="<"+N,S.state=T.TEXT}continue;case T.SGML_DECL:(S.sgmlDecl+N).toUpperCase()===l?(q(S,"onopencdata"),S.state=T.CDATA,S.sgmlDecl="",S.cdata=""):S.sgmlDecl+N==="--"?(S.state=T.COMMENT,S.comment="",S.sgmlDecl=""):(S.sgmlDecl+N).toUpperCase()===d?(S.state=T.DOCTYPE,(S.doctype||S.sawRoot)&&H(S,"Inappropriately located doctype declaration"),S.doctype="",S.sgmlDecl=""):N===">"?(q(S,"onsgmldeclaration",S.sgmlDecl),S.sgmlDecl="",S.state=T.TEXT):(C(N)&&(S.state=T.SGML_DECL_QUOTED),S.sgmlDecl+=N);continue;case T.SGML_DECL_QUOTED:N===S.q&&(S.state=T.SGML_DECL,S.q=""),S.sgmlDecl+=N;continue;case T.DOCTYPE:N===">"?(S.state=T.TEXT,q(S,"ondoctype",S.doctype),S.doctype=!0):(S.doctype+=N,N==="["?S.state=T.DOCTYPE_DTD:C(N)&&(S.state=T.DOCTYPE_QUOTED,S.q=N));continue;case T.DOCTYPE_QUOTED:S.doctype+=N,N===S.q&&(S.q="",S.state=T.DOCTYPE);continue;case T.DOCTYPE_DTD:S.doctype+=N,N==="]"?S.state=T.DOCTYPE:C(N)&&(S.state=T.DOCTYPE_DTD_QUOTED,S.q=N);continue;case T.DOCTYPE_DTD_QUOTED:S.doctype+=N,N===S.q&&(S.state=T.DOCTYPE_DTD,S.q="");continue;case T.COMMENT:N==="-"?S.state=T.COMMENT_ENDING:S.comment+=N;continue;case T.COMMENT_ENDING:N==="-"?(S.state=T.COMMENT_ENDED,S.comment=me(S.opt,S.comment),S.comment&&q(S,"oncomment",S.comment),S.comment=""):(S.comment+="-"+N,S.state=T.COMMENT);continue;case T.COMMENT_ENDED:N!==">"?(H(S,"Malformed comment"),S.comment+="--"+N,S.state=T.COMMENT):S.state=T.TEXT;continue;case T.CDATA:N==="]"?S.state=T.CDATA_ENDING:S.cdata+=N;continue;case T.CDATA_ENDING:N==="]"?S.state=T.CDATA_ENDING_2:(S.cdata+="]"+N,S.state=T.CDATA);continue;case T.CDATA_ENDING_2:N===">"?(S.cdata&&q(S,"oncdata",S.cdata),q(S,"onclosecdata"),S.cdata="",S.state=T.TEXT):N==="]"?S.cdata+="]":(S.cdata+="]]"+N,S.state=T.CDATA);continue;case T.PROC_INST:N==="?"?S.state=T.PROC_INST_ENDING:E(N)?S.state=T.PROC_INST_BODY:S.procInstName+=N;continue;case T.PROC_INST_BODY:if(!S.procInstBody&&E(N))continue;N==="?"?S.state=T.PROC_INST_ENDING:S.procInstBody+=N;continue;case T.PROC_INST_ENDING:N===">"?(q(S,"onprocessinginstruction",{name:S.procInstName,body:S.procInstBody}),S.procInstName=S.procInstBody="",S.state=T.TEXT):(S.procInstBody+="?"+N,S.state=T.PROC_INST_BODY);continue;case T.OPEN_TAG:R(_,N)?S.tagName+=N:(re(S),N===">"?fe(S):N==="/"?S.state=T.OPEN_TAG_SLASH:(E(N)||H(S,"Invalid character in tag name"),S.state=T.ATTRIB));continue;case T.OPEN_TAG_SLASH:N===">"?(fe(S,!0),Ce(S)):(H(S,"Forward-slash in opening tag not followed by >"),S.state=T.ATTRIB);continue;case T.ATTRIB:if(E(N))continue;N===">"?fe(S):N==="/"?S.state=T.OPEN_TAG_SLASH:R(g,N)?(S.attribName=N,S.attribValue="",S.state=T.ATTRIB_NAME):H(S,"Invalid attribute name");continue;case T.ATTRIB_NAME:N==="="?S.state=T.ATTRIB_VALUE:N===">"?(H(S,"Attribute without value"),S.attribValue=S.attribName,ne(S),fe(S)):E(N)?S.state=T.ATTRIB_NAME_SAW_WHITE:R(_,N)?S.attribName+=N:H(S,"Invalid attribute name");continue;case T.ATTRIB_NAME_SAW_WHITE:if(N==="=")S.state=T.ATTRIB_VALUE;else{if(E(N))continue;H(S,"Attribute without value"),S.tag.attributes[S.attribName]="",S.attribValue="",q(S,"onattribute",{name:S.attribName,value:""}),S.attribName="",N===">"?fe(S):R(g,N)?(S.attribName=N,S.state=T.ATTRIB_NAME):(H(S,"Invalid attribute name"),S.state=T.ATTRIB)}continue;case T.ATTRIB_VALUE:if(E(N))continue;C(N)?(S.q=N,S.state=T.ATTRIB_VALUE_QUOTED):(H(S,"Unquoted attribute value"),S.state=T.ATTRIB_VALUE_UNQUOTED,S.attribValue=N);continue;case T.ATTRIB_VALUE_QUOTED:if(N!==S.q){N==="&"?S.state=T.ATTRIB_VALUE_ENTITY_Q:S.attribValue+=N;continue}ne(S),S.q="",S.state=T.ATTRIB_VALUE_CLOSED;continue;case T.ATTRIB_VALUE_CLOSED:E(N)?S.state=T.ATTRIB:N===">"?fe(S):N==="/"?S.state=T.OPEN_TAG_SLASH:R(g,N)?(H(S,"No whitespace between attributes"),S.attribName=N,S.attribValue="",S.state=T.ATTRIB_NAME):H(S,"Invalid attribute name");continue;case T.ATTRIB_VALUE_UNQUOTED:if(!k(N)){N==="&"?S.state=T.ATTRIB_VALUE_ENTITY_U:S.attribValue+=N;continue}ne(S),N===">"?fe(S):S.state=T.ATTRIB;continue;case T.CLOSE_TAG:if(S.tagName)N===">"?Ce(S):R(_,N)?S.tagName+=N:S.script?(S.script+="</"+S.tagName,S.tagName="",S.state=T.SCRIPT):(E(N)||H(S,"Invalid tagname in closing tag"),S.state=T.CLOSE_TAG_SAW_WHITE);else{if(E(N))continue;$(g,N)?S.script?(S.script+="</"+N,S.state=T.SCRIPT):H(S,"Invalid tagname in closing tag."):S.tagName=N}continue;case T.CLOSE_TAG_SAW_WHITE:if(E(N))continue;N===">"?Ce(S):H(S,"Invalid characters in closing tag");continue;case T.TEXT_ENTITY:case T.ATTRIB_VALUE_ENTITY_Q:case T.ATTRIB_VALUE_ENTITY_U:var We,nt;switch(S.state){case T.TEXT_ENTITY:We=T.TEXT,nt="textNode";break;case T.ATTRIB_VALUE_ENTITY_Q:We=T.ATTRIB_VALUE_QUOTED,nt="attribValue";break;case T.ATTRIB_VALUE_ENTITY_U:We=T.ATTRIB_VALUE_UNQUOTED,nt="attribValue";break}if(N===";")if(S.opt.unparsedEntities){var ot=J(S);S.entity="",S.state=We,S.write(ot)}else S[nt]+=J(S),S.entity="",S.state=We;else R(S.entity.length?y:b,N)?S.entity+=N:(H(S,"Invalid character in entity name"),S[nt]+="&"+S.entity+N,S.entity="",S.state=We);continue;default:throw new Error(S,"Unknown state: "+S.state)}return S.position>=S.bufferCheckPosition&&r(S),S}/*! http://mths.be/fromcodepoint v0.1.0 by @mathias */return String.fromCodePoint||(function(){var A=String.fromCharCode,S=Math.floor,M=function(){var N=16384,ke=[],$e,We,nt=-1,ot=arguments.length;if(!ot)return"";for(var Bt="";++nt<ot;){var Ke=Number(arguments[nt]);if(!isFinite(Ke)||Ke<0||Ke>1114111||S(Ke)!==Ke)throw RangeError("Invalid code point: "+Ke);Ke<=65535?ke.push(Ke):(Ke-=65536,$e=(Ke>>10)+55296,We=Ke%1024+56320,ke.push($e,We)),(nt+1===ot||ke.length>N)&&(Bt+=A.apply(null,ke),ke.length=0)}return Bt};Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:M,configurable:!0,writable:!0}):String.fromCodePoint=M})(),t},hM=dM(),kp=`The output should be formatted as a XML file.
1. Output should conform to the tags below. 
2. If tags are not given, make them on your own.
3. Remember to always open and close all the tags.

As an example, for the tags ["foo", "bar", "baz"]:
1. String "<foo>
   <bar>
      <baz></baz>
   </bar>
</foo>" is a well-formatted instance of the schema. 
2. String "<foo>
   <bar>
   </foo>" is a badly-formatted instance.
3. String "<foo>
   <tag>
   </tag>
</foo>" is a badly-formatted instance.

Here are the output tags:
\`\`\`
{tags}
\`\`\``;var fM=class extends fc{constructor(e){super(e);p(this,"tags");p(this,"lc_namespace",["langchain_core","output_parsers"]);p(this,"lc_serializable",!0);this.tags=e==null?void 0:e.tags}static lc_name(){return"XMLOutputParser"}_diff(e,n){if(n)return e?ed(e,n):[{op:"replace",path:"",value:n}]}async parsePartialResult(e){return Ip(e[0].text)}async parse(e){return Ip(e)}getFormatInstructions(){var n;return!!(this.tags&&this.tags.length>0)?kp.replace("{tags}",((n=this.tags)==null?void 0:n.join(", "))??""):kp}};const pM=t=>t.split(`
`).map(e=>e.replace(/^\s+/,"")).join(`
`).trim(),Px=t=>{if(Object.keys(t).length===0)return{};const e={};return t.children.length>0?(e[t.name]=t.children.map(Px),e):(e[t.name]=t.text??void 0,e)};function Ip(t){const e=pM(t),n=hM.parser(!0);let r={};const s=[];n.onopentag=o=>{const c={name:o.name,attributes:o.attributes,children:[],text:"",isSelfClosing:o.isSelfClosing};s.length>0?s[s.length-1].children.push(c):r=c,o.isSelfClosing||s.push(c)},n.onclosetag=()=>{if(s.length>0){const o=s.pop();s.length===0&&o&&(r=o)}},n.ontext=o=>{if(s.length>0){const c=s[s.length-1];c.text+=o}},n.onattribute=o=>{if(s.length>0){const c=s[s.length-1];c.attributes[o.name]=o.value}};const i=/```(xml)?(.*)```/s.exec(e),a=i?i[2]:e;return n.write(a).close(),r&&r.name==="?xml"&&(r=r.children[0]),Px(r)}var Lx={};ve(Lx,{AsymmetricStructuredOutputParser:()=>lM,BaseCumulativeTransformOutputParser:()=>fc,BaseLLMOutputParser:()=>cd,BaseOutputParser:()=>dc,BaseTransformOutputParser:()=>hc,BytesOutputParser:()=>sM,CommaSeparatedListOutputParser:()=>iM,CustomListOutputParser:()=>aM,JsonMarkdownStructuredOutputParser:()=>Nx,JsonOutputParser:()=>Cp,ListOutputParser:()=>pc,MarkdownListOutputParser:()=>cM,NumberedListOutputParser:()=>oM,OutputParserException:()=>ls,StringOutputParser:()=>uM,StructuredOutputParser:()=>ol,XMLOutputParser:()=>fM,XML_FORMAT_INSTRUCTIONS:()=>kp,parseJsonMarkdown:()=>np,parsePartialJson:()=>ma,parseXMLMarkdown:()=>Ip});function ud(t,e){if(t.function===void 0)return;let n;if(e!=null&&e.partial)try{n=ma(t.function.arguments??"{}")}catch{return}else try{n=JSON.parse(t.function.arguments)}catch(s){throw new ls([`Function "${t.function.name}" arguments:`,"",t.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}const r={name:t.function.name,args:n,type:"tool_call"};return e!=null&&e.returnId&&(r.id=t.id),r}function Mx(t){if(t.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.args)}}}function cl(t,e){var n,r;return{name:(n=t.function)==null?void 0:n.name,args:(r=t.function)==null?void 0:r.arguments,id:t.id,error:e,type:"invalid_tool_call"}}var Dx=class extends fc{constructor(e){super(e);p(this,"returnId",!1);p(this,"lc_namespace",["langchain","output_parsers","openai_tools"]);p(this,"lc_serializable",!0);this.returnId=(e==null?void 0:e.returnId)??this.returnId}static lc_name(){return"JsonOutputToolsParser"}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,n=!0){var a;const r=e[0].message;let s;if($i(r)&&((a=r.tool_calls)!=null&&a.length)?s=r.tool_calls.map(o=>{const{id:c,...u}=o;return this.returnId?{id:c,...u}:u}):r.additional_kwargs.tool_calls!==void 0&&(s=JSON.parse(JSON.stringify(r.additional_kwargs.tool_calls)).map(c=>ud(c,{returnId:this.returnId,partial:n}))),!s)return[];const i=[];for(const o of s)if(o!==void 0){const c={type:o.name,args:o.args,id:o.id};i.push(c)}return i}},Rp=class extends Dx{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","openai_tools"]);p(this,"lc_serializable",!0);p(this,"returnId",!1);p(this,"keyName");p(this,"returnSingle",!1);p(this,"zodSchema");this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}static lc_name(){return"JsonOutputKeyToolsParser"}async _validateResult(e){var r;if(this.zodSchema===void 0)return e;const n=await gS(this.zodSchema,e);if(n.success)return n.data;throw new ls(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify((r=n.error)==null?void 0:r.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const r=(await super.parsePartialResult(e)).filter(i=>i.type===this.keyName);let s=r;if(r.length)return this.returnId||(s=r.map(i=>i.args)),this.returnSingle?s[0]:s}async parseResult(e){const r=(await super.parsePartialResult(e,!1)).filter(a=>a.type===this.keyName);let s=r;return r.length?(this.returnId||(s=r.map(a=>a.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(a=>this._validateResult(a)))):void 0}},Ux={};ve(Ux,{JsonOutputKeyToolsParser:()=>Rp,JsonOutputToolsParser:()=>Dx,convertLangChainToolCallToOpenAI:()=>Mx,makeInvalidToolCall:()=>cl,parseToolCall:()=>ud});var Bx=class extends cd{constructor(e){super();p(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);p(this,"lc_serializable",!0);p(this,"argsOnly",!0);this.argsOnly=(e==null?void 0:e.argsOnly)??this.argsOnly}static lc_name(){return"OutputFunctionsParser"}async parseResult(e){if("message"in e[0]){const r=e[0].message.additional_kwargs.function_call;if(!r)throw new Error(`No function_call in message ${JSON.stringify(e)}`);if(!r.arguments)throw new Error(`No arguments in function_call ${JSON.stringify(e)}`);return this.argsOnly?r.arguments:JSON.stringify(r)}else throw new Error(`No message in generations ${JSON.stringify(e)}`)}},jx=class extends fc{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);p(this,"lc_serializable",!0);p(this,"outputParser");p(this,"argsOnly",!0);this.argsOnly=(e==null?void 0:e.argsOnly)??this.argsOnly,this.outputParser=new Bx(e)}static lc_name(){return"JsonOutputFunctionsParser"}_diff(e,n){return n?ed(e??{},n):void 0}async parsePartialResult(e){const n=e[0];if(!n.message)return;const{message:r}=n,s=r.additional_kwargs.function_call;if(s)return this.argsOnly?ma(s.arguments):{...s,arguments:ma(s.arguments)}}async parseResult(e){const n=await this.outputParser.parseResult(e);if(!n)throw new Error(`No result from "OutputFunctionsParser" ${JSON.stringify(e)}`);return this.parse(n)}async parse(e){const n=JSON.parse(e);return this.argsOnly||(n.arguments=JSON.parse(n.arguments)),n}getFormatInstructions(){return""}},mM=class extends cd{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);p(this,"lc_serializable",!0);p(this,"outputParser",new jx);p(this,"attrName");this.attrName=e.attrName}static lc_name(){return"JsonKeyOutputFunctionsParser"}get lc_aliases(){return{attrName:"key_name"}}async parseResult(e){return(await this.outputParser.parseResult(e))[this.attrName]}},Fx={};ve(Fx,{JsonKeyOutputFunctionsParser:()=>mM,JsonOutputFunctionsParser:()=>jx,OutputFunctionsParser:()=>Bx});var mc=class extends je{constructor(e){super(e);p(this,"lc_serializable",!0);p(this,"lc_namespace",["langchain_core","prompts",this._getPromptType()]);p(this,"inputVariables");p(this,"outputParser");p(this,"partialVariables");p(this,"metadata");p(this,"tags");const{inputVariables:n}=e;if(n.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}get lc_attributes(){return{partialVariables:void 0}}async mergePartialAndUserVariables(e){const n=this.partialVariables??{},r={};for(const[i,a]of Object.entries(n))typeof a=="string"?r[i]=a:r[i]=await a();return{...r,...e}}async invoke(e,n){const r={...this.metadata,...n==null?void 0:n.metadata},s=[...this.tags??[],...(n==null?void 0:n.tags)??[]];return this._callWithConfig(i=>this.formatPromptValue(i),e,{...n,tags:s,metadata:r,runType:"prompt"})}},Bo=class extends mc{async formatPromptValue(t){const e=await this.format(t);return new pg(e)}};/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var gM=Object.prototype.toString,La=Array.isArray||function(e){return gM.call(e)==="[object Array]"};function xg(t){return typeof t=="function"}function yM(t){return La(t)?"array":typeof t}function uf(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function lb(t,e){return t!=null&&typeof t=="object"&&e in t}function _M(t,e){return t!=null&&typeof t!="object"&&t.hasOwnProperty&&t.hasOwnProperty(e)}var wM=RegExp.prototype.test;function bM(t,e){return wM.call(t,e)}var vM=/\S/;function EM(t){return!bM(vM,t)}var SM={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function xM(t){return String(t).replace(/[&<>"'`=\/]/g,function(n){return SM[n]})}var TM=/\s*/,AM=/\s+/,db=/\s*=/,CM=/\s*\}/,kM=/#|\^|\/|>|\{|&|=|!/;function IM(t,e){if(!t)return[];var n=!1,r=[],s=[],i=[],a=!1,o=!1,c="",u=0;function l(){if(a&&!o)for(;i.length;)delete s[i.pop()];else i=[];a=!1,o=!1}var d,h,f;function m(T){if(typeof T=="string"&&(T=T.split(AM,2)),!La(T)||T.length!==2)throw new Error("Invalid tags: "+T);d=new RegExp(uf(T[0])+"\\s*"),h=new RegExp("\\s*"+uf(T[1])),f=new RegExp("\\s*"+uf("}"+T[1]))}m(e||In.tags);for(var g=new gc(t),_,b,y,E,C,k;!g.eos();){if(_=g.pos,y=g.scanUntil(d),y)for(var R=0,$=y.length;R<$;++R)E=y.charAt(R),EM(E)?(i.push(s.length),c+=E):(o=!0,n=!0,c+=" "),s.push(["text",E,_,_+1]),_+=1,E===`
`&&(l(),c="",u=0,n=!1);if(!g.scan(d))break;if(a=!0,b=g.scan(kM)||"name",g.scan(TM),b==="="?(y=g.scanUntil(db),g.scan(db),g.scanUntil(h)):b==="{"?(y=g.scanUntil(f),g.scan(CM),g.scanUntil(h),b="&"):y=g.scanUntil(h),!g.scan(h))throw new Error("Unclosed tag at "+g.pos);if(b==">"?C=[b,y,_,g.pos,c,u,n]:C=[b,y,_,g.pos],u++,s.push(C),b==="#"||b==="^")r.push(C);else if(b==="/"){if(k=r.pop(),!k)throw new Error('Unopened section "'+y+'" at '+_);if(k[1]!==y)throw new Error('Unclosed section "'+k[1]+'" at '+_)}else b==="name"||b==="{"||b==="&"?o=!0:b==="="&&m(y)}if(l(),k=r.pop(),k)throw new Error('Unclosed section "'+k[1]+'" at '+g.pos);return OM(RM(s))}function RM(t){for(var e=[],n,r,s=0,i=t.length;s<i;++s)n=t[s],n&&(n[0]==="text"&&r&&r[0]==="text"?(r[1]+=n[1],r[3]=n[3]):(e.push(n),r=n));return e}function OM(t){for(var e=[],n=e,r=[],s,i,a=0,o=t.length;a<o;++a)switch(s=t[a],s[0]){case"#":case"^":n.push(s),r.push(s),n=s[4]=[];break;case"/":i=r.pop(),i[5]=s[2],n=r.length>0?r[r.length-1][4]:e;break;default:n.push(s)}return e}function gc(t){this.string=t,this.tail=t,this.pos=0}gc.prototype.eos=function(){return this.tail===""};gc.prototype.scan=function(e){var n=this.tail.match(e);if(!n||n.index!==0)return"";var r=n[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r};gc.prototype.scanUntil=function(e){var n=this.tail.search(e),r;switch(n){case-1:r=this.tail,this.tail="";break;case 0:r="";break;default:r=this.tail.substring(0,n),this.tail=this.tail.substring(n)}return this.pos+=r.length,r};function Sa(t,e){this.view=t,this.cache={".":this.view},this.parent=e}Sa.prototype.push=function(e){return new Sa(e,this)};Sa.prototype.lookup=function(e){var n=this.cache,r;if(n.hasOwnProperty(e))r=n[e];else{for(var s=this,i,a,o,c=!1;s;){if(e.indexOf(".")>0)for(i=s.view,a=e.split("."),o=0;i!=null&&o<a.length;)o===a.length-1&&(c=lb(i,a[o])||_M(i,a[o])),i=i[a[o++]];else i=s.view[e],c=lb(s.view,e);if(c){r=i;break}s=s.parent}n[e]=r}return xg(r)&&(r=r.call(this.view)),r};function gn(){this.templateCache={_cache:{},set:function(e,n){this._cache[e]=n},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}gn.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};gn.prototype.parse=function(e,n){var r=this.templateCache,s=e+":"+(n||In.tags).join(":"),i=typeof r<"u",a=i?r.get(s):void 0;return a==null&&(a=IM(e,n),i&&r.set(s,a)),a};gn.prototype.render=function(e,n,r,s){var i=this.getConfigTags(s),a=this.parse(e,i),o=n instanceof Sa?n:new Sa(n,void 0);return this.renderTokens(a,o,r,e,s)};gn.prototype.renderTokens=function(e,n,r,s,i){for(var a="",o,c,u,l=0,d=e.length;l<d;++l)u=void 0,o=e[l],c=o[0],c==="#"?u=this.renderSection(o,n,r,s,i):c==="^"?u=this.renderInverted(o,n,r,s,i):c===">"?u=this.renderPartial(o,n,r,i):c==="&"?u=this.unescapedValue(o,n):c==="name"?u=this.escapedValue(o,n,i):c==="text"&&(u=this.rawValue(o)),u!==void 0&&(a+=u);return a};gn.prototype.renderSection=function(e,n,r,s,i){var a=this,o="",c=n.lookup(e[1]);function u(h){return a.render(h,n,r,i)}if(c){if(La(c))for(var l=0,d=c.length;l<d;++l)o+=this.renderTokens(e[4],n.push(c[l]),r,s,i);else if(typeof c=="object"||typeof c=="string"||typeof c=="number")o+=this.renderTokens(e[4],n.push(c),r,s,i);else if(xg(c)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");c=c.call(n.view,s.slice(e[3],e[5]),u),c!=null&&(o+=c)}else o+=this.renderTokens(e[4],n,r,s,i);return o}};gn.prototype.renderInverted=function(e,n,r,s,i){var a=n.lookup(e[1]);if(!a||La(a)&&a.length===0)return this.renderTokens(e[4],n,r,s,i)};gn.prototype.indentPartial=function(e,n,r){for(var s=n.replace(/[^ \t]/g,""),i=e.split(`
`),a=0;a<i.length;a++)i[a].length&&(a>0||!r)&&(i[a]=s+i[a]);return i.join(`
`)};gn.prototype.renderPartial=function(e,n,r,s){if(r){var i=this.getConfigTags(s),a=xg(r)?r(e[1]):r[e[1]];if(a!=null){var o=e[6],c=e[5],u=e[4],l=a;c==0&&u&&(l=this.indentPartial(a,u,o));var d=this.parse(l,i);return this.renderTokens(d,n,r,l,s)}}};gn.prototype.unescapedValue=function(e,n){var r=n.lookup(e[1]);if(r!=null)return r};gn.prototype.escapedValue=function(e,n,r){var s=this.getConfigEscape(r)||In.escape,i=n.lookup(e[1]);if(i!=null)return typeof i=="number"&&s===In.escape?String(i):s(i)};gn.prototype.rawValue=function(e){return e[1]};gn.prototype.getConfigTags=function(e){return La(e)?e:e&&typeof e=="object"?e.tags:void 0};gn.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!La(e))return e.escape};var In={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(t){jo.templateCache=t},get templateCache(){return jo.templateCache}},jo=new gn;In.clearCache=function(){return jo.clearCache()};In.parse=function(e,n){return jo.parse(e,n)};In.render=function(e,n,r,s){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+yM(e)+'" was given as the first argument for mustache#render(template, view, partials)');return jo.render(e,n,r,s)};In.escape=xM;In.Scanner=gc;In.Context=Sa;In.Writer=gn;function zx(){In.escape=t=>t}const Fo=t=>{const e=t.split(""),n=[],r=(i,a)=>{for(let o=a;o<e.length;o+=1)if(i.includes(e[o]))return o;return-1};let s=0;for(;s<e.length;)if(e[s]==="{"&&s+1<e.length&&e[s+1]==="{")n.push({type:"literal",text:"{"}),s+=2;else if(e[s]==="}"&&s+1<e.length&&e[s+1]==="}")n.push({type:"literal",text:"}"}),s+=2;else if(e[s]==="{"){const i=r("}",s);if(i<0)throw new Error("Unclosed '{' in template.");n.push({type:"variable",name:e.slice(s+1,i).join("")}),s=i+1}else{if(e[s]==="}")throw new Error("Single '}' in template.");{const i=r("{}",s),a=(i<0?e.slice(s):e.slice(s,i)).join("");n.push({type:"literal",text:a}),s=i<0?e.length:i}}return n},Vx=(t,e=[])=>{const n=[];for(const r of t)if(r[0]==="name"){const s=r[1].includes(".")?r[1].split(".")[0]:r[1];n.push({type:"variable",name:s})}else if(["#","&","^",">"].includes(r[0])){if(n.push({type:"variable",name:r[1]}),r[0]==="#"&&r.length>4&&Array.isArray(r[4])){const s=[...e,r[1]],i=Vx(r[4],s);n.push(...i)}}else n.push({type:"literal",text:r[1]});return n},ul=t=>{zx();const e=In.parse(t);return Vx(e)},qx=(t,e)=>Fo(t).reduce((n,r)=>{if(r.type==="variable"){if(r.name in e){const s=typeof e[r.name]=="string"?e[r.name]:JSON.stringify(e[r.name]);return n+s}throw new Error(`(f-string) Missing value for input ${r.name}`)}return n+r.text},""),Hx=(t,e)=>(zx(),In.render(t,e)),ll={"f-string":qx,mustache:Hx},Gx={"f-string":Fo,mustache:ul},br=(t,e,n)=>{try{return ll[e](t,n)}catch(r){throw Ql(r,"INVALID_PROMPT_INPUT")}},dl=(t,e)=>Gx[e](t),yc=(t,e,n)=>{if(!(e in ll)){const r=Object.keys(ll);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{const r=n.reduce((s,i)=>(s[i]="foo",s),{});Array.isArray(t)?t.forEach(s=>{if(s.type==="text"&&"text"in s&&typeof s.text=="string")br(s.text,e,r);else if(s.type==="image_url"){if(typeof s.image_url=="string")br(s.image_url,e,r);else if(typeof s.image_url=="object"&&s.image_url!==null&&"url"in s.image_url&&typeof s.image_url.url=="string"){const i=s.image_url.url;br(i,e,r)}}else throw new Error(`Invalid message template received. ${JSON.stringify(s,null,2)}`)}):br(t,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}};var Ds=class Ya extends Bo{constructor(n){super(n);p(this,"template");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);p(this,"additionalContentFields");if(n.templateFormat==="mustache"&&n.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,n),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),yc(this.template,this.templateFormat,r)}}static lc_name(){return"PromptTemplate"}_getPromptType(){return"prompt"}async format(n){const r=await this.mergePartialAndUserVariables(n);return br(this.template,this.templateFormat,r)}static fromExamples(n,r,s,i=`

`,a=""){const o=[a,...n,r].join(i);return new Ya({inputVariables:s,template:o})}static fromTemplate(n,r){const{templateFormat:s="f-string",...i}=r??{},a=new Set;return dl(n,s).forEach(o=>{o.type==="variable"&&a.add(o.name)}),new Ya({inputVariables:[...a],templateFormat:s,template:n,...i})}async partial(n){const r=this.inputVariables.filter(a=>!(a in n)),s={...this.partialVariables??{},...n},i={...this,inputVariables:r,partialVariables:s};return new Ya(i)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(n){if(!n.template)throw new Error("Prompt template must have a template");return new Ya({inputVariables:n.input_variables,template:n.template,templateFormat:n.template_format})}},_u=class Wx extends mc{constructor(n){super(n);p(this,"lc_namespace",["langchain_core","prompts","image"]);p(this,"template");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);p(this,"additionalContentFields");if(this.template=n.template,this.templateFormat=n.templateFormat??this.templateFormat,this.validateTemplate=n.validateTemplate??this.validateTemplate,this.additionalContentFields=n.additionalContentFields,this.validateTemplate){let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),yc([{type:"image_url",image_url:this.template}],this.templateFormat,r)}}static lc_name(){return"ImagePromptTemplate"}_getPromptType(){return"prompt"}async partial(n){const r=this.inputVariables.filter(a=>!(a in n)),s={...this.partialVariables??{},...n},i={...this,inputVariables:r,partialVariables:s};return new Wx(i)}async format(n){const r={};for(const[o,c]of Object.entries(this.template))typeof c=="string"?r[o]=br(c,this.templateFormat,n):r[o]=c;const s=n.url||r.url,i=n.detail||r.detail;if(!s)throw new Error("Must provide either an image URL.");if(typeof s!="string")throw new Error("url must be a string.");const a={url:s};return i&&(a.detail=i),a}async formatPromptValue(n){const r=await this.format(n);return new XS(r)}},Op=class extends je{constructor(e){const n=e.templateFormat??"f-string",r=$p(e.template,n);super({inputVariables:r,...e});p(this,"lc_namespace",["langchain_core","prompts","dict"]);p(this,"lc_serializable",!0);p(this,"template");p(this,"templateFormat");p(this,"inputVariables");this.template=e.template,this.templateFormat=n,this.inputVariables=r}static lc_name(){return"DictPromptTemplate"}async format(e){return Np(this.template,e,this.templateFormat)}async invoke(e){return await this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})}};function $p(t,e){const n=[];for(const r of Object.values(t))if(typeof r=="string")dl(r,e).forEach(s=>{s.type==="variable"&&n.push(s.name)});else if(Array.isArray(r))for(const s of r)typeof s=="string"?dl(s,e).forEach(i=>{i.type==="variable"&&n.push(i.name)}):typeof s=="object"&&n.push(...$p(s,e));else typeof r=="object"&&r!==null&&n.push(...$p(r,e));return Array.from(new Set(n))}function Np(t,e,n){const r={};for(const[s,i]of Object.entries(t))if(typeof i=="string")r[s]=br(i,n,e);else if(Array.isArray(i)){const a=[];for(const o of i)typeof o=="string"?a.push(br(o,n,e)):typeof o=="object"&&a.push(Np(o,e,n));r[s]=a}else typeof i=="object"&&i!==null?r[s]=Np(i,e,n):r[s]=i;return r}var ld=class extends je{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","prompts","chat"]);p(this,"lc_serializable",!0)}async invoke(e,n){return this._callWithConfig(r=>this.formatMessages(r),e,{...n,runType:"prompt"})}},Pp=class extends ld{constructor(e){typeof e=="string"&&(e={variableName:e});super(e);p(this,"variableName");p(this,"optional");this.variableName=e.variableName,this.optional=e.optional??!1}static lc_name(){return"MessagesPlaceholder"}get inputVariables(){return[this.variableName]}async formatMessages(e){const n=e[this.variableName];if(this.optional&&!n)return[];if(!n){const s=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw s.name="InputFormatError",s}let r;try{Array.isArray(n)?r=n.map(Vr):r=[Vr(n)]}catch(s){const i=typeof n=="string"?n:JSON.stringify(n,null,2),a=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${i}`,`Additional message: ${s.message}`].join(`

`));throw a.name="InputFormatError",a.lc_error_code=s.lc_error_code,a}return r}},Jx=class extends ld{constructor(e){"prompt"in e||(e={prompt:e});super(e);p(this,"prompt");this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},Tg=class extends mc{constructor(t){super(t)}async format(t){return(await this.formatPromptValue(t)).toString()}async formatPromptValue(t){const e=await this.formatMessages(t);return new mg(e)}},Zx=class extends Jx{constructor(e,n){"prompt"in e||(e={prompt:e,role:n});super(e);p(this,"role");this.role=e.role}static lc_name(){return"ChatMessagePromptTemplate"}async format(e){return new Zr(await this.prompt.format(e),this.role)}static fromTemplate(e,n,r){return new this(Ds.fromTemplate(e,{templateFormat:r==null?void 0:r.templateFormat}),n)}};function $M(t){return t===null||typeof t!="object"||Array.isArray(t)?!1:Object.keys(t).length===1&&"text"in t&&typeof t.text=="string"}function NM(t){return t===null||typeof t!="object"||Array.isArray(t)?!1:"image_url"in t&&(typeof t.image_url=="string"||typeof t.image_url=="object"&&t.image_url!==null&&"url"in t.image_url&&typeof t.image_url.url=="string")}var Ag=class extends ld{constructor(e,n){"prompt"in e||(e={prompt:e});super(e);p(this,"lc_namespace",["langchain_core","prompts","chat"]);p(this,"lc_serializable",!0);p(this,"inputVariables",[]);p(this,"additionalOptions",{});p(this,"prompt");p(this,"messageClass");p(this,"chatMessageClass");if(this.prompt=e.prompt,Array.isArray(this.prompt)){let r=[];this.prompt.forEach(s=>{"inputVariables"in s&&(r=r.concat(s.inputVariables))}),this.inputVariables=r}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=n??this.additionalOptions}static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}createMessage(e){const n=this.constructor;if(n._messageClass()){const r=n._messageClass();return new r({content:e})}else if(n.chatMessageClass){const r=n.chatMessageClass();return new r({content:e,role:this.getRoleFromMessageClass(r.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,n){if(typeof e=="string")return new this(Ds.fromTemplate(e,n));const r=[];for(const s of e)if(typeof s=="string")r.push(Ds.fromTemplate(s,n));else if(s!==null)if($M(s)){let i="";typeof s.text=="string"&&(i=s.text??"");const a={...n,additionalContentFields:s};r.push(Ds.fromTemplate(i,a))}else if(NM(s)){let i=s.image_url??"",a,o=[];if(typeof i=="string"){let c;(n==null?void 0:n.templateFormat)==="mustache"?c=ul(i):c=Fo(i);const u=c.flatMap(l=>l.type==="variable"?[l.name]:[]);if(((u==null?void 0:u.length)??0)>0){if(u.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${u}
From: ${i}`);o=[u[0]]}else o=[];i={url:i},a=new _u({template:i,inputVariables:o,templateFormat:n==null?void 0:n.templateFormat,additionalContentFields:s})}else if(typeof i=="object"){if("url"in i){let c;(n==null?void 0:n.templateFormat)==="mustache"?c=ul(i.url):c=Fo(i.url),o=c.flatMap(u=>u.type==="variable"?[u.name]:[])}else o=[];a=new _u({template:i,inputVariables:o,templateFormat:n==null?void 0:n.templateFormat,additionalContentFields:s})}else throw new Error("Invalid image template");r.push(a)}else typeof s=="object"&&r.push(new Op({template:s,templateFormat:n==null?void 0:n.templateFormat}));return new this({prompt:r,additionalOptions:n})}async format(e){if(this.prompt instanceof Bo){const n=await this.prompt.format(e);return this.createMessage(n)}else{const n=[];for(const r of this.prompt){let s={};if(!("inputVariables"in r))throw new Error(`Prompt ${r} does not have inputVariables defined.`);for(const i of r.inputVariables)s||(s={[i]:e[i]}),s={...s,[i]:e[i]};if(r instanceof Bo){const i=await r.format(s);let a;"additionalContentFields"in r&&(a=r.additionalContentFields),i!==""&&n.push({...a,type:"text",text:i})}else if(r instanceof _u){const i=await r.format(s);let a;"additionalContentFields"in r&&(a=r.additionalContentFields),n.push({...a,type:"image_url",image_url:i})}else if(r instanceof Op){const i=await r.format(s);let a;"additionalContentFields"in r&&(a=r.additionalContentFields),n.push({...a,...i})}}return this.createMessage(n)}}async formatMessages(e){return[await this.format(e)]}},Cg=class extends Ag{static _messageClass(){return It}static lc_name(){return"HumanMessagePromptTemplate"}},Kx=class extends Ag{static _messageClass(){return ht}static lc_name(){return"AIMessagePromptTemplate"}},Xx=class extends Ag{static _messageClass(){return vt}static lc_name(){return"SystemMessagePromptTemplate"}};function PM(t){return typeof t.formatMessages=="function"}function LM(t,e){if(PM(t)||Lt(t))return t;if(Array.isArray(t)&&t[0]==="placeholder"){const s=t[1];if((e==null?void 0:e.templateFormat)==="mustache"&&typeof s=="string"&&s.slice(0,2)==="{{"&&s.slice(-2)==="}}"){const i=s.slice(2,-2);return new Pp({variableName:i,optional:!0})}else if(typeof s=="string"&&s[0]==="{"&&s[s.length-1]==="}"){const i=s.slice(1,-1);return new Pp({variableName:i,optional:!0})}throw new Error(`Invalid placeholder template for format ${(e==null?void 0:e.templateFormat)??'"f-string"'}: "${t[1]}". Expected a variable name surrounded by ${(e==null?void 0:e.templateFormat)==="mustache"?"double":"single"} curly braces.`)}const n=Vr(t);let r;if(typeof n.content=="string"?r=n.content:r=n.content.map(s=>"text"in s?{...s,text:s.text}:"image_url"in s?{...s,image_url:s.image_url}:s),n._getType()==="human")return Cg.fromTemplate(r,e);if(n._getType()==="ai")return Kx.fromTemplate(r,e);if(n._getType()==="system")return Xx.fromTemplate(r,e);if(Zr.isInstance(n))return Zx.fromTemplate(n.content,n.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${n._getType()}".`)}function MM(t){return t.constructor.lc_name()==="MessagesPlaceholder"}var kg=class wu extends Tg{constructor(n){super(n);p(this,"promptMessages");p(this,"validateTemplate",!0);p(this,"templateFormat","f-string");if(n.templateFormat==="mustache"&&n.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,n),this.validateTemplate){const r=new Set;for(const c of this.promptMessages)if(!(c instanceof rr))for(const u of c.inputVariables)r.add(u);const s=this.inputVariables,i=new Set(this.partialVariables?s.concat(Object.keys(this.partialVariables)):s),a=new Set([...i].filter(c=>!r.has(c)));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are not used in any of the prompt messages.`);const o=new Set([...r].filter(c=>!i.has(c)));if(o.size>0)throw new Error(`Input variables \`${[...o]}\` are used in prompt messages but not in the prompt template.`)}}static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}_getPromptType(){return"chat"}async _parseImagePrompts(n,r){if(typeof n.content=="string")return n;const s=await Promise.all(n.content.map(async i=>{if(i.type!=="image_url")return i;let a="";typeof i.image_url=="string"?a=i.image_url:typeof i.image_url=="object"&&i.image_url!==null&&"url"in i.image_url&&typeof i.image_url.url=="string"&&(a=i.image_url.url);const c=await Ds.fromTemplate(a,{templateFormat:this.templateFormat}).format(r);return typeof i.image_url=="object"&&i.image_url!==null&&"url"in i.image_url?i.image_url.url=c:i.image_url=c,i}));return n.content=s,n}async formatMessages(n){const r=await this.mergePartialAndUserVariables(n);let s=[];for(const i of this.promptMessages)if(i instanceof rr)s.push(await this._parseImagePrompts(i,r));else{let a;this.templateFormat==="mustache"?a={...r}:a=i.inputVariables.reduce((c,u)=>{if(!(u in r)&&!(MM(i)&&i.optional))throw Ql(new Error(`Missing value for input variable \`${u.toString()}\``),"INVALID_PROMPT_INPUT");return c[u]=r[u],c},{});const o=await i.formatMessages(a);s=s.concat(o)}return s}async partial(n){const r=this.inputVariables.filter(a=>!(a in n)),s={...this.partialVariables??{},...n},i={...this,inputVariables:r,partialVariables:s};return new wu(i)}static fromTemplate(n,r){const s=Ds.fromTemplate(n,r),i=new Cg({prompt:s});return this.fromMessages([i])}static fromMessages(n,r){const s=n.reduce((o,c)=>o.concat(c instanceof wu?c.promptMessages:[LM(c,r)]),[]),i=n.reduce((o,c)=>c instanceof wu?Object.assign(o,c.partialVariables):o,Object.create(null)),a=new Set;for(const o of s)if(!(o instanceof rr))for(const c of o.inputVariables)c in i||a.add(c);return new this({...r,inputVariables:[...a],promptMessages:s,partialVariables:i,templateFormat:r==null?void 0:r.templateFormat})}},DM=class Lp extends Bo{constructor(n){super(n);p(this,"lc_serializable",!1);p(this,"examples");p(this,"exampleSelector");p(this,"examplePrompt");p(this,"suffix","");p(this,"exampleSeparator",`

`);p(this,"prefix","");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);if(Object.assign(this,n),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),yc(this.prefix+this.suffix,this.templateFormat,r)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(n){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(n);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(n){const r=this.inputVariables.filter(a=>!(a in n)),s={...this.partialVariables??{},...n},i={...this,inputVariables:r,partialVariables:s};return new Lp(i)}async format(n){const r=await this.mergePartialAndUserVariables(n),s=await this.getExamples(r),i=await Promise.all(s.map(o=>this.examplePrompt.format(o))),a=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return br(a,this.templateFormat,r)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(n){const{example_prompt:r}=n;if(!r)throw new Error("Missing example prompt");const s=await Ds.deserialize(r);let i;if(Array.isArray(n.examples))i=n.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new Lp({inputVariables:n.input_variables,examplePrompt:s,examples:i,exampleSeparator:n.example_separator,prefix:n.prefix,suffix:n.suffix,templateFormat:n.template_format})}},UM=class Yx extends Tg{constructor(n){super(n);p(this,"lc_serializable",!0);p(this,"examples");p(this,"exampleSelector");p(this,"examplePrompt");p(this,"suffix","");p(this,"exampleSeparator",`

`);p(this,"prefix","");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);if(this.examples=n.examples,this.examplePrompt=n.examplePrompt,this.exampleSeparator=n.exampleSeparator??`

`,this.exampleSelector=n.exampleSelector,this.prefix=n.prefix??"",this.suffix=n.suffix??"",this.templateFormat=n.templateFormat??"f-string",this.validateTemplate=n.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),yc(this.prefix+this.suffix,this.templateFormat,r)}}_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}async getExamples(n){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(n);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(n){const r=await this.mergePartialAndUserVariables(n);let s=await this.getExamples(r);s=s.map(a=>{const o={};return this.examplePrompt.inputVariables.forEach(c=>{o[c]=a[c]}),o});const i=[];for(const a of s){const o=await this.examplePrompt.formatMessages(a);i.push(...o)}return i}async format(n){const r=await this.mergePartialAndUserVariables(n),s=await this.getExamples(r),a=(await Promise.all(s.map(c=>this.examplePrompt.formatMessages(c)))).flat().map(c=>c.content),o=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return br(o,this.templateFormat,r)}async partial(n){const r=this.inputVariables.filter(a=>!(a in n)),s={...this.partialVariables??{},...n},i={...this,inputVariables:r,partialVariables:s};return new Yx(i)}},BM=class bu extends mc{constructor(n){super({...n,inputVariables:[]});p(this,"pipelinePrompts");p(this,"finalPrompt");this.pipelinePrompts=n.pipelinePrompts,this.finalPrompt=n.finalPrompt,this.inputVariables=this.computeInputValues()}static lc_name(){return"PipelinePromptTemplate"}computeInputValues(){const n=this.pipelinePrompts.map(s=>s.name),r=this.pipelinePrompts.map(s=>s.prompt.inputVariables.filter(i=>!n.includes(i))).flat();return[...new Set(r)]}static extractRequiredInputValues(n,r){return r.reduce((s,i)=>(s[i]=n[i],s),{})}async formatPipelinePrompts(n){const r=await this.mergePartialAndUserVariables(n);for(const{name:s,prompt:i}of this.pipelinePrompts){const a=bu.extractRequiredInputValues(r,i.inputVariables);i instanceof kg?r[s]=await i.formatMessages(a):r[s]=await i.format(a)}return bu.extractRequiredInputValues(r,this.finalPrompt.inputVariables)}async formatPromptValue(n){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(n))}async format(n){return this.finalPrompt.format(await this.formatPipelinePrompts(n))}async partial(n){const r={...this};return r.inputVariables=this.inputVariables.filter(s=>!(s in n)),r.partialVariables={...this.partialVariables??{},...n},new bu(r)}serialize(){throw new Error("Not implemented.")}_getPromptType(){return"pipeline"}};function hb(t){return typeof t=="object"&&t!=null&&"withStructuredOutput"in t&&typeof t.withStructuredOutput=="function"}function jM(t){return typeof t=="object"&&t!=null&&"lc_id"in t&&Array.isArray(t.lc_id)&&t.lc_id.join("/")==="langchain_core/runnables/RunnableBinding"}var FM=class Qx extends kg{constructor(n){super(n);p(this,"schema");p(this,"method");p(this,"lc_namespace",["langchain_core","prompts","structured"]);this.schema=n.schema,this.method=n.method}get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}pipe(n){if(hb(n))return super.pipe(n.withStructuredOutput(this.schema));if(jM(n)&&hb(n.bound))return super.pipe(new Hs({bound:n.bound.withStructuredOutput(this.schema,...this.method?[{method:this.method}]:[]),kwargs:n.kwargs??{},config:n.config,configFactories:n.configFactories}));throw new Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(n,r,s){return Qx.fromMessages(n,{schema:r,method:s})}},eT={};ve(eT,{AIMessagePromptTemplate:()=>Kx,BaseChatPromptTemplate:()=>Tg,BaseMessagePromptTemplate:()=>ld,BaseMessageStringPromptTemplate:()=>Jx,BasePromptTemplate:()=>mc,BaseStringPromptTemplate:()=>Bo,ChatMessagePromptTemplate:()=>Zx,ChatPromptTemplate:()=>kg,DEFAULT_FORMATTER_MAPPING:()=>ll,DEFAULT_PARSER_MAPPING:()=>Gx,DictPromptTemplate:()=>Op,FewShotChatMessagePromptTemplate:()=>UM,FewShotPromptTemplate:()=>DM,HumanMessagePromptTemplate:()=>Cg,ImagePromptTemplate:()=>_u,MessagesPlaceholder:()=>Pp,PipelinePromptTemplate:()=>BM,PromptTemplate:()=>Ds,StructuredPrompt:()=>FM,SystemMessagePromptTemplate:()=>Xx,checkValidTemplate:()=>yc,interpolateFString:()=>qx,interpolateMustache:()=>Hx,parseFString:()=>Fo,parseMustache:()=>ul,parseTemplate:()=>dl,renderTemplate:()=>br});var tT={};ve(tT,{BaseDocumentCompressor:()=>zM});var zM=class{static isBaseDocumentCompressor(t){return(t==null?void 0:t.compressDocuments)!==void 0}};const Ps={and:"and",or:"or",not:"not"},Be={eq:"eq",ne:"ne",lt:"lt",gt:"gt",lte:"lte",gte:"gte"};var nT=class{},Ig=class{accept(t){if(this.exprName==="Operation")return t.visitOperation(this);if(this.exprName==="Comparison")return t.visitComparison(this);if(this.exprName==="StructuredQuery")return t.visitStructuredQuery(this);throw new Error("Unknown Expression type")}},Rg=class extends Ig{},VM=class extends Rg{constructor(e,n,r){super();p(this,"exprName","Comparison");this.comparator=e,this.attribute=n,this.value=r}},qM=class extends Rg{constructor(e,n){super();p(this,"exprName","Operation");this.operator=e,this.args=n}},HM=class extends Ig{constructor(e,n){super();p(this,"exprName","StructuredQuery");this.query=e,this.filter=n}};function rT(t){return t&&typeof t=="object"&&!Array.isArray(t)}function _r(t){return t?typeof t=="string"&&t.length>0||typeof t=="function"?!1:rT(t)&&Object.keys(t).length===0:!0}function sT(t){if(typeof t=="number")return t%1===0;if(typeof t=="string"){const e=parseInt(t,10);return!Number.isNaN(e)&&e%1===0&&e.toString()===t}return!1}function iT(t){if(typeof t=="number")return t%1!==0;if(typeof t=="string"){const e=parseFloat(t);return!Number.isNaN(e)&&e%1!==0&&e.toString()===t}return!1}function aT(t){return typeof t=="string"&&(Number.isNaN(parseFloat(t))||parseFloat(t).toString()!==t)}function oT(t){return typeof t=="boolean"}function Og(t){let e;if(aT(t))e=t;else if(sT(t))e=parseInt(t,10);else if(iT(t))e=parseFloat(t);else if(oT(t))e=!!t;else throw new Error("Unsupported value type");return e}var $g=class extends nT{},GM=class extends $g{constructor(e){super();p(this,"allowedOperators");p(this,"allowedComparators");this.allowedOperators=(e==null?void 0:e.allowedOperators)??[Ps.and,Ps.or],this.allowedComparators=(e==null?void 0:e.allowedComparators)??[Be.eq,Be.ne,Be.gt,Be.gte,Be.lt,Be.lte]}formatFunction(e){if(e in Be){if(this.allowedComparators.length>0&&this.allowedComparators.indexOf(e)===-1)throw new Error(`Comparator ${e} not allowed. Allowed comparators: ${this.allowedComparators.join(", ")}`)}else if(e in Ps){if(this.allowedOperators.length>0&&this.allowedOperators.indexOf(e)===-1)throw new Error(`Operator ${e} not allowed. Allowed operators: ${this.allowedOperators.join(", ")}`)}else throw new Error("Unknown comparator or operator");return`$${e}`}visitOperation(e){var r;const n=(r=e.args)==null?void 0:r.map(s=>s.accept(this));return{[this.formatFunction(e.operator)]:n}}visitComparison(e){return{[e.attribute]:{[this.formatFunction(e.comparator)]:Og(e.value)}}}visitStructuredQuery(e){let n={};return e.filter&&(n={filter:e.filter.accept(this)}),n}mergeFilters(e,n,r="and",s=!1){if(!(_r(e)&&_r(n))){if(_r(e)||r==="replace")return _r(n)?void 0:n;if(_r(n))return s?e:r==="and"?void 0:e;if(r==="and")return{$and:[e,n]};if(r==="or")return{$or:[e,n]};throw new Error("Unknown merge type")}}},WM=class extends $g{constructor(){super(...arguments);p(this,"allowedOperators",[Ps.and,Ps.or]);p(this,"allowedComparators",[Be.eq,Be.ne,Be.gt,Be.gte,Be.lt,Be.lte])}formatFunction(){throw new Error("Not implemented")}getAllowedComparatorsForType(e){switch(e){case"string":return[Be.eq,Be.ne,Be.gt,Be.gte,Be.lt,Be.lte];case"number":return[Be.eq,Be.ne,Be.gt,Be.gte,Be.lt,Be.lte];case"boolean":return[Be.eq,Be.ne];default:throw new Error(`Unsupported data type: ${e}`)}}getComparatorFunction(e){switch(e){case Be.eq:return(n,r)=>n===r;case Be.ne:return(n,r)=>n!==r;case Be.gt:return(n,r)=>n>r;case Be.gte:return(n,r)=>n>=r;case Be.lt:return(n,r)=>n<r;case Be.lte:return(n,r)=>n<=r;default:throw new Error("Unknown comparator")}}getOperatorFunction(e){switch(e){case Ps.and:return(n,r)=>n&&r;case Ps.or:return(n,r)=>n||r;default:throw new Error("Unknown operator")}}visitOperation(e){const{operator:n,args:r}=e;if(this.allowedOperators.includes(n)){const s=this.getOperatorFunction(n);return i=>r?r.reduce((a,o)=>{const c=o.accept(this);if(typeof c=="function")return s(a,c(i));throw new Error("Filter is not a function")},!0):!0}else throw new Error("Operator not allowed")}visitComparison(e){const{comparator:n,attribute:r,value:s}=e,i=[Be.ne];if(this.allowedComparators.includes(n)){if(!this.getAllowedComparatorsForType(typeof s).includes(n))throw new Error(`'${n}' comparator not allowed to be used with ${typeof s}`);const a=this.getComparatorFunction(n);return o=>{const c=o.metadata[r];return c===void 0?!!i.includes(n):a(c,Og(s))}}else throw new Error("Comparator not allowed")}visitStructuredQuery(e){var r;if(!e.filter)return{};const n=(r=e.filter)==null?void 0:r.accept(this);if(typeof n!="function")throw new Error("Structured query filter is not a function");return{filter:n}}mergeFilters(e,n,r="and"){if(!(_r(e)&&_r(n))){if(_r(e)||r==="replace")return _r(n)?void 0:n;if(_r(n))return r==="and"?void 0:e;if(r==="and")return s=>e(s)&&n(s);if(r==="or")return s=>e(s)||n(s);throw new Error("Unknown merge type")}}},cT={};ve(cT,{BaseTranslator:()=>$g,BasicTranslator:()=>GM,Comparators:()=>Be,Comparison:()=>VM,Expression:()=>Ig,FilterDirective:()=>Rg,FunctionalTranslator:()=>WM,Operation:()=>qM,Operators:()=>Ps,StructuredQuery:()=>HM,Visitor:()=>nT,castValue:()=>Og,isBoolean:()=>oT,isFilterEmpty:()=>_r,isFloat:()=>iT,isInt:()=>sT,isObject:()=>rT,isString:()=>aT});function Ng(t){return t!==void 0&&Array.isArray(t.lc_namespace)}function Pg(t){return t!==void 0&&je.isRunnable(t)&&"lc_name"in t.constructor&&typeof t.constructor.lc_name=="function"&&t.constructor.lc_name()==="RunnableToolLike"}function Lg(t){return!!t&&typeof t=="object"&&"name"in t&&"schema"in t&&(tr(t.schema)||t.schema!=null&&typeof t.schema=="object"&&"type"in t.schema&&typeof t.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(t.schema.type))}function _c(t){return Lg(t)||Pg(t)||Ng(t)}const JM=(t,e)=>{oS.init(t,e),t.name="ZodError",Object.defineProperties(t,{format:{value:n=>_N(t,n)},flatten:{value:n=>yN(t,n)},addIssue:{value:n=>t.issues.push(n)},addIssues:{value:n=>t.issues.push(...n)},isEmpty:{get(){return t.issues.length===0}}})},dd=Le("ZodError",JM,{Parent:Error}),ZM=cS(dd),KM=uS(dd),XM=dS(dd),YM=hS(dd),On=Le("ZodType",(t,e)=>(Yt.init(t,e),t.def=e,Object.defineProperty(t,"_def",{value:e}),t.check=(...n)=>t.clone({...e,checks:[...e.checks??[],...n.map(r=>typeof r=="function"?{_zod:{check:r,def:{check:"custom"},onattach:[]}}:r)]}),t.clone=(n,r)=>Wr(t,n,r),t.brand=()=>t,t.register=((n,r)=>(n.add(t,r),t)),t.parse=(n,r)=>ZM(t,n,r,{callee:t.parse}),t.safeParse=(n,r)=>XM(t,n,r),t.parseAsync=async(n,r)=>KM(t,n,r,{callee:t.parseAsync}),t.safeParseAsync=async(n,r)=>YM(t,n,r),t.spa=t.safeParseAsync,t.refine=(n,r)=>t.check(SD(n,r)),t.superRefine=n=>t.check(xD(n)),t.overwrite=n=>t.check(ZN(n)),t.optional=()=>fb(t),t.nullable=()=>pb(t),t.nullish=()=>fb(pb(t)),t.nonoptional=n=>mD(t,n),t.array=()=>tD(t),t.or=n=>rD([t,n]),t.and=n=>iD(t,n),t.transform=n=>mb(t,oD(n)),t.default=n=>dD(t,n),t.prefault=n=>fD(t,n),t.catch=n=>yD(t,n),t.pipe=n=>mb(t,n),t.readonly=()=>bD(t),t.describe=n=>{const r=t.clone();return Mt.add(r,{description:n}),r},Object.defineProperty(t,"description",{get(){var n;return(n=Mt.get(t))==null?void 0:n.description},configurable:!0}),t.meta=(...n)=>{if(n.length===0)return Mt.get(t);const r=t.clone();return Mt.add(r,n[0]),r},t.isOptional=()=>t.safeParse(void 0).success,t.isNullable=()=>t.safeParse(null).success,t)),QM=Le("ZodAny",(t,e)=>{kN.init(t,e),On.init(t,e)});function Vc(){return qN(QM)}const eD=Le("ZodArray",(t,e)=>{ON.init(t,e),On.init(t,e),t.element=e.element,t.min=(n,r)=>t.check(Pw(n,r)),t.nonempty=n=>t.check(Pw(1,n)),t.max=(n,r)=>t.check(WN(n,r)),t.length=(n,r)=>t.check(JN(n,r)),t.unwrap=()=>t.element});function tD(t,e){return KN(eD,t,e)}const nD=Le("ZodUnion",(t,e)=>{$N.init(t,e),On.init(t,e),t.options=e.options});function rD(t,e){return new nD({type:"union",options:t,...Zs(e)})}const sD=Le("ZodIntersection",(t,e)=>{NN.init(t,e),On.init(t,e)});function iD(t,e){return new sD({type:"intersection",left:t,right:e})}const aD=Le("ZodTransform",(t,e)=>{PN.init(t,e),On.init(t,e),t._zod.parse=(n,r)=>{n.addIssue=i=>{if(typeof i=="string")n.issues.push(No(i,n.value,e));else{const a=i;a.fatal&&(a.continue=!1),a.code??(a.code="custom"),a.input??(a.input=n.value),a.inst??(a.inst=t),a.continue??(a.continue=!0),n.issues.push(No(a))}};const s=e.transform(n.value,n);return s instanceof Promise?s.then(i=>(n.value=i,n)):(n.value=s,n)}});function oD(t){return new aD({type:"transform",transform:t})}const cD=Le("ZodOptional",(t,e)=>{rg.init(t,e),On.init(t,e),t.unwrap=()=>t._zod.def.innerType});function fb(t){return new cD({type:"optional",innerType:t})}const uD=Le("ZodNullable",(t,e)=>{LN.init(t,e),On.init(t,e),t.unwrap=()=>t._zod.def.innerType});function pb(t){return new uD({type:"nullable",innerType:t})}const lD=Le("ZodDefault",(t,e)=>{MN.init(t,e),On.init(t,e),t.unwrap=()=>t._zod.def.innerType,t.removeDefault=t.unwrap});function dD(t,e){return new lD({type:"default",innerType:t,get defaultValue(){return typeof e=="function"?e():e}})}const hD=Le("ZodPrefault",(t,e)=>{DN.init(t,e),On.init(t,e),t.unwrap=()=>t._zod.def.innerType});function fD(t,e){return new hD({type:"prefault",innerType:t,get defaultValue(){return typeof e=="function"?e():e}})}const pD=Le("ZodNonOptional",(t,e)=>{UN.init(t,e),On.init(t,e),t.unwrap=()=>t._zod.def.innerType});function mD(t,e){return new pD({type:"nonoptional",innerType:t,...Zs(e)})}const gD=Le("ZodCatch",(t,e)=>{BN.init(t,e),On.init(t,e),t.unwrap=()=>t._zod.def.innerType,t.removeCatch=t.unwrap});function yD(t,e){return new gD({type:"catch",innerType:t,catchValue:typeof e=="function"?e:()=>e})}const _D=Le("ZodPipe",(t,e)=>{jN.init(t,e),On.init(t,e),t.in=e.in,t.out=e.out});function mb(t,e){return new _D({type:"pipe",in:t,out:e})}const wD=Le("ZodReadonly",(t,e)=>{FN.init(t,e),On.init(t,e)});function bD(t){return new wD({type:"readonly",innerType:t})}const vD=Le("ZodCustom",(t,e)=>{zN.init(t,e),On.init(t,e)});function ED(t){const e=new Na({check:"custom"});return e._zod.check=t,e}function SD(t,e={}){return XN(vD,t,e)}function xD(t){const e=ED(n=>(n.addIssue=r=>{if(typeof r=="string")n.issues.push(No(r,n.value,e._zod.def));else{const s=r;s.fatal&&(s.continue=!1),s.code??(s.code="custom"),s.input??(s.input=n.value),s.inst??(s.inst=e),s.continue??(s.continue=!e._zod.def.abort),n.issues.push(No(s))}},t(n.value,n)));return e}var uT={};ve(uT,{BaseToolkit:()=>TD,DynamicStructuredTool:()=>hT,DynamicTool:()=>dT,StructuredTool:()=>hd,Tool:()=>lT,ToolInputParsingException:()=>Gu,isLangChainTool:()=>_c,isRunnableToolLike:()=>Pg,isStructuredTool:()=>Ng,isStructuredToolParams:()=>Lg,tool:()=>Ma});var hd=class extends vg{constructor(e){super(e??{});p(this,"returnDirect",!1);p(this,"verboseParsingErrors",!1);p(this,"responseFormat","content");p(this,"defaultConfig");this.verboseParsingErrors=(e==null?void 0:e.verboseParsingErrors)??this.verboseParsingErrors,this.responseFormat=(e==null?void 0:e.responseFormat)??this.responseFormat,this.defaultConfig=(e==null?void 0:e.defaultConfig)??this.defaultConfig,this.metadata=(e==null?void 0:e.metadata)??this.metadata}get lc_namespace(){return["langchain","tools"]}async invoke(e,n){let r,s=ze(er(this.defaultConfig,n));return po(e)?(r=e.args,s={...s,toolCall:e}):r=e,this.call(r,s)}async call(e,n,r){const s=po(e)?e.args:e;let i;if(tr(this.schema))try{i=await rd(this.schema,s)}catch(m){let g="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(g=`${g}
Details: ${m.message}`),m instanceof Error&&m.constructor.name==="ZodError"&&(g=`${g}

${bN(m)}`),new Gu(g,JSON.stringify(e))}else{const m=it(s,this.schema);if(!m.valid){let g="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(g=`${g}
Details: ${m.errors.map(_=>`${_.keywordLocation}: ${_.error}`).join(`
`)}`),new Gu(g,JSON.stringify(e))}i=s}const a=cc(n),o=hn.configure(a.callbacks,this.callbacks,a.tags||r,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),c=await(o==null?void 0:o.handleToolStart(this.toJSON(),typeof e=="string"?e:JSON.stringify(e),a.runId,void 0,void 0,void 0,a.runName));delete a.runId;let u;try{u=await this._call(i,c,a)}catch(m){throw await(c==null?void 0:c.handleToolError(m)),m}let l,d;if(this.responseFormat==="content_and_artifact")if(Array.isArray(u)&&u.length===2)[l,d]=u;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(u)}`);else l=u;let h;po(e)&&(h=e.id),!h&&z$(a)&&(h=a.toolCall.id);const f=AD({content:l,artifact:d,toolCallId:h,name:this.name,metadata:this.metadata});return await(c==null?void 0:c.handleToolEnd(f)),f}},lT=class extends hd{constructor(n){super(n);p(this,"schema",mn({input:rt().optional()}).transform(n=>n.input))}call(n,r){const s=typeof n=="string"||n==null?{input:n}:n;return super.call(s,r)}},dT=class extends lT{constructor(e){super(e);p(this,"name");p(this,"description");p(this,"func");this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect}static lc_name(){return"DynamicTool"}async call(e,n){const r=cc(n);return r.runName===void 0&&(r.runName=this.name),super.call(e,r)}async _call(e,n,r){return this.func(e,n,r)}},hT=class extends hd{constructor(e){super(e);p(this,"name");p(this,"description");p(this,"func");p(this,"schema");this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=e.schema}static lc_name(){return"DynamicStructuredTool"}async call(e,n,r){const s=cc(n);return s.runName===void 0&&(s.runName=this.name),super.call(e,s,r)}_call(e,n,r){return this.func(e,n,r)}},TD=class{getTools(){return this.tools}};function Ma(t,e){var a;const n=sg(e.schema),r=go(e.schema);if(!e.schema||n||r)return new dT({...e,description:e.description??((a=e.schema)==null?void 0:a.description)??`${e.name} tool`,func:async(o,c,u)=>new Promise((l,d)=>{const h=Je(u,{callbacks:c==null?void 0:c.getChild()});Dt.runWithConfig(fs(h),async()=>{try{l(t(o,h))}catch(f){d(f)}})})});const s=e.schema,i=e.description??e.schema.description??`${e.name} tool`;return new hT({...e,description:i,schema:s,func:async(o,c,u)=>new Promise((l,d)=>{u!=null&&u.signal&&u.signal.addEventListener("abort",()=>d(Io(u.signal)));const h=Je(u,{callbacks:c==null?void 0:c.getChild()});Dt.runWithConfig(fs(h),async()=>{var f;try{const m=await t(o,h);if((f=u==null?void 0:u.signal)!=null&&f.aborted)return;l(m)}catch(m){d(m)}})})})}function AD(t){const{content:e,artifact:n,toolCallId:r,metadata:s}=t;return r&&!Lm(e)?typeof e=="string"||Array.isArray(e)&&e.every(i=>typeof i=="object")?new Hr({status:"success",content:e,artifact:n,tool_call_id:r,name:t.name,metadata:s}):new Hr({status:"success",content:CD(e),artifact:n,tool_call_id:r,name:t.name,metadata:s}):e}function CD(t){try{return JSON.stringify(t,null,2)??""}catch{return`${t}`}}var fT={};ve(fT,{RunCollectorCallbackHandler:()=>kD});var kD=class extends ws{constructor({exampleId:e}={}){super({_awaitHandler:!0});p(this,"name","run_collector");p(this,"exampleId");p(this,"tracedRuns");this.exampleId=e,this.tracedRuns=[]}async persistRun(e){const n={...e};n.reference_example_id=this.exampleId,this.tracedRuns.push(n)}},ID={},pT={};ve(pT,{chunkArray:()=>RD});const RD=(t,e)=>t.reduce((n,r,s)=>{const i=Math.floor(s/e),a=n[i]||[];return n[i]=a.concat([r]),n},[]);var mT={};ve(mT,{EventStreamContentType:()=>OD,convertEventStreamToIterableReadableDataStream:()=>ND,getBytes:()=>gT,getLines:()=>yT,getMessages:()=>_T});const OD="text/event-stream";async function gT(t,e){if(t instanceof ReadableStream){const n=t.getReader();for(;;){const r=await n.read();if(r.done){e(new Uint8Array,!0);break}e(r.value)}}else try{for await(const n of t)e(new Uint8Array(n));e(new Uint8Array,!0)}catch(n){throw new Error(["Parsing event source stream failed.","Ensure your implementation of fetch returns a web or Node readable stream.",`Error: ${n.message}`].join(`
`))}}var aa=(function(t){return t[t.NewLine=10]="NewLine",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.Colon=58]="Colon",t})(aa||{});function yT(t){let e,n,r,s=!1;return function(a,o){if(o){t(a,0,!0);return}e===void 0?(e=a,n=0,r=-1):e=$D(e,a);const c=e.length;let u=0;for(;n<c;){s&&(e[n]===aa.NewLine&&(u=++n),s=!1);let l=-1;for(;n<c&&l===-1;++n)switch(e[n]){case aa.Colon:r===-1&&(r=n-u);break;case aa.CarriageReturn:s=!0;case aa.NewLine:l=n;break}if(l===-1)break;t(e.subarray(u,l),r),u=n,r=-1}u===c?e=void 0:u!==0&&(e=e.subarray(u),n-=u)}}function _T(t,e,n){let r=lf();const s=new TextDecoder;return function(a,o,c){if(c){PD(r)||(t==null||t(r),r=lf());return}if(a.length===0)t==null||t(r),r=lf();else if(o>0){const u=s.decode(a.subarray(0,o)),l=o+(a[o+1]===aa.Space?2:1),d=s.decode(a.subarray(l));switch(u){case"data":r.data=r.data?r.data+`
`+d:d;break;case"event":r.event=d;break;case"id":e==null||e(r.id=d);break;case"retry":{const h=parseInt(d,10);Number.isNaN(h)||n==null||n(r.retry=h);break}}}}}function $D(t,e){const n=new Uint8Array(t.length+e.length);return n.set(t),n.set(e,t.length),n}function lf(){return{data:"",event:"",id:"",retry:void 0}}function ND(t,e){const n=new ReadableStream({async start(r){const s=_T(a=>{if(a.event==="error")throw new Error(a.data??"Unspecified event streaming error.");a.event==="metadata"?e==null||e(a):a.data&&r.enqueue(a.data)});await gT(t,yT((a,o,c)=>{s(a,o,c),c&&r.close()}))}});return kn.fromReadableStream(n)}function PD(t){return t.data===""&&t.event===""&&t.id===""&&t.retry===void 0}var wT={};ve(wT,{convertToOpenAIFunction:()=>bT,convertToOpenAITool:()=>vT,isLangChainTool:()=>_c,isRunnableToolLike:()=>Pg,isStructuredTool:()=>Ng,isStructuredToolParams:()=>Lg});function bT(t,e){const n=typeof e=="number"?void 0:e;return{name:t.name,description:t.description,parameters:nn(t.schema),...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}}function vT(t,e){const n=typeof e=="number"?void 0:e;let r;return _c(t)?r={type:"function",function:bT(t)}:r=t,(n==null?void 0:n.strict)!==void 0&&(r.function.strict=n.strict),r}function ET(t,e){let n=0,r=0,s=0;for(let i=0;i<t.length;i++)n+=t[i]*e[i],r+=t[i]*t[i],s+=e[i]*e[i];return n/(Math.sqrt(r)*Math.sqrt(s))}function LD(t,e){let n=0;for(let r=0;r<t.length;r++)n+=t[r]*e[r];return n}function MD(t,e){let n=0;for(let r=0;r<t.length;r++)n+=(t[r]-e[r])*(t[r]-e[r]);return n}function DD(t,e){return Math.sqrt(MD(t,e))}var ST={};ve(ST,{cosineSimilarity:()=>Mp,euclideanDistance:()=>jD,innerProduct:()=>BD,matrixFunc:()=>fd,maximalMarginalRelevance:()=>FD,normalize:()=>UD});function fd(t,e,n){if(t.length===0||t[0].length===0||e.length===0||e[0].length===0)return[[]];if(t[0].length!==e[0].length)throw new Error(`Number of columns in X and Y must be the same. X has shape ${[t.length,t[0].length]} and Y has shape ${[e.length,e[0].length]}.`);return t.map(r=>e.map(s=>n(r,s)).map(s=>Number.isNaN(s)?0:s))}function UD(t,e=!1){const n=zD(t);return t.map(r=>r.map(s=>e?1-s/n:s/n))}function Mp(t,e){return fd(t,e,ET)}function BD(t,e){return fd(t,e,LD)}function jD(t,e){return fd(t,e,DD)}function FD(t,e,n=.5,r=4){if(Math.min(r,e.length)<=0)return[];const s=Array.isArray(t[0])?t:[t],i=Mp(s,e)[0],a=xT(i).maxIndex,o=[e[a]],c=[a];for(;c.length<Math.min(r,e.length);){let u=-1/0,l=-1;const d=Mp(e,o);i.forEach((h,f)=>{if(c.includes(f))return;const m=Math.max(...d[f]),g=n*h-(1-n)*m;g>u&&(u=g,l=f)}),o.push(e[l]),c.push(l)}return c}function xT(t){if(t.length===0)return{maxIndex:-1,maxValue:NaN};let e=t[0],n=0;for(let r=1;r<t.length;r+=1)t[r]>e&&(n=r,e=t[r]);return{maxIndex:n,maxValue:e}}function zD(t){return t.reduce((e,n)=>Math.max(e,xT(n).maxValue),0)}var VD=class extends Pi{_combineLLMOutput(){return[]}_llmType(){return"fake"}async _generate(t,e,n){var s;if((s=e==null?void 0:e.stop)!=null&&s.length)return{generations:[{message:new ht(e.stop[0]),text:e.stop[0]}]};const r=t.map(i=>typeof i.content=="string"?i.content:JSON.stringify(i.content,null,2)).join(`
`);return await(n==null?void 0:n.handleLLMNewToken(r)),{generations:[{message:new ht(r),text:r}],llmOutput:{}}}},qD=class TT extends Pi{constructor({sleep:n=50,responses:r=[],chunks:s=[],toolStyle:i="openai",thrownErrorString:a,...o}){super(o);p(this,"sleep",50);p(this,"responses",[]);p(this,"chunks",[]);p(this,"toolStyle","openai");p(this,"thrownErrorString");p(this,"tools",[]);this.sleep=n,this.responses=r,this.chunks=s,this.toolStyle=i,this.thrownErrorString=a}_llmType(){return"fake"}bindTools(n){const r=[...this.tools,...n],s=r.map(o=>{switch(this.toolStyle){case"openai":return{type:"function",function:{name:o.name,description:o.description,parameters:nn(o.schema)}};case"anthropic":return{name:o.name,description:o.description,input_schema:nn(o.schema)};case"bedrock":return{toolSpec:{name:o.name,description:o.description,inputSchema:nn(o.schema)}};case"google":return{name:o.name,description:o.description,parameters:nn(o.schema)};default:throw new Error(`Unsupported tool style: ${this.toolStyle}`)}}),i=this.toolStyle==="google"?[{functionDeclarations:s}]:s,a=new TT({sleep:this.sleep,responses:this.responses,chunks:this.chunks,toolStyle:this.toolStyle,thrownErrorString:this.thrownErrorString});return a.tools=r,a.withConfig({tools:i})}async _generate(n,r,s){var o,c,u,l;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const i=((c=(o=this.responses)==null?void 0:o[0])==null?void 0:c.content)??n[0].content??"";return{generations:[{text:"",message:new ht({content:i,tool_calls:(l=(u=this.chunks)==null?void 0:u[0])==null?void 0:l.tool_calls})}]}}async*_streamResponseChunks(n,r,s){var o,c,u;if(this.thrownErrorString)throw new Error(this.thrownErrorString);if((o=this.chunks)!=null&&o.length){for(const l of this.chunks){const d=new fn({message:new Et({content:l.content,tool_calls:l.tool_calls,additional_kwargs:l.additional_kwargs??{}}),text:((c=l.content)==null?void 0:c.toString())??""});yield d,await(s==null?void 0:s.handleLLMNewToken(l.content,void 0,void 0,void 0,void 0,{chunk:d}))}return}const i=((u=this.responses)==null?void 0:u[0])??new ht(typeof n[0].content=="string"?n[0].content:""),a=typeof i.content=="string"?i.content:"";for(const l of a){await new Promise(h=>setTimeout(h,this.sleep));const d=new fn({message:new Et({content:l}),text:l});yield d,await(s==null?void 0:s.handleLLMNewToken(l,void 0,void 0,void 0,void 0,{chunk:d}))}}},HD=class extends Pi{constructor(e){super(e);p(this,"lc_serializable",!0);p(this,"responses");p(this,"i",0);p(this,"sleep");p(this,"emitCustomEvent",!1);const{responses:n,sleep:r,emitCustomEvent:s}=e;this.responses=n,this.sleep=r,this.emitCustomEvent=s??this.emitCustomEvent}static lc_name(){return"FakeListChatModel"}_combineLLMOutput(){return[]}_llmType(){return"fake-list"}async _generate(e,n,r){var s;if(await this._sleepIfRequested(),n!=null&&n.thrownErrorString)throw new Error(n.thrownErrorString);if(this.emitCustomEvent&&await(r==null?void 0:r.handleCustomEvent("some_test_event",{someval:!0})),(s=n==null?void 0:n.stop)!=null&&s.length)return{generations:[this._formatGeneration(n.stop[0])]};{const i=this._currentResponse();return this._incrementResponse(),{generations:[this._formatGeneration(i)],llmOutput:{}}}}_formatGeneration(e){return{message:new ht(e),text:e}}async*_streamResponseChunks(e,n,r){const s=this._currentResponse();this._incrementResponse(),this.emitCustomEvent&&await(r==null?void 0:r.handleCustomEvent("some_test_event",{someval:!0}));for await(const i of s){if(await this._sleepIfRequested(),n!=null&&n.thrownErrorString)throw new Error(n.thrownErrorString);yield this._createResponseChunk(i),r==null||r.handleLLMNewToken(i)}}async _sleepIfRequested(){this.sleep!==void 0&&await this._sleep()}async _sleep(){return new Promise(e=>{setTimeout(()=>e(),this.sleep)})}_createResponseChunk(e){return new fn({message:new Et({content:e}),text:e})}_currentResponse(){return this.responses[this.i]}_incrementResponse(){this.i<this.responses.length-1?this.i+=1:this.i=0}withStructuredOutput(e,n){return Tr.from(async r=>{var i,a;const s=await this.invoke(r);if((a=(i=s.tool_calls)==null?void 0:i[0])!=null&&a.args)return s.tool_calls[0].args;if(typeof s.content=="string")return JSON.parse(s.content);throw new Error("No structured output found")})}},GD=class extends fg{constructor(e){super(e??{});p(this,"vectorSize");this.vectorSize=(e==null?void 0:e.vectorSize)??4}async embedDocuments(e){return Promise.all(e.map(n=>this.embedQuery(n)))}async embedQuery(e){let n=e;n=n.toLowerCase().replaceAll(/[^a-z ]/g,"");const r=n.length%this.vectorSize,s=r===0?0:this.vectorSize-r,i=n.length+s;n=n.padEnd(i," ");const a=n.length/this.vectorSize,o=[];for(let u=0;u<n.length;u+=a)o.push(n.slice(u,u+a));return o.map(u=>{let l=0;for(let h=0;h<u.length;h+=1)l+=u===" "?0:u.charCodeAt(h);return l%26/26})}},WD=class extends fg{constructor(t){super(t??{})}embedDocuments(t){return Promise.resolve(t.map(()=>[.1,.2,.3,.4]))}embedQuery(t){return Promise.resolve([.1,.2,.3,.4])}},JD=class extends Sg{constructor(e){super(e);p(this,"response");p(this,"thrownErrorString");this.response=e.response,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e,n,r){if(this.thrownErrorString)throw new Error(this.thrownErrorString);const s=this.response??e;return await(r==null?void 0:r.handleLLMNewToken(s)),s}},ZD=class extends Sg{constructor(e){super(e);p(this,"sleep",50);p(this,"responses");p(this,"thrownErrorString");this.sleep=e.sleep??this.sleep,this.responses=e.responses,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e){var r,s;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const n=(r=this.responses)==null?void 0:r[0];return this.responses=(s=this.responses)==null?void 0:s.slice(1),n??e}async*_streamResponseChunks(e,n,r){var i,a;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const s=(i=this.responses)==null?void 0:i[0];this.responses=(a=this.responses)==null?void 0:a.slice(1);for(const o of s??e)await new Promise(c=>setTimeout(c,this.sleep)),yield{text:o,generationInfo:{}},await(r==null?void 0:r.handleLLMNewToken(o))}},KD=class extends GS{constructor(){super();p(this,"lc_namespace",["langchain_core","message","fake"]);p(this,"messages",[])}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async addUserMessage(e){this.messages.push(new It(e))}async addAIMessage(e){this.messages.push(new ht(e))}async clear(){this.messages=[]}},XD=class extends hg{constructor(){super();p(this,"lc_namespace",["langchain_core","message","fake"]);p(this,"messages",[])}async addMessage(e){this.messages.push(e)}async getMessages(){return this.messages}},YD=class extends ws{constructor(){super();p(this,"name","fake_tracer");p(this,"runs",[])}persistRun(e){return this.runs.push(e),Promise.resolve()}},QD=class extends dc{constructor(){super(...arguments);p(this,"lc_namespace",["tests","fake"])}getFormatInstructions(){return""}async parse(e){return e.split(",").map(n=>n.trim())}},e4=class extends gg{constructor(e){super();p(this,"lc_namespace",["test","fake"]);p(this,"output",[new Ms({pageContent:"foo"}),new Ms({pageContent:"bar"})]);this.output=(e==null?void 0:e.output)??this.output}async _getRelevantDocuments(e){return this.output}},t4=class extends je{constructor(e){super(e);p(this,"lc_namespace",["tests","fake"]);p(this,"returnOptions");this.returnOptions=e.returnOptions}async invoke(e,n){return this.returnOptions?n??{}:{input:e}}},n4=class extends hd{constructor(e){super(e);p(this,"name");p(this,"description");p(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}async _call(e,n){return JSON.stringify(e)}},r4=class extends ws{constructor(){super();p(this,"runPromiseResolver");p(this,"runPromise");p(this,"name","single_run_extractor");this.runPromise=new Promise(e=>{this.runPromiseResolver=e})}async persistRun(e){this.runPromiseResolver(e)}async extract(){return this.runPromise}},s4=class AT extends yg{constructor(n,{similarity:r,...s}={}){super(n,s);p(this,"memoryVectors",[]);p(this,"similarity");this.similarity=r??ET}_vectorstoreType(){return"memory"}async addDocuments(n){const r=n.map(({pageContent:s})=>s);return this.addVectors(await this.embeddings.embedDocuments(r),n)}async addVectors(n,r){const s=n.map((i,a)=>({content:r[a].pageContent,embedding:i,metadata:r[a].metadata}));this.memoryVectors=this.memoryVectors.concat(s)}async similaritySearchVectorWithScore(n,r,s){const i=u=>{if(!s)return!0;const l=new Ms({metadata:u.metadata,pageContent:u.content});return s(l)},a=this.memoryVectors.filter(i);return a.map((u,l)=>({similarity:this.similarity(n,u.embedding),index:l})).sort((u,l)=>u.similarity>l.similarity?-1:0).slice(0,r).map(u=>[new Ms({metadata:a[u.index].metadata,pageContent:a[u.index].content}),u.similarity])}static async fromTexts(n,r,s,i){const a=[];for(let o=0;o<n.length;o+=1){const c=Array.isArray(r)?r[o]:r,u=new Ms({pageContent:n[o],metadata:c});a.push(u)}return AT.fromDocuments(a,s,i)}static async fromDocuments(n,r,s){const i=new this(r,s);return await i.addDocuments(n),i}static async fromExistingIndex(n,r){return new this(n,r)}},CT={};ve(CT,{FakeChatMessageHistory:()=>KD,FakeChatModel:()=>VD,FakeEmbeddings:()=>WD,FakeLLM:()=>JD,FakeListChatMessageHistory:()=>XD,FakeListChatModel:()=>HD,FakeRetriever:()=>e4,FakeRunnable:()=>t4,FakeSplitIntoListParser:()=>QD,FakeStreamingChatModel:()=>qD,FakeStreamingLLM:()=>ZD,FakeTool:()=>n4,FakeTracer:()=>YD,FakeVectorStore:()=>s4,SingleRunExtractor:()=>r4,SyntheticEmbeddings:()=>GD});var kT={};ve(kT,{extendInteropZodObject:()=>yS,getInteropZodDefaultGetter:()=>_S,getInteropZodObjectShape:()=>Po,getSchemaDescription:()=>xi,interopParse:()=>mu,interopParseAsync:()=>rd,interopSafeParse:()=>eP,interopSafeParseAsync:()=>gS,interopZodObjectMakeFieldsOptional:()=>sP,interopZodObjectPartial:()=>ag,interopZodObjectPassthrough:()=>pp,interopZodObjectStrict:()=>Yu,interopZodTransformInputSchema:()=>ia,isInteropZodLiteral:()=>QN,isInteropZodObject:()=>yr,isInteropZodSchema:()=>tr,isShapelessZodSchema:()=>tP,isSimpleStringZodSchema:()=>sg,isZodArrayV4:()=>sd,isZodLiteralV3:()=>pS,isZodLiteralV4:()=>mS,isZodObjectV3:()=>ig,isZodObjectV4:()=>qr,isZodSchema:()=>YN,isZodSchemaV3:()=>gt,isZodSchemaV4:()=>ft});var IT={};ve(IT,{agents:()=>m1,caches:()=>rx,callbacks__base:()=>iE,callbacks__manager:()=>FE,callbacks__promises:()=>$E,chat_history:()=>HS,document_loaders__base:()=>cx,document_loaders__langsmith:()=>lx,documents:()=>hx,embeddings:()=>WS,example_selectors:()=>gx,index:()=>_L,indexing:()=>Ex,language_models__base:()=>Ax,language_models__chat_models:()=>kx,language_models__llms:()=>Ix,load__serializable:()=>Lv,memory:()=>JS,messages:()=>qS,messages__tool:()=>nE,output_parsers:()=>Lx,output_parsers__openai_functions:()=>Fx,output_parsers__openai_tools:()=>Ux,outputs:()=>tS,prompt_values:()=>KS,prompts:()=>eT,retrievers:()=>ex,retrievers__document_compressors:()=>tT,runnables:()=>Ox,runnables__graph:()=>$S,singletons:()=>WE,stores:()=>YS,structured_query:()=>cT,tools:()=>uT,tracers__base:()=>TE,tracers__console:()=>CE,tracers__log_stream:()=>QE,tracers__run_collector:()=>fT,tracers__tracer_langchain:()=>IE,types__stream:()=>ID,utils__async_caller:()=>sS,utils__chunk_array:()=>pT,utils__env:()=>Fv,utils__event_source_parse:()=>mT,utils__function_calling:()=>wT,utils__hash:()=>nx,utils__json_patch:()=>$x,utils__json_schema:()=>OS,utils__math:()=>ST,utils__stream:()=>JE,utils__testing:()=>CT,utils__tiktoken:()=>xx,utils__types:()=>kT,vectorstores:()=>tx});function i4(t){const e={};for(let n=t;n&&n.prototype;n=Object.getPrototypeOf(n))Object.assign(e,Reflect.get(n.prototype,"lc_aliases"));return Object.entries(e).reduce((n,[r,s])=>(n[s]=r,n),{})}async function vu(t){const{optionalImportsMap:e={},optionalImportEntrypoints:n=[],importMap:r={},secretsMap:s={},path:i=["$"]}=this,a=i.join(".");if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&t.lc===1&&t.type==="secret"){const o=t,[c]=o.id;if(c in s)return s[c];{const u=nr(c);if(u)return u;throw new Error(`Missing key "${c}" for ${a} in load(secretsMap={})`)}}else if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&t.lc===1&&t.type==="not_implemented"){const c=JSON.stringify(t);throw new Error(`Trying to load an object that doesn't implement serialization: ${a} -> ${c}`)}else if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&"kwargs"in t&&t.lc===1){const o=t,c=JSON.stringify(o),[u,...l]=o.id.slice().reverse(),d=l.reverse(),h={langchain_core:IT,langchain:r};let f=null;const m=[d.join("/")];d[0]==="langchain_community"&&m.push(["langchain",...d.slice(1)].join("/"));const g=m.find(y=>y in e);if(p1.concat(n).includes(d.join("/"))||g)if(g!==void 0)f=await e[g];else throw new Error(`Missing key "${d.join("/")}" for ${a} in load(optionalImportsMap={})`);else{let y;if(d[0]==="langchain"||d[0]==="langchain_core")y=h[d[0]],d.shift();else throw new Error(`Invalid namespace: ${a} -> ${c}`);if(d.length===0)throw new Error(`Invalid namespace: ${a} -> ${c}`);let E;do{if(E=d.join("__"),E in y)break;d.pop()}while(d.length>0);E in y&&(f=y[E])}if(typeof f!="object"||f===null)throw new Error(`Invalid namespace: ${a} -> ${c}`);const _=f[u]??Object.values(f).find(y=>typeof y=="function"&&Vl(y)===u);if(typeof _!="function")throw new Error(`Invalid identifer: ${a} -> ${c}`);const b=await vu.call({...this,path:[...i,"kwargs"]},o.kwargs);if(o.type==="constructor"){const y=new _(Pv(b,o1,i4(_)));return Object.defineProperty(y.constructor,"name",{value:u}),y}else throw new Error(`Invalid type: ${a} -> ${c}`)}else if(typeof t=="object"&&t!==null)return Array.isArray(t)?Promise.all(t.map((o,c)=>vu.call({...this,path:[...i,`${c}`]},o))):Object.fromEntries(await Promise.all(Object.entries(t).map(async([o,c])=>[o,await vu.call({...this,path:[...i,o]},c)])));return t}async function a4(t,e){const n=JSON.parse(t);return vu.call({...e},n)}function o4(t){return t!==null&&t.lc===1&&t.type==="constructor"&&Array.isArray(t.id)}async function Dp(t){if(t&&typeof t=="object"){if(Array.isArray(t))return await Promise.all(t.map(n=>Dp(n)));{const e={};for(const[n,r]of Object.entries(t))e[n]=await Dp(r);if(e.lc===2&&e.type==="undefined")return;if(e.lc===2&&e.type==="constructor"&&Array.isArray(e.id))try{const n=e.id[e.id.length-1];let r;switch(n){case"Set":r=Set;break;case"Map":r=Map;break;case"RegExp":r=RegExp;break;case"Error":r=Error;break;default:return e}return e.method?r[e.method](...e.args||[]):new r(...e.args||[])}catch{return e}else if(o4(e))return a4(JSON.stringify(e));return e}}return t}function df(t,e,n,r){return{lc:2,type:"constructor",id:[t.name],method:e??null,args:n??[],kwargs:r??{}}}function c4(t){return t===void 0?{lc:2,type:"undefined"}:t instanceof Set||t instanceof Map?df(t.constructor,void 0,[Array.from(t)]):t instanceof RegExp?df(RegExp,void 0,[t.source,t.flags]):t instanceof Error?df(t.constructor,void 0,[t.message]):(t==null?void 0:t.lg_name)==="Send"?{node:t.node,args:t.args}:t}var u4=class{_dumps(t){return new TextEncoder().encode(YI(t,(n,r)=>c4(r)))}async dumpsTyped(t){return t instanceof Uint8Array?["bytes",t]:["json",this._dumps(t)]}async _loads(t){const e=JSON.parse(t);return Dp(e)}async loadsTyped(t,e){if(t==="bytes")return typeof e=="string"?new TextEncoder().encode(e):e;if(t==="json")return this._loads(typeof e=="string"?e:new TextDecoder().decode(e));throw new Error(`Unknown serialization type: ${t}`)}};function RT(t){if(typeof t!="object"||t===null)return t;const e=Array.isArray(t)?[]:{};for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=RT(t[n]));return e}function OT(){return{v:4,id:Nv(-2),ts:new Date().toISOString(),channel_values:{},channel_versions:{},versions_seen:{}}}function hl(t){return{v:t.v,id:t.id,ts:t.ts,channel_values:{...t.channel_values},channel_versions:{...t.channel_versions},versions_seen:RT(t.versions_seen)}}function $T(t,e){return typeof t=="number"&&typeof e=="number"?Math.sign(t-e):String(t).localeCompare(String(e))}function l4(...t){return t.reduce((e,n,r)=>r===0?n:$T(e,n)>=0?e:n)}const d4={[WI]:-1,[du]:-2,[JI]:-3,[ZI]:-4};var qa=class extends Error{constructor(t){super(t),this.name="InvalidNamespaceError"}};function h4(t){if(t.length===0)throw new qa("Namespace cannot be empty.");for(const e of t){if(typeof e!="string")throw new qa(`Invalid namespace label '${e}' found in ${t}. Namespace labels must be strings, but got ${typeof e}.`);if(e.includes("."))throw new qa(`Invalid namespace label '${e}' found in ${t}. Namespace labels cannot contain periods ('.').`);if(e==="")throw new qa(`Namespace labels cannot be empty strings. Got ${e} in ${t}`)}if(t[0]==="langgraph")throw new qa(`Root label for namespace cannot be "langgraph". Got: ${t}`)}var f4=class{async get(t,e){return(await this.batch([{namespace:t,key:e}]))[0]}async search(t,e={}){const{filter:n,limit:r=10,offset:s=0,query:i}=e;return(await this.batch([{namespacePrefix:t,filter:n,limit:r,offset:s,query:i}]))[0]}async put(t,e,n,r){h4(t),await this.batch([{namespace:t,key:e,value:n,index:r}])}async delete(t,e){await this.batch([{namespace:t,key:e,value:null}])}async listNamespaces(t={}){const{prefix:e,suffix:n,maxDepth:r,limit:s=100,offset:i=0}=t,a=[];return e&&a.push({matchType:"prefix",path:e}),n&&a.push({matchType:"suffix",path:n}),(await this.batch([{matchConditions:a.length?a:void 0,maxDepth:r,limit:s,offset:i}]))[0]}start(){}stop(){}};const p4=t=>"lg_name"in t&&t.lg_name==="AsyncBatchedStore"?t.store:t;var m4=class extends f4{constructor(e){super();p(this,"lg_name","AsyncBatchedStore");p(this,"store");p(this,"queue",new Map);p(this,"nextKey",0);p(this,"running",!1);p(this,"processingTask",null);this.store=p4(e)}get isRunning(){return this.running}async batch(e){throw new Error("The `batch` method is not implemented on `AsyncBatchedStore`.\n Instead, it calls the `batch` method on the wrapped store.\n If you are seeing this error, something is wrong.")}async get(e,n){return this.enqueueOperation({namespace:e,key:n})}async search(e,n){const{filter:r,limit:s=10,offset:i=0,query:a}=n||{};return this.enqueueOperation({namespacePrefix:e,filter:r,limit:s,offset:i,query:a})}async put(e,n,r){return this.enqueueOperation({namespace:e,key:n,value:r})}async delete(e,n){return this.enqueueOperation({namespace:e,key:n,value:null})}start(){this.running||(this.running=!0,this.processingTask=this.processBatchQueue())}async stop(){this.running=!1,this.processingTask&&await this.processingTask}enqueueOperation(e){return new Promise((n,r)=>{const s=this.nextKey;this.nextKey+=1,this.queue.set(s,{operation:e,resolve:n,reject:r})})}async processBatchQueue(){for(;this.running;){if(await new Promise(n=>{setTimeout(n,0)}),this.queue.size===0)continue;const e=new Map(this.queue);this.queue.clear();try{const n=Array.from(e.values()).map(({operation:s})=>s),r=await this.store.batch(n);e.forEach(({resolve:s},i)=>{const a=Array.from(e.keys()).indexOf(i);s(r[a])})}catch(n){e.forEach(({reject:r})=>{r(n)})}}}toJSON(){return{queue:this.queue,nextKey:this.nextKey,running:this.running,store:"[LangGraphStore]"}}},g4=class{constructor(t){p(this,"serde",new u4);this.serde=t||this.serde}};function NT(t){return t!=null&&t.lg_is_channel===!0}var Li=class{constructor(){p(this,"ValueType");p(this,"UpdateType");p(this,"lg_is_channel",!0)}consume(){return!1}finish(){return!1}isAvailable(){try{return this.get(),!0}catch(t){if(t.name===Zt.unminifiable_name)return!1;throw t}}};const Up=Symbol.for("LG_IS_ONLY_BASE_CHANNEL");function Mg(t){if(t[Up]===!0)return t;const e={};for(const n in t){if(!Object.prototype.hasOwnProperty.call(t,n))continue;const r=t[n];NT(r)&&(e[n]=r)}return Object.assign(e,{[Up]:!0}),e}function fl(t,e){const n=Mg(t),r={};for(const s in n){if(!Object.prototype.hasOwnProperty.call(n,s))continue;const i=e.channel_values[s];r[s]=n[s].fromCheckpoint(i)}return Object.assign(r,{[Up]:!0}),r}function ii(t,e,n,r){let s;if(e===void 0)s=t.channel_values;else{s={};for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i))try{s[i]=e[i].checkpoint()}catch(a){if(a.name!==Zt.unminifiable_name)throw a}}return{v:4,id:(r==null?void 0:r.id)??Nv(n),ts:new Date().toISOString(),channel_values:s,channel_versions:t.channel_versions,versions_seen:t.versions_seen}}var Bp=class PT extends Li{constructor(n,r){super();p(this,"lc_graph_name","BinaryOperatorAggregate");p(this,"value");p(this,"operator");p(this,"initialValueFactory");this.operator=n,this.initialValueFactory=r,this.value=r==null?void 0:r()}fromCheckpoint(n){const r=new PT(this.operator,this.initialValueFactory);return typeof n<"u"&&(r.value=n),r}update(n){let r=n;if(!r.length)return!1;this.value===void 0&&([this.value]=r,r=r.slice(1));for(const s of r)this.value!==void 0&&(this.value=this.operator(this.value,s));return!0}get(){if(this.value===void 0)throw new Zt;return this.value}checkpoint(){if(this.value===void 0)throw new Zt;return this.value}isAvailable(){return this.value!==void 0}},Dg=class LT extends Li{constructor(){super(...arguments);p(this,"lc_graph_name","LastValue");p(this,"value",[])}fromCheckpoint(n){const r=new LT;return typeof n<"u"&&(r.value=[n]),r}update(n){if(n.length===0)return!1;if(n.length!==1)throw new at("LastValue can only receive one value per step.",{lc_error_code:"INVALID_CONCURRENT_GRAPH_UPDATE"});return this.value=[n[n.length-1]],!0}get(){if(this.value.length===0)throw new Zt;return this.value[0]}checkpoint(){if(this.value.length===0)throw new Zt;return this.value[0]}isAvailable(){return this.value.length!==0}},y4=class MT extends Li{constructor(){super(...arguments);p(this,"lc_graph_name","LastValueAfterFinish");p(this,"value",[]);p(this,"finished",!1)}fromCheckpoint(n){const r=new MT;if(typeof n<"u"){const[s,i]=n;r.value=[s],r.finished=i}return r}update(n){return n.length===0?!1:(this.finished=!1,this.value=[n[n.length-1]],!0)}get(){if(this.value.length===0||!this.finished)throw new Zt;return this.value[0]}checkpoint(){if(this.value.length!==0)return[this.value[0],this.finished]}consume(){return this.finished?(this.finished=!1,this.value=[],!0):!1}finish(){return!this.finished&&this.value.length>0?(this.finished=!0,!0):!1}isAvailable(){return this.value.length!==0&&this.finished}},_4=class{constructor(t){p(this,"lc_graph_name","AnnotationRoot");p(this,"spec");this.spec=t}};const pt=function(t){return t?jp(t):new Dg};pt.Root=t=>new _4(t);function jp(t){return typeof t=="object"&&t&&"reducer"in t&&t.reducer?new Bp(t.reducer,t.default):typeof t=="object"&&t&&"value"in t&&t.value?new Bp(t.value,t.default):new Dg}const Qe="__start__",Fe="__end__",ss="__input__",w4="__copy__",xn="__error__",hf="__pregel_ns_writes",Us="__pregel_send",Ug="__pregel_call",gi="__pregel_read",yt="__pregel_checkpointer",Is="__pregel_resuming",yo="__pregel_task_id",pl="__pregel_stream",b4="__pregel_resume_value",Eu="__pregel_resume_map",Bs="__pregel_scratchpad",Su="__pregel_previous",DT="__pregel_durability",Fp="checkpoint_id",Mr="checkpoint_ns",v4="__pregel_node_finished",Xn="checkpoint_map",gb="__pregel_abort_signals",qe="__interrupt__",Cn="__resume__",Bg="__no_writes__",xa="__return__",ff="__previous__",bt="langsmith:hidden",E4="langsmith:nostream",yb="__self__",Yn="__pregel_tasks",Bn="__pregel_push",xu="__pregel_pull",Qn="00000000-0000-0000-0000-000000000000",S4=[bt,ss,qe,Cn,xn,Bg,Us,gi,yt,DT,pl,Is,yo,Ug,b4,Bs,Su,Xn,Mr,Fp],Ot="|",ds=":",_b=Symbol.for("langgraph.command");var Cv,x4=(Cv=_b,class{constructor(t){p(this,Cv);this[_b]=t}});function zp(t){const e=t;return e!=null&&typeof e.node=="string"&&e.args!==void 0}var ml=class{constructor(t,e){p(this,"lg_name","Send");p(this,"node");p(this,"args");this.node=t,this.args=zo(e)}toJSON(){return{lg_name:this.lg_name,node:this.node,args:this.args}}};function qn(t){return t instanceof ml}function UT(t){return!t||typeof t!="object"||!(qe in t)?!1:Array.isArray(t[qe])}var Wf,dn=(Wf=class extends x4{constructor(n){super(n);p(this,"lg_name","Command");p(this,"lc_direct_tool_output",!0);p(this,"graph");p(this,"update");p(this,"resume");p(this,"goto",[]);this.resume=n.resume,this.graph=n.graph,this.update=n.update,n.goto&&(this.goto=Array.isArray(n.goto)?zo(n.goto):[zo(n.goto)])}_updateAsTuples(){return this.update&&typeof this.update=="object"&&!Array.isArray(this.update)?Object.entries(this.update):Array.isArray(this.update)&&this.update.every(n=>Array.isArray(n)&&n.length===2&&typeof n[0]=="string")?this.update:[["__root__",this.update]]}toJSON(){var r;let n;return typeof this.goto=="string"?n=this.goto:qn(this.goto)?n=this.goto.toJSON():n=(r=this.goto)==null?void 0:r.map(s=>typeof s=="string"?s:s.toJSON()),{lg_name:this.lg_name,update:this.update,resume:this.resume,goto:n}}},p(Wf,"PARENT","__parent__"),Wf);function bn(t){return typeof t!="object"||t==null?!1:"lg_name"in t&&t.lg_name==="Command"}function zo(t,e=new Map){if(t!=null&&typeof t=="object"){if(e.has(t))return e.get(t);let n;if(Array.isArray(t))n=[],e.set(t,n),t.forEach((r,s)=>{n[s]=zo(r,e)});else if(bn(t)&&!(t instanceof dn))n=new dn(t),e.set(t,n);else if(zp(t)&&!(t instanceof ml))n=new ml(t.node,t.args),e.set(t,n);else if(bn(t)||qn(t))n=t,e.set(t,n);else if("lc_serializable"in t&&t.lc_serializable)n=t,e.set(t,n);else{n={},e.set(t,n);for(const[r,s]of Object.entries(t))n[r]=zo(s,e)}return n}return t}const T4=["tags","metadata","callbacks","configurable"],A4=["tags","metadata","callbacks","runName","maxConcurrency","recursionLimit","configurable","runId","outputKeys","streamMode","store","writer","interrupt","context","interruptBefore","interruptAfter","checkpointDuring","durability","signal"],C4=25;function BT(...t){const e={tags:[],metadata:{},callbacks:void 0,recursionLimit:C4,configurable:{}},n=Dt.getRunnableConfig();if(n!==void 0){for(const[r,s]of Object.entries(n))if(s!==void 0)if(T4.includes(r)){let i;Array.isArray(s)?i=[...s]:typeof s=="object"?r==="callbacks"&&"copy"in s&&typeof s.copy=="function"?i=s.copy():i={...s}:i=s,e[r]=i}else e[r]=s}for(const r of t)if(r!==void 0)for(const[s,i]of Object.entries(r))i!==void 0&&A4.includes(s)&&(e[s]=i);for(const[r,s]of Object.entries(e.configurable))e.metadata=e.metadata??{},!r.startsWith("__")&&(typeof s=="string"||typeof s=="number"||typeof s=="boolean")&&!(r in e.metadata)&&(e.metadata[r]=s);return e}function k4(){return Dt.getRunnableConfig()}function pf(t){return t.split(Ot).filter(e=>!e.match(/^\d+$/)).map(e=>e.split(ds)[0]).join(Ot)}function I4(t){const e=t.split(Ot);for(;e.length>1&&e[e.length-1].match(/^\d+$/);)e.pop();return e.slice(0,-1).join(Ot)}var Mi=class extends je{constructor(e){super();p(this,"lc_namespace",["langgraph"]);p(this,"func");p(this,"tags");p(this,"config");p(this,"trace",!0);p(this,"recurse",!0);this.name=e.name??e.func.name,this.func=e.func,this.config=e.tags?{tags:e.tags}:void 0,this.trace=e.trace??this.trace,this.recurse=e.recurse??this.recurse}async _tracedInvoke(e,n,r){return new Promise((s,i)=>{const a=Je(n,{callbacks:r==null?void 0:r.getChild()});Dt.runWithConfig(a,async()=>{try{const o=await this.func(e,a);s(o)}catch(o){i(o)}})})}async invoke(e,n){let r;const s=BT(n),i=er(this.config,s);return this.trace?r=await this._callWithConfig(this._tracedInvoke,e,i):r=await Dt.runWithConfig(i,async()=>this.func(e,i)),je.isRunnable(r)&&this.recurse?await Dt.runWithConfig(i,async()=>r.invoke(e,i)):r}};function*Ss(t,e){if(e===void 0)yield*t;else for(const n of t)yield[e,n]}async function Os(t){const e=[];for await(const n of await t)e.push(n);return e}function Qa(t){const e=[];for(const n of t)e.push(n);return e}function ji(t,e){return t?"configurable"in t?{...t,configurable:{...t.configurable,...e}}:{...t,configurable:e}:{configurable:e}}function R4(t){return typeof t=="object"&&(t==null?void 0:t[Symbol.for("LG_SKIP_WRITE")])!==void 0}const yi={[Symbol.for("LG_PASSTHROUGH")]:!0};function qc(t){return typeof t=="object"&&(t==null?void 0:t[Symbol.for("LG_PASSTHROUGH")])!==void 0}const mf=Symbol("IS_WRITER");var ln=class Vp extends Mi{constructor(n,r){const s=`ChannelWrite<${n.map(i=>qn(i)?i.node:"channel"in i?i.channel:"...").join(",")}>`;super({writes:n,name:s,tags:r,func:async(i,a)=>this._write(i,a??{})});p(this,"writes");this.writes=n}async _write(n,r){const s=this.writes.map(i=>gf(i)&&qc(i.value)?{mapper:i.mapper,value:n}:Tu(i)&&qc(i.value)?{channel:i.channel,value:n,skipNone:i.skipNone,mapper:i.mapper}:i);return await Vp.doWrite(r,s),n}static async doWrite(n,r){var a;for(const o of r){if(Tu(o)){if(o.channel===Yn)throw new at("Cannot write to the reserved channel TASKS");if(qc(o.value))throw new at("PASSTHROUGH value must be replaced")}if(gf(o)&&qc(o.value))throw new at("PASSTHROUGH value must be replaced")}const s=[];for(const o of r)if(qn(o))s.push([Yn,o]);else if(gf(o)){const c=await o.mapper.invoke(o.value,n);c!=null&&c.length>0&&s.push(...c)}else if(Tu(o)){const c=o.mapper!==void 0?await o.mapper.invoke(o.value,n):o.value;if(R4(c)||o.skipNone&&c===void 0)continue;s.push([o.channel,c])}else throw new Error(`Invalid write entry: ${JSON.stringify(o)}`);((a=n.configurable)==null?void 0:a[Us])(s)}static isWriter(n){return n instanceof Vp||mf in n&&!!n[mf]}static registerWriter(n){return Object.defineProperty(n,mf,{value:!0})}};function Tu(t){return t!==void 0&&typeof t.channel=="string"}function gf(t){return t!==void 0&&!Tu(t)&&je.isRunnable(t.mapper)}var O4=class jT extends Mi{constructor(n,r,s=!1){super({func:(i,a)=>jT.doRead(a,this.channel,this.fresh,this.mapper)});p(this,"lc_graph_name","ChannelRead");p(this,"channel");p(this,"fresh",!1);p(this,"mapper");this.fresh=s,this.mapper=r,this.channel=n,this.name=Array.isArray(n)?`ChannelRead<${n.join(",")}>`:`ChannelRead<${n}>`}static doRead(n,r,s,i){var o;const a=(o=n.configurable)==null?void 0:o[gi];if(!a)throw new Error("Runnable is not configured with a read function. Make sure to call in the context of a Pregel process");return i?i(a(r,s)):a(r,s)}};const Fi=new ms;var Vo=class eo extends Hs{constructor(n){var _;const{channels:r,triggers:s,mapper:i,writers:a,bound:o,kwargs:c,metadata:u,retryPolicy:l,cachePolicy:d,tags:h,subgraphs:f,ends:m}=n,g=[...(_=n.config)!=null&&_.tags?n.config.tags:[],...h??[]];super({...n,bound:n.bound??Fi,config:{...n.config?n.config:{},tags:g}});p(this,"lc_graph_name","PregelNode");p(this,"channels");p(this,"triggers",[]);p(this,"mapper");p(this,"writers",[]);p(this,"bound",Fi);p(this,"kwargs",{});p(this,"metadata",{});p(this,"tags",[]);p(this,"retryPolicy");p(this,"cachePolicy");p(this,"subgraphs");p(this,"ends");this.channels=r,this.triggers=s,this.mapper=i,this.writers=a??this.writers,this.bound=o??this.bound,this.kwargs=c??this.kwargs,this.metadata=u??this.metadata,this.tags=g,this.retryPolicy=l,this.cachePolicy=d,this.subgraphs=f,this.ends=m}getWriters(){var r;const n=[...this.writers];for(;n.length>1&&n[n.length-1]instanceof ln&&n[n.length-2]instanceof ln;){const s=n.slice(-2),i=s[0].writes.concat(s[1].writes);n[n.length-2]=new ln(i,(r=s[0].config)==null?void 0:r.tags),n.pop()}return n}getNode(){const n=this.getWriters();if(!(this.bound===Fi&&n.length===0))return this.bound===Fi&&n.length===1?n[0]:this.bound===Fi?new Jr({first:n[0],middle:n.slice(1,n.length-1),last:n[n.length-1],omitSequenceTags:!0}):n.length>0?new Jr({first:this.bound,middle:n.slice(0,n.length-1),last:n[n.length-1],omitSequenceTags:!0}):this.bound}join(n){if(!Array.isArray(n))throw new Error("channels must be a list");if(typeof this.channels!="object")throw new Error("all channels must be named when using .join()");return new eo({channels:{...this.channels,...Object.fromEntries(n.map(r=>[r,r]))},triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound,kwargs:this.kwargs,config:this.config,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy})}pipe(n){return ln.isWriter(n)?new eo({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:[...this.writers,n],bound:this.bound,config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy}):this.bound===Fi?new eo({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:Jt(n),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy}):new eo({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound.pipe(n),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy})}};function $4(t){return"steps"in t&&Array.isArray(t.steps)}function jg(t){return"lg_is_pregel"in t&&t.lg_is_pregel===!0}function FT(t){const e=[t];for(const n of e){if(jg(n))return n;$4(n)&&e.push(...n.steps)}}const G=t=>BigInt(t),et=(t,e=0)=>new DataView(t.buffer,t.byteOffset+e,t.byteLength-e),zT=G("0x9E3779B1"),VT=G("0x85EBCA77"),N4=G("0xC2B2AE3D"),Gs=G("0x9E3779B185EBCA87"),Ai=G("0xC2B2AE3D27D4EB4F"),qT=G("0x165667B19E3779F9"),Fg=G("0x85EBCA77C2B2AE63"),P4=G("0x27D4EB2F165667C5"),L4=G("0x165667919E3779F9"),M4=G("0x9FB21C651E98DF25"),D4=t=>{const e=t.length;if(e%2!==0)throw new Error("String should have an even number of characters");const n=e/2,r=new Uint8Array(n);let s=0,i=0;for(;i<n;){const a=t.slice(s,s+=2);r[i]=Number.parseInt(a,16),i+=1}return et(r)},Nr=D4("b8fe6c3923a44bbe7c01812cf721ad1cded46de9839097db7240a4a4b7b3671fcb79e64eccc0e578825ad07dccff7221b8084674f743248ee03590e6813a264c3c2852bb91c300cb88d0658b1b532ea371644897a20df94e3819ef46a9deacd8a8fa763fe39c343ff9dcbbc7c70b4f1d8a51e04bcdb45931c89f7ec9d9787364eac5ac8334d3ebc3c581a0fffa1363eb170ddd51b7f0da49d316552629d4689e2b16be587d47a1fc8ff8b8d17ad031ce45cb3a8f95160428afd7fbcabb4b407e"),ha=(G(1)<<G(128))-G(1),Pe=(G(1)<<G(64))-G(1),gl=(G(1)<<G(32))-G(1),is=64,HT=is/8,U4=8,Hc=4;function Ta(t){if(!t)throw new Error("Assert failed")}function B4(t){const e=new DataView(new ArrayBuffer(8));return e.setBigUint64(0,t,!0),e.getBigUint64(0,!1)}function j4(t){let e=t;return e=(e&G(65535))<<G(16)|(e&G(4294901760))>>G(16),e=(e&G(16711935))<<G(8)|(e&G(4278255360))>>G(8),e}function F4(t,e){return(t&gl)*(e&gl)&Pe}function z4(t,e){return(t<<e|t>>G(32)-e)&gl}function GT(t,e,n){for(let r=0;r<HT;r+=1){const s=e.getBigUint64(r*8,!0),i=s^n.getBigUint64(r*8,!0);t[r^1]+=s,t[r]+=F4(i,i>>G(32))}return t}function wb(t,e,n,r){for(let s=0;s<r;s+=1)GT(t,et(e,s*is),et(n,s*8));return t}function V4(t,e){for(let n=0;n<HT;n+=1){const r=e.getBigUint64(n*8,!0);let s=t[n];s=qp(s,G(47)),s^=r,s*=zT,t[n]=s&Pe}return t}function Gc(t,e){return WT(t[0]^e.getBigUint64(0,!0),t[1]^e.getBigUint64(U4,!0))}function bb(t,e,n){let r=n;return r+=Gc(t.slice(0),et(e,0*Hc)),r+=Gc(t.slice(2),et(e,4*Hc)),r+=Gc(t.slice(4),et(e,8*Hc)),r+=Gc(t.slice(6),et(e,12*Hc)),Br(r&Pe)}function q4(t,e,n,r,s){let i=t;const a=Math.floor((n.byteLength-is)/8),o=is*a,c=Math.floor((e.byteLength-1)/o);for(let u=0;u<c;u+=1)i=wb(i,et(e,u*o),n,a),i=s(i,et(n,n.byteLength-is));{const u=Math.floor((e.byteLength-1-o*c)/is);i=wb(i,et(e,c*o),n,u),i=r(i,et(e,e.byteLength-is),et(n,n.byteLength-is-7))}return i}function H4(t,e){let n=new BigUint64Array([N4,Gs,Ai,qT,Fg,VT,P4,zT]);Ta(t.byteLength>128),n=q4(n,t,e,GT,V4),Ta(n.length*8===64);{const r=bb(n,et(e,11),G(t.byteLength)*Gs&Pe);return bb(n,et(e,e.byteLength-is-11),~(G(t.byteLength)*Ai)&Pe)<<G(64)|r}}function WT(t,e){const n=t*e&ha;return n&Pe^n>>G(64)}function vb(t,e,n){return WT((t.getBigUint64(0,!0)^e.getBigUint64(0,!0)+n)&Pe,(t.getBigUint64(8,!0)^e.getBigUint64(8,!0)-n)&Pe)}function Au(t,e,n,r,s){let i=t&Pe,a=t>>G(64)&Pe;return i+=vb(e,r,s),i^=n.getBigUint64(0,!0)+n.getBigUint64(8,!0),i&=Pe,a+=vb(n,et(r,16),s),a^=e.getBigUint64(0,!0)+e.getBigUint64(8,!0),a&=Pe,a<<G(64)|i}function Br(t){let e=t;return e^=e>>G(37),e*=L4,e&=Pe,e^=e>>G(32),e}function yl(t){let e=t;return e^=e>>G(33),e*=Ai,e&=Pe,e^=e>>G(29),e*=qT,e&=Pe,e^=e>>G(32),e}function G4(t,e,n){const r=t.byteLength;Ta(r>0&&r<=3);const s=G(t.getUint8(r-1))|G(r<<8)|G(t.getUint8(0)<<16)|G(t.getUint8(r>>1)<<24),i=(G(e.getUint32(0,!0))^G(e.getUint32(4,!0)))+n,a=(s^i)&Pe,o=(G(e.getUint32(8,!0))^G(e.getUint32(12,!0)))-n,c=(z4(j4(s),G(13))^o)&Pe;return(yl(c)&Pe)<<G(64)|yl(a)}function qp(t,e){return t^t>>e}function W4(t,e,n){const r=t.byteLength;Ta(r>=4&&r<=8);{const s=t.getUint32(0,!0),i=t.getUint32(r-4,!0),a=G(s)|G(i)<<G(32),o=(e.getBigUint64(16,!0)^e.getBigUint64(24,!0))+n&Pe;let u=(a^o)*(Gs+(G(r)<<G(2)))&ha;return u+=(u&Pe)<<G(65),u&=ha,u^=u>>G(67),qp(qp(u&Pe,G(35))*M4&Pe,G(28))|Br(u>>G(64))<<G(64)}}function J4(t,e,n){const r=t.byteLength;Ta(r>=9&&r<=16);{const s=(e.getBigUint64(32,!0)^e.getBigUint64(40,!0))+n&Pe,i=(e.getBigUint64(48,!0)^e.getBigUint64(56,!0))-n&Pe,a=t.getBigUint64(0,!0);let o=t.getBigUint64(r-8,!0),c=(a^o^s)*Gs;const u=(c&Pe)+(G(r-1)<<G(54));c=c&(ha^Pe)|u,o^=i,c+=o+(o&gl)*(VT-G(1))<<G(64),c&=ha,c^=B4(c>>G(64));let l=(c&Pe)*Ai;return l+=(c>>G(64))*Ai<<G(64),l&=ha,Br(l&Pe)|Br(l>>G(64))<<G(64)}}function Z4(t,e){const n=t.byteLength;return Ta(n<=16),n>8?J4(t,Nr,e):n>=4?W4(t,Nr,e):n>0?G4(t,Nr,e):yl(e^Nr.getBigUint64(64,!0)^Nr.getBigUint64(72,!0))|yl(e^Nr.getBigUint64(80,!0)^Nr.getBigUint64(88,!0))<<G(64)}function Hp(t){return~t+G(1)&Pe}function K4(t,e,n){let r=G(t.byteLength)*Gs&Pe,s=G(t.byteLength-1)/G(32);for(;s>=0;){const o=Number(s);r=Au(r,et(t,16*o),et(t,t.byteLength-16*(o+1)),et(e,32*o),n),s-=G(1)}let i=r+(r>>G(64))&Pe;i=Br(i);let a=(r&Pe)*Gs+(r>>G(64))*Fg+(G(t.byteLength)-n&Pe)*Ai;return a&=Pe,a=Hp(Br(a)),i|a<<G(64)}function X4(t,e,n){let r=G(t.byteLength)*Gs&Pe;for(let a=32;a<160;a+=32)r=Au(r,et(t,a-32),et(t,a-16),et(e,a-32),n);r=Br(r&Pe)|Br(r>>G(64))<<G(64);for(let a=160;a<=t.byteLength;a+=32)r=Au(r,et(t,a-32),et(t,a-16),et(e,3+a-160),n);r=Au(r,et(t,t.byteLength-16),et(t,t.byteLength-32),et(e,103),Hp(n));let s=r+(r>>G(64))&Pe;s=Br(s);let i=(r&Pe)*Gs+(r>>G(64))*Fg+(G(t.byteLength)-n&Pe)*Ai;return i&=Pe,i=Hp(Br(i)),s|i<<G(64)}function ti(t,e=G(0)){const n=new TextEncoder,r=et(typeof t=="string"?n.encode(t):t),s=r.byteLength,i=a=>a.toString(16).padStart(32,"0");return s<=16?i(Z4(r,e)):s<=128?i(K4(r,Nr,e)):s<=240?i(X4(r,Nr,e)):i(H4(r,Nr))}function JT(t){return/^[0-9a-f]{32}$/.test(t)}function fa(t,e,n=!0,r=!1){try{return t[e].get()}catch(s){if(s.name===Zt.unminifiable_name){if(r)return s;if(n)return null}throw s}}function Ci(t,e,n=!0){if(Array.isArray(e)){const r={};for(const s of e)try{r[s]=fa(t,s,!n)}catch(i){if(i.name===Zt.unminifiable_name)continue}return r}else return fa(t,e)}function*Y4(t,e){if(t.graph===dn.PARENT)throw new at("There is no parent graph.");if(t.goto){let n;Array.isArray(t.goto)?n=t.goto:n=[t.goto];for(const r of n)if(qn(r))yield[Qn,Yn,r];else if(typeof r=="string")yield[Qn,`branch:to:${r}`,"__start__"];else throw new Error(`In Command.send, expected Send or string, got ${typeof r}`)}if(t.resume)if(typeof t.resume=="object"&&Object.keys(t.resume).length&&Object.keys(t.resume).every(JT))for(const[n,r]of Object.entries(t.resume)){const s=e.filter(i=>i[0]===n&&i[1]===Cn).map(i=>i[2]).slice(0,1)??[];s.push(r),yield[n,Cn,s]}else yield[Qn,Cn,t.resume];if(t.update){if(typeof t.update!="object"||!t.update)throw new Error("Expected cmd.update to be a dict mapping channel names to update values");if(Array.isArray(t.update))for(const[n,r]of t.update)yield[Qn,n,r];else for(const[n,r]of Object.entries(t.update))yield[Qn,n,r]}}function*ZT(t,e){if(e!=null)if(Array.isArray(t)&&typeof e=="object"&&!Array.isArray(e))for(const n in e)t.includes(n)&&(yield[n,e[n]]);else{if(Array.isArray(t))throw new Error('Input chunk must be an object when "inputChannels" is an array');yield[t,e]}}function*yf(t,e,n){Array.isArray(t)?(e===!0||e.find(([r,s])=>t.includes(r)))&&(yield Ci(n,t)):(e===!0||e.some(([r,s])=>r===t))&&(yield fa(n,t))}function*Q4(t,e,n){const r=e.filter(([o,c])=>{var u;return(o.config===void 0||!((u=o.config.tags)!=null&&u.includes(bt)))&&c[0][0]!==xn&&c[0][0]!==qe});if(!r.length)return;let s;r.some(([o])=>o.writes.some(([c,u])=>c===xa))?s=r.flatMap(([o])=>o.writes.filter(([c,u])=>c===xa).map(([c,u])=>[o.name,u])):Array.isArray(t)?s=r.flatMap(([o])=>{const{writes:c}=o,u={};for(const[l]of c)t.includes(l)&&(u[l]=(u[l]||0)+1);return Object.values(u).some(l=>l>1)?c.filter(([l])=>t.includes(l)).map(([l,d])=>[o.name,{[l]:d}]):[[o.name,Object.fromEntries(c.filter(([l])=>t.includes(l)))]]}):s=r.flatMap(([o])=>o.writes.filter(([c,u])=>c===t).map(([c,u])=>[o.name,u]));const i={};for(const[o,c]of s)o in i||(i[o]=[]),i[o].push(c);const a={};for(const o in i)if(i[o].length===1){const[c]=i[o];a[o]=c}else a[o]=i[o];n&&(a.__metadata__={cached:n}),yield a}function zg(t){const e=typeof t[Qe];if(e==="number")return 0;if(e==="string")return"";for(const n in t){if(!Object.prototype.hasOwnProperty.call(t,n))continue;const r=typeof t[n];if(r==="number")return 0;if(r==="string")return"";break}}function Cu(t,e){if(Object.keys(t).length>0){const n=zg(e);return Object.fromEntries(Object.entries(e).filter(([r,s])=>s>(t[r]??n)))}else return e}function eU(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}function gr(t,e){return t===null?{configurable:e}:(t==null?void 0:t.configurable)===void 0?{...t,configurable:e}:{...t,configurable:{...t.configurable,...e}}}function Ks(t,e){var r,s;const n=(e==null?void 0:e.parents)??{};return Object.keys(n).length>0?gr(t,{[Xn]:{...n,[((r=t.configurable)==null?void 0:r.checkpoint_ns)??""]:(s=t.configurable)==null?void 0:s.checkpoint_id}}):t}function _l(...t){const e=[...new Set(t.filter(Boolean))];if(e.length===0)return{signal:void 0,dispose:void 0};if(e.length===1)return{signal:e[0],dispose:void 0};const n=new AbortController,r=()=>{var a;const i=(a=e.find(o=>o.aborted))==null?void 0:a.reason;n.abort(i),e.forEach(o=>o.removeEventListener("abort",r))};e.forEach(i=>i.addEventListener("abort",r,{once:!0}));const s=e.find(i=>i.aborted);return s&&n.abort(s.reason),{signal:n.signal,dispose:()=>{e.forEach(i=>i.removeEventListener("abort",r))}}}const tU=(t,e)=>{if(!(!t&&!e))return t?e?Array.isArray(t)&&Array.isArray(e)?[...t,...e]:Array.isArray(t)?[...t,e]:Array.isArray(e)?[t,...e]:[t,e]:t:e};var nU=class{constructor({func:t,name:e,input:n,retry:r,cache:s,callbacks:i}){p(this,"func");p(this,"name");p(this,"input");p(this,"retry");p(this,"cache");p(this,"callbacks");p(this,"__lg_type","call");this.func=t,this.name=e,this.input=n,this.retry=r,this.cache=s,this.callbacks=i}};function rU(t){return typeof t=="object"&&t!==null&&"__lg_type"in t&&t.__lg_type==="call"}function sU(t,e){const n=new Mi({func:r=>e(...r),name:t,trace:!1,recurse:!1});return new Jr({name:t,first:n,last:new ln([{channel:xa,value:yi}],[bt])})}const iU=t=>t!==void 0?t+1:1;function aU(t,e){if(e==null)return!1;for(const n of t)if(e[n])return!0;return!1}function oU(t){let e;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e==null?e=t[n]:e=l4(e,t[n]));return e}function Wc(t,e,n){const r=zg(t.channel_versions),s=t.versions_seen[qe]??{};let i=!1;if((t.channel_versions[Qe]??r)>(s[Qe]??r))i=!0;else for(const o in t.channel_versions)if(Object.prototype.hasOwnProperty.call(t.channel_versions,o)&&t.channel_versions[o]>(s[o]??r)){i=!0;break}const a=n.some(o=>{var c,u;return e==="*"?!((u=(c=o.config)==null?void 0:c.tags)!=null&&u.includes(bt)):e.includes(o.name)});return i&&a}function ku(t,e,n,r,s=!1){let i=new Set;if(Array.isArray(r))i=new Set(r.filter(o=>n.writes.some(([c,u])=>c===o)));else{for(const[o]of n.writes)if(o===r){i=new Set([o]);break}i=i||new Set}let a;if(s&&i.size>0){const o=Object.fromEntries(Object.entries(e).filter(([l,d])=>i.has(l))),c=ii(t,o,-1),u=fl(o,c);Un(hl(c),u,[n],void 0,void 0),a=Ci({...e,...u},r)}else a=Ci(e,r);return a}function _f(t,e,n){for(const[r,s]of n)if([Bn,Yn].includes(r)&&s!=null){if(!qn(s))throw new at(`Invalid packet type, expected SendProtocol, got ${JSON.stringify(s)}`);if(!(s.node in e))throw new at(`Invalid node name "${s.node}" in Send packet`)}t(n)}const cU=new Set([Bg,Bn,Cn,qe,xa,xn]);function Un(t,e,n,r,s){var h,f;n.sort((m,g)=>{var y,E;const _=((y=m.path)==null?void 0:y.slice(0,3))||[],b=((E=g.path)==null?void 0:E.slice(0,3))||[];for(let C=0;C<Math.min(_.length,b.length);C+=1){if(_[C]<b[C])return-1;if(_[C]>b[C])return 1}return _.length-b.length});const i=n.some(m=>m.triggers.length>0),a=Mg(e);for(const m of n){(h=t.versions_seen)[f=m.name]??(h[f]={});for(const g of m.triggers)g in t.channel_versions&&(t.versions_seen[m.name][g]=t.channel_versions[g])}let o=oU(t.channel_versions);const c=new Set(n.flatMap(m=>m.triggers).filter(m=>!S4.includes(m)));let u=!1;for(const m of c)m in a&&a[m].consume()&&r!==void 0&&(t.channel_versions[m]=r(o),u=!0);const l={};for(const m of n)for(const[g,_]of m.writes)cU.has(g)||g in a&&(l[g]??(l[g]=[]),l[g].push(_));o!=null&&r!=null&&(o=u?r(o):o);const d=new Set;for(const[m,g]of Object.entries(l))if(m in a){const _=a[m];let b;try{b=_.update(g)}catch(y){if(y.name===at.unminifiable_name){const E=new at(`Invalid update for channel "${m}" with values ${JSON.stringify(g)}: ${y.message}`);throw E.lc_error_code=y.lc_error_code,E}else throw y}b&&r!==void 0&&(t.channel_versions[m]=r(o),_.isAvailable()&&d.add(m))}if(i)for(const m in a){if(!Object.prototype.hasOwnProperty.call(a,m))continue;const g=a[m];g.isAvailable()&&!d.has(m)&&g.update([])&&r!==void 0&&(t.channel_versions[m]=r(o),g.isAvailable()&&d.add(m))}if(i&&!aU(d,s))for(const m in a){if(!Object.prototype.hasOwnProperty.call(a,m))continue;const g=a[m];g.finish()&&r!==void 0&&(t.channel_versions[m]=r(o),g.isAvailable()&&d.add(m))}return d}function*uU(t,e,n){if(n.updatedChannels!=null&&n.triggerToNodes!=null){const s=new Set;for(const i of n.updatedChannels){const a=n.triggerToNodes[i];for(const o of a??[])s.add(o)}yield*[...s].sort();return}if(!(()=>{for(const s in t.channel_versions)if(t.channel_versions[s]!==null)return!1;return!0})())for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&(yield s)}function oa(t,e,n,r,s,i,a){const o={},c=r[Yn];if(c!=null&&c.isAvailable()){const u=c.get().length;for(let l=0;l<u;l+=1){const d=Gp([Bn,l],t,e,n,r,s,i,a);d!==void 0&&(o[d.id]=d)}}for(const u of uU(t,n,a)){const l=Gp([xu,u],t,e,n,r,s,i,a);l!==void 0&&(o[l.id]=l)}return o}function Gp(t,e,n,r,s,i,a,o){var f,m,g,_;const{step:c,checkpointer:u,manager:l}=o,d=i.configurable??{},h=d.checkpoint_ns??"";if(t[0]===Bn&&rU(t[t.length-1])){const b=t[t.length-1],y=sU(b.name,b.func),E=[Bn],C=h===""?b.name:`${h}${Ot}${b.name}`,k=ta(JSON.stringify([C,c.toString(),b.name,Bn,t[1],t[2]]),e.id),R=`${C}${ds}${k}`,$=[...t.slice(0,3),!0],T={langgraph_step:c,langgraph_node:b.name,langgraph_triggers:E,langgraph_path:$,langgraph_checkpoint_ns:R};if(a){const B=[];return{name:b.name,input:b.input,proc:y,writes:B,config:Je(er(i,{metadata:T,store:o.store??i.store}),{runName:b.name,callbacks:l==null?void 0:l.getChild(`graph:step:${c}`),configurable:{[yo]:k,[Us]:q=>_f(ie=>B.push(...ie),r,q),[gi]:(q,ie=!1)=>ku(e,s,{name:b.name,writes:B,triggers:E,path:$},q,ie),[yt]:u??d[yt],[Xn]:{...d[Xn],[h]:e.id},[Bs]:wf({pendingWrites:n??[],taskId:k,currentTaskInput:b.input,resumeMap:(f=i.configurable)==null?void 0:f[Eu],namespaceHash:ti(R)}),[Su]:e.channel_values[ff],checkpoint_id:void 0,checkpoint_ns:R}}),triggers:E,retry_policy:b.retry,cache_key:b.cache?{key:ti((b.cache.keyFunc??JSON.stringify)([b.input])),ns:[hf,b.name??"__dynamic__"],ttl:b.cache.ttl}:void 0,id:k,path:$,writers:[]}}else return{id:k,name:b.name,interrupts:[],path:$}}else if(t[0]===Bn){const b=typeof t[1]=="number"?t[1]:parseInt(t[1],10);if(!((m=s[Yn])!=null&&m.isAvailable()))return;const y=s[Yn].get();if(b<0||b>=y.length)return;const E=zp(y[b])&&!qn(y[b])?new ml(y[b].node,y[b].args):y[b];if(!zp(E)){console.warn(`Ignoring invalid packet ${JSON.stringify(E)} in pending sends.`);return}if(!(E.node in r)){console.warn(`Ignoring unknown node name ${E.node} in pending sends.`);return}const C=[Bn],k=h===""?E.node:`${h}${Ot}${E.node}`,R=ta(JSON.stringify([k,c.toString(),E.node,Bn,b.toString()]),e.id),$=`${k}${ds}${R}`;let T={langgraph_step:c,langgraph_node:E.node,langgraph_triggers:C,langgraph_path:t.slice(0,3),langgraph_checkpoint_ns:$};if(a){const B=r[E.node],z=B.getNode();if(z!==void 0){B.metadata!==void 0&&(T={...T,...B.metadata});const q=[];return{name:E.node,input:E.args,proc:z,subgraphs:B.subgraphs,writes:q,config:Je(er(i,{metadata:T,tags:B.tags,store:o.store??i.store}),{runName:E.node,callbacks:l==null?void 0:l.getChild(`graph:step:${c}`),configurable:{[yo]:R,[Us]:ie=>_f(me=>q.push(...me),r,ie),[gi]:(ie,me=!1)=>ku(e,s,{name:E.node,writes:q,triggers:C,path:t},ie,me),[yt]:u??d[yt],[Xn]:{...d[Xn],[h]:e.id},[Bs]:wf({pendingWrites:n??[],taskId:R,currentTaskInput:E.args,resumeMap:(g=i.configurable)==null?void 0:g[Eu],namespaceHash:ti($)}),[Su]:e.channel_values[ff],checkpoint_id:void 0,checkpoint_ns:$}}),triggers:C,retry_policy:B.retryPolicy,cache_key:B.cachePolicy?{key:ti((B.cachePolicy.keyFunc??JSON.stringify)([E.args])),ns:[hf,B.name??"__dynamic__",E.node],ttl:B.cachePolicy.ttl}:void 0,id:R,path:t,writers:B.getWriters()}}}else return{id:R,name:E.node,interrupts:[],path:t}}else if(t[0]===xu){const b=t[1].toString(),y=r[b];if(y===void 0)return;if(n!=null&&n.length){const R=h===""?b:`${h}${Ot}${b}`,$=ta(JSON.stringify([R,c.toString(),b,xu,b]),e.id);if(n.some(B=>B[0]===$&&B[1]!==xn))return}const E=zg(e.channel_versions);if(E===void 0)return;const C=e.versions_seen[b]??{},k=y.triggers.find(R=>s[R].isAvailable()?(e.channel_versions[R]??E)>(C[R]??E):!1);if(k!==void 0){const R=lU(y,s,a);if(R===void 0)return;const $=h===""?b:`${h}${Ot}${b}`,T=ta(JSON.stringify([$,c.toString(),b,xu,[k]]),e.id),B=`${$}${ds}${T}`;let z={langgraph_step:c,langgraph_node:b,langgraph_triggers:[k],langgraph_path:t,langgraph_checkpoint_ns:B};if(a){const q=y.getNode();if(q!==void 0){y.metadata!==void 0&&(z={...z,...y.metadata});const ie=[];return{name:b,input:R,proc:q,subgraphs:y.subgraphs,writes:ie,config:Je(er(i,{metadata:z,tags:y.tags,store:o.store??i.store}),{runName:b,callbacks:l==null?void 0:l.getChild(`graph:step:${c}`),configurable:{[yo]:T,[Us]:me=>_f(j=>{ie.push(...j)},r,me),[gi]:(me,j=!1)=>ku(e,s,{name:b,writes:ie,triggers:[k],path:t},me,j),[yt]:u??d[yt],[Xn]:{...d[Xn],[h]:e.id},[Bs]:wf({pendingWrites:n??[],taskId:T,currentTaskInput:R,resumeMap:(_=i.configurable)==null?void 0:_[Eu],namespaceHash:ti(B)}),[Su]:e.channel_values[ff],checkpoint_id:void 0,checkpoint_ns:B}}),triggers:[k],retry_policy:y.retryPolicy,cache_key:y.cachePolicy?{key:ti((y.cachePolicy.keyFunc??JSON.stringify)([R])),ns:[hf,y.name??"__dynamic__",b],ttl:y.cachePolicy.ttl}:void 0,id:T,path:t,writers:y.getWriters()}}}else return{id:T,name:b,interrupts:[],path:t}}}}function lU(t,e,n){let r;if(typeof t.channels=="object"&&!Array.isArray(t.channels)){r={};for(const[s,i]of Object.entries(t.channels))if(t.triggers.includes(i))try{r[s]=fa(e,i,!1)}catch(a){if(a.name===Zt.unminifiable_name)return;throw a}else if(i in e)try{r[s]=fa(e,i,!1)}catch(a){if(a.name===Zt.unminifiable_name)continue;throw a}}else if(Array.isArray(t.channels)){let s=!1;for(const i of t.channels)try{r=fa(e,i,!1),s=!0;break}catch(a){if(a.name===Zt.unminifiable_name)continue;throw a}if(!s)return}else throw new Error(`Invalid channels type, expected list or dict, got ${t.channels}`);return n&&t.mapper!==void 0&&(r=t.mapper(r)),r}function wf({pendingWrites:t,taskId:e,currentTaskInput:n,resumeMap:r,namespaceHash:s}){var c;const i=(c=t.find(([u,l])=>u===Qn&&l===Cn))==null?void 0:c[2],o={callCounter:0,interruptCounter:-1,resume:(()=>{const u=t.filter(([l,d])=>l===e&&d===Cn).flatMap(([l,d,h])=>h);if(r!=null&&s in r){const l=r[s];u.push(l)}return u})(),nullResume:i,subgraphCounter:0,currentTaskInput:n,consumeNullResume:()=>{if(o.nullResume)return delete o.nullResume,t.splice(t.findIndex(([u,l])=>u===Qn&&l===Cn),1),i}};return o}const qo={blue:{start:"\x1B[34m",end:"\x1B[0m"},green:{start:"\x1B[32m",end:"\x1B[0m"},yellow:{start:"\x1B[33;1m",end:"\x1B[0m"}},Ho=(t,e)=>`${t.start}${e}${t.end}`;function*Eb(t){var e;for(const{id:n,name:r,input:s,config:i,triggers:a,writes:o}of t){if((e=i==null?void 0:i.tags)!=null&&e.includes(bt))continue;const c=o.filter(([u,l])=>u===n&&l===qe).map(([,u])=>u);yield{id:n,name:r,input:s,triggers:a,interrupts:c}}}function dU(t){return typeof t!="object"||t===null?!1:"$writes"in t&&Array.isArray(t.$writes)}function KT(t){const e={};for(const[n,r]of t){const s=String(n);if(s in e){const i=dU(e[s])?e[s].$writes:[e[s]];i.push(r),e[s]={$writes:i}}else e[s]=r}return e}function*hU(t,e){var n;for(const[{id:r,name:s,config:i},a]of t)(n=i==null?void 0:i.tags)!=null&&n.includes(bt)||(yield{id:r,name:s,result:KT(a.filter(([o])=>Array.isArray(e)?e.includes(o):o===e)),interrupts:a.filter(o=>o[0]===qe).map(o=>o[1])})}function*fU(t,e,n,r,s,i,a,o){var d,h,f;function c(m){const g={};return m.callbacks!=null&&(g.callbacks=m.callbacks),m.configurable!=null&&(g.configurable=m.configurable),m.maxConcurrency!=null&&(g.max_concurrency=m.maxConcurrency),m.metadata!=null&&(g.metadata=m.metadata),m.recursionLimit!=null&&(g.recursion_limit=m.recursionLimit),m.runId!=null&&(g.run_id=m.runId),m.runName!=null&&(g.run_name=m.runName),m.tags!=null&&(g.tags=m.tags),g}const u=(d=t.configurable)==null?void 0:d.checkpoint_ns,l={};for(const m of s){if(!((h=m.subgraphs)!=null&&h.length?m.subgraphs:[m.proc]).find(FT))continue;let _=`${m.name}:${m.id}`;u&&(_=`${u}|${_}`),l[m.id]={configurable:{thread_id:(f=t.configurable)==null?void 0:f.thread_id,checkpoint_ns:_}}}yield{config:c(t),values:Ci(e,n),metadata:r,next:s.map(m=>m.name),tasks:XT(s,i,l,o),parentConfig:a?c(a):void 0}}function XT(t,e,n,r){return t.map(s=>{var u;const i=(u=e.find(([l,d])=>l===s.id&&d===xn))==null?void 0:u[2],a=e.filter(([l,d])=>l===s.id&&d===qe).map(([,,l])=>l),o=(()=>{var d;if(i||a.length||!e.length)return;const l=e.findIndex(([h,f])=>h===s.id&&f===xa);if(l>=0)return e[l][2];if(typeof r=="string")return(d=e.find(([h,f])=>h===s.id&&f===r))==null?void 0:d[2];if(Array.isArray(r)){const h=e.filter(([f,m])=>f===s.id&&r.includes(m)).map(([,f,m])=>[f,m]);return h.length?KT(h):void 0}})();if(i)return{id:s.id,name:s.name,path:s.path,error:i,interrupts:a,result:o};const c=n==null?void 0:n[s.id];return{id:s.id,name:s.name,path:s.path,interrupts:a,...c!==void 0?{state:c}:{},result:o}})}function pU(t,e,n){console.log([`${Ho(qo.blue,`[${t}:checkpoint]`)}`,`\x1B[1m State at the end of step ${t}:\x1B[0m
`,JSON.stringify(Ci(e,n),null,2)].join(""))}function YT(t,e){const n=e.length;console.log([`${Ho(qo.blue,`[${t}:tasks]`)}`,`\x1B[1m Starting step ${t} with ${n} task${n===1?"":"s"}:\x1B[0m
`,e.map(r=>`- ${Ho(qo.green,String(r.name))} -> ${JSON.stringify(r.input,null,2)}`).join(`
`)].join(""))}function mU(t,e,n){const r={};for(const[s,i]of e)n.includes(s)&&(r[s]||(r[s]=[]),r[s].push(i));console.log([`${Ho(qo.blue,`[${t}:writes]`)}`,`\x1B[1m Finished step ${t} with writes to ${Object.keys(r).length} channel${Object.keys(r).length!==1?"s":""}:\x1B[0m
`,Object.entries(r).map(([s,i])=>`- ${Ho(qo.yellow,s)} -> ${i.map(a=>JSON.stringify(a)).join(", ")}`).join(`
`)].join(""))}var Sb=class extends kn{constructor(e,n){const r=e.getReader(),s=n??new AbortController;super({start(i){return a();function a(){return r.read().then(({done:o,value:c})=>{if(o){i.close();return}return i.enqueue(c),a()})}}});p(this,"_abortController");p(this,"_innerReader");this._abortController=s,this._innerReader=r}async cancel(e){this._abortController.abort(e),this._innerReader.releaseLock()}get signal(){return this._abortController.signal}},QT=class extends kn{constructor(e){let n;const r=new Promise(s=>{n=s});super({start:s=>{n(s)}});p(this,"modes");p(this,"controller");p(this,"passthroughFn");p(this,"_closed",!1);r.then(s=>{this.controller=s}),this.passthroughFn=e.passthroughFn,this.modes=e.modes}get closed(){return this._closed}push(e){var n;(n=this.passthroughFn)==null||n.call(this,e),this.controller.enqueue(e)}close(){try{this.controller.close()}catch{}finally{this._closed=!0}}error(e){this.controller.error(e)}};function gU(t){return JSON.stringify(t,function(e,n){const r=this[e];if(r!=null&&typeof r=="object"&&"toDict"in r&&typeof r.toDict=="function"){const{type:s,data:i}=r.toDict();return{...i,type:s}}return n})}function yU(t){return t instanceof Error?{error:t.name,message:t.message}:{error:"Error",message:JSON.stringify(t)}}function Vg(t){return typeof t!="object"||t==null?!1:"configurable"in t&&typeof t.configurable=="object"&&t.configurable!=null}function bf(t){return!Vg(t)||!t.configurable.thread_id?null:{thread_id:t.configurable.thread_id,checkpoint_ns:t.configurable.checkpoint_ns||"",checkpoint_id:t.configurable.checkpoint_id||null,checkpoint_map:t.configurable.checkpoint_map||null}}function xb(t){if(Vg(t)){const e=Object.fromEntries(Object.entries(t.configurable).filter(([r])=>!r.startsWith("__"))),n={...t,configurable:e};return delete n.callbacks,n}return t}function Tb(t){const e={...t,checkpoint:bf(t.config),parent_checkpoint:bf(t.parentConfig),config:xb(t.config),parent_config:xb(t.parentConfig),tasks:t.tasks.map(n=>{if(Vg(n.state)){const r=bf(n.state);if(r!=null){const s={...n,checkpoint:r};return delete s.state,s}}return n})};return delete e.parentConfig,e}function _U(t){const e=new TextEncoder;return new ReadableStream({async start(n){const r=s=>{n.enqueue(e.encode(`event: ${s.event}
data: ${gU(s.data)}

`))};try{for await(const s of t){const[i,a,o]=s;let c=o;if(a==="debug"){const l=o;l.type==="checkpoint"&&(c={...l,payload:Tb(l.payload)})}a==="checkpoints"&&(c=Tb(o));const u=i!=null&&i.length?`${a}|${i.join("|")}`:a;r({event:u,data:c})}}catch(s){r({event:"error",data:yU(s)})}n.close()}})}const Jc=Symbol.for("INPUT_DONE"),vf=Symbol.for("INPUT_RESUMING"),wU=25;function bU(...t){return new QT({passthroughFn:e=>{for(const n of t)n.modes.has(e[1])&&n.push(e)},modes:new Set(t.flatMap(e=>Array.from(e.modes)))})}var vU=class extends g4{constructor(e){super();p(this,"cache");p(this,"queue",Promise.resolve());this.cache=e}async get(e){return this.enqueueOperation("get",e)}async set(e){return this.enqueueOperation("set",e)}async clear(e){return this.enqueueOperation("clear",e)}async stop(){await this.queue}enqueueOperation(e,...n){const r=this.queue.then(()=>this.cache[e](...n));return this.queue=r.then(()=>{},()=>{}),r}},EU=class eA{constructor(e){p(this,"input");p(this,"output");p(this,"config");p(this,"checkpointer");p(this,"checkpointerGetNextVersion");p(this,"channels");p(this,"checkpoint");p(this,"checkpointIdSaved");p(this,"checkpointConfig");p(this,"checkpointMetadata");p(this,"checkpointNamespace");p(this,"checkpointPendingWrites",[]);p(this,"checkpointPreviousVersions");p(this,"step");p(this,"stop");p(this,"durability");p(this,"outputKeys");p(this,"streamKeys");p(this,"nodes");p(this,"skipDoneTasks");p(this,"prevCheckpointConfig");p(this,"updatedChannels");p(this,"status","pending");p(this,"tasks",{});p(this,"stream");p(this,"checkpointerPromises",[]);p(this,"isNested");p(this,"_checkpointerChainedPromise",Promise.resolve());p(this,"store");p(this,"cache");p(this,"manager");p(this,"interruptAfter");p(this,"interruptBefore");p(this,"toInterrupt",[]);p(this,"debug",!1);p(this,"triggerToNodes");this.input=e.input,this.checkpointer=e.checkpointer,this.checkpointer!==void 0?this.checkpointerGetNextVersion=this.checkpointer.getNextVersion.bind(this.checkpointer):this.checkpointerGetNextVersion=iU,this.checkpoint=e.checkpoint,this.checkpointMetadata=e.checkpointMetadata,this.checkpointPreviousVersions=e.checkpointPreviousVersions,this.channels=e.channels,this.checkpointPendingWrites=e.checkpointPendingWrites,this.step=e.step,this.stop=e.stop,this.config=e.config,this.checkpointConfig=e.checkpointConfig,this.isNested=e.isNested,this.manager=e.manager,this.outputKeys=e.outputKeys,this.streamKeys=e.streamKeys,this.nodes=e.nodes,this.skipDoneTasks=e.skipDoneTasks,this.store=e.store,this.cache=e.cache?new vU(e.cache):void 0,this.stream=e.stream,this.checkpointNamespace=e.checkpointNamespace,this.prevCheckpointConfig=e.prevCheckpointConfig,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.durability=e.durability,this.debug=e.debug,this.triggerToNodes=e.triggerToNodes}get isResuming(){var c,u,l,d,h;let e=!1;if(Qe in this.checkpoint.channel_versions)e=!0;else for(const f in this.checkpoint.channel_versions)if(Object.prototype.hasOwnProperty.call(this.checkpoint.channel_versions,f)){e=!0;break}const r=((c=this.config.configurable)==null?void 0:c[Is])!==void 0&&((u=this.config.configurable)==null?void 0:u[Is]),s=this.input===null||this.input===void 0,i=bn(this.input)&&this.input.resume!=null,a=this.input===vf,o=!this.isNested&&((l=this.config.metadata)==null?void 0:l.run_id)!==void 0&&((d=this.checkpointMetadata)==null?void 0:d.run_id)!==void 0&&this.config.metadata.run_id===((h=this.checkpointMetadata)==null?void 0:h.run_id);return e&&(r||s||i||a||o)}static async initialize(e){var E,C,k,R,$,T,B,z,q,ie,me,j;let{config:n,stream:r}=e;r!==void 0&&((E=n.configurable)==null?void 0:E[pl])!==void 0&&(r=bU(r,n.configurable[pl]));const s=n.configurable?!("checkpoint_id"in n.configurable):!0,i=(C=n.configurable)==null?void 0:C[Bs];n.configurable&&i&&(i.subgraphCounter>0&&(n=gr(n,{[Mr]:[n.configurable[Mr],i.subgraphCounter.toString()].join(Ot)})),i.subgraphCounter+=1);const a=gi in(n.configurable??{});!a&&((k=n.configurable)==null?void 0:k.checkpoint_ns)!==void 0&&((R=n.configurable)==null?void 0:R.checkpoint_ns)!==""&&(n=gr(n,{checkpoint_ns:"",checkpoint_id:void 0}));let o=n;(($=n.configurable)==null?void 0:$[Xn])!==void 0&&((z=(T=n.configurable)==null?void 0:T[Xn])!=null&&z[(B=n.configurable)==null?void 0:B.checkpoint_ns])&&(o=gr(n,{checkpoint_id:n.configurable[Xn][(q=n.configurable)==null?void 0:q.checkpoint_ns]}));const c=((me=(ie=n.configurable)==null?void 0:ie.checkpoint_ns)==null?void 0:me.split(Ot))??[],u=await((j=e.checkpointer)==null?void 0:j.getTuple(o))??{config:n,checkpoint:OT(),metadata:{source:"input",step:-2,parents:{}},pendingWrites:[]};o={...n,...u.config,configurable:{checkpoint_ns:"",...n.configurable,...u.config.configurable}};const l=u.parentConfig,d=hl(u.checkpoint),h={...u.metadata},f=u.pendingWrites??[],m=fl(e.channelSpecs,d),g=(h.step??0)+1,_=g+(n.recursionLimit??wU)+1,b={...d.channel_versions},y=e.store?new m4(e.store):void 0;return y&&await y.start(),new eA({input:e.input,config:n,checkpointer:e.checkpointer,checkpoint:d,checkpointMetadata:h,checkpointConfig:o,prevCheckpointConfig:l,checkpointNamespace:c,channels:m,isNested:a,manager:e.manager,skipDoneTasks:s,step:g,stop:_,checkpointPreviousVersions:b,checkpointPendingWrites:f,outputKeys:e.outputKeys??[],streamKeys:e.streamKeys??[],nodes:e.nodes,stream:r,store:y,cache:e.cache,interruptAfter:e.interruptAfter,interruptBefore:e.interruptBefore,durability:e.durability,debug:e.debug,triggerToNodes:e.triggerToNodes})}_checkpointerPutAfterPrevious(e){this._checkpointerChainedPromise=this._checkpointerChainedPromise.then(()=>{var n;return(n=this.checkpointer)==null?void 0:n.put(e.config,e.checkpoint,e.metadata,e.newVersions)}),this.checkpointerPromises.push(this._checkpointerChainedPromise)}putWrites(e,n){var a;let r=n;if(r.length===0)return;r.every(([o])=>o in d4)&&(r=Array.from(new Map(r.map(o=>[o[0],o])).values())),this.checkpointPendingWrites=this.checkpointPendingWrites.filter(o=>o[0]!==e);for(const[o,c]of r)this.checkpointPendingWrites.push([e,o,c]);const s=gr(this.checkpointConfig,{[Mr]:((a=this.config.configurable)==null?void 0:a.checkpoint_ns)??"",[Fp]:this.checkpoint.id});if(this.durability!=="exit"&&this.checkpointer!=null&&this.checkpointerPromises.push(this.checkpointer.putWrites(s,r,e)),this.tasks&&this._outputWrites(e,r),!n.length||!this.cache||!this.tasks)return;const i=this.tasks[e];i==null||i.cache_key==null||n[0][0]===xn||n[0][0]===qe||this.cache.set([{key:[i.cache_key.ns,i.cache_key.key],value:i.writes,ttl:i.cache_key.ttl}])}_outputWrites(e,n,r=!1){var i,a;const s=this.tasks[e];if(s!==void 0){if(s.config!==void 0&&(s.config.tags??[]).includes(bt))return;if(n.length>0)if(n[0][0]===qe){if(((i=s.path)==null?void 0:i[0])===Bn&&((a=s.path)==null?void 0:a.at(-1))===!0)return;const o=n.filter(c=>c[0]===qe).flatMap(c=>c[1]);this._emit([["updates",{[qe]:o}],["values",{[qe]:o}]])}else n[0][0]!==xn&&this._emit(Qa(Ss(Q4(this.outputKeys,[[s,n]],r),"updates")));r||this._emit(Qa(Ss(hU([[s,n]],this.streamKeys),"tasks")))}}async _matchCachedWrites(){if(!this.cache)return[];const e=[],n=([a,o])=>`ns:${a.join(",")}|key:${o}`,r=[],s={};for(const a of Object.values(this.tasks))a.cache_key!=null&&!a.writes.length&&(r.push([a.cache_key.ns,a.cache_key.key]),s[n([a.cache_key.ns,a.cache_key.key])]=a);if(r.length===0)return[];const i=await this.cache.get(r);for(const{key:a,value:o}of i){const c=s[n(a)];c!=null&&(c.writes.push(...o),e.push({task:c,result:o}))}return e}async tick(e){var i,a,o;this.store&&!this.store.isRunning&&await((i=this.store)==null?void 0:i.start());const{inputKeys:n=[]}=e;if(this.status!=="pending")throw new Error(`Cannot tick when status is no longer "pending". Current status: "${this.status}"`);if(![Jc,vf].includes(this.input))await this._first(n);else{if(this.toInterrupt.length>0)throw this.status="interrupt_before",new la;if(Object.values(this.tasks).every(c=>c.writes.length>0)){const c=Object.values(this.tasks).flatMap(l=>l.writes);this.updatedChannels=Un(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion,this.triggerToNodes);const u=await Os(Ss(yf(this.outputKeys,c,this.channels),"values"));if(this._emit(u),this.checkpointPendingWrites=[],await this._putCheckpoint({source:"loop"}),Wc(this.checkpoint,this.interruptAfter,Object.values(this.tasks)))throw this.status="interrupt_after",new la;((a=this.config.configurable)==null?void 0:a[Is])!==void 0&&((o=this.config.configurable)==null||delete o[Is])}else return!1}if(this.step>this.stop)return this.status="out_of_steps",!1;const r=oa(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.config,!0,{step:this.step,checkpointer:this.checkpointer,isResuming:this.isResuming,manager:this.manager,store:this.store,stream:this.stream,triggerToNodes:this.triggerToNodes,updatedChannels:this.updatedChannels});if(this.tasks=r,this.checkpointer&&this._emit(await Os(Ss(fU(this.checkpointConfig,this.channels,this.streamKeys,this.checkpointMetadata,Object.values(this.tasks),this.checkpointPendingWrites,this.prevCheckpointConfig,this.outputKeys),"checkpoints"))),Object.values(this.tasks).length===0)return this.status="done",!1;if(this.skipDoneTasks&&this.checkpointPendingWrites.length>0){for(const[c,u,l]of this.checkpointPendingWrites){if(u===xn||u===qe||u===Cn)continue;const d=Object.values(this.tasks).find(h=>h.id===c);d&&d.writes.push([u,l])}for(const c of Object.values(this.tasks))c.writes.length>0&&this._outputWrites(c.id,c.writes,!0)}if(Object.values(this.tasks).every(c=>c.writes.length>0))return this.tick({inputKeys:n});if(Wc(this.checkpoint,this.interruptBefore,Object.values(this.tasks)))throw this.status="interrupt_before",new la;const s=await Os(Ss(Eb(Object.values(this.tasks)),"tasks"));return this._emit(s),!0}async finishAndHandleError(e){this.durability==="exit"&&(!this.isNested||typeof e<"u"||this.checkpointNamespace.every(r=>!r.includes(ds)))&&(this._putCheckpoint(this.checkpointMetadata),this._flushPendingWrites());const n=this._suppressInterrupt(e);return(n||e===void 0)&&(this.output=Ci(this.channels,this.outputKeys)),n&&(this.tasks!==void 0&&this.checkpointPendingWrites.length>0&&Object.values(this.tasks).some(r=>r.writes.length>0)&&(this.updatedChannels=Un(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion,this.triggerToNodes),this._emit(Qa(Ss(yf(this.outputKeys,Object.values(this.tasks).flatMap(r=>r.writes),this.channels),"values")))),ea(e)&&!e.interrupts.length&&this._emit([["updates",{[qe]:[]}],["values",{[qe]:[]}]])),n}async acceptPush(e,n,r){var a,o;if(((a=this.interruptAfter)==null?void 0:a.length)>0&&Wc(this.checkpoint,this.interruptAfter,[e])){this.toInterrupt.push(e);return}const s=Gp([Bn,e.path??[],n,e.id,r],this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,e.config??{},!0,{step:this.step,checkpointer:this.checkpointer,manager:this.manager,store:this.store,stream:this.stream});if(!s)return;if(((o=this.interruptBefore)==null?void 0:o.length)>0&&Wc(this.checkpoint,this.interruptBefore,[s])){this.toInterrupt.push(s);return}this._emit(Qa(Ss(Eb([s]),"tasks"))),this.debug&&YT(this.step,[s]),this.tasks[s.id]=s,this.skipDoneTasks&&this._matchWrites({[s.id]:s});const i=await this._matchCachedWrites();for(const{task:c}of i)this._outputWrites(c.id,c.writes,!0);return s}_suppressInterrupt(e){return ea(e)&&!this.isNested}async _first(e){var a;const{configurable:n}=this.config,r=n==null?void 0:n[Bs];if(r&&r.nullResume!==void 0&&this.putWrites(Qn,[[Cn,r.nullResume]]),bn(this.input)){const o=this.input.resume!=null;if(this.input.resume!=null&&typeof this.input.resume=="object"&&Object.keys(this.input.resume).every(JT)&&((a=this.config).configurable??(a.configurable={}),this.config.configurable[Eu]=this.input.resume),o&&this.checkpointer==null)throw new Error("Cannot use Command(resume=...) without checkpointer");const c={};for(const[u,l,d]of Y4(this.input,this.checkpointPendingWrites))c[u]??(c[u]=[]),c[u].push([l,d]);if(Object.keys(c).length===0)throw new jy("Received empty Command input");for(const[u,l]of Object.entries(c))this.putWrites(u,l)}const s=(this.checkpointPendingWrites??[]).filter(o=>o[0]===Qn).map(o=>o.slice(1));s.length>0&&Un(this.checkpoint,this.channels,[{name:ss,writes:s,triggers:[]}],this.checkpointerGetNextVersion,this.triggerToNodes);const i=bn(this.input)&&s.length>0;if(this.isResuming||i){for(const c in this.channels)if(Object.prototype.hasOwnProperty.call(this.channels,c)&&this.checkpoint.channel_versions[c]!==void 0){const u=this.checkpoint.channel_versions[c];this.checkpoint.versions_seen[qe]={...this.checkpoint.versions_seen[qe],[c]:u}}const o=await Os(Ss(yf(this.outputKeys,!0,this.channels),"values"));this._emit(o)}if(this.isResuming)this.input=vf;else if(i)await this._putCheckpoint({source:"input"}),this.input=Jc;else{const o=await Os(ZT(e,this.input));if(o.length>0){const c=oa(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.config,!0,{step:this.step});this.updatedChannels=Un(this.checkpoint,this.channels,Object.values(c).concat([{name:ss,writes:o,triggers:[]}]),this.checkpointerGetNextVersion,this.triggerToNodes),await this._putCheckpoint({source:"input"}),this.input=Jc}else if(Is in(this.config.configurable??{}))this.input=Jc;else throw new jy(`Received no input writes for ${JSON.stringify(e,null,2)}`)}this.isNested||(this.config=gr(this.config,{[Is]:this.isResuming}))}_emit(e){for(const[n,r]of e)if(this.stream.modes.has(n)&&this.stream.push([this.checkpointNamespace,n,r]),(n==="checkpoints"||n==="tasks")&&this.stream.modes.has("debug")){const s=n==="checkpoints"?this.step-1:this.step,i=new Date().toISOString(),a=n==="checkpoints"?"checkpoint":typeof r=="object"&&r!=null&&"result"in r?"task_result":"task";this.stream.push([this.checkpointNamespace,"debug",{step:s,type:a,timestamp:i,payload:r}])}}_putCheckpoint(e){var i;const n=this.checkpointMetadata===e,r=this.checkpointer!=null&&(this.durability!=="exit"||n),s=a=>{var u,l,d;this.prevCheckpointConfig=(l=(u=this.checkpointConfig)==null?void 0:u.configurable)!=null&&l.checkpoint_id?this.checkpointConfig:void 0,this.checkpointConfig=gr(this.checkpointConfig,{[Mr]:((d=this.config.configurable)==null?void 0:d.checkpoint_ns)??""});const o={...this.checkpoint.channel_versions},c=Cu(this.checkpointPreviousVersions,o);this.checkpointPreviousVersions=o,this._checkpointerPutAfterPrevious({config:{...this.checkpointConfig},checkpoint:hl(a),metadata:{...this.checkpointMetadata},newVersions:c}),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_id:this.checkpoint.id}}};n||(this.checkpointMetadata={...e,step:this.step,parents:((i=this.config.configurable)==null?void 0:i[Xn])??{}}),this.checkpoint=ii(this.checkpoint,r?this.channels:void 0,this.step,n?{id:this.checkpoint.id}:void 0),r&&s(this.checkpoint),n||(this.step+=1)}_flushPendingWrites(){var r;if(this.checkpointer==null||this.checkpointPendingWrites.length===0)return;const e=gr(this.checkpointConfig,{[Mr]:((r=this.config.configurable)==null?void 0:r.checkpoint_ns)??"",[Fp]:this.checkpoint.id}),n={};for(const[s,i,a]of this.checkpointPendingWrites)n[s]??(n[s]=[]),n[s].push([i,a]);for(const[s,i]of Object.entries(n))this.checkpointerPromises.push(this.checkpointer.putWrites(e,i,s))}_matchWrites(e){for(const[n,r,s]of this.checkpointPendingWrites){if(r===xn||r===qe||r===Cn)continue;const i=Object.values(e).find(a=>a.id===n);i&&i.writes.push([r,s])}for(const n of Object.values(e))n.writes.length>0&&this._outputWrites(n.id,n.writes,!0)}};function SU(t){return Lt(t==null?void 0:t.message)}var xU=class extends Oa{constructor(e){super();p(this,"name","StreamMessagesHandler");p(this,"streamFn");p(this,"metadatas",{});p(this,"seen",{});p(this,"emittedChatModelRunIds",{});p(this,"stableMessageIdMap",{});p(this,"lc_prefer_streaming",!0);this.streamFn=e}_emit(e,n,r,s=!1){var a;if(s&&n.id!==void 0&&this.seen[n.id]!==void 0)return;let i=n.id;r!=null&&(Dm(n)?i??(i=`run-${r}-tool-${n.tool_call_id}`):((i==null||i===`run-${r}`)&&(i=this.stableMessageIdMap[r]??i??`run-${r}`),(a=this.stableMessageIdMap)[r]??(a[r]=i))),i!==n.id&&(n.id=i,n.lc_kwargs.id=i),n.id!=null&&(this.seen[n.id]=n),this.streamFn([e[0],"messages",[n,e[1]]])}handleChatModelStart(e,n,r,s,i,a,o,c){o&&(!a||!a.includes(E4)&&!a.includes("nostream"))&&(this.metadatas[r]=[o.langgraph_checkpoint_ns.split("|"),{tags:a,name:c,...o}])}handleLLMNewToken(e,n,r,s,i,a){const o=a==null?void 0:a.chunk;this.emittedChatModelRunIds[r]=!0,this.metadatas[r]!==void 0&&(SU(o)?this._emit(this.metadatas[r],o.message,r):this._emit(this.metadatas[r],new Et({content:e}),r))}handleLLMEnd(e,n){var r,s;if(this.metadatas[n]!==void 0){if(!this.emittedChatModelRunIds[n]){const i=(s=(r=e.generations)==null?void 0:r[0])==null?void 0:s[0];Lt(i==null?void 0:i.message)&&this._emit(this.metadatas[n],i==null?void 0:i.message,n,!0),delete this.emittedChatModelRunIds[n]}delete this.metadatas[n],delete this.stableMessageIdMap[n]}}handleLLMError(e,n){delete this.metadatas[n]}handleChainStart(e,n,r,s,i,a,o,c){if(a!==void 0&&c===a.langgraph_node&&(i===void 0||!i.includes(bt))&&(this.metadatas[r]=[a.langgraph_checkpoint_ns.split("|"),{tags:i,name:c,...a}],typeof n=="object")){for(const u of Object.values(n))if((Lt(u)||Ao(u))&&u.id!==void 0)this.seen[u.id]=u;else if(Array.isArray(u))for(const l of u)(Lt(l)||Ao(l))&&l.id!==void 0&&(this.seen[l.id]=l)}}handleChainEnd(e,n){const r=this.metadatas[n];if(delete this.metadatas[n],r!==void 0){if(Lt(e))this._emit(r,e,n,!0);else if(Array.isArray(e))for(const s of e)Lt(s)&&this._emit(r,s,n,!0);else if(e!=null&&typeof e=="object"){for(const s of Object.values(e))if(Lt(s))this._emit(r,s,n,!0);else if(Array.isArray(s))for(const i of s)Lt(i)&&this._emit(r,i,n,!0)}}}handleChainError(e,n){delete this.metadatas[n]}};const TU=500,AU=2,CU=128e3,kU=3,IU=[400,401,402,403,404,405,406,407,409],RU=t=>{var n,r;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||t.name==="GraphValueError"||(t==null?void 0:t.code)==="ECONNABORTED")return!1;const e=((n=t==null?void 0:t.response)==null?void 0:n.status)??(t==null?void 0:t.status);return!(e&&IU.includes(+e)||((r=t==null?void 0:t.error)==null?void 0:r.code)==="insufficient_quota")};async function tA(t,e,n,r){var l;const s=t.retry_policy??e;let i=s!==void 0?s.initialInterval??TU:0,a=0,o,c,{config:u}=t;for(n&&(u=gr(u,n)),u={...u,signal:r};!(r!=null&&r.aborted);){t.writes.splice(0,t.writes.length),o=void 0;try{c=await t.proc.invoke(t.input,u);break}catch(d){if(o=d,o.pregelTaskId=t.id,CI(o)){const g=(l=u==null?void 0:u.configurable)==null?void 0:l.checkpoint_ns,_=o.command;if(_.graph===g){for(const b of t.writers)await b.invoke(_,u);o=void 0;break}else if(_.graph===dn.PARENT){const b=I4(g);o.command=new dn({...o.command,graph:b})}}if(lu(o)||s===void 0||(a+=1,a>=(s.maxAttempts??kU))||!(s.retryOn??RU)(o))break;i=Math.min(s.maxInterval??CU,i*(s.backoffFactor??AU));const f=s.jitter?Math.floor(i+Math.random()*1e3):i;await new Promise(g=>setTimeout(g,f));const m=o.name??o.constructor.unminifiable_name??o.constructor.name;((s==null?void 0:s.logWarning)??!0)&&console.log(`Retrying task "${String(t.name)}" after ${i.toFixed(2)}ms (attempt ${a}) after ${m}: ${o}`),u=gr(u,{[Is]:!0})}}return{task:t,result:c,error:o,signalAborted:r==null?void 0:r.aborted}}const Wp=Symbol.for("promiseAdded");function OU(){const t={next:()=>{},wait:Promise.resolve(Wp)};function e(n){t.next=()=>{t.wait=new Promise(e),n(Wp)}}return t.wait=new Promise(e),t}var $U=class{constructor({loop:t,nodeFinished:e}){p(this,"nodeFinished");p(this,"loop");this.loop=t,this.nodeFinished=e}async tick(t={}){const{timeout:e,retryPolicy:n,onStepWrite:r,maxConcurrency:s}=t,i=new Set;let a;const o=new AbortController,c=o.signal,u=e?AbortSignal.timeout(e):void 0,l=Object.values(this.loop.tasks).filter(m=>m.writes.length===0),{signals:d,disposeCombinedSignal:h}=this._initializeAbortSignals({exceptionSignal:c,stepTimeoutSignal:u,signal:t.signal}),f=this._executeTasksWithRetry(l,{signals:d,retryPolicy:n,maxConcurrency:s});for await(const{task:m,error:g,signalAborted:_}of f)this._commit(m,g),ea(g)||lu(g)&&!ea(a)?a=g:g&&(i.size===0||!_)&&(o.abort(),i.add(g));if(h==null||h(),r==null||r(this.loop.step,Object.values(this.loop.tasks).map(m=>m.writes).flat()),i.size===1)throw Array.from(i)[0];if(i.size>1)throw new AggregateError(Array.from(i),`Multiple errors occurred during superstep ${this.loop.step}. See the "errors" field of this exception for more details.`);if(ea(a)||lu(a)&&this.loop.isNested)throw a}_initializeAbortSignals({exceptionSignal:t,stepTimeoutSignal:e,signal:n}){var u;const r=((u=this.loop.config.configurable)==null?void 0:u[gb])??{},s=r.externalAbortSignal??n,i=e??r.timeoutAbortSignal,{signal:a,dispose:o}=_l(s,i,t),c={externalAbortSignal:s,timeoutAbortSignal:i,composedAbortSignal:a};return this.loop.config=gr(this.loop.config,{[gb]:c}),{signals:c,disposeCombinedSignal:o}}async*_executeTasksWithRetry(t,e){var h,f,m;const{retryPolicy:n,maxConcurrency:r,signals:s}=e??{},i=OU(),a={},o={executingTasksMap:a,barrier:i,retryPolicy:n,scheduleTask:async(g,_,b)=>this.loop.acceptPush(g,_,b)};if((h=s==null?void 0:s.composedAbortSignal)!=null&&h.aborted)throw new Error("Abort");let c=0,u;const l=_l(s==null?void 0:s.externalAbortSignal,s==null?void 0:s.timeoutAbortSignal),d=l.signal?new Promise((g,_)=>{var b;u=()=>_(new Error("Abort")),(b=l.signal)==null||b.addEventListener("abort",u,{once:!0})}):void 0;for(;(c===0||Object.keys(a).length>0)&&t.length;){for(;Object.values(a).length<(r??t.length)&&c<t.length;c+=1){const _=t[c];a[_.id]=tA(_,n,{[Ug]:Iu==null?void 0:Iu.bind(o,this,_)},s==null?void 0:s.composedAbortSignal).catch(b=>{var y;return{task:_,error:b,signalAborted:(y=s==null?void 0:s.composedAbortSignal)==null?void 0:y.aborted}})}const g=await Promise.race([...Object.values(a),...d?[d]:[],i.wait]);g!==Wp&&(yield g,u!=null&&((f=l.signal)==null||f.removeEventListener("abort",u),(m=l.dispose)==null||m.call(l)),delete a[g.task.id])}}_commit(t,e){var n;if(e!==void 0)if(ea(e)){if(e.interrupts.length){const r=e.interrupts.map(i=>[qe,i]),s=t.writes.filter(i=>i[0]===Cn);s.length&&r.push(...s),this.loop.putWrites(t.id,r)}}else lu(e)&&t.writes.length?this.loop.putWrites(t.id,t.writes):this.loop.putWrites(t.id,[[xn,{message:e.message,name:e.name}]]);else this.nodeFinished&&(((n=t.config)==null?void 0:n.tags)==null||!t.config.tags.includes(bt))&&this.nodeFinished(String(t.name)),t.writes.length===0&&t.writes.push([Bg,null]),this.loop.putWrites(t.id,t.writes)}};async function Iu(t,e,n,r,s,i={}){var d,h;const a=(h=(d=e.config)==null?void 0:d.configurable)==null?void 0:h[Bs];if(!a)throw new Error(`BUG: No scratchpad found on task ${e.name}__${e.id}`);const o=a.callCounter;a.callCounter+=1;const c=new nU({func:n,name:r,input:s,cache:i.cache,retry:i.retry,callbacks:i.callbacks}),u=await this.scheduleTask(e,o,c);if(!u)return;const l=this.executingTasksMap[u.id];if(l!==void 0)return l;if(u.writes.length>0){const f=u.writes.filter(([g])=>g===xa),m=u.writes.filter(([g])=>g===xn);if(f.length>0){if(f.length===1)return Promise.resolve(f[0][1]);throw new Error(`BUG: multiple returns found for task ${u.name}__${u.id}`)}if(m.length>0){if(m.length===1){const g=m[0][1],_=g instanceof Error?g:new Error(String(g));return Promise.reject(_)}throw new Error(`BUG: multiple errors found for task ${u.name}__${u.id}`)}return}else{const f=tA(u,i.retry,{[Ug]:Iu.bind(this,t,u)});return this.executingTasksMap[u.id]=f,this.barrier.next(),f.then(({result:m,error:g})=>g?Promise.reject(g):m)}}var Yr=class extends Error{constructor(t){super(t),this.name="GraphValidationError"}};function NU({nodes:t,channels:e,inputChannels:n,outputChannels:r,streamChannels:s,interruptAfterNodes:i,interruptBeforeNodes:a}){if(!e)throw new Yr("Channels not provided");const o=new Set,c=new Set;for(const[u,l]of Object.entries(t)){if(u===qe)throw new Yr(`"Node name ${qe} is reserved"`);if(l.constructor===Vo)l.triggers.forEach(d=>o.add(d));else throw new Yr(`Invalid node type ${typeof l}, expected PregelNode`)}for(const u of o)if(!(u in e))throw new Yr(`Subscribed channel '${String(u)}' not in channels`);if(Array.isArray(n)){if(n.every(u=>!o.has(u)))throw new Yr(`None of the input channels ${n} are subscribed to by any node`)}else if(!o.has(n))throw new Yr(`Input channel ${String(n)} is not subscribed to by any node`);Array.isArray(r)?r.forEach(u=>c.add(u)):c.add(r),s&&!Array.isArray(s)?c.add(s):Array.isArray(s)&&s.forEach(u=>c.add(u));for(const u of c)if(!(u in e))throw new Yr(`Output channel '${String(u)}' not in channels`);if(i&&i!=="*"){for(const u of i)if(!(u in t))throw new Yr(`Node ${String(u)} not in nodes`)}if(a&&a!=="*"){for(const u of a)if(!(u in t))throw new Yr(`Node ${String(u)} not in nodes`)}}function Ab(t,e){if(Array.isArray(t)){for(const n of t)if(!(n in e))throw new Error(`Key ${String(n)} not found in channels`)}else if(!(t in e))throw new Error(`Key ${String(t)} not found in channels`)}var PU=class nA extends Li{constructor(n){super();p(this,"lc_graph_name","Topic");p(this,"unique",!1);p(this,"accumulate",!1);p(this,"seen");p(this,"values");this.unique=(n==null?void 0:n.unique)??this.unique,this.accumulate=(n==null?void 0:n.accumulate)??this.accumulate,this.seen=new Set,this.values=[]}fromCheckpoint(n){const r=new nA({unique:this.unique,accumulate:this.accumulate});return typeof n<"u"&&(r.seen=new Set(n[0]),r.values=n[1]),r}update(n){let r=!1;this.accumulate||(r=this.values.length>0,this.values=[]);const s=n.flat();if(s.length>0)if(this.unique)for(const i of s)this.seen.has(i)||(r=!0,this.seen.add(i),this.values.push(i));else r=!0,this.values.push(...s);return r}get(){if(this.values.length===0)throw new Zt;return this.values}checkpoint(){return[[...this.seen],this.values]}isAvailable(){return this.values.length!==0}};function LU(t){var c,u,l;const e=Dt.getRunnableConfig();if(!e)throw new Error("Called interrupt() outside the context of a graph.");const n=e.configurable;if(!n)throw new Error("No configurable found in config");if(!n[yt])throw new uu("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=n[Bs];s.interruptCounter+=1;const i=s.interruptCounter;if(s.resume.length>0&&i<s.resume.length)return(c=n[Us])==null||c.call(n,[[Cn,s.resume]]),s.resume[i];if(s.nullResume!==void 0){if(s.resume.length!==i)throw new Error(`Resume length mismatch: ${s.resume.length} !== ${i}`);const d=s.consumeNullResume();return s.resume.push(d),(u=n[Us])==null||u.call(n,[[Cn,s.resume]]),d}const a=(l=n[Mr])==null?void 0:l.split(Ot),o=a?ti(a.join(Ot)):void 0;throw new la([{id:o,value:t}])}var MU=class{static subscribeTo(t,e){const{key:n,tags:r}={key:void 0,tags:void 0,...e??{}};if(Array.isArray(t)&&n!==void 0)throw new Error("Can't specify a key when subscribing to multiple channels");let s;typeof t=="string"?n?s={[n]:t}:s=[t]:s=Object.fromEntries(t.map(a=>[a,a]));const i=Array.isArray(t)?t:[t];return new Vo({channels:s,triggers:i,tags:r})}static writeTo(t,e){const n=[];for(const r of t)n.push({channel:r,value:yi,skipNone:!1});for(const[r,s]of Object.entries(e??{}))je.isRunnable(s)||typeof s=="function"?n.push({channel:r,value:yi,skipNone:!0,mapper:Jt(s)}):n.push({channel:r,value:s,skipNone:!1});return new ln(n)}},DU=class extends je{constructor(){super(...arguments);p(this,"lc_namespace",["langgraph","pregel"])}invoke(e,n){throw new Error("Not implemented")}withConfig(e){return super.withConfig(e)}stream(e,n){return super.stream(e,n)}},UU=class extends DU{constructor(e){super(e);p(this,"lc_namespace",["langgraph","pregel"]);p(this,"lg_is_pregel",!0);p(this,"nodes");p(this,"channels");p(this,"inputChannels");p(this,"outputChannels");p(this,"autoValidate",!0);p(this,"streamMode",["values"]);p(this,"streamChannels");p(this,"interruptAfter");p(this,"interruptBefore");p(this,"stepTimeout");p(this,"debug",!1);p(this,"checkpointer");p(this,"retryPolicy");p(this,"config");p(this,"store");p(this,"cache");p(this,"userInterrupt");p(this,"triggerToNodes",{});let{streamMode:n}=e;if(n!=null&&!Array.isArray(n)&&(n=[n]),this.nodes=e.nodes,this.channels=e.channels,Yn in this.channels&&"lc_graph_name"in this.channels[Yn]&&this.channels[Yn].lc_graph_name!=="Topic")throw new Error(`Channel '${Yn}' is reserved and cannot be used in the graph.`);this.channels[Yn]=new PU({accumulate:!1}),this.autoValidate=e.autoValidate??this.autoValidate,this.streamMode=n??this.streamMode,this.inputChannels=e.inputChannels,this.outputChannels=e.outputChannels,this.streamChannels=e.streamChannels??this.streamChannels,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.stepTimeout=e.stepTimeout??this.stepTimeout,this.debug=e.debug??this.debug,this.checkpointer=e.checkpointer,this.retryPolicy=e.retryPolicy,this.config=e.config,this.store=e.store,this.cache=e.cache,this.name=e.name,this.triggerToNodes=e.triggerToNodes??this.triggerToNodes,this.userInterrupt=e.userInterrupt,this.autoValidate&&this.validate()}static lc_name(){return"LangGraph"}withConfig(e){const n=er(this.config,e);return new this.constructor({...this,config:n})}validate(){var e;NU({nodes:this.nodes,channels:this.channels,outputChannels:this.outputChannels,inputChannels:this.inputChannels,streamChannels:this.streamChannels,interruptAfterNodes:this.interruptAfter,interruptBeforeNodes:this.interruptBefore});for(const[n,r]of Object.entries(this.nodes))for(const s of r.triggers)(e=this.triggerToNodes)[s]??(e[s]=[]),this.triggerToNodes[s].push(n);return this}get streamChannelsList(){return Array.isArray(this.streamChannels)?this.streamChannels:this.streamChannels?[this.streamChannels]:Object.keys(this.channels)}get streamChannelsAsIs(){return this.streamChannels?this.streamChannels:Object.keys(this.channels)}async getGraphAsync(e){return this.getGraph(e)}*getSubgraphs(e,n){var r;for(const[s,i]of Object.entries(this.nodes)){if(e!==void 0&&!e.startsWith(s))continue;const a=(r=i.subgraphs)!=null&&r.length?i.subgraphs:[i.bound];for(const o of a){const c=FT(o);if(c!==void 0){if(s===e){yield[s,c];return}if(e===void 0&&(yield[s,c]),n){let u=e;e!==void 0&&(u=e.slice(s.length+1));for(const[l,d]of c.getSubgraphs(u,n))yield[`${s}${Ot}${l}`,d]}}}}}async*getSubgraphsAsync(e,n){yield*this.getSubgraphs(e,n)}async _prepareStateSnapshot({config:e,saved:n,subgraphCheckpointer:r,applyPendingWrites:s=!1}){var h,f,m,g,_,b,y,E;if(n===void 0)return{values:{},next:[],config:e,tasks:[]};const i=fl(this.channels,n.checkpoint);if((h=n.pendingWrites)!=null&&h.length){const C=n.pendingWrites.filter(([k,R])=>k===Qn).map(([k,R,$])=>[String(R),$]);C.length>0&&Un(n.checkpoint,i,[{name:ss,writes:C,triggers:[]}],void 0,this.triggerToNodes)}const a=Object.values(oa(n.checkpoint,n.pendingWrites,this.nodes,i,n.config,!0,{step:(((f=n.metadata)==null?void 0:f.step)??-1)+1,store:this.store})),o=await Os(this.getSubgraphsAsync()),c=((m=n.config.configurable)==null?void 0:m.checkpoint_ns)??"",u={};for(const C of a){const k=o.find(([$])=>$===C.name);if(!k)continue;let R=`${String(C.name)}${ds}${C.id}`;if(c&&(R=`${c}${Ot}${R}`),r===void 0){const $={configurable:{thread_id:(g=n.config.configurable)==null?void 0:g.thread_id,checkpoint_ns:R}};u[C.id]=$}else{const $={configurable:{[yt]:r,thread_id:(_=n.config.configurable)==null?void 0:_.thread_id,checkpoint_ns:R}},T=k[1];u[C.id]=await T.getState($,{subgraphs:!0})}}if(s&&((b=n.pendingWrites)!=null&&b.length)){const C=Object.fromEntries(a.map(R=>[R.id,R]));for(const[R,$,T]of n.pendingWrites)[xn,qe,du].includes($)||R in C&&C[R].writes.push([String($),T]);const k=a.filter(R=>R.writes.length>0);k.length>0&&Un(n.checkpoint,i,k,void 0,this.triggerToNodes)}let l=n==null?void 0:n.metadata;l&&((E=(y=n==null?void 0:n.config)==null?void 0:y.configurable)!=null&&E.thread_id)&&(l={...l,thread_id:n.config.configurable.thread_id});const d=a.filter(C=>C.writes.length===0).map(C=>C.name);return{values:Ci(i,this.streamChannelsAsIs),next:d,tasks:XT(a,(n==null?void 0:n.pendingWrites)??[],u,this.streamChannelsAsIs),metadata:l,config:Ks(n.config,n.metadata),createdAt:n.checkpoint.ts,parentConfig:n.parentConfig}}async getState(e,n){var c,u,l,d;const r=((c=e.configurable)==null?void 0:c[yt])??this.checkpointer;if(!r)throw new uu("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=((u=e.configurable)==null?void 0:u.checkpoint_ns)??"";if(s!==""&&((l=e.configurable)==null?void 0:l[yt])===void 0){const h=pf(s);for await(const[f,m]of this.getSubgraphsAsync(h,!0))if(f===h)return await m.getState(ji(e,{[yt]:r}),{subgraphs:n==null?void 0:n.subgraphs});throw new Error(`Subgraph with namespace "${h}" not found.`)}const i=er(this.config,e),a=await r.getTuple(e);return await this._prepareStateSnapshot({config:i,saved:a,subgraphCheckpointer:n!=null&&n.subgraphs?r:void 0,applyPendingWrites:!((d=e.configurable)!=null&&d.checkpoint_id)})}async*getStateHistory(e,n){var a,o,c;const r=((a=e.configurable)==null?void 0:a[yt])??this.checkpointer;if(!r)throw new uu("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=((o=e.configurable)==null?void 0:o.checkpoint_ns)??"";if(s!==""&&((c=e.configurable)==null?void 0:c[yt])===void 0){const u=pf(s);for await(const[l,d]of this.getSubgraphsAsync(u,!0))if(l===u){yield*d.getStateHistory(ji(e,{[yt]:r}),n);return}throw new Error(`Subgraph with namespace "${u}" not found.`)}const i=er(this.config,e,{configurable:{checkpoint_ns:s}});for await(const u of r.list(i,n))yield this._prepareStateSnapshot({config:u.config,saved:u})}async bulkUpdateState(e,n){var o,c,u;const r=((o=e.configurable)==null?void 0:o[yt])??this.checkpointer;if(!r)throw new uu("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});if(n.length===0)throw new Error("No supersteps provided");if(n.some(l=>l.updates.length===0))throw new Error("No updates provided");const s=((c=e.configurable)==null?void 0:c.checkpoint_ns)??"";if(s!==""&&((u=e.configurable)==null?void 0:u[yt])===void 0){const l=pf(s);for await(const[,d]of this.getSubgraphsAsync(l,!0))return await d.bulkUpdateState(ji(e,{[yt]:r}),n);throw new Error(`Subgraph "${l}" not found`)}const i=async(l,d)=>{var q,ie,me,j,F,H,re,ue,ne,fe,Ce;const h=this.config?er(this.config,l):l,f=await r.getTuple(h),m=f!==void 0?hl(f.checkpoint):OT(),g={...f==null?void 0:f.checkpoint.channel_versions},_=((q=f==null?void 0:f.metadata)==null?void 0:q.step)??-1;let b=ji(h,{checkpoint_ns:((ie=h.configurable)==null?void 0:ie.checkpoint_ns)??""}),y=h.metadata??{};f!=null&&f.config.configurable&&(b=ji(h,f.config.configurable),y={...f.metadata,...y});const{values:E,asNode:C}=d[0];if(E==null&&C===void 0){if(d.length>1)throw new at("Cannot create empty checkpoint with multiple updates");const J=await r.put(b,ii(m,void 0,_),{source:"update",step:_+1,parents:((me=f==null?void 0:f.metadata)==null?void 0:me.parents)??{}},{});return Ks(J,f?f.metadata:void 0)}const k=fl(this.channels,m);if(E===null&&C===Fe){if(d.length>1)throw new at("Cannot apply multiple updates when clearing state");if(f){const Q=oa(m,f.pendingWrites||[],this.nodes,k,f.config,!0,{step:(((j=f.metadata)==null?void 0:j.step)??-1)+1,checkpointer:r,store:this.store}),ae=(f.pendingWrites||[]).filter(Z=>Z[0]===Qn).map(Z=>Z.slice(1));ae.length>0&&Un(m,k,[{name:ss,writes:ae,triggers:[]}],r.getNextVersion.bind(r),this.triggerToNodes);for(const[Z,A,S]of f.pendingWrites||[])[xn,qe,du].includes(A)||Z in Q&&Q[Z].writes.push([A,S]);Un(m,k,Object.values(Q),r.getNextVersion.bind(r),this.triggerToNodes)}const J=await r.put(b,ii(m,k,_),{...y,source:"update",step:_+1,parents:((F=f==null?void 0:f.metadata)==null?void 0:F.parents)??{}},Cu(g,m.channel_versions));return Ks(J,f?f.metadata:void 0)}if(C===w4){if(d.length>1)throw new at("Cannot copy checkpoint with multiple updates");if(f==null)throw new at("Cannot copy a non-existent checkpoint");const J=Z=>!Array.isArray(Z)||Z.length===0?!1:Z.every(A=>Array.isArray(A)&&A.length===2),Q=ii(m,void 0,_),ae=await r.put(f.parentConfig??ji(f.config,{checkpoint_id:void 0}),Q,{source:"fork",step:_+1,parents:((H=f.metadata)==null?void 0:H.parents)??{}},{});if(J(E)){const Z=oa(Q,f.pendingWrites,this.nodes,k,ae,!1,{step:_+2}),A=Object.values(Z).reduce((M,{name:N,id:ke})=>(M[N]??(M[N]=[]),M[N].push({id:ke}),M),{}),S=E.reduce((M,N)=>{var ot,Bt;const[ke,$e]=N;M[$e]??(M[$e]=[]);const We=M[$e].length,nt=(Bt=(ot=A[$e])==null?void 0:ot[We])==null?void 0:Bt.id;return M[$e].push({values:ke,asNode:$e,taskId:nt}),M},{});return i(Ks(ae,f.metadata),Object.values(S).flat())}return Ks(ae,f.metadata)}if(C===ss){if(d.length>1)throw new at("Cannot apply multiple updates when updating as input");const J=await Os(ZT(this.inputChannels,E));if(J.length===0)throw new at(`Received no input writes for ${JSON.stringify(this.inputChannels,null,2)}`);Un(m,k,[{name:ss,writes:J,triggers:[]}],r.getNextVersion.bind(this.checkpointer),this.triggerToNodes);const Q=((re=f==null?void 0:f.metadata)==null?void 0:re.step)!=null?f.metadata.step+1:-1,ae=await r.put(b,ii(m,k,Q),{source:"input",step:Q,parents:((ue=f==null?void 0:f.metadata)==null?void 0:ue.parents)??{}},Cu(g,m.channel_versions));return await r.putWrites(ae,J,ta(ss,m.id)),Ks(ae,f?f.metadata:void 0)}if(((ne=h.configurable)==null?void 0:ne.checkpoint_id)===void 0&&(f==null?void 0:f.pendingWrites)!==void 0&&f.pendingWrites.length>0){const J=oa(m,f.pendingWrites,this.nodes,k,f.config,!0,{store:this.store,checkpointer:this.checkpointer,step:(((fe=f.metadata)==null?void 0:fe.step)??-1)+1}),Q=(f.pendingWrites??[]).filter(Z=>Z[0]===Qn).map(Z=>Z.slice(1));Q.length>0&&Un(f.checkpoint,k,[{name:ss,writes:Q,triggers:[]}],void 0,this.triggerToNodes);for(const[Z,A,S]of f.pendingWrites)[xn,qe,du].includes(A)||J[Z]===void 0||J[Z].writes.push([A,S]);const ae=Object.values(J).filter(Z=>Z.writes.length>0);ae.length>0&&Un(m,k,ae,void 0,this.triggerToNodes)}const R=Object.values(m.versions_seen).map(J=>Object.values(J)).flat().find(J=>!!J),$=[];if(d.length===1){let{values:J,asNode:Q,taskId:ae}=d[0];if(Q===void 0&&Object.keys(this.nodes).length===1)[Q]=Object.keys(this.nodes);else if(Q===void 0&&R===void 0)typeof this.inputChannels=="string"&&this.nodes[this.inputChannels]!==void 0&&(Q=this.inputChannels);else if(Q===void 0){const Z=Object.entries(m.versions_seen).map(([A,S])=>Object.values(S).map(M=>[M,A])).flat().filter(([A,S])=>S!==qe).sort(([A],[S])=>$T(A,S));Z&&(Z.length===1?Q=Z[0][1]:Z[Z.length-1][0]!==Z[Z.length-2][0]&&(Q=Z[Z.length-1][1]))}if(Q===void 0)throw new at('Ambiguous update, specify "asNode"');$.push({values:J,asNode:Q,taskId:ae})}else for(const{asNode:J,values:Q,taskId:ae}of d){if(J==null)throw new at('"asNode" is required when applying multiple updates');$.push({values:Q,asNode:J,taskId:ae})}const T=[];for(const{asNode:J,values:Q,taskId:ae}of $){if(this.nodes[J]===void 0)throw new at(`Node "${J.toString()}" does not exist`);const Z=this.nodes[J].getWriters();if(!Z.length)throw new at(`No writers found for node "${J.toString()}"`);T.push({name:J,input:Q,proc:Z.length>1?Jr.from(Z,{omitSequenceTags:!0}):Z[0],writes:[],triggers:[qe],id:ae??ta(qe,m.id),writers:[]})}for(const J of T)await J.proc.invoke(J.input,Je({...h,store:(h==null?void 0:h.store)??this.store},{runName:h.runName??`${this.getName()}UpdateState`,configurable:{[Us]:Q=>J.writes.push(...Q),[gi]:(Q,ae=!1)=>ku(m,k,J,Q,ae)}}));for(const J of T){const Q=J.writes.filter(ae=>ae[0]!==Bn);f!==void 0&&Q.length>0&&await r.putWrites(b,Q,J.id)}Un(m,k,T,r.getNextVersion.bind(this.checkpointer),this.triggerToNodes);const B=Cu(g,m.channel_versions),z=await r.put(b,ii(m,k,_+1),{source:"update",step:_+1,parents:((Ce=f==null?void 0:f.metadata)==null?void 0:Ce.parents)??{}},B);for(const J of T){const Q=J.writes.filter(ae=>ae[0]===Bn);Q.length>0&&await r.putWrites(z,Q,J.id)}return Ks(z,f?f.metadata:void 0)};let a=e;for(const{updates:l}of n)a=await i(a,l);return a}async updateState(e,n,r){return this.bulkUpdateState(e,[{updates:[{values:n,asNode:r}]}])}_defaults(e){var k,R,$;const{debug:n,streamMode:r,inputKeys:s,outputKeys:i,interruptAfter:a,interruptBefore:o,...c}=e;let u=!0;const l=n!==void 0?n:this.debug;let d=i;d===void 0?d=this.streamChannelsAsIs:Ab(d,this.channels);let h=s;h===void 0?h=this.inputChannels:Ab(h,this.channels);const f=o??this.interruptBefore??[],m=a??this.interruptAfter??[];let g;r!==void 0?(g=Array.isArray(r)?r:[r],u=typeof r=="string"):(((k=e.configurable)==null?void 0:k[yo])!==void 0?g=["values"]:g=this.streamMode,u=!0);let _;if(this.checkpointer===!1)_=void 0;else if(e!==void 0&&((R=e.configurable)==null?void 0:R[yt])!==void 0)_=e.configurable[yt];else{if(this.checkpointer===!0)throw new Error("checkpointer: true cannot be used for root graphs.");_=this.checkpointer}const b=e.store??this.store,y=e.cache??this.cache;if(e.durability!=null&&e.checkpointDuring!=null)throw new Error("Cannot use both `durability` and `checkpointDuring` at the same time.");const E=(()=>{if(e.checkpointDuring!=null)return e.checkpointDuring===!1?"exit":"async"})(),C=e.durability??E??(($=e==null?void 0:e.configurable)==null?void 0:$[DT])??"async";return[l,g,h,d,c,f,m,_,b,u,y,C]}async stream(e,n){var a;const r=new AbortController,s={recursionLimit:(a=this.config)==null?void 0:a.recursionLimit,...n,signal:_l(n==null?void 0:n.signal,r.signal).signal},i=await super.stream(e,s);return new Sb((n==null?void 0:n.encoding)==="text/event-stream"?_U(i):i,r)}streamEvents(e,n,r){var a,o;const s=new AbortController,i={recursionLimit:(a=this.config)==null?void 0:a.recursionLimit,...n,callbacks:tU((o=this.config)==null?void 0:o.callbacks,n==null?void 0:n.callbacks),signal:_l(n==null?void 0:n.signal,s.signal).signal};return new Sb(super.streamEvents(e,i,r),s)}async _validateInput(e){return e}async _validateContext(e){return e}async*_streamIterator(e,n){const r="version"in(n??{})?void 0:(n==null?void 0:n.encoding)??void 0,s=n==null?void 0:n.subgraphs,i=BT(this.config,n);if(i.recursionLimit===void 0||i.recursionLimit<1)throw new Error('Passed "recursionLimit" must be at least 1.');if(this.checkpointer!==void 0&&this.checkpointer!==!1&&i.configurable===void 0)throw new Error('Checkpointer requires one or more of the following "configurable" keys: "thread_id", "checkpoint_ns", "checkpoint_id"');const a=await this._validateInput(e),{runId:o,...c}=i,[u,l,,d,h,f,m,g,_,b,y,E]=this._defaults(c);typeof h.context<"u"?h.context=await this._validateContext(h.context):h.configurable=await this._validateContext(h.configurable);const C=new QT({modes:new Set(l)});if(this.checkpointer===!0){h.configurable??(h.configurable={});const ie=h.configurable[Mr]??"";h.configurable[Mr]=ie.split(Ot).map(me=>me.split(ds)[0]).join(Ot)}if(l.includes("messages")){const ie=new xU(j=>C.push(j)),{callbacks:me}=h;if(me===void 0)h.callbacks=[ie];else if(Array.isArray(me))h.callbacks=me.concat(ie);else{const j=me.copy();j.addHandler(ie,!0),h.callbacks=j}}h.writer??(h.writer=ie=>{var j,F,H;if(!l.includes("custom"))return;const me=(H=(F=(j=k4())==null?void 0:j.configurable)==null?void 0:F[Mr])==null?void 0:H.split(Ot).slice(0,-1);C.push([me??[],"custom",ie])}),h.interrupt??(h.interrupt=this.userInterrupt??LU);const k=await An(h),R=await(k==null?void 0:k.handleChainStart(this.toJSON(),eU(e,"input"),o,void 0,void 0,void 0,(h==null?void 0:h.runName)??this.getName())),$=Mg(this.channels);let T,B;const q=(async()=>{var ie,me,j;try{T=await EU.initialize({input:a,config:h,checkpointer:g,nodes:this.nodes,channelSpecs:$,outputKeys:d,streamKeys:this.streamChannelsAsIs,store:_,cache:y,stream:C,interruptAfter:m,interruptBefore:f,manager:R,debug:this.debug,triggerToNodes:this.triggerToNodes,durability:E});const F=new $U({loop:T,nodeFinished:(ie=h.configurable)==null?void 0:ie[v4]});n!=null&&n.subgraphs&&(T.config.configurable={...T.config.configurable,[pl]:T.stream}),await this._runLoop({loop:T,runner:F,debug:u,config:h}),E==="sync"&&await Promise.all((T==null?void 0:T.checkpointerPromises)??[])}catch(F){B=F}finally{try{T&&(await((me=T.store)==null?void 0:me.stop()),await((j=T.cache)==null?void 0:j.stop())),await Promise.all((T==null?void 0:T.checkpointerPromises)??[])}catch(F){B=B??F}B?C.error(B):C.close()}})();try{for await(const ie of C){if(ie===void 0)throw new Error("Data structure error.");const[me,j,F]=ie;if(l.includes(j)){if(r==="text/event-stream"){s?yield[me,j,F]:yield[null,j,F];continue}s&&!b?yield[me,j,F]:b?s?yield[me,F]:yield F:yield[j,F]}}}catch(ie){throw await(R==null?void 0:R.handleChainError(B)),ie}finally{await q}await(R==null?void 0:R.handleChainEnd((T==null?void 0:T.output)??{},o,void 0,void 0,void 0))}async invoke(e,n){const r=(n==null?void 0:n.streamMode)??"values",s={...n,outputKeys:(n==null?void 0:n.outputKeys)??this.outputChannels,streamMode:r,encoding:void 0},i=[],a=await this.stream(e,s),o=[];let c;for await(const u of a)r==="values"?UT(u)?o.push(u[qe]):c=u:i.push(u);if(r==="values"){if(o.length>0){const u=o.flat(1);if(c==null)return{[qe]:u};if(typeof c=="object")return{...c,[qe]:u}}return c}return i}async _runLoop(e){const{loop:n,runner:r,debug:s,config:i}=e;let a;try{for(;await n.tick({inputKeys:this.inputChannels});){for(const{task:o}of await n._matchCachedWrites())n._outputWrites(o.id,o.writes,!0);s&&pU(n.checkpointMetadata.step,n.channels,this.streamChannelsList),s&&YT(n.step,Object.values(n.tasks)),await r.tick({timeout:this.stepTimeout,retryPolicy:this.retryPolicy,onStepWrite:(o,c)=>{s&&mU(o,c,this.streamChannelsList)},maxConcurrency:i.maxConcurrency,signal:i.signal})}if(n.status==="out_of_steps")throw new AI([`Recursion limit of ${i.recursionLimit} reached`,"without hitting a stop condition. You can increase the",'limit by setting the "recursionLimit" config key.'].join(" "),{lc_error_code:"GRAPH_RECURSION_LIMIT"})}catch(o){if(a=o,!await n.finishAndHandleError(a))throw o}finally{a===void 0&&await n.finishAndHandleError()}}async clearCache(){var e;await((e=this.cache)==null?void 0:e.clear([]))}},Aa=class rA extends Li{constructor(n=!0){super();p(this,"lc_graph_name","EphemeralValue");p(this,"guard");p(this,"value",[]);this.guard=n}fromCheckpoint(n){const r=new rA(this.guard);return typeof n<"u"&&(r.value=[n]),r}update(n){if(n.length===0){const r=this.value.length>0;return this.value=[],r}if(n.length!==1&&this.guard)throw new at("EphemeralValue can only receive one value per step.");return this.value=[n[n.length-1]],!0}get(){if(this.value.length===0)throw new Zt;return this.value[0]}checkpoint(){if(this.value.length===0)throw new Zt;return this.value[0]}isAvailable(){return this.value.length!==0}};const BU=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Cb(t){return typeof t=="string"&&BU.test(t)}var qt=[];for(var Ef=0;Ef<256;++Ef)qt.push((Ef+256).toString(16).slice(1));function jU(t,e=0){return(qt[t[e+0]]+qt[t[e+1]]+qt[t[e+2]]+qt[t[e+3]]+"-"+qt[t[e+4]]+qt[t[e+5]]+"-"+qt[t[e+6]]+qt[t[e+7]]+"-"+qt[t[e+8]]+qt[t[e+9]]+"-"+qt[t[e+10]]+qt[t[e+11]]+qt[t[e+12]]+qt[t[e+13]]+qt[t[e+14]]+qt[t[e+15]]).toLowerCase()}var Zc,FU=new Uint8Array(16);function zU(){if(!Zc&&(Zc=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Zc))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Zc(FU)}var VU=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const kb={randomUUID:VU};function Ib(t,e,n){if(kb.randomUUID&&!t)return kb.randomUUID();t=t||{};var r=t.random||(t.rng||zU)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,jU(r)}var sA=class{constructor(t){p(this,"path");p(this,"ends");je.isRunnable(t.path)?this.path=t.path:this.path=Jt(t.path).withConfig({runName:"Branch"}),this.ends=Array.isArray(t.pathMap)?t.pathMap.reduce((e,n)=>(e[n]=n,e),{}):t.pathMap}run(t,e){return ln.registerWriter(new Mi({name:"<branch_run>",trace:!1,func:async(n,r)=>{try{return await this._route(n,r,t,e)}catch(s){throw s.name===Rv.unminifiable_name&&console.warn(`[WARN]: 'NodeInterrupt' thrown in conditional edge. This is likely a bug in your graph implementation.
NodeInterrupt should only be thrown inside a node, not in edge conditions.`),s}}}))}async _route(t,e,n,r){let s=await this.path.invoke(r?r(e):t,e);Array.isArray(s)||(s=[s]);let i;if(this.ends?i=s.map(o=>qn(o)?o:this.ends[o]):i=s,i.some(o=>!o))throw new Error("Branch condition returned unknown or null destination");if(i.filter(qn).some(o=>o.node===Fe))throw new at("Cannot send a packet to the END node");return await n(i,e)??t}},qU=class{constructor(){p(this,"nodes");p(this,"edges");p(this,"branches");p(this,"entryPoint");p(this,"compiled",!1);this.nodes={},this.edges=new Set,this.branches={}}warnIfCompiled(t){this.compiled&&console.warn(t)}get allEdges(){return this.edges}addNode(...t){function e(r){return r.length>=1&&typeof r[0]!="string"}const n=e(t)?Array.isArray(t[0])?t[0]:Object.entries(t[0]):[[t[0],t[1],t[2]]];if(n.length===0)throw new Error("No nodes provided in `addNode`");for(const[r,s,i]of n){for(const o of[Ot,ds])if(r.includes(o))throw new Error(`"${o}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),r in this.nodes)throw new Error(`Node \`${r}\` already present.`);if(r===Fe)throw new Error(`Node \`${r}\` is reserved.`);const a=Jt(s);this.nodes[r]={runnable:a,metadata:i==null?void 0:i.metadata,subgraphs:jg(a)?[a]:i==null?void 0:i.subgraphs,ends:i==null?void 0:i.ends}}return this}addEdge(t,e){if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),t===Fe)throw new Error("END cannot be a start node");if(e===Qe)throw new Error("START cannot be an end node");if(Array.from(this.edges).some(([n])=>n===t)&&!("channels"in this))throw new Error(`Already found path for ${t}. For multiple edges, use StateGraph.`);return this.edges.add([t,e]),this}addConditionalEdges(t,e,n){var i,a;const r=typeof t=="object"?t:{source:t,path:e,pathMap:n};if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),!je.isRunnable(r.path)){const o=Array.isArray(r.pathMap)?r.pathMap.join(","):Object.keys(r.pathMap??{}).join(",");r.path=Jt(r.path).withConfig({runName:`Branch<${r.source}${o!==""?`,${o}`:""}>`.slice(0,63)})}const s=r.path.getName()==="RunnableLambda"?"condition":r.path.getName();if(this.branches[r.source]&&this.branches[r.source][s])throw new Error(`Condition \`${s}\` already present for node \`${t}\``);return(i=this.branches)[a=r.source]??(i[a]={}),this.branches[r.source][s]=new sA(r),this}setEntryPoint(t){return this.warnIfCompiled("Setting the entry point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(Qe,t)}setFinishPoint(t){return this.warnIfCompiled("Setting a finish point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(t,Fe)}compile({checkpointer:t,interruptBefore:e,interruptAfter:n,name:r}={}){this.validate([...Array.isArray(e)?e:[],...Array.isArray(n)?n:[]]);const s=new iA({builder:this,checkpointer:t,interruptAfter:n,interruptBefore:e,autoValidate:!1,nodes:{},channels:{[Qe]:new Aa,[Fe]:new Aa},inputChannels:Qe,outputChannels:Fe,streamChannels:[],streamMode:"values",name:r});for(const[i,a]of Object.entries(this.nodes))s.attachNode(i,a);for(const[i,a]of this.edges)s.attachEdge(i,a);for(const[i,a]of Object.entries(this.branches))for(const[o,c]of Object.entries(a))s.attachBranch(i,o,c);return s.validate()}validate(t){const e=new Set([...this.allEdges].map(([r,s])=>r));for(const[r]of Object.entries(this.branches))e.add(r);for(const r of e)if(r!==Qe&&!(r in this.nodes))throw new Error(`Found edge starting at unknown node \`${r}\``);const n=new Set([...this.allEdges].map(([r,s])=>s));for(const[r,s]of Object.entries(this.branches))for(const i of Object.values(s))if(i.ends!=null)for(const a of Object.values(i.ends))n.add(a);else{n.add(Fe);for(const a of Object.keys(this.nodes))a!==r&&n.add(a)}for(const r of Object.values(this.nodes))for(const s of r.ends??[])n.add(s);for(const r of Object.keys(this.nodes))if(!n.has(r))throw new kI([`Node \`${r}\` is not reachable.`,"","If you are returning Command objects from your node,",'make sure you are passing names of potential destination nodes as an "ends" array','into ".addNode(..., { ends: ["node1", "node2"] })".'].join(`
`),{lc_error_code:"UNREACHABLE_NODE"});for(const r of n)if(r!==Fe&&!(r in this.nodes))throw new Error(`Found edge ending at unknown node \`${r}\``);if(t){for(const r of t)if(!(r in this.nodes))throw new Error(`Interrupt node \`${r}\` is not present`)}this.compiled=!0}},iA=class extends UU{constructor({builder:e,...n}){super(n);p(this,"builder");this.builder=e}attachNode(e,n){this.channels[e]=new Aa,this.nodes[e]=new Vo({channels:[],triggers:[],metadata:n.metadata,subgraphs:n.subgraphs,ends:n.ends}).pipe(n.runnable).pipe(new ln([{channel:e,value:yi}],[bt])),this.streamChannels.push(e)}attachEdge(e,n){if(n===Fe){if(e===Qe)throw new Error("Cannot have an edge from START to END");this.nodes[e].writers.push(new ln([{channel:Fe,value:yi}],[bt]))}else this.nodes[n].triggers.push(e),this.nodes[n].channels.push(e)}attachBranch(e,n,r){e===Qe&&!this.nodes[Qe]&&(this.nodes[Qe]=MU.subscribeTo(Qe,{tags:[bt]})),this.nodes[e].pipe(r.run(i=>{const a=i.map(o=>qn(o)?o:{channel:o===Fe?Fe:`branch:${e}:${n}:${o}`,value:yi});return new ln(a,[bt])}));const s=r.ends?Object.values(r.ends):Object.keys(this.nodes);for(const i of s)if(i!==Fe){const a=`branch:${e}:${n}:${i}`;this.channels[a]=new Aa,this.nodes[i].triggers.push(a),this.nodes[i].channels.push(a)}}async getGraphAsync(e){var u,l,d,h;const n=e==null?void 0:e.xray,r=new Uo,s={[Qe]:r.addNode({schema:Vc()},Qe)},i={};let a={};n&&(a=Object.fromEntries((await Os(this.getSubgraphsAsync())).filter(f=>Rb(f[1]))));function o(f,m,g,_=!1){if(m===Fe&&i[Fe]===void 0&&(i[Fe]=r.addNode({schema:Vc()},Fe)),s[f]!==void 0){if(i[m]===void 0)throw new Error(`End node ${m} not found!`);return r.addEdge(s[f],i[m],g!==m?g:void 0,_)}}for(const[f,m]of Object.entries(this.builder.nodes)){const g=en(f),_=m.runnable,b=m.metadata??{};if((u=this.interruptBefore)!=null&&u.includes(f)&&((l=this.interruptAfter)!=null&&l.includes(f))?b.__interrupt="before,after":(d=this.interruptBefore)!=null&&d.includes(f)?b.__interrupt="before":(h=this.interruptAfter)!=null&&h.includes(f)&&(b.__interrupt="after"),n){const y=typeof n=="number"?n-1:n,E=a[f]!==void 0?await a[f].getGraphAsync({...e,xray:y}):_.getGraph(e);if(E.trimFirstNode(),E.trimLastNode(),Object.keys(E.nodes).length>1){let R=function(T){return T?T.lc_runnable:!1},$=function(T,B){if(T!==void 0&&!Cb(T))return T;if(R(B))try{let z=B.getName();return z=z.startsWith("Runnable")?z.slice(8):z,z}catch{return B.getName()}else return B.name??"UnknownSchema"};const[C,k]=r.extend(E,g);if(C===void 0)throw new Error(`Could not extend subgraph "${f}" due to missing entrypoint.`);k!==void 0&&(s[g]={name:$(k.id,k.data),...k}),i[g]={name:$(C.id,C.data),...C}}else{const C=r.addNode(_,g,b);s[g]=C,i[g]=C}}else{const y=r.addNode(_,g,b);s[g]=y,i[g]=y}}const c=[...this.builder.allEdges].sort(([f],[m])=>f<m?-1:m>f?1:0);for(const[f,m]of c)o(en(f),en(m));for(const[f,m]of Object.entries(this.builder.branches)){const g={...Object.fromEntries(Object.keys(this.builder.nodes).filter(_=>_!==f).map(_=>[en(_),en(_)])),[Fe]:Fe};for(const _ of Object.values(m)){let b;_.ends!==void 0?b=_.ends:b=g;for(const[y,E]of Object.entries(b))o(en(f),en(E),y,!0)}}for(const[f,m]of Object.entries(this.builder.nodes))if(m.ends!==void 0)for(const g of m.ends)o(en(f),en(g),void 0,!0);return r}getGraph(e){var u,l,d,h;const n=e==null?void 0:e.xray,r=new Uo,s={[Qe]:r.addNode({schema:Vc()},Qe)},i={};let a={};n&&(a=Object.fromEntries(Qa(this.getSubgraphs()).filter(f=>Rb(f[1]))));function o(f,m,g,_=!1){return m===Fe&&i[Fe]===void 0&&(i[Fe]=r.addNode({schema:Vc()},Fe)),r.addEdge(s[f],i[m],g!==m?g:void 0,_)}for(const[f,m]of Object.entries(this.builder.nodes)){const g=en(f),_=m.runnable,b=m.metadata??{};if((u=this.interruptBefore)!=null&&u.includes(f)&&((l=this.interruptAfter)!=null&&l.includes(f))?b.__interrupt="before,after":(d=this.interruptBefore)!=null&&d.includes(f)?b.__interrupt="before":(h=this.interruptAfter)!=null&&h.includes(f)&&(b.__interrupt="after"),n){const y=typeof n=="number"?n-1:n,E=a[f]!==void 0?a[f].getGraph({...e,xray:y}):_.getGraph(e);if(E.trimFirstNode(),E.trimLastNode(),Object.keys(E.nodes).length>1){let R=function(T){return T?T.lc_runnable:!1},$=function(T,B){if(T!==void 0&&!Cb(T))return T;if(R(B))try{let z=B.getName();return z=z.startsWith("Runnable")?z.slice(8):z,z}catch{return B.getName()}else return B.name??"UnknownSchema"};const[C,k]=r.extend(E,g);if(C===void 0)throw new Error(`Could not extend subgraph "${f}" due to missing entrypoint.`);k!==void 0&&(s[g]={name:$(k.id,k.data),...k}),i[g]={name:$(C.id,C.data),...C}}else{const C=r.addNode(_,g,b);s[g]=C,i[g]=C}}else{const y=r.addNode(_,g,b);s[g]=y,i[g]=y}}const c=[...this.builder.allEdges].sort(([f],[m])=>f<m?-1:m>f?1:0);for(const[f,m]of c)o(en(f),en(m));for(const[f,m]of Object.entries(this.builder.branches)){const g={...Object.fromEntries(Object.keys(this.builder.nodes).filter(_=>_!==f).map(_=>[en(_),en(_)])),[Fe]:Fe};for(const _ of Object.values(m)){let b;_.ends!==void 0?b=_.ends:b=g;for(const[y,E]of Object.entries(b))o(en(f),en(E),y,!0)}}return r}};function Rb(t){return typeof t.attachNode=="function"&&typeof t.attachEdge=="function"}function en(t){return t==="subgraph"?`"${t}"`:t}const ui=(t,e)=>t.size===e.size&&[...t].every(n=>e.has(n));var HU=class aA extends Li{constructor(n){super();p(this,"lc_graph_name","NamedBarrierValue");p(this,"names");p(this,"seen");this.names=n,this.seen=new Set}fromCheckpoint(n){const r=new aA(this.names);return typeof n<"u"&&(r.seen=new Set(n)),r}update(n){let r=!1;for(const s of n)if(this.names.has(s))this.seen.has(s)||(this.seen.add(s),r=!0);else throw new at(`Value ${JSON.stringify(s)} not in names ${JSON.stringify(this.names)}`);return r}get(){if(!ui(this.names,this.seen))throw new Zt}checkpoint(){return[...this.seen]}consume(){return this.seen&&this.names&&ui(this.seen,this.names)?(this.seen=new Set,!0):!1}isAvailable(){return!!this.names&&ui(this.names,this.seen)}},GU=class oA extends Li{constructor(n){super();p(this,"lc_graph_name","NamedBarrierValueAfterFinish");p(this,"names");p(this,"seen");p(this,"finished");this.names=n,this.seen=new Set,this.finished=!1}fromCheckpoint(n){const r=new oA(this.names);if(typeof n<"u"){const[s,i]=n;r.seen=new Set(s),r.finished=i}return r}update(n){let r=!1;for(const s of n)if(this.names.has(s)&&!this.seen.has(s))this.seen.add(s),r=!0;else if(!this.names.has(s))throw new at(`Value ${JSON.stringify(s)} not in names ${JSON.stringify(this.names)}`);return r}get(){if(!this.finished||!ui(this.names,this.seen))throw new Zt}checkpoint(){return[[...this.seen],this.finished]}consume(){return this.finished&&this.seen&&this.names&&ui(this.seen,this.names)?(this.seen=new Set,this.finished=!1,!0):!1}finish(){return!this.finished&&this.names&&ui(this.names,this.seen)?(this.finished=!0,!0):!1}isAvailable(){return this.finished&&!!this.names&&ui(this.names,this.seen)}};const WU="lg:";var JU=class{constructor(){p(this,"_map",new WeakMap);p(this,"_extensionCache",new Map)}get(t){return this._map.get(t)}extend(t,e){const n=this.get(t);this._map.set(t,e(n))}remove(t){return this._map.delete(t),this}has(t){return this._map.has(t)}getChannelsForSchema(t){const e={},n=Po(t);for(const[r,s]of Object.entries(n)){const i=this.get(s);i!=null&&i.reducer?e[r]=new Bp(i.reducer.fn,i.default):e[r]=new Dg}return e}getExtendedChannelSchemas(t,e){if(Object.keys(e).length===0)return t;const n=Object.entries(e).filter(([,i])=>i===!0).sort(([i],[a])=>i.localeCompare(a)).map(([i,a])=>`${i}:${a}`).join("|"),r=this._extensionCache.get(n)??new WeakMap;if(r.has(t))return r.get(t);let s=t;if(e.withReducerSchema||e.withJsonSchemaExtrasAsDescription){const i=Object.entries(Po(t)).map(([a,o])=>{var l;const c=this.get(o);let u=e.withReducerSchema?((l=c==null?void 0:c.reducer)==null?void 0:l.schema)??o:o;if(e.withJsonSchemaExtrasAsDescription&&(c!=null&&c.jsonSchemaExtra)){const d=xi(u)??xi(o),h=JSON.stringify({...c.jsonSchemaExtra,description:d});u=u.describe(`${WU}${h}`)}return[a,u]});s=yS(t,Object.fromEntries(i)),gt(s)&&(s._def.unknownKeys="strip")}return e.asPartial&&(s=ag(s)),r.set(t,s),this._extensionCache.set(n,r),s}};const wl=new JU;function ZU(t,e){var n;if(e.reducer&&!e.default){const r=_S(t);r!=null&&(e.default=r)}if(e.reducer){const r=Object.assign(t,{lg_reducer_schema:((n=e.reducer)==null?void 0:n.schema)??t});return wl.extend(r,()=>e),r}else return wl.extend(t,()=>e),t}const cs="__root__",Jp=Symbol.for("langgraph.state.partial");var KU=class extends qU{constructor(e,n){var s,i;super();p(this,"channels",{});p(this,"waitingEdges",new Set);p(this,"_schemaDefinition");p(this,"_schemaRuntimeDefinition");p(this,"_inputDefinition");p(this,"_inputRuntimeDefinition");p(this,"_outputDefinition");p(this,"_outputRuntimeDefinition");p(this,"_schemaDefinitions",new Map);p(this,"_metaRegistry",wl);p(this,"_configSchema");p(this,"_configRuntimeSchema");p(this,"_interrupt");p(this,"_writer");if(rB(e)){const a=this._metaRegistry.getChannelsForSchema(e.state),o=e.input!=null?this._metaRegistry.getChannelsForSchema(e.input):a,c=e.output!=null?this._metaRegistry.getChannelsForSchema(e.output):a;this._schemaDefinition=a,this._schemaRuntimeDefinition=e.state,this._inputDefinition=o,this._inputRuntimeDefinition=e.input??Jp,this._outputDefinition=c,this._outputRuntimeDefinition=e.output??e.state}else if(yr(e)){const a=this._metaRegistry.getChannelsForSchema(e);this._schemaDefinition=a,this._schemaRuntimeDefinition=e,this._inputDefinition=a,this._inputRuntimeDefinition=Jp,this._outputDefinition=a,this._outputRuntimeDefinition=e}else if(nB(e))this._schemaDefinition=e.input.spec,this._inputDefinition=e.input.spec,this._outputDefinition=e.output.spec;else if(tB(e))this._schemaDefinition=e.stateSchema.spec,this._inputDefinition=((s=e.input)==null?void 0:s.spec)??this._schemaDefinition,this._outputDefinition=((i=e.output)==null?void 0:i.spec)??this._schemaDefinition;else if(QU(e)||Ob(e)){const a=Ob(e)?e.spec:e;this._schemaDefinition=a}else if(eB(e)){const a=XU(e.channels);this._schemaDefinition=a}else throw new Error("Invalid StateGraph input. Make sure to pass a valid Annotation.Root or Zod schema.");this._inputDefinition??(this._inputDefinition=this._schemaDefinition),this._outputDefinition??(this._outputDefinition=this._schemaDefinition),this._addSchema(this._schemaDefinition),this._addSchema(this._inputDefinition),this._addSchema(this._outputDefinition);function r(a){return typeof a=="object"&&a!=null&&!("spec"in a)&&!yr(a)}r(n)?(yr(n.context)&&(this._configRuntimeSchema=n.context),this._interrupt=n.interrupt,this._writer=n.writer):yr(n)&&(this._configRuntimeSchema=n)}get allEdges(){return new Set([...this.edges,...Array.from(this.waitingEdges).flatMap(([e,n])=>e.map(r=>[r,n]))])}_addSchema(e){if(!this._schemaDefinitions.has(e)){this._schemaDefinitions.set(e,e);for(const[n,r]of Object.entries(e)){let s;if(typeof r=="function"?s=r():s=r,this.channels[n]!==void 0){if(this.channels[n]!==s&&s.lc_graph_name!=="LastValue")throw new Error(`Channel "${n}" already exists with a different type.`)}else this.channels[n]=s}}}addNode(...e){function n(s){return s.length>=1&&typeof s[0]!="string"}const r=n(e)?Array.isArray(e[0])?e[0]:Object.entries(e[0]).map(([s,i])=>[s,i]):[[e[0],e[1],e[2]]];if(r.length===0)throw new Error("No nodes provided in `addNode`");for(const[s,i,a]of r){if(s in this.channels)throw new Error(`${s} is already being used as a state attribute (a.k.a. a channel), cannot also be used as a node name.`);for(const d of[Ot,ds])if(s.includes(d))throw new Error(`"${d}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),s in this.nodes)throw new Error(`Node \`${s}\` already present.`);if(s===Fe||s===Qe)throw new Error(`Node \`${s}\` is reserved.`);let o=this._schemaDefinition;(a==null?void 0:a.input)!==void 0&&(yr(a.input)?o=this._metaRegistry.getChannelsForSchema(a.input):a.input.spec!==void 0&&(o=a.input.spec)),o!==void 0&&this._addSchema(o);let c;je.isRunnable(i)?c=i:typeof i=="function"?c=new Mi({func:i,name:s,trace:!1}):c=Jt(i);let u=a==null?void 0:a.cachePolicy;typeof u=="boolean"&&(u=u?{}:void 0);const l={runnable:c,retryPolicy:a==null?void 0:a.retryPolicy,cachePolicy:u,metadata:a==null?void 0:a.metadata,input:o??this._schemaDefinition,subgraphs:jg(c)?[c]:a==null?void 0:a.subgraphs,ends:a==null?void 0:a.ends,defer:a==null?void 0:a.defer};this.nodes[s]=l}return this}addEdge(e,n){if(typeof e=="string")return super.addEdge(e,n);this.compiled&&console.warn("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph.");for(const r of e){if(r===Fe)throw new Error("END cannot be a start node");if(!Object.keys(this.nodes).some(s=>s===r))throw new Error(`Need to add a node named "${r}" first`)}if(n===Fe)throw new Error("END cannot be an end node");if(!Object.keys(this.nodes).some(r=>r===n))throw new Error(`Need to add a node named "${n}" first`);return this.waitingEdges.add([e,n]),this}addSequence(e){const n=Array.isArray(e)?e:Object.entries(e);if(n.length===0)throw new Error("Sequence requires at least one node.");let r;for(const[s,i,a]of n){if(s in this.nodes)throw new Error(`Node names must be unique: node with the name "${s}" already exists.`);const o=s;this.addNode(o,i,a),r!=null&&this.addEdge(r,o),r=o}return this}compile({checkpointer:e,store:n,cache:r,interruptBefore:s,interruptAfter:i,name:a,description:o}={}){this.validate([...Array.isArray(s)?s:[],...Array.isArray(i)?i:[]]);const c=Object.keys(this._schemaDefinitions.get(this._outputDefinition)),u=c.length===1&&c[0]===cs?cs:c,l=Object.keys(this.channels),d=l.length===1&&l[0]===cs?cs:l,h=this._interrupt,f=new YU({builder:this,checkpointer:e,interruptAfter:i,interruptBefore:s,autoValidate:!1,nodes:{},channels:{...this.channels,[Qe]:new Aa},inputChannels:Qe,outputChannels:u,streamChannels:d,streamMode:"updates",store:n,cache:r,name:a,description:o,userInterrupt:h});f.attachNode(Qe);for(const[m,g]of Object.entries(this.nodes))f.attachNode(m,g);f.attachBranch(Qe,yb,$b(),{withReader:!1});for(const[m]of Object.entries(this.nodes))f.attachBranch(m,yb,$b(),{withReader:!1});for(const[m,g]of this.edges)f.attachEdge(m,g);for(const[m,g]of this.waitingEdges)f.attachEdge(m,g);for(const[m,g]of Object.entries(this.branches))for(const[_,b]of Object.entries(g))f.attachBranch(m,_,b);return f.validate()}};function XU(t){const e={};for(const[n,r]of Object.entries(t))e[n]=jp(r);return e}var YU=class extends iA{constructor({description:e,...n}){super(n);p(this,"description");p(this,"_metaRegistry",wl);this.description=e}attachNode(e,n){let r;e===Qe?r=Object.entries(this.builder._schemaDefinitions.get(this.builder._inputDefinition)).map(([c])=>c):r=Object.keys(this.builder.channels);function s(c){if(bn(c))return c.graph===dn.PARENT?null:c._updateAsTuples();if(Array.isArray(c)&&c.length>0&&c.some(u=>bn(u))){const u=[];for(const l of c)if(bn(l)){if(l.graph===dn.PARENT)continue;u.push(...l._updateAsTuples())}else u.push([cs,l]);return u}else if(c!=null)return[[cs,c]];return null}const i=e;function a(c){if(c){if(bn(c))return c.graph===dn.PARENT?null:c._updateAsTuples().filter(([u])=>r.includes(u));if(Array.isArray(c)&&c.length>0&&c.some(bn)){const u=[];for(const l of c)if(bn(l)){if(l.graph===dn.PARENT)continue;u.push(...l._updateAsTuples().filter(([d])=>r.includes(d)))}else{const d=a(l);d&&u.push(...d??[])}return u}else{if(typeof c=="object"&&!Array.isArray(c))return Object.entries(c).filter(([u])=>r.includes(u));{const u=Array.isArray(c)?"array":typeof c;throw new at(`Expected node "${i.toString()}" to return an object or an array containing at least one Command object, received ${u}`,{lc_error_code:"INVALID_GRAPH_NODE_RETURN_VALUE"})}}}else return null}const o=[{value:yi,mapper:new Mi({func:r.length&&r[0]===cs?s:a,trace:!1,recurse:!1})}];if(e===Qe)this.nodes[e]=new Vo({tags:[bt],triggers:[Qe],channels:[Qe],writers:[new ln(o,[bt])]});else{const c=(n==null?void 0:n.input)??this.builder._schemaDefinition,u=Object.fromEntries(Object.keys(this.builder._schemaDefinitions.get(c)).map(h=>[h,h])),l=Object.keys(u).length===1&&cs in u,d=`branch:to:${e}`;this.channels[d]=n!=null&&n.defer?new y4:new Aa(!1),this.nodes[e]=new Vo({triggers:[d],channels:l?Object.keys(u):u,writers:[new ln(o,[bt])],mapper:l?void 0:h=>Object.fromEntries(Object.entries(h).filter(([f])=>f in u)),bound:n==null?void 0:n.runnable,metadata:n==null?void 0:n.metadata,retryPolicy:n==null?void 0:n.retryPolicy,cachePolicy:n==null?void 0:n.cachePolicy,subgraphs:n==null?void 0:n.subgraphs,ends:n==null?void 0:n.ends})}}attachEdge(e,n){if(n!==Fe){if(typeof e=="string")this.nodes[e].writers.push(new ln([{channel:`branch:to:${n}`,value:null}],[bt]));else if(Array.isArray(e)){const r=`join:${e.join("+")}:${n}`;this.channels[r]=this.builder.nodes[n].defer?new GU(new Set(e)):new HU(new Set(e)),this.nodes[n].triggers.push(r);for(const s of e)this.nodes[s].writers.push(new ln([{channel:r,value:s}],[bt]))}}}attachBranch(e,n,r,s={withReader:!0}){const i=async(a,o)=>{const c=a.filter(l=>l!==Fe);if(!c.length)return;const u=c.map(l=>qn(l)?l:{channel:l===Fe?l:`branch:to:${l}`,value:e});await ln.doWrite({...o,tags:(o.tags??[]).concat([bt])},u)};this.nodes[e].writers.push(r.run(i,s.withReader?a=>O4.doRead(a,this.streamChannels??this.outputChannels,!0):void 0))}async _validateInput(e){if(e==null)return e;const n=(()=>{const r=this.builder._inputRuntimeDefinition,s=this.builder._schemaRuntimeDefinition,i=a=>{if(a!=null)return this._metaRegistry.getExtendedChannelSchemas(a,{withReducerSchema:!0})};if(yr(r))return i(r);if(r===Jp)return ag(i(s))})();if(bn(e)){const r=e;return e.update&&n!=null&&(r.update=mu(n,e.update)),r}return n!=null?mu(n,e):e}isInterrupted(e){return UT(e)}async _validateContext(e){const n=this.builder._configRuntimeSchema;return yr(n)&&mu(n,e),e}};function QU(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)&&Object.keys(t).length>0&&Object.values(t).every(e=>typeof e=="function"||NT(e))}function Ob(t){return typeof t=="object"&&t!==null&&"lc_graph_name"in t&&t.lc_graph_name==="AnnotationRoot"}function eB(t){return typeof t=="object"&&t!==null&&t.channels!==void 0}function tB(t){return typeof t=="object"&&t!==null&&t.stateSchema!==void 0}function nB(t){return typeof t=="object"&&t!==null&&t.stateSchema===void 0&&t.input!==void 0&&t.output!==void 0}function rB(t){return!(typeof t!="object"||t==null||!("state"in t)||!yr(t.state)||"input"in t&&!yr(t.input)||"output"in t&&!yr(t.output))}function sB(t){if(qn(t))return[t];const e=[];bn(t)?e.push(t):Array.isArray(t)&&e.push(...t.filter(bn));const n=[];for(const r of e){if(r.graph===dn.PARENT)throw new Ov(r);qn(r.goto)||typeof r.goto=="string"?n.push(r.goto):Array.isArray(r.goto)&&n.push(...r.goto)}return n}function $b(){const t=new Mi({func:sB,tags:[bt],trace:!1,recurse:!1,name:"<control_branch>"});return new sA({path:t})}const iB="__remove_all__";function cA(t,e){const n=Array.isArray(t)?t:[t],r=Array.isArray(e)?e:[e],s=n.map(Vr),i=r.map(Vr);for(const l of s)(l.id===null||l.id===void 0)&&(l.id=Ib(),l.lc_kwargs.id=l.id);let a;for(let l=0;l<i.length;l+=1){const d=i[l];(d.id===null||d.id===void 0)&&(d.id=Ib(),d.lc_kwargs.id=d.id),d.getType()==="remove"&&d.id===iB&&(a=l)}if(a!=null)return i.slice(a+1);const o=[...s],c=new Map(o.map((l,d)=>[l.id,d])),u=new Set;for(const l of i){const d=c.get(l.id);if(d!==void 0)l.getType()==="remove"?u.add(l.id):(u.delete(l.id),o[d]=l);else{if(l.getType()==="remove")throw new Error(`Attempting to delete a message with an ID that doesn't exist ('${l.id}')`);c.set(l.id,o.length),o.push(l)}}return o.filter(l=>!u.has(l.id))}pt.Root({messages:pt({reducer:cA,default:()=>[]})});const aB={reducer:{fn:cA},jsonSchemaExtra:{langgraph_type:"messages"},default:()=>[]};mn({messages:ZU(LP(),aB)});const oB=40,cB=35,uB=50,lB=2,dB=5,Kc={ASSET:"Asset",ENTITY:"Entity"},Xs={SPOOFING:"Spoofing",TAMPERING:"Tampering",REPUDIATION:"Repudiation",INFORMATION_DISCLOSURE:"Information Disclosure",DENIAL_OF_SERVICE:"Denial of Service",ELEVATION_OF_PRIVILEGE:"Elevation of Privilege"},Sf={LOW:"Low",MEDIUM:"Medium",HIGH:"High"},hB=mn({summary:rt().describe(`A short headline summary of max ${oB} words`)}),fB=mn({type:vp([Kc.ASSET,Kc.ENTITY]).describe(`Type, one of ${Kc.ASSET} or ${Kc.ENTITY}`),name:rt().describe("The name of the asset"),description:rt().describe("The description of the asset or entity")}),pB=mn({assets:pi(fB).describe("The list of assets")}),mB=mn({flow_description:rt().describe("The description of the data flow"),source_entity:rt().describe("The source entity/asset of the data flow"),target_entity:rt().describe("The target entity/asset of the data flow")}),gB=mn({purpose:rt().describe("The purpose of the trust boundary"),source_entity:rt().describe("The source entity/asset of the trust boundary"),target_entity:rt().describe("The target entity/asset of the trust boundary")}),yB=mn({category:rt().describe("Actor Category"),description:rt().describe("One sentence describing their relevance to this architecture"),example:rt().describe("Brief list of 1-2 specific actor types")}),_B=mn({data_flows:pi(mB).describe("The list of data flows"),trust_boundaries:pi(gB).describe("The list of trust boundaries"),threat_sources:pi(yB).describe("The list of threat actors")}),wB=mn({name:rt().describe("A concise, descriptive name for the threat that clearly identifies the security concern"),stride_category:vp([Xs.SPOOFING,Xs.TAMPERING,Xs.REPUDIATION,Xs.INFORMATION_DISCLOSURE,Xs.DENIAL_OF_SERVICE,Xs.ELEVATION_OF_PRIVILEGE]).describe(`The STRIDE category classification: One of ${Object.values(Xs).join(", ")}`),description:rt().describe(`A comprehensive description of the threat scenario, including how it could be executed and its potential consequences. Must be between ${cB} and ${uB} words. Follow threat grammar: [Threat Actor] + [Action] + [Asset/Target] + [Negative Outcome]`),target:rt().describe("The specific asset, component, system, or data element that could be compromised by this threat"),impact:rt().describe("The potential business, technical, or operational consequences if this threat is successfully exploited. Consider confidentiality, integrity, and availability impacts"),likelihood:vp([Sf.LOW,Sf.MEDIUM,Sf.HIGH]).describe("The probability of threat occurrence based on factors like attacker motivation, capability, opportunity, and existing controls"),mitigations:pi(rt()).min(lB).max(dB).describe("Specific security controls, countermeasures, or design changes that can prevent, detect, or reduce the impact of this threat"),source:rt().describe("The threat actor or agent who could execute this threat"),prerequisites:pi(rt()).default([]).describe("Required conditions, access levels, knowledge, or system states that must exist for this threat to be viable"),vector:rt().describe("The attack vector or pathway through which the threat could be delivered or executed"),starred:xS().default(!1).optional().describe("User-defined flag for prioritization or tracking. Ignored by automated threat modeling agents")}),bB=mn({threats:pi(wB).describe("The list of threats")}),vB=mn({stop:xS().describe("Should continue evaluation further threats or the catalog is comprehensive and complete."),gap:rt().optional().default("").describe("The identited list of gaps discovered to improve the threat catalog. Required only when 'stop' is False. ")});function EB(t,e){if(!t)return e;if(!e)return t;const n=new Set(t.threats.map(s=>s.name)),r=e.threats.filter(s=>!n.has(s.name));return{threats:[...t.threats,...r]}}function SB(t,e){return t?e?[...t,...e]:t:e||[]}function on(t,e){return e??t}const xB=pt.Root({job_id:pt({reducer:on}),summary:pt({reducer:on}),assets:pt({reducer:on}),image_data:pt({reducer:on}),system_architecture:pt({reducer:on}),description:pt({reducer:on}),assumptions:pt({reducer:on}),threat_list:pt({reducer:EB}),iteration:pt({reducer:on}),retry:pt({reducer:on}),s3_location:pt({reducer:on}),title:pt({reducer:on}),owner:pt({reducer:on}),stop:pt({reducer:on}),gap:pt({reducer:SB}),replay:pt({reducer:on}),instructions:pt({reducer:on})});class TB{constructor(){this.store=new Map}run(e,n,...r){const s=this.store;this.store=new Map(s),this.store.set("current",e);try{return n(...r)}finally{this.store=s}}getStore(){return this.store.get("current")}enterWith(e){this.store.set("current",e)}disable(){this.store.delete("current")}exit(e,...n){const r=this.store;this.store=new Map;try{return e(...n)}finally{this.store=r}}}function AB(){Dt.initializeGlobalInstance(new TB)}AB();class wc{constructor(e,n,r){this.image_data=e,this.description=n,this.assumptions=r;const s=Fl();this.supportsCaching=(s==null?void 0:s.provider)==="bedrock"}base_msg(e=!1){const n=[{type:"text",text:"<architecture_diagram>"},{type:"image_url",image_url:{url:`data:image/jpeg;base64,${this.image_data}`}},{type:"text",text:"</architecture_diagram>"},{type:"text",text:`<description>${this.description}</description>`},{type:"text",text:`<assumptions>${this.assumptions}</assumptions>`}];return e&&this.supportsCaching&&n.push({cachePoint:{type:"default"}}),n}createSummaryMessage(e=40){const n=[{type:"text",text:`Generate a short headline summary of max ${e} words this architecture using the diagram and description if available`}],r=this.base_msg();return r.push(...n),new It({content:r})}createAssetMessage(){const e=[{type:"text",text:"Identify Assets"}],n=this.base_msg();return n.push(...e),new It({content:n})}createSystemFlowsMessage(e){const r=[{type:"text",text:`<identified_assets_and_entities>${typeof e=="string"?e:JSON.stringify(e)}</identified_assets_and_entities>`},{type:"text",text:"Identify system flows"}],s=this.base_msg();return s.push(...r),new It({content:s})}createThreatMessage(e,n){const r=typeof e=="string"?e:JSON.stringify(e),s=typeof n=="string"?n:JSON.stringify(n),i=[{type:"text",text:`<identified_assets_and_entities>${r}</identified_assets_and_entities>`},{type:"text",text:`<data_flow>${s}</data_flow>`},{type:"text",text:"Define threats and mitigations for the solution"}],a=this.base_msg();return a.push(...i),new It({content:a})}createThreatImproveMessage(e,n,r,s){const i=typeof e=="string"?e:JSON.stringify(e),a=typeof n=="string"?n:JSON.stringify(n),o=typeof r=="string"?r:JSON.stringify(r),c=[{type:"text",text:`<identified_assets_and_entities>${i}</identified_assets_and_entities>`},{type:"text",text:`<data_flow>${a}</data_flow>`}];this.supportsCaching&&c.push({cachePoint:{type:"default"}}),c.push({type:"text",text:`<threats>${o}</threats>`},{type:"text",text:`<gap>${s}</gap>`},{type:"text",text:"Identify missing threats and respective mitigations for the solution"});const u=this.base_msg(!0);return u.push(...c),new It({content:u})}createGapAnalysisMessage(e,n,r,s){const i=typeof e=="string"?e:JSON.stringify(e),a=typeof n=="string"?n:JSON.stringify(n),o=typeof r=="string"?r:JSON.stringify(r),c=[{type:"text",text:`<identified_assets_and_entities>${i}</identified_assets_and_entities>`},{type:"text",text:`<data_flow>${a}</data_flow>`}];this.supportsCaching&&c.push({cachePoint:{type:"default"}}),c.push({type:"text",text:`<threats>${o}</threats>`},{type:"text",text:`<previous_gap>${s}</previous_gap>
`},{type:"text",text:"Identify missing threats and respective mitigations for the solution"});const u=this.base_msg(!0);return u.push(...c),new It({content:u})}}function bc(t){return!t||t.length===0?" ":t.join(`
`)}const CB=40;function kB(){return[{type:"text",text:`<instruction>
   Use the information provided by the user to generate a short headline summary of max ${CB} words.
   </instruction> 

      `}]}function IB(){return[{type:"text",text:`<instruction>
   You are an expert in all security domains and threat modeling. Your role is to carefully review a given architecture and identify key assets and entities that require protection. Follow these steps:

   1. Review the provided inputs carefully:

         * <architecture_diagram>: Architecture Diagram of the solution in scope for threat modeling.
         * <description>: [Description of the solution provided by the user]
         * <assumptions>: [Assumptions provided by the user]

   2. Identify the most critical assets within the system, such as sensitive data, databases, communication channels, or APIs. These are components that need protection.

   3. Identify the key entities involved, such as users, services, or systems interacting with the system.

   4. For each identified asset or entity, provide the following information in the specified format:

   Type: [Asset or Entity]
   Name: [Asset/Entity Name]
   Description: [Brief description of the asset/entity]
   </instruction> 

      `}]}function RB(){return[{type:"text",text:`
<task>
You are an expert in all security domains and threat modeling. Your goal is to systematically analyze the given system architecture and identify critical security elements: data flows, trust boundaries, and relevant threat actors. Your analysis must be comprehensive, architecturally-grounded, and focused on elements that impact the security posture of the system.
</task>

<instructions>

1. Review the provided inputs carefully:

   * <architecture_diagram>: Architecture Diagram of the solution in scope for threat modeling.
   * <description>: [Description of the solution provided by the user]
   * <assumptions>: [Assumptions provided by the user]
   * <identified_assets_and_entities>: Inventory of key assets and entities in the architecture.

2. Data Flow Analysis:

   **Definition**: Data flows represent the movement of information between system components, including the path, direction, and security context of the data movement.

   **Identification approach**:
   - Map all significant data movements between identified assets and entities
   - Consider both internal flows (within trust boundaries) and external flows (crossing trust boundaries)
   - Focus on flows involving sensitive data, authentication credentials, or business-critical information
   - Include bidirectional flows where relevant
   - Consider both primary operational flows and secondary flows (logs, backups, monitoring)

   **Use the following format for each data flow**:
   <data_flow_definition>
   flow_description: [Clear description of what data moves and how]
   source_entity: [Source entity name from assets inventory]
   target_entity: [Target entity name from assets inventory]
   assets: [List of specific assets/data types involved in this flow]
   flow_type: [Internal/External/Cross-boundary]
   criticality: [High/Medium/Low - based on data sensitivity and business impact]
   </data_flow_definition>

3. Trust Boundary Analysis:

   **Definition**: Trust boundaries are logical or physical barriers where the level of trust changes, typically representing transitions between different security domains, ownership, or control levels.

   **Identification criteria**:
   - Network boundaries (internal to external networks, DMZ transitions)
   - Process boundaries (different applications, services, or execution contexts)
   - Physical boundaries (on-premises to cloud, different data centers)
   - Organizational boundaries (internal systems to third-party services)
   - Administrative boundaries (different management domains or privilege levels)

   **Use the following format for each trust boundary**:
   <trust_boundary>
   purpose: [Security purpose and what trust level change occurs]
   source_entity: [Entity on the higher trust side]
   target_entity: [Entity on the lower trust side]
   boundary_type: [Network/Process/Physical/Organizational/Administrative]
   security_controls: [Existing controls at this boundary, if known]
   </trust_boundary>

4. Threat Actor Analysis:

   **Definition**: Threat actors are individuals, groups, or entities with the potential to compromise the system's security objectives.

   **Output format**: Present threat actors in a concise table format:

   | Category | Description | Examples |
   |----------|-------------|----------|
   | [Actor Category] | [One sentence describing their relevance to this architecture] | [Brief list of 1-2 specific actor types] |

   **Standard threat actor categories to consider**:
   - Legitimate Users (unintentional threats)
   - Malicious Internal Actors (intentional insider threats)
   - External Threat Actors (external attackers)
   - Untrusted Data Suppliers (third-party integrations)
   - Unauthorized External Users (no legitimate access)
   - Compromised System Components (if applicable)

   **Selection criteria**:
   - Only include categories with clear relevance to the architecture
   - Maximum 5-7 threat actor categories
   - Focus on actor types, not attack methods
   - Keep descriptions to ONE concise sentence
   - Examples should be 2-5 words each

   **Output constraints**:
   - No attack scenarios or narratives
   - No detailed technical descriptions
   - No step-by-step attack explanations
   - Focus on WHO might attack, not HOW

5. Analysis guidelines:

   **Completeness requirements**:
   - Address all identified assets and entities from the provided inventory
   - Consider the full system lifecycle (deployment, operation, maintenance, decommissioning)
   - Include both automated and manual processes
   - Account for emergency or disaster recovery scenarios if mentioned

   **Contextual alignment**:
   - Respect the stated assumptions and constraints
   - Focus on elements relevant to the described solution and deployment model
   - Consider the organization's threat landscape based on provided context
   - Align with the technical architecture and technology stack described

   **Prioritization approach**:
   - Prioritize high-criticality flows involving sensitive data
   - Focus on trust boundaries with significant security implications
   - Emphasize threat actors with realistic access to the described architecture

6. Quality control checklist:

   **Data Flows**:
   * [ ] Are all significant data movements between assets identified?
   * [ ] Are both internal and cross-boundary flows covered?
   * [ ] Is the criticality assessment based on data sensitivity and business impact?
   * [ ] Are flow descriptions specific and technically accurate?

   **Trust Boundaries**:
   * [ ] Are all significant trust level transitions identified?
   * [ ] Is the security purpose of each boundary clearly articulated?
   * [ ] Are different types of boundaries (network, process, physical, etc.) considered?
   * [ ] Do boundaries align with the described architecture?

   **Threat Actors**:
   * [ ] Is the output in table format with Category, Description, Examples columns?
   * [ ] Are descriptions limited to ONE sentence?
   * [ ] Are examples brief (2-5 words each)?
   * [ ] Is the total count reasonable (typically 5-7 categories)?
   * [ ] Does the analysis avoid attack scenarios and technical details?

   **Overall Analysis**:
   * [ ] Does the analysis cover all provided assets and entities?
   * [ ] Is the analysis consistent with stated assumptions?
   * [ ] Are security-critical elements prioritized appropriately?
   * [ ] Would this analysis support effective threat modeling?
</instructions>
`}]}function Nb(t=null){const e=`You are an expert threat modeling specialist focused on rigorous gap identification and clear stop/continue judgment. Your job is to evaluate a threat catalog ONLY for realistic, actionable gaps within customer boundaries, and to make a definitive decision—after thorough checks—on whether threat modeling can STOP or must CONTINUE.
<critical_validation_requirements>
BEFORE identifying any gap, you MUST verify:
1. If <assumptions> are provided: The gap does NOT contradict any assumption
2. The gap is a REALISTIC, EXPLOITABLE vulnerability—not theoretical
3. The threat actor who could exploit this gap EXISTS in <data_flow> threat_sources
4. The customer CAN actually address this gap (within their control)
5. The gap is a real architectural vulnerability, with practical attack path
If any check fails, DO NOT include the gap in your analysis.
</critical_validation_requirements>
<assumption_enforcement>
WHEN ASSUMPTIONS ARE PROVIDED: Treat assumptions as absolute constraints—do not identify any gap contradicted or invalidated by assumptions.
WHEN NO ASSUMPTIONS: Use standard industry security expectations for comparable systems; do NOT assume controls are present unless evidence shows so.
</assumption_enforcement>
<gap_realism_guidance>
Only identify gaps with documented, practical, real-world exploitability. Each must:
- Be based on practical attacker capabilities
- Have clear attack paths and business relevance
- Avoid unlikely, theoretical, or non-customer actionable issues
If realism or relevance is in doubt, SKIP this gap.
</gap_realism_guidance>
<gap_analysis_process>
Process for judgment:
1. Coverage Matrix: Map assets/entities x STRIDE to spot missing coverage
2. For each empty cell, in strict order, check:
a. Assumptions (skip if contradicted)
b. Realism (skip if not practical)
c. Architecture (skip if not plausible)
d. Threat Source (skip if no matching actor)
e. Customer Control (skip if not customer-controlled)
f. Materiality (skip if not meaningful)
Only IF ALL are true, document the gap.
3. When assessing coverage, poor-quality or incorrect existing threat records (unrealistic, out-of-scope, or not customer actionable) are themselves gaps.
</gap_analysis_process>
<shared_responsibility_boundaries>
NEVER identify gaps outside customer control (e.g., cloud provider hardware or infrastructure). For IaaS, PaaS, SaaS, validate strictly against customer responsibility boundaries.
</shared_responsibility_boundaries>
<decision_logic>
STRICTLY follow decision logic:
Set stop = TRUE ONLY IF:
- **All** threat sources in <data_flow> have realistic, actionable threat coverage
- **All** critical assets/entities have appropriate STRIDE category coverage (excluding those made irrelevant by assumptions)
- **No** exploitable, customer-addressable, realistic gaps remain
- **All** existing threats comply with all assumptions and boundaries
- **All** coverage is quality-checked as described
If even ONE of these is not met, set stop = FALSE and list ONLY those valid, actionable, customer-controlled, realistic gaps.
At each judgment point, re-check if new gaps are truly material and not already covered, and whether previous gaps now count as closed.
When stop = TRUE, output: "Threat catalog is comprehensive within defined boundaries [and assumptions, if provided]. No actionable gaps identified. Coverage includes realistic threats within customer control."
When stop = FALSE, output detailed gap analysis ONLY covering high-quality gaps per above, and state why coverage is incomplete.
</decision_logic>
<output_requirements>
ALWAYS state explicitly:
- Whether assumptions were respected
- Whether gaps are within customer control
- That all reported gaps are realistic and actionable
- Number of valid gaps after filtering
For EACH gap, document:
- Pre-validation for assumptions (if any)
- STRIDE category
- Affected assets/flows
- Exploiting threat source (from <data_flow>)
- Practical attack path
- Business impact
IMPROVEMENT: Track previous gaps: mark as closed or persistent, explaining why.
<final_checklist>
Before submitting, review:
 - Every gap is realistic, exploitable, and customer-addressable
 - All gaps respect system assumptions
 - All gaps trace to valid threat sources
 - No duplicate/contradictory/immaterial gaps
If any check fails, remove the gap.
</final_checklist>
FOCUS: Quality over quantity. Once all true, actionable gaps (within customer boundaries) are identified and documented, you MUST set stop=TRUE. Do not continue identifying trivial, theoretical, duplicate, or already-covered issues.
      `,n=`
<important_instructions>
         ${t}
         </important_instructions>
      `;return t?[{type:"text",text:n+e}]:[{type:"text",text:e}]}function Ru(t=null){const e=`
You are an expert threat modeling specialist tasked with enriching an existing threat catalog using STRIDE methodology. You will identify new, actionable, and realistic threats that respect all provided constraints.

<critical_instructions>
BEFORE generating any threat, you MUST:
1. If <assumptions> are provided: Verify it doesn't violate any assumption
2. Verify the threat actor exists in <data_flow> threat_sources
3. Confirm it's not a duplicate of existing threats
4. Ensure it's within customer control boundary
5. Validate the threat is realistic and plausible

If a potential threat fails ANY of these checks, DO NOT include it.
</critical_instructions>

<assumption_enforcement>
**WHEN ASSUMPTIONS ARE PROVIDED:**
Assumptions define what is already secure or out of scope. These are non-negotiable constraints:
- If an assumption states "X is trusted", DO NOT generate threats about X being compromised
- If an assumption states "Y is already implemented", DO NOT suggest Y as a mitigation
- If an assumption defines a security boundary, RESPECT it completely
- Assumptions override all other considerations

**WHEN NO ASSUMPTIONS ARE PROVIDED:**
Use reasonable security baselines for the given context:
- Assume standard security best practices are NOT necessarily in place
- Consider common misconfigurations and oversights
- Focus on threats the customer can realistically address

WHY THIS MATTERS: When provided, assumptions reflect security decisions already made by the system owner. Violating them wastes time and undermines credibility.
</assumption_enforcement>

<threat_realism_guidance>
Every threat must be REALISTIC and PLAUSIBLE. Apply these filters:

**Generate threats that:**
- Have documented real-world precedent or clear attack paths
- Can be executed with reasonable attacker resources/skill
- Target common vulnerabilities or misconfigurations
- Have logical cause-and-effect relationships
- Are relevant to the specific system architecture

**Avoid threats that:**
- Require nation-state resources for low-value targets
- Depend on multiple highly unlikely events occurring simultaneously
- Assume attackers have unrealistic capabilities (e.g., "break AES-256 encryption")
- Are purely theoretical without practical attack vectors
- Ignore basic economics of attacks (effort vs. reward)

**Reality Check Questions:**
- Has this type of attack happened before in similar systems?
- Would a rational attacker invest resources in this approach?
- Is the attack technically feasible with current knowledge/tools?
- Does the attack path make practical sense?
</threat_realism_guidance>

<threat_generation_process>
For EACH potential threat, follow this exact sequence:

**1. Assumption Check (Conditional)**
   - IF assumptions exist: Ask "Does this threat contradict any assumption?"
     - If YES → Skip this threat entirely
     - If NO → Continue to step 2
   - IF no assumptions provided: Continue to step 2

**2. Realism Validation**
   - Ask: "Is this threat plausible and realistic?"
   - Review against <threat_realism_guidance>
   - If NO → Skip this threat entirely
   - If YES → Continue to step 3

**3. Source Validation**
   - Find the exact threat source in <data_flow> threat_sources
   - Ask: "Is this actor explicitly listed?"
   - If NO → Skip this threat entirely
   - If YES → Continue to step 4

**4. Duplication Check**
   - Compare against ALL existing threats
   - Ask: "Is this meaningfully different?"
   - If NO → Skip this threat entirely
   - If YES → Continue to step 5

**5. Control Boundary Check**
   - Identify who can mitigate this threat
   - Ask: "Can the customer control this?"
   - If NO → Skip this threat entirely
   - If YES → Continue to step 6

**6. Gap Relevance Check**
   - Review the <gap> analysis (if provided)
   - Ask: "Does this address an identified gap?"
   - If NO → Consider if it's still valuable
   - If YES → Proceed to format the threat

Only after passing ALL checks should you include the threat.
</threat_generation_process>

<shared_responsibility_boundaries>
You MUST respect these service model boundaries:

- **IaaS**: Customer controls from OS up; exclude hypervisor/hardware threats
- **PaaS**: Customer controls application and data; exclude platform runtime threats
- **SaaS**: Customer controls configuration and data; exclude application code threats

Never suggest the customer can mitigate provider-level vulnerabilities. Focus on:
- Misconfigurations the customer can fix
- Weak customer-controlled security settings
- Missing customer-implementable controls
- Insecure customer usage patterns
</shared_responsibility_boundaries>

<threat_format_template>
Structure each threat EXACTLY as:
"[Actor from data_flow] can [specific action] by [concrete method], causing [measurable impact] to [identified asset]"

Include:
- **Realism Justification**: "This threat is realistic because [real-world examples/feasible attack path]"
- **Assumption Compliance** (if assumptions provided): "This threat respects assumption X because..."
- **Gap Addressed** (if gap analysis provided): "This fills the gap in [specific area]"
- **Not a Duplicate Because**: "Unlike existing threat Y, this focuses on..."
- **Customer Control**: "The customer can mitigate this by..."
</threat_format_template>

<quality_validation>
Before finalizing your threat list:
1. **Realism check** - Are all threats practically feasible?
2. **Assumption compliance** (if provided) - Does any threat violate them?
3. **Source accuracy** - Do all match <data_flow> exactly?
4. **Duplication check** - Are threats genuinely distinct?
5. **Customer control** - Can they actually implement the mitigations?
6. **Gap coverage** (if provided) - Are you addressing identified weaknesses?

If you find any issues during validation, REMOVE those threats rather than trying to justify them.
</quality_validation>

<examples_of_realistic_threats>
**Example 1: Realistic**
✓ "Attacker can exploit default admin credentials on publicly exposed admin panel, causing unauthorized access to customer data"
- Real-world precedent: Common in breach reports
- Feasible: Requires basic scanning and credential stuffing
- Practical: Attackers routinely scan for default credentials

**Example 2: Unrealistic**
✗ "Attacker can break TLS 1.3 encryption through cryptographic breakthrough, exposing all transmitted data"
- No real-world precedent for TLS 1.3 breaks
- Requires theoretical breakthrough in mathematics
- Impractical: Nation-state level resources for minimal gain

**Example 3: Realistic with Context**
✓ "Insider with legitimate access can exfiltrate database backups through approved cloud storage sync tool, bypassing DLP controls"
- Real-world precedent: Common insider threat vector
- Feasible: Uses legitimate tools and access
- Practical: Clear attack path with available tools
</examples_of_realistic_threats>

<examples_of_assumption_respect>
**Example 1: If assumption states "Internal network is trusted"**
- WRONG: "Internal attacker can intercept traffic"
- RIGHT: "External attacker can exploit misconfigured firewall rules"

**Example 2: If assumption states "MFA is implemented for all users"**
- WRONG: "Attacker can bypass authentication without MFA"
- RIGHT: "Attacker can exploit MFA fatigue through repeated push notifications"

**Example 3: If assumption states "Cloud provider security is out of scope"**
- WRONG: "AWS S3 service could be compromised"
- RIGHT: "Misconfigured S3 bucket permissions could expose data"

**Example 4: If NO assumptions are provided**
- ACCEPTABLE: "Attacker can gain access through weak password policy, causing account compromise"
- ACCEPTABLE: "Internal user can access data without MFA, allowing unauthorized access after credential theft"
</examples_of_assumption_respect>

<output_requirements>
Generate high-quality threats that:
- Pass ALL validation checks (including realism)
- Address identified gaps (if gap analysis provided)
- Respect ALL assumptions without exception (if assumptions provided)
- Use only threat actors from data_flow
- Are realistic and practically feasible
- Provide actionable, customer-implementable mitigations
- Add genuine value beyond existing threats
- Set Starred to False

**Quality over quantity**: It's better to provide excellent, realistic, compliant threats rather than many that violate boundaries or strain credibility.
</output_requirements>
   `,n=`
<important_instructions>
         ${t}
         </important_instructions>
      `;return t?[{type:"text",text:n+e}]:[{type:"text",text:e}]}function OB(t=null){return Ru(t)}const Tn={START:"START",ASSETS:"ASSETS",FLOW:"FLOW",THREAT:"THREAT",THREAT_RETRY:"THREAT_RETRY",FINALIZE:"FINALIZE",COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"},bl=0,uA=1,$B=15;function ir(t,e){var n;if((n=t==null?void 0:t.signal)!=null&&n.aborted){console.log(`Workflow aborted, skipping ${e}`);const r=new Error("AbortError");throw r.name="AbortError",r}}function Ut(t){const e=de.getJobStatus(t);return(e==null?void 0:e.state)===Tn.CANCELLED}function pd(t){if(t.content&&Array.isArray(t.content)&&t.content.length>0){const e=t.content[0];if(e&&typeof e=="object"){const n=e.reasoning_content;if(n&&n.text)return n.text}}if(t.additional_kwargs){const e=t.additional_kwargs.reasoning_content;if(e)return typeof e=="string"?e:e.text||null}return null}async function NB(t,e){var r;if(console.log("Node: generateSummary"),ir(e,"generateSummary"),t.summary)return console.log("Summary already exists, skipping generation"),{image_data:t.image_data};const n=t.job_id||"unknown";try{if(Ut(n)){console.log(`Job ${n} was cancelled, aborting generateSummary`);const f=new Error("AbortError");throw f.name="AbortError",f}const i=new wc(t.image_data,t.description||"",bc(t.assumptions||[])).createSummaryMessage(40),o=[new vt({content:kB()}),i],c=(r=e.configurable)==null?void 0:r.model_summary;if(!c){const f=new Error("Summary model not found in config");throw console.error("Configuration error:",f.message),f}const u=Ma(async f=>f,{name:"summary_state",description:"Generate a summary of the architecture",schema:hB}),l=c.bindTools([u]);console.log(`Invoking summary model for job ${n}`);const d=await l.invoke(o);if(ir(e,"generateSummary (after model invocation)"),Ut(n)){console.log(`Job ${n} was cancelled during model invocation`);const f=new Error("AbortError");throw f.name="AbortError",f}const h=d.tool_calls[0].args;return console.log(`Summary generated successfully for job ${n}`),{image_data:t.image_data,summary:h.summary}}catch(s){if(s.name==="AbortError"||s.message==="AbortError")console.log(`generateSummary aborted for job ${n}`);else if(console.error(`Error in generateSummary for job ${n}:`,s),console.error("Error details:",{name:s.name,message:s.message}),!Ut(n))try{de.setJobStatus(n,Tn.FAILED,t.retry||0)}catch(a){console.error(`Failed to update job status for ${n}:`,a)}throw s}}async function PB(t,e){var r,s;console.log("Node: defineAssets"),ir(e,"defineAssets");const n=t.job_id||"unknown";try{if(Ut(n)){console.log(`Job ${n} was cancelled, aborting defineAssets`);const y=new Error("AbortError");throw y.name="AbortError",y}de.setJobStatus(n,Tn.ASSETS,t.retry||0);const a=new wc(t.image_data,t.description||"",bc(t.assumptions||[])).createAssetMessage(),c=[new vt({content:IB()}),a],u=(r=e.configurable)==null?void 0:r.model_assets;if(!u){const y=new Error("Assets model not found in config");throw console.error("Configuration error:",y.message),y}const l=((s=e.configurable)==null?void 0:s.reasoning)||0,d=Ma(async y=>y,{name:"assets_list",description:"Define the list of system assets",schema:pB}),h=u.model||"",f=h.startsWith("gpt-")||h.startsWith("o1-"),m=h.includes("sonnet");let g;f?g=u.bindTools([d],{tool_choice:"assets_list"}):m?l>0?g=u.bindTools([d]):g=u.bindTools([d],{tool_choice:"any"}):g=u.bindTools([d]),console.log(`Invoking assets model for job ${n}`);const _=await g.invoke(c);if(ir(e,"defineAssets (after model invocation)"),Ut(n)){console.log(`Job ${n} was cancelled during model invocation`);const y=new Error("AbortError");throw y.name="AbortError",y}const b=_.tool_calls[0].args;if(l>0){const y=pd(_);y&&de.updateJobTrail(n,{assets:y})}return console.log(`Assets defined successfully for job ${n}`),{assets:b}}catch(i){if(i.name==="AbortError"||i.message==="AbortError")console.log(`defineAssets aborted for job ${n}`);else if(console.error(`Error in defineAssets for job ${n}:`,i),console.error("Error details:",{name:i.name,message:i.message}),!Ut(n))try{de.setJobStatus(n,Tn.FAILED,t.retry||0)}catch(o){console.error(`Failed to update job status for ${n}:`,o)}throw i}}async function LB(t,e){var r,s;console.log("Node: defineFlows"),ir(e,"defineFlows");const n=t.job_id||"unknown";try{if(Ut(n)){console.log(`Job ${n} was cancelled, aborting defineFlows`);const y=new Error("AbortError");throw y.name="AbortError",y}de.setJobStatus(n,Tn.FLOW,t.retry||0);const a=new wc(t.image_data,t.description||"",bc(t.assumptions||[])).createSystemFlowsMessage(t.assets),c=[new vt({content:RB()}),a],u=(r=e.configurable)==null?void 0:r.model_flows;if(!u){const y=new Error("Flows model not found in config");throw console.error("Configuration error:",y.message),y}const l=((s=e.configurable)==null?void 0:s.reasoning)||0,d=Ma(async y=>y,{name:"flows_list",description:"Define data flows, trust boundaries, and threat sources",schema:_B}),h=u.model||"",f=h.startsWith("gpt-")||h.startsWith("o1-"),m=h.includes("sonnet");let g;f?g=u.bindTools([d],{tool_choice:"flows_list"}):m?l>0?g=u.bindTools([d]):g=u.bindTools([d],{tool_choice:"any"}):g=u.bindTools([d]),console.log(`Invoking flows model for job ${n}`);const _=await g.invoke(c);if(ir(e,"defineFlows (after model invocation)"),Ut(n)){console.log(`Job ${n} was cancelled during model invocation`);const y=new Error("AbortError");throw y.name="AbortError",y}const b=_.tool_calls[0].args;if(l>0){const y=pd(_);y&&de.updateJobTrail(n,{flows:y})}return console.log(`Flows defined successfully for job ${n}`),{system_architecture:b}}catch(i){if(i.name==="AbortError"||i.message==="AbortError")console.log(`defineFlows aborted for job ${n}`);else if(console.error(`Error in defineFlows for job ${n}:`,i),console.error("Error details:",{name:i.name,message:i.message}),!Ut(n))try{de.setJobStatus(n,Tn.FAILED,t.retry||0)}catch(o){console.error(`Failed to update job status for ${n}:`,o)}throw i}}async function MB(t,e){var a,o,c;console.log("Node: defineThreats"),ir(e,"defineThreats");const n=t.job_id||"unknown",r=parseInt(t.retry||0),s=parseInt(t.iteration||0),i=((a=e.configurable)==null?void 0:a.max_retry)||$B;try{if(Ut(n)){console.log(`Job ${n} was cancelled, aborting defineThreats`);const me=new Error("AbortError");throw me.name="AbortError",me}const u=r>=i,l=r>=s&&s!==0;if(u||l)return console.log(`Iteration limit reached for job ${n} (retry: ${r}, iteration: ${s}, max: ${i})`),de.setJobStatus(n,Tn.FINALIZE,r),new dn({goto:"finalize"});const d=r+1;r>0?de.setJobStatus(n,Tn.THREAT_RETRY,d):de.setJobStatus(n,Tn.THREAT,d);const h=t.gap||[],f=t.threat_list,m=(f==null?void 0:f.threats)||[],g=new wc(t.image_data,t.description||"",bc(t.assumptions||[]));let _,b;r>0||m.length>0?(_=g.createThreatImproveMessage(t.assets,t.system_architecture,t.threat_list,h),t.replay&&t.instructions?b=new vt({content:Ru(t.instructions)}):b=new vt({content:Ru()})):(_=g.createThreatMessage(t.assets,t.system_architecture),t.replay&&t.instructions?b=new vt({content:OB(t.instructions)}):b=new vt({content:Ru()}));const y=[b,_],E=(o=e.configurable)==null?void 0:o.model_threats;if(!E)throw new Error("Threats model not found in config");const C=((c=e.configurable)==null?void 0:c.reasoning)||0,k=Ma(async me=>me,{name:"threats_list",description:"Define the list of security threats",schema:bB}),R=E.model||"",$=R.startsWith("gpt-")||R.startsWith("o1-"),T=R.includes("sonnet");let B;$?B=E.bindTools([k],{tool_choice:"threats_list"}):T?C>0?B=E.bindTools([k]):B=E.bindTools([k],{tool_choice:"any"}):B=E.bindTools([k]),console.log(`Invoking threats model for job ${n} (iteration ${r+1})`);const z=await B.invoke(y);if(ir(e,"defineThreats (after model invocation)"),Ut(n)){console.log(`Job ${n} was cancelled during model invocation`);const me=new Error("AbortError");throw me.name="AbortError",me}const q=z.tool_calls[0].args;if(C>0){const me=pd(z);me&&((r===0?bl:uA)===bl?de.updateJobTrail(n,{threats:[me]}):de.updateJobTrail(n,{threats:me}))}const ie=r+1;return s===0?(console.log(`Job ${n}: Auto mode (iteration 0), routing to gap analysis`),new dn({goto:"gap_analysis",update:{threat_list:q,retry:ie}})):(console.log(`Job ${n}: Fixed iteration mode, looping back to threats`),new dn({goto:"define_threats",update:{threat_list:q,retry:ie}}))}catch(u){if(u.name==="AbortError"||u.message==="AbortError")console.log(`defineThreats aborted for job ${n}`);else if(console.error(`Error in defineThreats for job ${n}:`,u),console.error("Error details:",{name:u.name,message:u.message}),!Ut(n))try{de.setJobStatus(n,Tn.FAILED,t.retry||0)}catch(d){console.error(`Failed to update job status for ${n}:`,d)}throw u}}async function DB(t,e){var r,s;console.log("Node: gapAnalysis"),ir(e,"gapAnalysis");const n=t.job_id||"unknown";try{if(Ut(n)){console.log(`Job ${n} was cancelled, aborting gapAnalysis`);const y=new Error("AbortError");throw y.name="AbortError",y}const a=new wc(t.image_data,t.description||"",bc(t.assumptions||[])).createGapAnalysisMessage(t.assets,t.system_architecture,t.threat_list||"",t.gap||[]);let o;t.replay&&t.instructions?o=new vt({content:Nb(t.instructions)}):o=new vt({content:Nb()});const c=[o,a],u=(r=e.configurable)==null?void 0:r.model_gaps;if(!u){const y=new Error("Gaps model not found in config");throw console.error("Configuration error:",y.message),y}const l=((s=e.configurable)==null?void 0:s.reasoning)||0,d=Ma(async y=>y,{name:"continue_threat_modeling",description:"Analyze gaps and decide whether to continue threat modeling",schema:vB}),h=u.model||"",f=h.startsWith("gpt-")||h.startsWith("o1-"),m=h.includes("sonnet");let g;f?g=u.bindTools([d],{tool_choice:"continue_threat_modeling"}):m?l>0?g=u.bindTools([d]):g=u.bindTools([d],{tool_choice:"any"}):g=u.bindTools([d]),console.log(`Invoking gap analysis model for job ${n}`);const _=await g.invoke(c);if(ir(e,"gapAnalysis (after model invocation)"),Ut(n)){console.log(`Job ${n} was cancelled during model invocation`);const y=new Error("AbortError");throw y.name="AbortError",y}const b=_.tool_calls[0].args;if(l>0){const y=pd(_);y&&((parseInt(t.retry||0)===0?bl:uA)===bl?de.updateJobTrail(n,{gaps:[y]}):de.updateJobTrail(n,{gaps:y}))}return b.stop?(console.log(`Job ${n}: Gap analysis determined to stop, routing to finalize`),new dn({goto:"finalize"})):(console.log(`Job ${n}: Gap analysis determined to continue, routing to define_threats`),new dn({goto:"define_threats",update:{gap:[b.gap]}}))}catch(i){if(i.name==="AbortError"||i.message==="AbortError")console.log(`gapAnalysis aborted for job ${n}`);else if(console.error(`Error in gapAnalysis for job ${n}:`,i),console.error("Error details:",{name:i.name,message:i.message}),!Ut(n))try{de.setJobStatus(n,Tn.FAILED,t.retry||0)}catch(o){console.error(`Failed to update job status for ${n}:`,o)}throw i}}async function UB(t,e){console.log("Node: finalize"),ir(e,"finalize");const n=t.job_id||"unknown";try{if(Ut(n)){console.log(`Job ${n} was cancelled before finalization, aborting`);const i=new Error("AbortError");throw i.name="AbortError",i}const r=parseInt(t.retry||0);console.log(`Finalizing job ${n} with ${r} completed iterations`),de.setJobStatus(n,Tn.FINALIZE,r);const s={job_id:n,s3_location:t.s3_location||"",owner:t.owner||"LIGHTNING_USER",title:t.title||"",summary:t.summary||"",description:t.description||"",assumptions:t.assumptions||[],assets:t.assets||null,system_architecture:t.system_architecture||null,threat_list:t.threat_list||null,retry:r,backup:null,completed_at:new Date().toISOString()};if(de.setJobResults(n,s),await new Promise(i=>setTimeout(i,1e3)),ir(e,"finalize (before completion)"),Ut(n)){console.log(`Job ${n} was cancelled during finalization delay`);const i=new Error("AbortError");throw i.name="AbortError",i}return de.setJobStatus(n,Tn.COMPLETE,r),console.log(`Job ${n} completed successfully`),{}}catch(r){if(r.name==="AbortError"||r.message==="AbortError")console.log(`finalize aborted for job ${n} - job was cancelled`);else if(console.error(`Error in finalize for job ${n}:`,r),console.error("Error details:",{name:r.name,message:r.message}),!Ut(n))try{de.setJobStatus(n,Tn.FAILED,t.retry||0);const i=de.getJobResults(n)||{};de.setJobResults(n,{...i,error:r.message||"Finalization failed",error_type:r.name||"Error",failed_at:new Date().toISOString()})}catch(i){console.error(`Failed to update job status for ${n}:`,i)}throw r}}function BB(t){if(console.log("Routing: routeReplay"),!t.replay)return"full";const e=t.job_id||"unknown";try{de.updateJobTrail(e,{threats:[],gaps:[]});const n=de.getJobResults(e);if(n&&n.backup){const r={...n,assets:n.backup.assets,system_architecture:n.backup.system_architecture,threat_list:n.backup.threat_list};de.setJobResults(e,r)}return"replay"}catch(n){return console.error("Error in routeReplay:",n),"full"}}function jB(){console.log("Creating threat modeling workflow...");const t=new KU(xB);return t.addNode("generate_summary",NB),t.addNode("define_assets",PB),t.addNode("define_flows",LB),t.addNode("finalize",UB),t.addNode("define_threats",MB,{ends:["gap_analysis","define_threats","finalize"]}),t.addNode("gap_analysis",DB,{ends:["define_threats","finalize"]}),t.addEdge(Qe,"generate_summary"),t.addConditionalEdges("generate_summary",BB,{replay:"define_threats",full:"define_assets"}),t.addEdge("define_assets","define_flows"),t.addEdge("define_flows","define_threats"),t.addEdge("finalize",Fe),console.log("Workflow compiled successfully"),t.compile()}function FB(t){return!!(typeof t=="object"&&t&&"toolSpec"in t)}function Pb(t){if(t.every(od))return t.map(e=>({toolSpec:{name:e.function.name,description:e.function.description,inputSchema:{json:e.function.parameters}}}));if(t.every(_c))return t.map(e=>({toolSpec:{name:e.name,description:e.description,inputSchema:{json:tr(e.schema)?nn(e.schema):e.schema}}}));if(t.every(FB))return t;throw new Error("Invalid tools passed. Must be an array of StructuredToolInterface, ToolDefinition, or BedrockTool.")}function zB(t,e,n){const r=n.supportsToolChoiceValues??[];let s;if(typeof t=="string")switch(t){case"any":s={any:{}};break;case"auto":s={auto:{}};break;default:{if(!e.find(o=>{var c;return((c=o.toolSpec)==null?void 0:c.name)===t}))throw new Error(`Tool with name ${t} not found in tools list.`);s={tool:{name:t}}}}else s=t;const i=Object.keys(s)[0];if(!r.includes(i)){let a="";throw r.length?a=`Model ${n.model} does not currently support 'tool_choice' of type ${i}. The following 'tool_choice' types are supported: ${r.join(", ")}.`:a=`Model ${n.model} does not currently support 'tool_choice'.`,new Error(`${a} Please seehttps://docs.aws.amazon.com/bedrock/latest/APIReference/API_runtime_ToolChoice.htmlfor the latest documentation on models that support tool choice.`)}return s}function VB(t){if(t.includes("claude-3")||t.includes("claude-4")||t.includes("claude-opus-4")||t.includes("claude-sonnet-4"))return["auto","any","tool"];if(t.includes("mistral-large"))return["auto","any"]}const xf={document(t){switch(t){case"text/csv":return"csv";case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":return"docx";case"text/html":return"html";case"text/markdown":return"md";case"application/pdf":return"pdf";case"text/plain":return"txt";case"application/vnd.ms-excel":return"xls";case"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":return"xlsx";default:return t}},image(t){switch(t){case"image/gif":return"gif";case"image/jpeg":return"jpeg";case"image/png":return"png";case"image/webp":return"webp";default:return t}},video(t){switch(t){case"video/flv":return"flv";case"video/mkv":return"mkv";case"video/mov":return"mov";case"video/mp4":return"mp4";case"video/mpeg":return"mpeg";case"video/mpg":return"mpg";case"video/three_gp":return"three_gp";case"video/webm":return"webm";case"video/wmv":return"wmv";default:return t}}};function qB(t){return{sourceContent:[{text:typeof t.citedText=="string"?t.citedText:""}],location:{documentChunk:{documentIndex:typeof t.source=="string"?Number(t.source):void 0,start:typeof t.startIndex=="number"?t.startIndex:void 0,end:typeof t.endIndex=="number"?t.endIndex:void 0}}}}function HB(t){var r;const e=(r=t.response_metadata)==null?void 0:r.model_provider;function*n(){var s;for(const i of t.contentBlocks)if(i.type==="text")(s=i.annotations)!=null&&s.length?yield{citationsContent:{content:[{text:i.text}],citations:i.annotations.map(qB)}}:yield{text:i.text};else{if(i.type==="audio")continue;if(i.type==="code_interpreter_call")continue;if(i.type==="code_interpreter_result")continue;if(i.type==="file"){const a=xf.document(i.mimeType??"");if(i.data){const o=typeof i.data=="string"?Uint8Array.from(Kt.from(i.data,"base64")):i.data;yield{document:{name:i.id,format:a,source:{bytes:o}}}}else i.fileId&&i.fileId.startsWith("s3://")&&(yield{document:{name:i.id,format:a,source:{s3Location:{uri:i.fileId}}}})}else if(i.type==="image"){const a=xf.image(i.mimeType??"");if(i.data){const o=typeof i.data=="string"?Uint8Array.from(Kt.from(i.data,"base64")):i.data;yield{image:{format:a,source:{bytes:o}}}}else i.fileId&&i.fileId.startsWith("s3://")&&(yield{image:{format:a,source:{s3Location:{uri:i.fileId}}}})}else{if(i.type==="invalid_tool_call")continue;if(i.type==="reasoning")yield{reasoningContent:{reasoningText:{text:i.reasoning}}};else{if(i.type==="server_tool_call")continue;if(i.type==="server_tool_call_chunk")continue;if(i.type==="server_tool_call_result")continue;if(i.type==="text-plain")continue;if(i.type==="tool_call")yield{toolUse:{toolUseId:i.id,name:i.name,input:i.args}};else{if(i.type==="tool_call_chunk")continue;if(i.type==="video"){const a=xf.video(i.mimeType??"");if(i.data){const o=typeof i.data=="string"?Uint8Array.from(Kt.from(i.data,"base64")):i.data;yield{video:{format:a,source:{bytes:o}}}}else i.fileId&&i.fileId.startsWith("s3://")&&(yield{video:{format:a,source:{s3Location:{uri:i.fileId}}}})}else{if(i.type==="web_search_call")continue;if(i.type==="web_search_result")continue;i.type==="non_standard"&&e==="bedrock-converse"&&(yield i)}}}}}}return Array.from(n())}function qg(t){return!!(typeof t=="object"&&t!==null&&"cachePoint"in t&&t.cachePoint&&typeof t.cachePoint=="object"&&t.cachePoint!==null&&"type"in t.cachePoint&&t.cachePoint.type==="default")}function GB(t){const e=t.match(/^data:image\/(\w+);base64,/);let n;if(e){const a=e[1].toLowerCase();["gif","jpeg","png","webp"].includes(a)&&(n=a)}const r=t.replace(/^data:image\/\w+;base64,/,""),s=atob(r),i=new Uint8Array(s.length);for(let a=0;a<s.length;a+=1)i[a]=s.charCodeAt(a);return{image:{format:n,source:{bytes:i}}}}const WB={providerName:"ChatBedrockConverse",fromStandardTextBlock(t){return{text:t.text}},fromStandardImageBlock(t){let e;if(t.source_type==="url"){const n=vi({dataUrl:t.url,asTypedArray:!0});if(n)return e=ci(n.mime_type).type,{image:{format:e,source:{bytes:n.data}}};throw new Error("Only base64 data URLs are supported for image blocks with source type 'url' with ChatBedrockConverse.")}else if(t.source_type==="base64"){if(t.mime_type&&(e=ci(t.mime_type).subtype),e&&!["gif","jpeg","png","webp"].includes(e))throw new Error(`Unsupported image mime type: "${t.mime_type}" ChatBedrockConverse only supports "image/gif", "image/jpeg", "image/png", and "image/webp" formats.`);return{image:{format:e,source:{bytes:Uint8Array.from(atob(t.data),n=>n.charCodeAt(0))}}}}else throw t.source_type==="id"?new Error("Image source type 'id' not supported with ChatBedrockConverse."):new Error(`Unsupported image source type: "${t.source_type}" with ChatBedrockConverse.`)},fromStandardFileBlock(t){var r,s,i;const e={"text/csv":"csv","application/msword":"doc","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","text/html":"html","text/markdown":"md","application/pdf":"pdf","text/plain":"txt","application/vnd.ms-excel":"xls","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx"},n=((r=t.metadata)==null?void 0:r.name)??((s=t.metadata)==null?void 0:s.filename)??((i=t.metadata)==null?void 0:i.title);if(t.source_type==="text")return{document:{name:n,format:"txt",source:{bytes:new TextEncoder().encode(t.text)}}};if(t.source_type==="url"){const a=vi({dataUrl:t.url,asTypedArray:!0});if(a){const o=ci(a.mime_type??t.mime_type),c=`${o.type}/${o.subtype}`,u=e[c];return{document:{name:n,format:u,source:{bytes:a.data}}}}throw new Error("Only base64 data URLs are supported for file blocks with source type 'url' with ChatBedrockConverse.")}if(t.source_type==="base64"){let a;if(t.mime_type){const o=ci(t.mime_type),c=`${o.type}/${o.subtype}`;if(a=e[c],a===void 0)throw new Error(`Unsupported file mime type: "${t.mime_type}" ChatBedrockConverse only supports ${Object.keys(e).join(", ")} formats.`)}return{document:{name:n,format:a,source:{bytes:Uint8Array.from(atob(t.data),o=>o.charCodeAt(0))}}}}throw t.source_type==="id"?new Error("File source type 'id' not supported with ChatBedrockConverse."):new Error(`Unsupported file source type: "${t.source_type}" with ChatBedrockConverse.`)}};function lA({block:t,onUnknown:e="throw"}){if(typeof t=="string")return{text:t};if(vr(t))return Hl(t,WB);if(t.type==="text")return{text:t.text};if(t.type==="image_url")return GB(typeof t.image_url=="string"?t.image_url:t.image_url.url);if(t.type==="document"&&t.document!==void 0)return{document:t.document};if(t.type==="image"&&t.image!==void 0)return{image:t.image};if(qg(t))return{cachePoint:{type:"default"}};if(e==="throw")throw new Error(`Unsupported content block type: ${t.type}`);return t}function JB(t){if(typeof t.content=="string")return[{text:t.content}];if(Array.isArray(t.content)&&t.content.length>0){const e=[];for(const n of t.content)if(n.type==="text"&&typeof n.text=="string")e.push({text:n.text});else if(qg(n))e.push({cachePoint:{type:"default"}});else break;if(t.content.length===e.length)return e}throw new Error("System message content must be either a string, or an array of text blocks, optionally including a cache point.")}function ZB(t){var n;if(t.response_metadata.response_format==="v1")return{role:"assistant",content:HB(t)};const e={role:"assistant",content:[]};if(typeof t.content=="string"&&t.content!=="")(n=e.content)==null||n.push({text:t.content});else if(Array.isArray(t.content)){const r=QB(t.content),s=[];r.forEach(i=>{var a;if(i.type==="text"&&i.text!=="")if(((a=i.text)==null?void 0:a.replace(/\n/g,"").trim())===""){if(s.length>0){const c=`${s[s.length-1].text}${i.text}`;s[s.length-1].text=c}}else s.push({text:i.text});else if(i.type==="reasoning_content")s.push({reasoningContent:YB(i)});else if(qg(i))s.push({cachePoint:{type:"default"}});else{const o=Object.fromEntries(Object.entries(i).filter(([c])=>c!=="type"));throw new Error(`Unsupported content block type: ${i.type} with content of ${JSON.stringify(o,null,2)}`)}}),e.content=[...e.content?e.content:[],...s]}return t.tool_calls&&t.tool_calls.length&&(e.content=[...e.content?e.content:[],...t.tool_calls.map(r=>({toolUse:{toolUseId:r.id,name:r.name,input:r.args}}))]),e}function KB(t){if(t.content==="")throw new Error(`Invalid message content: empty string. '${t.type}' must contain non-empty content.`);return{role:"user",content:(Array.isArray(t.content)?t.content:[t.content]).map(r=>lA({block:r,onUnknown:"throw"}))}}function XB(t){const e=t;return typeof e.content=="string"?{role:"user",content:[{toolResult:{toolUseId:e.tool_call_id,content:[{text:e.content}]}}]}:{role:"user",content:[{toolResult:{toolUseId:e.tool_call_id,content:t.content.map(n=>{const r=lA({block:n,onUnknown:"returnUnmodified"});return r!==n?r:{json:n}})}}]}}function Lb(t){const e=t.reduce((s,i)=>(vt.isInstance(i)&&s.push(...JB(i)),s),[]);return{converseMessages:t.filter(s=>!vt.isInstance(s)).map(s=>{if(ht.isInstance(s))return ZB(s);if(It.isInstance(s)||Zr.isInstance(s))return KB(s);if(Hr.isInstance(s))return XB(s);throw new Error(`Unsupported message type: ${s.type}`)}).reduce((s,i)=>{var o,c;const a=s[s.length-1];return a&&a.role==="user"&&((o=a.content)!=null&&o.some(u=>"toolResult"in u))&&i.role==="user"&&((c=i.content)!=null&&c.some(u=>"toolResult"in u))?a.content=a.content.concat(i.content):s.push(i),s},[]),converseSystem:e}}function YB(t){if(t.type!=="reasoning_content")throw new Error("Invalid reasoning content");if("reasoningText"in t)return{reasoningText:t.reasoningText};if("redactedContent"in t)return{redactedContent:Kt.from(t.redactedContent,"base64")};throw new Error("Invalid reasoning content")}function QB(t){const e=[];let n={};for(const r of t){if(r.type!=="reasoning_content"){Object.keys(n).length>0&&(e.push(n),n={}),e.push(r);continue}if("reasoningText"in r&&typeof r.reasoningText=="object"){"redactedContent"in n&&(e.push(n),n={});const{text:s,signature:i}=r.reasoningText,{text:a,signature:o}="reasoningText"in n?n.reasoningText:{};n={type:"reasoning_content",reasoningText:{...n.reasoningText??{},...a!==void 0||s!==void 0?{text:(a??"")+(s??"")}:{},...o!==void 0||i!==void 0?{signature:(o??"")+(i??"")}:{}}},"signature"in r.reasoningText&&(e.push(n),n={})}if("redactedContent"in r){"reasoningText"in n&&(e.push(n),n={});const{redactedContent:s}=r;n={type:"reasoning_content",redactedContent:("redactedContent"in n?n.redactedContent:"")+s}}}return Object.keys(n).length>0&&e.push(n),e}function ej(t,e){var s;if(!t.content)throw new Error("No message content found in response.");if(t.role!=="assistant")throw new Error(`Unsupported message role received in ChatBedrockConverse response: ${t.role}`);let n;"$metadata"in e&&e.$metadata&&typeof e.$metadata=="object"&&"requestId"in e.$metadata&&(n=e.$metadata.requestId);let r;if(e.usage){const i=e.usage.inputTokens??0,a=e.usage.outputTokens??0;r={input_tokens:i,output_tokens:a,total_tokens:e.usage.totalTokens??i+a}}if(((s=t.content)==null?void 0:s.length)===1&&"text"in t.content[0]&&typeof t.content[0].text=="string")return new ht({content:t.content[0].text,response_metadata:{...e,model_provider:"bedrock-converse"},usage_metadata:r,id:n});{const i=[],a=[];return t.content.forEach(o=>{"cachePoint"in o?a.push({type:"cache_point",cachePoint:o.cachePoint}):"citationsContent"in o?a.push({type:"citations_content",citationsContent:o.citationsContent}):"document"in o?a.push({type:"document",document:o.document}):"guardContent"in o?a.push({type:"guard_content",guardContent:o.guardContent}):"image"in o?a.push({type:"image",image:o.image}):"reasoningContent"in o?a.push(ij(o.reasoningContent)):"text"in o&&typeof o.text=="string"?a.push({type:"text",text:o.text}):"toolResult"in o?a.push({type:"tool_result",toolResult:o.toolResult}):"toolUse"in o&&o.toolUse&&o.toolUse.name&&o.toolUse.input&&typeof o.toolUse.input=="object"?i.push({id:o.toolUse.toolUseId,name:o.toolUse.name,args:o.toolUse.input,type:"tool_call"}):"video"in o&&a.push({type:"video",video:o.video})}),new ht({content:a.length?a:"",tool_calls:i.length?i:void 0,response_metadata:{...e,model_provider:"bedrock-converse"},usage_metadata:r,id:n})}}function tj(t){if(!t.delta)throw new Error("No delta found in content block.");if(typeof t.delta.text=="string")return new fn({text:t.delta.text,message:new Et({content:t.delta.text})});if(t.delta.toolUse){const e=t.contentBlockIndex;return new fn({text:"",message:new Et({content:"",tool_call_chunks:[{args:t.delta.toolUse.input,index:e,type:"tool_call_chunk"}]})})}else{if(t.delta.reasoningContent)return new fn({text:"",message:new Et({content:[sj(t.delta.reasoningContent)]})});throw new Error(`Unsupported content block type(s): ${JSON.stringify(t.delta,null,2)}`)}}function nj(t){var n;const e=t.contentBlockIndex;if((n=t.start)!=null&&n.toolUse)return new fn({text:"",message:new Et({content:"",tool_call_chunks:[{name:t.start.toolUse.name,id:t.start.toolUse.toolUseId,index:e,type:"tool_call_chunk"}]})});throw new Error("Unsupported content block start event.")}function rj(t,e){var i,a,o;const n=((i=t.usage)==null?void 0:i.inputTokens)??0,r=((a=t.usage)==null?void 0:a.outputTokens)??0,s={input_tokens:n,output_tokens:r,total_tokens:((o=t.usage)==null?void 0:o.totalTokens)??n+r};return new fn({text:"",message:new Et({content:"",usage_metadata:e.streamUsage?s:void 0,response_metadata:{metadata:t,model_provider:"bedrock-converse"}})})}function sj(t){const{text:e,redactedContent:n,signature:r}=t;if(typeof e=="string")return{type:"reasoning_content",reasoningText:{text:e}};if(r)return{type:"reasoning_content",reasoningText:{signature:r}};if(n)return{type:"reasoning_content",redactedContent:Kt.from(n).toString("base64")};throw new Error("Invalid reasoning content")}function ij(t){const{reasoningText:e,redactedContent:n}=t;if(e)return{type:"reasoning_content",reasoningText:e};if(n)return{type:"reasoning_content",redactedContent:Kt.from(n).toString("base64")};throw new Error("Invalid reasoning content")}function aj(t){const e=t.signer,n=t.signer,r=Object.assign(t,{eventSigner:e,messageSigner:n}),s=r.eventStreamPayloadHandlerProvider(r);return Object.assign(r,{eventStreamPayloadHandler:s})}const oj=t=>({setHttpHandler(e){t.httpHandler=e},httpHandler(){return t.httpHandler},updateHttpClientConfig(e,n){var r;(r=t.httpHandler)==null||r.updateHttpClientConfig(e,n)},httpHandlerConfigs(){return t.httpHandler.httpHandlerConfigs()}}),cj=t=>({httpHandler:t.httpHandler()});var Go;(function(t){t.HTTP="http",t.HTTPS="https"})(Go||(Go={}));var vl;(function(t){t.MD5="md5",t.CRC32="crc32",t.CRC32C="crc32c",t.SHA1="sha1",t.SHA256="sha256"})(vl||(vl={}));const Zp="__smithy_context";class Rn{constructor(e){p(this,"method");p(this,"protocol");p(this,"hostname");p(this,"port");p(this,"path");p(this,"query");p(this,"headers");p(this,"username");p(this,"password");p(this,"fragment");p(this,"body");this.method=e.method||"GET",this.hostname=e.hostname||"localhost",this.port=e.port,this.query=e.query||{},this.headers=e.headers||{},this.body=e.body,this.protocol=e.protocol?e.protocol.slice(-1)!==":"?`${e.protocol}:`:e.protocol:"https:",this.path=e.path?e.path.charAt(0)!=="/"?`/${e.path}`:e.path:"/",this.username=e.username,this.password=e.password,this.fragment=e.fragment}static clone(e){const n=new Rn({...e,headers:{...e.headers}});return n.query&&(n.query=uj(n.query)),n}static isInstance(e){if(!e)return!1;const n=e;return"method"in n&&"protocol"in n&&"hostname"in n&&"path"in n&&typeof n.query=="object"&&typeof n.headers=="object"}clone(){return Rn.clone(this)}}function uj(t){return Object.keys(t).reduce((e,n)=>{const r=t[n];return{...e,[n]:Array.isArray(r)?[...r]:r}},{})}class Ca{constructor(e){p(this,"statusCode");p(this,"reason");p(this,"headers");p(this,"body");this.statusCode=e.statusCode,this.reason=e.reason,this.headers=e.headers||{},this.body=e.body}static isInstance(e){if(!e)return!1;const n=e;return typeof n.statusCode=="number"&&typeof n.headers=="object"}}const lj=t=>e=>async n=>{if(!Rn.isInstance(n.request))return e(n);const{request:r}=n,{handlerProtocol:s=""}=t.requestHandler.metadata||{};if(s.indexOf("h2")>=0&&!r.headers[":authority"])delete r.headers.host,r.headers[":authority"]=r.hostname+(r.port?":"+r.port:"");else if(!r.headers.host){let i=r.hostname;r.port!=null&&(i+=`:${r.port}`),r.headers.host=i}return e(n)},dj={name:"hostHeaderMiddleware",step:"build",priority:"low",tags:["HOST"],override:!0},hj=t=>({applyToStack:e=>{e.add(lj(t),dj)}}),fj=()=>(t,e)=>async n=>{var r,s;try{const i=await t(n),{clientName:a,commandName:o,logger:c,dynamoDbDocumentClientOptions:u={}}=e,{overrideInputFilterSensitiveLog:l,overrideOutputFilterSensitiveLog:d}=u,h=l??e.inputFilterSensitiveLog,f=d??e.outputFilterSensitiveLog,{$metadata:m,...g}=i.output;return(r=c==null?void 0:c.info)==null||r.call(c,{clientName:a,commandName:o,input:h(n.input),output:f(g),metadata:m}),i}catch(i){const{clientName:a,commandName:o,logger:c,dynamoDbDocumentClientOptions:u={}}=e,{overrideInputFilterSensitiveLog:l}=u,d=l??e.inputFilterSensitiveLog;throw(s=c==null?void 0:c.error)==null||s.call(c,{clientName:a,commandName:o,input:d(n.input),error:i,metadata:i.$metadata}),i}},pj={name:"loggerMiddleware",tags:["LOGGER"],step:"initialize",override:!0},mj=t=>({applyToStack:e=>{e.add(fj(),pj)}}),gj={step:"build",tags:["RECURSION_DETECTION"],name:"recursionDetectionMiddleware",override:!0,priority:"low"},yj=()=>t=>async e=>t(e),_j=t=>({applyToStack:e=>{e.add(yj(),gj)}}),md=t=>t[Zp]||(t[Zp]={}),hs=t=>{if(typeof t=="function")return t;const e=Promise.resolve(t);return()=>e},wj=(t,e)=>{if(!e||e.length===0)return t;const n=[];for(const r of e)for(const s of t)s.schemeId.split("#")[1]===r&&n.push(s);for(const r of t)n.find(({schemeId:s})=>s===r.schemeId)||n.push(r);return n};function bj(t){const e=new Map;for(const n of t)e.set(n.schemeId,n);return e}const vj=(t,e)=>(n,r)=>async s=>{var d;const i=t.httpAuthSchemeProvider(await e.httpAuthSchemeParametersProvider(t,r,s.input)),a=t.authSchemePreference?await t.authSchemePreference():[],o=wj(i,a),c=bj(t.httpAuthSchemes),u=md(r),l=[];for(const h of o){const f=c.get(h.schemeId);if(!f){l.push(`HttpAuthScheme \`${h.schemeId}\` was not enabled for this service.`);continue}const m=f.identityProvider(await e.identityProviderConfigProvider(t));if(!m){l.push(`HttpAuthScheme \`${h.schemeId}\` did not have an IdentityProvider configured.`);continue}const{identityProperties:g={},signingProperties:_={}}=((d=h.propertiesExtractor)==null?void 0:d.call(h,t,r))||{};h.identityProperties=Object.assign(h.identityProperties||{},g),h.signingProperties=Object.assign(h.signingProperties||{},_),u.selectedHttpAuthScheme={httpAuthOption:h,identity:await m(h.identityProperties),signer:f.signer};break}if(!u.selectedHttpAuthScheme)throw new Error(l.join(`
`));return n(s)},Ej={step:"serialize",tags:["HTTP_AUTH_SCHEME"],name:"httpAuthSchemeMiddleware",override:!0,relation:"before",toMiddleware:"endpointV2Middleware"},Sj=(t,{httpAuthSchemeParametersProvider:e,identityProviderConfigProvider:n})=>({applyToStack:r=>{r.addRelativeTo(vj(t,{httpAuthSchemeParametersProvider:e,identityProviderConfigProvider:n}),Ej)}}),xj=(t,e)=>(n,r)=>async s=>{var a,o,c,u;const{response:i}=await n(s);try{const l=await e(i,t);return{response:i,output:l}}catch(l){if(Object.defineProperty(l,"$response",{value:i}),!("$metadata"in l)){const d="Deserialization error: to see the raw response, inspect the hidden field {error}.$response on this object.";try{l.message+=`
  `+d}catch{!r.logger||((o=(a=r.logger)==null?void 0:a.constructor)==null?void 0:o.name)==="NoOpLogger"?console.warn(d):(u=(c=r.logger)==null?void 0:c.warn)==null||u.call(c,d)}typeof l.$responseBodyText<"u"&&l.$response&&(l.$response.body=l.$responseBodyText);try{if(Ca.isInstance(i)){const{headers:h={}}=i,f=Object.entries(h);l.$metadata={httpStatusCode:i.statusCode,requestId:Tf(/^x-[\w-]+-request-?id$/,f),extendedRequestId:Tf(/^x-[\w-]+-id-2$/,f),cfId:Tf(/^x-[\w-]+-cf-id$/,f)}}}catch{}}throw l}},Tf=(t,e)=>(e.find(([n])=>n.match(t))||[void 0,void 0])[1],Tj=(t,e)=>(n,r)=>async s=>{var c;const i=t,a=(c=r.endpointV2)!=null&&c.url&&i.urlParser?async()=>i.urlParser(r.endpointV2.url):i.endpoint;if(!a)throw new Error("No valid endpoint provider available.");const o=await e(s.input,{...t,endpoint:a});return n({...s,request:o})},Aj={name:"deserializerMiddleware",step:"deserialize",tags:["DESERIALIZER"],override:!0},dA={name:"serializerMiddleware",step:"serialize",tags:["SERIALIZER"],override:!0};function hA(t,e,n){return{applyToStack:r=>{r.add(xj(t,n),Aj),r.add(Tj(t,e),dA)}}}const Cj=t=>e=>{throw e},kj=(t,e)=>{},Ij=t=>(e,n)=>async r=>{if(!Rn.isInstance(r.request))return e(r);const i=md(n).selectedHttpAuthScheme;if(!i)throw new Error("No HttpAuthScheme was selected: unable to sign request");const{httpAuthOption:{signingProperties:a={}},identity:o,signer:c}=i,u=await e({...r,request:await c.sign(r.request,o,a)}).catch((c.errorHandler||Cj)(a));return(c.successHandler||kj)(u.response,a),u},Rj={step:"finalizeRequest",tags:["HTTP_SIGNING"],name:"httpSigningMiddleware",aliases:["apiKeyMiddleware","tokenMiddleware","awsAuthMiddleware"],override:!0,relation:"after",toMiddleware:"retryMiddleware"},Oj=t=>({applyToStack:e=>{e.addRelativeTo(Ij(),Rj)}}),_o=t=>{if(typeof t=="function")return t;const e=Promise.resolve(t);return()=>e},fA="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Mb=Object.entries(fA).reduce((t,[e,n])=>(t[n]=Number(e),t),{}),$j=fA.split(""),pa=6,wo=8,Nj=63,Hg=t=>{let e=t.length/4*3;t.slice(-2)==="=="?e-=2:t.slice(-1)==="="&&e--;const n=new ArrayBuffer(e),r=new DataView(n);for(let s=0;s<t.length;s+=4){let i=0,a=0;for(let u=s,l=s+3;u<=l;u++)if(t[u]!=="="){if(!(t[u]in Mb))throw new TypeError(`Invalid character ${t[u]} in base64 string.`);i|=Mb[t[u]]<<(l-u)*pa,a+=pa}else i>>=pa;const o=s/4*3;i>>=a%wo;const c=Math.floor(a/wo);for(let u=0;u<c;u++){const l=(c-u-1)*wo;r.setUint8(o+u,(i&255<<l)>>l)}}return new Uint8Array(n)},ka=t=>new TextEncoder().encode(t),Wo=t=>typeof t=="string"?ka(t):ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength/Uint8Array.BYTES_PER_ELEMENT):new Uint8Array(t),Gg=t=>{if(typeof t=="string")return t;if(typeof t!="object"||typeof t.byteOffset!="number"||typeof t.byteLength!="number")throw new Error("@smithy/util-utf8: toUtf8 encoder function only accepts string | Uint8Array.");return new TextDecoder("utf-8").decode(t)};function pA(t){let e;typeof t=="string"?e=ka(t):e=t;const n=typeof e=="object"&&typeof e.length=="number",r=typeof e=="object"&&typeof e.byteOffset=="number"&&typeof e.byteLength=="number";if(!n&&!r)throw new Error("@smithy/util-base64: toBase64 encoder function only accepts string | Uint8Array.");let s="";for(let i=0;i<e.length;i+=3){let a=0,o=0;for(let u=i,l=Math.min(i+3,e.length);u<l;u++)a|=e[u]<<(l-u-1)*wo,o+=wo;const c=Math.ceil(o/pa);a<<=c*pa-o;for(let u=1;u<=c;u++){const l=(c-u)*pa;s+=$j[(a&Nj<<l)>>l]}s+="==".slice(0,4-c)}return s}class _i extends Uint8Array{static fromString(e,n="utf-8"){if(typeof e=="string")return n==="base64"?_i.mutate(Hg(e)):_i.mutate(ka(e));throw new Error(`Unsupported conversion from ${typeof e} to Uint8ArrayBlobAdapter.`)}static mutate(e){return Object.setPrototypeOf(e,_i.prototype),e}transformToString(e="utf-8"){return e==="base64"?pA(this):Gg(this)}}const wi=t=>encodeURIComponent(t).replace(/[!'()*]/g,Pj),Pj=t=>`%${t.charCodeAt(0).toString(16).toUpperCase()}`;function mA(t){const e=[];for(let n of Object.keys(t).sort()){const r=t[n];if(n=wi(n),Array.isArray(r))for(let s=0,i=r.length;s<i;s++)e.push(`${n}=${wi(r[s])}`);else{let s=n;(r||typeof r=="string")&&(s+=`=${wi(r)}`),e.push(s)}}return e.join("&")}function Db(t,e){return new Request(t,e)}function Lj(t=0){return new Promise((e,n)=>{t&&setTimeout(()=>{const r=new Error(`Request did not complete within ${t} ms`);r.name="TimeoutError",n(r)},t)})}const Af={supported:void 0};class Jo{constructor(e){p(this,"config");p(this,"configProvider");typeof e=="function"?this.configProvider=e().then(n=>n||{}):(this.config=e??{},this.configProvider=Promise.resolve(this.config)),Af.supported===void 0&&(Af.supported=typeof Request<"u"&&"keepalive"in Db("https://[::1]"))}static create(e){return typeof(e==null?void 0:e.handle)=="function"?e:new Jo(e)}destroy(){}async handle(e,{abortSignal:n,requestTimeout:r}={}){var y;this.config||(this.config=await this.configProvider);const s=r??this.config.requestTimeout,i=this.config.keepAlive===!0,a=this.config.credentials;if(n!=null&&n.aborted){const E=new Error("Request aborted");return E.name="AbortError",Promise.reject(E)}let o=e.path;const c=mA(e.query||{});c&&(o+=`?${c}`),e.fragment&&(o+=`#${e.fragment}`);let u="";if(e.username!=null||e.password!=null){const E=e.username??"",C=e.password??"";u=`${E}:${C}@`}const{port:l,method:d}=e,h=`${e.protocol}//${u}${e.hostname}${l?`:${l}`:""}${o}`,f=d==="GET"||d==="HEAD"?void 0:e.body,m={body:f,headers:new Headers(e.headers),method:d,credentials:a};(y=this.config)!=null&&y.cache&&(m.cache=this.config.cache),f&&(m.duplex="half"),typeof AbortController<"u"&&(m.signal=n),Af.supported&&(m.keepalive=i),typeof this.config.requestInit=="function"&&Object.assign(m,this.config.requestInit(e));let g=()=>{};const _=Db(h,m),b=[fetch(_).then(E=>{const C=E.headers,k={};for(const $ of C.entries())k[$[0]]=$[1];return E.body!=null?{response:new Ca({headers:k,reason:E.statusText,statusCode:E.status,body:E.body})}:E.blob().then($=>({response:new Ca({headers:k,reason:E.statusText,statusCode:E.status,body:$})}))}),Lj(s)];return n&&b.push(new Promise((E,C)=>{const k=()=>{const R=new Error("Request aborted");R.name="AbortError",C(R)};if(typeof n.addEventListener=="function"){const R=n;R.addEventListener("abort",k,{once:!0}),g=()=>R.removeEventListener("abort",k)}else n.onabort=k})),Promise.race(b).finally(g)}updateHttpClientConfig(e,n){this.config=void 0,this.configProvider=this.configProvider.then(r=>(r[e]=n,r))}httpHandlerConfigs(){return this.config??{}}}const Mj=async t=>{var e;return typeof Blob=="function"&&t instanceof Blob||((e=t.constructor)==null?void 0:e.name)==="Blob"?Blob.prototype.arrayBuffer!==void 0?new Uint8Array(await t.arrayBuffer()):Dj(t):Uj(t)};async function Dj(t){const e=await Bj(t),n=Hg(e);return new Uint8Array(n)}async function Uj(t){const e=[],n=t.getReader();let r=!1,s=0;for(;!r;){const{done:o,value:c}=await n.read();c&&(e.push(c),s+=c.length),r=o}const i=new Uint8Array(s);let a=0;for(const o of e)i.set(o,a),a+=o.length;return i}function Bj(t){return new Promise((e,n)=>{const r=new FileReader;r.onloadend=()=>{if(r.readyState!==2)return n(new Error("Reader aborted too early"));const s=r.result??"",i=s.indexOf(","),a=i>-1?i+1:s.length;e(s.substring(a))},r.onabort=()=>n(new Error("Read aborted")),r.onerror=()=>n(r.error),r.readAsDataURL(t)})}const gA={},Kp={};for(let t=0;t<256;t++){let e=t.toString(16).toLowerCase();e.length===1&&(e=`0${e}`),gA[t]=e,Kp[e]=t}function Wg(t){if(t.length%2!==0)throw new Error("Hex encoded strings must have an even number length");const e=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2){const r=t.slice(n,n+2).toLowerCase();if(r in Kp)e[n/2]=Kp[r];else throw new Error(`Cannot decode unrecognized sequence ${r} as hexadecimal`)}return e}function jn(t){let e="";for(let n=0;n<t.byteLength;n++)e+=gA[t[n]];return e}const jj=async(t=new Uint8Array,e)=>{if(t instanceof Uint8Array)return _i.mutate(t);if(!t)return _i.mutate(new Uint8Array);const n=e.streamCollector(t);return _i.mutate(await n)};function Ub(t){return encodeURIComponent(t).replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}const Cf=t=>typeof t=="function"?t():t;function Xc(t){if(typeof t=="object")return t;t=t|0;const e={};let n=0;for(const r of["httpLabel","idempotent","idempotencyToken","sensitive","httpPayload","httpResponseCode","httpQueryParams"])(t>>n++&1)===1&&(e[r]=1);return e}const Rs=class Rs{constructor(e,n){p(this,"ref");p(this,"memberName");p(this,"symbol",Rs.symbol);p(this,"name");p(this,"schema");p(this,"_isMemberSchema");p(this,"traits");p(this,"memberTraits");p(this,"normalizedTraits");this.ref=e,this.memberName=n;const r=[];let s=e,i=e;for(this._isMemberSchema=!1;kf(s);)r.push(s[1]),s=s[0],i=Cf(s),this._isMemberSchema=!0;if(r.length>0){this.memberTraits={};for(let a=r.length-1;a>=0;--a){const o=r[a];Object.assign(this.memberTraits,Xc(o))}}else this.memberTraits=0;if(i instanceof Rs){const a=this.memberTraits;Object.assign(this,i),this.memberTraits=Object.assign({},a,i.getMemberTraits(),this.getMemberTraits()),this.normalizedTraits=void 0,this.memberName=n??i.memberName;return}if(this.schema=Cf(i),Fj(this.schema)?(this.name=`${this.schema[1]}#${this.schema[2]}`,this.traits=this.schema[3]):(this.name=this.memberName??String(i),this.traits=0),this._isMemberSchema&&!n)throw new Error(`@smithy/core/schema - NormalizedSchema member init ${this.getName(!0)} missing member name.`)}static[Symbol.hasInstance](e){const n=this.prototype.isPrototypeOf(e);return!n&&typeof e=="object"&&e!==null?e.symbol===this.symbol:n}static of(e){const n=Cf(e);if(n instanceof Rs)return n;if(kf(n)){const[r,s]=n;if(r instanceof Rs)return Object.assign(r.getMergedTraits(),Xc(s)),r;throw new Error(`@smithy/core/schema - may not init unwrapped member schema=${JSON.stringify(e,null,2)}.`)}return new Rs(n)}getSchema(){const e=this.schema;return e[0]===0?e[4]:e}getName(e=!1){const{name:n}=this;return!e&&n&&n.includes("#")?n.split("#")[1]:n||void 0}getMemberName(){return this.memberName}isMemberSchema(){return this._isMemberSchema}isListSchema(){const e=this.getSchema();return typeof e=="number"?e>=64&&e<128:e[0]===1}isMapSchema(){const e=this.getSchema();return typeof e=="number"?e>=128&&e<=255:e[0]===2}isStructSchema(){const e=this.getSchema();return e[0]===3||e[0]===-3}isBlobSchema(){const e=this.getSchema();return e===21||e===42}isTimestampSchema(){const e=this.getSchema();return typeof e=="number"&&e>=4&&e<=7}isUnitSchema(){return this.getSchema()==="unit"}isDocumentSchema(){return this.getSchema()===15}isStringSchema(){return this.getSchema()===0}isBooleanSchema(){return this.getSchema()===2}isNumericSchema(){return this.getSchema()===1}isBigIntegerSchema(){return this.getSchema()===17}isBigDecimalSchema(){return this.getSchema()===19}isStreaming(){const{streaming:e}=this.getMergedTraits();return!!e||this.getSchema()===42}isIdempotencyToken(){const e=i=>(i&4)===4||!!(i!=null&&i.idempotencyToken),{normalizedTraits:n,traits:r,memberTraits:s}=this;return e(n)||e(r)||e(s)}getMergedTraits(){return this.normalizedTraits??(this.normalizedTraits={...this.getOwnTraits(),...this.getMemberTraits()})}getMemberTraits(){return Xc(this.memberTraits)}getOwnTraits(){return Xc(this.traits)}getKeySchema(){const[e,n]=[this.isDocumentSchema(),this.isMapSchema()];if(!e&&!n)throw new Error(`@smithy/core/schema - cannot get key for non-map: ${this.getName(!0)}`);const r=this.getSchema(),s=e?15:r[4]??0;return Ha([s,0],"key")}getValueSchema(){const e=this.getSchema(),[n,r,s]=[this.isDocumentSchema(),this.isMapSchema(),this.isListSchema()],i=typeof e=="number"?63&e:e&&typeof e=="object"&&(r||s)?e[3+e[0]]:n?15:void 0;if(i!=null)return Ha([i,0],r?"value":"member");throw new Error(`@smithy/core/schema - ${this.getName(!0)} has no value member.`)}getMemberSchema(e){const n=this.getSchema();if(this.isStructSchema()&&n[4].includes(e)){const r=n[4].indexOf(e),s=n[5][r];return Ha(kf(s)?s:[s,0],e)}if(this.isDocumentSchema())return Ha([15,0],e);throw new Error(`@smithy/core/schema - ${this.getName(!0)} has no no member=${e}.`)}getMemberSchemas(){const e={};try{for(const[n,r]of this.structIterator())e[n]=r}catch{}return e}getEventStreamMember(){if(this.isStructSchema()){for(const[e,n]of this.structIterator())if(n.isStreaming()&&n.isStructSchema())return e}return""}*structIterator(){if(this.isUnitSchema())return;if(!this.isStructSchema())throw new Error("@smithy/core/schema - cannot iterate non-struct schema.");const e=this.getSchema();for(let n=0;n<e[4].length;++n)yield[e[4][n],Ha([e[5][n],0],e[4][n])]}};p(Rs,"symbol",Symbol.for("@smithy/nor"));let Zo=Rs;function Ha(t,e){if(t instanceof Zo)return Object.assign(t,{memberName:e,_isMemberSchema:!0});const n=Zo;return new n(t,e)}const kf=t=>Array.isArray(t)&&t.length===2,Fj=t=>Array.isArray(t)&&t.length>=5,zj=t=>{if(t!=null){if(typeof t=="number"){if((t===0||t===1)&&Sl.warn(El(`Expected boolean, got ${typeof t}: ${t}`)),t===0)return!1;if(t===1)return!0}if(typeof t=="string"){const e=t.toLowerCase();if((e==="false"||e==="true")&&Sl.warn(El(`Expected boolean, got ${typeof t}: ${t}`)),e==="false")return!1;if(e==="true")return!0}if(typeof t=="boolean")return t;throw new TypeError(`Expected boolean, got ${typeof t}: ${t}`)}},Vj=t=>{if(t!=null){if(typeof t=="string"){const e=parseFloat(t);if(!Number.isNaN(e))return String(e)!==String(t)&&Sl.warn(El(`Expected number but observed string: ${t}`)),e}if(typeof t=="number")return t;throw new TypeError(`Expected number, got ${typeof t}: ${t}`)}},qj=t=>{if(t!=null){if(Number.isInteger(t)&&!Number.isNaN(t))return t;throw new TypeError(`Expected integer, got ${typeof t}: ${t}`)}},Jg=t=>Hj(t,32),Hj=(t,e)=>{const n=qj(t);if(n!==void 0&&Gj(n,e)!==n)throw new TypeError(`Expected ${e}-bit integer, got ${t}`);return n},Gj=(t,e)=>{switch(e){case 32:return Int32Array.of(t)[0];case 16:return Int16Array.of(t)[0];case 8:return Int8Array.of(t)[0]}},Wj=(t,e)=>{if(t==null)throw new TypeError(`Expected a non-null value for ${e}`);return t},yA=t=>{if(t==null)return;if(typeof t=="object"&&!Array.isArray(t))return t;const e=Array.isArray(t)?"array":typeof t;throw new TypeError(`Expected object, got ${e}: ${t}`)},Ne=t=>{if(t!=null){if(typeof t=="string")return t;if(["boolean","number","bigint"].includes(typeof t))return Sl.warn(El(`Expected string, got ${typeof t}: ${t}`)),String(t);throw new TypeError(`Expected string, got ${typeof t}: ${t}`)}},Jj=t=>{if(t==null)return;const e=yA(t),n=Object.entries(e).filter(([,r])=>r!=null).map(([r])=>r);if(n.length===0)throw new TypeError("Unions must have exactly one non-null member. None were found.");if(n.length>1)throw new TypeError(`Unions must have exactly one non-null member. Keys ${n} were not null.`);return e},Xp=t=>typeof t=="string"?Zj(t):Vj(t),Zj=t=>{switch(t){case"NaN":return NaN;case"Infinity":return 1/0;case"-Infinity":return-1/0;default:throw new Error(`Unable to parse float value: ${t}`)}},El=t=>String(new TypeError(t).stack||t).split(`
`).slice(0,5).filter(e=>!e.includes("stackTraceWarning")).join(`
`),Sl={warn:console.warn},Bb=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),tn=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0")),Kj=()=>{if(Bb)return Bb();const t=new Uint8Array(16);return crypto.getRandomValues(t),t[6]=t[6]&15|64,t[8]=t[8]&63|128,tn[t[0]]+tn[t[1]]+tn[t[2]]+tn[t[3]]+"-"+tn[t[4]]+tn[t[5]]+"-"+tn[t[6]]+tn[t[7]]+"-"+tn[t[8]]+tn[t[9]]+"-"+tn[t[10]]+tn[t[11]]+tn[t[12]]+tn[t[13]]+tn[t[14]]+tn[t[15]]},Xj=(t,e,n,r,s,i)=>{if(e!=null&&e[n]!==void 0){const a=r();if(a.length<=0)throw new Error("Empty value provided for input HTTP label: "+n+".");t=t.replace(s,i?a.split("/").map(o=>Ub(o)).join("/"):Ub(a))}else throw new Error("No value provided for input HTTP label: "+n+".");return t};function _A(t,e){return new Yj(t,e)}class Yj{constructor(e,n){p(this,"input");p(this,"context");p(this,"query",{});p(this,"method","");p(this,"headers",{});p(this,"path","");p(this,"body",null);p(this,"hostname","");p(this,"resolvePathStack",[]);this.input=e,this.context=n}async build(){const{hostname:e,protocol:n="https",port:r,path:s}=await this.context.endpoint();this.path=s;for(const i of this.resolvePathStack)i(this.path);return new Rn({protocol:n,hostname:this.hostname||e,port:r,method:this.method,path:this.path,query:this.query,body:this.body,headers:this.headers})}hn(e){return this.hostname=e,this}bp(e){return this.resolvePathStack.push(n=>{this.path=`${n!=null&&n.endsWith("/")?n.slice(0,-1):n||""}`+e}),this}p(e,n,r,s){return this.resolvePathStack.push(i=>{this.path=Xj(i,this.input,e,n,r,s)}),this}h(e){return this.headers=e,this}q(e){return this.query=e,this}b(e){return this.body=e,this}m(e){return this.method=e,this}}function Qj(t,e,n){t.__smithy_context?t.__smithy_context.features||(t.__smithy_context.features={}):t.__smithy_context={features:{}},t.__smithy_context.features[e]=n}class eF{constructor(e){p(this,"authSchemes",new Map);for(const[n,r]of Object.entries(e))r!==void 0&&this.authSchemes.set(n,r)}getIdentityProvider(e){return this.authSchemes.get(e)}}class tF{async sign(e,n,r){const s=Rn.clone(e);if(!n.token)throw new Error("request could not be signed with `token` since the `token` is not defined");return s.headers.Authorization=`Bearer ${n.token}`,s}}const nF=t=>function(n){return Zg(n)&&n.expiration.getTime()-Date.now()<t},rF=3e5,wA=nF(rF),Zg=t=>t.expiration!==void 0,bA=(t,e,n)=>{if(t===void 0)return;const r=typeof t!="function"?async()=>Promise.resolve(t):t;let s,i,a,o=!1;const c=async u=>{i||(i=r(u));try{s=await i,a=!0,o=!1}finally{i=void 0}return s};return e===void 0?async u=>((!a||u!=null&&u.forceRefresh)&&(s=await c(u)),s):async u=>((!a||u!=null&&u.forceRefresh)&&(s=await c(u)),o?s:n(s)?(e(s)&&await c(u),s):(o=!0,s))},sF=void 0;function iF(t){return t===void 0?!0:typeof t=="string"&&t.length<=50}function aF(t){const e=_o(t.userAgentAppId??sF),{customUserAgent:n}=t;return Object.assign(t,{customUserAgent:typeof n=="string"?[[n]]:n,userAgentAppId:async()=>{var s,i;const r=await e();if(!iF(r)){const a=((i=(s=t.logger)==null?void 0:s.constructor)==null?void 0:i.name)==="NoOpLogger"||!t.logger?console:t.logger;typeof r!="string"?a==null||a.warn("userAgentAppId must be a string or undefined."):r.length>50&&(a==null||a.warn("The provided userAgentAppId exceeds the maximum length of 50 characters."))}return r}})}class oF{constructor({size:e,params:n}){p(this,"capacity");p(this,"data",new Map);p(this,"parameters",[]);this.capacity=e??50,n&&(this.parameters=n)}get(e,n){const r=this.hash(e);if(r===!1)return n();if(!this.data.has(r)){if(this.data.size>this.capacity+10){const s=this.data.keys();let i=0;for(;;){const{value:a,done:o}=s.next();if(this.data.delete(a),o||++i>10)break}}this.data.set(r,n())}return this.data.get(r)}size(){return this.data.size}hash(e){let n="";const{parameters:r}=this;if(r.length===0)return!1;for(const s of r){const i=String(e[s]??"");if(i.includes("|;"))return!1;n+=i+"|;"}return n}}const cF=new RegExp("^(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}$"),vA=t=>cF.test(t)||t.startsWith("[")&&t.endsWith("]"),uF=new RegExp("^(?!.*-$)(?!-)[a-zA-Z0-9-]{1,63}$"),gd=(t,e=!1)=>{if(!e)return uF.test(t);const n=t.split(".");for(const r of n)if(!gd(r))return!1;return!0},xl={},Ko="endpoints";function Ws(t){return typeof t!="object"||t==null?t:"ref"in t?`$${Ws(t.ref)}`:"fn"in t?`${t.fn}(${(t.argv||[]).map(Ws).join(", ")})`:JSON.stringify(t,null,2)}class Hn extends Error{constructor(e){super(e),this.name="EndpointError"}}const lF=(t,e)=>t===e,dF=t=>{const e=t.split("."),n=[];for(const r of e){const s=r.indexOf("[");if(s!==-1){if(r.indexOf("]")!==r.length-1)throw new Hn(`Path: '${t}' does not end with ']'`);const i=r.slice(s+1,-1);if(Number.isNaN(parseInt(i)))throw new Hn(`Invalid array index: '${i}' in path: '${t}'`);s!==0&&n.push(r.slice(0,s)),n.push(i)}else n.push(r)}return n},EA=(t,e)=>dF(e).reduce((n,r)=>{if(typeof n!="object")throw new Hn(`Index '${r}' in '${e}' not found in '${JSON.stringify(t)}'`);return Array.isArray(n)?n[parseInt(r)]:n[r]},t),hF=t=>t!=null,fF=t=>!t,If={[Go.HTTP]:80,[Go.HTTPS]:443},pF=t=>{const e=(()=>{try{if(t instanceof URL)return t;if(typeof t=="object"&&"hostname"in t){const{hostname:h,port:f,protocol:m="",path:g="",query:_={}}=t,b=new URL(`${m}//${h}${f?`:${f}`:""}${g}`);return b.search=Object.entries(_).map(([y,E])=>`${y}=${E}`).join("&"),b}return new URL(t)}catch{return null}})();if(!e)return console.error(`Unable to parse ${JSON.stringify(t)} as a whatwg URL.`),null;const n=e.href,{host:r,hostname:s,pathname:i,protocol:a,search:o}=e;if(o)return null;const c=a.slice(0,-1);if(!Object.values(Go).includes(c))return null;const u=vA(s),l=n.includes(`${r}:${If[c]}`)||typeof t=="string"&&t.includes(`${r}:${If[c]}`),d=`${r}${l?`:${If[c]}`:""}`;return{scheme:c,authority:d,path:i,normalizedPath:i.endsWith("/")?i:`${i}/`,isIp:u}},mF=(t,e)=>t===e,gF=(t,e,n,r)=>e>=n||t.length<n?null:r?t.substring(t.length-n,t.length-e):t.substring(e,n),yF=t=>encodeURIComponent(t).replace(/[!*'()]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`),_F={booleanEquals:lF,getAttr:EA,isSet:hF,isValidHostLabel:gd,not:fF,parseURL:pF,stringEquals:mF,substring:gF,uriEncode:yF},SA=(t,e)=>{const n=[],r={...e.endpointParams,...e.referenceRecord};let s=0;for(;s<t.length;){const i=t.indexOf("{",s);if(i===-1){n.push(t.slice(s));break}n.push(t.slice(s,i));const a=t.indexOf("}",i);if(a===-1){n.push(t.slice(i));break}t[i+1]==="{"&&t[a+1]==="}"&&(n.push(t.slice(i+1,a)),s=a+2);const o=t.substring(i+1,a);if(o.includes("#")){const[c,u]=o.split("#");n.push(EA(r[c],u))}else n.push(r[o]);s=a+1}return n.join("")},wF=({ref:t},e)=>({...e.endpointParams,...e.referenceRecord})[t],yd=(t,e,n)=>{if(typeof t=="string")return SA(t,n);if(t.fn)return TA.callFunction(t,n);if(t.ref)return wF(t,n);throw new Hn(`'${e}': ${String(t)} is not a string, function or reference.`)},xA=({fn:t,argv:e},n)=>{const r=e.map(i=>["boolean","number"].includes(typeof i)?i:TA.evaluateExpression(i,"arg",n)),s=t.split(".");return s[0]in xl&&s[1]!=null?xl[s[0]][s[1]](...r):_F[t](...r)},TA={evaluateExpression:yd,callFunction:xA},bF=({assign:t,...e},n)=>{var s,i;if(t&&t in n.referenceRecord)throw new Hn(`'${t}' is already defined in Reference Record.`);const r=xA(e,n);return(i=(s=n.logger)==null?void 0:s.debug)==null||i.call(s,`${Ko} evaluateCondition: ${Ws(e)} = ${Ws(r)}`),{result:r===""?!0:!!r,...t!=null&&{toAssign:{name:t,value:r}}}},Kg=(t=[],e)=>{var r,s;const n={};for(const i of t){const{result:a,toAssign:o}=bF(i,{...e,referenceRecord:{...e.referenceRecord,...n}});if(!a)return{result:a};o&&(n[o.name]=o.value,(s=(r=e.logger)==null?void 0:r.debug)==null||s.call(r,`${Ko} assign: ${o.name} := ${Ws(o.value)}`))}return{result:!0,referenceRecord:n}},vF=(t,e)=>Object.entries(t).reduce((n,[r,s])=>({...n,[r]:s.map(i=>{const a=yd(i,"Header value entry",e);if(typeof a!="string")throw new Hn(`Header '${r}' value '${a}' is not a string`);return a})}),{}),AA=(t,e)=>Object.entries(t).reduce((n,[r,s])=>({...n,[r]:kA.getEndpointProperty(s,e)}),{}),CA=(t,e)=>{if(Array.isArray(t))return t.map(n=>CA(n,e));switch(typeof t){case"string":return SA(t,e);case"object":if(t===null)throw new Hn(`Unexpected endpoint property: ${t}`);return kA.getEndpointProperties(t,e);case"boolean":return t;default:throw new Hn(`Unexpected endpoint property type: ${typeof t}`)}},kA={getEndpointProperty:CA,getEndpointProperties:AA},EF=(t,e)=>{const n=yd(t,"Endpoint URL",e);if(typeof n=="string")try{return new URL(n)}catch(r){throw console.error(`Failed to construct URL with ${n}`,r),r}throw new Hn(`Endpoint URL must be a string, got ${typeof n}`)},SF=(t,e)=>{var l,d;const{conditions:n,endpoint:r}=t,{result:s,referenceRecord:i}=Kg(n,e);if(!s)return;const a={...e,referenceRecord:{...e.referenceRecord,...i}},{url:o,properties:c,headers:u}=r;return(d=(l=e.logger)==null?void 0:l.debug)==null||d.call(l,`${Ko} Resolving endpoint from template: ${Ws(r)}`),{...u!=null&&{headers:vF(u,a)},...c!=null&&{properties:AA(c,a)},url:EF(o,a)}},xF=(t,e)=>{const{conditions:n,error:r}=t,{result:s,referenceRecord:i}=Kg(n,e);if(s)throw new Hn(yd(r,"Error",{...e,referenceRecord:{...e.referenceRecord,...i}}))},IA=(t,e)=>{for(const n of t)if(n.type==="endpoint"){const r=SF(n,e);if(r)return r}else if(n.type==="error")xF(n,e);else if(n.type==="tree"){const r=RA.evaluateTreeRule(n,e);if(r)return r}else throw new Hn(`Unknown endpoint rule: ${n}`);throw new Hn("Rules evaluation failed")},TF=(t,e)=>{const{conditions:n,rules:r}=t,{result:s,referenceRecord:i}=Kg(n,e);if(s)return RA.evaluateRules(r,{...e,referenceRecord:{...e.referenceRecord,...i}})},RA={evaluateRules:IA,evaluateTreeRule:TF},AF=(t,e)=>{var u,l,d,h;const{endpointParams:n,logger:r}=e,{parameters:s,rules:i}=t;(l=(u=e.logger)==null?void 0:u.debug)==null||l.call(u,`${Ko} Initial EndpointParams: ${Ws(n)}`);const a=Object.entries(s).filter(([,f])=>f.default!=null).map(([f,m])=>[f,m.default]);if(a.length>0)for(const[f,m]of a)n[f]=n[f]??m;const o=Object.entries(s).filter(([,f])=>f.required).map(([f])=>f);for(const f of o)if(n[f]==null)throw new Hn(`Missing required parameter: '${f}'`);const c=IA(i,{endpointParams:n,logger:r,referenceRecord:{}});return(h=(d=e.logger)==null?void 0:d.debug)==null||h.call(d,`${Ko} Resolved endpoint: ${Ws(c)}`),c},OA=(t,e=!1)=>{if(e){for(const n of t.split("."))if(!OA(n))return!1;return!0}return!(!gd(t)||t.length<3||t.length>63||t!==t.toLowerCase()||vA(t))},jb=":",CF="/",kF=t=>{const e=t.split(jb);if(e.length<6)return null;const[n,r,s,i,a,...o]=e;if(n!=="arn"||r===""||s===""||o.join(jb)==="")return null;const c=o.map(u=>u.split(CF)).flat();return{partition:r,service:s,region:i,accountId:a,resourceId:c}},IF=[{id:"aws",outputs:{dnsSuffix:"amazonaws.com",dualStackDnsSuffix:"api.aws",implicitGlobalRegion:"us-east-1",name:"aws",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^(us|eu|ap|sa|ca|me|af|il|mx)\\-\\w+\\-\\d+$",regions:{"af-south-1":{description:"Africa (Cape Town)"},"ap-east-1":{description:"Asia Pacific (Hong Kong)"},"ap-east-2":{description:"Asia Pacific (Taipei)"},"ap-northeast-1":{description:"Asia Pacific (Tokyo)"},"ap-northeast-2":{description:"Asia Pacific (Seoul)"},"ap-northeast-3":{description:"Asia Pacific (Osaka)"},"ap-south-1":{description:"Asia Pacific (Mumbai)"},"ap-south-2":{description:"Asia Pacific (Hyderabad)"},"ap-southeast-1":{description:"Asia Pacific (Singapore)"},"ap-southeast-2":{description:"Asia Pacific (Sydney)"},"ap-southeast-3":{description:"Asia Pacific (Jakarta)"},"ap-southeast-4":{description:"Asia Pacific (Melbourne)"},"ap-southeast-5":{description:"Asia Pacific (Malaysia)"},"ap-southeast-6":{description:"Asia Pacific (New Zealand)"},"ap-southeast-7":{description:"Asia Pacific (Thailand)"},"aws-global":{description:"aws global region"},"ca-central-1":{description:"Canada (Central)"},"ca-west-1":{description:"Canada West (Calgary)"},"eu-central-1":{description:"Europe (Frankfurt)"},"eu-central-2":{description:"Europe (Zurich)"},"eu-north-1":{description:"Europe (Stockholm)"},"eu-south-1":{description:"Europe (Milan)"},"eu-south-2":{description:"Europe (Spain)"},"eu-west-1":{description:"Europe (Ireland)"},"eu-west-2":{description:"Europe (London)"},"eu-west-3":{description:"Europe (Paris)"},"il-central-1":{description:"Israel (Tel Aviv)"},"me-central-1":{description:"Middle East (UAE)"},"me-south-1":{description:"Middle East (Bahrain)"},"mx-central-1":{description:"Mexico (Central)"},"sa-east-1":{description:"South America (Sao Paulo)"},"us-east-1":{description:"US East (N. Virginia)"},"us-east-2":{description:"US East (Ohio)"},"us-west-1":{description:"US West (N. California)"},"us-west-2":{description:"US West (Oregon)"}}},{id:"aws-cn",outputs:{dnsSuffix:"amazonaws.com.cn",dualStackDnsSuffix:"api.amazonwebservices.com.cn",implicitGlobalRegion:"cn-northwest-1",name:"aws-cn",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^cn\\-\\w+\\-\\d+$",regions:{"aws-cn-global":{description:"aws-cn global region"},"cn-north-1":{description:"China (Beijing)"},"cn-northwest-1":{description:"China (Ningxia)"}}},{id:"aws-eusc",outputs:{dnsSuffix:"amazonaws.eu",dualStackDnsSuffix:"api.amazonwebservices.eu",implicitGlobalRegion:"eusc-de-east-1",name:"aws-eusc",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^eusc\\-(de)\\-\\w+\\-\\d+$",regions:{"eusc-de-east-1":{description:"EU (Germany)"}}},{id:"aws-iso",outputs:{dnsSuffix:"c2s.ic.gov",dualStackDnsSuffix:"api.aws.ic.gov",implicitGlobalRegion:"us-iso-east-1",name:"aws-iso",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-iso\\-\\w+\\-\\d+$",regions:{"aws-iso-global":{description:"aws-iso global region"},"us-iso-east-1":{description:"US ISO East"},"us-iso-west-1":{description:"US ISO WEST"}}},{id:"aws-iso-b",outputs:{dnsSuffix:"sc2s.sgov.gov",dualStackDnsSuffix:"api.aws.scloud",implicitGlobalRegion:"us-isob-east-1",name:"aws-iso-b",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-isob\\-\\w+\\-\\d+$",regions:{"aws-iso-b-global":{description:"aws-iso-b global region"},"us-isob-east-1":{description:"US ISOB East (Ohio)"},"us-isob-west-1":{description:"US ISOB West"}}},{id:"aws-iso-e",outputs:{dnsSuffix:"cloud.adc-e.uk",dualStackDnsSuffix:"api.cloud-aws.adc-e.uk",implicitGlobalRegion:"eu-isoe-west-1",name:"aws-iso-e",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^eu\\-isoe\\-\\w+\\-\\d+$",regions:{"aws-iso-e-global":{description:"aws-iso-e global region"},"eu-isoe-west-1":{description:"EU ISOE West"}}},{id:"aws-iso-f",outputs:{dnsSuffix:"csp.hci.ic.gov",dualStackDnsSuffix:"api.aws.hci.ic.gov",implicitGlobalRegion:"us-isof-south-1",name:"aws-iso-f",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-isof\\-\\w+\\-\\d+$",regions:{"aws-iso-f-global":{description:"aws-iso-f global region"},"us-isof-east-1":{description:"US ISOF EAST"},"us-isof-south-1":{description:"US ISOF SOUTH"}}},{id:"aws-us-gov",outputs:{dnsSuffix:"amazonaws.com",dualStackDnsSuffix:"api.aws",implicitGlobalRegion:"us-gov-west-1",name:"aws-us-gov",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-gov\\-\\w+\\-\\d+$",regions:{"aws-us-gov-global":{description:"aws-us-gov global region"},"us-gov-east-1":{description:"AWS GovCloud (US-East)"},"us-gov-west-1":{description:"AWS GovCloud (US-West)"}}}],RF={partitions:IF};let OF=RF;const $F=t=>{const{partitions:e}=OF;for(const r of e){const{regions:s,outputs:i}=r;for(const[a,o]of Object.entries(s))if(a===t)return{...i,...o}}for(const r of e){const{regionRegex:s,outputs:i}=r;if(new RegExp(s).test(t))return{...i}}const n=e.find(r=>r.id==="aws");if(!n)throw new Error("Provided region was not found in the partition array or regex, and default partition with id 'aws' doesn't exist.");return{...n.outputs}},$A={isVirtualHostableS3Bucket:OA,parseArn:kF,partition:$F};xl.aws=$A;function NF(t){const e={};if(t=t.replace(/^\?/,""),t)for(const n of t.split("&")){let[r,s=null]=n.split("=");r=decodeURIComponent(r),s&&(s=decodeURIComponent(s)),r in e?Array.isArray(e[r])?e[r].push(s):e[r]=[e[r],s]:e[r]=s}return e}const Tl=t=>{if(typeof t=="string")return Tl(new URL(t));const{hostname:e,pathname:n,port:r,protocol:s,search:i}=t;let a;return i&&(a=NF(i)),{hostname:e,port:r?parseInt(r):void 0,protocol:s,path:n,query:a}};function PF(t,e,n){return t.$source||(t.$source={}),t.$source[e]=n,t}function kr(t,e,n){t.__aws_sdk_context?t.__aws_sdk_context.features||(t.__aws_sdk_context.features={}):t.__aws_sdk_context={features:{}},t.__aws_sdk_context.features[e]=n}const Fb=t=>{var e,n;return Ca.isInstance(t)?((e=t.headers)==null?void 0:e.date)??((n=t.headers)==null?void 0:n.Date):void 0},NA=t=>new Date(Date.now()+t),LF=(t,e)=>Math.abs(NA(e).getTime()-t)>=3e5,zb=(t,e)=>{const n=Date.parse(t);return LF(n,e)?n-Date.now():e},bo=(t,e)=>{if(!e)throw new Error(`Property \`${t}\` is not resolved for AWS SDK SigV4Auth`);return e},MF=async t=>{var u,l,d;const e=bo("context",t.context),n=bo("config",t.config),r=(d=(l=(u=e.endpointV2)==null?void 0:u.properties)==null?void 0:l.authSchemes)==null?void 0:d[0],i=await bo("signer",n.signer)(r),a=t==null?void 0:t.signingRegion,o=t==null?void 0:t.signingRegionSet,c=t==null?void 0:t.signingName;return{config:n,signer:i,signingRegion:a,signingRegionSet:o,signingName:c}};class DF{async sign(e,n,r){var d;if(!Rn.isInstance(e))throw new Error("The request is not an instance of `HttpRequest` and cannot be signed");const s=await MF(r),{config:i,signer:a}=s;let{signingRegion:o,signingName:c}=s;const u=r.context;if(((d=u==null?void 0:u.authSchemes)==null?void 0:d.length)??!1){const[h,f]=u.authSchemes;(h==null?void 0:h.name)==="sigv4a"&&(f==null?void 0:f.name)==="sigv4"&&(o=(f==null?void 0:f.signingRegion)??o,c=(f==null?void 0:f.signingName)??c)}return await a.sign(e,{signingDate:NA(i.systemClockOffset),signingRegion:o,signingService:c})}errorHandler(e){return n=>{const r=n.ServerTime??Fb(n.$response);if(r){const s=bo("config",e.config),i=s.systemClockOffset;s.systemClockOffset=zb(r,s.systemClockOffset),s.systemClockOffset!==i&&n.$metadata&&(n.$metadata.clockSkewCorrected=!0)}throw n}}successHandler(e,n){const r=Fb(e);if(r){const s=bo("config",n.config);s.systemClockOffset=zb(r,s.systemClockOffset)}}}const UF=(t,e,n)=>{let r,s,i,a=!1;const o=async()=>{s||(s=t());try{r=await s,i=!0,a=!1}finally{s=void 0}return r};return async c=>((!i||c!=null&&c.forceRefresh)&&(r=await o()),r)},BF="X-Amz-Algorithm",jF="X-Amz-Credential",PA="X-Amz-Date",FF="X-Amz-SignedHeaders",zF="X-Amz-Expires",LA="X-Amz-Signature",MA="X-Amz-Security-Token",DA="authorization",UA=PA.toLowerCase(),VF="date",qF=[DA,UA,VF],HF=LA.toLowerCase(),Yp="x-amz-content-sha256",GF=MA.toLowerCase(),WF={authorization:!0,"cache-control":!0,connection:!0,expect:!0,from:!0,"keep-alive":!0,"max-forwards":!0,pragma:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,"x-amzn-trace-id":!0},JF=/^proxy-/,ZF=/^sec-/,Rf="AWS4-HMAC-SHA256",KF="AWS4-HMAC-SHA256-PAYLOAD",XF="UNSIGNED-PAYLOAD",YF=50,BA="aws4_request",QF=3600*24*7,Yc={},Of=[],$f=(t,e,n)=>`${t}/${e}/${n}/${BA}`,e6=async(t,e,n,r,s)=>{const i=await Vb(t,e.secretAccessKey,e.accessKeyId),a=`${n}:${r}:${s}:${jn(i)}:${e.sessionToken}`;if(a in Yc)return Yc[a];for(Of.push(a);Of.length>YF;)delete Yc[Of.shift()];let o=`AWS4${e.secretAccessKey}`;for(const c of[n,r,s,BA])o=await Vb(t,o,c);return Yc[a]=o},Vb=(t,e,n)=>{const r=new t(e);return r.update(Wo(n)),r.digest()},qb=({headers:t},e,n)=>{const r={};for(const s of Object.keys(t).sort()){if(t[s]==null)continue;const i=s.toLowerCase();(i in WF||e!=null&&e.has(i)||JF.test(i)||ZF.test(i))&&(!n||n&&!n.has(i))||(r[i]=t[s].trim().replace(/\s+/g," "))}return r},t6=t=>typeof ArrayBuffer=="function"&&t instanceof ArrayBuffer||Object.prototype.toString.call(t)==="[object ArrayBuffer]",Nf=async({headers:t,body:e},n)=>{for(const r of Object.keys(t))if(r.toLowerCase()===Yp)return t[r];if(e==null)return"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855";if(typeof e=="string"||ArrayBuffer.isView(e)||t6(e)){const r=new n;return r.update(Wo(e)),jn(await r.digest())}return XF};class n6{format(e){const n=[];for(const i of Object.keys(e)){const a=ka(i);n.push(Uint8Array.from([a.byteLength]),a,this.formatHeaderValue(e[i]))}const r=new Uint8Array(n.reduce((i,a)=>i+a.byteLength,0));let s=0;for(const i of n)r.set(i,s),s+=i.byteLength;return r}formatHeaderValue(e){switch(e.type){case"boolean":return Uint8Array.from([e.value?0:1]);case"byte":return Uint8Array.from([2,e.value]);case"short":const n=new DataView(new ArrayBuffer(3));return n.setUint8(0,3),n.setInt16(1,e.value,!1),new Uint8Array(n.buffer);case"integer":const r=new DataView(new ArrayBuffer(5));return r.setUint8(0,4),r.setInt32(1,e.value,!1),new Uint8Array(r.buffer);case"long":const s=new Uint8Array(9);return s[0]=5,s.set(e.value.bytes,1),s;case"binary":const i=new DataView(new ArrayBuffer(3+e.value.byteLength));i.setUint8(0,6),i.setUint16(1,e.value.byteLength,!1);const a=new Uint8Array(i.buffer);return a.set(e.value,3),a;case"string":const o=ka(e.value),c=new DataView(new ArrayBuffer(3+o.byteLength));c.setUint8(0,7),c.setUint16(1,o.byteLength,!1);const u=new Uint8Array(c.buffer);return u.set(o,3),u;case"timestamp":const l=new Uint8Array(9);return l[0]=8,l.set(s6.fromNumber(e.value.valueOf()).bytes,1),l;case"uuid":if(!r6.test(e.value))throw new Error(`Invalid UUID received: ${e.value}`);const d=new Uint8Array(17);return d[0]=9,d.set(Wg(e.value.replace(/\-/g,"")),1),d}}}var Hb;(function(t){t[t.boolTrue=0]="boolTrue",t[t.boolFalse=1]="boolFalse",t[t.byte=2]="byte",t[t.short=3]="short",t[t.integer=4]="integer",t[t.long=5]="long",t[t.byteArray=6]="byteArray",t[t.string=7]="string",t[t.timestamp=8]="timestamp",t[t.uuid=9]="uuid"})(Hb||(Hb={}));const r6=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/;let s6=class jA{constructor(e){p(this,"bytes");if(this.bytes=e,e.byteLength!==8)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(e){if(e>9223372036854776e3||e<-9223372036854776e3)throw new Error(`${e} is too large (or, if negative, too small) to represent as an Int64`);const n=new Uint8Array(8);for(let r=7,s=Math.abs(Math.round(e));r>-1&&s>0;r--,s/=256)n[r]=s;return e<0&&Gb(n),new jA(n)}valueOf(){const e=this.bytes.slice(0),n=e[0]&128;return n&&Gb(e),parseInt(jn(e),16)*(n?-1:1)}toString(){return String(this.valueOf())}};function Gb(t){for(let e=0;e<8;e++)t[e]^=255;for(let e=7;e>-1&&(t[e]++,t[e]===0);e--);}const i6=(t,e)=>{t=t.toLowerCase();for(const n of Object.keys(e))if(t===n.toLowerCase())return!0;return!1},a6=(t,e={})=>{var s,i;const{headers:n,query:r={}}=Rn.clone(t);for(const a of Object.keys(n)){const o=a.toLowerCase();(o.slice(0,6)==="x-amz-"&&!((s=e.unhoistableHeaders)!=null&&s.has(o))||(i=e.hoistableHeaders)!=null&&i.has(o))&&(r[a]=n[a],delete n[a])}return{...t,headers:n,query:r}},Wb=t=>{t=Rn.clone(t);for(const e of Object.keys(t.headers))qF.indexOf(e.toLowerCase())>-1&&delete t.headers[e];return t},o6=({query:t={}})=>{const e=[],n={};for(const r of Object.keys(t)){if(r.toLowerCase()===HF)continue;const s=wi(r);e.push(s);const i=t[r];typeof i=="string"?n[s]=`${s}=${wi(i)}`:Array.isArray(i)&&(n[s]=i.slice(0).reduce((a,o)=>a.concat([`${s}=${wi(o)}`]),[]).sort().join("&"))}return e.sort().map(r=>n[r]).filter(r=>r).join("&")},c6=t=>u6(t).toISOString().replace(/\.\d{3}Z$/,"Z"),u6=t=>typeof t=="number"?new Date(t*1e3):typeof t=="string"?Number(t)?new Date(Number(t)*1e3):new Date(t):t;class l6{constructor({applyChecksum:e,credentials:n,region:r,service:s,sha256:i,uriEscapePath:a=!0}){p(this,"service");p(this,"regionProvider");p(this,"credentialProvider");p(this,"sha256");p(this,"uriEscapePath");p(this,"applyChecksum");this.service=s,this.sha256=i,this.uriEscapePath=a,this.applyChecksum=typeof e=="boolean"?e:!0,this.regionProvider=hs(r),this.credentialProvider=hs(n)}createCanonicalRequest(e,n,r){const s=Object.keys(n).sort();return`${e.method}
${this.getCanonicalPath(e)}
${o6(e)}
${s.map(i=>`${i}:${n[i]}`).join(`
`)}

${s.join(";")}
${r}`}async createStringToSign(e,n,r,s){const i=new this.sha256;i.update(Wo(r));const a=await i.digest();return`${s}
${e}
${n}
${jn(a)}`}getCanonicalPath({path:e}){if(this.uriEscapePath){const n=[];for(const i of e.split("/"))(i==null?void 0:i.length)!==0&&i!=="."&&(i===".."?n.pop():n.push(i));const r=`${e!=null&&e.startsWith("/")?"/":""}${n.join("/")}${n.length>0&&(e!=null&&e.endsWith("/"))?"/":""}`;return wi(r).replace(/%2F/g,"/")}return e}validateResolvedCredentials(e){if(typeof e!="object"||typeof e.accessKeyId!="string"||typeof e.secretAccessKey!="string")throw new Error("Resolved credential object is not valid")}formatDate(e){const n=c6(e).replace(/[\-:]/g,"");return{longDate:n,shortDate:n.slice(0,8)}}getCanonicalHeaderList(e){return Object.keys(e).sort().join(";")}}class Jb extends l6{constructor({applyChecksum:n,credentials:r,region:s,service:i,sha256:a,uriEscapePath:o=!0}){super({applyChecksum:n,credentials:r,region:s,service:i,sha256:a,uriEscapePath:o});p(this,"headerFormatter",new n6)}async presign(n,r={}){const{signingDate:s=new Date,expiresIn:i=3600,unsignableHeaders:a,unhoistableHeaders:o,signableHeaders:c,hoistableHeaders:u,signingRegion:l,signingService:d}=r,h=await this.credentialProvider();this.validateResolvedCredentials(h);const f=l??await this.regionProvider(),{longDate:m,shortDate:g}=this.formatDate(s);if(i>QF)return Promise.reject("Signature version 4 presigned URLs must have an expiration date less than one week in the future");const _=$f(g,f,d??this.service),b=a6(Wb(n),{unhoistableHeaders:o,hoistableHeaders:u});h.sessionToken&&(b.query[MA]=h.sessionToken),b.query[BF]=Rf,b.query[jF]=`${h.accessKeyId}/${_}`,b.query[PA]=m,b.query[zF]=i.toString(10);const y=qb(b,a,c);return b.query[FF]=this.getCanonicalHeaderList(y),b.query[LA]=await this.getSignature(m,_,this.getSigningKey(h,f,g,d),this.createCanonicalRequest(b,y,await Nf(n,this.sha256))),b}async sign(n,r){return typeof n=="string"?this.signString(n,r):n.headers&&n.payload?this.signEvent(n,r):n.message?this.signMessage(n,r):this.signRequest(n,r)}async signEvent({headers:n,payload:r},{signingDate:s=new Date,priorSignature:i,signingRegion:a,signingService:o}){const c=a??await this.regionProvider(),{shortDate:u,longDate:l}=this.formatDate(s),d=$f(u,c,o??this.service),h=await Nf({headers:{},body:r},this.sha256),f=new this.sha256;f.update(n);const m=jn(await f.digest()),g=[KF,l,d,i,m,h].join(`
`);return this.signString(g,{signingDate:s,signingRegion:c,signingService:o})}async signMessage(n,{signingDate:r=new Date,signingRegion:s,signingService:i}){return this.signEvent({headers:this.headerFormatter.format(n.message.headers),payload:n.message.body},{signingDate:r,signingRegion:s,signingService:i,priorSignature:n.priorSignature}).then(o=>({message:n.message,signature:o}))}async signString(n,{signingDate:r=new Date,signingRegion:s,signingService:i}={}){const a=await this.credentialProvider();this.validateResolvedCredentials(a);const o=s??await this.regionProvider(),{shortDate:c}=this.formatDate(r),u=new this.sha256(await this.getSigningKey(a,o,c,i));return u.update(Wo(n)),jn(await u.digest())}async signRequest(n,{signingDate:r=new Date,signableHeaders:s,unsignableHeaders:i,signingRegion:a,signingService:o}={}){const c=await this.credentialProvider();this.validateResolvedCredentials(c);const u=a??await this.regionProvider(),l=Wb(n),{longDate:d,shortDate:h}=this.formatDate(r),f=$f(h,u,o??this.service);l.headers[UA]=d,c.sessionToken&&(l.headers[GF]=c.sessionToken);const m=await Nf(l,this.sha256);!i6(Yp,l.headers)&&this.applyChecksum&&(l.headers[Yp]=m);const g=qb(l,i,s),_=await this.getSignature(d,f,this.getSigningKey(c,u,h,o),this.createCanonicalRequest(l,g,m));return l.headers[DA]=`${Rf} Credential=${c.accessKeyId}/${f}, SignedHeaders=${this.getCanonicalHeaderList(g)}, Signature=${_}`,l}async getSignature(n,r,s,i){const a=await this.createStringToSign(n,r,i,Rf),o=new this.sha256(await s);return o.update(Wo(a)),jn(await o.digest())}getSigningKey(n,r,s,i){return e6(this.sha256,n,s,r,i||this.service)}}const d6=t=>{let e=t.credentials,n=!!t.credentials,r;Object.defineProperty(t,"credentials",{set(u){u&&u!==e&&u!==r&&(n=!0),e=u;const l=h6(t,{credentials:e,credentialDefaultProvider:t.credentialDefaultProvider}),d=f6(t,l);n&&!d.attributed?(r=async h=>d(h).then(f=>PF(f,"CREDENTIALS_CODE","e")),r.memoized=d.memoized,r.configBound=d.configBound,r.attributed=!0):r=d},get(){return r},enumerable:!0,configurable:!0}),t.credentials=e;const{signingEscapePath:s=!0,systemClockOffset:i=t.systemClockOffset||0,sha256:a}=t;let o;return t.signer?o=_o(t.signer):t.regionInfoProvider?o=()=>_o(t.region)().then(async u=>[await t.regionInfoProvider(u,{useFipsEndpoint:await t.useFipsEndpoint(),useDualstackEndpoint:await t.useDualstackEndpoint()})||{},u]).then(([u,l])=>{const{signingRegion:d,signingService:h}=u;t.signingRegion=t.signingRegion||d||l,t.signingName=t.signingName||h||t.serviceId;const f={...t,credentials:t.credentials,region:t.signingRegion,service:t.signingName,sha256:a,uriEscapePath:s},m=t.signerConstructor||Jb;return new m(f)}):o=async u=>{u=Object.assign({},{name:"sigv4",signingName:t.signingName||t.defaultSigningName,signingRegion:await _o(t.region)(),properties:{}},u);const l=u.signingRegion,d=u.signingName;t.signingRegion=t.signingRegion||l,t.signingName=t.signingName||d||t.serviceId;const h={...t,credentials:t.credentials,region:t.signingRegion,service:t.signingName,sha256:a,uriEscapePath:s},f=t.signerConstructor||Jb;return new f(h)},Object.assign(t,{systemClockOffset:i,signingEscapePath:s,signer:o})};function h6(t,{credentials:e,credentialDefaultProvider:n}){let r;return e?e!=null&&e.memoized?r=e:r=bA(e,wA,Zg):n?r=_o(n(Object.assign({},t,{parentClientConfig:t}))):r=async()=>{throw new Error("@aws-sdk/core::resolveAwsSdkSigV4Config - `credentials` not provided and no credentialDefaultProvider was configured.")},r.memoized=!0,r}function f6(t,e){if(e.configBound)return e;const n=async r=>e({...r,callerClientConfig:t});return n.memoized=e.memoized,n.configBound=!0,n}const Zb=typeof TextEncoder=="function"?new TextEncoder:null,p6=t=>{if(typeof t=="string"){if(Zb)return Zb.encode(t).byteLength;let e=t.length;for(let n=e-1;n>=0;n--){const r=t.charCodeAt(n);r>127&&r<=2047?e++:r>2047&&r<=65535&&(e+=2),r>=56320&&r<=57343&&n--}return e}else{if(typeof t.byteLength=="number")return t.byteLength;if(typeof t.size=="number")return t.size}throw new Error(`Body Length computation failed for ${t}`)},Ys=(t,e)=>{const n=[];if(t&&n.push(t),e)for(const r of e)n.push(r);return n},xs=(t,e)=>`${t||"anonymous"}${e&&e.length>0?` (a.k.a. ${e.join(",")})`:""}`,Al=()=>{let t=[],e=[],n=!1;const r=new Set,s=d=>d.sort((h,f)=>Kb[f.step]-Kb[h.step]||Xb[f.priority||"normal"]-Xb[h.priority||"normal"]),i=d=>{let h=!1;const f=m=>{const g=Ys(m.name,m.aliases);if(g.includes(d)){h=!0;for(const _ of g)r.delete(_);return!1}return!0};return t=t.filter(f),e=e.filter(f),h},a=d=>{let h=!1;const f=m=>{if(m.middleware===d){h=!0;for(const g of Ys(m.name,m.aliases))r.delete(g);return!1}return!0};return t=t.filter(f),e=e.filter(f),h},o=d=>{var h;return t.forEach(f=>{d.add(f.middleware,{...f})}),e.forEach(f=>{d.addRelativeTo(f.middleware,{...f})}),(h=d.identifyOnResolve)==null||h.call(d,l.identifyOnResolve()),d},c=d=>{const h=[];return d.before.forEach(f=>{f.before.length===0&&f.after.length===0?h.push(f):h.push(...c(f))}),h.push(d),d.after.reverse().forEach(f=>{f.before.length===0&&f.after.length===0?h.push(f):h.push(...c(f))}),h},u=(d=!1)=>{const h=[],f=[],m={};return t.forEach(_=>{const b={..._,before:[],after:[]};for(const y of Ys(b.name,b.aliases))m[y]=b;h.push(b)}),e.forEach(_=>{const b={..._,before:[],after:[]};for(const y of Ys(b.name,b.aliases))m[y]=b;f.push(b)}),f.forEach(_=>{if(_.toMiddleware){const b=m[_.toMiddleware];if(b===void 0){if(d)return;throw new Error(`${_.toMiddleware} is not found when adding ${xs(_.name,_.aliases)} middleware ${_.relation} ${_.toMiddleware}`)}_.relation==="after"&&b.after.push(_),_.relation==="before"&&b.before.push(_)}}),s(h).map(c).reduce((_,b)=>(_.push(...b),_),[])},l={add:(d,h={})=>{const{name:f,override:m,aliases:g}=h,_={step:"initialize",priority:"normal",middleware:d,...h},b=Ys(f,g);if(b.length>0){if(b.some(y=>r.has(y))){if(!m)throw new Error(`Duplicate middleware name '${xs(f,g)}'`);for(const y of b){const E=t.findIndex(k=>{var R;return k.name===y||((R=k.aliases)==null?void 0:R.some($=>$===y))});if(E===-1)continue;const C=t[E];if(C.step!==_.step||_.priority!==C.priority)throw new Error(`"${xs(C.name,C.aliases)}" middleware with ${C.priority} priority in ${C.step} step cannot be overridden by "${xs(f,g)}" middleware with ${_.priority} priority in ${_.step} step.`);t.splice(E,1)}}for(const y of b)r.add(y)}t.push(_)},addRelativeTo:(d,h)=>{const{name:f,override:m,aliases:g}=h,_={middleware:d,...h},b=Ys(f,g);if(b.length>0){if(b.some(y=>r.has(y))){if(!m)throw new Error(`Duplicate middleware name '${xs(f,g)}'`);for(const y of b){const E=e.findIndex(k=>{var R;return k.name===y||((R=k.aliases)==null?void 0:R.some($=>$===y))});if(E===-1)continue;const C=e[E];if(C.toMiddleware!==_.toMiddleware||C.relation!==_.relation)throw new Error(`"${xs(C.name,C.aliases)}" middleware ${C.relation} "${C.toMiddleware}" middleware cannot be overridden by "${xs(f,g)}" middleware ${_.relation} "${_.toMiddleware}" middleware.`);e.splice(E,1)}}for(const y of b)r.add(y)}e.push(_)},clone:()=>o(Al()),use:d=>{d.applyToStack(l)},remove:d=>typeof d=="string"?i(d):a(d),removeByTag:d=>{let h=!1;const f=m=>{const{tags:g,name:_,aliases:b}=m;if(g&&g.includes(d)){const y=Ys(_,b);for(const E of y)r.delete(E);return h=!0,!1}return!0};return t=t.filter(f),e=e.filter(f),h},concat:d=>{var f;const h=o(Al());return h.use(d),h.identifyOnResolve(n||h.identifyOnResolve()||(((f=d.identifyOnResolve)==null?void 0:f.call(d))??!1)),h},applyToStack:o,identify:()=>u(!0).map(d=>{const h=d.step??d.relation+" "+d.toMiddleware;return xs(d.name,d.aliases)+" - "+h}),identifyOnResolve(d){return typeof d=="boolean"&&(n=d),n},resolve:(d,h)=>{for(const f of u().map(m=>m.middleware).reverse())d=f(d,h);return n&&console.log(l.identify()),d}};return l},Kb={initialize:5,serialize:4,build:3,finalizeRequest:2,deserialize:1},Xb={high:3,normal:2,low:1};class m6{constructor(e){p(this,"config");p(this,"middlewareStack",Al());p(this,"initConfig");p(this,"handlers");this.config=e}send(e,n,r){const s=typeof n!="function"?n:void 0,i=typeof n=="function"?n:r,a=s===void 0&&this.config.cacheMiddleware===!0;let o;if(a){this.handlers||(this.handlers=new WeakMap);const c=this.handlers;c.has(e.constructor)?o=c.get(e.constructor):(o=e.resolveMiddleware(this.middlewareStack,this.config,s),c.set(e.constructor,o))}else delete this.handlers,o=e.resolveMiddleware(this.middlewareStack,this.config,s);if(i)o(e).then(c=>i(null,c.output),c=>i(c)).catch(()=>{});else return o(e).then(c=>c.output)}destroy(){var e,n,r;(r=(n=(e=this.config)==null?void 0:e.requestHandler)==null?void 0:n.destroy)==null||r.call(n),delete this.handlers}}const Pf="***SensitiveInformation***";function Qp(t,e){if(e==null)return e;const n=Zo.of(t);if(n.getMergedTraits().sensitive)return Pf;if(n.isListSchema()){if(!!n.getValueSchema().getMergedTraits().sensitive)return Pf}else if(n.isMapSchema()){if(!!n.getKeySchema().getMergedTraits().sensitive||!!n.getValueSchema().getMergedTraits().sensitive)return Pf}else if(n.isStructSchema()&&typeof e=="object"){const r=e,s={};for(const[i,a]of n.structIterator())r[i]!=null&&(s[i]=Qp(a,r[i]));return s}return e}class Xg{constructor(){p(this,"middlewareStack",Al());p(this,"schema")}static classBuilder(){return new g6}resolveMiddlewareWithContext(e,n,r,{middlewareFn:s,clientName:i,commandName:a,inputFilterSensitiveLog:o,outputFilterSensitiveLog:c,smithyContext:u,additionalContext:l,CommandCtor:d}){for(const _ of s.bind(this)(d,e,n,r))this.middlewareStack.use(_);const h=e.concat(this.middlewareStack),{logger:f}=n,m={logger:f,clientName:i,commandName:a,inputFilterSensitiveLog:o,outputFilterSensitiveLog:c,[Zp]:{commandInstance:this,...u},...l},{requestHandler:g}=n;return h.resolve(_=>g.handle(_.request,r||{}),m)}}class g6{constructor(){p(this,"_init",()=>{});p(this,"_ep",{});p(this,"_middlewareFn",()=>[]);p(this,"_commandName","");p(this,"_clientName","");p(this,"_additionalContext",{});p(this,"_smithyContext",{});p(this,"_inputFilterSensitiveLog");p(this,"_outputFilterSensitiveLog");p(this,"_serializer",null);p(this,"_deserializer",null);p(this,"_operationSchema")}init(e){this._init=e}ep(e){return this._ep=e,this}m(e){return this._middlewareFn=e,this}s(e,n,r={}){return this._smithyContext={service:e,operation:n,...r},this}c(e={}){return this._additionalContext=e,this}n(e,n){return this._clientName=e,this._commandName=n,this}f(e=r=>r,n=r=>r){return this._inputFilterSensitiveLog=e,this._outputFilterSensitiveLog=n,this}ser(e){return this._serializer=e,this}de(e){return this._deserializer=e,this}sc(e){return this._operationSchema=e,this._smithyContext.operationSchema=e,this}build(){const e=this;let n;return n=class extends Xg{constructor(...[s]){super();p(this,"input");p(this,"serialize",e._serializer);p(this,"deserialize",e._deserializer);this.input=s??{},e._init(this),this.schema=e._operationSchema}static getEndpointParameterInstructions(){return e._ep}resolveMiddleware(s,i,a){const o=e._operationSchema,c=(o==null?void 0:o[4])??(o==null?void 0:o.input),u=(o==null?void 0:o[5])??(o==null?void 0:o.output);return this.resolveMiddlewareWithContext(s,i,a,{CommandCtor:n,middlewareFn:e._middlewareFn,clientName:e._clientName,commandName:e._commandName,inputFilterSensitiveLog:e._inputFilterSensitiveLog??(o?Qp.bind(null,c):l=>l),outputFilterSensitiveLog:e._outputFilterSensitiveLog??(o?Qp.bind(null,u):l=>l),smithyContext:e._smithyContext,additionalContext:e._additionalContext})}}}}const gs="***SensitiveInformation***";class ca extends Error{constructor(n){super(n.message);p(this,"$fault");p(this,"$response");p(this,"$retryable");p(this,"$metadata");Object.setPrototypeOf(this,Object.getPrototypeOf(this).constructor.prototype),this.name=n.name,this.$fault=n.$fault,this.$metadata=n.$metadata}static isInstance(n){if(!n)return!1;const r=n;return ca.prototype.isPrototypeOf(r)||!!r.$fault&&!!r.$metadata&&(r.$fault==="client"||r.$fault==="server")}static[Symbol.hasInstance](n){if(!n)return!1;const r=n;return this===ca?ca.isInstance(n):ca.isInstance(n)?r.name&&this.name?this.prototype.isPrototypeOf(n)||r.name===this.name:this.prototype.isPrototypeOf(n):!1}}const Gn=(t,e={})=>{Object.entries(e).filter(([,r])=>r!==void 0).forEach(([r,s])=>{(t[r]==null||t[r]==="")&&(t[r]=s)});const n=t.message||t.Message||"UnknownError";return t.message=n,delete t.Message,t},y6=({output:t,parsedBody:e,exceptionCtor:n,errorCode:r})=>{const s=w6(t),i=s.httpStatusCode?s.httpStatusCode+"":void 0,a=new n({name:(e==null?void 0:e.code)||(e==null?void 0:e.Code)||r||i||"UnknownError",$fault:"client",$metadata:s});throw Gn(a,e)},_6=t=>({output:e,parsedBody:n,errorCode:r})=>{y6({output:e,parsedBody:n,exceptionCtor:t,errorCode:r})},w6=t=>({httpStatusCode:t.statusCode,requestId:t.headers["x-amzn-requestid"]??t.headers["x-amzn-request-id"]??t.headers["x-amz-request-id"],extendedRequestId:t.headers["x-amz-id-2"],cfId:t.headers["x-amz-cf-id"]}),b6=t=>{switch(t){case"standard":return{retryMode:"standard",connectionTimeout:3100};case"in-region":return{retryMode:"standard",connectionTimeout:1100};case"cross-region":return{retryMode:"standard",connectionTimeout:3100};case"mobile":return{retryMode:"standard",connectionTimeout:3e4};default:return{}}},v6=t=>{const e=[];for(const n in vl){const r=vl[n];t[r]!==void 0&&e.push({algorithmId:()=>r,checksumConstructor:()=>t[r]})}return{addChecksumAlgorithm(n){e.push(n)},checksumAlgorithms(){return e}}},E6=t=>{const e={};return t.checksumAlgorithms().forEach(n=>{e[n.algorithmId()]=n.checksumConstructor()}),e},S6=t=>({setRetryStrategy(e){t.retryStrategy=e},retryStrategy(){return t.retryStrategy}}),x6=t=>{const e={};return e.retryStrategy=t.retryStrategy(),e},T6=t=>Object.assign(v6(t),S6(t)),A6=t=>Object.assign(E6(t),x6(t));class FA{trace(){}debug(){}info(){}warn(){}error(){}}function $n(t,e,n){let r,s;r={},s=t;for(const i of Object.keys(s)){if(!Array.isArray(s[i])){r[i]=s[i];continue}zA(r,null,s,i)}return r}const xe=(t,e)=>{const n={};for(const r in e)zA(n,t,e,r);return n},zA=(t,e,n,r)=>{if(e!==null){let a=n[r];typeof a=="function"&&(a=[,a]);const[o=C6,c=k6,u=r]=a;(typeof o=="function"&&o(e[u])||typeof o!="function"&&o)&&(t[r]=c(e[u]));return}let[s,i]=n[r];if(typeof i=="function"){let a;const o=s===void 0&&(a=i())!=null,c=typeof s=="function"&&!!s(void 0)||typeof s!="function"&&!!s;o?t[r]=a:c&&(t[r]=i())}else{const a=s===void 0&&i!=null,o=typeof s=="function"&&!!s(i)||typeof s!="function"&&!!s;(a||o)&&(t[r]=i)}},C6=t=>t!=null,k6=t=>t,Yb=t=>{if(t!==t)return"NaN";switch(t){case 1/0:return"Infinity";case-1/0:return"-Infinity";default:return t}},te=t=>{if(t==null)return{};if(Array.isArray(t))return t.filter(e=>e!=null).map(te);if(typeof t=="object"){const e={};for(const n of Object.keys(t))t[n]!=null&&(e[n]=te(t[n]));return e}return t},I6=(t,e)=>jj(t,e).then(n=>((e==null?void 0:e.utf8Encoder)??Gg)(n)),Wn=(t,e)=>I6(t,e).then(n=>{if(n.length)try{return JSON.parse(n)}catch(r){throw(r==null?void 0:r.name)==="SyntaxError"&&Object.defineProperty(r,"$responseBodyText",{value:n}),r}return{}}),R6=async(t,e)=>{const n=await Wn(t,e);return n.message=n.message??n.Message,n},O6=(t,e)=>{const n=(i,a)=>Object.keys(i).find(o=>o.toLowerCase()===a.toLowerCase()),r=i=>{let a=i;return typeof a=="number"&&(a=a.toString()),a.indexOf(",")>=0&&(a=a.split(",")[0]),a.indexOf(":")>=0&&(a=a.split(":")[0]),a.indexOf("#")>=0&&(a=a.split("#")[1]),a},s=n(t.headers,"x-amzn-errortype");if(s!==void 0)return r(t.headers[s]);if(e&&typeof e=="object"){const i=n(e,"code");if(i&&e[i]!==void 0)return r(e[i]);if(e.__type!==void 0)return r(e.__type)}},ar=t=>{if(t!=null)return typeof t=="object"&&"__type"in t&&delete t.__type,Jj(t)},$6=/\d{12}\.ddb/;async function N6(t,e,n){var i,a,o,c,u,l,d;const r=n.request;if(((i=r==null?void 0:r.headers)==null?void 0:i["smithy-protocol"])==="rpc-v2-cbor"&&kr(t,"PROTOCOL_RPC_V2_CBOR","M"),typeof e.retryStrategy=="function"){const h=await e.retryStrategy();typeof h.acquireInitialRetryToken=="function"?(o=(a=h.constructor)==null?void 0:a.name)!=null&&o.includes("Adaptive")?kr(t,"RETRY_MODE_ADAPTIVE","F"):kr(t,"RETRY_MODE_STANDARD","E"):kr(t,"RETRY_MODE_LEGACY","D")}if(typeof e.accountIdEndpointMode=="function"){const h=t.endpointV2;switch(String((c=h==null?void 0:h.url)==null?void 0:c.hostname).match($6)&&kr(t,"ACCOUNT_ID_ENDPOINT","O"),await((u=e.accountIdEndpointMode)==null?void 0:u.call(e))){case"disabled":kr(t,"ACCOUNT_ID_MODE_DISABLED","Q");break;case"preferred":kr(t,"ACCOUNT_ID_MODE_PREFERRED","P");break;case"required":kr(t,"ACCOUNT_ID_MODE_REQUIRED","R");break}}const s=(d=(l=t.__smithy_context)==null?void 0:l.selectedHttpAuthScheme)==null?void 0:d.identity;if(s!=null&&s.$source){const h=s;h.accountId&&kr(t,"RESOLVED_ACCOUNT_ID","T");for(const[f,m]of Object.entries(h.$source??{}))kr(t,f,m)}}const Qb="user-agent",Lf="x-amz-user-agent",e0=" ",Mf="/",P6=/[^\!\$\%\&\'\*\+\-\.\^\_\`\|\~\d\w]/g,L6=/[^\!\$\%\&\'\*\+\-\.\^\_\`\|\~\d\w\#]/g,t0="-",M6=1024;function D6(t){let e="";for(const n in t){const r=t[n];if(e.length+r.length+1<=M6){e.length?e+=","+r:e+=r;continue}break}return e}const U6=t=>(e,n)=>async r=>{var f,m,g,_;const{request:s}=r;if(!Rn.isInstance(s))return e(r);const{headers:i}=s,a=((f=n==null?void 0:n.userAgent)==null?void 0:f.map(Qc))||[],o=(await t.defaultUserAgentProvider()).map(Qc);await N6(n,t,r);const c=n;o.push(`m/${D6(Object.assign({},(m=n.__smithy_context)==null?void 0:m.features,(g=c.__aws_sdk_context)==null?void 0:g.features))}`);const u=((_=t==null?void 0:t.customUserAgent)==null?void 0:_.map(Qc))||[],l=await t.userAgentAppId();l&&o.push(Qc([`app/${l}`]));const d=[].concat([...o,...a,...u]).join(e0),h=[...o.filter(b=>b.startsWith("aws-sdk-")),...u].join(e0);return t.runtime!=="browser"?(h&&(i[Lf]=i[Lf]?`${i[Qb]} ${h}`:h),i[Qb]=d):i[Lf]=d,e({...r,request:s})},Qc=t=>{var a;const e=t[0].split(Mf).map(o=>o.replace(P6,t0)).join(Mf),n=(a=t[1])==null?void 0:a.replace(L6,t0),r=e.indexOf(Mf),s=e.substring(0,r);let i=e.substring(r+1);return s==="api"&&(i=i.toLowerCase()),[s,i,n].filter(o=>o&&o.length>0).reduce((o,c,u)=>{switch(u){case 0:return c;case 1:return`${o}/${c}`;default:return`${o}#${c}`}},"")},B6={name:"getUserAgentMiddleware",step:"build",priority:"low",tags:["SET_USER_AGENT","USER_AGENT"],override:!0},j6=t=>({applyToStack:e=>{e.add(U6(t),B6)}});function F6(t,e,n,r){function s(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function o(l){try{u(r.next(l))}catch(d){a(d)}}function c(l){try{u(r.throw(l))}catch(d){a(d)}}function u(l){l.done?i(l.value):s(l.value).then(o,c)}u((r=r.apply(t,e||[])).next())})}function z6(t,e){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,s,i,a=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(u){return function(l){return c([u,l])}}function c(u){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(n=0)),n;)try{if(r=1,s&&(i=u[0]&2?s.return:u[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,u[1])).done)return i;switch(s=0,i&&(u=[u[0]&2,i.value]),u[0]){case 0:case 1:i=u;break;case 4:return n.label++,{value:u[1],done:!1};case 5:n.label++,s=u[1],u=[0];continue;case 7:u=n.ops.pop(),n.trys.pop();continue;default:if(i=n.trys,!(i=i.length>0&&i[i.length-1])&&(u[0]===6||u[0]===2)){n=0;continue}if(u[0]===3&&(!i||u[1]>i[0]&&u[1]<i[3])){n.label=u[1];break}if(u[0]===6&&n.label<i[1]){n.label=i[1],i=u;break}if(i&&n.label<i[2]){n.label=i[2],n.ops.push(u);break}i[2]&&n.ops.pop(),n.trys.pop();continue}u=e.call(t,n)}catch(l){u=[6,l],s=0}finally{r=i=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function V6(t){var e=typeof Symbol=="function"&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}const q6=t=>new TextEncoder().encode(t);var H6=typeof Kt<"u"&&Kt.from?function(t){return Kt.from(t,"utf8")}:q6;function Xo(t){return t instanceof Uint8Array?t:typeof t=="string"?H6(t):ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength/Uint8Array.BYTES_PER_ELEMENT):new Uint8Array(t)}function em(t){return typeof t=="string"?t.length===0:t.byteLength===0}function G6(t){if(!Uint32Array.from){for(var e=new Uint32Array(t.length),n=0;n<t.length;)e[n]=t[n],n+=1;return e}return Uint32Array.from(t)}var VA=(function(){function t(){this.checksum=4294967295}return t.prototype.update=function(e){var n,r;try{for(var s=V6(e),i=s.next();!i.done;i=s.next()){var a=i.value;this.checksum=this.checksum>>>8^J6[(this.checksum^a)&255]}}catch(o){n={error:o}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return this},t.prototype.digest=function(){return(this.checksum^4294967295)>>>0},t})(),W6=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],J6=G6(W6);class vo{constructor(e){p(this,"bytes");if(this.bytes=e,e.byteLength!==8)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(e){if(e>9223372036854776e3||e<-9223372036854776e3)throw new Error(`${e} is too large (or, if negative, too small) to represent as an Int64`);const n=new Uint8Array(8);for(let r=7,s=Math.abs(Math.round(e));r>-1&&s>0;r--,s/=256)n[r]=s;return e<0&&n0(n),new vo(n)}valueOf(){const e=this.bytes.slice(0),n=e[0]&128;return n&&n0(e),parseInt(jn(e),16)*(n?-1:1)}toString(){return String(this.valueOf())}}function n0(t){for(let e=0;e<8;e++)t[e]^=255;for(let e=7;e>-1&&(t[e]++,t[e]===0);e--);}class Z6{constructor(e,n){p(this,"toUtf8");p(this,"fromUtf8");this.toUtf8=e,this.fromUtf8=n}format(e){const n=[];for(const i of Object.keys(e)){const a=this.fromUtf8(i);n.push(Uint8Array.from([a.byteLength]),a,this.formatHeaderValue(e[i]))}const r=new Uint8Array(n.reduce((i,a)=>i+a.byteLength,0));let s=0;for(const i of n)r.set(i,s),s+=i.byteLength;return r}formatHeaderValue(e){switch(e.type){case"boolean":return Uint8Array.from([e.value?0:1]);case"byte":return Uint8Array.from([2,e.value]);case"short":const n=new DataView(new ArrayBuffer(3));return n.setUint8(0,3),n.setInt16(1,e.value,!1),new Uint8Array(n.buffer);case"integer":const r=new DataView(new ArrayBuffer(5));return r.setUint8(0,4),r.setInt32(1,e.value,!1),new Uint8Array(r.buffer);case"long":const s=new Uint8Array(9);return s[0]=5,s.set(e.value.bytes,1),s;case"binary":const i=new DataView(new ArrayBuffer(3+e.value.byteLength));i.setUint8(0,6),i.setUint16(1,e.value.byteLength,!1);const a=new Uint8Array(i.buffer);return a.set(e.value,3),a;case"string":const o=this.fromUtf8(e.value),c=new DataView(new ArrayBuffer(3+o.byteLength));c.setUint8(0,7),c.setUint16(1,o.byteLength,!1);const u=new Uint8Array(c.buffer);return u.set(o,3),u;case"timestamp":const l=new Uint8Array(9);return l[0]=8,l.set(vo.fromNumber(e.value.valueOf()).bytes,1),l;case"uuid":if(!s3.test(e.value))throw new Error(`Invalid UUID received: ${e.value}`);const d=new Uint8Array(17);return d[0]=9,d.set(Wg(e.value.replace(/\-/g,"")),1),d}}parse(e){const n={};let r=0;for(;r<e.byteLength;){const s=e.getUint8(r++),i=this.toUtf8(new Uint8Array(e.buffer,e.byteOffset+r,s));switch(r+=s,e.getUint8(r++)){case 0:n[i]={type:s0,value:!0};break;case 1:n[i]={type:s0,value:!1};break;case 2:n[i]={type:K6,value:e.getInt8(r++)};break;case 3:n[i]={type:X6,value:e.getInt16(r,!1)},r+=2;break;case 4:n[i]={type:Y6,value:e.getInt32(r,!1)},r+=4;break;case 5:n[i]={type:Q6,value:new vo(new Uint8Array(e.buffer,e.byteOffset+r,8))},r+=8;break;case 6:const a=e.getUint16(r,!1);r+=2,n[i]={type:e3,value:new Uint8Array(e.buffer,e.byteOffset+r,a)},r+=a;break;case 7:const o=e.getUint16(r,!1);r+=2,n[i]={type:t3,value:this.toUtf8(new Uint8Array(e.buffer,e.byteOffset+r,o))},r+=o;break;case 8:n[i]={type:n3,value:new Date(new vo(new Uint8Array(e.buffer,e.byteOffset+r,8)).valueOf())},r+=8;break;case 9:const c=new Uint8Array(e.buffer,e.byteOffset+r,16);r+=16,n[i]={type:r3,value:`${jn(c.subarray(0,4))}-${jn(c.subarray(4,6))}-${jn(c.subarray(6,8))}-${jn(c.subarray(8,10))}-${jn(c.subarray(10))}`};break;default:throw new Error("Unrecognized header type tag")}}return n}}var r0;(function(t){t[t.boolTrue=0]="boolTrue",t[t.boolFalse=1]="boolFalse",t[t.byte=2]="byte",t[t.short=3]="short",t[t.integer=4]="integer",t[t.long=5]="long",t[t.byteArray=6]="byteArray",t[t.string=7]="string",t[t.timestamp=8]="timestamp",t[t.uuid=9]="uuid"})(r0||(r0={}));const s0="boolean",K6="byte",X6="short",Y6="integer",Q6="long",e3="binary",t3="string",n3="timestamp",r3="uuid",s3=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/,qA=4,Cs=qA*2,ni=4,i3=Cs+ni*2;function a3({byteLength:t,byteOffset:e,buffer:n}){if(t<i3)throw new Error("Provided message too short to accommodate event stream message overhead");const r=new DataView(n,e,t),s=r.getUint32(0,!1);if(t!==s)throw new Error("Reported message length does not match received message length");const i=r.getUint32(qA,!1),a=r.getUint32(Cs,!1),o=r.getUint32(t-ni,!1),c=new VA().update(new Uint8Array(n,e,Cs));if(a!==c.digest())throw new Error(`The prelude checksum specified in the message (${a}) does not match the calculated CRC32 checksum (${c.digest()})`);if(c.update(new Uint8Array(n,e+Cs,t-(Cs+ni))),o!==c.digest())throw new Error(`The message checksum (${c.digest()}) did not match the expected value of ${o}`);return{headers:new DataView(n,e+Cs+ni,i),body:new Uint8Array(n,e+Cs+ni+i,s-i-(Cs+ni+ni))}}class HA{constructor(e,n){p(this,"headerMarshaller");p(this,"messageBuffer");p(this,"isEndOfStream");this.headerMarshaller=new Z6(e,n),this.messageBuffer=[],this.isEndOfStream=!1}feed(e){this.messageBuffer.push(this.decode(e))}endOfStream(){this.isEndOfStream=!0}getMessage(){const e=this.messageBuffer.pop(),n=this.isEndOfStream;return{getMessage(){return e},isEndOfStream(){return n}}}getAvailableMessages(){const e=this.messageBuffer;this.messageBuffer=[];const n=this.isEndOfStream;return{getMessages(){return e},isEndOfStream(){return n}}}encode({headers:e,body:n}){const r=this.headerMarshaller.format(e),s=r.byteLength+n.byteLength+16,i=new Uint8Array(s),a=new DataView(i.buffer,i.byteOffset,i.byteLength),o=new VA;return a.setUint32(0,s,!1),a.setUint32(4,r.byteLength,!1),a.setUint32(8,o.update(i.subarray(0,8)).digest(),!1),i.set(r,12),i.set(n,r.byteLength+12),a.setUint32(s-4,o.update(i.subarray(8,s-4)).digest(),!1),i}decode(e){const{headers:n,body:r}=a3(e);return{headers:this.headerMarshaller.parse(n),body:r}}formatHeaders(e){return this.headerMarshaller.format(e)}}class o3{constructor(e){p(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.inputStream)yield this.options.decoder.decode(e)}}class c3{constructor(e){p(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.messageStream)yield this.options.encoder.encode(e);this.options.includeEndFrame&&(yield new Uint8Array(0))}}class u3{constructor(e){p(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.messageStream){const n=await this.options.deserializer(e);n!==void 0&&(yield n)}}}class l3{constructor(e){p(this,"options");this.options=e}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const e of this.options.inputStream)yield this.options.serializer(e)}}const d3=(t,e,n,r)=>{let s=t;const i={start(){},async transform(a,o){try{const c=new Date(Date.now()+await r()),u={":date":{type:"timestamp",value:c}},l=await e.sign({message:{body:a,headers:u},priorSignature:s},{signingDate:c});s=l.signature;const d=n.encode({headers:{...u,":chunk-signature":{type:"binary",value:Wg(l.signature)}},body:a});o.enqueue(d)}catch(c){o.error(c)}}};return new TransformStream({...i})};class h3{constructor(e){p(this,"messageSigner");p(this,"eventStreamCodec");p(this,"systemClockOffsetProvider");this.messageSigner=e.messageSigner,this.eventStreamCodec=new HA(e.utf8Encoder,e.utf8Decoder),this.systemClockOffsetProvider=async()=>e.systemClockOffset??0}async handle(e,n,r={}){const s=n.request,{body:i,headers:a,query:o}=s;if(!(i instanceof ReadableStream))throw new Error("Eventstream payload must be a ReadableStream.");const c=new TransformStream;s.body=c.readable;let u;try{u=await e(n)}catch(m){throw s.body.cancel(),m}const d=((a.authorization||"").match(/Signature=([\w]+)$/)||[])[1]||o&&o["X-Amz-Signature"]||"",h=d3(d,await this.messageSigner(),this.eventStreamCodec,this.systemClockOffsetProvider);return i.pipeThrough(h).pipeThrough(c),u}}const f3=t=>new h3(t),GA=t=>t.protocol==="ws:"||t.protocol==="wss:";class p3{constructor(e){p(this,"signer");this.signer=e.signer}presign(e,n={}){return this.signer.presign(e,n)}async sign(e,n){return Rn.isInstance(e)&&GA(e)?{...await this.signer.presign({...e,body:""},{...n,expiresIn:60,unsignableHeaders:new Set(Object.keys(e.headers).filter(s=>s!=="host"))}),body:e.body}:this.signer.sign(e,n)}}const m3=t=>{const{signer:e}=t;return Object.assign(t,{signer:async n=>{const r=await e(n);if(g3(r))return new p3({signer:r});throw new Error("Expected WebsocketSignatureV4 signer, please check the client constructor.")}})},g3=t=>!!t;function y3(t){const{port:e,query:n}=t;let{protocol:r,path:s,hostname:i}=t;r&&r.slice(-1)!==":"&&(r+=":"),e&&(i+=`:${e}`),s&&s.charAt(0)!=="/"&&(s=`/${s}`);let a=n?mA(n):"";a&&a[0]!=="?"&&(a=`?${a}`);let o="";if(t.username!=null||t.password!=null){const u=t.username??"",l=t.password??"";o=`${u}:${l}@`}let c="";return t.fragment&&(c=`#${t.fragment}`),`${r}//${o}${i}${s}${a}${c}`}function _3(t){let e=0,n=0,r=null,s=null;const i=o=>{if(typeof o!="number")throw new Error("Attempted to allocate an event message where size was not a number: "+o);e=o,n=4,r=new Uint8Array(o),new DataView(r.buffer).setUint32(0,o,!1)},a=async function*(){const o=t[Symbol.asyncIterator]();for(;;){const{value:c,done:u}=await o.next();if(u){if(e)if(e===n)yield r;else throw new Error("Truncated event message received.");else return;return}const l=c.length;let d=0;for(;d<l;){if(!r){const f=l-d;s||(s=new Uint8Array(4));const m=Math.min(4-n,f);if(s.set(c.slice(d,d+m),n),n+=m,d+=m,n<4)break;i(new DataView(s.buffer).getUint32(0,!1)),s=null}const h=Math.min(e-n,l-d);r.set(c.slice(d,d+h),n),n+=h,d+=h,e&&e===n&&(yield r,r=null,e=0,n=0)}}};return{[Symbol.asyncIterator]:a}}function w3(t,e){return async function(n){const{value:r}=n.headers[":message-type"];if(r==="error"){const s=new Error(n.headers[":error-message"].value||"UnknownError");throw s.name=n.headers[":error-code"].value,s}else if(r==="exception"){const s=n.headers[":exception-type"].value,i={[s]:n},a=await t(i);if(a.$unknown){const o=new Error(e(n.body));throw o.name=s,o}throw a[s]}else if(r==="event"){const s={[n.headers[":event-type"].value]:n},i=await t(s);return i.$unknown?void 0:i}else throw Error(`Unrecognizable event type: ${n.headers[":event-type"].value}`)}}let b3=class{constructor({utf8Encoder:e,utf8Decoder:n}){p(this,"eventStreamCodec");p(this,"utfEncoder");this.eventStreamCodec=new HA(e,n),this.utfEncoder=e}deserialize(e,n){const r=_3(e);return new u3({messageStream:new o3({inputStream:r,decoder:this.eventStreamCodec}),deserializer:w3(n,this.utfEncoder)})}serialize(e,n){return new c3({messageStream:new l3({inputStream:e,serializer:n}),encoder:this.eventStreamCodec,includeEndFrame:!0})}};const WA=t=>({[Symbol.asyncIterator]:async function*(){const e=t.getReader();try{for(;;){const{done:n,value:r}=await e.read();if(n)return;yield r}}finally{e.releaseLock()}}}),JA=t=>{const e=t[Symbol.asyncIterator]();return new ReadableStream({async pull(n){const{done:r,value:s}=await e.next();if(r)return n.close();n.enqueue(s)}})};class v3{constructor({utf8Encoder:e,utf8Decoder:n}){p(this,"universalMarshaller");this.universalMarshaller=new b3({utf8Decoder:n,utf8Encoder:e})}deserialize(e,n){const r=E3(e)?WA(e):e;return this.universalMarshaller.deserialize(r,n)}serialize(e,n){const r=this.universalMarshaller.serialize(e,n);return typeof ReadableStream=="function"?JA(r):r}}const E3=t=>typeof ReadableStream=="function"&&t instanceof ReadableStream,S3=t=>new v3(t),x3=2e3;class Yg{constructor(e,n=new Jo){p(this,"metadata",{handlerProtocol:"websocket/h1.1"});p(this,"config");p(this,"configPromise");p(this,"httpHandler");p(this,"sockets",{});this.httpHandler=n,typeof e=="function"?(this.config={},this.configPromise=e().then(r=>this.config=r??{})):(this.config=e??{},this.configPromise=Promise.resolve(this.config))}static create(e,n=new Jo){return typeof(e==null?void 0:e.handle)=="function"?e:new Yg(e,n)}destroy(){for(const[e,n]of Object.entries(this.sockets)){for(const r of n)r.close(1e3,"Socket closed through destroy() call");delete this.sockets[e]}}async handle(e){if(!GA(e))return this.httpHandler.handle(e);const n=y3(e),r=new WebSocket(n);this.sockets[n]||(this.sockets[n]=[]),this.sockets[n].push(r),r.binaryType="arraybuffer",this.config=await this.configPromise;const{connectionTimeout:s=x3}=this.config;await this.waitForReady(r,s);const{body:i}=e,a=T3(i),o=this.connect(r,a),c=A3(o);return{response:new Ca({statusCode:200,body:c})}}updateHttpClientConfig(e,n){this.configPromise=this.configPromise.then(r=>(r[e]=n,r))}httpHandlerConfigs(){return this.config??{}}removeNotUsableSockets(e){this.sockets[e]=(this.sockets[e]??[]).filter(n=>![WebSocket.CLOSING,WebSocket.CLOSED].includes(n.readyState))}waitForReady(e,n){return new Promise((r,s)=>{const i=setTimeout(()=>{this.removeNotUsableSockets(e.url),s({$metadata:{httpStatusCode:500}})},n);e.onopen=()=>{clearTimeout(i),r()}})}connect(e,n){let r,s=!1,i=()=>{},a=()=>{};e.onmessage=u=>{a({done:!1,value:new Uint8Array(u.data)})},e.onerror=u=>{s=!0,e.close(),i(u)},e.onclose=()=>{this.removeNotUsableSockets(e.url),!s&&(r?i(r):a({done:!0,value:void 0}))};const o={[Symbol.asyncIterator]:()=>({next:()=>new Promise((u,l)=>{a=u,i=l})})};return(async()=>{try{for await(const u of n)e.send(u)}catch(u){r=u}finally{e.close(1e3)}})(),o}}const T3=t=>t[Symbol.asyncIterator]?t:C3(t)?WA(t):{[Symbol.asyncIterator]:async function*(){yield t}},A3=t=>typeof ReadableStream=="function"?JA(t):t,C3=t=>typeof ReadableStream=="function"&&t instanceof ReadableStream,k3=!1,I3=!1,i0=new Set,R3=(t,e=gd)=>{if(!i0.has(t)&&!e(t))throw new Error(`Region not accepted: region="${t}" is not a valid hostname component.`);i0.add(t)},ZA=t=>typeof t=="string"&&(t.startsWith("fips-")||t.endsWith("-fips")),O3=t=>ZA(t)?["fips-aws-global","aws-fips"].includes(t)?"us-east-1":t.replace(/fips-(dkr-|prod-)?|-fips/,""):t,$3=t=>{const{region:e,useFipsEndpoint:n}=t;if(!e)throw new Error("Region is missing");return Object.assign(t,{region:async()=>{const r=typeof e=="function"?await e():e,s=O3(r);return R3(s),s},useFipsEndpoint:async()=>{const r=typeof e=="string"?e:await e();return ZA(r)?!0:typeof n!="function"?Promise.resolve(!!n):n()}})},N3=t=>Object.assign(t,{eventStreamMarshaller:t.eventStreamSerdeProvider(t)}),a0="content-length";function P3(t){return e=>async n=>{const r=n.request;if(Rn.isInstance(r)){const{body:s,headers:i}=r;if(s&&Object.keys(i).map(a=>a.toLowerCase()).indexOf(a0)===-1)try{const a=t(s);r.headers={...r.headers,[a0]:String(a)}}catch{}}return e({...n,request:r})}}const L3={step:"build",tags:["SET_CONTENT_LENGTH","CONTENT_LENGTH"],name:"contentLengthMiddleware",override:!0},M3=t=>({applyToStack:e=>{e.add(P3(t.bodyLengthChecker),L3)}}),D3=async t=>{const e=(t==null?void 0:t.Bucket)||"";if(typeof t.Bucket=="string"&&(t.Bucket=e.replace(/#/g,encodeURIComponent("#")).replace(/\?/g,encodeURIComponent("?"))),z3(e)){if(t.ForcePathStyle===!0)throw new Error("Path-style addressing cannot be used with ARN buckets")}else(!F3(e)||e.indexOf(".")!==-1&&!String(t.Endpoint).startsWith("http:")||e.toLowerCase()!==e||e.length<3)&&(t.ForcePathStyle=!0);return t.DisableMultiRegionAccessPoints&&(t.disableMultiRegionAccessPoints=!0,t.DisableMRAP=!0),t},U3=/^[a-z0-9][a-z0-9\.\-]{1,61}[a-z0-9]$/,B3=/(\d+\.){3}\d+/,j3=/\.\./,F3=t=>U3.test(t)&&!B3.test(t)&&!j3.test(t),z3=t=>{const[e,n,r,,,s]=t.split(":"),i=e==="arn"&&t.split(":").length>=6,a=!!(i&&n&&r&&s);if(i&&!a)throw new Error(`Invalid ARN: ${t} was an invalid ARN.`);return a},V3=(t,e,n)=>{const r=async()=>{const s=n[t]??n[e];return typeof s=="function"?s():s};return t==="credentialScope"||e==="CredentialScope"?async()=>{const s=typeof n.credentials=="function"?await n.credentials():n.credentials;return(s==null?void 0:s.credentialScope)??(s==null?void 0:s.CredentialScope)}:t==="accountId"||e==="AccountId"?async()=>{const s=typeof n.credentials=="function"?await n.credentials():n.credentials;return(s==null?void 0:s.accountId)??(s==null?void 0:s.AccountId)}:t==="endpoint"||e==="endpoint"?async()=>{if(n.isCustomEndpoint===!1)return;const s=await r();if(s&&typeof s=="object"){if("url"in s)return s.url.href;if("hostname"in s){const{protocol:i,hostname:a,port:o,path:c}=s;return`${i}//${a}${o?":"+o:""}${c}`}}return s}:r},KA=async t=>{},XA=t=>typeof t=="object"?"url"in t?Tl(t.url):t:Tl(t),q3=async(t,e,n,r)=>{if(!n.isCustomEndpoint){let a;n.serviceConfiguredEndpoint?a=await n.serviceConfiguredEndpoint():a=await KA(n.serviceId),a&&(n.endpoint=()=>Promise.resolve(XA(a)),n.isCustomEndpoint=!0)}const s=await H3(t,e,n);if(typeof n.endpointProvider!="function")throw new Error("config.endpointProvider is not set.");return n.endpointProvider(s,r)},H3=async(t,e,n)=>{var i;const r={},s=((i=e==null?void 0:e.getEndpointParameterInstructions)==null?void 0:i.call(e))||{};for(const[a,o]of Object.entries(s))switch(o.type){case"staticContextParams":r[a]=o.value;break;case"contextParams":r[a]=t[o.name];break;case"clientContextParams":case"builtInParams":r[a]=await V3(o.name,a,n)();break;case"operationContextParams":r[a]=o.get(t);break;default:throw new Error("Unrecognized endpoint parameter instruction: "+JSON.stringify(o))}return Object.keys(s).length===0&&Object.assign(r,n),String(n.serviceId).toLowerCase()==="s3"&&await D3(r),r},G3=({config:t,instructions:e})=>(n,r)=>async s=>{var o,c,u;t.isCustomEndpoint&&Qj(r,"ENDPOINT_OVERRIDE","N");const i=await q3(s.input,{getEndpointParameterInstructions(){return e}},{...t},r);r.endpointV2=i,r.authSchemes=(o=i.properties)==null?void 0:o.authSchemes;const a=(c=r.authSchemes)==null?void 0:c[0];if(a){r.signing_region=a.signingRegion,r.signing_service=a.signingName;const l=md(r),d=(u=l==null?void 0:l.selectedHttpAuthScheme)==null?void 0:u.httpAuthOption;d&&(d.signingProperties=Object.assign(d.signingProperties||{},{signing_region:a.signingRegion,signingRegion:a.signingRegion,signing_service:a.signingName,signingName:a.signingName,signingRegionSet:a.signingRegionSet},a.properties))}return n({...s})},W3={step:"serialize",tags:["ENDPOINT_PARAMETERS","ENDPOINT_V2","ENDPOINT"],name:"endpointV2Middleware",override:!0,relation:"before",toMiddleware:dA.name},YA=(t,e)=>({applyToStack:n=>{n.addRelativeTo(G3({config:t,instructions:e}),W3)}}),J3=t=>{const e=t.tls??!0,{endpoint:n,useDualstackEndpoint:r,useFipsEndpoint:s}=t,i=n!=null?async()=>XA(await hs(n)()):void 0,o=Object.assign(t,{endpoint:i,tls:e,isCustomEndpoint:!!n,useDualstackEndpoint:hs(r??!1),useFipsEndpoint:hs(s??!1)});let c;return o.serviceConfiguredEndpoint=async()=>(t.serviceId&&!c&&(c=KA(t.serviceId)),c),o};var Ia;(function(t){t.STANDARD="standard",t.ADAPTIVE="adaptive"})(Ia||(Ia={}));const Cl=3,Z3=Ia.STANDARD,K3=["BandwidthLimitExceeded","EC2ThrottledException","LimitExceededException","PriorRequestNotComplete","ProvisionedThroughputExceededException","RequestLimitExceeded","RequestThrottled","RequestThrottledException","SlowDown","ThrottledException","Throttling","ThrottlingException","TooManyRequestsException","TransactionInProgressException"],X3=["TimeoutError","RequestTimeout","RequestTimeoutException"],Y3=[500,502,503,504],Q3=["ECONNRESET","ECONNREFUSED","EPIPE","ETIMEDOUT"],e8=["EHOSTUNREACH","ENETUNREACH","ENOTFOUND"],t8=t=>(t==null?void 0:t.$retryable)!==void 0,n8=t=>{var e;return(e=t.$metadata)==null?void 0:e.clockSkewCorrected},r8=t=>{const e=new Set(["Failed to fetch","NetworkError when attempting to fetch resource","The Internet connection appears to be offline","Load failed","Network request failed"]);return t&&t instanceof TypeError?e.has(t.message):!1},QA=t=>{var e,n;return((e=t.$metadata)==null?void 0:e.httpStatusCode)===429||K3.includes(t.name)||((n=t.$retryable)==null?void 0:n.throttling)==!0},Qg=(t,e=0)=>{var n;return t8(t)||n8(t)||X3.includes(t.name)||Q3.includes((t==null?void 0:t.code)||"")||e8.includes((t==null?void 0:t.code)||"")||Y3.includes(((n=t.$metadata)==null?void 0:n.httpStatusCode)||0)||r8(t)||t.cause!==void 0&&e<=10&&Qg(t.cause,e+1)},s8=t=>{var e;if(((e=t.$metadata)==null?void 0:e.httpStatusCode)!==void 0){const n=t.$metadata.httpStatusCode;return 500<=n&&n<=599&&!Qg(t)}return!1},jl=class jl{constructor(e){p(this,"beta");p(this,"minCapacity");p(this,"minFillRate");p(this,"scaleConstant");p(this,"smooth");p(this,"currentCapacity",0);p(this,"enabled",!1);p(this,"lastMaxRate",0);p(this,"measuredTxRate",0);p(this,"requestCount",0);p(this,"fillRate");p(this,"lastThrottleTime");p(this,"lastTimestamp",0);p(this,"lastTxRateBucket");p(this,"maxCapacity");p(this,"timeWindow",0);this.beta=(e==null?void 0:e.beta)??.7,this.minCapacity=(e==null?void 0:e.minCapacity)??1,this.minFillRate=(e==null?void 0:e.minFillRate)??.5,this.scaleConstant=(e==null?void 0:e.scaleConstant)??.4,this.smooth=(e==null?void 0:e.smooth)??.8;const n=this.getCurrentTimeInSeconds();this.lastThrottleTime=n,this.lastTxRateBucket=Math.floor(this.getCurrentTimeInSeconds()),this.fillRate=this.minFillRate,this.maxCapacity=this.minCapacity}getCurrentTimeInSeconds(){return Date.now()/1e3}async getSendToken(){return this.acquireTokenBucket(1)}async acquireTokenBucket(e){if(this.enabled){if(this.refillTokenBucket(),e>this.currentCapacity){const n=(e-this.currentCapacity)/this.fillRate*1e3;await new Promise(r=>jl.setTimeoutFn(r,n))}this.currentCapacity=this.currentCapacity-e}}refillTokenBucket(){const e=this.getCurrentTimeInSeconds();if(!this.lastTimestamp){this.lastTimestamp=e;return}const n=(e-this.lastTimestamp)*this.fillRate;this.currentCapacity=Math.min(this.maxCapacity,this.currentCapacity+n),this.lastTimestamp=e}updateClientSendingRate(e){let n;if(this.updateMeasuredRate(),QA(e)){const s=this.enabled?Math.min(this.measuredTxRate,this.fillRate):this.measuredTxRate;this.lastMaxRate=s,this.calculateTimeWindow(),this.lastThrottleTime=this.getCurrentTimeInSeconds(),n=this.cubicThrottle(s),this.enableTokenBucket()}else this.calculateTimeWindow(),n=this.cubicSuccess(this.getCurrentTimeInSeconds());const r=Math.min(n,2*this.measuredTxRate);this.updateTokenBucketRate(r)}calculateTimeWindow(){this.timeWindow=this.getPrecise(Math.pow(this.lastMaxRate*(1-this.beta)/this.scaleConstant,1/3))}cubicThrottle(e){return this.getPrecise(e*this.beta)}cubicSuccess(e){return this.getPrecise(this.scaleConstant*Math.pow(e-this.lastThrottleTime-this.timeWindow,3)+this.lastMaxRate)}enableTokenBucket(){this.enabled=!0}updateTokenBucketRate(e){this.refillTokenBucket(),this.fillRate=Math.max(e,this.minFillRate),this.maxCapacity=Math.max(e,this.minCapacity),this.currentCapacity=Math.min(this.currentCapacity,this.maxCapacity)}updateMeasuredRate(){const e=this.getCurrentTimeInSeconds(),n=Math.floor(e*2)/2;if(this.requestCount++,n>this.lastTxRateBucket){const r=this.requestCount/(n-this.lastTxRateBucket);this.measuredTxRate=this.getPrecise(r*this.smooth+this.measuredTxRate*(1-this.smooth)),this.requestCount=0,this.lastTxRateBucket=n}}getPrecise(e){return parseFloat(e.toFixed(8))}};p(jl,"setTimeoutFn",setTimeout);let tm=jl;const nm=100,eC=20*1e3,i8=500,o0=500,a8=5,o8=10,c8=1,u8="amz-sdk-invocation-id",l8="amz-sdk-request",d8=()=>{let t=nm;return{computeNextBackoffDelay:r=>Math.floor(Math.min(eC,Math.random()*2**r*t)),setDelayBase:r=>{t=r}}},c0=({retryDelay:t,retryCount:e,retryCost:n})=>({getRetryCount:()=>e,getRetryDelay:()=>Math.min(eC,t),getRetryCost:()=>n});class tC{constructor(e){p(this,"maxAttempts");p(this,"mode",Ia.STANDARD);p(this,"capacity",o0);p(this,"retryBackoffStrategy",d8());p(this,"maxAttemptsProvider");this.maxAttempts=e,this.maxAttemptsProvider=typeof e=="function"?e:async()=>e}async acquireInitialRetryToken(e){return c0({retryDelay:nm,retryCount:0})}async refreshRetryTokenForRetry(e,n){const r=await this.getMaxAttempts();if(this.shouldRetry(e,n,r)){const s=n.errorType;this.retryBackoffStrategy.setDelayBase(s==="THROTTLING"?i8:nm);const i=this.retryBackoffStrategy.computeNextBackoffDelay(e.getRetryCount()),a=n.retryAfterHint?Math.max(n.retryAfterHint.getTime()-Date.now()||0,i):i,o=this.getCapacityCost(s);return this.capacity-=o,c0({retryDelay:a,retryCount:e.getRetryCount()+1,retryCost:o})}throw new Error("No retry token available")}recordSuccess(e){this.capacity=Math.max(o0,this.capacity+(e.getRetryCost()??c8))}getCapacity(){return this.capacity}async getMaxAttempts(){try{return await this.maxAttemptsProvider()}catch{return console.warn(`Max attempts provider could not resolve. Using default of ${Cl}`),Cl}}shouldRetry(e,n,r){return e.getRetryCount()+1<r&&this.capacity>=this.getCapacityCost(n.errorType)&&this.isRetryableError(n.errorType)}getCapacityCost(e){return e==="TRANSIENT"?o8:a8}isRetryableError(e){return e==="THROTTLING"||e==="TRANSIENT"}}class h8{constructor(e,n){p(this,"maxAttemptsProvider");p(this,"rateLimiter");p(this,"standardRetryStrategy");p(this,"mode",Ia.ADAPTIVE);this.maxAttemptsProvider=e;const{rateLimiter:r}=n??{};this.rateLimiter=r??new tm,this.standardRetryStrategy=new tC(e)}async acquireInitialRetryToken(e){return await this.rateLimiter.getSendToken(),this.standardRetryStrategy.acquireInitialRetryToken(e)}async refreshRetryTokenForRetry(e,n){return this.rateLimiter.updateClientSendingRate(n),this.standardRetryStrategy.refreshRetryTokenForRetry(e,n)}recordSuccess(e){this.rateLimiter.updateClientSendingRate({}),this.standardRetryStrategy.recordSuccess(e)}}const f8=t=>t instanceof Error?t:t instanceof Object?Object.assign(new Error,t):typeof t=="string"?new Error(t):new Error(`AWS SDK error wrapper for ${t}`),p8=t=>{const{retryStrategy:e,retryMode:n,maxAttempts:r}=t,s=hs(r??Cl);return Object.assign(t,{maxAttempts:s,retryStrategy:async()=>e||(await hs(n)()===Ia.ADAPTIVE?new h8(s):new tC(s))})},m8=t=>(t==null?void 0:t.body)instanceof ReadableStream,g8=t=>(e,n)=>async r=>{var a;let s=await t.retryStrategy();const i=await t.maxAttempts();if(y8(s)){s=s;let o=await s.acquireInitialRetryToken(n.partition_id),c=new Error,u=0,l=0;const{request:d}=r,h=Rn.isInstance(d);for(h&&(d.headers[u8]=Kj());;)try{h&&(d.headers[l8]=`attempt=${u+1}; max=${i}`);const{response:f,output:m}=await e(r);return s.recordSuccess(o),m.$metadata.attempts=u+1,m.$metadata.totalRetryDelay=l,{response:f,output:m}}catch(f){const m=_8(f);if(c=f8(f),h&&m8(d))throw(a=n.logger instanceof FA?console:n.logger)==null||a.warn("An error was encountered in a non-retryable streaming request."),c;try{o=await s.refreshRetryTokenForRetry(o,m)}catch{throw c.$metadata||(c.$metadata={}),c.$metadata.attempts=u+1,c.$metadata.totalRetryDelay=l,c}u=o.getRetryCount();const g=o.getRetryDelay();l+=g,await new Promise(_=>setTimeout(_,g))}}else return s=s,s!=null&&s.mode&&(n.userAgent=[...n.userAgent||[],["cfg/retry-mode",s.mode]]),s.retry(e,r)},y8=t=>typeof t.acquireInitialRetryToken<"u"&&typeof t.refreshRetryTokenForRetry<"u"&&typeof t.recordSuccess<"u",_8=t=>{const e={error:t,errorType:w8(t)},n=E8(t.$response);return n&&(e.retryAfterHint=n),e},w8=t=>QA(t)?"THROTTLING":Qg(t)?"TRANSIENT":s8(t)?"SERVER_ERROR":"CLIENT_ERROR",b8={name:"retryMiddleware",tags:["RETRY"],step:"finalizeRequest",priority:"high",override:!0},v8=t=>({applyToStack:e=>{e.add(g8(t),b8)}}),E8=t=>{if(!Ca.isInstance(t))return;const e=Object.keys(t.headers).find(i=>i.toLowerCase()==="retry-after");if(!e)return;const n=t.headers[e],r=Number(n);return Number.isNaN(r)?new Date(n):new Date(r*1e3)},S8=async(t,e,n)=>({operation:md(e).operation,region:await hs(t.region)()||(()=>{throw new Error("expected `region` to be configured for `aws.auth#sigv4`")})()});function x8(t){return{schemeId:"aws.auth#sigv4",signingProperties:{name:"bedrock",region:t.region},propertiesExtractor:(e,n)=>({signingProperties:{config:e,context:n}})}}function T8(t){return{schemeId:"smithy.api#httpBearerAuth",propertiesExtractor:({profile:e,filepath:n,configFilepath:r,ignoreCache:s},i)=>({identityProperties:{profile:e,filepath:n,configFilepath:r,ignoreCache:s}})}}const A8=t=>{const e=[];switch(t.operation){default:e.push(x8(t)),e.push(T8())}return e},C8=t=>{const e=bA(t.token,wA,Zg),n=d6(t);return Object.assign(n,{authSchemePreference:hs(t.authSchemePreference??[]),token:e})},k8=t=>Object.assign(t,{useDualstackEndpoint:t.useDualstackEndpoint??!1,useFipsEndpoint:t.useFipsEndpoint??!1,defaultSigningName:"bedrock"}),nC={UseFIPS:{type:"builtInParams",name:"useFipsEndpoint"},Endpoint:{type:"builtInParams",name:"endpoint"},Region:{type:"builtInParams",name:"region"},UseDualStack:{type:"builtInParams",name:"useDualstackEndpoint"}},I8="3.917.0",R8={version:I8};var rC={name:"SHA-256"},u0={name:"HMAC",hash:rC},O8=new Uint8Array([227,176,196,66,152,252,28,20,154,251,244,200,153,111,185,36,39,174,65,228,100,155,147,76,164,149,153,27,120,82,184,85]);const $8={};function Ou(){return typeof window<"u"?window:typeof self<"u"?self:$8}var N8=(function(){function t(e){this.toHash=new Uint8Array(0),this.secret=e,this.reset()}return t.prototype.update=function(e){if(!em(e)){var n=Xo(e),r=new Uint8Array(this.toHash.byteLength+n.byteLength);r.set(this.toHash,0),r.set(n,this.toHash.byteLength),this.toHash=r}},t.prototype.digest=function(){var e=this;return this.key?this.key.then(function(n){return Ou().crypto.subtle.sign(u0,n,e.toHash).then(function(r){return new Uint8Array(r)})}):em(this.toHash)?Promise.resolve(O8):Promise.resolve().then(function(){return Ou().crypto.subtle.digest(rC,e.toHash)}).then(function(n){return Promise.resolve(new Uint8Array(n))})},t.prototype.reset=function(){var e=this;this.toHash=new Uint8Array(0),this.secret&&this.secret!==void 0&&(this.key=new Promise(function(n,r){Ou().crypto.subtle.importKey("raw",Xo(e.secret),u0,!1,["sign"]).then(n,r)}),this.key.catch(function(){}))},t})(),Kn=64,P8=32,L8=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),M8=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],D8=Math.pow(2,53)-1,$u=(function(){function t(){this.state=Int32Array.from(M8),this.temp=new Int32Array(64),this.buffer=new Uint8Array(64),this.bufferLength=0,this.bytesHashed=0,this.finished=!1}return t.prototype.update=function(e){if(this.finished)throw new Error("Attempted to update an already finished hash.");var n=0,r=e.byteLength;if(this.bytesHashed+=r,this.bytesHashed*8>D8)throw new Error("Cannot hash more than 2^53 - 1 bits");for(;r>0;)this.buffer[this.bufferLength++]=e[n++],r--,this.bufferLength===Kn&&(this.hashBuffer(),this.bufferLength=0)},t.prototype.digest=function(){if(!this.finished){var e=this.bytesHashed*8,n=new DataView(this.buffer.buffer,this.buffer.byteOffset,this.buffer.byteLength),r=this.bufferLength;if(n.setUint8(this.bufferLength++,128),r%Kn>=Kn-8){for(var s=this.bufferLength;s<Kn;s++)n.setUint8(s,0);this.hashBuffer(),this.bufferLength=0}for(var s=this.bufferLength;s<Kn-8;s++)n.setUint8(s,0);n.setUint32(Kn-8,Math.floor(e/4294967296),!0),n.setUint32(Kn-4,e),this.hashBuffer(),this.finished=!0}for(var i=new Uint8Array(P8),s=0;s<8;s++)i[s*4]=this.state[s]>>>24&255,i[s*4+1]=this.state[s]>>>16&255,i[s*4+2]=this.state[s]>>>8&255,i[s*4+3]=this.state[s]>>>0&255;return i},t.prototype.hashBuffer=function(){for(var e=this,n=e.buffer,r=e.state,s=r[0],i=r[1],a=r[2],o=r[3],c=r[4],u=r[5],l=r[6],d=r[7],h=0;h<Kn;h++){if(h<16)this.temp[h]=(n[h*4]&255)<<24|(n[h*4+1]&255)<<16|(n[h*4+2]&255)<<8|n[h*4+3]&255;else{var f=this.temp[h-2],m=(f>>>17|f<<15)^(f>>>19|f<<13)^f>>>10;f=this.temp[h-15];var g=(f>>>7|f<<25)^(f>>>18|f<<14)^f>>>3;this.temp[h]=(m+this.temp[h-7]|0)+(g+this.temp[h-16]|0)}var _=(((c>>>6|c<<26)^(c>>>11|c<<21)^(c>>>25|c<<7))+(c&u^~c&l)|0)+(d+(L8[h]+this.temp[h]|0)|0)|0,b=((s>>>2|s<<30)^(s>>>13|s<<19)^(s>>>22|s<<10))+(s&i^s&a^i&a)|0;d=l,l=u,u=c,c=o+_|0,o=a,a=i,i=s,s=_+b|0}r[0]+=s,r[1]+=i,r[2]+=a,r[3]+=o,r[4]+=c,r[5]+=u,r[6]+=l,r[7]+=d},t})(),U8=(function(){function t(e){this.secret=e,this.hash=new $u,this.reset()}return t.prototype.update=function(e){if(!(em(e)||this.error))try{this.hash.update(Xo(e))}catch(n){this.error=n}},t.prototype.digestSync=function(){if(this.error)throw this.error;return this.outer?(this.outer.finished||this.outer.update(this.hash.digest()),this.outer.digest()):this.hash.digest()},t.prototype.digest=function(){return F6(this,void 0,void 0,function(){return z6(this,function(e){return[2,this.digestSync()]})})},t.prototype.reset=function(){if(this.hash=new $u,this.secret){this.outer=new $u;var e=B8(this.secret),n=new Uint8Array(Kn);n.set(e);for(var r=0;r<Kn;r++)e[r]^=54,n[r]^=92;this.hash.update(e),this.outer.update(n);for(var r=0;r<e.byteLength;r++)e[r]=0}},t})();function B8(t){var e=Xo(t);if(e.byteLength>Kn){var n=new $u;n.update(e),e=n.digest()}var r=new Uint8Array(Kn);return r.set(e),r}var j8=["decrypt","digest","encrypt","exportKey","generateKey","importKey","sign","verify"];function F8(t){if(z8(t)&&typeof t.crypto.subtle=="object"){var e=t.crypto.subtle;return V8(e)}return!1}function z8(t){if(typeof t=="object"&&typeof t.crypto=="object"){var e=t.crypto.getRandomValues;return typeof e=="function"}return!1}function V8(t){return t&&j8.every(function(e){return typeof t[e]=="function"})}var q8=(function(){function t(e){F8(Ou())?this.hash=new N8(e):this.hash=new U8(e)}return t.prototype.update=function(e,n){this.hash.update(Xo(e))},t.prototype.digest=function(){return this.hash.digest()},t.prototype.reset=function(){this.hash.reset()},t})();const H8=({serviceId:t,clientVersion:e})=>async n=>{var f,m,g;const r=typeof window<"u"?window.navigator:void 0,s=(r==null?void 0:r.userAgent)??"",i=((f=r==null?void 0:r.userAgentData)==null?void 0:f.platform)??l0.os(s)??"other",a=void 0,o=((m=r==null?void 0:r.userAgentData)==null?void 0:m.brands)??[],c=o[o.length-1],u=(c==null?void 0:c.brand)??l0.browser(s)??"unknown",l=(c==null?void 0:c.version)??"unknown",d=[["aws-sdk-js",e],["ua","2.1"],[`os/${i}`,a],["lang/js"],["md/browser",`${u}_${l}`]];t&&d.push([`api/${t}`,e]);const h=await((g=n==null?void 0:n.userAgentAppId)==null?void 0:g.call(n));return h&&d.push([`app/${h}`]),d},l0={os(t){if(/iPhone|iPad|iPod/.test(t))return"iOS";if(/Macintosh|Mac OS X/.test(t))return"macOS";if(/Windows NT/.test(t))return"Windows";if(/Android/.test(t))return"Android";if(/Linux/.test(t))return"Linux"},browser(t){if(/EdgiOS|EdgA|Edg\//.test(t))return"Microsoft Edge";if(/Firefox\//.test(t))return"Firefox";if(/Chrome\//.test(t))return"Chrome";if(/Safari\//.test(t))return"Safari"}},G8=t=>()=>Promise.reject(t),sC="required",Dr="fn",Ur="argv",Da="ref",d0=!0,h0="isSet",Yo="booleanEquals",zi="error",Ga="endpoint",cn="tree",ey="PartitionResult",f0={[sC]:!1,type:"String"},p0={[sC]:!0,default:!1,type:"Boolean"},m0={[Da]:"Endpoint"},iC={[Dr]:Yo,[Ur]:[{[Da]:"UseFIPS"},!0]},aC={[Dr]:Yo,[Ur]:[{[Da]:"UseDualStack"},!0]},Ir={},g0={[Dr]:"getAttr",[Ur]:[{[Da]:ey},"supportsFIPS"]},y0={[Dr]:Yo,[Ur]:[!0,{[Dr]:"getAttr",[Ur]:[{[Da]:ey},"supportsDualStack"]}]},_0=[iC],w0=[aC],b0=[{[Da]:"Region"}],W8={parameters:{Region:f0,UseDualStack:p0,UseFIPS:p0,Endpoint:f0},rules:[{conditions:[{[Dr]:h0,[Ur]:[m0]}],rules:[{conditions:_0,error:"Invalid Configuration: FIPS and custom endpoint are not supported",type:zi},{rules:[{conditions:w0,error:"Invalid Configuration: Dualstack and custom endpoint are not supported",type:zi},{endpoint:{url:m0,properties:Ir,headers:Ir},type:Ga}],type:cn}],type:cn},{rules:[{conditions:[{[Dr]:h0,[Ur]:b0}],rules:[{conditions:[{[Dr]:"aws.partition",[Ur]:b0,assign:ey}],rules:[{conditions:[iC,aC],rules:[{conditions:[{[Dr]:Yo,[Ur]:[d0,g0]},y0],rules:[{rules:[{endpoint:{url:"https://bedrock-runtime-fips.{Region}.{PartitionResult#dualStackDnsSuffix}",properties:Ir,headers:Ir},type:Ga}],type:cn}],type:cn},{error:"FIPS and DualStack are enabled, but this partition does not support one or both",type:zi}],type:cn},{conditions:_0,rules:[{conditions:[{[Dr]:Yo,[Ur]:[g0,d0]}],rules:[{rules:[{endpoint:{url:"https://bedrock-runtime-fips.{Region}.{PartitionResult#dnsSuffix}",properties:Ir,headers:Ir},type:Ga}],type:cn}],type:cn},{error:"FIPS is enabled but this partition does not support FIPS",type:zi}],type:cn},{conditions:w0,rules:[{conditions:[y0],rules:[{rules:[{endpoint:{url:"https://bedrock-runtime.{Region}.{PartitionResult#dualStackDnsSuffix}",properties:Ir,headers:Ir},type:Ga}],type:cn}],type:cn},{error:"DualStack is enabled but this partition does not support DualStack",type:zi}],type:cn},{rules:[{endpoint:{url:"https://bedrock-runtime.{Region}.{PartitionResult#dnsSuffix}",properties:Ir,headers:Ir},type:Ga}],type:cn}],type:cn}],type:cn},{error:"Invalid Configuration: Missing Region",type:zi}],type:cn}]},J8=W8,Z8=new oF({size:50,params:["Endpoint","Region","UseDualStack","UseFIPS"]}),K8=(t,e={})=>Z8.get(t,()=>AF(J8,{endpointParams:t,logger:e.logger}));xl.aws=$A;const X8=t=>({apiVersion:"2023-09-30",base64Decoder:(t==null?void 0:t.base64Decoder)??Hg,base64Encoder:(t==null?void 0:t.base64Encoder)??pA,disableHostPrefix:(t==null?void 0:t.disableHostPrefix)??!1,endpointProvider:(t==null?void 0:t.endpointProvider)??K8,extensions:(t==null?void 0:t.extensions)??[],httpAuthSchemeProvider:(t==null?void 0:t.httpAuthSchemeProvider)??A8,httpAuthSchemes:(t==null?void 0:t.httpAuthSchemes)??[{schemeId:"aws.auth#sigv4",identityProvider:e=>e.getIdentityProvider("aws.auth#sigv4"),signer:new DF},{schemeId:"smithy.api#httpBearerAuth",identityProvider:e=>e.getIdentityProvider("smithy.api#httpBearerAuth"),signer:new tF}],logger:(t==null?void 0:t.logger)??new FA,serviceId:(t==null?void 0:t.serviceId)??"Bedrock Runtime",urlParser:(t==null?void 0:t.urlParser)??Tl,utf8Decoder:(t==null?void 0:t.utf8Decoder)??ka,utf8Encoder:(t==null?void 0:t.utf8Encoder)??Gg}),Y8=["in-region","cross-region","mobile","standard","legacy"],Q8=({defaultsMode:t}={})=>UF(async()=>{const e=typeof t=="function"?await t():t;switch(e==null?void 0:e.toLowerCase()){case"auto":return Promise.resolve(e5()?"mobile":"standard");case"mobile":case"in-region":case"cross-region":case"standard":case"legacy":return Promise.resolve(e==null?void 0:e.toLocaleLowerCase());case void 0:return Promise.resolve("legacy");default:throw new Error(`Invalid parameter for "defaultsMode", expect ${Y8.join(", ")}, got ${e}`)}}),e5=()=>{var e;const t=window==null?void 0:window.navigator;if(t!=null&&t.connection){const{effectiveType:n,rtt:r,downlink:s}=t==null?void 0:t.connection;if(typeof n=="string"&&n!=="4g"||Number(r)>100||Number(s)<10)return!0}return((e=t==null?void 0:t.userAgentData)==null?void 0:e.mobile)||typeof(t==null?void 0:t.maxTouchPoints)=="number"&&(t==null?void 0:t.maxTouchPoints)>1},t5=t=>{const e=Q8(t),n=()=>e().then(b6),r=X8(t);return{...r,...t,runtime:"browser",defaultsMode:e,bodyLengthChecker:(t==null?void 0:t.bodyLengthChecker)??p6,credentialDefaultProvider:(t==null?void 0:t.credentialDefaultProvider)??(s=>()=>Promise.reject(new Error("Credential is missing"))),defaultUserAgentProvider:(t==null?void 0:t.defaultUserAgentProvider)??H8({serviceId:r.serviceId,clientVersion:R8.version}),eventStreamPayloadHandlerProvider:(t==null?void 0:t.eventStreamPayloadHandlerProvider)??f3,eventStreamSerdeProvider:(t==null?void 0:t.eventStreamSerdeProvider)??S3,maxAttempts:(t==null?void 0:t.maxAttempts)??Cl,region:(t==null?void 0:t.region)??G8("Region is missing"),requestHandler:Yg.create((t==null?void 0:t.requestHandler)??n,Jo.create(n)),retryMode:(t==null?void 0:t.retryMode)??(async()=>(await n()).retryMode||Z3),sha256:(t==null?void 0:t.sha256)??q8,streamCollector:(t==null?void 0:t.streamCollector)??Mj,useDualstackEndpoint:(t==null?void 0:t.useDualstackEndpoint)??(()=>Promise.resolve(k3)),useFipsEndpoint:(t==null?void 0:t.useFipsEndpoint)??(()=>Promise.resolve(I3))}},n5=t=>({setRegion(e){t.region=e},region(){return t.region}}),r5=t=>({region:t.region()}),s5=t=>{const e=t.httpAuthSchemes;let n=t.httpAuthSchemeProvider,r=t.credentials,s=t.token;return{setHttpAuthScheme(i){const a=e.findIndex(o=>o.schemeId===i.schemeId);a===-1?e.push(i):e.splice(a,1,i)},httpAuthSchemes(){return e},setHttpAuthSchemeProvider(i){n=i},httpAuthSchemeProvider(){return n},setCredentials(i){r=i},credentials(){return r},setToken(i){s=i},token(){return s}}},i5=t=>({httpAuthSchemes:t.httpAuthSchemes(),httpAuthSchemeProvider:t.httpAuthSchemeProvider(),credentials:t.credentials(),token:t.token()}),a5=(t,e)=>{const n=Object.assign(n5(t),T6(t),oj(t),s5(t));return e.forEach(r=>r.configure(n)),Object.assign(t,r5(n),A6(n),cj(n),i5(n))};class o5 extends m6{constructor(...[n]){const r=t5(n||{});super(r);p(this,"config");this.initConfig=r;const s=k8(r),i=aF(s),a=p8(i),o=$3(a),c=o,u=J3(c),l=N3(u),d=C8(l),h=aj(d),f=m3(h),m=a5(f,(n==null?void 0:n.extensions)||[]);this.config=m,this.middlewareStack.use(j6(this.config)),this.middlewareStack.use(v8(this.config)),this.middlewareStack.use(M3(this.config)),this.middlewareStack.use(hj(this.config)),this.middlewareStack.use(mj(this.config)),this.middlewareStack.use(_j(this.config)),this.middlewareStack.use(Sj(this.config,{httpAuthSchemeParametersProvider:S8,identityProviderConfigProvider:async g=>new eF({"aws.auth#sigv4":g.credentials,"smithy.api#httpBearerAuth":g.token})})),this.middlewareStack.use(Oj(this.config))}destroy(){super.destroy()}}class yn extends ca{constructor(e){super(e),Object.setPrototypeOf(this,yn.prototype)}}class ty extends yn{constructor(n){super({name:"AccessDeniedException",$fault:"client",...n});p(this,"name","AccessDeniedException");p(this,"$fault","client");Object.setPrototypeOf(this,ty.prototype)}}var v0;(function(t){t.visit=(e,n)=>e.s3OutputDataConfig!==void 0?n.s3OutputDataConfig(e.s3OutputDataConfig):n._(e.$unknown[0],e.$unknown[1])})(v0||(v0={}));class ny extends yn{constructor(n){super({name:"InternalServerException",$fault:"server",...n});p(this,"name","InternalServerException");p(this,"$fault","server");Object.setPrototypeOf(this,ny.prototype)}}class ry extends yn{constructor(n){super({name:"ThrottlingException",$fault:"client",...n});p(this,"name","ThrottlingException");p(this,"$fault","client");Object.setPrototypeOf(this,ry.prototype)}}class sy extends yn{constructor(n){super({name:"ValidationException",$fault:"client",...n});p(this,"name","ValidationException");p(this,"$fault","client");Object.setPrototypeOf(this,sy.prototype)}}class iy extends yn{constructor(n){super({name:"ConflictException",$fault:"client",...n});p(this,"name","ConflictException");p(this,"$fault","client");Object.setPrototypeOf(this,iy.prototype)}}class ay extends yn{constructor(n){super({name:"ResourceNotFoundException",$fault:"client",...n});p(this,"name","ResourceNotFoundException");p(this,"$fault","client");Object.setPrototypeOf(this,ay.prototype)}}class oy extends yn{constructor(n){super({name:"ServiceQuotaExceededException",$fault:"client",...n});p(this,"name","ServiceQuotaExceededException");p(this,"$fault","client");Object.setPrototypeOf(this,oy.prototype)}}class cy extends yn{constructor(n){super({name:"ServiceUnavailableException",$fault:"server",...n});p(this,"name","ServiceUnavailableException");p(this,"$fault","server");Object.setPrototypeOf(this,cy.prototype)}}var E0;(function(t){t.visit=(e,n)=>e.bytes!==void 0?n.bytes(e.bytes):n._(e.$unknown[0],e.$unknown[1])})(E0||(E0={}));var S0;(function(t){t.visit=(e,n)=>e.text!==void 0?n.text(e.text):e.image!==void 0?n.image(e.image):n._(e.$unknown[0],e.$unknown[1])})(S0||(S0={}));var x0;(function(t){t.visit=(e,n)=>e.valid!==void 0?n.valid(e.valid):e.invalid!==void 0?n.invalid(e.invalid):e.satisfiable!==void 0?n.satisfiable(e.satisfiable):e.impossible!==void 0?n.impossible(e.impossible):e.translationAmbiguous!==void 0?n.translationAmbiguous(e.translationAmbiguous):e.tooComplex!==void 0?n.tooComplex(e.tooComplex):e.noTranslations!==void 0?n.noTranslations(e.noTranslations):n._(e.$unknown[0],e.$unknown[1])})(x0||(x0={}));var T0;(function(t){t.visit=(e,n)=>e.documentChar!==void 0?n.documentChar(e.documentChar):e.documentPage!==void 0?n.documentPage(e.documentPage):e.documentChunk!==void 0?n.documentChunk(e.documentChunk):n._(e.$unknown[0],e.$unknown[1])})(T0||(T0={}));var A0;(function(t){t.visit=(e,n)=>e.text!==void 0?n.text(e.text):n._(e.$unknown[0],e.$unknown[1])})(A0||(A0={}));var C0;(function(t){t.visit=(e,n)=>e.text!==void 0?n.text(e.text):n._(e.$unknown[0],e.$unknown[1])})(C0||(C0={}));var k0;(function(t){t.visit=(e,n)=>e.text!==void 0?n.text(e.text):n._(e.$unknown[0],e.$unknown[1])})(k0||(k0={}));var rm;(function(t){t.visit=(e,n)=>e.bytes!==void 0?n.bytes(e.bytes):e.s3Location!==void 0?n.s3Location(e.s3Location):e.text!==void 0?n.text(e.text):e.content!==void 0?n.content(e.content):n._(e.$unknown[0],e.$unknown[1])})(rm||(rm={}));var sm;(function(t){t.visit=(e,n)=>e.bytes!==void 0?n.bytes(e.bytes):n._(e.$unknown[0],e.$unknown[1])})(sm||(sm={}));var im;(function(t){t.visit=(e,n)=>e.text!==void 0?n.text(e.text):e.image!==void 0?n.image(e.image):n._(e.$unknown[0],e.$unknown[1])})(im||(im={}));var am;(function(t){t.visit=(e,n)=>e.bytes!==void 0?n.bytes(e.bytes):e.s3Location!==void 0?n.s3Location(e.s3Location):n._(e.$unknown[0],e.$unknown[1])})(am||(am={}));var om;(function(t){t.visit=(e,n)=>e.reasoningText!==void 0?n.reasoningText(e.reasoningText):e.redactedContent!==void 0?n.redactedContent(e.redactedContent):n._(e.$unknown[0],e.$unknown[1])})(om||(om={}));var cm;(function(t){t.visit=(e,n)=>e.bytes!==void 0?n.bytes(e.bytes):e.s3Location!==void 0?n.s3Location(e.s3Location):n._(e.$unknown[0],e.$unknown[1])})(cm||(cm={}));var um;(function(t){t.visit=(e,n)=>e.json!==void 0?n.json(e.json):e.text!==void 0?n.text(e.text):e.image!==void 0?n.image(e.image):e.document!==void 0?n.document(e.document):e.video!==void 0?n.video(e.video):n._(e.$unknown[0],e.$unknown[1])})(um||(um={}));var lm;(function(t){t.visit=(e,n)=>e.text!==void 0?n.text(e.text):e.image!==void 0?n.image(e.image):e.document!==void 0?n.document(e.document):e.video!==void 0?n.video(e.video):e.toolUse!==void 0?n.toolUse(e.toolUse):e.toolResult!==void 0?n.toolResult(e.toolResult):e.guardContent!==void 0?n.guardContent(e.guardContent):e.cachePoint!==void 0?n.cachePoint(e.cachePoint):e.reasoningContent!==void 0?n.reasoningContent(e.reasoningContent):e.citationsContent!==void 0?n.citationsContent(e.citationsContent):n._(e.$unknown[0],e.$unknown[1])})(lm||(lm={}));var I0;(function(t){t.visit=(e,n)=>e.text!==void 0?n.text(e.text):n._(e.$unknown[0],e.$unknown[1])})(I0||(I0={}));var dm;(function(t){t.visit=(e,n)=>e.text!==void 0?n.text(e.text):e.guardContent!==void 0?n.guardContent(e.guardContent):e.cachePoint!==void 0?n.cachePoint(e.cachePoint):n._(e.$unknown[0],e.$unknown[1])})(dm||(dm={}));var R0;(function(t){t.visit=(e,n)=>e.auto!==void 0?n.auto(e.auto):e.any!==void 0?n.any(e.any):e.tool!==void 0?n.tool(e.tool):n._(e.$unknown[0],e.$unknown[1])})(R0||(R0={}));var hm;(function(t){t.visit=(e,n)=>e.json!==void 0?n.json(e.json):n._(e.$unknown[0],e.$unknown[1])})(hm||(hm={}));var fm;(function(t){t.visit=(e,n)=>e.toolSpec!==void 0?n.toolSpec(e.toolSpec):e.cachePoint!==void 0?n.cachePoint(e.cachePoint):n._(e.$unknown[0],e.$unknown[1])})(fm||(fm={}));var O0;(function(t){t.visit=(e,n)=>e.message!==void 0?n.message(e.message):n._(e.$unknown[0],e.$unknown[1])})(O0||(O0={}));class uy extends yn{constructor(n){super({name:"ModelErrorException",$fault:"client",...n});p(this,"name","ModelErrorException");p(this,"$fault","client");p(this,"originalStatusCode");p(this,"resourceName");Object.setPrototypeOf(this,uy.prototype),this.originalStatusCode=n.originalStatusCode,this.resourceName=n.resourceName}}class ly extends yn{constructor(n){super({name:"ModelNotReadyException",$fault:"client",...n});p(this,"name","ModelNotReadyException");p(this,"$fault","client");p(this,"$retryable",{});Object.setPrototypeOf(this,ly.prototype)}}class dy extends yn{constructor(n){super({name:"ModelTimeoutException",$fault:"client",...n});p(this,"name","ModelTimeoutException");p(this,"$fault","client");Object.setPrototypeOf(this,dy.prototype)}}var $0;(function(t){t.visit=(e,n)=>e.text!==void 0?n.text(e.text):e.redactedContent!==void 0?n.redactedContent(e.redactedContent):e.signature!==void 0?n.signature(e.signature):n._(e.$unknown[0],e.$unknown[1])})($0||($0={}));var N0;(function(t){t.visit=(e,n)=>e.text!==void 0?n.text(e.text):e.toolUse!==void 0?n.toolUse(e.toolUse):e.reasoningContent!==void 0?n.reasoningContent(e.reasoningContent):e.citation!==void 0?n.citation(e.citation):n._(e.$unknown[0],e.$unknown[1])})(N0||(N0={}));var P0;(function(t){t.visit=(e,n)=>e.toolUse!==void 0?n.toolUse(e.toolUse):n._(e.$unknown[0],e.$unknown[1])})(P0||(P0={}));class hy extends yn{constructor(n){super({name:"ModelStreamErrorException",$fault:"client",...n});p(this,"name","ModelStreamErrorException");p(this,"$fault","client");p(this,"originalStatusCode");p(this,"originalMessage");Object.setPrototypeOf(this,hy.prototype),this.originalStatusCode=n.originalStatusCode,this.originalMessage=n.originalMessage}}var L0;(function(t){t.visit=(e,n)=>e.messageStart!==void 0?n.messageStart(e.messageStart):e.contentBlockStart!==void 0?n.contentBlockStart(e.contentBlockStart):e.contentBlockDelta!==void 0?n.contentBlockDelta(e.contentBlockDelta):e.contentBlockStop!==void 0?n.contentBlockStop(e.contentBlockStop):e.messageStop!==void 0?n.messageStop(e.messageStop):e.metadata!==void 0?n.metadata(e.metadata):e.internalServerException!==void 0?n.internalServerException(e.internalServerException):e.modelStreamErrorException!==void 0?n.modelStreamErrorException(e.modelStreamErrorException):e.validationException!==void 0?n.validationException(e.validationException):e.throttlingException!==void 0?n.throttlingException(e.throttlingException):e.serviceUnavailableException!==void 0?n.serviceUnavailableException(e.serviceUnavailableException):n._(e.$unknown[0],e.$unknown[1])})(L0||(L0={}));var M0;(function(t){t.visit=(e,n)=>e.chunk!==void 0?n.chunk(e.chunk):n._(e.$unknown[0],e.$unknown[1])})(M0||(M0={}));var D0;(function(t){t.visit=(e,n)=>e.chunk!==void 0?n.chunk(e.chunk):e.internalServerException!==void 0?n.internalServerException(e.internalServerException):e.modelStreamErrorException!==void 0?n.modelStreamErrorException(e.modelStreamErrorException):e.validationException!==void 0?n.validationException(e.validationException):e.throttlingException!==void 0?n.throttlingException(e.throttlingException):e.modelTimeoutException!==void 0?n.modelTimeoutException(e.modelTimeoutException):e.serviceUnavailableException!==void 0?n.serviceUnavailableException(e.serviceUnavailableException):n._(e.$unknown[0],e.$unknown[1])})(D0||(D0={}));var U0;(function(t){t.visit=(e,n)=>e.chunk!==void 0?n.chunk(e.chunk):e.internalServerException!==void 0?n.internalServerException(e.internalServerException):e.modelStreamErrorException!==void 0?n.modelStreamErrorException(e.modelStreamErrorException):e.validationException!==void 0?n.validationException(e.validationException):e.throttlingException!==void 0?n.throttlingException(e.throttlingException):e.modelTimeoutException!==void 0?n.modelTimeoutException(e.modelTimeoutException):e.serviceUnavailableException!==void 0?n.serviceUnavailableException(e.serviceUnavailableException):n._(e.$unknown[0],e.$unknown[1])})(U0||(U0={}));var B0;(function(t){t.visit=(e,n)=>e.invokeModel!==void 0?n.invokeModel(e.invokeModel):e.converse!==void 0?n.converse(e.converse):n._(e.$unknown[0],e.$unknown[1])})(B0||(B0={}));const Qo=t=>({...t,...t.logic&&{logic:gs},...t.naturalLanguage&&{naturalLanguage:gs}}),_d=t=>({...t,...t.premises&&{premises:t.premises.map(e=>Qo(e))},...t.claims&&{claims:t.claims.map(e=>Qo(e))}}),j0=t=>({...t,...t.text&&{text:gs}}),wd=t=>({...t,...t.premises&&{premises:t.premises.map(e=>Qo(e))},...t.claims&&{claims:t.claims.map(e=>Qo(e))},...t.untranslatedPremises&&{untranslatedPremises:t.untranslatedPremises.map(e=>j0(e))},...t.untranslatedClaims&&{untranslatedClaims:t.untranslatedClaims.map(e=>j0(e))}}),c5=t=>({...t,...t.translation&&{translation:wd(t.translation)},...t.logicWarning&&{logicWarning:_d(t.logicWarning)}}),u5=t=>({...t,...t.translation&&{translation:wd(t.translation)},...t.logicWarning&&{logicWarning:_d(t.logicWarning)}}),pm=t=>({...t,...t.statements&&{statements:t.statements.map(e=>Qo(e))}}),l5=t=>({...t,...t.translation&&{translation:wd(t.translation)},...t.claimsTrueScenario&&{claimsTrueScenario:pm(t.claimsTrueScenario)},...t.claimsFalseScenario&&{claimsFalseScenario:pm(t.claimsFalseScenario)},...t.logicWarning&&{logicWarning:_d(t.logicWarning)}}),d5=t=>({...t}),h5=t=>({...t,...t.translation&&{translation:wd(t.translation)},...t.claimsTrueScenario&&{claimsTrueScenario:pm(t.claimsTrueScenario)},...t.logicWarning&&{logicWarning:_d(t.logicWarning)}}),f5=t=>{if(t.valid!==void 0)return{valid:h5(t.valid)};if(t.invalid!==void 0)return{invalid:u5(t.invalid)};if(t.satisfiable!==void 0)return{satisfiable:l5(t.satisfiable)};if(t.impossible!==void 0)return{impossible:c5(t.impossible)};if(t.translationAmbiguous!==void 0)return{translationAmbiguous:d5(t.translationAmbiguous)};if(t.tooComplex!==void 0)return{tooComplex:t.tooComplex};if(t.noTranslations!==void 0)return{noTranslations:t.noTranslations};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},p5=t=>({...t,...t.findings&&{findings:t.findings.map(e=>f5(e))}}),F0=t=>({...t,...t.automatedReasoningPolicy&&{automatedReasoningPolicy:p5(t.automatedReasoningPolicy)}}),oC=t=>{if(t.text!==void 0)return{text:t.text};if(t.image!==void 0)return{image:gs};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},m5=t=>{if(t.text!==void 0)return{text:t.text};if(t.image!==void 0)return{image:t.image};if(t.document!==void 0)return{document:t.document};if(t.video!==void 0)return{video:t.video};if(t.toolUse!==void 0)return{toolUse:t.toolUse};if(t.toolResult!==void 0)return{toolResult:t.toolResult};if(t.guardContent!==void 0)return{guardContent:oC(t.guardContent)};if(t.cachePoint!==void 0)return{cachePoint:t.cachePoint};if(t.reasoningContent!==void 0)return{reasoningContent:gs};if(t.citationsContent!==void 0)return{citationsContent:t.citationsContent};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},fy=t=>({...t,...t.content&&{content:t.content.map(e=>m5(e))}}),cC=t=>{if(t.text!==void 0)return{text:t.text};if(t.guardContent!==void 0)return{guardContent:oC(t.guardContent)};if(t.cachePoint!==void 0)return{cachePoint:t.cachePoint};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},g5=t=>({...t,...t.messages&&{messages:t.messages.map(e=>fy(e))},...t.system&&{system:t.system.map(e=>cC(e))},...t.toolConfig&&{toolConfig:t.toolConfig},...t.promptVariables&&{promptVariables:gs},...t.requestMetadata&&{requestMetadata:gs}}),y5=t=>{if(t.message!==void 0)return{message:fy(t.message)};if(t.$unknown!==void 0)return{[t.$unknown[0]]:"UNKNOWN"}},_5=t=>({...t,...t.inputAssessment&&{inputAssessment:Object.entries(t.inputAssessment).reduce((e,[n,r])=>(e[n]=F0(r),e),{})},...t.outputAssessments&&{outputAssessments:Object.entries(t.outputAssessments).reduce((e,[n,r])=>(e[n]=r.map(s=>F0(s)),e),{})}}),w5=t=>({...t,...t.guardrail&&{guardrail:_5(t.guardrail)}}),b5=t=>({...t,...t.output&&{output:y5(t.output)},...t.trace&&{trace:w5(t.trace)}}),v5=t=>({...t,...t.messages&&{messages:t.messages.map(e=>fy(e))},...t.system&&{system:t.system.map(e=>cC(e))},...t.toolConfig&&{toolConfig:t.toolConfig},...t.promptVariables&&{promptVariables:gs},...t.requestMetadata&&{requestMetadata:gs}}),E5=t=>({...t,...t.stream&&{stream:"STREAMING_CONTENT"}}),S5=async(t,e)=>{const n=_A(t,e),r={"content-type":"application/json"};n.bp("/model/{modelId}/converse"),n.p("modelId",()=>t.modelId,"{modelId}",!1);let s;return s=JSON.stringify(xe(t,{additionalModelRequestFields:i=>vc(i),additionalModelResponseFieldPaths:i=>te(i),guardrailConfig:i=>te(i),inferenceConfig:i=>_C(i),messages:i=>wC(i,e),performanceConfig:i=>te(i),promptVariables:i=>te(i),requestMetadata:i=>te(i),system:i=>bC(i,e),toolConfig:i=>vC(i)})),n.m("POST").h(r).b(s),n.build()},x5=async(t,e)=>{const n=_A(t,e),r={"content-type":"application/json"};n.bp("/model/{modelId}/converse-stream"),n.p("modelId",()=>t.modelId,"{modelId}",!1);let s;return s=JSON.stringify(xe(t,{additionalModelRequestFields:i=>vc(i),additionalModelResponseFieldPaths:i=>te(i),guardrailConfig:i=>te(i),inferenceConfig:i=>_C(i),messages:i=>wC(i,e),performanceConfig:i=>te(i),promptVariables:i=>te(i),requestMetadata:i=>te(i),system:i=>bC(i,e),toolConfig:i=>vC(i)})),n.m("POST").h(r).b(s),n.build()},T5=async(t,e)=>{if(t.statusCode!==200&&t.statusCode>=300)return uC(t,e);const n=$n({$metadata:Nn(t)}),r=Wj(yA(await Wn(t.body,e)),"body"),s=xe(r,{additionalModelResponseFields:i=>bd(i),metrics:te,output:i=>m9(ar(i),e),performanceConfig:te,stopReason:Ne,trace:i=>_9(i),usage:te});return Object.assign(n,s),n},A5=async(t,e)=>{if(t.statusCode!==200&&t.statusCode>=300)return uC(t,e);const n=$n({$metadata:Nn(t)}),r=t.body;return n.stream=L5(r,e),n},uC=async(t,e)=>{const n={...t,body:await R6(t.body,e)},r=O6(t,n.body);switch(r){case"AccessDeniedException":case"com.amazonaws.bedrockruntime#AccessDeniedException":throw await k5(n);case"InternalServerException":case"com.amazonaws.bedrockruntime#InternalServerException":throw await lC(n);case"ResourceNotFoundException":case"com.amazonaws.bedrockruntime#ResourceNotFoundException":throw await N5(n);case"ServiceQuotaExceededException":case"com.amazonaws.bedrockruntime#ServiceQuotaExceededException":throw await P5(n);case"ServiceUnavailableException":case"com.amazonaws.bedrockruntime#ServiceUnavailableException":throw await hC(n);case"ThrottlingException":case"com.amazonaws.bedrockruntime#ThrottlingException":throw await fC(n);case"ValidationException":case"com.amazonaws.bedrockruntime#ValidationException":throw await pC(n);case"ModelErrorException":case"com.amazonaws.bedrockruntime#ModelErrorException":throw await R5(n);case"ModelNotReadyException":case"com.amazonaws.bedrockruntime#ModelNotReadyException":throw await O5(n);case"ModelTimeoutException":case"com.amazonaws.bedrockruntime#ModelTimeoutException":throw await $5(n);case"ModelStreamErrorException":case"com.amazonaws.bedrockruntime#ModelStreamErrorException":throw await dC(n);case"ConflictException":case"com.amazonaws.bedrockruntime#ConflictException":throw await I5(n);default:const s=n.body;return C5({output:t,parsedBody:s,errorCode:r})}},C5=_6(yn),k5=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne});Object.assign(n,s);const i=new ty({$metadata:Nn(t),...n});return Gn(i,t.body)},I5=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne});Object.assign(n,s);const i=new iy({$metadata:Nn(t),...n});return Gn(i,t.body)},lC=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne});Object.assign(n,s);const i=new ny({$metadata:Nn(t),...n});return Gn(i,t.body)},R5=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne,originalStatusCode:Jg,resourceName:Ne});Object.assign(n,s);const i=new uy({$metadata:Nn(t),...n});return Gn(i,t.body)},O5=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne});Object.assign(n,s);const i=new ly({$metadata:Nn(t),...n});return Gn(i,t.body)},dC=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne,originalMessage:Ne,originalStatusCode:Jg});Object.assign(n,s);const i=new hy({$metadata:Nn(t),...n});return Gn(i,t.body)},$5=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne});Object.assign(n,s);const i=new dy({$metadata:Nn(t),...n});return Gn(i,t.body)},N5=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne});Object.assign(n,s);const i=new ay({$metadata:Nn(t),...n});return Gn(i,t.body)},P5=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne});Object.assign(n,s);const i=new oy({$metadata:Nn(t),...n});return Gn(i,t.body)},hC=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne});Object.assign(n,s);const i=new cy({$metadata:Nn(t),...n});return Gn(i,t.body)},fC=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne});Object.assign(n,s);const i=new ry({$metadata:Nn(t),...n});return Gn(i,t.body)},pC=async(t,e)=>{const n=$n({}),r=t.body,s=xe(r,{message:Ne});Object.assign(n,s);const i=new sy({$metadata:Nn(t),...n});return Gn(i,t.body)},L5=(t,e)=>e.eventStreamMarshaller.deserialize(t,async n=>n.messageStart!=null?{messageStart:await F5(n.messageStart,e)}:n.contentBlockStart!=null?{contentBlockStart:await D5(n.contentBlockStart,e)}:n.contentBlockDelta!=null?{contentBlockDelta:await M5(n.contentBlockDelta,e)}:n.contentBlockStop!=null?{contentBlockStop:await U5(n.contentBlockStop,e)}:n.messageStop!=null?{messageStop:await z5(n.messageStop,e)}:n.metadata!=null?{metadata:await B5(n.metadata,e)}:n.internalServerException!=null?{internalServerException:await j5(n.internalServerException,e)}:n.modelStreamErrorException!=null?{modelStreamErrorException:await V5(n.modelStreamErrorException,e)}:n.validationException!=null?{validationException:await G5(n.validationException,e)}:n.throttlingException!=null?{throttlingException:await H5(n.throttlingException,e)}:n.serviceUnavailableException!=null?{serviceUnavailableException:await q5(n.serviceUnavailableException,e)}:{$unknown:n}),M5=async(t,e)=>{const n={},r=await Wn(t.body,e);return Object.assign(n,f9(r,e)),n},D5=async(t,e)=>{const n={},r=await Wn(t.body,e);return Object.assign(n,te(r)),n},U5=async(t,e)=>{const n={},r=await Wn(t.body,e);return Object.assign(n,te(r)),n},B5=async(t,e)=>{const n={},r=await Wn(t.body,e);return Object.assign(n,g9(r)),n},j5=async(t,e)=>{const n={...t,body:await Wn(t.body,e)};return lC(n)},F5=async(t,e)=>{const n={},r=await Wn(t.body,e);return Object.assign(n,te(r)),n},z5=async(t,e)=>{const n={},r=await Wn(t.body,e);return Object.assign(n,z9(r)),n},V5=async(t,e)=>{const n={...t,body:await Wn(t.body,e)};return dC(n)},q5=async(t,e)=>{const n={...t,body:await Wn(t.body,e)};return hC(n)},H5=async(t,e)=>{const n={...t,body:await Wn(t.body,e)};return fC(n)},G5=async(t,e)=>{const n={...t,body:await Wn(t.body,e)};return pC(n)},W5=(t,e)=>lm.visit(t,{cachePoint:n=>({cachePoint:te(n)}),citationsContent:n=>({citationsContent:te(n)}),document:n=>({document:mC(n,e)}),guardContent:n=>({guardContent:gC(n,e)}),image:n=>({image:yC(n,e)}),reasoningContent:n=>({reasoningContent:e9(n,e)}),text:n=>({text:n}),toolResult:n=>({toolResult:s9(n,e)}),toolUse:n=>({toolUse:u9(n)}),video:n=>({video:EC(n,e)}),_:(n,r)=>({[n]:r})}),J5=(t,e)=>t.filter(n=>n!=null).map(n=>W5(n,e)),mC=(t,e)=>xe(t,{citations:te,context:[],format:[],name:[],source:n=>Z5(n,e)}),Z5=(t,e)=>rm.visit(t,{bytes:n=>({bytes:e.base64Encoder(n)}),content:n=>({content:te(n)}),s3Location:n=>({s3Location:te(n)}),text:n=>({text:n}),_:(n,r)=>({[n]:r})}),gC=(t,e)=>im.visit(t,{image:n=>({image:K5(n,e)}),text:n=>({text:te(n)}),_:(n,r)=>({[n]:r})}),K5=(t,e)=>xe(t,{format:[],source:n=>X5(n,e)}),X5=(t,e)=>sm.visit(t,{bytes:n=>({bytes:e.base64Encoder(n)}),_:(n,r)=>({[n]:r})}),yC=(t,e)=>xe(t,{format:[],source:n=>Y5(n,e)}),Y5=(t,e)=>am.visit(t,{bytes:n=>({bytes:e.base64Encoder(n)}),s3Location:n=>({s3Location:te(n)}),_:(n,r)=>({[n]:r})}),_C=(t,e)=>xe(t,{maxTokens:[],stopSequences:te,temperature:Yb,topP:Yb}),Q5=(t,e)=>xe(t,{content:n=>J5(n,e),role:[]}),wC=(t,e)=>t.filter(n=>n!=null).map(n=>Q5(n,e)),e9=(t,e)=>om.visit(t,{reasoningText:n=>({reasoningText:te(n)}),redactedContent:n=>({redactedContent:e.base64Encoder(n)}),_:(n,r)=>({[n]:r})}),t9=(t,e)=>dm.visit(t,{cachePoint:n=>({cachePoint:te(n)}),guardContent:n=>({guardContent:gC(n,e)}),text:n=>({text:n}),_:(n,r)=>({[n]:r})}),bC=(t,e)=>t.filter(n=>n!=null).map(n=>t9(n,e)),n9=(t,e)=>fm.visit(t,{cachePoint:n=>({cachePoint:te(n)}),toolSpec:n=>({toolSpec:c9(n)}),_:(n,r)=>({[n]:r})}),vC=(t,e)=>xe(t,{toolChoice:te,tools:n=>o9(n)}),r9=(t,e)=>hm.visit(t,{json:n=>({json:vc(n)}),_:(n,r)=>({[n]:r})}),s9=(t,e)=>xe(t,{content:n=>a9(n,e),status:[],toolUseId:[]}),i9=(t,e)=>um.visit(t,{document:n=>({document:mC(n,e)}),image:n=>({image:yC(n,e)}),json:n=>({json:vc(n)}),text:n=>({text:n}),video:n=>({video:EC(n,e)}),_:(n,r)=>({[n]:r})}),a9=(t,e)=>t.filter(n=>n!=null).map(n=>i9(n,e)),o9=(t,e)=>t.filter(n=>n!=null).map(n=>n9(n)),c9=(t,e)=>xe(t,{description:[],inputSchema:n=>r9(n),name:[]}),u9=(t,e)=>xe(t,{input:n=>vc(n),name:[],toolUseId:[]}),EC=(t,e)=>xe(t,{format:[],source:n=>l9(n,e)}),l9=(t,e)=>cm.visit(t,{bytes:n=>({bytes:e.base64Encoder(n)}),s3Location:n=>({s3Location:te(n)}),_:(n,r)=>({[n]:r})}),vc=(t,e)=>t,d9=(t,e)=>t.cachePoint!=null?{cachePoint:te(t.cachePoint)}:t.citationsContent!=null?{citationsContent:te(t.citationsContent)}:t.document!=null?{document:SC(t.document,e)}:t.guardContent!=null?{guardContent:D9(ar(t.guardContent),e)}:t.image!=null?{image:AC(t.image,e)}:t.reasoningContent!=null?{reasoningContent:V9(ar(t.reasoningContent),e)}:Ne(t.text)!==void 0?{text:Ne(t.text)}:t.toolResult!=null?{toolResult:H9(t.toolResult,e)}:t.toolUse!=null?{toolUse:J9(t.toolUse)}:t.video!=null?{video:CC(t.video,e)}:{$unknown:Object.entries(t)[0]},h9=(t,e)=>t.citation!=null?{citation:te(t.citation)}:t.reasoningContent!=null?{reasoningContent:q9(ar(t.reasoningContent),e)}:Ne(t.text)!==void 0?{text:Ne(t.text)}:t.toolUse!=null?{toolUse:te(t.toolUse)}:{$unknown:Object.entries(t)[0]},f9=(t,e)=>xe(t,{contentBlockIndex:Jg,delta:n=>h9(ar(n),e)}),p9=(t,e)=>(t||[]).filter(r=>r!=null).map(r=>d9(ar(r),e)),m9=(t,e)=>t.message!=null?{message:F9(t.message,e)}:{$unknown:Object.entries(t)[0]},g9=(t,e)=>xe(t,{metrics:te,performanceConfig:te,trace:n=>y9(n),usage:te}),y9=(t,e)=>xe(t,{guardrail:n=>TC(n),promptRouter:te}),_9=(t,e)=>xe(t,{guardrail:n=>TC(n),promptRouter:te}),SC=(t,e)=>xe(t,{citations:te,context:Ne,format:Ne,name:Ne,source:n=>w9(ar(n),e)}),w9=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:t.content!=null?{content:te(t.content)}:t.s3Location!=null?{s3Location:te(t.s3Location)}:Ne(t.text)!==void 0?{text:Ne(t.text)}:{$unknown:Object.entries(t)[0]},xC=(t,e)=>xe(t,{automatedReasoningPolicy:n=>C9(n),contentPolicy:te,contextualGroundingPolicy:n=>M9(n),invocationMetrics:te,sensitiveInformationPolicy:te,topicPolicy:te,wordPolicy:te}),b9=(t,e)=>(t||[]).filter(r=>r!=null).map(r=>xC(r)),v9=(t,e)=>Object.entries(t).reduce((n,[r,s])=>(s===null||(n[r]=b9(s)),n),{}),E9=(t,e)=>Object.entries(t).reduce((n,[r,s])=>(s===null||(n[r]=xC(s)),n),{}),S9=(t,e)=>t.impossible!=null?{impossible:T9(t.impossible)}:t.invalid!=null?{invalid:A9(t.invalid)}:t.noTranslations!=null?{noTranslations:te(t.noTranslations)}:t.satisfiable!=null?{satisfiable:k9(t.satisfiable)}:t.tooComplex!=null?{tooComplex:te(t.tooComplex)}:t.translationAmbiguous!=null?{translationAmbiguous:I9(t.translationAmbiguous)}:t.valid!=null?{valid:N9(t.valid)}:{$unknown:Object.entries(t)[0]},x9=(t,e)=>(t||[]).filter(r=>r!=null).map(r=>S9(ar(r))),T9=(t,e)=>xe(t,{contradictingRules:te,logicWarning:te,translation:n=>Ec(n)}),A9=(t,e)=>xe(t,{contradictingRules:te,logicWarning:te,translation:n=>Ec(n)}),C9=(t,e)=>xe(t,{findings:n=>x9(n)}),k9=(t,e)=>xe(t,{claimsFalseScenario:te,claimsTrueScenario:te,logicWarning:te,translation:n=>Ec(n)}),Ec=(t,e)=>xe(t,{claims:te,confidence:Xp,premises:te,untranslatedClaims:te,untranslatedPremises:te}),I9=(t,e)=>xe(t,{differenceScenarios:te,options:n=>$9(n)}),R9=(t,e)=>(t||[]).filter(r=>r!=null).map(r=>Ec(r)),O9=(t,e)=>xe(t,{translations:n=>R9(n)}),$9=(t,e)=>(t||[]).filter(r=>r!=null).map(r=>O9(r)),N9=(t,e)=>xe(t,{claimsTrueScenario:te,logicWarning:te,supportingRules:te,translation:n=>Ec(n)}),P9=(t,e)=>xe(t,{action:Ne,detected:zj,score:Xp,threshold:Xp,type:Ne}),L9=(t,e)=>(t||[]).filter(r=>r!=null).map(r=>P9(r)),M9=(t,e)=>xe(t,{filters:n=>L9(n)}),D9=(t,e)=>t.image!=null?{image:U9(t.image,e)}:t.text!=null?{text:te(t.text)}:{$unknown:Object.entries(t)[0]},U9=(t,e)=>xe(t,{format:Ne,source:n=>B9(ar(n),e)}),B9=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:{$unknown:Object.entries(t)[0]},TC=(t,e)=>xe(t,{actionReason:Ne,inputAssessment:n=>E9(n),modelOutput:te,outputAssessments:n=>v9(n)}),AC=(t,e)=>xe(t,{format:Ne,source:n=>j9(ar(n),e)}),j9=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:t.s3Location!=null?{s3Location:te(t.s3Location)}:{$unknown:Object.entries(t)[0]},F9=(t,e)=>xe(t,{content:n=>p9(n,e),role:Ne}),z9=(t,e)=>xe(t,{additionalModelResponseFields:n=>bd(n),stopReason:Ne}),V9=(t,e)=>t.reasoningText!=null?{reasoningText:te(t.reasoningText)}:t.redactedContent!=null?{redactedContent:e.base64Decoder(t.redactedContent)}:{$unknown:Object.entries(t)[0]},q9=(t,e)=>t.redactedContent!=null?{redactedContent:e.base64Decoder(t.redactedContent)}:Ne(t.signature)!==void 0?{signature:Ne(t.signature)}:Ne(t.text)!==void 0?{text:Ne(t.text)}:{$unknown:Object.entries(t)[0]},H9=(t,e)=>xe(t,{content:n=>W9(n,e),status:Ne,toolUseId:Ne}),G9=(t,e)=>t.document!=null?{document:SC(t.document,e)}:t.image!=null?{image:AC(t.image,e)}:t.json!=null?{json:bd(t.json)}:Ne(t.text)!==void 0?{text:Ne(t.text)}:t.video!=null?{video:CC(t.video,e)}:{$unknown:Object.entries(t)[0]},W9=(t,e)=>(t||[]).filter(r=>r!=null).map(r=>G9(ar(r),e)),J9=(t,e)=>xe(t,{input:n=>bd(n),name:Ne,toolUseId:Ne}),CC=(t,e)=>xe(t,{format:Ne,source:n=>Z9(ar(n),e)}),Z9=(t,e)=>t.bytes!=null?{bytes:e.base64Decoder(t.bytes)}:t.s3Location!=null?{s3Location:te(t.s3Location)}:{$unknown:Object.entries(t)[0]},bd=(t,e)=>t,Nn=t=>({httpStatusCode:t.statusCode,requestId:t.headers["x-amzn-requestid"]??t.headers["x-amzn-request-id"]??t.headers["x-amz-request-id"],extendedRequestId:t.headers["x-amz-id-2"],cfId:t.headers["x-amz-cf-id"]});class K9 extends Xg.classBuilder().ep(nC).m(function(e,n,r,s){return[hA(r,this.serialize,this.deserialize),YA(r,e.getEndpointParameterInstructions())]}).s("AmazonBedrockFrontendService","Converse",{}).n("BedrockRuntimeClient","ConverseCommand").f(g5,b5).ser(S5).de(T5).build(){}class X9 extends Xg.classBuilder().ep(nC).m(function(e,n,r,s){return[hA(r,this.serialize,this.deserialize),YA(r,e.getEndpointParameterInstructions())]}).s("AmazonBedrockFrontendService","ConverseStream",{eventStream:{output:!0}}).n("BedrockRuntimeClient","ConverseStreamCommand").f(v5,E5).ser(x5).de(A5).build(){}const Y9=()=>async()=>{throw new Error("Credential provider not available in browser. Please pass credentials directly.")},Q9=Y9;var kC=class extends Pi{constructor(e){super(e??{});p(this,"model","anthropic.claude-3-haiku-20240307-v1:0");p(this,"streaming",!1);p(this,"region");p(this,"temperature");p(this,"maxTokens");p(this,"endpointHost");p(this,"topP");p(this,"additionalModelRequestFields");p(this,"streamUsage",!0);p(this,"guardrailConfig");p(this,"performanceConfig");p(this,"client");p(this,"clientOptions");p(this,"supportsToolChoiceValues");const{profile:n,filepath:r,configFilepath:s,ignoreCache:i,mfaCodeProvider:a,roleAssumer:o,roleArn:c,webIdentityTokenFile:u,roleAssumerWithWebIdentity:l,...d}=e??{},h=(d==null?void 0:d.credentials)??Q9(),f=(d==null?void 0:d.region)??nr("AWS_DEFAULT_REGION");if(!f)throw new Error("Please set the AWS_DEFAULT_REGION environment variable or pass it to the constructor as the region field.");this.client=(e==null?void 0:e.client)??new o5({...e==null?void 0:e.clientOptions,region:f,credentials:h,endpoint:d.endpointHost?`https://${d.endpointHost}`:void 0}),this.region=f,this.model=(d==null?void 0:d.model)??this.model,this.streaming=(d==null?void 0:d.streaming)??this.streaming,this.temperature=d==null?void 0:d.temperature,this.maxTokens=d==null?void 0:d.maxTokens,this.endpointHost=d==null?void 0:d.endpointHost,this.topP=d==null?void 0:d.topP,this.additionalModelRequestFields=d==null?void 0:d.additionalModelRequestFields,this.streamUsage=(d==null?void 0:d.streamUsage)??this.streamUsage,this.guardrailConfig=d==null?void 0:d.guardrailConfig,this.performanceConfig=d==null?void 0:d.performanceConfig,this.clientOptions=d==null?void 0:d.clientOptions,(d==null?void 0:d.supportsToolChoiceValues)===void 0?this.supportsToolChoiceValues=VB(this.model):this.supportsToolChoiceValues=d.supportsToolChoiceValues}static lc_name(){return"ChatBedrockConverse"}get lc_secrets(){return{apiKey:"API_KEY_NAME"}}get lc_aliases(){return{apiKey:"API_KEY_NAME"}}getLsParams(e){var r,s;const n=this.invocationParams(e);return{ls_provider:"amazon_bedrock",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:((r=n.inferenceConfig)==null?void 0:r.temperature)??this.temperature,ls_max_tokens:((s=n.inferenceConfig)==null?void 0:s.maxTokens)??void 0,ls_stop:e.stop}}bindTools(e,n){return this.withConfig({tools:Pb(e),...n})}_llmType(){return"chat_bedrock_converse"}invocationParams(e){let n;if(e!=null&&e.tools&&e.tools.length){const r=Pb(e.tools);n={tools:r,toolChoice:e.tool_choice?zB(e.tool_choice,r,{model:this.model,supportsToolChoiceValues:this.supportsToolChoiceValues}):void 0}}return{inferenceConfig:{maxTokens:this.maxTokens,temperature:this.temperature,topP:this.topP,stopSequences:e==null?void 0:e.stop},toolConfig:n,additionalModelRequestFields:this.additionalModelRequestFields??(e==null?void 0:e.additionalModelRequestFields),guardrailConfig:this.guardrailConfig??(e==null?void 0:e.guardrailConfig),performanceConfig:e==null?void 0:e.performanceConfig}}async _generate(e,n,r){if(this.streaming){const s=this._streamResponseChunks(e,n,r);let i;for await(const a of s)i===void 0?i=a:i=i.concat(a);if(i===void 0)throw new Error("Could not parse final output from Bedrock streaming call.");return{generations:[i],llmOutput:i.generationInfo}}return this._generateNonStreaming(e,n,r)}async _generateNonStreaming(e,n,r){const{converseMessages:s,converseSystem:i}=Lb(e),a=this.invocationParams(n),o=new K9({modelId:this.model,messages:s,system:i,requestMetadata:n.requestMetadata,...a}),c=await this.client.send(o,{abortSignal:n.signal}),{output:u,...l}=c;if(!(u!=null&&u.message))throw new Error("No message found in Bedrock response.");const d=ej(u.message,l);return{generations:[{text:typeof d.content=="string"?d.content:"",message:d}]}}async*_streamResponseChunks(e,n,r){const{converseMessages:s,converseSystem:i}=Lb(e),a=this.invocationParams(n);let{streamUsage:o}=this;n.streamUsage!==void 0&&(o=n.streamUsage);const c=new X9({modelId:this.model,messages:s,system:i,requestMetadata:n.requestMetadata,...a}),u=await this.client.send(c,{abortSignal:n.signal});if(u.stream)for await(const l of u.stream)if(l.contentBlockStart)yield nj(l.contentBlockStart);else if(l.contentBlockDelta){const d=tj(l.contentBlockDelta);yield d,await(r==null?void 0:r.handleLLMNewToken(d.text,void 0,void 0,void 0,void 0,{chunk:d}))}else l.metadata?yield rj(l.metadata,{streamUsage:o}):yield new fn({text:"",message:new Et({content:"",response_metadata:{...l}})})}withStructuredOutput(e,n){const r=e,s=n==null?void 0:n.name,i=xi(r)??"A function available to call.",a=n==null?void 0:n.method,o=n==null?void 0:n.includeRaw;if(a==="jsonMode")throw new Error("ChatBedrockConverse does not support 'jsonMode'.");let c=s??"extract",u;tr(r)?u=[{type:"function",function:{name:c,description:i,parameters:nn(r)}}]:("name"in r&&(c=r.name),u=[{type:"function",function:{name:c,description:i,parameters:r}}]);const l=this.supportsToolChoiceValues??[];let d;l.includes("tool")?d={tool_choice:u[0].function.name}:l.includes("any")&&(d={tool_choice:"any"});const h=this.bindTools(u,d),f=Tr.from(b=>{if(!b.tool_calls||b.tool_calls.length===0)throw new Error("No tool calls found in the response.");const y=b.tool_calls.find(E=>E.name===c);if(!y)throw new Error(`No tool call found with name ${c}.`);return y.args});if(!o)return h.pipe(f).withConfig({runName:"StructuredOutput"});const m=ms.assign({parsed:(b,y)=>f.invoke(b.raw,y)}),g=ms.assign({parsed:()=>null}),_=m.withFallbacks({fallbacks:[g]});return Jr.from([{raw:h},_]).withConfig({runName:"StructuredOutputRunnable"})}};const bi=t=>t();function Sc(t){return t?!!(/^o\d/.test(t??"")||t.startsWith("gpt-5")&&!t.startsWith("gpt-5-chat")):!1}function ez(t){return t.role!=="system"&&t.role!=="developer"&&t.role!=="assistant"&&t.role!=="user"&&t.role!=="function"&&t.role!=="tool"&&console.warn(`Unknown message role: ${t.role}`),t.role}function xc(t){const e=t._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!Zr.isInstance(t))throw new Error("Invalid generic chat message");return ez(t);default:throw new Error(`Unknown message type: ${e}`)}}function tz(t){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:i,azureADTokenProvider:a,azureOpenAIEndpoint:o}=t;if((r||a)&&s&&e)return`${s}/${e}`;if((r||a)&&o&&e)return`${o}/openai/deployments/${e}`;if(r||a){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${e}`}return i}function nz(t,e){let n;return _c(t)?n=vT(t):n=t,(e==null?void 0:e.strict)!==void 0&&(n.function.strict=e.strict),n}function rz(t){return t.anyOf!==void 0&&Array.isArray(t.anyOf)}function sz(t){const e=["namespace functions {",""];for(const n of t)n.description&&e.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(e.push(`type ${n.name} = (_: {`),e.push(IC(n.parameters,0)),e.push("}) => any;")):e.push(`type ${n.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function IC(t,e){var r;const n=[];for(const[s,i]of Object.entries(t.properties??{}))i.description&&e<2&&n.push(`// ${i.description}`),(r=t.required)!=null&&r.includes(s)?n.push(`${s}: ${kl(i,e)},`):n.push(`${s}?: ${kl(i,e)},`);return n.map(s=>" ".repeat(e)+s).join(`
`)}function kl(t,e){if(rz(t))return t.anyOf.map(n=>kl(n,e)).join(" | ");switch(t.type){case"string":return t.enum?t.enum.map(n=>`"${n}"`).join(" | "):"string";case"number":return t.enum?t.enum.map(n=>`${n}`).join(" | "):"number";case"integer":return t.enum?t.enum.map(n=>`${n}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",IC(t,e+2),"}"].join(`
`);case"array":return t.items?`${kl(t.items,e)}[]`:"any[]";default:return""}}function RC(t){if(t)return t==="any"||t==="required"?"required":t==="auto"?"auto":t==="none"?"none":typeof t=="string"?{type:"function",function:{name:t}}:t}function py(t){return"type"in t&&t.type!=="function"}function iz(t){return t!=null&&typeof t=="object"&&"type"in t&&t.type!=="function"}function Il(t){return typeof t=="object"&&t!==null&&"metadata"in t&&typeof t.metadata=="object"&&t.metadata!==null&&"customTool"in t.metadata&&typeof t.metadata.customTool=="object"&&t.metadata.customTool!==null}function OC(t){return"type"in t&&t.type==="custom"&&"custom"in t&&typeof t.custom=="object"&&t.custom!==null}function az(t){if(t.type==="custom_tool_call")return{...t,type:"tool_call",call_id:t.id,id:t.call_id,name:t.name,isCustomTool:!0,args:{input:t.input}}}function oz(t){return t.type==="tool_call"&&"isCustomTool"in t&&t.isCustomTool===!0}function cz(t){const e=()=>{if(t.custom.format){if(t.custom.format.type==="grammar")return{type:"grammar",definition:t.custom.format.grammar.definition,syntax:t.custom.format.grammar.syntax};if(t.custom.format.type==="text")return{type:"text"}}};return{type:"custom",name:t.custom.name,description:t.custom.description,format:e()}}function uz(t){const e=()=>{if(t.format){if(t.format.type==="grammar")return{type:"grammar",grammar:{definition:t.format.definition,syntax:t.format.syntax}};if(t.format.type==="text")return{type:"text"}}};return{type:"custom",custom:{name:t.name,description:t.description,format:e()}}}function mm(t){return typeof t=="object"&&t!==null&&("name"in t&&t.name==="AbortError"||"message"in t&&String(t.message).includes("FetchRequestCanceledException"))}const gm=t=>{if(t instanceof Error)return t;if(typeof t=="object"&&t!==null){try{if(Object.prototype.toString.call(t)==="[object Error]"){const e=new Error(t.message,t.cause?{cause:t.cause}:{});return t.stack&&(e.stack=t.stack),t.cause&&!e.cause&&(e.cause=t.cause),t.name&&(e.name=t.name),e}}catch{}try{return new Error(JSON.stringify(t))}catch{}}return new Error(t)};class we extends Error{}class Xt extends we{constructor(e,n,r,s){super(`${Xt.makeMessage(e,n,r)}`),this.status=e,this.headers=s,this.requestID=s==null?void 0:s.get("x-request-id"),this.error=n;const i=n;this.code=i==null?void 0:i.code,this.param=i==null?void 0:i.param,this.type=i==null?void 0:i.type}static makeMessage(e,n,r){const s=n!=null&&n.message?typeof n.message=="string"?n.message:JSON.stringify(n.message):n?JSON.stringify(n):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,n,r,s){if(!e||!s)return new vd({message:r,cause:gm(n)});const i=n==null?void 0:n.error;return e===400?new $C(e,i,r,s):e===401?new NC(e,i,r,s):e===403?new PC(e,i,r,s):e===404?new LC(e,i,r,s):e===409?new MC(e,i,r,s):e===422?new DC(e,i,r,s):e===429?new UC(e,i,r,s):e>=500?new BC(e,i,r,s):new Xt(e,i,r,s)}}class Fn extends Xt{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class vd extends Xt{constructor({message:e,cause:n}){super(void 0,void 0,e||"Connection error.",void 0),n&&(this.cause=n)}}class Ed extends vd{constructor({message:e}={}){super({message:e??"Request timed out."})}}class $C extends Xt{}class NC extends Xt{}class PC extends Xt{}class LC extends Xt{}class MC extends Xt{}class DC extends Xt{}class UC extends Xt{}class BC extends Xt{}class jC extends we{constructor(){super("Could not parse response content as the length limit was reached")}}class FC extends we{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class to extends Error{constructor(e){super(e)}}function Rl(t){return t!==void 0&&"function"in t&&t.function!==void 0}function lz(t,e){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),n}function my(t){return(t==null?void 0:t.$brand)==="auto-parseable-response-format"}function Tc(t){return(t==null?void 0:t.$brand)==="auto-parseable-tool"}function dz(t,e){return!e||!zC(e)?{...t,choices:t.choices.map(n=>(VC(n.message.tool_calls),{...n,message:{...n.message,parsed:null,...n.message.tool_calls?{tool_calls:n.message.tool_calls}:void 0}}))}:gy(t,e)}function gy(t,e){const n=t.choices.map(r=>{var s;if(r.finish_reason==="length")throw new jC;if(r.finish_reason==="content_filter")throw new FC;return VC(r.message.tool_calls),{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:((s=r.message.tool_calls)==null?void 0:s.map(i=>fz(e,i)))??void 0}:void 0,parsed:r.message.content&&!r.message.refusal?hz(e,r.message.content):null}}});return{...t,choices:n}}function hz(t,e){var n,r;return((n=t.response_format)==null?void 0:n.type)!=="json_schema"?null:((r=t.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in t.response_format?t.response_format.$parseRaw(e):JSON.parse(e):null}function fz(t,e){var r;const n=(r=t.tools)==null?void 0:r.find(s=>{var i;return Rl(s)&&((i=s.function)==null?void 0:i.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:Tc(n)?n.$parseRaw(e.function.arguments):n!=null&&n.function.strict?JSON.parse(e.function.arguments):null}}}function pz(t,e){var r;if(!t||!("tools"in t)||!t.tools)return!1;const n=(r=t.tools)==null?void 0:r.find(s=>{var i;return Rl(s)&&((i=s.function)==null?void 0:i.name)===e.function.name});return Rl(n)&&(Tc(n)||(n==null?void 0:n.function.strict)||!1)}function zC(t){var e;return my(t.response_format)?!0:((e=t.tools)==null?void 0:e.some(n=>Tc(n)||n.type==="function"&&n.function.strict===!0))??!1}function VC(t){for(const e of t||[])if(e.type!=="function")throw new we(`Currently only \`function\` tool calls are supported; Received \`${e.type}\``)}function mz(t){for(const e of t??[]){if(e.type!=="function")throw new we(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new we(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}const gz=Symbol("Let zodToJsonSchema decide on which parser to use"),z0={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},yz=t=>typeof t=="string"?{...z0,basePath:["#"],definitions:{},name:t}:{...z0,basePath:["#"],definitions:{},...t},ym=t=>"_def"in t?t._def:t;function _z(t){if(!t)return!0;for(const e in t)return!1;return!0}const wz=t=>{const e=yz(t),n=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[ym(s),{def:ym(s),path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function qC(t,e,n,r){r!=null&&r.errorMessages&&n&&(t.errorMessage={...t.errorMessage,[e]:n})}function Ye(t,e,n,r,s){t[e]=n,qC(t,e,r,s)}function bz(){return{}}function vz(t,e){var r,s;const n={type:"array"};return((s=(r=t.type)==null?void 0:r._def)==null?void 0:s.typeName)!==D.ZodAny&&(n.items=Ge(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&Ye(n,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&Ye(n,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(Ye(n,"minItems",t.exactLength.value,t.exactLength.message,e),Ye(n,"maxItems",t.exactLength.value,t.exactLength.message,e)),n}function Ez(t,e){const n={type:"integer",format:"int64"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?Ye(n,"minimum",r.value,r.message,e):Ye(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),Ye(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?Ye(n,"maximum",r.value,r.message,e):Ye(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),Ye(n,"maximum",r.value,r.message,e));break;case"multipleOf":Ye(n,"multipleOf",r.value,r.message,e);break}return n}function Sz(){return{type:"boolean"}}function xz(t,e){return Ge(t.type._def,e)}const Tz=(t,e)=>Ge(t.innerType._def,e);function HC(t,e,n){const r=n??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((s,i)=>HC(t,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Az(t,e)}}const Az=(t,e)=>{const n={type:"integer",format:"unix-time"};if(e.target==="openApi3")return n;for(const r of t.checks)switch(r.kind){case"min":Ye(n,"minimum",r.value,r.message,e);break;case"max":Ye(n,"maximum",r.value,r.message,e);break}return n};function Cz(t,e){return{...Ge(t.innerType._def,e),default:t.defaultValue()}}function kz(t,e,n){return e.effectStrategy==="input"?Ge(t.schema._def,e,n):{}}function Iz(t){return{type:"string",enum:[...t.values]}}const Rz=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function Oz(t,e){const n=[Ge(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),Ge(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(i=>{if(Rz(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(r=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;a=c}else r=void 0;s.push(a)}}),s.length?{allOf:s,...r}:void 0}function $z(t,e){const n=typeof t.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[t.value]}:{type:n==="bigint"?"integer":n,const:t.value}}let Df;const Qs={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Df===void 0&&(Df=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Df),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function GC(t,e){const n={type:"string"};function r(s){return e.patternStrategy==="escape"?Nz(s):s}if(t.checks)for(const s of t.checks)switch(s.kind){case"min":Ye(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,s.value):s.value,s.message,e);break;case"max":Ye(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":dr(n,"email",s.message,e);break;case"format:idn-email":dr(n,"idn-email",s.message,e);break;case"pattern:zod":hr(n,Qs.email,s.message,e);break}break;case"url":dr(n,"uri",s.message,e);break;case"uuid":dr(n,"uuid",s.message,e);break;case"regex":hr(n,s.regex,s.message,e);break;case"cuid":hr(n,Qs.cuid,s.message,e);break;case"cuid2":hr(n,Qs.cuid2,s.message,e);break;case"startsWith":hr(n,RegExp(`^${r(s.value)}`),s.message,e);break;case"endsWith":hr(n,RegExp(`${r(s.value)}$`),s.message,e);break;case"datetime":dr(n,"date-time",s.message,e);break;case"date":dr(n,"date",s.message,e);break;case"time":dr(n,"time",s.message,e);break;case"duration":dr(n,"duration",s.message,e);break;case"length":Ye(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,s.value):s.value,s.message,e),Ye(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,s.value):s.value,s.message,e);break;case"includes":{hr(n,RegExp(r(s.value)),s.message,e);break}case"ip":{s.version!=="v6"&&dr(n,"ipv4",s.message,e),s.version!=="v4"&&dr(n,"ipv6",s.message,e);break}case"emoji":hr(n,Qs.emoji,s.message,e);break;case"ulid":{hr(n,Qs.ulid,s.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{dr(n,"binary",s.message,e);break}case"contentEncoding:base64":{Ye(n,"contentEncoding","base64",s.message,e);break}case"pattern:zod":{hr(n,Qs.base64,s.message,e);break}}break}case"nanoid":hr(n,Qs.nanoid,s.message,e)}return n}const Nz=t=>Array.from(t).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),dr=(t,e,n,r)=>{var s;t.format||(s=t.anyOf)!=null&&s.some(i=>i.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&r.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...n&&r.errorMessages&&{errorMessage:{format:n}}})):Ye(t,"format",e,n,r)},hr=(t,e,n,r)=>{var s;t.pattern||(s=t.allOf)!=null&&s.some(i=>i.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&r.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:V0(e,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):Ye(t,"pattern",V0(e,r),n,r)},V0=(t,e)=>{var u;const n=typeof t=="function"?t():t;if(!e.applyRegexFlags||!n.flags)return n.source;const r={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},s=r.i?n.source.toLowerCase():n.source;let i="",a=!1,o=!1,c=!1;for(let l=0;l<s.length;l++){if(a){i+=s[l],a=!1;continue}if(r.i){if(o){if(s[l].match(/[a-z]/)){c?(i+=s[l],i+=`${s[l-2]}-${s[l]}`.toUpperCase(),c=!1):s[l+1]==="-"&&((u=s[l+2])!=null&&u.match(/[a-z]/))?(i+=s[l],c=!0):i+=`${s[l]}${s[l].toUpperCase()}`;continue}}else if(s[l].match(/[a-z]/)){i+=`[${s[l]}${s[l].toUpperCase()}]`;continue}}if(r.m){if(s[l]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(s[l]==="$"){i+=`($|(?=[\r
]))`;continue}}if(r.s&&s[l]==="."){i+=o?`${s[l]}\r
`:`[${s[l]}\r
]`;continue}i+=s[l],s[l]==="\\"?a=!0:o&&s[l]==="]"?o=!1:!o&&s[l]==="["&&(o=!0)}try{const l=new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return i};function WC(t,e){var r,s,i,a;if(e.target==="openApi3"&&((r=t.keyType)==null?void 0:r._def.typeName)===D.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((o,c)=>({...o,[c]:Ge(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:Ge(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return n;if(((s=t.keyType)==null?void 0:s._def.typeName)===D.ZodString&&((i=t.keyType._def.checks)!=null&&i.length)){const o=Object.entries(GC(t.keyType._def,e)).reduce((c,[u,l])=>u==="type"?c:{...c,[u]:l},{});return{...n,propertyNames:o}}else if(((a=t.keyType)==null?void 0:a._def.typeName)===D.ZodEnum)return{...n,propertyNames:{enum:t.keyType._def.values}};return n}function Pz(t,e){if(e.mapStrategy==="record")return WC(t,e);const n=Ge(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=Ge(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[n,r],minItems:2,maxItems:2}}}function Lz(t){const e=t.values,r=Object.keys(t.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(r.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function Mz(){return{not:{}}}function Dz(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Ol={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Uz(t,e){if(e.target==="openApi3")return q0(t,e);const n=t.options instanceof Map?Array.from(t.options.values()):t.options;if(n.every(r=>r._def.typeName in Ol&&(!r._def.checks||!r._def.checks.length))){const r=n.reduce((s,i)=>{const a=Ol[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:r.length>1?r:r[0]}}else if(n.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=n.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":if(i._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===n.length){const s=r.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:n.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(n.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((r,s)=>[...r,...s._def.values.filter(i=>!r.includes(i))],[])};return q0(t,e)}const q0=(t,e)=>{const n=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((r,s)=>Ge(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return n.length?{anyOf:n}:void 0};function Bz(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:Ol[t.innerType._def.typeName],nullable:!0}:{type:[Ol[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=Ge(t.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const n=Ge(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function jz(t,e){const n={type:"number"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"int":n.type="integer",qC(n,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?Ye(n,"minimum",r.value,r.message,e):Ye(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),Ye(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?Ye(n,"maximum",r.value,r.message,e):Ye(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),Ye(n,"maximum",r.value,r.message,e));break;case"multipleOf":Ye(n,"multipleOf",r.value,r.message,e);break}return n}function Fz(t,e){return e.removeAdditionalStrategy==="strict"?t.catchall._def.typeName==="ZodNever"?t.unknownKeys!=="strict":Ge(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":Ge(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function zz(t,e){const n={type:"object",...Object.entries(t.shape()).reduce((r,[s,i])=>{var c;if(i===void 0||i._def===void 0)return r;const a=[...e.currentPath,"properties",s],o=Ge(i._def,{...e,currentPath:a,propertyPath:a});if(o===void 0)return r;if(e.openaiStrictMode&&i.isOptional()&&!i.isNullable()&&typeof((c=i._def)==null?void 0:c.defaultValue)>"u")throw new Error(`Zod field at \`${a.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...r.properties,[s]:o},required:i.isOptional()&&!e.openaiStrictMode?r.required:[...r.required,s]}},{properties:{},required:[]}),additionalProperties:Fz(t,e)};return n.required.length||delete n.required,n}const Vz=(t,e)=>{if(e.propertyPath&&e.currentPath.slice(0,e.propertyPath.length).toString()===e.propertyPath.toString())return Ge(t.innerType._def,{...e,currentPath:e.currentPath});const n=Ge(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}},qz=(t,e)=>{if(e.pipeStrategy==="input")return Ge(t.in._def,e);if(e.pipeStrategy==="output")return Ge(t.out._def,e);const n=Ge(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=Ge(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,r].filter(s=>s!==void 0)}};function Hz(t,e){return Ge(t.type._def,e)}function Gz(t,e){const r={type:"array",uniqueItems:!0,items:Ge(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&Ye(r,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&Ye(r,"maxItems",t.maxSize.value,t.maxSize.message,e),r}function Wz(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((n,r)=>Ge(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[]),additionalItems:Ge(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((n,r)=>Ge(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[])}}function Jz(){return{not:{}}}function Zz(){return{}}const Kz=(t,e)=>Ge(t.innerType._def,e);function Ge(t,e,n=!1){var a;const r=e.seen.get(t);if(e.override){const o=(a=e.override)==null?void 0:a.call(e,t,e,r,n);if(o!==gz)return o}if(r&&!n){const o=Xz(r,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const i=Qz(t,t.typeName,e,n);return i&&eV(t,e,i),s.jsonSchema=i,i}const Xz=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"extract-to-root":const n=t.path.slice(e.basePath.length+1).join("_");return n!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[n]=t.def),{$ref:[...e.basePath,e.definitionPath,n].join("/")};case"relative":return{$ref:Yz(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((r,s)=>e.currentPath[s]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Yz=(t,e)=>{let n=0;for(;n<t.length&&n<e.length&&t[n]===e[n];n++);return[(t.length-n).toString(),...e.slice(n)].join("/")},Qz=(t,e,n,r)=>{switch(e){case D.ZodString:return GC(t,n);case D.ZodNumber:return jz(t,n);case D.ZodObject:return zz(t,n);case D.ZodBigInt:return Ez(t,n);case D.ZodBoolean:return Sz();case D.ZodDate:return HC(t,n);case D.ZodUndefined:return Jz();case D.ZodNull:return Dz(n);case D.ZodArray:return vz(t,n);case D.ZodUnion:case D.ZodDiscriminatedUnion:return Uz(t,n);case D.ZodIntersection:return Oz(t,n);case D.ZodTuple:return Wz(t,n);case D.ZodRecord:return WC(t,n);case D.ZodLiteral:return $z(t,n);case D.ZodEnum:return Iz(t);case D.ZodNativeEnum:return Lz(t);case D.ZodNullable:return Bz(t,n);case D.ZodOptional:return Vz(t,n);case D.ZodMap:return Pz(t,n);case D.ZodSet:return Gz(t,n);case D.ZodLazy:return Ge(t.getter()._def,n);case D.ZodPromise:return Hz(t,n);case D.ZodNaN:case D.ZodNever:return Mz();case D.ZodEffects:return kz(t,n,r);case D.ZodAny:return bz();case D.ZodUnknown:return Zz();case D.ZodDefault:return Cz(t,n);case D.ZodBranded:return xz(t,n);case D.ZodReadonly:return Kz(t,n);case D.ZodCatch:return Tz(t,n);case D.ZodPipeline:return qz(t,n);case D.ZodFunction:case D.ZodVoid:case D.ZodSymbol:return;default:return(s=>{})()}},eV=(t,e,n)=>(t.description&&(n.description=t.description,e.markdownDescription&&(n.markdownDescription=t.description)),n),tV=(t,e)=>{const n=wz(e),r=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,s=Ge(t._def,r===void 0?n:{...n,currentPath:[...n.basePath,n.definitionPath,r]},!1)??{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(s.title=i);const a=(()=>{if(_z(n.definitions))return;const c={},u=new Set;for(let l=0;l<500;l++){const d=Object.entries(n.definitions).filter(([h])=>!u.has(h));if(d.length===0)break;for(const[h,f]of d)c[h]=Ge(ym(f),{...n,currentPath:[...n.basePath,n.definitionPath,h]},!0)??{},u.add(h)}return c})(),o=r===void 0?a?{...s,[n.definitionPath]:a}:s:n.nameStrategy==="duplicate-ref"?{...s,...a||n.seenRefs.size?{[n.definitionPath]:{...a,...n.seenRefs.size?{[r]:s}:void 0}}:void 0}:{$ref:[...n.$refStrategy==="relative"?[]:n.basePath,n.definitionPath,r].join("/"),[n.definitionPath]:{...a,[r]:s}};return n.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":n.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function nV(t,e){return!e||!sV(e)?{...t,output_parsed:null,output:t.output.map(n=>n.type==="function_call"?{...n,parsed_arguments:null}:n.type==="message"?{...n,content:n.content.map(r=>({...r,parsed:null}))}:n)}:JC(t,e)}function JC(t,e){const n=t.output.map(s=>{if(s.type==="function_call")return{...s,parsed_arguments:oV(e,s)};if(s.type==="message"){const i=s.content.map(a=>a.type==="output_text"?{...a,parsed:rV(e,a.text)}:a);return{...s,content:i}}return s}),r=Object.assign({},t,{output:n});return Object.getOwnPropertyDescriptor(t,"output_text")||_m(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(const s of r.output)if(s.type==="message"){for(const i of s.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),r}function rV(t,e){var n,r,s,i;return((r=(n=t.text)==null?void 0:n.format)==null?void 0:r.type)!=="json_schema"?null:"$parseRaw"in((s=t.text)==null?void 0:s.format)?((i=t.text)==null?void 0:i.format).$parseRaw(e):JSON.parse(e)}function sV(t){var e;return!!my((e=t.text)==null?void 0:e.format)}function iV(t){return(t==null?void 0:t.$brand)==="auto-parseable-tool"}function aV(t,e){return t.find(n=>n.type==="function"&&n.name===e)}function oV(t,e){const n=aV(t.tools??[],e.name);return{...e,...e,parsed_arguments:iV(n)?n.$parseRaw(e.arguments):n!=null&&n.strict?JSON.parse(e.arguments):null}}function _m(t){const e=[];for(const n of t.output)if(n.type==="message")for(const r of n.content)r.type==="output_text"&&e.push(r.text);t.output_text=e.join("")}function cV(t){if(t.type!=="object")throw new Error(`Root schema must have type: 'object' but got type: ${t.type?`'${t.type}'`:"undefined"}`);const e=structuredClone(t);return es(e,[],e)}function wm(t){if(typeof t=="boolean")return!1;if(t.type==="null")return!0;for(const e of t.oneOf??[])if(wm(e))return!0;for(const e of t.anyOf??[])if(wm(e))return!0;return!1}function es(t,e,n){if(typeof t=="boolean")throw new TypeError(`Expected object schema but got boolean; path=${e.join("/")}`);if(!ri(t))throw new TypeError(`Expected ${JSON.stringify(t)} to be an object; path=${e.join("/")}`);const r=t.$defs;if(ri(r))for(const[h,f]of Object.entries(r))es(f,[...e,"$defs",h],n);const s=t.definitions;if(ri(s))for(const[h,f]of Object.entries(s))es(f,[...e,"definitions",h],n);t.type==="object"&&!("additionalProperties"in t)&&(t.additionalProperties=!1);const a=t.required??[],o=t.properties;if(ri(o)){for(const[h,f]of Object.entries(o))if(!wm(f)&&!a.includes(h))throw new Error(`Zod field at \`${[...e,"properties",h].join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);t.required=Object.keys(o),t.properties=Object.fromEntries(Object.entries(o).map(([h,f])=>[h,es(f,[...e,"properties",h],n)]))}const c=t.items;ri(c)&&(t.items=es(c,[...e,"items"],n));const u=t.anyOf;Array.isArray(u)&&(t.anyOf=u.map((h,f)=>es(h,[...e,"anyOf",String(f)],n)));const l=t.allOf;if(Array.isArray(l))if(l.length===1){const h=es(l[0],[...e,"allOf","0"],n);Object.assign(t,h),delete t.allOf}else t.allOf=l.map((h,f)=>es(h,[...e,"allOf",String(f)],n));t.default===null&&delete t.default;const d=t.$ref;if(d&&lV(t,1)){if(typeof d!="string")throw new TypeError(`Received non-string $ref - ${d}; path=${e.join("/")}`);const h=uV(n,d);if(typeof h=="boolean")throw new Error(`Expected \`$ref: ${d}\` to resolve to an object schema but got boolean`);if(!ri(h))throw new Error(`Expected \`$ref: ${d}\` to resolve to an object but got ${JSON.stringify(h)}`);return Object.assign(t,{...h,...t}),delete t.$ref,es(t,e,n)}return t}function uV(t,e){if(!e.startsWith("#/"))throw new Error(`Unexpected $ref format ${JSON.stringify(e)}; Does not start with #/`);const n=e.slice(2).split("/");let r=t;for(const s of n){if(!ri(r))throw new Error(`encountered non-object entry while resolving ${e} - ${JSON.stringify(r)}`);const i=r[s];if(i===void 0)throw new Error(`Key ${s} not found while resolving ${e}`);r=i}return r}function ri(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function lV(t,e){let n=0;for(const r in t)if(n++,n>e)return!0;return!1}function dV(t,e){return tV(t,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function hV(t){return cV(Xu(t,{target:"draft-7"}))}function fV(t){return"_zod"in t}function pV(t,e,n){return lz({type:"json_schema",json_schema:{...n,name:e,strict:!0,schema:fV(t)?hV(t):dV(t,{name:e})}},r=>t.parse(JSON.parse(r)))}const H0=["jsonSchema","functionCalling","jsonMode"];function mV(t,e){if(typeof e<"u"&&!H0.includes(e))throw new Error(`Invalid method: ${e}. Supported methods are: ${H0.join(", ")}`);const n=!t.startsWith("gpt-3")&&!t.startsWith("gpt-4-")&&t!=="gpt-4";if(n&&!e)return"jsonSchema";if(!n&&e==="jsonSchema")throw new Error(`JSON Schema is not supported for model "${t}". Please use a different method, e.g. "functionCalling" or "jsonMode".`);return e??"functionCalling"}function gV(t,e){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),n}function yV(t,e,n){if(gt(t))return pV(t,e,n);if(ft(t))return gV({type:"json_schema",json_schema:{...n,name:e,strict:!0,schema:Xu(t,{cycles:"ref",reused:"ref",override(r){r.jsonSchema.title=e}})}},r=>nd(t,JSON.parse(r)));throw new Error("Unsupported schema response format")}function _V(t,e){if(e&&typeof e=="object"&&"images"in e&&Array.isArray(e.images)){const n=e.images.filter(r=>{var s;return typeof((s=r==null?void 0:r.image_url)==null?void 0:s.url)=="string"}).map(r=>({type:"image",url:r.image_url.url}));return[{type:"text",text:t},...n]}return t}function G0(t){var r,s,i,a;const e={...((r=t==null?void 0:t.input_tokens_details)==null?void 0:r.cached_tokens)!=null&&{cache_read:(s=t==null?void 0:t.input_tokens_details)==null?void 0:s.cached_tokens}},n={...((i=t==null?void 0:t.output_tokens_details)==null?void 0:i.reasoning_tokens)!=null&&{reasoning:(a=t==null?void 0:t.output_tokens_details)==null?void 0:a.reasoning_tokens}};return{input_tokens:(t==null?void 0:t.input_tokens)??0,output_tokens:(t==null?void 0:t.output_tokens)??0,total_tokens:(t==null?void 0:t.total_tokens)??0,input_token_details:e,output_token_details:n}}function Ae(t,e,n,r,s){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,n),n}function P(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)}let ZC=function(){const{crypto:t}=globalThis;if(t!=null&&t.randomUUID)return ZC=t.randomUUID.bind(t),t.randomUUID();const e=new Uint8Array(1),n=t?()=>t.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^n()&15>>+r/4).toString(16))};const wV=/^[a-z][a-z0-9+.-]*:/i,bV=t=>wV.test(t);let vn=t=>(vn=Array.isArray,vn(t)),W0=vn;function KC(t){return typeof t!="object"?{}:t??{}}function vV(t){if(!t)return!0;for(const e in t)return!1;return!0}function EV(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Uf(t){return t!=null&&typeof t=="object"&&!Array.isArray(t)}const SV=(t,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new we(`${t} must be an integer`);if(e<0)throw new we(`${t} must be a positive integer`);return e},xV=t=>{try{return JSON.parse(t)}catch{return}},Ac=t=>new Promise(e=>setTimeout(e,t)),Xi="6.7.0",TV=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function AV(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const CV=()=>{var n;const t=AV();if(t==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Xi,"X-Stainless-OS":Z0(Deno.build.os),"X-Stainless-Arch":J0(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((n=Deno.version)==null?void 0:n.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Xi,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(t==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Xi,"X-Stainless-OS":Z0(globalThis.process.platform??"unknown"),"X-Stainless-Arch":J0(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const e=kV();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Xi,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Xi,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function kV(){if(typeof navigator>"u"||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:n}of t){const r=n.exec(navigator.userAgent);if(r){const s=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}const J0=t=>t==="x32"?"x32":t==="x86_64"||t==="x64"?"x64":t==="arm"?"arm":t==="aarch64"||t==="arm64"?"arm64":t?`other:${t}`:"unknown",Z0=t=>(t=t.toLowerCase(),t.includes("ios")?"iOS":t==="android"?"Android":t==="darwin"?"MacOS":t==="win32"?"Windows":t==="freebsd"?"FreeBSD":t==="openbsd"?"OpenBSD":t==="linux"?"Linux":t?`Other:${t}`:"Unknown");let K0;const IV=()=>K0??(K0=CV());function RV(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function XC(...t){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...t)}function YC(t){let e=Symbol.asyncIterator in t?t[Symbol.asyncIterator]():t[Symbol.iterator]();return XC({start(){},async pull(n){const{done:r,value:s}=await e.next();r?n.close():n.enqueue(s)},async cancel(){var n;await((n=e.return)==null?void 0:n.call(e))}})}function QC(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const n=await e.read();return n!=null&&n.done&&e.releaseLock(),n}catch(n){throw e.releaseLock(),n}},async return(){const n=e.cancel();return e.releaseLock(),await n,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function OV(t){var r,s;if(t===null||typeof t!="object")return;if(t[Symbol.asyncIterator]){await((s=(r=t[Symbol.asyncIterator]()).return)==null?void 0:s.call(r));return}const e=t.getReader(),n=e.cancel();e.releaseLock(),await n}const $V=({headers:t,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)}),ek="RFC3986",tk=t=>String(t),X0={RFC1738:t=>String(t).replace(/%20/g,"+"),RFC3986:tk},NV="RFC1738";let bm=(t,e)=>(bm=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),bm(t,e));const Rr=(()=>{const t=[];for(let e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t})(),Bf=1024,PV=(t,e,n,r,s)=>{if(t.length===0)return t;let i=t;if(typeof t=="symbol"?i=Symbol.prototype.toString.call(t):typeof t!="string"&&(i=String(t)),n==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let a="";for(let o=0;o<i.length;o+=Bf){const c=i.length>=Bf?i.slice(o,o+Bf):i,u=[];for(let l=0;l<c.length;++l){let d=c.charCodeAt(l);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||s===NV&&(d===40||d===41)){u[u.length]=c.charAt(l);continue}if(d<128){u[u.length]=Rr[d];continue}if(d<2048){u[u.length]=Rr[192|d>>6]+Rr[128|d&63];continue}if(d<55296||d>=57344){u[u.length]=Rr[224|d>>12]+Rr[128|d>>6&63]+Rr[128|d&63];continue}l+=1,d=65536+((d&1023)<<10|c.charCodeAt(l)&1023),u[u.length]=Rr[240|d>>18]+Rr[128|d>>12&63]+Rr[128|d>>6&63]+Rr[128|d&63]}a+=u.join("")}return a};function LV(t){return!t||typeof t!="object"?!1:!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))}function Y0(t,e){if(vn(t)){const n=[];for(let r=0;r<t.length;r+=1)n.push(e(t[r]));return n}return e(t)}const nk={brackets(t){return String(t)+"[]"},comma:"comma",indices(t,e){return String(t)+"["+e+"]"},repeat(t){return String(t)}},rk=function(t,e){Array.prototype.push.apply(t,vn(e)?e:[e])};let Q0;const kt={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:PV,encodeValuesOnly:!1,format:ek,formatter:tk,indices:!1,serializeDate(t){return(Q0??(Q0=Function.prototype.call.bind(Date.prototype.toISOString)))(t)},skipNulls:!1,strictNullHandling:!1};function MV(t){return typeof t=="string"||typeof t=="number"||typeof t=="boolean"||typeof t=="symbol"||typeof t=="bigint"}const jf={};function sk(t,e,n,r,s,i,a,o,c,u,l,d,h,f,m,g,_,b){let y=t,E=b,C=0,k=!1;for(;(E=E.get(jf))!==void 0&&!k;){const z=E.get(t);if(C+=1,typeof z<"u"){if(z===C)throw new RangeError("Cyclic object value");k=!0}typeof E.get(jf)>"u"&&(C=0)}if(typeof u=="function"?y=u(e,y):y instanceof Date?y=h==null?void 0:h(y):n==="comma"&&vn(y)&&(y=Y0(y,function(z){return z instanceof Date?h==null?void 0:h(z):z})),y===null){if(i)return c&&!g?c(e,kt.encoder,_,"key",f):e;y=""}if(MV(y)||LV(y)){if(c){const z=g?e:c(e,kt.encoder,_,"key",f);return[(m==null?void 0:m(z))+"="+(m==null?void 0:m(c(y,kt.encoder,_,"value",f)))]}return[(m==null?void 0:m(e))+"="+(m==null?void 0:m(String(y)))]}const R=[];if(typeof y>"u")return R;let $;if(n==="comma"&&vn(y))g&&c&&(y=Y0(y,c)),$=[{value:y.length>0?y.join(",")||null:void 0}];else if(vn(u))$=u;else{const z=Object.keys(y);$=l?z.sort(l):z}const T=o?String(e).replace(/\./g,"%2E"):String(e),B=r&&vn(y)&&y.length===1?T+"[]":T;if(s&&vn(y)&&y.length===0)return B+"[]";for(let z=0;z<$.length;++z){const q=$[z],ie=typeof q=="object"&&typeof q.value<"u"?q.value:y[q];if(a&&ie===null)continue;const me=d&&o?q.replace(/\./g,"%2E"):q,j=vn(y)?typeof n=="function"?n(B,me):B:B+(d?"."+me:"["+me+"]");b.set(t,C);const F=new WeakMap;F.set(jf,b),rk(R,sk(ie,j,n,r,s,i,a,o,n==="comma"&&g&&vn(y)?null:c,u,l,d,h,f,m,g,_,F))}return R}function DV(t=kt){if(typeof t.allowEmptyArrays<"u"&&typeof t.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof t.encodeDotInKeys<"u"&&typeof t.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(t.encoder!==null&&typeof t.encoder<"u"&&typeof t.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=t.charset||kt.charset;if(typeof t.charset<"u"&&t.charset!=="utf-8"&&t.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=ek;if(typeof t.format<"u"){if(!bm(X0,t.format))throw new TypeError("Unknown format option provided.");n=t.format}const r=X0[n];let s=kt.filter;(typeof t.filter=="function"||vn(t.filter))&&(s=t.filter);let i;if(t.arrayFormat&&t.arrayFormat in nk?i=t.arrayFormat:"indices"in t?i=t.indices?"indices":"repeat":i=kt.arrayFormat,"commaRoundTrip"in t&&typeof t.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=typeof t.allowDots>"u"?t.encodeDotInKeys?!0:kt.allowDots:!!t.allowDots;return{addQueryPrefix:typeof t.addQueryPrefix=="boolean"?t.addQueryPrefix:kt.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof t.allowEmptyArrays=="boolean"?!!t.allowEmptyArrays:kt.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof t.charsetSentinel=="boolean"?t.charsetSentinel:kt.charsetSentinel,commaRoundTrip:!!t.commaRoundTrip,delimiter:typeof t.delimiter>"u"?kt.delimiter:t.delimiter,encode:typeof t.encode=="boolean"?t.encode:kt.encode,encodeDotInKeys:typeof t.encodeDotInKeys=="boolean"?t.encodeDotInKeys:kt.encodeDotInKeys,encoder:typeof t.encoder=="function"?t.encoder:kt.encoder,encodeValuesOnly:typeof t.encodeValuesOnly=="boolean"?t.encodeValuesOnly:kt.encodeValuesOnly,filter:s,format:n,formatter:r,serializeDate:typeof t.serializeDate=="function"?t.serializeDate:kt.serializeDate,skipNulls:typeof t.skipNulls=="boolean"?t.skipNulls:kt.skipNulls,sort:typeof t.sort=="function"?t.sort:null,strictNullHandling:typeof t.strictNullHandling=="boolean"?t.strictNullHandling:kt.strictNullHandling}}function UV(t,e={}){let n=t;const r=DV(e);let s,i;typeof r.filter=="function"?(i=r.filter,n=i("",n)):vn(r.filter)&&(i=r.filter,s=i);const a=[];if(typeof n!="object"||n===null)return"";const o=nk[r.arrayFormat],c=o==="comma"&&r.commaRoundTrip;s||(s=Object.keys(n)),r.sort&&s.sort(r.sort);const u=new WeakMap;for(let h=0;h<s.length;++h){const f=s[h];r.skipNulls&&n[f]===null||rk(a,sk(n[f],f,o,c,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,u))}const l=a.join(r.delimiter);let d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),l.length>0?d+l:""}function BV(t){let e=0;for(const s of t)e+=s.length;const n=new Uint8Array(e);let r=0;for(const s of t)n.set(s,r),r+=s.length;return n}let ev;function yy(t){let e;return(ev??(e=new globalThis.TextEncoder,ev=e.encode.bind(e)))(t)}let tv;function nv(t){let e;return(tv??(e=new globalThis.TextDecoder,tv=e.decode.bind(e)))(t)}var Ln,Mn;class Sd{constructor(){Ln.set(this,void 0),Mn.set(this,void 0),Ae(this,Ln,new Uint8Array),Ae(this,Mn,null)}decode(e){if(e==null)return[];const n=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?yy(e):e;Ae(this,Ln,BV([P(this,Ln,"f"),n]));const r=[];let s;for(;(s=jV(P(this,Ln,"f"),P(this,Mn,"f")))!=null;){if(s.carriage&&P(this,Mn,"f")==null){Ae(this,Mn,s.index);continue}if(P(this,Mn,"f")!=null&&(s.index!==P(this,Mn,"f")+1||s.carriage)){r.push(nv(P(this,Ln,"f").subarray(0,P(this,Mn,"f")-1))),Ae(this,Ln,P(this,Ln,"f").subarray(P(this,Mn,"f"))),Ae(this,Mn,null);continue}const i=P(this,Mn,"f")!==null?s.preceding-1:s.preceding,a=nv(P(this,Ln,"f").subarray(0,i));r.push(a),Ae(this,Ln,P(this,Ln,"f").subarray(s.index)),Ae(this,Mn,null)}return r}flush(){return P(this,Ln,"f").length?this.decode(`
`):[]}}Ln=new WeakMap,Mn=new WeakMap;Sd.NEWLINE_CHARS=new Set([`
`,"\r"]);Sd.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function jV(t,e){for(let s=e??0;s<t.length;s++){if(t[s]===10)return{preceding:s,index:s+1,carriage:!1};if(t[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function FV(t){for(let r=0;r<t.length-1;r++){if(t[r]===10&&t[r+1]===10||t[r]===13&&t[r+1]===13)return r+2;if(t[r]===13&&t[r+1]===10&&r+3<t.length&&t[r+2]===13&&t[r+3]===10)return r+4}return-1}const $l={off:0,error:200,warn:300,info:400,debug:500},rv=(t,e,n)=>{if(t){if(EV($l,t))return t;Ht(n).warn(`${e} was set to ${JSON.stringify(t)}, expected one of ${JSON.stringify(Object.keys($l))}`)}};function no(){}function eu(t,e,n){return!e||$l[t]>$l[n]?no:e[t].bind(e)}const zV={error:no,warn:no,info:no,debug:no};let sv=new WeakMap;function Ht(t){const e=t.logger,n=t.logLevel??"off";if(!e)return zV;const r=sv.get(e);if(r&&r[0]===n)return r[1];const s={error:eu("error",e,n),warn:eu("warn",e,n),info:eu("info",e,n),debug:eu("debug",e,n)};return sv.set(e,[n,s]),s}const si=t=>(t.options&&(t.options={...t.options},delete t.options.headers),t.headers&&(t.headers=Object.fromEntries((t.headers instanceof Headers?[...t.headers]:Object.entries(t.headers)).map(([e,n])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":n]))),"retryOfRequestLogID"in t&&(t.retryOfRequestLogID&&(t.retryOf=t.retryOfRequestLogID),delete t.retryOfRequestLogID),t);var Wa;class jr{constructor(e,n,r){this.iterator=e,Wa.set(this,void 0),this.controller=n,Ae(this,Wa,r)}static fromSSEResponse(e,n,r){let s=!1;const i=r?Ht(r):console;async function*a(){if(s)throw new we("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(const c of VV(e,n))if(!o){if(c.data.startsWith("[DONE]")){o=!0;continue}if(c.event===null||!c.event.startsWith("thread.")){let u;try{u=JSON.parse(c.data)}catch(l){throw i.error("Could not parse message into JSON:",c.data),i.error("From chunk:",c.raw),l}if(u&&u.error)throw new Xt(void 0,u.error,void 0,e.headers);yield u}else{let u;try{u=JSON.parse(c.data)}catch(l){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),l}if(c.event=="error")throw new Xt(void 0,u.error,u.message,void 0);yield{event:c.event,data:u}}}o=!0}catch(c){if(mm(c))return;throw c}finally{o||n.abort()}}return new jr(a,n,r)}static fromReadableStream(e,n,r){let s=!1;async function*i(){const o=new Sd,c=QC(e);for await(const u of c)for(const l of o.decode(u))yield l;for(const u of o.flush())yield u}async function*a(){if(s)throw new we("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(const c of i())o||c&&(yield JSON.parse(c));o=!0}catch(c){if(mm(c))return;throw c}finally{o||n.abort()}}return new jr(a,n,r)}[(Wa=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],n=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){const a=r.next();e.push(a),n.push(a)}return i.shift()}});return[new jr(()=>s(e),this.controller,P(this,Wa,"f")),new jr(()=>s(n),this.controller,P(this,Wa,"f"))]}toReadableStream(){const e=this;let n;return XC({async start(){n=e[Symbol.asyncIterator]()},async pull(r){try{const{value:s,done:i}=await n.next();if(i)return r.close();const a=yy(JSON.stringify(s)+`
`);r.enqueue(a)}catch(s){r.error(s)}},async cancel(){var r;await((r=n.return)==null?void 0:r.call(n))}})}}async function*VV(t,e){if(!t.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new we("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new we("Attempted to iterate over a response with no body");const n=new HV,r=new Sd,s=QC(t.body);for await(const i of qV(s))for(const a of r.decode(i)){const o=n.decode(a);o&&(yield o)}for(const i of r.flush()){const a=n.decode(i);a&&(yield a)}}async function*qV(t){let e=new Uint8Array;for await(const n of t){if(n==null)continue;const r=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?yy(n):n;let s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let i;for(;(i=FV(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}class HV{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[n,r,s]=GV(e,":");return s.startsWith(" ")&&(s=s.substring(1)),n==="event"?this.event=s:n==="data"&&this.data.push(s),null}}function GV(t,e){const n=t.indexOf(e);return n!==-1?[t.substring(0,n),e,t.substring(n+e.length)]:[t,"",""]}async function ik(t,e){const{response:n,requestLogID:r,retryOfRequestLogID:s,startTime:i}=e,a=await(async()=>{var d;if(e.options.stream)return Ht(t).debug("response",n.status,n.url,n.headers,n.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(n,e.controller,t):jr.fromSSEResponse(n,e.controller,t);if(n.status===204)return null;if(e.options.__binaryResponse)return n;const o=n.headers.get("content-type"),c=(d=o==null?void 0:o.split(";")[0])==null?void 0:d.trim();if((c==null?void 0:c.includes("application/json"))||(c==null?void 0:c.endsWith("+json"))){const h=await n.json();return ak(h,n)}return await n.text()})();return Ht(t).debug(`[${r}] response parsed`,si({retryOfRequestLogID:s,url:n.url,status:n.status,body:a,durationMs:Date.now()-i})),a}function ak(t,e){return!t||typeof t!="object"||Array.isArray(t)?t:Object.defineProperty(t,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var ro;class xd extends Promise{constructor(e,n,r=ik){super(s=>{s(null)}),this.responsePromise=n,this.parseResponse=r,ro.set(this,void 0),Ae(this,ro,e)}_thenUnwrap(e){return new xd(P(this,ro,"f"),this.responsePromise,async(n,r)=>ak(e(await this.parseResponse(n,r),r),r.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,n]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:n,request_id:n.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(P(this,ro,"f"),e))),this.parsedPromise}then(e,n){return this.parse().then(e,n)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}ro=new WeakMap;var tu;class _y{constructor(e,n,r,s){tu.set(this,void 0),Ae(this,tu,e),this.options=s,this.response=n,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new we("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await P(this,tu,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(tu=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const n of e.getPaginatedItems())yield n}}class WV extends xd{constructor(e,n,r){super(e,n,async(s,i)=>new r(s,i.response,await ik(s,i),i.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const n of e)yield n}}class Td extends _y{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class xt extends _y{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var r;const e=this.getPaginatedItems(),n=(r=e[e.length-1])==null?void 0:r.id;return n?{...this.options,query:{...KC(this.options.query),after:n}}:null}}class Nl extends _y{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.has_more=r.has_more||!1,this.last_id=r.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const e=this.last_id;return e?{...this.options,query:{...KC(this.options.query),after:e}}:null}}const ok=()=>{var t;if(typeof File>"u"){const{process:e}=globalThis,n=typeof((t=e==null?void 0:e.versions)==null?void 0:t.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(n?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function Eo(t,e,n){return ok(),new File(t,e??"unknown_file",n)}function Nu(t){return(typeof t=="object"&&t!==null&&("name"in t&&t.name&&String(t.name)||"url"in t&&t.url&&String(t.url)||"filename"in t&&t.filename&&String(t.filename)||"path"in t&&t.path&&String(t.path))||"").split(/[\\/]/).pop()||void 0}const wy=t=>t!=null&&typeof t=="object"&&typeof t[Symbol.asyncIterator]=="function",iv=async(t,e)=>vm(t.body)?{...t,body:await ck(t.body,e)}:t,ki=async(t,e)=>({...t,body:await ck(t.body,e)}),av=new WeakMap;function JV(t){const e=typeof t=="function"?t:t.fetch,n=av.get(e);if(n)return n;const r=(async()=>{try{const s="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new s(i).text()}catch{return!0}})();return av.set(e,r),r}const ck=async(t,e)=>{if(!await JV(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const n=new FormData;return await Promise.all(Object.entries(t||{}).map(([r,s])=>Em(n,r,s))),n},uk=t=>t instanceof Blob&&"name"in t,ZV=t=>typeof t=="object"&&t!==null&&(t instanceof Response||wy(t)||uk(t)),vm=t=>{if(ZV(t))return!0;if(Array.isArray(t))return t.some(vm);if(t&&typeof t=="object"){for(const e in t)if(vm(t[e]))return!0}return!1},Em=async(t,e,n)=>{if(n!==void 0){if(n==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")t.append(e,String(n));else if(n instanceof Response)t.append(e,Eo([await n.blob()],Nu(n)));else if(wy(n))t.append(e,Eo([await new Response(YC(n)).blob()],Nu(n)));else if(uk(n))t.append(e,n,Nu(n));else if(Array.isArray(n))await Promise.all(n.map(r=>Em(t,e+"[]",r)));else if(typeof n=="object")await Promise.all(Object.entries(n).map(([r,s])=>Em(t,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`)}},lk=t=>t!=null&&typeof t=="object"&&typeof t.size=="number"&&typeof t.type=="string"&&typeof t.text=="function"&&typeof t.slice=="function"&&typeof t.arrayBuffer=="function",KV=t=>t!=null&&typeof t=="object"&&typeof t.name=="string"&&typeof t.lastModified=="number"&&lk(t),XV=t=>t!=null&&typeof t=="object"&&typeof t.url=="string"&&typeof t.blob=="function";async function YV(t,e,n){if(ok(),t=await t,KV(t))return t instanceof File?t:Eo([await t.arrayBuffer()],t.name);if(XV(t)){const s=await t.blob();return e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()),Eo(await Sm(s),e,n)}const r=await Sm(t);if(e||(e=Nu(t)),!(n!=null&&n.type)){const s=r.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof s=="string"&&(n={...n,type:s})}return Eo(r,e,n)}async function Sm(t){var n;let e=[];if(typeof t=="string"||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)e.push(t);else if(lk(t))e.push(t instanceof Blob?t:await t.arrayBuffer());else if(wy(t))for await(const r of t)e.push(...await Sm(r));else{const r=(n=t==null?void 0:t.constructor)==null?void 0:n.name;throw new Error(`Unexpected data type: ${typeof t}${r?`; constructor: ${r}`:""}${QV(t)}`)}return e}function QV(t){return typeof t!="object"||t===null?"":`; props: [${Object.getOwnPropertyNames(t).map(n=>`"${n}"`).join(", ")}]`}class ge{constructor(e){this._client=e}}function dk(t){return t.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const ov=Object.freeze(Object.create(null)),eq=(t=dk)=>function(n,...r){if(n.length===1)return n[0];let s=!1;const i=[],a=n.reduce((l,d,h)=>{var g;/[?#]/.test(d)&&(s=!0);const f=r[h];let m=(s?encodeURIComponent:t)(""+f);return h!==r.length&&(f==null||typeof f=="object"&&f.toString===((g=Object.getPrototypeOf(Object.getPrototypeOf(f.hasOwnProperty??ov)??ov))==null?void 0:g.toString))&&(m=f+"",i.push({start:l.length+d.length,length:m.length,error:`Value of type ${Object.prototype.toString.call(f).slice(8,-1)} is not a valid path parameter`})),l+d+(h===r.length?"":m)},""),o=a.split(/[?#]/,1)[0],c=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let u;for(;(u=c.exec(o))!==null;)i.push({start:u.index,length:u[0].length,error:`Value "${u[0]}" can't be safely passed as a path parameter`});if(i.sort((l,d)=>l.start-d.start),i.length>0){let l=0;const d=i.reduce((h,f)=>{const m=" ".repeat(f.start-l),g="^".repeat(f.length);return l=f.start+f.length,h+m+g},"");throw new we(`Path parameters result in path with invalid segments:
${i.map(h=>h.error).join(`
`)}
${a}
${d}`)}return a},V=eq(dk);let hk=class extends ge{list(e,n={},r){return this._client.getAPIList(V`/chat/completions/${e}/messages`,xt,{query:n,...r})}};const Pl=t=>(t==null?void 0:t.role)==="assistant",fk=t=>(t==null?void 0:t.role)==="tool";var xm,Pu,Lu,so,io,Mu,ao,ts,oo,Ll,Ml,Yi,pk;class by{constructor(){xm.add(this),this.controller=new AbortController,Pu.set(this,void 0),Lu.set(this,()=>{}),so.set(this,()=>{}),io.set(this,void 0),Mu.set(this,()=>{}),ao.set(this,()=>{}),ts.set(this,{}),oo.set(this,!1),Ll.set(this,!1),Ml.set(this,!1),Yi.set(this,!1),Ae(this,Pu,new Promise((e,n)=>{Ae(this,Lu,e,"f"),Ae(this,so,n,"f")})),Ae(this,io,new Promise((e,n)=>{Ae(this,Mu,e,"f"),Ae(this,ao,n,"f")})),P(this,Pu,"f").catch(()=>{}),P(this,io,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},P(this,xm,"m",pk).bind(this))},0)}_connected(){this.ended||(P(this,Lu,"f").call(this),this._emit("connect"))}get ended(){return P(this,oo,"f")}get errored(){return P(this,Ll,"f")}get aborted(){return P(this,Ml,"f")}abort(){this.controller.abort()}on(e,n){return(P(this,ts,"f")[e]||(P(this,ts,"f")[e]=[])).push({listener:n}),this}off(e,n){const r=P(this,ts,"f")[e];if(!r)return this;const s=r.findIndex(i=>i.listener===n);return s>=0&&r.splice(s,1),this}once(e,n){return(P(this,ts,"f")[e]||(P(this,ts,"f")[e]=[])).push({listener:n,once:!0}),this}emitted(e){return new Promise((n,r)=>{Ae(this,Yi,!0),e!=="error"&&this.once("error",r),this.once(e,n)})}async done(){Ae(this,Yi,!0),await P(this,io,"f")}_emit(e,...n){if(P(this,oo,"f"))return;e==="end"&&(Ae(this,oo,!0),P(this,Mu,"f").call(this));const r=P(this,ts,"f")[e];if(r&&(P(this,ts,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...n))),e==="abort"){const s=n[0];!P(this,Yi,"f")&&!(r!=null&&r.length)&&Promise.reject(s),P(this,so,"f").call(this,s),P(this,ao,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=n[0];!P(this,Yi,"f")&&!(r!=null&&r.length)&&Promise.reject(s),P(this,so,"f").call(this,s),P(this,ao,"f").call(this,s),this._emit("end")}}_emitFinal(){}}Pu=new WeakMap,Lu=new WeakMap,so=new WeakMap,io=new WeakMap,Mu=new WeakMap,ao=new WeakMap,ts=new WeakMap,oo=new WeakMap,Ll=new WeakMap,Ml=new WeakMap,Yi=new WeakMap,xm=new WeakSet,pk=function(e){if(Ae(this,Ll,!0),e instanceof Error&&e.name==="AbortError"&&(e=new Fn),e instanceof Fn)return Ae(this,Ml,!0),this._emit("abort",e);if(e instanceof we)return this._emit("error",e);if(e instanceof Error){const n=new we(e.message);return n.cause=e,this._emit("error",n)}return this._emit("error",new we(String(e)))};function tq(t){return typeof t.parse=="function"}var un,Tm,Dl,Am,Cm,km,mk,gk;const nq=10;class yk extends by{constructor(){super(...arguments),un.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const n=(r=e.choices[0])==null?void 0:r.message;return n&&this._addMessage(n),e}_addMessage(e,n=!0){if("content"in e||(e.content=null),this.messages.push(e),n){if(this._emit("message",e),fk(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(Pl(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionToolCall",r.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new we("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),P(this,un,"m",Tm).call(this)}async finalMessage(){return await this.done(),P(this,un,"m",Dl).call(this)}async finalFunctionToolCall(){return await this.done(),P(this,un,"m",Am).call(this)}async finalFunctionToolCallResult(){return await this.done(),P(this,un,"m",Cm).call(this)}async totalUsage(){return await this.done(),P(this,un,"m",km).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const n=P(this,un,"m",Dl).call(this);n&&this._emit("finalMessage",n);const r=P(this,un,"m",Tm).call(this);r&&this._emit("finalContent",r);const s=P(this,un,"m",Am).call(this);s&&this._emit("finalFunctionToolCall",s);const i=P(this,un,"m",Cm).call(this);i!=null&&this._emit("finalFunctionToolCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",P(this,un,"m",km).call(this))}async _createChatCompletion(e,n,r){const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),P(this,un,"m",mk).call(this,n);const i=await e.chat.completions.create({...n,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(gy(i,n))}async _runChatCompletion(e,n,r){for(const s of n.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,n,r)}async _runTools(e,n,r){var f,m,g;const s="tool",{tool_choice:i="auto",stream:a,...o}=n,c=typeof i!="string"&&i.type==="function"&&((f=i==null?void 0:i.function)==null?void 0:f.name),{maxChatCompletions:u=nq}=r||{},l=n.tools.map(_=>{if(Tc(_)){if(!_.$callback)throw new we("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:_.$callback,name:_.function.name,description:_.function.description||"",parameters:_.function.parameters,parse:_.$parseRaw,strict:!0}}}return _}),d={};for(const _ of l)_.type==="function"&&(d[_.function.name||_.function.function.name]=_.function);const h="tools"in n?l.map(_=>_.type==="function"?{type:"function",function:{name:_.function.name||_.function.function.name,parameters:_.function.parameters,description:_.function.description,strict:_.function.strict}}:_):void 0;for(const _ of n.messages)this._addMessage(_,!1);for(let _=0;_<u;++_){const y=(m=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:h,messages:[...this.messages]},r)).choices[0])==null?void 0:m.message;if(!y)throw new we("missing message in ChatCompletion response");if(!((g=y.tool_calls)!=null&&g.length))return;for(const E of y.tool_calls){if(E.type!=="function")continue;const C=E.id,{name:k,arguments:R}=E.function,$=d[k];if($){if(c&&c!==k){const q=`Invalid tool_call: ${JSON.stringify(k)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:s,tool_call_id:C,content:q});continue}}else{const q=`Invalid tool_call: ${JSON.stringify(k)}. Available options are: ${Object.keys(d).map(ie=>JSON.stringify(ie)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:C,content:q});continue}let T;try{T=tq($)?await $.parse(R):R}catch(q){const ie=q instanceof Error?q.message:String(q);this._addMessage({role:s,tool_call_id:C,content:ie});continue}const B=await $.function(T,this),z=P(this,un,"m",gk).call(this,B);if(this._addMessage({role:s,tool_call_id:C,content:z}),c)return}}}}un=new WeakSet,Tm=function(){return P(this,un,"m",Dl).call(this).content??null},Dl=function(){let e=this.messages.length;for(;e-- >0;){const n=this.messages[e];if(Pl(n))return{...n,content:n.content??null,refusal:n.refusal??null}}throw new we("stream ended without producing a ChatCompletionMessage with role=assistant")},Am=function(){var e,n;for(let r=this.messages.length-1;r>=0;r--){const s=this.messages[r];if(Pl(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(n=s.tool_calls.filter(i=>i.type==="function").at(-1))==null?void 0:n.function}},Cm=function(){for(let e=this.messages.length-1;e>=0;e--){const n=this.messages[e];if(fk(n)&&n.content!=null&&typeof n.content=="string"&&this.messages.some(r=>{var s;return r.role==="assistant"&&((s=r.tool_calls)==null?void 0:s.some(i=>i.type==="function"&&i.id===n.tool_call_id))}))return n.content}},km=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:n}of this._chatCompletions)n&&(e.completion_tokens+=n.completion_tokens,e.prompt_tokens+=n.prompt_tokens,e.total_tokens+=n.total_tokens);return e},mk=function(e){if(e.n!=null&&e.n>1)throw new we("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},gk=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class vy extends yk{static runTools(e,n,r){const s=new vy,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,n,i)),s}_addMessage(e,n=!0){super._addMessage(e,n),Pl(e)&&e.content&&this._emit("content",e.content)}}const _k=1,wk=2,bk=4,vk=8,Ek=16,Sk=32,xk=64,Tk=128,Ak=256,Ck=Tk|Ak,kk=Ek|Sk|Ck|xk,Ik=_k|wk|kk,Rk=bk|vk,rq=Ik|Rk,Pt={STR:_k,NUM:wk,ARR:bk,OBJ:vk,NULL:Ek,BOOL:Sk,NAN:xk,INFINITY:Tk,MINUS_INFINITY:Ak,INF:Ck,SPECIAL:kk,ATOM:Ik,COLLECTION:Rk,ALL:rq};class sq extends Error{}class iq extends Error{}function aq(t,e=Pt.ALL){if(typeof t!="string")throw new TypeError(`expecting str, got ${typeof t}`);if(!t.trim())throw new Error(`${t} is empty`);return oq(t.trim(),e)}const oq=(t,e)=>{const n=t.length;let r=0;const s=h=>{throw new sq(`${h} at position ${r}`)},i=h=>{throw new iq(`${h} at position ${r}`)},a=()=>(d(),r>=n&&s("Unexpected end of input"),t[r]==='"'?o():t[r]==="{"?c():t[r]==="["?u():t.substring(r,r+4)==="null"||Pt.NULL&e&&n-r<4&&"null".startsWith(t.substring(r))?(r+=4,null):t.substring(r,r+4)==="true"||Pt.BOOL&e&&n-r<4&&"true".startsWith(t.substring(r))?(r+=4,!0):t.substring(r,r+5)==="false"||Pt.BOOL&e&&n-r<5&&"false".startsWith(t.substring(r))?(r+=5,!1):t.substring(r,r+8)==="Infinity"||Pt.INFINITY&e&&n-r<8&&"Infinity".startsWith(t.substring(r))?(r+=8,1/0):t.substring(r,r+9)==="-Infinity"||Pt.MINUS_INFINITY&e&&1<n-r&&n-r<9&&"-Infinity".startsWith(t.substring(r))?(r+=9,-1/0):t.substring(r,r+3)==="NaN"||Pt.NAN&e&&n-r<3&&"NaN".startsWith(t.substring(r))?(r+=3,NaN):l()),o=()=>{const h=r;let f=!1;for(r++;r<n&&(t[r]!=='"'||f&&t[r-1]==="\\");)f=t[r]==="\\"?!f:!1,r++;if(t.charAt(r)=='"')try{return JSON.parse(t.substring(h,++r-Number(f)))}catch(m){i(String(m))}else if(Pt.STR&e)try{return JSON.parse(t.substring(h,r-Number(f))+'"')}catch{return JSON.parse(t.substring(h,t.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},c=()=>{r++,d();const h={};try{for(;t[r]!=="}";){if(d(),r>=n&&Pt.OBJ&e)return h;const f=o();d(),r++;try{const m=a();Object.defineProperty(h,f,{value:m,writable:!0,enumerable:!0,configurable:!0})}catch(m){if(Pt.OBJ&e)return h;throw m}d(),t[r]===","&&r++}}catch{if(Pt.OBJ&e)return h;s("Expected '}' at end of object")}return r++,h},u=()=>{r++;const h=[];try{for(;t[r]!=="]";)h.push(a()),d(),t[r]===","&&r++}catch{if(Pt.ARR&e)return h;s("Expected ']' at end of array")}return r++,h},l=()=>{if(r===0){t==="-"&&Pt.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t)}catch(f){if(Pt.NUM&e)try{return t[t.length-1]==="."?JSON.parse(t.substring(0,t.lastIndexOf("."))):JSON.parse(t.substring(0,t.lastIndexOf("e")))}catch{}i(String(f))}}const h=r;for(t[r]==="-"&&r++;t[r]&&!",]}".includes(t[r]);)r++;r==n&&!(Pt.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(t.substring(h,r))}catch{t.substring(h,r)==="-"&&Pt.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t.substring(h,t.lastIndexOf("e")))}catch(m){i(String(m))}}},d=()=>{for(;r<n&&` 
\r	`.includes(t[r]);)r++};return a()},cv=t=>aq(t,Pt.ALL^Pt.NUM);var At,Qr,Vi,Ts,Ff,nu,zf,Vf,qf,ru,Hf,uv;class ec extends yk{constructor(e){super(),At.add(this),Qr.set(this,void 0),Vi.set(this,void 0),Ts.set(this,void 0),Ae(this,Qr,e),Ae(this,Vi,[])}get currentChatCompletionSnapshot(){return P(this,Ts,"f")}static fromReadableStream(e){const n=new ec(null);return n._run(()=>n._fromReadableStream(e)),n}static createChatCompletion(e,n,r){const s=new ec(n);return s._run(()=>s._runChatCompletion(e,{...n,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,n,r){var a;super._createChatCompletion;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),P(this,At,"m",Ff).call(this);const i=await e.chat.completions.create({...n,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of i)P(this,At,"m",zf).call(this,o);if((a=i.controller.signal)!=null&&a.aborted)throw new Fn;return this._addChatCompletion(P(this,At,"m",ru).call(this))}async _fromReadableStream(e,n){var a;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),P(this,At,"m",Ff).call(this),this._connected();const s=jr.fromReadableStream(e,this.controller);let i;for await(const o of s)i&&i!==o.id&&this._addChatCompletion(P(this,At,"m",ru).call(this)),P(this,At,"m",zf).call(this,o),i=o.id;if((a=s.controller.signal)!=null&&a.aborted)throw new Fn;return this._addChatCompletion(P(this,At,"m",ru).call(this))}[(Qr=new WeakMap,Vi=new WeakMap,Ts=new WeakMap,At=new WeakSet,Ff=function(){this.ended||Ae(this,Ts,void 0)},nu=function(n){let r=P(this,Vi,"f")[n.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},P(this,Vi,"f")[n.index]=r,r)},zf=function(n){var s,i,a,o,c,u,l,d,h,f,m,g,_,b,y;if(this.ended)return;const r=P(this,At,"m",uv).call(this,n);this._emit("chunk",n,r);for(const E of n.choices){const C=r.choices[E.index];E.delta.content!=null&&((s=C.message)==null?void 0:s.role)==="assistant"&&((i=C.message)!=null&&i.content)&&(this._emit("content",E.delta.content,C.message.content),this._emit("content.delta",{delta:E.delta.content,snapshot:C.message.content,parsed:C.message.parsed})),E.delta.refusal!=null&&((a=C.message)==null?void 0:a.role)==="assistant"&&((o=C.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:E.delta.refusal,snapshot:C.message.refusal}),((c=E.logprobs)==null?void 0:c.content)!=null&&((u=C.message)==null?void 0:u.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(l=E.logprobs)==null?void 0:l.content,snapshot:((d=C.logprobs)==null?void 0:d.content)??[]}),((h=E.logprobs)==null?void 0:h.refusal)!=null&&((f=C.message)==null?void 0:f.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(m=E.logprobs)==null?void 0:m.refusal,snapshot:((g=C.logprobs)==null?void 0:g.refusal)??[]});const k=P(this,At,"m",nu).call(this,C);C.finish_reason&&(P(this,At,"m",qf).call(this,C),k.current_tool_call_index!=null&&P(this,At,"m",Vf).call(this,C,k.current_tool_call_index));for(const R of E.delta.tool_calls??[])k.current_tool_call_index!==R.index&&(P(this,At,"m",qf).call(this,C),k.current_tool_call_index!=null&&P(this,At,"m",Vf).call(this,C,k.current_tool_call_index)),k.current_tool_call_index=R.index;for(const R of E.delta.tool_calls??[]){const $=(_=C.message.tool_calls)==null?void 0:_[R.index];$!=null&&$.type&&(($==null?void 0:$.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(b=$.function)==null?void 0:b.name,index:R.index,arguments:$.function.arguments,parsed_arguments:$.function.parsed_arguments,arguments_delta:((y=R.function)==null?void 0:y.arguments)??""}):($==null||$.type,void 0))}}},Vf=function(n,r){var a,o,c;if(P(this,At,"m",nu).call(this,n).done_tool_calls.has(r))return;const i=(a=n.message.tool_calls)==null?void 0:a[r];if(!i)throw new Error("no tool call snapshot");if(!i.type)throw new Error("tool call snapshot missing `type`");if(i.type==="function"){const u=(c=(o=P(this,Qr,"f"))==null?void 0:o.tools)==null?void 0:c.find(l=>Rl(l)&&l.function.name===i.function.name);this._emit("tool_calls.function.arguments.done",{name:i.function.name,index:r,arguments:i.function.arguments,parsed_arguments:Tc(u)?u.$parseRaw(i.function.arguments):u!=null&&u.function.strict?JSON.parse(i.function.arguments):null})}else i.type},qf=function(n){var s,i;const r=P(this,At,"m",nu).call(this,n);if(n.message.content&&!r.content_done){r.content_done=!0;const a=P(this,At,"m",Hf).call(this);this._emit("content.done",{content:n.message.content,parsed:a?a.$parseRaw(n.message.content):null})}n.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:n.message.refusal})),(s=n.logprobs)!=null&&s.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:n.logprobs.content})),(i=n.logprobs)!=null&&i.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:n.logprobs.refusal}))},ru=function(){if(this.ended)throw new we("stream has ended, this shouldn't happen");const n=P(this,Ts,"f");if(!n)throw new we("request ended without sending any chunks");return Ae(this,Ts,void 0),Ae(this,Vi,[]),cq(n,P(this,Qr,"f"))},Hf=function(){var r;const n=(r=P(this,Qr,"f"))==null?void 0:r.response_format;return my(n)?n:null},uv=function(n){var r,s,i,a;let o=P(this,Ts,"f");const{choices:c,...u}=n;o?Object.assign(o,u):o=Ae(this,Ts,{...u,choices:[]});for(const{delta:l,finish_reason:d,index:h,logprobs:f=null,...m}of n.choices){let g=o.choices[h];if(g||(g=o.choices[h]={finish_reason:d,index:h,message:{},logprobs:f,...m}),f)if(!g.logprobs)g.logprobs=Object.assign({},f);else{const{content:R,refusal:$,...T}=f;Object.assign(g.logprobs,T),R&&((r=g.logprobs).content??(r.content=[]),g.logprobs.content.push(...R)),$&&((s=g.logprobs).refusal??(s.refusal=[]),g.logprobs.refusal.push(...$))}if(d&&(g.finish_reason=d,P(this,Qr,"f")&&zC(P(this,Qr,"f")))){if(d==="length")throw new jC;if(d==="content_filter")throw new FC}if(Object.assign(g,m),!l)continue;const{content:_,refusal:b,function_call:y,role:E,tool_calls:C,...k}=l;if(Object.assign(g.message,k),b&&(g.message.refusal=(g.message.refusal||"")+b),E&&(g.message.role=E),y&&(g.message.function_call?(y.name&&(g.message.function_call.name=y.name),y.arguments&&((i=g.message.function_call).arguments??(i.arguments=""),g.message.function_call.arguments+=y.arguments)):g.message.function_call=y),_&&(g.message.content=(g.message.content||"")+_,!g.message.refusal&&P(this,At,"m",Hf).call(this)&&(g.message.parsed=cv(g.message.content))),C){g.message.tool_calls||(g.message.tool_calls=[]);for(const{index:R,id:$,type:T,function:B,...z}of C){const q=(a=g.message.tool_calls)[R]??(a[R]={});Object.assign(q,z),$&&(q.id=$),T&&(q.type=T),B&&(q.function??(q.function={name:B.name??"",arguments:""})),B!=null&&B.name&&(q.function.name=B.name),B!=null&&B.arguments&&(q.function.arguments+=B.arguments,pz(P(this,Qr,"f"),q)&&(q.function.parsed_arguments=cv(q.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("chunk",s=>{const i=n.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>n.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new jr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function cq(t,e){const{id:n,choices:r,created:s,model:i,system_fingerprint:a,...o}=t,c={...o,id:n,choices:r.map(({message:u,finish_reason:l,index:d,logprobs:h,...f})=>{if(!l)throw new we(`missing finish_reason for choice ${d}`);const{content:m=null,function_call:g,tool_calls:_,...b}=u,y=u.role;if(!y)throw new we(`missing role for choice ${d}`);if(g){const{arguments:E,name:C}=g;if(E==null)throw new we(`missing function_call.arguments for choice ${d}`);if(!C)throw new we(`missing function_call.name for choice ${d}`);return{...f,message:{content:m,function_call:{arguments:E,name:C},role:y,refusal:u.refusal??null},finish_reason:l,index:d,logprobs:h}}return _?{...f,index:d,finish_reason:l,logprobs:h,message:{...b,role:y,content:m,refusal:u.refusal??null,tool_calls:_.map((E,C)=>{const{function:k,type:R,id:$,...T}=E,{arguments:B,name:z,...q}=k||{};if($==null)throw new we(`missing choices[${d}].tool_calls[${C}].id
${su(t)}`);if(R==null)throw new we(`missing choices[${d}].tool_calls[${C}].type
${su(t)}`);if(z==null)throw new we(`missing choices[${d}].tool_calls[${C}].function.name
${su(t)}`);if(B==null)throw new we(`missing choices[${d}].tool_calls[${C}].function.arguments
${su(t)}`);return{...T,id:$,type:R,function:{...q,name:z,arguments:B}}})}}:{...f,message:{...b,content:m,role:y,refusal:u.refusal??null},finish_reason:l,index:d,logprobs:h}}),created:s,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return dz(c,e)}function su(t){return JSON.stringify(t)}class Ul extends ec{static fromReadableStream(e){const n=new Ul(null);return n._run(()=>n._fromReadableStream(e)),n}static runTools(e,n,r){const s=new Ul(n),i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,n,i)),s}}let Ey=class extends ge{constructor(){super(...arguments),this.messages=new hk(this._client)}create(e,n){return this._client.post("/chat/completions",{body:e,...n,stream:e.stream??!1})}retrieve(e,n){return this._client.get(V`/chat/completions/${e}`,n)}update(e,n,r){return this._client.post(V`/chat/completions/${e}`,{body:n,...r})}list(e={},n){return this._client.getAPIList("/chat/completions",xt,{query:e,...n})}delete(e,n){return this._client.delete(V`/chat/completions/${e}`,n)}parse(e,n){return mz(e.tools),this._client.chat.completions.create(e,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(r=>gy(r,e))}runTools(e,n){return e.stream?Ul.runTools(this._client,e,n):vy.runTools(this._client,e,n)}stream(e,n){return ec.createChatCompletion(this._client,e,n)}};Ey.Messages=hk;class Sy extends ge{constructor(){super(...arguments),this.completions=new Ey(this._client)}}Sy.Completions=Ey;const Ok=Symbol("brand.privateNullableHeaders");function*uq(t){if(!t)return;if(Ok in t){const{values:r,nulls:s}=t;yield*r.entries();for(const i of s)yield[i,null];return}let e=!1,n;t instanceof Headers?n=t.entries():W0(t)?n=t:(e=!0,n=Object.entries(t??{}));for(let r of n){const s=r[0];if(typeof s!="string")throw new TypeError("expected header name to be a string");const i=W0(r[1])?r[1]:[r[1]];let a=!1;for(const o of i)o!==void 0&&(e&&!a&&(a=!0,yield[s,null]),yield[s,o])}}const oe=t=>{const e=new Headers,n=new Set;for(const r of t){const s=new Set;for(const[i,a]of uq(r)){const o=i.toLowerCase();s.has(o)||(e.delete(i),s.add(o)),a===null?(e.delete(i),n.add(o)):(e.append(i,a),n.delete(o))}}return{[Ok]:!0,values:e,nulls:n}};class $k extends ge{create(e,n){return this._client.post("/audio/speech",{body:e,...n,headers:oe([{Accept:"application/octet-stream"},n==null?void 0:n.headers]),__binaryResponse:!0})}}class Nk extends ge{create(e,n){return this._client.post("/audio/transcriptions",ki({body:e,...n,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class Pk extends ge{create(e,n){return this._client.post("/audio/translations",ki({body:e,...n,__metadata:{model:e.model}},this._client))}}class Cc extends ge{constructor(){super(...arguments),this.transcriptions=new Nk(this._client),this.translations=new Pk(this._client),this.speech=new $k(this._client)}}Cc.Transcriptions=Nk;Cc.Translations=Pk;Cc.Speech=$k;class Lk extends ge{create(e,n){return this._client.post("/batches",{body:e,...n})}retrieve(e,n){return this._client.get(V`/batches/${e}`,n)}list(e={},n){return this._client.getAPIList("/batches",xt,{query:e,...n})}cancel(e,n){return this._client.post(V`/batches/${e}/cancel`,n)}}class Mk extends ge{create(e,n){return this._client.post("/assistants",{body:e,...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,n){return this._client.get(V`/assistants/${e}`,{...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,n,r){return this._client.post(V`/assistants/${e}`,{body:n,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e={},n){return this._client.getAPIList("/assistants",xt,{query:e,...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,n){return this._client.delete(V`/assistants/${e}`,{...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}let Dk=class extends ge{create(e,n){return this._client.post("/realtime/sessions",{body:e,...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}};class Uk extends ge{create(e,n){return this._client.post("/realtime/transcription_sessions",{body:e,...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}let Ad=class extends ge{constructor(){super(...arguments),this.sessions=new Dk(this._client),this.transcriptionSessions=new Uk(this._client)}};Ad.Sessions=Dk;Ad.TranscriptionSessions=Uk;class Bk extends ge{create(e,n){return this._client.post("/chatkit/sessions",{body:e,...n,headers:oe([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}cancel(e,n){return this._client.post(V`/chatkit/sessions/${e}/cancel`,{...n,headers:oe([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}}let jk=class extends ge{retrieve(e,n){return this._client.get(V`/chatkit/threads/${e}`,{...n,headers:oe([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}list(e={},n){return this._client.getAPIList("/chatkit/threads",Nl,{query:e,...n,headers:oe([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}delete(e,n){return this._client.delete(V`/chatkit/threads/${e}`,{...n,headers:oe([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}listItems(e,n={},r){return this._client.getAPIList(V`/chatkit/threads/${e}/items`,Nl,{query:n,...r,headers:oe([{"OpenAI-Beta":"chatkit_beta=v1"},r==null?void 0:r.headers])})}};class Cd extends ge{constructor(){super(...arguments),this.sessions=new Bk(this._client),this.threads=new jk(this._client)}}Cd.Sessions=Bk;Cd.Threads=jk;class Fk extends ge{create(e,n,r){return this._client.post(V`/threads/${e}/messages`,{body:n,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,n,r){const{thread_id:s}=n;return this._client.get(V`/threads/${s}/messages/${e}`,{...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,n,r){const{thread_id:s,...i}=n;return this._client.post(V`/threads/${s}/messages/${e}`,{body:i,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,n={},r){return this._client.getAPIList(V`/threads/${e}/messages`,xt,{query:n,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,n,r){const{thread_id:s}=n;return this._client.delete(V`/threads/${s}/messages/${e}`,{...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}class zk extends ge{retrieve(e,n,r){const{thread_id:s,run_id:i,...a}=n;return this._client.get(V`/threads/${s}/runs/${i}/steps/${e}`,{query:a,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,n,r){const{thread_id:s,...i}=n;return this._client.getAPIList(V`/threads/${s}/runs/${e}/steps`,xt,{query:i,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}const lq=t=>{if(typeof Kt<"u"){const e=Kt.from(t,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(t),n=e.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=e.charCodeAt(s);return Array.from(new Float32Array(r.buffer))}};var Gf={};const qi=t=>{var e,n,r,s;if(typeof globalThis.process<"u")return((e=Gf==null?void 0:Gf[t])==null?void 0:e.trim())??void 0;if(typeof globalThis.Deno<"u")return(s=(r=(n=globalThis.Deno.env)==null?void 0:n.get)==null?void 0:r.call(n,t))==null?void 0:s.trim()};var Gt,li,Im,Pr,Du,mr,di,ua,ai,Bl,Dn,Uu,Bu,So,co,uo,lv,dv,hv,fv,pv,mv,gv;class xo extends by{constructor(){super(...arguments),Gt.add(this),Im.set(this,[]),Pr.set(this,{}),Du.set(this,{}),mr.set(this,void 0),di.set(this,void 0),ua.set(this,void 0),ai.set(this,void 0),Bl.set(this,void 0),Dn.set(this,void 0),Uu.set(this,void 0),Bu.set(this,void 0),So.set(this,void 0)}[(Im=new WeakMap,Pr=new WeakMap,Du=new WeakMap,mr=new WeakMap,di=new WeakMap,ua=new WeakMap,ai=new WeakMap,Bl=new WeakMap,Dn=new WeakMap,Uu=new WeakMap,Bu=new WeakMap,So=new WeakMap,Gt=new WeakSet,Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("event",s=>{const i=n.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>n.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const n=new li;return n._run(()=>n._fromReadableStream(e)),n}async _fromReadableStream(e,n){var i;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=jr.fromReadableStream(e,this.controller);for await(const a of s)P(this,Gt,"m",co).call(this,a);if((i=s.controller.signal)!=null&&i.aborted)throw new Fn;return this._addRun(P(this,Gt,"m",uo).call(this))}toReadableStream(){return new jr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,n,r,s){const i=new li;return i._run(()=>i._runToolAssistantStream(e,n,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,n,r,s){var c;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...r,stream:!0},o=await e.submitToolOutputs(n,a,{...s,signal:this.controller.signal});this._connected();for await(const u of o)P(this,Gt,"m",co).call(this,u);if((c=o.controller.signal)!=null&&c.aborted)throw new Fn;return this._addRun(P(this,Gt,"m",uo).call(this))}static createThreadAssistantStream(e,n,r){const s=new li;return s._run(()=>s._threadAssistantStream(e,n,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,n,r,s){const i=new li;return i._run(()=>i._runAssistantStream(e,n,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return P(this,Uu,"f")}currentRun(){return P(this,Bu,"f")}currentMessageSnapshot(){return P(this,mr,"f")}currentRunStepSnapshot(){return P(this,So,"f")}async finalRunSteps(){return await this.done(),Object.values(P(this,Pr,"f"))}async finalMessages(){return await this.done(),Object.values(P(this,Du,"f"))}async finalRun(){if(await this.done(),!P(this,di,"f"))throw Error("Final run was not received.");return P(this,di,"f")}async _createThreadAssistantStream(e,n,r){var o;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const i={...n,stream:!0},a=await e.createAndRun(i,{...r,signal:this.controller.signal});this._connected();for await(const c of a)P(this,Gt,"m",co).call(this,c);if((o=a.controller.signal)!=null&&o.aborted)throw new Fn;return this._addRun(P(this,Gt,"m",uo).call(this))}async _createAssistantStream(e,n,r,s){var c;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...r,stream:!0},o=await e.create(n,a,{...s,signal:this.controller.signal});this._connected();for await(const u of o)P(this,Gt,"m",co).call(this,u);if((c=o.controller.signal)!=null&&c.aborted)throw new Fn;return this._addRun(P(this,Gt,"m",uo).call(this))}static accumulateDelta(e,n){for(const[r,s]of Object.entries(n)){if(!e.hasOwnProperty(r)){e[r]=s;continue}let i=e[r];if(i==null){e[r]=s;continue}if(r==="index"||r==="type"){e[r]=s;continue}if(typeof i=="string"&&typeof s=="string")i+=s;else if(typeof i=="number"&&typeof s=="number")i+=s;else if(Uf(i)&&Uf(s))i=this.accumulateDelta(i,s);else if(Array.isArray(i)&&Array.isArray(s)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...s);continue}for(const a of s){if(!Uf(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);const o=a.index;if(o==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const c=i[o];c==null?i.push(a):i[o]=this.accumulateDelta(c,a)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${s}, accValue: ${i}`);e[r]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,n,r){return await this._createThreadAssistantStream(n,e,r)}async _runAssistantStream(e,n,r,s){return await this._createAssistantStream(n,e,r,s)}async _runToolAssistantStream(e,n,r,s){return await this._createToolAssistantStream(n,e,r,s)}}li=xo,co=function(e){if(!this.ended)switch(Ae(this,Uu,e),P(this,Gt,"m",hv).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":P(this,Gt,"m",gv).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":P(this,Gt,"m",dv).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":P(this,Gt,"m",lv).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},uo=function(){if(this.ended)throw new we("stream has ended, this shouldn't happen");if(!P(this,di,"f"))throw Error("Final run has not been received");return P(this,di,"f")},lv=function(e){const[n,r]=P(this,Gt,"m",pv).call(this,e,P(this,mr,"f"));Ae(this,mr,n),P(this,Du,"f")[n.id]=n;for(const s of r){const i=n.content[s.index];(i==null?void 0:i.type)=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,n),e.data.delta.content)for(const s of e.data.delta.content){if(s.type=="text"&&s.text){let i=s.text,a=n.content[s.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=P(this,ua,"f")){if(P(this,ai,"f"))switch(P(this,ai,"f").type){case"text":this._emit("textDone",P(this,ai,"f").text,P(this,mr,"f"));break;case"image_file":this._emit("imageFileDone",P(this,ai,"f").image_file,P(this,mr,"f"));break}Ae(this,ua,s.index)}Ae(this,ai,n.content[s.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(P(this,ua,"f")!==void 0){const s=e.data.content[P(this,ua,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,P(this,mr,"f"));break;case"text":this._emit("textDone",s.text,P(this,mr,"f"));break}}P(this,mr,"f")&&this._emit("messageDone",e.data),Ae(this,mr,void 0)}},dv=function(e){const n=P(this,Gt,"m",fv).call(this,e);switch(Ae(this,So,n),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&n.step_details.type=="tool_calls")for(const i of r.step_details.tool_calls)i.index==P(this,Bl,"f")?this._emit("toolCallDelta",i,n.step_details.tool_calls[i.index]):(P(this,Dn,"f")&&this._emit("toolCallDone",P(this,Dn,"f")),Ae(this,Bl,i.index),Ae(this,Dn,n.step_details.tool_calls[i.index]),P(this,Dn,"f")&&this._emit("toolCallCreated",P(this,Dn,"f")));this._emit("runStepDelta",e.data.delta,n);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Ae(this,So,void 0),e.data.step_details.type=="tool_calls"&&P(this,Dn,"f")&&(this._emit("toolCallDone",P(this,Dn,"f")),Ae(this,Dn,void 0)),this._emit("runStepDone",e.data,n);break}},hv=function(e){P(this,Im,"f").push(e),this._emit("event",e)},fv=function(e){switch(e.event){case"thread.run.step.created":return P(this,Pr,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let n=P(this,Pr,"f")[e.data.id];if(!n)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){const s=li.accumulateDelta(n,r.delta);P(this,Pr,"f")[e.data.id]=s}return P(this,Pr,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":P(this,Pr,"f")[e.data.id]=e.data;break}if(P(this,Pr,"f")[e.data.id])return P(this,Pr,"f")[e.data.id];throw new Error("No snapshot available")},pv=function(e,n){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!n)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const i of s.delta.content)if(i.index in n.content){let a=n.content[i.index];n.content[i.index]=P(this,Gt,"m",mv).call(this,i,a)}else n.content[i.index]=i,r.push(i);return[n,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(n)return[n,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},mv=function(e,n){return li.accumulateDelta(n,e)},gv=function(e){switch(Ae(this,Bu,e.data),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":Ae(this,di,e.data),P(this,Dn,"f")&&(this._emit("toolCallDone",P(this,Dn,"f")),Ae(this,Dn,void 0));break}};let xy=class extends ge{constructor(){super(...arguments),this.steps=new zk(this._client)}create(e,n,r){const{include:s,...i}=n;return this._client.post(V`/threads/${e}/runs`,{query:{include:s},body:i,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers]),stream:n.stream??!1})}retrieve(e,n,r){const{thread_id:s}=n;return this._client.get(V`/threads/${s}/runs/${e}`,{...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,n,r){const{thread_id:s,...i}=n;return this._client.post(V`/threads/${s}/runs/${e}`,{body:i,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,n={},r){return this._client.getAPIList(V`/threads/${e}/runs`,xt,{query:n,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}cancel(e,n,r){const{thread_id:s}=n;return this._client.post(V`/threads/${s}/runs/${e}/cancel`,{...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async createAndPoll(e,n,r){const s=await this.create(e,n,r);return await this.poll(s.id,{thread_id:e},r)}createAndStream(e,n,r){return xo.createAssistantStream(e,this._client.beta.threads.runs,n,r)}async poll(e,n,r){var i;const s=oe([r==null?void 0:r.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=r==null?void 0:r.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const{data:a,response:o}=await this.retrieve(e,n,{...r,headers:{...r==null?void 0:r.headers,...s}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let c=5e3;if(r!=null&&r.pollIntervalMs)c=r.pollIntervalMs;else{const u=o.headers.get("openai-poll-after-ms");if(u){const l=parseInt(u);isNaN(l)||(c=l)}}await Ac(c);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,n,r){return xo.createAssistantStream(e,this._client.beta.threads.runs,n,r)}submitToolOutputs(e,n,r){const{thread_id:s,...i}=n;return this._client.post(V`/threads/${s}/runs/${e}/submit_tool_outputs`,{body:i,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers]),stream:n.stream??!1})}async submitToolOutputsAndPoll(e,n,r){const s=await this.submitToolOutputs(e,n,r);return await this.poll(s.id,n,r)}submitToolOutputsStream(e,n,r){return xo.createToolAssistantStream(e,this._client.beta.threads.runs,n,r)}};xy.Steps=zk;class kd extends ge{constructor(){super(...arguments),this.runs=new xy(this._client),this.messages=new Fk(this._client)}create(e={},n){return this._client.post("/threads",{body:e,...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,n){return this._client.get(V`/threads/${e}`,{...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,n,r){return this._client.post(V`/threads/${e}`,{body:n,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,n){return this._client.delete(V`/threads/${e}`,{...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}createAndRun(e,n){return this._client.post("/threads/runs",{body:e,...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers]),stream:e.stream??!1})}async createAndRunPoll(e,n){const r=await this.createAndRun(e,n);return await this.runs.poll(r.id,{thread_id:r.thread_id},n)}createAndRunStream(e,n){return xo.createThreadAssistantStream(e,this._client.beta.threads,n)}}kd.Runs=xy;kd.Messages=Fk;class Ua extends ge{constructor(){super(...arguments),this.realtime=new Ad(this._client),this.chatkit=new Cd(this._client),this.assistants=new Mk(this._client),this.threads=new kd(this._client)}}Ua.Realtime=Ad;Ua.ChatKit=Cd;Ua.Assistants=Mk;Ua.Threads=kd;class Vk extends ge{create(e,n){return this._client.post("/completions",{body:e,...n,stream:e.stream??!1})}}class qk extends ge{retrieve(e,n,r){const{container_id:s}=n;return this._client.get(V`/containers/${s}/files/${e}/content`,{...r,headers:oe([{Accept:"application/binary"},r==null?void 0:r.headers]),__binaryResponse:!0})}}let Ty=class extends ge{constructor(){super(...arguments),this.content=new qk(this._client)}create(e,n,r){return this._client.post(V`/containers/${e}/files`,ki({body:n,...r},this._client))}retrieve(e,n,r){const{container_id:s}=n;return this._client.get(V`/containers/${s}/files/${e}`,r)}list(e,n={},r){return this._client.getAPIList(V`/containers/${e}/files`,xt,{query:n,...r})}delete(e,n,r){const{container_id:s}=n;return this._client.delete(V`/containers/${s}/files/${e}`,{...r,headers:oe([{Accept:"*/*"},r==null?void 0:r.headers])})}};Ty.Content=qk;class Ay extends ge{constructor(){super(...arguments),this.files=new Ty(this._client)}create(e,n){return this._client.post("/containers",{body:e,...n})}retrieve(e,n){return this._client.get(V`/containers/${e}`,n)}list(e={},n){return this._client.getAPIList("/containers",xt,{query:e,...n})}delete(e,n){return this._client.delete(V`/containers/${e}`,{...n,headers:oe([{Accept:"*/*"},n==null?void 0:n.headers])})}}Ay.Files=Ty;class Hk extends ge{create(e,n,r){const{include:s,...i}=n;return this._client.post(V`/conversations/${e}/items`,{query:{include:s},body:i,...r})}retrieve(e,n,r){const{conversation_id:s,...i}=n;return this._client.get(V`/conversations/${s}/items/${e}`,{query:i,...r})}list(e,n={},r){return this._client.getAPIList(V`/conversations/${e}/items`,Nl,{query:n,...r})}delete(e,n,r){const{conversation_id:s}=n;return this._client.delete(V`/conversations/${s}/items/${e}`,r)}}class Cy extends ge{constructor(){super(...arguments),this.items=new Hk(this._client)}create(e={},n){return this._client.post("/conversations",{body:e,...n})}retrieve(e,n){return this._client.get(V`/conversations/${e}`,n)}update(e,n,r){return this._client.post(V`/conversations/${e}`,{body:n,...r})}delete(e,n){return this._client.delete(V`/conversations/${e}`,n)}}Cy.Items=Hk;class Gk extends ge{create(e,n){const r=!!e.encoding_format;let s=r?e.encoding_format:"base64";r&&Ht(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const i=this._client.post("/embeddings",{body:{...e,encoding_format:s},...n});return r?i:(Ht(this._client).debug("embeddings/decoding base64 embeddings from base64"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(o=>{const c=o.embedding;o.embedding=lq(c)}),a)))}}class Wk extends ge{retrieve(e,n,r){const{eval_id:s,run_id:i}=n;return this._client.get(V`/evals/${s}/runs/${i}/output_items/${e}`,r)}list(e,n,r){const{eval_id:s,...i}=n;return this._client.getAPIList(V`/evals/${s}/runs/${e}/output_items`,xt,{query:i,...r})}}class ky extends ge{constructor(){super(...arguments),this.outputItems=new Wk(this._client)}create(e,n,r){return this._client.post(V`/evals/${e}/runs`,{body:n,...r})}retrieve(e,n,r){const{eval_id:s}=n;return this._client.get(V`/evals/${s}/runs/${e}`,r)}list(e,n={},r){return this._client.getAPIList(V`/evals/${e}/runs`,xt,{query:n,...r})}delete(e,n,r){const{eval_id:s}=n;return this._client.delete(V`/evals/${s}/runs/${e}`,r)}cancel(e,n,r){const{eval_id:s}=n;return this._client.post(V`/evals/${s}/runs/${e}`,r)}}ky.OutputItems=Wk;class Iy extends ge{constructor(){super(...arguments),this.runs=new ky(this._client)}create(e,n){return this._client.post("/evals",{body:e,...n})}retrieve(e,n){return this._client.get(V`/evals/${e}`,n)}update(e,n,r){return this._client.post(V`/evals/${e}`,{body:n,...r})}list(e={},n){return this._client.getAPIList("/evals",xt,{query:e,...n})}delete(e,n){return this._client.delete(V`/evals/${e}`,n)}}Iy.Runs=ky;let Jk=class extends ge{create(e,n){return this._client.post("/files",ki({body:e,...n},this._client))}retrieve(e,n){return this._client.get(V`/files/${e}`,n)}list(e={},n){return this._client.getAPIList("/files",xt,{query:e,...n})}delete(e,n){return this._client.delete(V`/files/${e}`,n)}content(e,n){return this._client.get(V`/files/${e}/content`,{...n,headers:oe([{Accept:"application/binary"},n==null?void 0:n.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:n=5e3,maxWait:r=1800*1e3}={}){const s=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await Ac(n),a=await this.retrieve(e),Date.now()-i>r)throw new Ed({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return a}};class Zk extends ge{}let Kk=class extends ge{run(e,n){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...n})}validate(e,n){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...n})}};class Ry extends ge{constructor(){super(...arguments),this.graders=new Kk(this._client)}}Ry.Graders=Kk;class Xk extends ge{create(e,n,r){return this._client.getAPIList(V`/fine_tuning/checkpoints/${e}/permissions`,Td,{body:n,method:"post",...r})}retrieve(e,n={},r){return this._client.get(V`/fine_tuning/checkpoints/${e}/permissions`,{query:n,...r})}delete(e,n,r){const{fine_tuned_model_checkpoint:s}=n;return this._client.delete(V`/fine_tuning/checkpoints/${s}/permissions/${e}`,r)}}let Oy=class extends ge{constructor(){super(...arguments),this.permissions=new Xk(this._client)}};Oy.Permissions=Xk;class Yk extends ge{list(e,n={},r){return this._client.getAPIList(V`/fine_tuning/jobs/${e}/checkpoints`,xt,{query:n,...r})}}class $y extends ge{constructor(){super(...arguments),this.checkpoints=new Yk(this._client)}create(e,n){return this._client.post("/fine_tuning/jobs",{body:e,...n})}retrieve(e,n){return this._client.get(V`/fine_tuning/jobs/${e}`,n)}list(e={},n){return this._client.getAPIList("/fine_tuning/jobs",xt,{query:e,...n})}cancel(e,n){return this._client.post(V`/fine_tuning/jobs/${e}/cancel`,n)}listEvents(e,n={},r){return this._client.getAPIList(V`/fine_tuning/jobs/${e}/events`,xt,{query:n,...r})}pause(e,n){return this._client.post(V`/fine_tuning/jobs/${e}/pause`,n)}resume(e,n){return this._client.post(V`/fine_tuning/jobs/${e}/resume`,n)}}$y.Checkpoints=Yk;class Ba extends ge{constructor(){super(...arguments),this.methods=new Zk(this._client),this.jobs=new $y(this._client),this.checkpoints=new Oy(this._client),this.alpha=new Ry(this._client)}}Ba.Methods=Zk;Ba.Jobs=$y;Ba.Checkpoints=Oy;Ba.Alpha=Ry;class Qk extends ge{}class Ny extends ge{constructor(){super(...arguments),this.graderModels=new Qk(this._client)}}Ny.GraderModels=Qk;class eI extends ge{createVariation(e,n){return this._client.post("/images/variations",ki({body:e,...n},this._client))}edit(e,n){return this._client.post("/images/edits",ki({body:e,...n,stream:e.stream??!1},this._client))}generate(e,n){return this._client.post("/images/generations",{body:e,...n,stream:e.stream??!1})}}class tI extends ge{retrieve(e,n){return this._client.get(V`/models/${e}`,n)}list(e){return this._client.getAPIList("/models",Td,e)}delete(e,n){return this._client.delete(V`/models/${e}`,n)}}class nI extends ge{create(e,n){return this._client.post("/moderations",{body:e,...n})}}class rI extends ge{accept(e,n,r){return this._client.post(V`/realtime/calls/${e}/accept`,{body:n,...r,headers:oe([{Accept:"*/*"},r==null?void 0:r.headers])})}hangup(e,n){return this._client.post(V`/realtime/calls/${e}/hangup`,{...n,headers:oe([{Accept:"*/*"},n==null?void 0:n.headers])})}refer(e,n,r){return this._client.post(V`/realtime/calls/${e}/refer`,{body:n,...r,headers:oe([{Accept:"*/*"},r==null?void 0:r.headers])})}reject(e,n={},r){return this._client.post(V`/realtime/calls/${e}/reject`,{body:n,...r,headers:oe([{Accept:"*/*"},r==null?void 0:r.headers])})}}class sI extends ge{create(e,n){return this._client.post("/realtime/client_secrets",{body:e,...n})}}class Id extends ge{constructor(){super(...arguments),this.clientSecrets=new sI(this._client),this.calls=new rI(this._client)}}Id.ClientSecrets=sI;Id.Calls=rI;var Hi,iu,As,au,yv,_v,wv,bv;class Py extends by{constructor(e){super(),Hi.add(this),iu.set(this,void 0),As.set(this,void 0),au.set(this,void 0),Ae(this,iu,e)}static createResponse(e,n,r){const s=new Py(n);return s._run(()=>s._createOrRetrieveResponse(e,n,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,n,r){var o;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),P(this,Hi,"m",yv).call(this);let i,a=null;"response_id"in n?(i=await e.responses.retrieve(n.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),a=n.starting_after??null):i=await e.responses.create({...n,stream:!0},{...r,signal:this.controller.signal}),this._connected();for await(const c of i)P(this,Hi,"m",_v).call(this,c,a);if((o=i.controller.signal)!=null&&o.aborted)throw new Fn;return P(this,Hi,"m",wv).call(this)}[(iu=new WeakMap,As=new WeakMap,au=new WeakMap,Hi=new WeakSet,yv=function(){this.ended||Ae(this,As,void 0)},_v=function(n,r){if(this.ended)return;const s=(a,o)=>{(r==null||o.sequence_number>r)&&this._emit(a,o)},i=P(this,Hi,"m",bv).call(this,n);switch(s("event",n),n.type){case"response.output_text.delta":{const a=i.output[n.output_index];if(!a)throw new we(`missing output at index ${n.output_index}`);if(a.type==="message"){const o=a.content[n.content_index];if(!o)throw new we(`missing content at index ${n.content_index}`);if(o.type!=="output_text")throw new we(`expected content to be 'output_text', got ${o.type}`);s("response.output_text.delta",{...n,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const a=i.output[n.output_index];if(!a)throw new we(`missing output at index ${n.output_index}`);a.type==="function_call"&&s("response.function_call_arguments.delta",{...n,snapshot:a.arguments});break}default:s(n.type,n);break}},wv=function(){if(this.ended)throw new we("stream has ended, this shouldn't happen");const n=P(this,As,"f");if(!n)throw new we("request ended without sending any events");Ae(this,As,void 0);const r=dq(n,P(this,iu,"f"));return Ae(this,au,r),r},bv=function(n){var s;let r=P(this,As,"f");if(!r){if(n.type!=="response.created")throw new we(`When snapshot hasn't been set yet, expected 'response.created' event, got ${n.type}`);return r=Ae(this,As,n.response),r}switch(n.type){case"response.output_item.added":{r.output.push(n.item);break}case"response.content_part.added":{const i=r.output[n.output_index];if(!i)throw new we(`missing output at index ${n.output_index}`);const a=i.type,o=n.part;a==="message"&&o.type!=="reasoning_text"?i.content.push(o):a==="reasoning"&&o.type==="reasoning_text"&&(i.content||(i.content=[]),i.content.push(o));break}case"response.output_text.delta":{const i=r.output[n.output_index];if(!i)throw new we(`missing output at index ${n.output_index}`);if(i.type==="message"){const a=i.content[n.content_index];if(!a)throw new we(`missing content at index ${n.content_index}`);if(a.type!=="output_text")throw new we(`expected content to be 'output_text', got ${a.type}`);a.text+=n.delta}break}case"response.function_call_arguments.delta":{const i=r.output[n.output_index];if(!i)throw new we(`missing output at index ${n.output_index}`);i.type==="function_call"&&(i.arguments+=n.delta);break}case"response.reasoning_text.delta":{const i=r.output[n.output_index];if(!i)throw new we(`missing output at index ${n.output_index}`);if(i.type==="reasoning"){const a=(s=i.content)==null?void 0:s[n.content_index];if(!a)throw new we(`missing content at index ${n.content_index}`);if(a.type!=="reasoning_text")throw new we(`expected content to be 'reasoning_text', got ${a.type}`);a.text+=n.delta}break}case"response.completed":{Ae(this,As,n.response);break}}return r},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("event",s=>{const i=n.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>n.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=P(this,au,"f");if(!e)throw new we("stream ended without producing a ChatCompletion");return e}}function dq(t,e){return nV(t,e)}class iI extends ge{list(e,n={},r){return this._client.getAPIList(V`/responses/${e}/input_items`,xt,{query:n,...r})}}class aI extends ge{count(e={},n){return this._client.post("/responses/input_tokens",{body:e,...n})}}class Rd extends ge{constructor(){super(...arguments),this.inputItems=new iI(this._client),this.inputTokens=new aI(this._client)}create(e,n){return this._client.post("/responses",{body:e,...n,stream:e.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&_m(r),r))}retrieve(e,n={},r){return this._client.get(V`/responses/${e}`,{query:n,...r,stream:(n==null?void 0:n.stream)??!1})._thenUnwrap(s=>("object"in s&&s.object==="response"&&_m(s),s))}delete(e,n){return this._client.delete(V`/responses/${e}`,{...n,headers:oe([{Accept:"*/*"},n==null?void 0:n.headers])})}parse(e,n){return this._client.responses.create(e,n)._thenUnwrap(r=>JC(r,e))}stream(e,n){return Py.createResponse(this._client,e,n)}cancel(e,n){return this._client.post(V`/responses/${e}/cancel`,n)}}Rd.InputItems=iI;Rd.InputTokens=aI;class oI extends ge{create(e,n,r){return this._client.post(V`/uploads/${e}/parts`,ki({body:n,...r},this._client))}}class Ly extends ge{constructor(){super(...arguments),this.parts=new oI(this._client)}create(e,n){return this._client.post("/uploads",{body:e,...n})}cancel(e,n){return this._client.post(V`/uploads/${e}/cancel`,n)}complete(e,n,r){return this._client.post(V`/uploads/${e}/complete`,{body:n,...r})}}Ly.Parts=oI;const hq=async t=>{const e=await Promise.allSettled(t),n=e.filter(s=>s.status==="rejected");if(n.length){for(const s of n)console.error(s.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const s of e)s.status==="fulfilled"&&r.push(s.value);return r};class cI extends ge{create(e,n,r){return this._client.post(V`/vector_stores/${e}/file_batches`,{body:n,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,n,r){const{vector_store_id:s}=n;return this._client.get(V`/vector_stores/${s}/file_batches/${e}`,{...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}cancel(e,n,r){const{vector_store_id:s}=n;return this._client.post(V`/vector_stores/${s}/file_batches/${e}/cancel`,{...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async createAndPoll(e,n,r){const s=await this.create(e,n);return await this.poll(e,s.id,r)}listFiles(e,n,r){const{vector_store_id:s,...i}=n;return this._client.getAPIList(V`/vector_stores/${s}/file_batches/${e}/files`,xt,{query:i,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async poll(e,n,r){var i;const s=oe([r==null?void 0:r.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=r==null?void 0:r.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const{data:a,response:o}=await this.retrieve(n,{vector_store_id:e},{...r,headers:s}).withResponse();switch(a.status){case"in_progress":let c=5e3;if(r!=null&&r.pollIntervalMs)c=r.pollIntervalMs;else{const u=o.headers.get("openai-poll-after-ms");if(u){const l=parseInt(u);isNaN(l)||(c=l)}}await Ac(c);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:n,fileIds:r=[]},s){if(n==null||n.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const i=(s==null?void 0:s.maxConcurrency)??5,a=Math.min(i,n.length),o=this._client,c=n.values(),u=[...r];async function l(h){for(let f of h){const m=await o.files.create({file:f,purpose:"assistants"},s);u.push(m.id)}}const d=Array(a).fill(c).map(l);return await hq(d),await this.createAndPoll(e,{file_ids:u})}}class uI extends ge{create(e,n,r){return this._client.post(V`/vector_stores/${e}/files`,{body:n,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,n,r){const{vector_store_id:s}=n;return this._client.get(V`/vector_stores/${s}/files/${e}`,{...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,n,r){const{vector_store_id:s,...i}=n;return this._client.post(V`/vector_stores/${s}/files/${e}`,{body:i,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,n={},r){return this._client.getAPIList(V`/vector_stores/${e}/files`,xt,{query:n,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,n,r){const{vector_store_id:s}=n;return this._client.delete(V`/vector_stores/${s}/files/${e}`,{...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async createAndPoll(e,n,r){const s=await this.create(e,n,r);return await this.poll(e,s.id,r)}async poll(e,n,r){var i;const s=oe([r==null?void 0:r.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=r==null?void 0:r.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const a=await this.retrieve(n,{vector_store_id:e},{...r,headers:s}).withResponse(),o=a.data;switch(o.status){case"in_progress":let c=5e3;if(r!=null&&r.pollIntervalMs)c=r.pollIntervalMs;else{const u=a.response.headers.get("openai-poll-after-ms");if(u){const l=parseInt(u);isNaN(l)||(c=l)}}await Ac(c);break;case"failed":case"completed":return o}}}async upload(e,n,r){const s=await this._client.files.create({file:n,purpose:"assistants"},r);return this.create(e,{file_id:s.id},r)}async uploadAndPoll(e,n,r){const s=await this.upload(e,n,r);return await this.poll(e,s.id,r)}content(e,n,r){const{vector_store_id:s}=n;return this._client.getAPIList(V`/vector_stores/${s}/files/${e}/content`,Td,{...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}class Od extends ge{constructor(){super(...arguments),this.files=new uI(this._client),this.fileBatches=new cI(this._client)}create(e,n){return this._client.post("/vector_stores",{body:e,...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,n){return this._client.get(V`/vector_stores/${e}`,{...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,n,r){return this._client.post(V`/vector_stores/${e}`,{body:n,...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e={},n){return this._client.getAPIList("/vector_stores",xt,{query:e,...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,n){return this._client.delete(V`/vector_stores/${e}`,{...n,headers:oe([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}search(e,n,r){return this._client.getAPIList(V`/vector_stores/${e}/search`,Td,{body:n,method:"post",...r,headers:oe([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}Od.Files=uI;Od.FileBatches=cI;class lI extends ge{create(e,n){return this._client.post("/videos",iv({body:e,...n},this._client))}retrieve(e,n){return this._client.get(V`/videos/${e}`,n)}list(e={},n){return this._client.getAPIList("/videos",Nl,{query:e,...n})}delete(e,n){return this._client.delete(V`/videos/${e}`,n)}downloadContent(e,n={},r){return this._client.get(V`/videos/${e}/content`,{query:n,...r,headers:oe([{Accept:"application/binary"},r==null?void 0:r.headers]),__binaryResponse:!0})}remix(e,n,r){return this._client.post(V`/videos/${e}/remix`,iv({body:n,...r},this._client))}}var Qi,dI,ju;class hI extends ge{constructor(){super(...arguments),Qi.add(this)}async unwrap(e,n,r=this._client.webhookSecret,s=300){return await this.verifySignature(e,n,r,s),JSON.parse(e)}async verifySignature(e,n,r=this._client.webhookSecret,s=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");P(this,Qi,"m",dI).call(this,r);const i=oe([n]).values,a=P(this,Qi,"m",ju).call(this,i,"webhook-signature"),o=P(this,Qi,"m",ju).call(this,i,"webhook-timestamp"),c=P(this,Qi,"m",ju).call(this,i,"webhook-id"),u=parseInt(o,10);if(isNaN(u))throw new to("Invalid webhook timestamp format");const l=Math.floor(Date.now()/1e3);if(l-u>s)throw new to("Webhook timestamp is too old");if(u>l+s)throw new to("Webhook timestamp is too new");const d=a.split(" ").map(g=>g.startsWith("v1,")?g.substring(3):g),h=r.startsWith("whsec_")?Kt.from(r.replace("whsec_",""),"base64"):Kt.from(r,"utf-8"),f=c?`${c}.${o}.${e}`:`${o}.${e}`,m=await crypto.subtle.importKey("raw",h,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const g of d)try{const _=Kt.from(g,"base64");if(await crypto.subtle.verify("HMAC",m,_,new TextEncoder().encode(f)))return}catch{continue}throw new to("The given webhook signature does not match the expected signature")}}Qi=new WeakSet,dI=function(e){if(typeof e!="string"||e.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},ju=function(e,n){if(!e)throw new Error("Headers are required");const r=e.get(n);if(r==null)throw new Error(`Missing required header: ${n}`);return r};var Rm,My,Fu,fI;class Me{constructor({baseURL:e=qi("OPENAI_BASE_URL"),apiKey:n=qi("OPENAI_API_KEY"),organization:r=qi("OPENAI_ORG_ID")??null,project:s=qi("OPENAI_PROJECT_ID")??null,webhookSecret:i=qi("OPENAI_WEBHOOK_SECRET")??null,...a}={}){if(Rm.add(this),Fu.set(this,void 0),this.completions=new Vk(this),this.chat=new Sy(this),this.embeddings=new Gk(this),this.files=new Jk(this),this.images=new eI(this),this.audio=new Cc(this),this.moderations=new nI(this),this.models=new tI(this),this.fineTuning=new Ba(this),this.graders=new Ny(this),this.vectorStores=new Od(this),this.webhooks=new hI(this),this.beta=new Ua(this),this.batches=new Lk(this),this.uploads=new Ly(this),this.responses=new Rd(this),this.realtime=new Id(this),this.conversations=new Cy(this),this.evals=new Iy(this),this.containers=new Ay(this),this.videos=new lI(this),n===void 0)throw new we("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const o={apiKey:n,organization:r,project:s,webhookSecret:i,...a,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&TV())throw new we(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=o.baseURL,this.timeout=o.timeout??My.DEFAULT_TIMEOUT,this.logger=o.logger??console;const c="warn";this.logLevel=c,this.logLevel=rv(o.logLevel,"ClientOptions.logLevel",this)??rv(qi("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??c,this.fetchOptions=o.fetchOptions,this.maxRetries=o.maxRetries??2,this.fetch=o.fetch??RV(),Ae(this,Fu,$V),this._options=o,this.apiKey=typeof n=="string"?n:"Missing Key",this.organization=r,this.project=s,this.webhookSecret=i}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:n}){}async authHeaders(e){return oe([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return UV(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${Xi}`}defaultIdempotencyKey(){return`stainless-node-retry-${ZC()}`}makeStatusError(e,n,r,s){return Xt.generate(e,n,r,s)}async _callApiKey(){const e=this._options.apiKey;if(typeof e!="function")return!1;let n;try{n=await e()}catch(r){throw r instanceof we?r:new we(`Failed to get token from 'apiKey' function: ${r.message}`,{cause:r})}if(typeof n!="string"||!n)throw new we(`Expected 'apiKey' function argument to return a string but it returned ${n}`);return this.apiKey=n,!0}buildURL(e,n,r){const s=!P(this,Rm,"m",fI).call(this)&&r||this.baseURL,i=bV(e)?new URL(e):new URL(s+(s.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return vV(a)||(n={...a,...n}),typeof n=="object"&&n&&!Array.isArray(n)&&(i.search=this.stringifyQuery(n)),i.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:n,options:r}){}get(e,n){return this.methodRequest("get",e,n)}post(e,n){return this.methodRequest("post",e,n)}patch(e,n){return this.methodRequest("patch",e,n)}put(e,n){return this.methodRequest("put",e,n)}delete(e,n){return this.methodRequest("delete",e,n)}methodRequest(e,n,r){return this.request(Promise.resolve(r).then(s=>({method:e,path:n,...s})))}request(e,n=null){return new xd(this,this.makeRequest(e,n,void 0))}async makeRequest(e,n,r){var b,y;const s=await e,i=s.maxRetries??this.maxRetries;n==null&&(n=i),await this.prepareOptions(s);const{req:a,url:o,timeout:c}=await this.buildRequest(s,{retryCount:i-n});await this.prepareRequest(a,{url:o,options:s});const u="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),l=r===void 0?"":`, retryOf: ${r}`,d=Date.now();if(Ht(this).debug(`[${u}] sending request`,si({retryOfRequestLogID:r,method:s.method,url:o,options:s,headers:a.headers})),(b=s.signal)!=null&&b.aborted)throw new Fn;const h=new AbortController,f=await this.fetchWithTimeout(o,a,c,h).catch(gm),m=Date.now();if(f instanceof globalThis.Error){const E=`retrying, ${n} attempts remaining`;if((y=s.signal)!=null&&y.aborted)throw new Fn;const C=mm(f)||/timed? ?out/i.test(String(f)+("cause"in f?String(f.cause):""));if(n)return Ht(this).info(`[${u}] connection ${C?"timed out":"failed"} - ${E}`),Ht(this).debug(`[${u}] connection ${C?"timed out":"failed"} (${E})`,si({retryOfRequestLogID:r,url:o,durationMs:m-d,message:f.message})),this.retryRequest(s,n,r??u);throw Ht(this).info(`[${u}] connection ${C?"timed out":"failed"} - error; no more retries left`),Ht(this).debug(`[${u}] connection ${C?"timed out":"failed"} (error; no more retries left)`,si({retryOfRequestLogID:r,url:o,durationMs:m-d,message:f.message})),C?new Ed:new vd({cause:f})}const g=[...f.headers.entries()].filter(([E])=>E==="x-request-id").map(([E,C])=>", "+E+": "+JSON.stringify(C)).join(""),_=`[${u}${l}${g}] ${a.method} ${o} ${f.ok?"succeeded":"failed"} with status ${f.status} in ${m-d}ms`;if(!f.ok){const E=await this.shouldRetry(f);if(n&&E){const B=`retrying, ${n} attempts remaining`;return await OV(f.body),Ht(this).info(`${_} - ${B}`),Ht(this).debug(`[${u}] response error (${B})`,si({retryOfRequestLogID:r,url:f.url,status:f.status,headers:f.headers,durationMs:m-d})),this.retryRequest(s,n,r??u,f.headers)}const C=E?"error; no more retries left":"error; not retryable";Ht(this).info(`${_} - ${C}`);const k=await f.text().catch(B=>gm(B).message),R=xV(k),$=R?void 0:k;throw Ht(this).debug(`[${u}] response error (${C})`,si({retryOfRequestLogID:r,url:f.url,status:f.status,headers:f.headers,message:$,durationMs:Date.now()-d})),this.makeStatusError(f.status,R,$,f.headers)}return Ht(this).info(_),Ht(this).debug(`[${u}] response start`,si({retryOfRequestLogID:r,url:f.url,status:f.status,headers:f.headers,durationMs:m-d})),{response:f,options:s,controller:h,requestLogID:u,retryOfRequestLogID:r,startTime:d}}getAPIList(e,n,r){return this.requestAPIList(n,{method:"get",path:e,...r})}requestAPIList(e,n){const r=this.makeRequest(n,null,void 0);return new WV(this,r,e)}async fetchWithTimeout(e,n,r,s){const{signal:i,method:a,...o}=n||{};i&&i.addEventListener("abort",()=>s.abort());const c=setTimeout(()=>s.abort(),r),u=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||typeof o.body=="object"&&o.body!==null&&Symbol.asyncIterator in o.body,l={signal:s.signal,...u?{duplex:"half"}:{},method:"GET",...o};a&&(l.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,l)}finally{clearTimeout(c)}}async shouldRetry(e){const n=e.headers.get("x-should-retry");return n==="true"?!0:n==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,n,r,s){let i;const a=s==null?void 0:s.get("retry-after-ms");if(a){const c=parseFloat(a);Number.isNaN(c)||(i=c)}const o=s==null?void 0:s.get("retry-after");if(o&&!i){const c=parseFloat(o);Number.isNaN(c)?i=Date.parse(o)-Date.now():i=c*1e3}if(!(i&&0<=i&&i<60*1e3)){const c=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(n,c)}return await Ac(i),this.makeRequest(e,n-1,r)}calculateDefaultRetryTimeoutMillis(e,n){const i=n-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}async buildRequest(e,{retryCount:n=0}={}){const r={...e},{method:s,path:i,query:a,defaultBaseURL:o}=r,c=this.buildURL(i,a,o);"timeout"in r&&SV("timeout",r.timeout),r.timeout=r.timeout??this.timeout;const{bodyHeaders:u,body:l}=this.buildBody({options:r}),d=await this.buildHeaders({options:e,method:s,bodyHeaders:u,retryCount:n});return{req:{method:s,headers:d,...r.signal&&{signal:r.signal},...globalThis.ReadableStream&&l instanceof globalThis.ReadableStream&&{duplex:"half"},...l&&{body:l},...this.fetchOptions??{},...r.fetchOptions??{}},url:c,timeout:r.timeout}}async buildHeaders({options:e,method:n,bodyHeaders:r,retryCount:s}){let i={};this.idempotencyHeader&&n!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const a=oe([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(s),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...IV(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,r,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:n}}){if(!e)return{bodyHeaders:void 0,body:void 0};const r=oe([n]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&r.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:YC(e)}:P(this,Fu,"f").call(this,{body:e,headers:r})}}My=Me,Fu=new WeakMap,Rm=new WeakSet,fI=function(){return this.baseURL!=="https://api.openai.com/v1"};Me.OpenAI=My;Me.DEFAULT_TIMEOUT=6e5;Me.OpenAIError=we;Me.APIError=Xt;Me.APIConnectionError=vd;Me.APIConnectionTimeoutError=Ed;Me.APIUserAbortError=Fn;Me.NotFoundError=LC;Me.ConflictError=MC;Me.RateLimitError=UC;Me.BadRequestError=$C;Me.AuthenticationError=NC;Me.InternalServerError=BC;Me.PermissionDeniedError=PC;Me.UnprocessableEntityError=DC;Me.InvalidWebhookSignatureError=to;Me.toFile=YV;Me.Completions=Vk;Me.Chat=Sy;Me.Embeddings=Gk;Me.Files=Jk;Me.Images=eI;Me.Audio=Cc;Me.Moderations=nI;Me.Models=tI;Me.FineTuning=Ba;Me.Graders=Ny;Me.VectorStores=Od;Me.Webhooks=hI;Me.Beta=Ua;Me.Batches=Lk;Me.Uploads=Ly;Me.Responses=Rd;Me.Realtime=Id;Me.Conversations=Cy;Me.Evals=Iy;Me.Containers=Ay;Me.Videos=lI;var Dy=class extends Pi{constructor(e){var r,s,i;super(e??{});p(this,"temperature");p(this,"topP");p(this,"frequencyPenalty");p(this,"presencePenalty");p(this,"n");p(this,"logitBias");p(this,"model","gpt-3.5-turbo");p(this,"modelKwargs");p(this,"stop");p(this,"stopSequences");p(this,"user");p(this,"timeout");p(this,"streaming",!1);p(this,"streamUsage",!0);p(this,"maxTokens");p(this,"logprobs");p(this,"topLogprobs");p(this,"apiKey");p(this,"organization");p(this,"__includeRawResponse");p(this,"client");p(this,"clientConfig");p(this,"supportsStrictToolCalling");p(this,"audio");p(this,"modalities");p(this,"reasoning");p(this,"zdrEnabled");p(this,"service_tier");p(this,"promptCacheKey");p(this,"verbosity");p(this,"defaultOptions");p(this,"lc_serializable",!0);const n=typeof((r=e==null?void 0:e.configuration)==null?void 0:r.apiKey)=="string"?(s=e==null?void 0:e.configuration)==null?void 0:s.apiKey:void 0;this.apiKey=(e==null?void 0:e.apiKey)??n??nr("OPENAI_API_KEY"),this.organization=((i=e==null?void 0:e.configuration)==null?void 0:i.organization)??nr("OPENAI_ORGANIZATION"),this.model=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoning=e==null?void 0:e.reasoning,this.maxTokens=(e==null?void 0:e.maxCompletionTokens)??(e==null?void 0:e.maxTokens),this.promptCacheKey=(e==null?void 0:e.promptCacheKey)??this.promptCacheKey,this.verbosity=(e==null?void 0:e.verbosity)??this.verbosity,this.disableStreaming=(e==null?void 0:e.disableStreaming)===!0,this.streaming=(e==null?void 0:e.streaming)===!0,this.disableStreaming&&(this.streaming=!1),(e==null?void 0:e.streaming)===!1&&(this.disableStreaming=!0),this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),(e==null?void 0:e.service_tier)!==void 0&&(this.service_tier=e.service_tier),this.zdrEnabled=(e==null?void 0:e.zdrEnabled)??!1}_llmType(){return"openai"}static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning","service_tier"]}get lc_secrets(){return{apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{apiKey:"openai_api_key",modelName:"model"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","model","modelName","modelKwargs","stop","stopSequences","timeout","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","zdrEnabled","reasoning","promptCacheKey","verbosity"]}getLsParams(e){const n=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:n.temperature??void 0,ls_max_tokens:n.max_tokens??void 0,ls_stop:e.stop}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}_getReasoningParams(e){if(!Sc(this.model))return;let n;return this.reasoning!==void 0&&(n={...n,...this.reasoning}),(e==null?void 0:e.reasoning)!==void 0&&(n={...n,...e.reasoning}),n}_getResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&tr(e.json_schema.schema)?yV(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}_combineCallOptions(e){return{...this.defaultOptions,...e??{}}}_getClientOptions(e){if(!this.client){const r={baseURL:this.clientConfig.baseURL},s=tz(r),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new Me(i)}return{...this.clientConfig,...e}}_convertChatOpenAIToolToCompletionsTool(e,n){return Il(e)?uz(e.metadata.customTool):od(e)?(n==null?void 0:n.strict)!==void 0?{...e,function:{...e.function,strict:n.strict}}:e:nz(e,n)}bindTools(e,n){let r;return(n==null?void 0:n.strict)!==void 0?r=n.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this.withConfig({tools:e.map(s=>py(s)||Il(s)?s:this._convertChatOpenAIToolToCompletionsTool(s,{strict:r})),...n})}async stream(e,n){return super.stream(e,this._combineCallOptions(n))}async invoke(e,n){return super.invoke(e,this._combineCallOptions(n))}_combineLLMOutput(...e){return e.reduce((n,r)=>(r&&r.tokenUsage&&(n.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,n.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,n.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),n),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}async getNumTokensFromMessages(e){let n=0,r=0,s=0;this.model==="gpt-3.5-turbo-0301"?(r=4,s=-1):(r=3,s=1);const i=await Promise.all(e.map(async a=>{var h,f,m,g,_,b;const o=await this.getNumTokens(a.content),c=await this.getNumTokens(xc(a)),u=a.name!==void 0?s+await this.getNumTokens(a.name):0;let l=o+r+c+u;const d=a;if(d._getType()==="function"&&(l-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(l+=3),(f=d==null?void 0:d.additional_kwargs.function_call)!=null&&f.name&&(l+=await this.getNumTokens((m=d.additional_kwargs.function_call)==null?void 0:m.name)),(g=d.additional_kwargs.function_call)!=null&&g.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse((_=d.additional_kwargs.function_call)==null?void 0:_.arguments)))}catch(y){console.error("Error parsing function arguments",y,JSON.stringify(d.additional_kwargs.function_call)),l+=await this.getNumTokens((b=d.additional_kwargs.function_call)==null?void 0:b.arguments)}return n+=l,l}));return n+=3,{totalCount:n,countPerMessage:i}}async _getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var s;return(s=r.message.additional_kwargs)!=null&&s.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,s)=>r+s,0)}async _getEstimatedTokenCountFromPrompt(e,n,r){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(n&&r!=="auto"){const i=sz(n);s+=await this.getNumTokens(i),s+=9}return n&&e.find(i=>i._getType()==="system")&&(s-=4),r==="none"?s+=1:typeof r=="object"&&(s+=await this.getNumTokens(r.name)+4),s}_getStructuredOutputMethod(e){const n={...e};if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"){if((n==null?void 0:n.method)===void 0)return"jsonSchema"}else n.method==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`);return n.method}withStructuredOutput(e,n){let r,s;const{schema:i,name:a,includeRaw:o}={...n,schema:e};if((n==null?void 0:n.strict)!==void 0&&n.method==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");const c=mV(this.model,n==null?void 0:n.method);if(c==="jsonMode"){tr(i)?s=ol.fromZodSchema(i):s=new Cp;const h=nn(i);r=this.withConfig({outputVersion:"v0",response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"json_mode"},schema:{title:a??"extract",...h}}})}else if(c==="jsonSchema"){const h={name:a??"extract",description:xi(i),schema:i,strict:n==null?void 0:n.strict},f=nn(h.schema);if(r=this.withConfig({outputVersion:"v0",response_format:{type:"json_schema",json_schema:h},ls_structured_output_format:{kwargs:{method:"json_schema"},schema:{title:h.name,description:h.description,...f}}}),tr(i)){const m=ol.fromZodSchema(i);s=Tr.from(g=>"parsed"in g.additional_kwargs?g.additional_kwargs.parsed:m)}else s=new Cp}else{let h=a??"extract";if(tr(i)){const f=nn(i);r=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:{name:h,description:f.description,parameters:f}}],tool_choice:{type:"function",function:{name:h}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:h,...f}},...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}),s=new Rp({returnSingle:!0,keyName:h,zodSchema:i})}else{let f;typeof i.name=="string"&&typeof i.parameters=="object"&&i.parameters!=null?(f=i,h=i.name):(h=i.title??h,f={name:h,description:i.description??"",parameters:i});const m=nn(i);r=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:f}],tool_choice:{type:"function",function:{name:h}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:h,...m}},...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}),s=new Rp({returnSingle:!0,keyName:h})}}if(!o)return r.pipe(s);const u=ms.assign({parsed:(h,f)=>s.invoke(h.raw,f)}),l=ms.assign({parsed:()=>null}),d=u.withFallbacks({fallbacks:[l]});return Jr.from([{raw:r},d])}};function ou(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function pI(t){if(!t||typeof t!="object")return t;let e;return t.constructor.name===Ed.name&&"message"in t&&typeof t.message=="string"?(e=new Error(t.message),e.name="TimeoutError"):t.constructor.name===Fn.name&&"message"in t&&typeof t.message=="string"?(e=new Error(t.message),e.name="AbortError"):"status"in t&&t.status===400&&"message"in t&&typeof t.message=="string"&&t.message.includes("tool_calls")?e=ou(t,"INVALID_TOOL_RESULTS"):"status"in t&&t.status===401?e=ou(t,"MODEL_AUTHENTICATION"):"status"in t&&t.status===429?e=ou(t,"MODEL_RATE_LIMIT"):"status"in t&&t.status===404?e=ou(t,"MODEL_NOT_FOUND"):e=t,e}function fq(t){if(t.type==="image"){if(t.url)return{type:"image_url",image_url:{url:t.url}};if(t.data)return{type:"image_url",image_url:{url:`data:${t.mimeType};base64,${t.data}`}}}if(t.type==="audio"&&t.data){const e=bi(()=>{const[,n]=t.mimeType.split("/");return n==="wav"||n==="mp3"?n:"wav"});return{type:"input_audio",input_audio:{data:t.data.toString(),format:e}}}if(t.type==="file"){if(t.data)return{type:"file",file:{file_data:t.data.toString()}};if(t.fileId)return{type:"file",file:{file_id:t.fileId}}}}function pq(t,e){let n=xc(t);if(n==="system"&&Sc(e)&&(n="developer"),n==="developer")return{role:"developer",content:t.contentBlocks.filter(s=>s.type==="text")};if(n==="system")return{role:"system",content:t.contentBlocks.filter(s=>s.type==="text")};if(n==="assistant")return{role:"assistant",content:t.contentBlocks.filter(s=>s.type==="text")};if(n==="tool"&&Hr.isInstance(t))return{role:"tool",tool_call_id:t.tool_call_id,content:t.contentBlocks.filter(s=>s.type==="text")};if(n==="function")return{role:"function",name:t.name??"",content:t.contentBlocks.filter(s=>s.type==="text").join("")};function*r(s){for(const i of s){i.type==="text"&&(yield{type:"text",text:i.text});const a=fq(i);a&&(yield a)}}return{role:"user",content:Array.from(r(t.contentBlocks))}}function mq(t){var r;const e=$i(t)&&((r=t.response_metadata)==null?void 0:r.model_provider)==="openai";function*n(){const s=bi(()=>{try{const y=xc(t);return y==="system"||y==="developer"||y==="assistant"||y==="user"?y:"assistant"}catch{return"assistant"}});let i;const a=new Set,o=new Set,c=new Map,u=new Map;function*l(){if(!i)return;const y=i.content;(typeof y=="string"&&y.length>0||Array.isArray(y)&&y.length>0)&&(yield i),i=void 0}const d=y=>{i||(i={type:"message",role:s,content:[]}),typeof i.content=="string"?i.content=i.content.length>0?[{type:"input_text",text:i.content},...y]:[...y]:i.content.push(...y)},h=y=>{if(typeof y=="string")return y;try{return JSON.stringify(y??{})}catch{return"{}"}},f=y=>{const E=bi(()=>{var k;const C=(k=y.metadata)==null?void 0:k.detail;return C==="low"||C==="high"||C==="auto"?C:"auto"});if(y.fileId)return{type:"input_image",detail:E,file_id:y.fileId};if(y.url)return{type:"input_image",detail:E,image_url:y.url};if(y.data){const C=typeof y.data=="string"?y.data:Kt.from(y.data).toString("base64"),k=y.mimeType??"image/png";return{type:"input_image",detail:E,image_url:`data:${k};base64,${C}`}}},m=y=>{var C,k,R;const E=((C=y.metadata)==null?void 0:C.filename)??((k=y.metadata)==null?void 0:k.name)??((R=y.metadata)==null?void 0:R.title);if(y.fileId&&typeof E=="string")return{type:"input_file",file_id:y.fileId,...E?{filename:E}:{}};if(y.url&&typeof E=="string")return{type:"input_file",file_url:y.url,...E?{filename:E}:{}};if(y.data&&typeof E=="string"){const $=typeof y.data=="string"?y.data:Kt.from(y.data).toString("base64");return{type:"input_file",file_data:`data:${y.mimeType??"application/octet-stream"};base64,${$}`,...E?{filename:E}:{}}}},g=y=>{const E=bi(()=>{if(Array.isArray(y.summary)){const R=y.summary,$=(R==null?void 0:R.map(T=>T==null?void 0:T.text).filter(T=>typeof T=="string"))??[];if($.length>0)return $}return y.reasoning?[y.reasoning]:[]}),C=E.length>0?E.map(R=>({type:"summary_text",text:R})):[{type:"summary_text",text:""}],k={type:"reasoning",id:y.id??"",summary:C};return y.reasoning&&(k.content=[{type:"reasoning_text",text:y.reasoning}]),k},_=y=>({type:"function_call",name:y.name??"",call_id:y.id??"",arguments:h(y.args)}),b=y=>{const E=h(y.output),C=y.status==="success"?"completed":y.status==="error"?"incomplete":void 0;return{type:"function_call_output",call_id:y.toolCallId??"",output:E,...C?{status:C}:{}}};for(const y of t.contentBlocks)if(y.type==="text")d([{type:"input_text",text:y.text}]);else if(y.type!=="invalid_tool_call"){if(y.type==="reasoning")yield*l(),yield g(y);else if(y.type==="tool_call"){yield*l();const E=y.id??"";E&&(a.add(E),c.delete(E)),yield _(y)}else if(y.type==="tool_call_chunk"){if(y.id){const E=c.get(y.id)??{name:y.name,args:[]};y.name&&(E.name=y.name),y.args&&E.args.push(y.args),c.set(y.id,E)}}else if(y.type==="server_tool_call"){yield*l();const E=y.id??"";E&&(o.add(E),u.delete(E)),yield _(y)}else if(y.type==="server_tool_call_chunk"){if(y.id){const E=u.get(y.id)??{name:y.name,args:[]};y.name&&(E.name=y.name),y.args&&E.args.push(y.args),u.set(y.id,E)}}else if(y.type==="server_tool_call_result")yield*l(),yield b(y);else if(y.type!=="audio")if(y.type==="file"){const E=m(y);E&&d([E])}else if(y.type==="image"){const E=f(y);E&&d([E])}else if(y.type==="video"){const E=m(y);E&&d([E])}else y.type==="text-plain"?y.text&&d([{type:"input_text",text:y.text}]):y.type==="non_standard"&&e&&(yield*l(),yield y.value)}yield*l();for(const[y,E]of c){if(!y||a.has(y))continue;const C=E.args.join("");!E.name&&!C||(yield{type:"function_call",call_id:y,name:E.name??"",arguments:C})}for(const[y,E]of u){if(!y||o.has(y))continue;const C=E.args.join("");!E.name&&!C||(yield{type:"function_call",call_id:y,name:E.name??"",arguments:C})}}return Array.from(n())}const mI={providerName:"ChatOpenAI",fromStandardTextBlock(t){return{type:"text",text:t.text}},fromStandardImageBlock(t){var e,n;if(t.source_type==="url")return{type:"image_url",image_url:{url:t.url,...(e=t.metadata)!=null&&e.detail?{detail:t.metadata.detail}:{}}};if(t.source_type==="base64")return{type:"image_url",image_url:{url:`data:${t.mime_type??""};base64,${t.data}`,...(n=t.metadata)!=null&&n.detail?{detail:t.metadata.detail}:{}}};throw new Error(`Image content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(t){if(t.source_type==="url"){const e=vi({dataUrl:t.url});if(!e)throw new Error(`URL audio blocks with source_type ${t.source_type} must be formatted as a data URL for ChatOpenAI`);const n=e.mime_type||t.mime_type||"";let r;try{r=ci(n)}catch{throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`)}if(r.type!=="audio"||r.subtype!=="wav"&&r.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:r.subtype,data:e.data}}}if(t.source_type==="base64"){let e;try{e=ci(t.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`)}if(e.type!=="audio"||e.subtype!=="wav"&&e.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:e.subtype,data:t.data}}}throw new Error(`Audio content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(t){var e,n,r,s,i,a,o,c,u,l;if(t.source_type==="url"){if(!vi({dataUrl:t.url}))throw new Error(`URL file blocks with source_type ${t.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:t.url,...(e=t.metadata)!=null&&e.filename||(n=t.metadata)!=null&&n.name?{filename:((r=t.metadata)==null?void 0:r.filename)||((s=t.metadata)==null?void 0:s.name)}:{}}}}if(t.source_type==="base64")return{type:"file",file:{file_data:`data:${t.mime_type??""};base64,${t.data}`,...(i=t.metadata)!=null&&i.filename||(a=t.metadata)!=null&&a.name||(o=t.metadata)!=null&&o.title?{filename:((c=t.metadata)==null?void 0:c.filename)||((u=t.metadata)==null?void 0:u.name)||((l=t.metadata)==null?void 0:l.title)}:{}}};if(t.source_type==="id")return{type:"file",file:{file_id:t.id}};throw new Error(`File content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)}};function vv(t,e){return t.flatMap(n=>{var a,o;if("output_version"in n.response_metadata&&((a=n.response_metadata)==null?void 0:a.output_version)==="v1")return pq(n);let r=xc(n);r==="system"&&Sc(e)&&(r="developer");const s=typeof n.content=="string"?n.content:n.content.map(c=>vr(c)?Hl(c,mI):c),i={role:r,content:s};if(n.name!=null&&(i.name=n.name),n.additional_kwargs.function_call!=null&&(i.function_call=n.additional_kwargs.function_call,i.content=""),$i(n)&&((o=n.tool_calls)!=null&&o.length)?(i.tool_calls=n.tool_calls.map(Mx),i.content=""):(n.additional_kwargs.tool_calls!=null&&(i.tool_calls=n.additional_kwargs.tool_calls),n.tool_call_id!=null&&(i.tool_call_id=n.tool_call_id)),n.additional_kwargs.audio&&typeof n.additional_kwargs.audio=="object"&&"id"in n.additional_kwargs.audio){const c={role:"assistant",audio:{id:n.additional_kwargs.audio.id}};return[i,c]}return i})}const Gi="__openai_function_call_ids__";var gq=class extends Dy{invocationParams(t){var s;let e;(t==null?void 0:t.strict)!==void 0?e=t.strict:this.supportsStrictToolCalling!==void 0&&(e=this.supportsStrictToolCalling);const n={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:t==null?void 0:t.previous_response_id,truncation:t==null?void 0:t.truncation,include:t==null?void 0:t.include,tools:(s=t==null?void 0:t.tools)!=null&&s.length?this._reduceChatOpenAITools(t.tools,{stream:this.streaming,strict:e}):void 0,tool_choice:iz(t==null?void 0:t.tool_choice)?t==null?void 0:t.tool_choice:(()=>{const i=RC(t==null?void 0:t.tool_choice);if(typeof i=="object"&&"type"in i){if(i.type==="function")return{type:"function",name:i.function.name};if(i.type==="allowed_tools")return{type:"allowed_tools",mode:i.allowed_tools.mode,tools:i.allowed_tools.tools};if(i.type==="custom")return{type:"custom",name:i.custom.name}}})(),text:(()=>{if(t!=null&&t.text)return t.text;const i=this._getResponseFormat(t==null?void 0:t.response_format);return(i==null?void 0:i.type)==="json_schema"?i.json_schema.schema!=null?{format:{type:"json_schema",schema:i.json_schema.schema,description:i.json_schema.description,name:i.json_schema.name,strict:i.json_schema.strict},verbosity:t==null?void 0:t.verbosity}:void 0:{format:i,verbosity:t==null?void 0:t.verbosity}})(),parallel_tool_calls:t==null?void 0:t.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,prompt_cache_key:(t==null?void 0:t.promptCacheKey)??this.promptCacheKey,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},r=this._getReasoningParams(t);return r!==void 0&&(n.reasoning=r),n}async _generate(t,e){var r;const n=this.invocationParams(e);if(n.stream){const s=this._streamResponseChunks(t,e);let i;for await(const a of s)a.message.response_metadata={...a.generationInfo,...a.message.response_metadata},i=(i==null?void 0:i.concat(a))??a;return{generations:i?[i]:[],llmOutput:{estimatedTokenUsage:(r=i==null?void 0:i.message)==null?void 0:r.usage_metadata}}}else{const s=this._convertMessagesToResponsesParams(t),i=await this.completionWithRetry({input:s,...n,stream:!1},{signal:e==null?void 0:e.signal,...e==null?void 0:e.options});return{generations:[{text:i.output_text,message:this._convertResponsesMessageToBaseMessage(i)}],llmOutput:{id:i.id,estimatedTokenUsage:i.usage?{promptTokens:i.usage.input_tokens,completionTokens:i.usage.output_tokens,totalTokens:i.usage.total_tokens}:void 0}}}}async*_streamResponseChunks(t,e,n){const r=await this.completionWithRetry({...this.invocationParams(e),input:this._convertMessagesToResponsesParams(t),stream:!0},e);for await(const s of r){const i=this._convertResponsesDeltaToBaseMessageChunk(s);i!=null&&(yield i,await(n==null?void 0:n.handleLLMNewToken(i.text||"",{prompt:e.promptIndex??0,completion:0},void 0,void 0,void 0,{chunk:i})))}}async completionWithRetry(t,e){return this.caller.call(async()=>{var r,s;const n=this._getClientOptions(e);try{return((s=(r=t.text)==null?void 0:r.format)==null?void 0:s.type)==="json_schema"&&!t.stream?await this.client.responses.parse(t,n):await this.client.responses.create(t,n)}catch(i){throw pI(i)}})}_convertResponsesMessageToBaseMessage(t){if(t.error){const o=new Error(t.error.message);throw o.name=t.error.code,o}let e;const n=[],r=[],s=[],i={model_provider:"openai",model:t.model,created_at:t.created_at,id:t.id,incomplete_details:t.incomplete_details,metadata:t.metadata,object:t.object,status:t.status,user:t.user,service_tier:t.service_tier,model_name:t.model},a={};for(const o of t.output)if(o.type==="message")e=o.id,n.push(...o.content.flatMap(c=>c.type==="output_text"?("parsed"in c&&c.parsed!=null&&(a.parsed=c.parsed),{type:"text",text:c.text,annotations:c.annotations}):c.type==="refusal"?(a.refusal=c.refusal,[]):c));else if(o.type==="function_call"){const c={function:{name:o.name,arguments:o.arguments},id:o.call_id};try{r.push(ud(c,{returnId:!0}))}catch(u){let l;typeof u=="object"&&u!=null&&"message"in u&&typeof u.message=="string"&&(l=u.message),s.push(cl(c,l))}a[Gi]??(a[Gi]={}),o.id&&(a[Gi][o.call_id]=o.id)}else if(o.type==="reasoning")a.reasoning=o;else if(o.type==="custom_tool_call"){const c=az(o);c?r.push(c):s.push(cl(o,"Malformed custom tool call"))}else a.tool_outputs??(a.tool_outputs=[]),a.tool_outputs.push(o);return new ht({id:e,content:n,tool_calls:r,invalid_tool_calls:s,usage_metadata:G0(t.usage),additional_kwargs:a,response_metadata:i})}_convertResponsesDeltaToBaseMessageChunk(t){var c,u;const e=[];let n={},r;const s=[],i={model_provider:"openai"},a={};let o;if(t.type==="response.output_text.delta")e.push({type:"text",text:t.delta,index:t.content_index});else if(t.type==="response.output_text.annotation.added")e.push({type:"text",text:"",annotations:[t.annotation],index:t.content_index});else if(t.type==="response.output_item.added"&&t.item.type==="message")o=t.item.id;else if(t.type==="response.output_item.added"&&t.item.type==="function_call")s.push({type:"tool_call_chunk",name:t.item.name,args:t.item.arguments,id:t.item.call_id,index:t.output_index}),a[Gi]={[t.item.call_id]:t.item.id};else if(t.type==="response.output_item.done"&&["web_search_call","file_search_call","computer_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","image_generation_call","custom_tool_call"].includes(t.item.type))a.tool_outputs=[t.item];else if(t.type==="response.created")i.id=t.response.id,i.model_name=t.response.model,i.model=t.response.model;else if(t.type==="response.completed"){const l=this._convertResponsesMessageToBaseMessage(t.response);r=G0(t.response.usage),((u=(c=t.response.text)==null?void 0:c.format)==null?void 0:u.type)==="json_schema"&&(a.parsed??(a.parsed=JSON.parse(l.text)));for(const[d,h]of Object.entries(t.response))d!=="id"&&(i[d]=h)}else if(t.type==="response.function_call_arguments.delta"||t.type==="response.custom_tool_call_input.delta")s.push({type:"tool_call_chunk",args:t.delta,index:t.output_index});else if(t.type==="response.web_search_call.completed"||t.type==="response.file_search_call.completed")n={tool_outputs:{id:t.item_id,type:t.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(t.type==="response.refusal.done")a.refusal=t.refusal;else if(t.type==="response.output_item.added"&&"item"in t&&t.item.type==="reasoning"){const l=t.item.summary?t.item.summary.map((d,h)=>({...d,index:h})):void 0;a.reasoning={id:t.item.id,type:t.item.type,...l?{summary:l}:{}}}else if(t.type==="response.reasoning_summary_part.added")a.reasoning={type:"reasoning",summary:[{...t.part,index:t.summary_index}]};else if(t.type==="response.reasoning_summary_text.delta")a.reasoning={type:"reasoning",summary:[{text:t.delta,type:"summary_text",index:t.summary_index}]};else return t.type==="response.image_generation_call.partial_image",null;return new fn({text:e.map(l=>l.text).join(""),message:new Et({id:o,content:e,tool_call_chunks:s,usage_metadata:r,additional_kwargs:a,response_metadata:i}),generationInfo:n})}_convertMessagesToResponsesParams(t){return t.flatMap(e=>{var i,a,o,c;const n=e.response_metadata;if((n==null?void 0:n.output_version)==="v1")return mq(e);const r=e.additional_kwargs;let s=xc(e);if(s==="system"&&Sc(this.model)&&(s="developer"),s==="function")throw new Error("Function messages are not supported in Responses API");if(s==="tool"){const u=e;return(r==null?void 0:r.type)==="computer_call_output"?{type:"computer_call_output",output:(()=>{if(typeof u.content=="string")return{type:"computer_screenshot",image_url:u.content};if(Array.isArray(u.content)){const d=u.content.find(f=>f.type==="computer_screenshot");if(d)return d;const h=u.content.find(f=>f.type==="image_url");if(h)return{type:"computer_screenshot",image_url:typeof h.image_url=="string"?h.image_url:h.image_url.url}}throw new Error("Invalid computer call output")})(),call_id:u.tool_call_id}:(i=u.additional_kwargs)!=null&&i.customTool?{type:"custom_tool_call_output",call_id:u.tool_call_id,output:u.content}:{type:"function_call_output",call_id:u.tool_call_id,id:(a=u.id)!=null&&a.startsWith("fc_")?u.id:void 0,output:typeof u.content!="string"?JSON.stringify(u.content):u.content}}if(s==="assistant"){if(!this.zdrEnabled&&(n==null?void 0:n.output)!=null&&Array.isArray(n==null?void 0:n.output)&&(n==null?void 0:n.output.length)>0&&(n!=null&&n.output.every(m=>"type"in m)))return n==null?void 0:n.output;const u=[];if(r!=null&&r.reasoning&&!this.zdrEnabled){const m=this._convertReasoningSummary(r.reasoning);u.push(m)}let{content:l}=e;r!=null&&r.refusal&&(typeof l=="string"&&(l=[{type:"output_text",text:l,annotations:[]}]),l=[...l,{type:"refusal",refusal:r.refusal}]),(typeof l=="string"||l.length>0)&&u.push({type:"message",role:"assistant",...e.id&&!this.zdrEnabled&&e.id.startsWith("msg_")?{id:e.id}:{},content:bi(()=>typeof l=="string"?l:l.flatMap(m=>m.type==="text"?{type:"output_text",text:m.text,annotations:m.annotations??[]}:m.type==="output_text"||m.type==="refusal"?m:[]))});const d=r==null?void 0:r[Gi];$i(e)&&((o=e.tool_calls)!=null&&o.length)?u.push(...e.tool_calls.map(m=>oz(m)?{type:"custom_tool_call",id:m.call_id,call_id:m.id??"",input:m.args.input,name:m.name}:{type:"function_call",name:m.name,arguments:JSON.stringify(m.args),call_id:m.id,...this.zdrEnabled?{id:d==null?void 0:d[m.id]}:{}})):r!=null&&r.tool_calls&&u.push(...r.tool_calls.map(m=>({type:"function_call",name:m.function.name,call_id:m.id,arguments:m.function.arguments,...this.zdrEnabled?{id:d==null?void 0:d[m.id]}:{}})));const h=(c=n==null?void 0:n.output)!=null&&c.length?n==null?void 0:n.output:r.tool_outputs,f=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(h!=null){const m=h,g=m==null?void 0:m.filter(_=>f.includes(_.type));g.length>0&&u.push(...g)}return u}if(s==="user"||s==="system"||s==="developer"){if(typeof e.content=="string")return{type:"message",role:s,content:e.content};const u=[],l=e.content.flatMap(d=>{if(d.type==="mcp_approval_response"&&u.push({type:"mcp_approval_response",approval_request_id:d.approval_request_id,approve:d.approve}),vr(d))return Hl(d,mI);if(d.type==="text")return{type:"input_text",text:d.text};if(d.type==="image_url"){const h=bi(()=>{if(typeof d.image_url=="string")return d.image_url;if(typeof d.image_url=="object"&&d.image_url!==null&&"url"in d.image_url)return d.image_url.url}),f=bi(()=>{if(typeof d.image_url=="string")return"auto";if(typeof d.image_url=="object"&&d.image_url!==null&&"detail"in d.image_url)return d.image_url.detail});return{type:"input_image",image_url:h,detail:f}}return d.type==="input_text"||d.type==="input_image"||d.type==="input_file"?d:[]});return l.length>0&&u.push({type:"message",role:s,content:l}),u}return console.warn(`Unsupported role found when converting to OpenAI Responses API: ${s}`),[]})}_convertReasoningSummary(t){const e=(t.summary.length>1?t.summary.reduce((n,r)=>{const s=n[n.length-1];return s.index===r.index?s.text+=r.text:n.push(r),n},[{...t.summary[0]}]):t.summary).map(n=>Object.fromEntries(Object.entries(n).filter(([r])=>r!=="index")));return{...t,summary:e}}_reduceChatOpenAITools(t,e){const n=[];for(const r of t)if(py(r))r.type==="image_generation"&&(e!=null&&e.stream)&&(r.partial_images=1),n.push(r);else if(Il(r)){const s=r.metadata.customTool;n.push({type:"custom",name:s.name,description:s.description,format:s.format})}else od(r)?n.push({type:"function",name:r.function.name,parameters:r.function.parameters,description:r.function.description,strict:(e==null?void 0:e.strict)??null}):OC(r)&&n.push(cz(r));return n}},yq=class extends Dy{invocationParams(t,e){var a;let n;(t==null?void 0:t.strict)!==void 0?n=t.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling);let r={};(t==null?void 0:t.stream_options)!==void 0?r={stream_options:t.stream_options}:this.streamUsage&&(this.streaming||e!=null&&e.streaming)&&(r={stream_options:{include_usage:!0}});const s={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(t==null?void 0:t.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:t==null?void 0:t.functions,function_call:t==null?void 0:t.function_call,tools:(a=t==null?void 0:t.tools)!=null&&a.length?t.tools.map(o=>this._convertChatOpenAIToolToCompletionsTool(o,{strict:n})):void 0,tool_choice:RC(t==null?void 0:t.tool_choice),response_format:this._getResponseFormat(t==null?void 0:t.response_format),seed:t==null?void 0:t.seed,...r,parallel_tool_calls:t==null?void 0:t.parallel_tool_calls,...this.audio||t!=null&&t.audio?{audio:this.audio||(t==null?void 0:t.audio)}:{},...this.modalities||t!=null&&t.modalities?{modalities:this.modalities||(t==null?void 0:t.modalities)}:{},...this.modelKwargs,prompt_cache_key:(t==null?void 0:t.promptCacheKey)??this.promptCacheKey,verbosity:(t==null?void 0:t.verbosity)??this.verbosity};(t==null?void 0:t.prediction)!==void 0&&(s.prediction=t.prediction),this.service_tier!==void 0&&(s.service_tier=this.service_tier),(t==null?void 0:t.service_tier)!==void 0&&(s.service_tier=t.service_tier);const i=this._getReasoningParams(t);return i!==void 0&&i.effort!==void 0&&(s.reasoning_effort=i.effort),Sc(s.model)?s.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:s.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,s}async _generate(t,e,n){var a,o;const r={},s=this.invocationParams(e),i=vv(t,this.model);if(s.stream){const c=this._streamResponseChunks(t,e,n),u={};for await(const g of c){g.message.response_metadata={...g.generationInfo,...g.message.response_metadata};const _=((a=g.generationInfo)==null?void 0:a.completion)??0;u[_]===void 0?u[_]=g:u[_]=u[_].concat(g)}const l=Object.entries(u).sort(([g],[_])=>parseInt(g,10)-parseInt(_,10)).map(([g,_])=>_),{functions:d,function_call:h}=this.invocationParams(e),f=await this._getEstimatedTokenCountFromPrompt(t,d,h),m=await this._getNumTokensFromGenerations(l);return r.input_tokens=f,r.output_tokens=m,r.total_tokens=f+m,{generations:l,llmOutput:{estimatedTokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}else{const c=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:e==null?void 0:e.signal,...e==null?void 0:e.options}),{completion_tokens:u,prompt_tokens:l,total_tokens:d,prompt_tokens_details:h,completion_tokens_details:f}=(c==null?void 0:c.usage)??{};u&&(r.output_tokens=(r.output_tokens??0)+u),l&&(r.input_tokens=(r.input_tokens??0)+l),d&&(r.total_tokens=(r.total_tokens??0)+d),((h==null?void 0:h.audio_tokens)!==null||(h==null?void 0:h.cached_tokens)!==null)&&(r.input_token_details={...(h==null?void 0:h.audio_tokens)!==null&&{audio:h==null?void 0:h.audio_tokens},...(h==null?void 0:h.cached_tokens)!==null&&{cache_read:h==null?void 0:h.cached_tokens}}),((f==null?void 0:f.audio_tokens)!==null||(f==null?void 0:f.reasoning_tokens)!==null)&&(r.output_token_details={...(f==null?void 0:f.audio_tokens)!==null&&{audio:f==null?void 0:f.audio_tokens},...(f==null?void 0:f.reasoning_tokens)!==null&&{reasoning:f==null?void 0:f.reasoning_tokens}});const m=[];for(const g of(c==null?void 0:c.choices)??[]){const b={text:((o=g.message)==null?void 0:o.content)??"",message:this._convertCompletionsMessageToBaseMessage(g.message??{role:"assistant"},c)};b.generationInfo={...g.finish_reason?{finish_reason:g.finish_reason}:{},...g.logprobs?{logprobs:g.logprobs}:{}},$i(b.message)&&(b.message.usage_metadata=r),b.message=new ht(Object.fromEntries(Object.entries(b.message).filter(([y])=>!y.startsWith("lc_")))),m.push(b)}return{generations:m,llmOutput:{tokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}}async*_streamResponseChunks(t,e,n){var c,u,l,d,h,f,m,g,_,b;const r=vv(t,this.model),s={...this.invocationParams(e,{streaming:!0}),messages:r,stream:!0};let i;const a=await this.completionWithRetry(s,e);let o;for await(const y of a){const E=(c=y==null?void 0:y.choices)==null?void 0:c[0];if(y.usage&&(o=y.usage),!E)continue;const{delta:C}=E;if(!C)continue;const k=this._convertCompletionsDeltaToBaseMessageChunk(C,y,i);i=C.role??i;const R={prompt:e.promptIndex??0,completion:E.index??0};if(typeof k.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const $={...R};E.finish_reason!=null&&($.finish_reason=E.finish_reason,$.system_fingerprint=y.system_fingerprint,$.model_name=y.model,$.service_tier=y.service_tier),this.logprobs&&($.logprobs=E.logprobs);const T=new fn({message:k,text:k.content,generationInfo:$});yield T,await(n==null?void 0:n.handleLLMNewToken(T.text??"",R,void 0,void 0,void 0,{chunk:T}))}if(o){const y={...((u=o.prompt_tokens_details)==null?void 0:u.audio_tokens)!==null&&{audio:(l=o.prompt_tokens_details)==null?void 0:l.audio_tokens},...((d=o.prompt_tokens_details)==null?void 0:d.cached_tokens)!==null&&{cache_read:(h=o.prompt_tokens_details)==null?void 0:h.cached_tokens}},E={...((f=o.completion_tokens_details)==null?void 0:f.audio_tokens)!==null&&{audio:(m=o.completion_tokens_details)==null?void 0:m.audio_tokens},...((g=o.completion_tokens_details)==null?void 0:g.reasoning_tokens)!==null&&{reasoning:(_=o.completion_tokens_details)==null?void 0:_.reasoning_tokens}};yield new fn({message:new Et({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(y).length>0&&{input_token_details:y},...Object.keys(E).length>0&&{output_token_details:E}}}),text:""})}if((b=e.signal)!=null&&b.aborted)throw new Error("AbortError")}async completionWithRetry(t,e){const n=this._getClientOptions(e),r=t.response_format&&t.response_format.type==="json_schema";return this.caller.call(async()=>{try{return r&&!t.stream?await this.client.chat.completions.parse(t,n):await this.client.chat.completions.create(t,n)}catch(s){throw pI(s)}})}_convertCompletionsMessageToBaseMessage(t,e){var r,s;const n=t.tool_calls;switch(t.role){case"assistant":{const i=[],a=[];for(const l of n??[])try{i.push(ud(l,{returnId:!0}))}catch(d){a.push(cl(l,d.message))}const o={function_call:t.function_call,tool_calls:n};this.__includeRawResponse!==void 0&&(o.__raw_response=e);const c={model_provider:"openai",model_name:e.model,...e.system_fingerprint?{usage:{...e.usage},system_fingerprint:e.system_fingerprint}:{}};t.audio&&(o.audio=t.audio);const u=_V(t.content||"",(s=(r=e.choices)==null?void 0:r[0])==null?void 0:s.message);return new ht({content:u,tool_calls:i,invalid_tool_calls:a,additional_kwargs:o,response_metadata:c,id:e.id})}default:return new Zr(t.content||"",t.role??"unknown")}}_convertCompletionsDeltaToBaseMessageChunk(t,e,n){var o,c;const r=t.role??n,s=t.content??"";let i;t.function_call?i={function_call:t.function_call}:t.tool_calls?i={tool_calls:t.tool_calls}:i={},this.__includeRawResponse&&(i.__raw_response=e),t.audio&&(i.audio={...t.audio,index:e.choices[0].index});const a={model_provider:"openai",usage:{...e.usage}};if(r==="user")return new oc({content:s,response_metadata:a});if(r==="assistant"){const u=[];if(Array.isArray(t.tool_calls))for(const l of t.tool_calls)u.push({name:(o=l.function)==null?void 0:o.name,args:(c=l.function)==null?void 0:c.arguments,id:l.id,index:l.index,type:"tool_call_chunk"});return new Et({content:s,tool_call_chunks:u,additional_kwargs:i,id:e.id,response_metadata:a})}else return r==="system"?new js({content:s,response_metadata:a}):r==="developer"?new js({content:s,response_metadata:a,additional_kwargs:{__openai_role__:"developer"}}):r==="function"?new ac({content:s,additional_kwargs:i,name:t.name,response_metadata:a}):r==="tool"?new rc({content:s,additional_kwargs:i,tool_call_id:t.tool_call_id,response_metadata:a}):new ic({content:s,role:r,response_metadata:a})}},_q=class gI extends Dy{constructor(n){super(n);p(this,"useResponsesApi",!1);p(this,"responses");p(this,"completions");this.fields=n,this.useResponsesApi=(n==null?void 0:n.useResponsesApi)??!1,this.responses=(n==null?void 0:n.responses)??new gq(n),this.completions=(n==null?void 0:n.completions)??new yq(n)}get lc_serializable_keys(){return[...super.lc_serializable_keys,"useResponsesApi"]}get callKeys(){return[...super.callKeys,"useResponsesApi"]}_useResponsesApi(n){var a,o,c,u,l;const r=(a=n==null?void 0:n.tools)==null?void 0:a.some(py),s=(n==null?void 0:n.previous_response_id)!=null||(n==null?void 0:n.text)!=null||(n==null?void 0:n.truncation)!=null||(n==null?void 0:n.include)!=null||((o=n==null?void 0:n.reasoning)==null?void 0:o.summary)!=null||((c=this.reasoning)==null?void 0:c.summary)!=null,i=((u=n==null?void 0:n.tools)==null?void 0:u.some(OC))||((l=n==null?void 0:n.tools)==null?void 0:l.some(Il));return this.useResponsesApi||r||s||i}getLsParams(n){const r=this._combineCallOptions(n);return this._useResponsesApi(n)?this.responses.getLsParams(r):this.completions.getLsParams(r)}invocationParams(n){const r=this._combineCallOptions(n);return this._useResponsesApi(n)?this.responses.invocationParams(r):this.completions.invocationParams(r)}async _generate(n,r,s){return this._useResponsesApi(r)?this.responses._generate(n,r):this.completions._generate(n,r,s)}async*_streamResponseChunks(n,r,s){if(this._useResponsesApi(r)){yield*this.responses._streamResponseChunks(n,this._combineCallOptions(r),s);return}yield*this.completions._streamResponseChunks(n,this._combineCallOptions(r),s)}withConfig(n){const r=new gI(this.fields);return r.defaultOptions={...this.defaultOptions,...n},r}};const wq={model_main:{assets:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:64e3,reasoning_budget:{1:16e3,2:32e3,3:63999}},flows:{id:"global.anthropic.claude-sonnet-4-5-20250929-v1:0",max_tokens:64e3,reasoning_budget:{1:8e3,2:16e3,3:24e3}},threats:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:64e3,reasoning_budget:{1:24e3,2:48e3,3:63999}},gaps:{id:"global.anthropic.claude-sonnet-4-5-20250929-v1:0",max_tokens:64e3,reasoning_budget:{1:4e3,2:8e3,3:12e3}}},model_summary:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:4e3},model_struct:{id:"global.anthropic.claude-haiku-4-5-20251001-v1:0",max_tokens:64e3},reasoning_models:["global.anthropic.claude-haiku-4-5-20251001-v1:0","anthropic.claude-3-5-haiku-20241022-v1:0","global.anthropic.claude-sonnet-4-5-20250929-v1:0"]},bq={openai_model_main:{assets:{id:"gpt-5-mini-2025-08-07",max_tokens:64e3},flows:{id:"gpt-5-2025-08-07",max_tokens:64e3},threats:{id:"gpt-5-mini-2025-08-07",max_tokens:64e3},gaps:{id:"gpt-5-2025-08-07",max_tokens:64e3}},openai_model_summary:{id:"gpt-5-mini-2025-08-07",max_tokens:4e3},openai_model_struct:{id:"gpt-5-mini-2025-08-07",max_tokens:64e3},openai_reasoning_models:["gpt-5-2025-08-07","gpt-5-mini-2025-08-07"]},vq={0:"minimal",1:"low",2:"medium",3:"high"},Eq={0:"minimal",1:"minimal",2:"low",3:"low"};function Ev(t,e="bedrock"){if(!t||typeof t!="object")throw new Error("Configuration must be a valid object");if(e!=="bedrock"&&e!=="openai")throw new Error(`Invalid provider: ${e}. Must be 'bedrock' or 'openai'`);return e==="bedrock"?Sq(t):xq(t)}function Sq(t){if(!t.model_main)throw new Error("Configuration missing model_main");if(typeof t.model_main!="object")throw new Error("Configuration model_main must be an object");const e=["assets","flows","threats","gaps"];for(const n of e)Tq(t.model_main,n);if(Sv(t,"model_summary"),Sv(t,"model_struct"),!Array.isArray(t.reasoning_models))throw new Error("Configuration reasoning_models must be an array");return!0}function xq(t){if(!t.openai_model_main)throw new Error("Configuration missing openai_model_main");if(typeof t.openai_model_main!="object")throw new Error("Configuration openai_model_main must be an object");const e=["assets","flows","threats","gaps"];for(const n of e)Aq(t.openai_model_main,n,t.openai_reasoning_models);if(xv(t,"openai_model_summary",t.openai_reasoning_models),xv(t,"openai_model_struct",t.openai_reasoning_models),!Array.isArray(t.openai_reasoning_models))throw new Error("Configuration openai_reasoning_models must be an array");return!0}function Tq(t,e){if(!t[e])throw new Error(`Configuration missing model_main.${e}`);const n=t[e];if(typeof n!="object")throw new Error(`Configuration model_main.${e} must be an object`);if(!n.id)throw new Error(`Configuration missing model_main.${e}.id`);if(typeof n.id!="string"||n.id.trim()==="")throw new Error(`Configuration model_main.${e}.id must be a non-empty string`);if(typeof n.max_tokens!="number")throw new Error(`Configuration model_main.${e}.max_tokens must be a number`);if(n.max_tokens<=0||!Number.isInteger(n.max_tokens))throw new Error(`Configuration model_main.${e}.max_tokens must be a positive integer`);if(!n.reasoning_budget)throw new Error(`Configuration missing model_main.${e}.reasoning_budget`);if(typeof n.reasoning_budget!="object")throw new Error(`Configuration model_main.${e}.reasoning_budget must be an object`);const r=["1","2","3"];for(const s of r){if(!(s in n.reasoning_budget))throw new Error(`Configuration missing model_main.${e}.reasoning_budget["${s}"]`);const i=n.reasoning_budget[s];if(typeof i!="number")throw new Error(`Configuration model_main.${e}.reasoning_budget["${s}"] must be a number`);if(i<=0||!Number.isInteger(i))throw new Error(`Configuration model_main.${e}.reasoning_budget["${s}"] must be a positive integer`)}}function Aq(t,e,n=[]){if(!t[e])throw new Error(`Configuration missing openai_model_main.${e}`);const r=t[e];if(typeof r!="object")throw new Error(`Configuration openai_model_main.${e} must be an object`);if(!r.id)throw new Error(`Configuration missing openai_model_main.${e}.id`);if(typeof r.id!="string"||r.id.trim()==="")throw new Error(`Configuration openai_model_main.${e}.id must be a non-empty string`);if(!r.id.startsWith("gpt-5"))throw new Error(`Configuration openai_model_main.${e}.id must be a GPT-5 family model (e.g., gpt-5-2025-08-07 or gpt-5-mini-2025-08-07)`);if(typeof r.max_tokens!="number")throw new Error(`Configuration openai_model_main.${e}.max_tokens must be a number`);if(r.max_tokens<=0||!Number.isInteger(r.max_tokens))throw new Error(`Configuration openai_model_main.${e}.max_tokens must be a positive integer`);const s=128e3;if(r.max_tokens>s)throw new Error(`Configuration openai_model_main.${e}.max_tokens exceeds maximum allowed (${s})`);if(r.reasoning_budget)throw new Error(`Configuration openai_model_main.${e} should not contain reasoning_budget (OpenAI uses reasoning_effort parameter)`)}function Sv(t,e){if(!t[e])throw new Error(`Configuration missing ${e}`);const n=t[e];if(typeof n!="object")throw new Error(`Configuration ${e} must be an object`);if(!n.id)throw new Error(`Configuration missing ${e}.id`);if(typeof n.id!="string"||n.id.trim()==="")throw new Error(`Configuration ${e}.id must be a non-empty string`);if(typeof n.max_tokens!="number")throw new Error(`Configuration ${e}.max_tokens must be a number`);if(n.max_tokens<=0||!Number.isInteger(n.max_tokens))throw new Error(`Configuration ${e}.max_tokens must be a positive integer`)}function xv(t,e,n=[]){if(!t[e])throw new Error(`Configuration missing ${e}`);const r=t[e];if(typeof r!="object")throw new Error(`Configuration ${e} must be an object`);if(!r.id)throw new Error(`Configuration missing ${e}.id`);if(typeof r.id!="string"||r.id.trim()==="")throw new Error(`Configuration ${e}.id must be a non-empty string`);if(!r.id.startsWith("gpt-5"))throw new Error(`Configuration ${e}.id must be a GPT-5 family model (e.g., gpt-5-2025-08-07 or gpt-5-mini-2025-08-07)`);if(typeof r.max_tokens!="number")throw new Error(`Configuration ${e}.max_tokens must be a number`);if(r.max_tokens<=0||!Number.isInteger(r.max_tokens))throw new Error(`Configuration ${e}.max_tokens must be a positive integer`);const s=128e3;if(r.max_tokens>s)throw new Error(`Configuration ${e}.max_tokens exceeds maximum allowed (${s})`);if(r.reasoning_budget)throw new Error(`Configuration ${e} should not contain reasoning_budget (OpenAI uses reasoning_effort parameter)`)}const tc={VALIDATION_ERROR:{code:400,message:"Validation failed"},UNAUTHORIZED:{code:401,message:"Unauthorized access"},NOT_FOUND:{code:404,message:"Resource not found"},CREDENTIALS_ERROR:{code:401,message:"Invalid credentials"},MODEL_ERROR:{code:422,message:"Model invocation failed"},INTERNAL_ERROR:{code:500,message:"Internal server error"},OPENAI_AUTH_ERROR:{code:401,message:"OpenAI authentication failed"},OPENAI_RATE_LIMIT_ERROR:{code:429,message:"OpenAI rate limit exceeded"},MODEL_PROVIDER_ERROR:{code:422,message:"Model provider error"}};class St extends Error{constructor(e,n,r=null){var s;super(n),this.name="ThreatModelingError",this.type=e,this.statusCode=((s=tc[e])==null?void 0:s.code)||500,this.jobId=r,Error.captureStackTrace&&Error.captureStackTrace(this,St)}toResponse(){var e;return{error:((e=tc[this.type])==null?void 0:e.message)||"Unknown error",message:this.message,job_id:this.jobId}}toFetchError(){return{response:{status:this.statusCode,data:this.toResponse()}}}}function Kr(t){return async function(...e){try{return await t(...e)}catch(n){throw n instanceof St?n.toFetchError():n.response&&n.response.status&&n.response.data?n:new St("INTERNAL_ERROR",n.message||"An unexpected error occurred",null).toFetchError()}}}function ys(t,e){const n=e.filter(r=>t[r]===void 0||t[r]===null);if(n.length>0)throw new St("VALIDATION_ERROR",`Missing required parameters: ${n.join(", ")}`,t.id||null)}function Cq(t){if(!t)throw new St("CREDENTIALS_ERROR","AWS credentials not configured",null);if(!t.accessKeyId||!t.secretAccessKey)throw new St("CREDENTIALS_ERROR","Invalid AWS credentials: missing accessKeyId or secretAccessKey",null);if(!t.region)throw new St("CREDENTIALS_ERROR","AWS region not configured",null)}class Js extends Error{constructor(e="OpenAI API authentication failed. Please check your API key."){super(e),this.name="OpenAIAuthenticationError",this.type="OPENAI_AUTH_ERROR",this.statusCode=401,Error.captureStackTrace&&Error.captureStackTrace(this,Js)}toResponse(){return{error:tc.OPENAI_AUTH_ERROR.message,message:this.message}}toFetchError(){return{response:{status:this.statusCode,data:this.toResponse()}}}}class ja extends Error{constructor(e="OpenAI rate limit exceeded. Please try again later or check your quota."){super(e),this.name="OpenAIRateLimitError",this.type="OPENAI_RATE_LIMIT_ERROR",this.statusCode=429,Error.captureStackTrace&&Error.captureStackTrace(this,ja)}toResponse(){return{error:tc.OPENAI_RATE_LIMIT_ERROR.message,message:this.message}}toFetchError(){return{response:{status:this.statusCode,data:this.toResponse()}}}}class Wt extends Error{constructor(e,n="unknown"){super(e),this.name="ModelProviderError",this.type="MODEL_PROVIDER_ERROR",this.statusCode=422,this.provider=n,Error.captureStackTrace&&Error.captureStackTrace(this,Wt)}toResponse(){return{error:tc.MODEL_PROVIDER_ERROR.message,message:this.message,provider:this.provider}}toFetchError(){return{response:{status:this.statusCode,data:this.toResponse()}}}}function Uy(t,e="unknown"){var s;const n=((s=t.message)==null?void 0:s.toLowerCase())||"",r=t.toString().toLowerCase();return e==="openai"?n.includes("authentication")||n.includes("api_key")||n.includes("api key")||n.includes("unauthorized")||n.includes("invalid api key")||r.includes("401")?new Js("OpenAI API authentication failed. Please verify your API key is correct and active."):n.includes("rate_limit")||n.includes("rate limit")||n.includes("quota")||n.includes("too many requests")||r.includes("429")?new ja("OpenAI rate limit exceeded. Please wait a moment and try again, or check your account quota."):new Wt(`OpenAI API error: ${t.message}`,"openai"):e==="bedrock"?n.includes("credentials")||n.includes("access denied")||n.includes("unauthorized")?new St("CREDENTIALS_ERROR",`Amazon Bedrock authentication failed: ${t.message}`,null):new Wt(`Amazon Bedrock error: ${t.message}`,"bedrock"):new Wt(`Model provider error: ${t.message}`,e)}const yI=0;function cu(t,e,n,r,s){const i=t.id,a=t.max_tokens,o={model:i,region:r.region,credentials:{accessKeyId:r.accessKeyId,secretAccessKey:r.secretAccessKey},maxTokens:a};if(r.sessionToken&&r.sessionToken.trim()&&(o.credentials.sessionToken=r.sessionToken.trim()),e>0&&n.includes(i)){const u=t.reasoning_budget[e.toString()];u?(o.additionalModelRequestFields={thinking:{type:"enabled",budget_tokens:u}},console.log(`Reasoning enabled for ${s}: budget=${u}, model=${i}`)):console.warn(`No reasoning budget defined for ${s} at level ${e}, using default`)}else o.temperature=yI,e>0&&console.warn(`Reasoning requested for ${s} but model ${i} does not support it`);return new kC(o)}function Tv(t,e,n){const r={model:t.id,region:e.region,credentials:{accessKeyId:e.accessKeyId,secretAccessKey:e.secretAccessKey},maxTokens:t.max_tokens,temperature:yI};return e.sessionToken&&e.sessionToken.trim()&&(r.credentials.sessionToken=e.sessionToken.trim()),console.log(`Initialized ${n} model: ${t.id}`),new kC(r)}function Wi(t,e,n,r,s){try{const i={model:t.id,maxTokens:t.max_tokens,temperature:1,apiKey:r};if(e>0&&n.includes(t.id)){const a=t.id.includes("mini"),c=(a?vq:Eq)[e];c&&(i.reasoning_effort=c,console.log(`Reasoning enabled for ${s}: effort=${c}, model=${t.id} (${a?"mini":"standard"} mapping)`))}else e>0&&console.warn(`Reasoning requested for ${s} but model ${t.id} does not support it`);return console.log(`Initialized ${s} model: ${t.id}`),new _q(i)}catch(i){const a=Uy(i,"openai");throw console.error(`Failed to initialize OpenAI model ${s}:`,a.message),a}}function kq(t,e,n){try{console.log("Initializing OpenAI models with reasoning level:",t);const r=n.openaiApiKey;if(!r||r.trim()==="")throw new Js("OpenAI API key is missing. Please provide a valid API key.");const s=Wi(e.openai_model_main.assets,t,e.openai_reasoning_models,r,"assets"),i=Wi(e.openai_model_main.flows,t,e.openai_reasoning_models,r,"flows"),a=Wi(e.openai_model_main.threats,t,e.openai_reasoning_models,r,"threats"),o=Wi(e.openai_model_main.gaps,t,e.openai_reasoning_models,r,"gaps"),c=Wi(e.openai_model_summary,0,e.openai_reasoning_models,r,"summary"),u=Wi(e.openai_model_struct,0,e.openai_reasoning_models,r,"struct");return console.log("All OpenAI models initialized successfully"),{assets_model:s,flows_model:i,threats_model:a,gaps_model:o,summary_model:c,struct_model:u}}catch(r){if(r instanceof Js||r instanceof ja||r instanceof Wt)throw r;const s=Uy(r,"openai");throw console.error("Failed to initialize OpenAI models:",s.message),s}}function Iq(t,e,n){console.log("Initializing Bedrock models with reasoning level:",t);const r=cu(e.model_main.assets,t,e.reasoning_models,n,"assets"),s=cu(e.model_main.flows,t,e.reasoning_models,n,"flows"),i=cu(e.model_main.threats,t,e.reasoning_models,n,"threats"),a=cu(e.model_main.gaps,t,e.reasoning_models,n,"gaps"),o=Tv(e.model_summary,n,"summary"),c=Tv(e.model_struct,n,"struct");return console.log("All Bedrock models initialized successfully"),{assets_model:r,flows_model:s,threats_model:i,gaps_model:a,summary_model:o,struct_model:c}}function Rq(t=0,e=null){try{const n=Fl();if(!n)throw new Wt("Provider credentials not configured","unknown");if(!n.provider)throw new Wt("No provider configuration found","unknown");const r=n.provider;if(r==="bedrock"){const s=e||wq;if(Ev(s,"bedrock"),!n.accessKeyId||!n.secretAccessKey)throw new Wt("Invalid AWS credentials: missing accessKeyId or secretAccessKey","bedrock");return Iq(t,s,n)}else if(r==="openai"){const s=e||bq;if(Ev(s,"openai"),!n.openaiApiKey)throw new Js("Invalid OpenAI credentials: missing API key");return kq(t,s,n)}else throw new Wt(`Unsupported provider: ${r}`,r)}catch(n){throw n instanceof Js||n instanceof ja||n instanceof Wt?(console.error("Model initialization failed:",n.message),n):(console.error("Failed to initialize models:",n),n.message.includes("credentials")||n.message.includes("API key")?new Wt("Provider credentials are invalid or missing: "+n.message,"unknown"):n.message.includes("Configuration")?new Wt("Model configuration is invalid: "+n.message,"unknown"):n.message.includes("provider")?new Wt("Provider configuration error: "+n.message,"unknown"):new Wt("Failed to initialize models: "+n.message,"unknown"))}}const Sn={START:"START",ASSETS:"ASSETS",FLOW:"FLOW",THREAT:"THREAT",THREAT_RETRY:"THREAT_RETRY",FINALIZE:"FINALIZE",COMPLETE:"COMPLETE",FAILED:"FAILED",CANCELLED:"CANCELLED"},as=new Map;function Oq(t=0){try{const e=Fl();e&&e.provider==="bedrock"&&Cq(e);const n=Rq(t);return{configurable:{model_assets:n.assets_model,model_flows:n.flows_model,model_threats:n.threats_model,model_gaps:n.gaps_model,model_summary:n.summary_model,model_struct:n.struct_model,reasoning:t>0,max_retry:15}}}catch(e){throw e instanceof Js||e instanceof ja||e instanceof Wt||e instanceof St?e:new Wt(`Failed to initialize model configuration: ${e.message}`,"unknown")}}function $q(t){const{id:e,s3_location:n,iteration:r,description:s,assumptions:i,title:a,instructions:o}=t;let c=null;if(n){const u=de.getUploadedFile(n);if(u)try{const l=JSON.parse(u);c=l.data||null,!c&&l.error&&console.warn(`Image data not available: ${l.error}`)}catch{c=u}}return{job_id:e,s3_location:n||"",owner:"LIGHTNING_USER",title:a||"",description:s||"",assumptions:i||[],iteration:r||0,retry:0,image_data:c,replay:!1,instructions:o||null,summary:null,assets:null,system_architecture:null,threat_list:null,gap:[],stop:!1}}function Nq(t,e){const{iteration:n,instructions:r}=e,s=de.getJobResults(t);if(!s)throw new St("NOT_FOUND",`Job ${t} not found for replay`,t);const i={assets:s.assets,system_architecture:s.system_architecture,threat_list:s.threat_list};de.updateJobResults(t,{backup:i});let a=null;if(s.s3_location){const c=de.getUploadedFile(s.s3_location);if(c)try{const u=JSON.parse(c);a=u.data||null,!a&&u.error&&console.warn(`Image data not available: ${u.error}`)}catch{a=c}}let o=null;if(s.threat_list){const c={...s.threat_list};c.threats=(c.threats||[]).filter(u=>u.starred===!0),o=c}return{job_id:t,s3_location:s.s3_location||"",owner:"LIGHTNING_USER",title:s.title||"",description:s.description||"",assumptions:s.assumptions||[],iteration:n||0,retry:0,image_data:a,replay:!0,instructions:r||null,summary:s.summary||null,assets:s.assets||null,system_architecture:s.system_architecture||null,threat_list:o,gap:[],stop:!1}}async function Pq(t){const{s3_location:e,id:n,iteration:r,reasoning:s,description:i,assumptions:a,title:o,replay:c=!1,instructions:u}=t,l=n||kv();try{let d;return c?d=Nq(l,{iteration:r,reasoning:s,instructions:u}):d=$q({id:l,s3_location:e,iteration:r,reasoning:s,description:i,assumptions:a,title:o,instructions:u}),de.setJobStatus(l,Sn.START,0),de.setJobTrail(l,{id:l,assets:"",flows:"",gaps:[],threats:[]}),c||de.addJobToIndex(l,{title:o||"",owner:"LIGHTNING_USER",s3_location:e||""}),Lq(l,d,s||1),{id:l}}catch(d){throw console.error("Error executing agent:",d),de.setJobStatus(l,Sn.FAILED,0),d instanceof St?d:new St("INTERNAL_ERROR",`Failed to execute agent: ${d.message}`,l)}}function Lq(t,e,n){const r=typeof AbortController<"u";r||console.warn("AbortController not available, interruption will not be supported");const s=r?new AbortController:null,i=(async()=>{try{console.log(`Starting background execution for job ${t}`);const a=Oq(n);s&&(a.signal=s.signal);const o=jB();console.log("Invoking workflow...");const c=await o.invoke(e,a);if(!as.has(t)){console.log(`Job ${t} was cancelled during execution, skipping completion`);return}console.log(`Workflow completed for job ${t}`),console.log(`Job ${t} completed successfully`),as.delete(t)}catch(a){if(a.name==="AbortError"||a.message==="AbortError"||s&&s.signal.aborted){console.log(`Job ${t} was aborted - interruption successful`),as.delete(t);return}let c=a;const u=Fl();if(u&&u.provider&&(c=Uy(a,u.provider)),console.error(`Background execution failed for job ${t}:`,c),console.error("Error details:",{name:c.name,message:c.message,type:c.type||"unknown",stack:c.stack}),!as.has(t)){console.log(`Job ${t} was cancelled during error handling, skipping status update`);return}const d=de.getJobStatus(t),h=(d==null?void 0:d.retry)||0;try{de.setJobStatus(t,Sn.FAILED,h);const f=de.getJobResults(t)||{};de.setJobResults(t,{...f,error:c.message||"Unknown error",error_type:c.type||c.name||"Error",provider:(u==null?void 0:u.provider)||"unknown",failed_at:new Date().toISOString()})}catch(f){console.error(`Failed to store error state for job ${t}:`,f)}as.delete(t)}})();as.set(t,{abortController:s,status:"RUNNING",startTime:Date.now(),workflowPromise:i}),setTimeout(()=>i,0)}function SH(t){const e=de.getJobStatus(t);return e?[Sn.START,Sn.ASSETS,Sn.FLOW,Sn.THREAT,Sn.THREAT_RETRY,Sn.FINALIZE].includes(e.state):!1}function xH(t){const e=as.get(t);if(!e){console.log(`Interruption requested for job ${t}, but job not found in active jobs registry`);const n=de.getJobStatus(t);return n&&(console.log(`Job ${t} exists in storage with status: ${n.state}`),![Sn.COMPLETE,Sn.FAILED,Sn.CANCELLED].includes(n.state))?(console.log(`Updating orphaned job ${t} to CANCELLED state`),de.setJobStatus(t,Sn.CANCELLED,n.retry||0),!0):!1}console.log(`Interrupting job ${t} (started at ${new Date(e.startTime).toISOString()})`);try{e.abortController?(e.abortController.abort(),console.log(`Abort signal sent for job ${t}`)):console.warn(`No AbortController available for job ${t}, interruption may not be immediate`);const n=de.getJobStatus(t);n?(de.setJobStatus(t,Sn.CANCELLED,n.retry||0),console.log(`Job ${t} status updated to CANCELLED`)):console.warn(`Job ${t} status not found during interruption, may have been cleared`);try{const r=de.getJobResults(t)||{};de.setJobResults(t,{...r,cancelled_at:new Date().toISOString(),cancellation_reason:"User requested interruption"})}catch(r){console.error(`Failed to store cancellation metadata for job ${t}:`,r)}return as.delete(t),console.log(`Job ${t} interrupted successfully and removed from active registry`),!0}catch(n){return console.error(`Error during interruption of job ${t}:`,n),as.delete(t),!0}}const Mq=Kr(async(t,e,n,r,s,i,a=!1,o=null,c=null)=>(console.log("startThreatModeling called",{key:t,iteration:e,reasoning:n,title:r,replay:a,id:o}),a?ys({iteration:e,reasoning:n,id:o},["iteration","reasoning","id"]):ys({iteration:e,reasoning:n,title:r,description:s},["iteration","reasoning","title","description"]),{data:await Pq({s3_location:t,id:o,iteration:e,reasoning:n,description:s,assumptions:i||[],title:r,replay:a,instructions:c})})),Dq=Kr(async(t,e)=>{if(console.log("updateTm called",{id:t,payload:e}),ys({id:t},["id"]),!e||typeof e!="object")throw new St("VALIDATION_ERROR","Payload must be an object",t);const n=de.getJobResults(t);if(!n)throw new St("NOT_FOUND",`Job ${t} not found`,t);const r=["owner","s3_location","job_id"],s=Object.keys(e).filter(a=>!r.includes(a)).reduce((a,o)=>(a[o]=e[o],a),{});if(!n.backup){const a={assets:n.assets,system_architecture:n.system_architecture,threat_list:n.threat_list};s.backup=a}return de.updateJobResults(t,s),{data:de.getJobResults(t)}}),Uq=Kr(async t=>{console.log("restoreTm called",{id:t}),ys({id:t},["id"]);const e=de.getJobResults(t);if(!e)throw new St("NOT_FOUND",`Job ${t} not found`,t);if(!e.backup)throw new St("NOT_FOUND",`No backup found for job ${t}`,t);const n={...e,assets:e.backup.assets,system_architecture:e.backup.system_architecture,threat_list:e.backup.threat_list};de.setJobResults(t,n);const r=de.getJobStatus(t);return r&&de.setJobStatus(t,"COMPLETE",r.retry||0),{data:!0}}),Bq=Kr(async(t="image/png")=>{console.log("generateUrl called",{fileType:t});const e=kv();return{data:{presigned:`lightning://upload/${e}`,name:e}}}),jq=Kr(async t=>{console.log("getDownloadUrl called",{fileName:t}),ys({fileName:t},["fileName"]);const e=de.getUploadedFile(t);if(!e)throw new St("NOT_FOUND",`File ${t} not found`,null);try{let n,r;try{const o=JSON.parse(e);if(o.data&&o.type)r=o.data,n=o.type;else throw new Error("Invalid JSON format")}catch{const c=e.match(/^data:([^;]+);base64,(.+)$/);if(!c)throw new Error("Invalid data format - not JSON or data URL");n=c[1],r=c[2]}const s=atob(r),i=new Uint8Array(s.length);for(let o=0;o<s.length;o++)i[o]=s.charCodeAt(o);return new Blob([i],{type:n})}catch(n){throw new St("INTERNAL_ERROR",`Failed to retrieve file: ${n.message}`,null)}}),Fq=Kr(async t=>{ys({id:t},["id"]);const e=de.getJobStatus(t);return e?{data:{id:e.id,state:e.state,retry:e.retry||0}}:{data:{id:t,state:"Not Found",retry:0}}}),zq=Kr(async t=>{console.log("getThreatModelingTrail called",{id:t}),ys({id:t},["id"]);const e=de.getJobTrail(t);return e?{data:{id:e.id,assets:e.assets||"",flows:e.flows||"",gaps:e.gaps||[],threats:e.threats||[]}}:{data:{id:t,assets:"",flows:"",gaps:[],threats:[]}}}),Vq=Kr(async t=>{console.log("getThreatModelingResults called",{id:t}),ys({id:t},["id"]);const e=de.getJobResults(t);return e?{data:{job_id:t,state:"Found",item:e}}:{data:{job_id:t,state:"Not Found",item:null}}}),qq=Kr(async()=>(console.log("getThreatModelingAllResults called"),{data:{catalogs:de.getAllJobs().map(n=>de.getJobResults(n.id)||n).filter(Boolean)}})),Hq=Kr(async t=>{console.log("deleteTm called",{id:t}),ys({id:t},["id"]);const e=de.getJobResults(t);if(!e)throw new St("NOT_FOUND",`Job ${t} not found`,t);return e.s3_location&&de.deleteUploadedFile(e.s3_location),de.clearJobData(t),{data:{job_id:t,state:"Deleted"}}}),TH=Mq,AH=Dq,CH=Uq,kH=Bq,IH=jq,RH=Fq,OH=zq,$H=Vq,NH=qq,PH=Hq;export{tc as ERROR_TYPES,St as ThreatModelingError,DH as clearCredentials,PH as deleteTm,kH as generateUrl,Fl as getCredentials,IH as getDownloadUrl,NH as getThreatModelingAllResults,$H as getThreatModelingResults,RH as getThreatModelingStatus,OH as getThreatModelingTrail,UH as hasValidCredentials,xH as interruptJob,SH as isJobExecuting,CH as restoreTm,BH as setCredentials,TH as startThreatModeling,de as stateManager,AH as updateTm};
//# sourceMappingURL=index-mXBtjmVJ.js.map
